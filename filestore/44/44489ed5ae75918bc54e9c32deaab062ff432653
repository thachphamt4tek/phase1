
/* /web/static/lib/dompurify/DOMpurify.js */
(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?module.exports=factory():typeof define==='function'&&define.amd?define(factory):(global=typeof globalThis!=='undefined'?globalThis:global||self,global.DOMPurify=factory());})(this,(function(){'use strict';const{entries,setPrototypeOf,isFrozen,getPrototypeOf,getOwnPropertyDescriptor}=Object;let{freeze,seal,create}=Object;let{apply,construct}=typeof Reflect!=='undefined'&&Reflect;if(!freeze){freeze=function freeze(x){return x;};}
if(!seal){seal=function seal(x){return x;};}
if(!apply){apply=function apply(fun,thisValue,args){return fun.apply(thisValue,args);};}
if(!construct){construct=function construct(Func,args){return new Func(...args);};}
const arrayForEach=unapply(Array.prototype.forEach);const arrayPop=unapply(Array.prototype.pop);const arrayPush=unapply(Array.prototype.push);const stringToLowerCase=unapply(String.prototype.toLowerCase);const stringToString=unapply(String.prototype.toString);const stringMatch=unapply(String.prototype.match);const stringReplace=unapply(String.prototype.replace);const stringIndexOf=unapply(String.prototype.indexOf);const stringTrim=unapply(String.prototype.trim);const objectHasOwnProperty=unapply(Object.prototype.hasOwnProperty);const regExpTest=unapply(RegExp.prototype.test);const typeErrorCreate=unconstruct(TypeError);function unapply(func){return function(thisArg){for(var _len=arguments.length,args=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}
return apply(func,thisArg,args);};}
function unconstruct(func){return function(){for(var _len2=arguments.length,args=new Array(_len2),_key2=0;_key2<_len2;_key2++){args[_key2]=arguments[_key2];}
return construct(func,args);};}
function addToSet(set,array){let transformCaseFunc=arguments.length>2&&arguments[2]!==undefined?arguments[2]:stringToLowerCase;if(setPrototypeOf){setPrototypeOf(set,null);}
let l=array.length;while(l--){let element=array[l];if(typeof element==='string'){const lcElement=transformCaseFunc(element);if(lcElement!==element){if(!isFrozen(array)){array[l]=lcElement;}
element=lcElement;}}
set[element]=true;}
return set;}
function cleanArray(array){for(let index=0;index<array.length;index++){const isPropertyExist=objectHasOwnProperty(array,index);if(!isPropertyExist){array[index]=null;}}
return array;}
function clone(object){const newObject=create(null);for(const[property,value]of entries(object)){const isPropertyExist=objectHasOwnProperty(object,property);if(isPropertyExist){if(Array.isArray(value)){newObject[property]=cleanArray(value);}else if(value&&typeof value==='object'&&value.constructor===Object){newObject[property]=clone(value);}else{newObject[property]=value;}}}
return newObject;}
function lookupGetter(object,prop){while(object!==null){const desc=getOwnPropertyDescriptor(object,prop);if(desc){if(desc.get){return unapply(desc.get);}
if(typeof desc.value==='function'){return unapply(desc.value);}}
object=getPrototypeOf(object);}
function fallbackValue(){return null;}
return fallbackValue;}
const html$1=freeze(['a','abbr','acronym','address','area','article','aside','audio','b','bdi','bdo','big','blink','blockquote','body','br','button','canvas','caption','center','cite','code','col','colgroup','content','data','datalist','dd','decorator','del','details','dfn','dialog','dir','div','dl','dt','element','em','fieldset','figcaption','figure','font','footer','form','h1','h2','h3','h4','h5','h6','head','header','hgroup','hr','html','i','img','input','ins','kbd','label','legend','li','main','map','mark','marquee','menu','menuitem','meter','nav','nobr','ol','optgroup','option','output','p','picture','pre','progress','q','rp','rt','ruby','s','samp','section','select','shadow','small','source','spacer','span','strike','strong','style','sub','summary','sup','table','tbody','td','template','textarea','tfoot','th','thead','time','tr','track','tt','u','ul','var','video','wbr']);const svg$1=freeze(['svg','a','altglyph','altglyphdef','altglyphitem','animatecolor','animatemotion','animatetransform','circle','clippath','defs','desc','ellipse','filter','font','g','glyph','glyphref','hkern','image','line','lineargradient','marker','mask','metadata','mpath','path','pattern','polygon','polyline','radialgradient','rect','stop','style','switch','symbol','text','textpath','title','tref','tspan','view','vkern']);const svgFilters=freeze(['feBlend','feColorMatrix','feComponentTransfer','feComposite','feConvolveMatrix','feDiffuseLighting','feDisplacementMap','feDistantLight','feDropShadow','feFlood','feFuncA','feFuncB','feFuncG','feFuncR','feGaussianBlur','feImage','feMerge','feMergeNode','feMorphology','feOffset','fePointLight','feSpecularLighting','feSpotLight','feTile','feTurbulence']);const svgDisallowed=freeze(['animate','color-profile','cursor','discard','font-face','font-face-format','font-face-name','font-face-src','font-face-uri','foreignobject','hatch','hatchpath','mesh','meshgradient','meshpatch','meshrow','missing-glyph','script','set','solidcolor','unknown','use']);const mathMl$1=freeze(['math','menclose','merror','mfenced','mfrac','mglyph','mi','mlabeledtr','mmultiscripts','mn','mo','mover','mpadded','mphantom','mroot','mrow','ms','mspace','msqrt','mstyle','msub','msup','msubsup','mtable','mtd','mtext','mtr','munder','munderover','mprescripts']);const mathMlDisallowed=freeze(['maction','maligngroup','malignmark','mlongdiv','mscarries','mscarry','msgroup','mstack','msline','msrow','semantics','annotation','annotation-xml','mprescripts','none']);const text=freeze(['#text']);const html=freeze(['accept','action','align','alt','autocapitalize','autocomplete','autopictureinpicture','autoplay','background','bgcolor','border','capture','cellpadding','cellspacing','checked','cite','class','clear','color','cols','colspan','controls','controlslist','coords','crossorigin','datetime','decoding','default','dir','disabled','disablepictureinpicture','disableremoteplayback','download','draggable','enctype','enterkeyhint','face','for','headers','height','hidden','high','href','hreflang','id','inputmode','integrity','ismap','kind','label','lang','list','loading','loop','low','max','maxlength','media','method','min','minlength','multiple','muted','name','nonce','noshade','novalidate','nowrap','open','optimum','pattern','placeholder','playsinline','popover','popovertarget','popovertargetaction','poster','preload','pubdate','radiogroup','readonly','rel','required','rev','reversed','role','rows','rowspan','spellcheck','scope','selected','shape','size','sizes','span','srclang','start','src','srcset','step','style','summary','tabindex','title','translate','type','usemap','valign','value','width','wrap','xmlns','slot']);const svg=freeze(['accent-height','accumulate','additive','alignment-baseline','amplitude','ascent','attributename','attributetype','azimuth','basefrequency','baseline-shift','begin','bias','by','class','clip','clippathunits','clip-path','clip-rule','color','color-interpolation','color-interpolation-filters','color-profile','color-rendering','cx','cy','d','dx','dy','diffuseconstant','direction','display','divisor','dur','edgemode','elevation','end','exponent','fill','fill-opacity','fill-rule','filter','filterunits','flood-color','flood-opacity','font-family','font-size','font-size-adjust','font-stretch','font-style','font-variant','font-weight','fx','fy','g1','g2','glyph-name','glyphref','gradientunits','gradienttransform','height','href','id','image-rendering','in','in2','intercept','k','k1','k2','k3','k4','kerning','keypoints','keysplines','keytimes','lang','lengthadjust','letter-spacing','kernelmatrix','kernelunitlength','lighting-color','local','marker-end','marker-mid','marker-start','markerheight','markerunits','markerwidth','maskcontentunits','maskunits','max','mask','media','method','mode','min','name','numoctaves','offset','operator','opacity','order','orient','orientation','origin','overflow','paint-order','path','pathlength','patterncontentunits','patterntransform','patternunits','points','preservealpha','preserveaspectratio','primitiveunits','r','rx','ry','radius','refx','refy','repeatcount','repeatdur','restart','result','rotate','scale','seed','shape-rendering','slope','specularconstant','specularexponent','spreadmethod','startoffset','stddeviation','stitchtiles','stop-color','stop-opacity','stroke-dasharray','stroke-dashoffset','stroke-linecap','stroke-linejoin','stroke-miterlimit','stroke-opacity','stroke','stroke-width','style','surfacescale','systemlanguage','tabindex','tablevalues','targetx','targety','transform','transform-origin','text-anchor','text-decoration','text-rendering','textlength','type','u1','u2','unicode','values','viewbox','visibility','version','vert-adv-y','vert-origin-x','vert-origin-y','width','word-spacing','wrap','writing-mode','xchannelselector','ychannelselector','x','x1','x2','xmlns','y','y1','y2','z','zoomandpan']);const mathMl=freeze(['accent','accentunder','align','bevelled','close','columnsalign','columnlines','columnspan','denomalign','depth','dir','display','displaystyle','encoding','fence','frame','height','href','id','largeop','length','linethickness','lspace','lquote','mathbackground','mathcolor','mathsize','mathvariant','maxsize','minsize','movablelimits','notation','numalign','open','rowalign','rowlines','rowspacing','rowspan','rspace','rquote','scriptlevel','scriptminsize','scriptsizemultiplier','selection','separator','separators','stretchy','subscriptshift','supscriptshift','symmetric','voffset','width','xmlns']);const xml=freeze(['xlink:href','xml:id','xlink:title','xml:space','xmlns:xlink']);const MUSTACHE_EXPR=seal(/\{\{[\w\W]*|[\w\W]*\}\}/gm);const ERB_EXPR=seal(/<%[\w\W]*|[\w\W]*%>/gm);const TMPLIT_EXPR=seal(/\${[\w\W]*}/gm);const DATA_ATTR=seal(/^data-[\-\w.\u00B7-\uFFFF]/);const ARIA_ATTR=seal(/^aria-[\-\w]+$/);const IS_ALLOWED_URI=seal(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i);const IS_SCRIPT_OR_DATA=seal(/^(?:\w+script|data):/i);const ATTR_WHITESPACE=seal(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g);const DOCTYPE_NAME=seal(/^html$/i);const CUSTOM_ELEMENT=seal(/^[a-z][.\w]*(-[.\w]+)+$/i);var EXPRESSIONS=Object.freeze({__proto__:null,MUSTACHE_EXPR:MUSTACHE_EXPR,ERB_EXPR:ERB_EXPR,TMPLIT_EXPR:TMPLIT_EXPR,DATA_ATTR:DATA_ATTR,ARIA_ATTR:ARIA_ATTR,IS_ALLOWED_URI:IS_ALLOWED_URI,IS_SCRIPT_OR_DATA:IS_SCRIPT_OR_DATA,ATTR_WHITESPACE:ATTR_WHITESPACE,DOCTYPE_NAME:DOCTYPE_NAME,CUSTOM_ELEMENT:CUSTOM_ELEMENT});const NODE_TYPE={element:1,attribute:2,text:3,cdataSection:4,entityReference:5,entityNode:6,progressingInstruction:7,comment:8,document:9,documentType:10,documentFragment:11,notation:12};const getGlobal=function getGlobal(){return typeof window==='undefined'?null:window;};const _createTrustedTypesPolicy=function _createTrustedTypesPolicy(trustedTypes,purifyHostElement){if(typeof trustedTypes!=='object'||typeof trustedTypes.createPolicy!=='function'){return null;}
let suffix=null;const ATTR_NAME='data-tt-policy-suffix';if(purifyHostElement&&purifyHostElement.hasAttribute(ATTR_NAME)){suffix=purifyHostElement.getAttribute(ATTR_NAME);}
const policyName='dompurify'+(suffix?'#'+suffix:'');try{return trustedTypes.createPolicy(policyName,{createHTML(html){return html;},createScriptURL(scriptUrl){return scriptUrl;}});}catch(_){console.warn('TrustedTypes policy '+policyName+' could not be created.');return null;}};function createDOMPurify(){let window=arguments.length>0&&arguments[0]!==undefined?arguments[0]:getGlobal();const DOMPurify=root=>createDOMPurify(root);DOMPurify.version='3.1.7';DOMPurify.removed=[];if(!window||!window.document||window.document.nodeType!==NODE_TYPE.document){DOMPurify.isSupported=false;return DOMPurify;}
let{document}=window;const originalDocument=document;const currentScript=originalDocument.currentScript;const{DocumentFragment,HTMLTemplateElement,Node,Element,NodeFilter,NamedNodeMap=window.NamedNodeMap||window.MozNamedAttrMap,HTMLFormElement,DOMParser,trustedTypes}=window;const ElementPrototype=Element.prototype;const cloneNode=lookupGetter(ElementPrototype,'cloneNode');const remove=lookupGetter(ElementPrototype,'remove');const getNextSibling=lookupGetter(ElementPrototype,'nextSibling');const getChildNodes=lookupGetter(ElementPrototype,'childNodes');const getParentNode=lookupGetter(ElementPrototype,'parentNode');if(typeof HTMLTemplateElement==='function'){const template=document.createElement('template');if(template.content&&template.content.ownerDocument){document=template.content.ownerDocument;}}
let trustedTypesPolicy;let emptyHTML='';const{implementation,createNodeIterator,createDocumentFragment,getElementsByTagName}=document;const{importNode}=originalDocument;let hooks={};DOMPurify.isSupported=typeof entries==='function'&&typeof getParentNode==='function'&&implementation&&implementation.createHTMLDocument!==undefined;const{MUSTACHE_EXPR,ERB_EXPR,TMPLIT_EXPR,DATA_ATTR,ARIA_ATTR,IS_SCRIPT_OR_DATA,ATTR_WHITESPACE,CUSTOM_ELEMENT}=EXPRESSIONS;let{IS_ALLOWED_URI:IS_ALLOWED_URI$1}=EXPRESSIONS;let ALLOWED_TAGS=null;const DEFAULT_ALLOWED_TAGS=addToSet({},[...html$1,...svg$1,...svgFilters,...mathMl$1,...text]);let ALLOWED_ATTR=null;const DEFAULT_ALLOWED_ATTR=addToSet({},[...html,...svg,...mathMl,...xml]);let CUSTOM_ELEMENT_HANDLING=Object.seal(create(null,{tagNameCheck:{writable:true,configurable:false,enumerable:true,value:null},attributeNameCheck:{writable:true,configurable:false,enumerable:true,value:null},allowCustomizedBuiltInElements:{writable:true,configurable:false,enumerable:true,value:false}}));let FORBID_TAGS=null;let FORBID_ATTR=null;let ALLOW_ARIA_ATTR=true;let ALLOW_DATA_ATTR=true;let ALLOW_UNKNOWN_PROTOCOLS=false;let ALLOW_SELF_CLOSE_IN_ATTR=true;let SAFE_FOR_TEMPLATES=false;let SAFE_FOR_XML=true;let WHOLE_DOCUMENT=false;let SET_CONFIG=false;let FORCE_BODY=false;let RETURN_DOM=false;let RETURN_DOM_FRAGMENT=false;let RETURN_TRUSTED_TYPE=false;let SANITIZE_DOM=true;let SANITIZE_NAMED_PROPS=false;const SANITIZE_NAMED_PROPS_PREFIX='user-content-';let KEEP_CONTENT=true;let IN_PLACE=false;let USE_PROFILES={};let FORBID_CONTENTS=null;const DEFAULT_FORBID_CONTENTS=addToSet({},['annotation-xml','audio','colgroup','desc','foreignobject','head','iframe','math','mi','mn','mo','ms','mtext','noembed','noframes','noscript','plaintext','script','style','svg','template','thead','title','video','xmp']);let DATA_URI_TAGS=null;const DEFAULT_DATA_URI_TAGS=addToSet({},['audio','video','img','source','image','track']);let URI_SAFE_ATTRIBUTES=null;const DEFAULT_URI_SAFE_ATTRIBUTES=addToSet({},['alt','class','for','id','label','name','pattern','placeholder','role','summary','title','value','style','xmlns']);const MATHML_NAMESPACE='http://www.w3.org/1998/Math/MathML';const SVG_NAMESPACE='http://www.w3.org/2000/svg';const HTML_NAMESPACE='http://www.w3.org/1999/xhtml';let NAMESPACE=HTML_NAMESPACE;let IS_EMPTY_INPUT=false;let ALLOWED_NAMESPACES=null;const DEFAULT_ALLOWED_NAMESPACES=addToSet({},[MATHML_NAMESPACE,SVG_NAMESPACE,HTML_NAMESPACE],stringToString);let PARSER_MEDIA_TYPE=null;const SUPPORTED_PARSER_MEDIA_TYPES=['application/xhtml+xml','text/html'];const DEFAULT_PARSER_MEDIA_TYPE='text/html';let transformCaseFunc=null;let CONFIG=null;const formElement=document.createElement('form');const isRegexOrFunction=function isRegexOrFunction(testValue){return testValue instanceof RegExp||testValue instanceof Function;};const _parseConfig=function _parseConfig(){let cfg=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(CONFIG&&CONFIG===cfg){return;}
if(!cfg||typeof cfg!=='object'){cfg={};}
cfg=clone(cfg);PARSER_MEDIA_TYPE=SUPPORTED_PARSER_MEDIA_TYPES.indexOf(cfg.PARSER_MEDIA_TYPE)===-1?DEFAULT_PARSER_MEDIA_TYPE:cfg.PARSER_MEDIA_TYPE;transformCaseFunc=PARSER_MEDIA_TYPE==='application/xhtml+xml'?stringToString:stringToLowerCase;ALLOWED_TAGS=objectHasOwnProperty(cfg,'ALLOWED_TAGS')?addToSet({},cfg.ALLOWED_TAGS,transformCaseFunc):DEFAULT_ALLOWED_TAGS;ALLOWED_ATTR=objectHasOwnProperty(cfg,'ALLOWED_ATTR')?addToSet({},cfg.ALLOWED_ATTR,transformCaseFunc):DEFAULT_ALLOWED_ATTR;ALLOWED_NAMESPACES=objectHasOwnProperty(cfg,'ALLOWED_NAMESPACES')?addToSet({},cfg.ALLOWED_NAMESPACES,stringToString):DEFAULT_ALLOWED_NAMESPACES;URI_SAFE_ATTRIBUTES=objectHasOwnProperty(cfg,'ADD_URI_SAFE_ATTR')?addToSet(clone(DEFAULT_URI_SAFE_ATTRIBUTES),cfg.ADD_URI_SAFE_ATTR,transformCaseFunc):DEFAULT_URI_SAFE_ATTRIBUTES;DATA_URI_TAGS=objectHasOwnProperty(cfg,'ADD_DATA_URI_TAGS')?addToSet(clone(DEFAULT_DATA_URI_TAGS),cfg.ADD_DATA_URI_TAGS,transformCaseFunc):DEFAULT_DATA_URI_TAGS;FORBID_CONTENTS=objectHasOwnProperty(cfg,'FORBID_CONTENTS')?addToSet({},cfg.FORBID_CONTENTS,transformCaseFunc):DEFAULT_FORBID_CONTENTS;FORBID_TAGS=objectHasOwnProperty(cfg,'FORBID_TAGS')?addToSet({},cfg.FORBID_TAGS,transformCaseFunc):{};FORBID_ATTR=objectHasOwnProperty(cfg,'FORBID_ATTR')?addToSet({},cfg.FORBID_ATTR,transformCaseFunc):{};USE_PROFILES=objectHasOwnProperty(cfg,'USE_PROFILES')?cfg.USE_PROFILES:false;ALLOW_ARIA_ATTR=cfg.ALLOW_ARIA_ATTR!==false;ALLOW_DATA_ATTR=cfg.ALLOW_DATA_ATTR!==false;ALLOW_UNKNOWN_PROTOCOLS=cfg.ALLOW_UNKNOWN_PROTOCOLS||false;ALLOW_SELF_CLOSE_IN_ATTR=cfg.ALLOW_SELF_CLOSE_IN_ATTR!==false;SAFE_FOR_TEMPLATES=cfg.SAFE_FOR_TEMPLATES||false;SAFE_FOR_XML=cfg.SAFE_FOR_XML!==false;WHOLE_DOCUMENT=cfg.WHOLE_DOCUMENT||false;RETURN_DOM=cfg.RETURN_DOM||false;RETURN_DOM_FRAGMENT=cfg.RETURN_DOM_FRAGMENT||false;RETURN_TRUSTED_TYPE=cfg.RETURN_TRUSTED_TYPE||false;FORCE_BODY=cfg.FORCE_BODY||false;SANITIZE_DOM=cfg.SANITIZE_DOM!==false;SANITIZE_NAMED_PROPS=cfg.SANITIZE_NAMED_PROPS||false;KEEP_CONTENT=cfg.KEEP_CONTENT!==false;IN_PLACE=cfg.IN_PLACE||false;IS_ALLOWED_URI$1=cfg.ALLOWED_URI_REGEXP||IS_ALLOWED_URI;NAMESPACE=cfg.NAMESPACE||HTML_NAMESPACE;CUSTOM_ELEMENT_HANDLING=cfg.CUSTOM_ELEMENT_HANDLING||{};if(cfg.CUSTOM_ELEMENT_HANDLING&&isRegexOrFunction(cfg.CUSTOM_ELEMENT_HANDLING.tagNameCheck)){CUSTOM_ELEMENT_HANDLING.tagNameCheck=cfg.CUSTOM_ELEMENT_HANDLING.tagNameCheck;}
if(cfg.CUSTOM_ELEMENT_HANDLING&&isRegexOrFunction(cfg.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)){CUSTOM_ELEMENT_HANDLING.attributeNameCheck=cfg.CUSTOM_ELEMENT_HANDLING.attributeNameCheck;}
if(cfg.CUSTOM_ELEMENT_HANDLING&&typeof cfg.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements==='boolean'){CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=cfg.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements;}
if(SAFE_FOR_TEMPLATES){ALLOW_DATA_ATTR=false;}
if(RETURN_DOM_FRAGMENT){RETURN_DOM=true;}
if(USE_PROFILES){ALLOWED_TAGS=addToSet({},text);ALLOWED_ATTR=[];if(USE_PROFILES.html===true){addToSet(ALLOWED_TAGS,html$1);addToSet(ALLOWED_ATTR,html);}
if(USE_PROFILES.svg===true){addToSet(ALLOWED_TAGS,svg$1);addToSet(ALLOWED_ATTR,svg);addToSet(ALLOWED_ATTR,xml);}
if(USE_PROFILES.svgFilters===true){addToSet(ALLOWED_TAGS,svgFilters);addToSet(ALLOWED_ATTR,svg);addToSet(ALLOWED_ATTR,xml);}
if(USE_PROFILES.mathMl===true){addToSet(ALLOWED_TAGS,mathMl$1);addToSet(ALLOWED_ATTR,mathMl);addToSet(ALLOWED_ATTR,xml);}}
if(cfg.ADD_TAGS){if(ALLOWED_TAGS===DEFAULT_ALLOWED_TAGS){ALLOWED_TAGS=clone(ALLOWED_TAGS);}
addToSet(ALLOWED_TAGS,cfg.ADD_TAGS,transformCaseFunc);}
if(cfg.ADD_ATTR){if(ALLOWED_ATTR===DEFAULT_ALLOWED_ATTR){ALLOWED_ATTR=clone(ALLOWED_ATTR);}
addToSet(ALLOWED_ATTR,cfg.ADD_ATTR,transformCaseFunc);}
if(cfg.ADD_URI_SAFE_ATTR){addToSet(URI_SAFE_ATTRIBUTES,cfg.ADD_URI_SAFE_ATTR,transformCaseFunc);}
if(cfg.FORBID_CONTENTS){if(FORBID_CONTENTS===DEFAULT_FORBID_CONTENTS){FORBID_CONTENTS=clone(FORBID_CONTENTS);}
addToSet(FORBID_CONTENTS,cfg.FORBID_CONTENTS,transformCaseFunc);}
if(KEEP_CONTENT){ALLOWED_TAGS['#text']=true;}
if(WHOLE_DOCUMENT){addToSet(ALLOWED_TAGS,['html','head','body']);}
if(ALLOWED_TAGS.table){addToSet(ALLOWED_TAGS,['tbody']);delete FORBID_TAGS.tbody;}
if(cfg.TRUSTED_TYPES_POLICY){if(typeof cfg.TRUSTED_TYPES_POLICY.createHTML!=='function'){throw typeErrorCreate('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');}
if(typeof cfg.TRUSTED_TYPES_POLICY.createScriptURL!=='function'){throw typeErrorCreate('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');}
trustedTypesPolicy=cfg.TRUSTED_TYPES_POLICY;emptyHTML=trustedTypesPolicy.createHTML('');}else{if(trustedTypesPolicy===undefined){trustedTypesPolicy=_createTrustedTypesPolicy(trustedTypes,currentScript);}
if(trustedTypesPolicy!==null&&typeof emptyHTML==='string'){emptyHTML=trustedTypesPolicy.createHTML('');}}
if(freeze){freeze(cfg);}
CONFIG=cfg;};const MATHML_TEXT_INTEGRATION_POINTS=addToSet({},['mi','mo','mn','ms','mtext']);const HTML_INTEGRATION_POINTS=addToSet({},['annotation-xml']);const COMMON_SVG_AND_HTML_ELEMENTS=addToSet({},['title','style','font','a','script']);const ALL_SVG_TAGS=addToSet({},[...svg$1,...svgFilters,...svgDisallowed]);const ALL_MATHML_TAGS=addToSet({},[...mathMl$1,...mathMlDisallowed]);const _checkValidNamespace=function _checkValidNamespace(element){let parent=getParentNode(element);if(!parent||!parent.tagName){parent={namespaceURI:NAMESPACE,tagName:'template'};}
const tagName=stringToLowerCase(element.tagName);const parentTagName=stringToLowerCase(parent.tagName);if(!ALLOWED_NAMESPACES[element.namespaceURI]){return false;}
if(element.namespaceURI===SVG_NAMESPACE){if(parent.namespaceURI===HTML_NAMESPACE){return tagName==='svg';}
if(parent.namespaceURI===MATHML_NAMESPACE){return tagName==='svg'&&(parentTagName==='annotation-xml'||MATHML_TEXT_INTEGRATION_POINTS[parentTagName]);}
return Boolean(ALL_SVG_TAGS[tagName]);}
if(element.namespaceURI===MATHML_NAMESPACE){if(parent.namespaceURI===HTML_NAMESPACE){return tagName==='math';}
if(parent.namespaceURI===SVG_NAMESPACE){return tagName==='math'&&HTML_INTEGRATION_POINTS[parentTagName];}
return Boolean(ALL_MATHML_TAGS[tagName]);}
if(element.namespaceURI===HTML_NAMESPACE){if(parent.namespaceURI===SVG_NAMESPACE&&!HTML_INTEGRATION_POINTS[parentTagName]){return false;}
if(parent.namespaceURI===MATHML_NAMESPACE&&!MATHML_TEXT_INTEGRATION_POINTS[parentTagName]){return false;}
return!ALL_MATHML_TAGS[tagName]&&(COMMON_SVG_AND_HTML_ELEMENTS[tagName]||!ALL_SVG_TAGS[tagName]);}
if(PARSER_MEDIA_TYPE==='application/xhtml+xml'&&ALLOWED_NAMESPACES[element.namespaceURI]){return true;}
return false;};const _forceRemove=function _forceRemove(node){arrayPush(DOMPurify.removed,{element:node});try{getParentNode(node).removeChild(node);}catch(_){remove(node);}};const _removeAttribute=function _removeAttribute(name,node){try{arrayPush(DOMPurify.removed,{attribute:node.getAttributeNode(name),from:node});}catch(_){arrayPush(DOMPurify.removed,{attribute:null,from:node});}
node.removeAttribute(name);if(name==='is'&&!ALLOWED_ATTR[name]){if(RETURN_DOM||RETURN_DOM_FRAGMENT){try{_forceRemove(node);}catch(_){}}else{try{node.setAttribute(name,'');}catch(_){}}}};const _initDocument=function _initDocument(dirty){let doc=null;let leadingWhitespace=null;if(FORCE_BODY){dirty='<remove></remove>'+dirty;}else{const matches=stringMatch(dirty,/^[\r\n\t ]+/);leadingWhitespace=matches&&matches[0];}
if(PARSER_MEDIA_TYPE==='application/xhtml+xml'&&NAMESPACE===HTML_NAMESPACE){dirty='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+dirty+'</body></html>';}
const dirtyPayload=trustedTypesPolicy?trustedTypesPolicy.createHTML(dirty):dirty;if(NAMESPACE===HTML_NAMESPACE){try{doc=new DOMParser().parseFromString(dirtyPayload,PARSER_MEDIA_TYPE);}catch(_){}}
if(!doc||!doc.documentElement){doc=implementation.createDocument(NAMESPACE,'template',null);try{doc.documentElement.innerHTML=IS_EMPTY_INPUT?emptyHTML:dirtyPayload;}catch(_){}}
const body=doc.body||doc.documentElement;if(dirty&&leadingWhitespace){body.insertBefore(document.createTextNode(leadingWhitespace),body.childNodes[0]||null);}
if(NAMESPACE===HTML_NAMESPACE){return getElementsByTagName.call(doc,WHOLE_DOCUMENT?'html':'body')[0];}
return WHOLE_DOCUMENT?doc.documentElement:body;};const _createNodeIterator=function _createNodeIterator(root){return createNodeIterator.call(root.ownerDocument||root,root,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_COMMENT|NodeFilter.SHOW_TEXT|NodeFilter.SHOW_PROCESSING_INSTRUCTION|NodeFilter.SHOW_CDATA_SECTION,null);};const _isClobbered=function _isClobbered(elm){return elm instanceof HTMLFormElement&&(typeof elm.nodeName!=='string'||typeof elm.textContent!=='string'||typeof elm.removeChild!=='function'||!(elm.attributes instanceof NamedNodeMap)||typeof elm.removeAttribute!=='function'||typeof elm.setAttribute!=='function'||typeof elm.namespaceURI!=='string'||typeof elm.insertBefore!=='function'||typeof elm.hasChildNodes!=='function');};const _isNode=function _isNode(object){return typeof Node==='function'&&object instanceof Node;};const _executeHook=function _executeHook(entryPoint,currentNode,data){if(!hooks[entryPoint]){return;}
arrayForEach(hooks[entryPoint],hook=>{hook.call(DOMPurify,currentNode,data,CONFIG);});};const _sanitizeElements=function _sanitizeElements(currentNode){let content=null;_executeHook('beforeSanitizeElements',currentNode,null);if(_isClobbered(currentNode)){_forceRemove(currentNode);return true;}
const tagName=transformCaseFunc(currentNode.nodeName);_executeHook('uponSanitizeElement',currentNode,{tagName,allowedTags:ALLOWED_TAGS});if(currentNode.hasChildNodes()&&!_isNode(currentNode.firstElementChild)&&regExpTest(/<[/\w]/g,currentNode.innerHTML)&&regExpTest(/<[/\w]/g,currentNode.textContent)){_forceRemove(currentNode);return true;}
if(currentNode.nodeType===NODE_TYPE.progressingInstruction){_forceRemove(currentNode);return true;}
if(SAFE_FOR_XML&&currentNode.nodeType===NODE_TYPE.comment&&regExpTest(/<[/\w]/g,currentNode.data)){_forceRemove(currentNode);return true;}
if(!ALLOWED_TAGS[tagName]||FORBID_TAGS[tagName]){if(!FORBID_TAGS[tagName]&&_isBasicCustomElement(tagName)){if(CUSTOM_ELEMENT_HANDLING.tagNameCheck instanceof RegExp&&regExpTest(CUSTOM_ELEMENT_HANDLING.tagNameCheck,tagName)){return false;}
if(CUSTOM_ELEMENT_HANDLING.tagNameCheck instanceof Function&&CUSTOM_ELEMENT_HANDLING.tagNameCheck(tagName)){return false;}}
if(KEEP_CONTENT&&!FORBID_CONTENTS[tagName]){const parentNode=getParentNode(currentNode)||currentNode.parentNode;const childNodes=getChildNodes(currentNode)||currentNode.childNodes;if(childNodes&&parentNode){const childCount=childNodes.length;for(let i=childCount-1;i>=0;--i){const childClone=cloneNode(childNodes[i],true);childClone.__removalCount=(currentNode.__removalCount||0)+1;parentNode.insertBefore(childClone,getNextSibling(currentNode));}}}
_forceRemove(currentNode);return true;}
if(currentNode instanceof Element&&!_checkValidNamespace(currentNode)){_forceRemove(currentNode);return true;}
if((tagName==='noscript'||tagName==='noembed'||tagName==='noframes')&&regExpTest(/<\/no(script|embed|frames)/i,currentNode.innerHTML)){_forceRemove(currentNode);return true;}
if(SAFE_FOR_TEMPLATES&&currentNode.nodeType===NODE_TYPE.text){content=currentNode.textContent;arrayForEach([MUSTACHE_EXPR,ERB_EXPR,TMPLIT_EXPR],expr=>{content=stringReplace(content,expr,' ');});if(currentNode.textContent!==content){arrayPush(DOMPurify.removed,{element:currentNode.cloneNode()});currentNode.textContent=content;}}
_executeHook('afterSanitizeElements',currentNode,null);return false;};const _isValidAttribute=function _isValidAttribute(lcTag,lcName,value){if(SANITIZE_DOM&&(lcName==='id'||lcName==='name')&&(value in document||value in formElement)){return false;}
if(ALLOW_DATA_ATTR&&!FORBID_ATTR[lcName]&&regExpTest(DATA_ATTR,lcName));else if(ALLOW_ARIA_ATTR&&regExpTest(ARIA_ATTR,lcName));else if(!ALLOWED_ATTR[lcName]||FORBID_ATTR[lcName]){if(_isBasicCustomElement(lcTag)&&(CUSTOM_ELEMENT_HANDLING.tagNameCheck instanceof RegExp&&regExpTest(CUSTOM_ELEMENT_HANDLING.tagNameCheck,lcTag)||CUSTOM_ELEMENT_HANDLING.tagNameCheck instanceof Function&&CUSTOM_ELEMENT_HANDLING.tagNameCheck(lcTag))&&(CUSTOM_ELEMENT_HANDLING.attributeNameCheck instanceof RegExp&&regExpTest(CUSTOM_ELEMENT_HANDLING.attributeNameCheck,lcName)||CUSTOM_ELEMENT_HANDLING.attributeNameCheck instanceof Function&&CUSTOM_ELEMENT_HANDLING.attributeNameCheck(lcName))||lcName==='is'&&CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements&&(CUSTOM_ELEMENT_HANDLING.tagNameCheck instanceof RegExp&&regExpTest(CUSTOM_ELEMENT_HANDLING.tagNameCheck,value)||CUSTOM_ELEMENT_HANDLING.tagNameCheck instanceof Function&&CUSTOM_ELEMENT_HANDLING.tagNameCheck(value)));else{return false;}}else if(URI_SAFE_ATTRIBUTES[lcName]);else if(regExpTest(IS_ALLOWED_URI$1,stringReplace(value,ATTR_WHITESPACE,'')));else if((lcName==='src'||lcName==='xlink:href'||lcName==='href')&&lcTag!=='script'&&stringIndexOf(value,'data:')===0&&DATA_URI_TAGS[lcTag]);else if(ALLOW_UNKNOWN_PROTOCOLS&&!regExpTest(IS_SCRIPT_OR_DATA,stringReplace(value,ATTR_WHITESPACE,'')));else if(value){return false;}else;return true;};const _isBasicCustomElement=function _isBasicCustomElement(tagName){return tagName!=='annotation-xml'&&stringMatch(tagName,CUSTOM_ELEMENT);};const _sanitizeAttributes=function _sanitizeAttributes(currentNode){_executeHook('beforeSanitizeAttributes',currentNode,null);const{attributes}=currentNode;if(!attributes){return;}
const hookEvent={attrName:'',attrValue:'',keepAttr:true,allowedAttributes:ALLOWED_ATTR};let l=attributes.length;while(l--){const attr=attributes[l];const{name,namespaceURI,value:attrValue}=attr;const lcName=transformCaseFunc(name);let value=name==='value'?attrValue:stringTrim(attrValue);hookEvent.attrName=lcName;hookEvent.attrValue=value;hookEvent.keepAttr=true;hookEvent.forceKeepAttr=undefined;_executeHook('uponSanitizeAttribute',currentNode,hookEvent);value=hookEvent.attrValue;if(hookEvent.forceKeepAttr){continue;}
_removeAttribute(name,currentNode);if(!hookEvent.keepAttr){continue;}
if(!ALLOW_SELF_CLOSE_IN_ATTR&&regExpTest(/\/>/i,value)){_removeAttribute(name,currentNode);continue;}
if(SAFE_FOR_TEMPLATES){arrayForEach([MUSTACHE_EXPR,ERB_EXPR,TMPLIT_EXPR],expr=>{value=stringReplace(value,expr,' ');});}
const lcTag=transformCaseFunc(currentNode.nodeName);if(!_isValidAttribute(lcTag,lcName,value)){continue;}
if(SANITIZE_NAMED_PROPS&&(lcName==='id'||lcName==='name')){_removeAttribute(name,currentNode);value=SANITIZE_NAMED_PROPS_PREFIX+value;}
if(SAFE_FOR_XML&&regExpTest(/((--!?|])>)|<\/(style|title)/i,value)){_removeAttribute(name,currentNode);continue;}
if(trustedTypesPolicy&&typeof trustedTypes==='object'&&typeof trustedTypes.getAttributeType==='function'){if(namespaceURI);else{switch(trustedTypes.getAttributeType(lcTag,lcName)){case'TrustedHTML':{value=trustedTypesPolicy.createHTML(value);break;}
case'TrustedScriptURL':{value=trustedTypesPolicy.createScriptURL(value);break;}}}}
try{if(namespaceURI){currentNode.setAttributeNS(namespaceURI,name,value);}else{currentNode.setAttribute(name,value);}
if(_isClobbered(currentNode)){_forceRemove(currentNode);}else{arrayPop(DOMPurify.removed);}}catch(_){}}
_executeHook('afterSanitizeAttributes',currentNode,null);};const _sanitizeShadowDOM=function _sanitizeShadowDOM(fragment){let shadowNode=null;const shadowIterator=_createNodeIterator(fragment);_executeHook('beforeSanitizeShadowDOM',fragment,null);while(shadowNode=shadowIterator.nextNode()){_executeHook('uponSanitizeShadowNode',shadowNode,null);if(_sanitizeElements(shadowNode)){continue;}
if(shadowNode.content instanceof DocumentFragment){_sanitizeShadowDOM(shadowNode.content);}
_sanitizeAttributes(shadowNode);}
_executeHook('afterSanitizeShadowDOM',fragment,null);};DOMPurify.sanitize=function(dirty){let cfg=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};let body=null;let importedNode=null;let currentNode=null;let returnNode=null;IS_EMPTY_INPUT=!dirty;if(IS_EMPTY_INPUT){dirty='<!-->';}
if(typeof dirty!=='string'&&!_isNode(dirty)){if(typeof dirty.toString==='function'){dirty=dirty.toString();if(typeof dirty!=='string'){throw typeErrorCreate('dirty is not a string, aborting');}}else{throw typeErrorCreate('toString is not a function');}}
if(!DOMPurify.isSupported){return dirty;}
if(!SET_CONFIG){_parseConfig(cfg);}
DOMPurify.removed=[];if(typeof dirty==='string'){IN_PLACE=false;}
if(IN_PLACE){if(dirty.nodeName){const tagName=transformCaseFunc(dirty.nodeName);if(!ALLOWED_TAGS[tagName]||FORBID_TAGS[tagName]){throw typeErrorCreate('root node is forbidden and cannot be sanitized in-place');}}}else if(dirty instanceof Node){body=_initDocument('<!---->');importedNode=body.ownerDocument.importNode(dirty,true);if(importedNode.nodeType===NODE_TYPE.element&&importedNode.nodeName==='BODY'){body=importedNode;}else if(importedNode.nodeName==='HTML'){body=importedNode;}else{body.appendChild(importedNode);}}else{if(!RETURN_DOM&&!SAFE_FOR_TEMPLATES&&!WHOLE_DOCUMENT&&dirty.indexOf('<')===-1){return trustedTypesPolicy&&RETURN_TRUSTED_TYPE?trustedTypesPolicy.createHTML(dirty):dirty;}
body=_initDocument(dirty);if(!body){return RETURN_DOM?null:RETURN_TRUSTED_TYPE?emptyHTML:'';}}
if(body&&FORCE_BODY){_forceRemove(body.firstChild);}
const nodeIterator=_createNodeIterator(IN_PLACE?dirty:body);while(currentNode=nodeIterator.nextNode()){if(_sanitizeElements(currentNode)){continue;}
if(currentNode.content instanceof DocumentFragment){_sanitizeShadowDOM(currentNode.content);}
_sanitizeAttributes(currentNode);}
if(IN_PLACE){return dirty;}
if(RETURN_DOM){if(RETURN_DOM_FRAGMENT){returnNode=createDocumentFragment.call(body.ownerDocument);while(body.firstChild){returnNode.appendChild(body.firstChild);}}else{returnNode=body;}
if(ALLOWED_ATTR.shadowroot||ALLOWED_ATTR.shadowrootmode){returnNode=importNode.call(originalDocument,returnNode,true);}
return returnNode;}
let serializedHTML=WHOLE_DOCUMENT?body.outerHTML:body.innerHTML;if(WHOLE_DOCUMENT&&ALLOWED_TAGS['!doctype']&&body.ownerDocument&&body.ownerDocument.doctype&&body.ownerDocument.doctype.name&&regExpTest(DOCTYPE_NAME,body.ownerDocument.doctype.name)){serializedHTML='<!DOCTYPE '+body.ownerDocument.doctype.name+'>\n'+serializedHTML;}
if(SAFE_FOR_TEMPLATES){arrayForEach([MUSTACHE_EXPR,ERB_EXPR,TMPLIT_EXPR],expr=>{serializedHTML=stringReplace(serializedHTML,expr,' ');});}
return trustedTypesPolicy&&RETURN_TRUSTED_TYPE?trustedTypesPolicy.createHTML(serializedHTML):serializedHTML;};DOMPurify.setConfig=function(){let cfg=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};_parseConfig(cfg);SET_CONFIG=true;};DOMPurify.clearConfig=function(){CONFIG=null;SET_CONFIG=false;};DOMPurify.isValidAttribute=function(tag,attr,value){if(!CONFIG){_parseConfig({});}
const lcTag=transformCaseFunc(tag);const lcName=transformCaseFunc(attr);return _isValidAttribute(lcTag,lcName,value);};DOMPurify.addHook=function(entryPoint,hookFunction){if(typeof hookFunction!=='function'){return;}
hooks[entryPoint]=hooks[entryPoint]||[];arrayPush(hooks[entryPoint],hookFunction);};DOMPurify.removeHook=function(entryPoint){if(hooks[entryPoint]){return arrayPop(hooks[entryPoint]);}};DOMPurify.removeHooks=function(entryPoint){if(hooks[entryPoint]){hooks[entryPoint]=[];}};DOMPurify.removeAllHooks=function(){hooks={};};return DOMPurify;}
var purify=createDOMPurify();return purify;}));;

/* /html_editor/static/src/components/switch/switch.js */
odoo.define('@html_editor/components/switch/switch',['@odoo/owl'],function(require){'use strict';let __exports={};const{Component,xml}=require("@odoo/owl");const NO_OP=()=>{};const Switch=__exports.Switch=class Switch extends Component{static props={value:{type:Boolean,optional:true},extraClasses:String,disabled:{type:Boolean,optional:true},label:{type:String,optional:true},description:{type:String,optional:true},onChange:{Function,optional:true},};static defaultProps={onChange:NO_OP,};static template=xml`
    <label t-att-class="'o_switch' + extraClasses">
        <input type="checkbox"
                name="switch"
                class="visually-hidden"
                t-att-checked="props.value"
                t-att-disabled="props.disabled"
                t-on-change="(ev) => props.onChange(ev.target.checked)"
                t-on-keyup="onKeyup"/>
        <span/>
        <span t-if="props.label" t-esc="props.label" class="ms-2"/>
        <span t-if="props.description" class="text-muted ms-2" t-esc="props.description"/>
    </label>
    `;setup(){this.extraClasses=this.props.extraClasses?` ${this.props.extraClasses}`:"";}
onKeyup(ev){if(ev.key==="Enter"){ev.currentTarget.checked=!ev.currentTarget.checked;}}}
return __exports;});;

/* /html_editor/static/src/main/media/media_dialog/document_selector.js */
odoo.define('@html_editor/main/media/media_dialog/document_selector',['@web/core/l10n/translation','@html_editor/main/media/media_dialog/file_selector','@web/core/utils/render'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{Attachment,FileSelector,IMAGE_MIMETYPES}=require("@html_editor/main/media/media_dialog/file_selector");const{renderToElement}=require("@web/core/utils/render");const DocumentAttachment=__exports.DocumentAttachment=class DocumentAttachment extends Attachment{static template="html_editor.DocumentAttachment";}
const DocumentSelector=__exports.DocumentSelector=class DocumentSelector extends FileSelector{static mediaSpecificClasses=["o_image"];static mediaSpecificStyles=[];static mediaExtraClasses=[];static tagNames=["A"];static attachmentsListTemplate="html_editor.DocumentsListTemplate";static components={...FileSelector.components,DocumentAttachment,};setup(){super.setup();this.uploadText=_t("Upload a document");this.urlPlaceholder="https://www.odoo.com/mydocument";this.addText=_t("Add URL");this.searchPlaceholder=_t("Search a document");this.allLoadedText=_t("All documents have been loaded");}
get attachmentsDomain(){const domain=super.attachmentsDomain;domain.push(["mimetype","not in",IMAGE_MIMETYPES]);domain.unshift("&","|",["url","=",null],"!",["url","=like","/web/assets/%"]);return domain;}
async onClickDocument(document){this.selectAttachment(document);await this.props.save();}
async fetchAttachments(...args){const attachments=await super.fetchAttachments(...args);if(this.selectInitialMedia()){for(const attachment of attachments){if(`/web/content/${attachment.id}`===this.props.media.getAttribute("href").replace(/[?].*/,"")){this.selectAttachment(attachment);}}}
return attachments;}
static async createElements(selectedMedia,{orm}){return Promise.all(selectedMedia.map(async(attachment)=>{let url=`/web/content/${encodeURIComponent(
                    attachment.id
                )}?unique=${encodeURIComponent(attachment.checksum)}&download=true`;if(!attachment.public){let accessToken=attachment.access_token;if(!accessToken){[accessToken]=await orm.call("ir.attachment","generate_access_token",[attachment.id,]);}
url+=`&access_token=${encodeURIComponent(accessToken)}`;}
return this.renderFileElement(attachment,url);}));}
static renderFileElement(attachment,downloadUrl){return renderStaticFileBox(attachment.name,attachment.mimetype,downloadUrl,attachment.id);}}
__exports.renderStaticFileBox=renderStaticFileBox;function renderStaticFileBox(filename,mimetype,downloadUrl,id){const rootSpan=document.createElement("span");rootSpan.classList.add("o_file_box","o-contenteditable-false");rootSpan.contentEditable=false;rootSpan.dataset.attachmentId=id;const bannerElement=renderToElement("html_editor.StaticFileBox",{fileModel:{filename,mimetype,downloadUrl},});rootSpan.append(bannerElement);return rootSpan;}
return __exports;});;

/* /html_editor/static/src/main/media/media_dialog/file_selector.js */
odoo.define('@html_editor/main/media/media_dialog/file_selector',['@web/core/l10n/translation','@web/core/network/rpc','@web/core/utils/hooks','@web/core/confirmation_dialog/confirmation_dialog','@web/core/dialog/dialog','@web/core/utils/concurrency','@web/core/utils/timing','@html_editor/main/media/media_dialog/search_media','@odoo/owl'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{rpc}=require("@web/core/network/rpc");const{useService}=require("@web/core/utils/hooks");const{ConfirmationDialog}=require("@web/core/confirmation_dialog/confirmation_dialog");const{Dialog}=require("@web/core/dialog/dialog");const{KeepLast}=require("@web/core/utils/concurrency");const{useDebounced}=require("@web/core/utils/timing");const{SearchMedia}=require("@html_editor/main/media/media_dialog/search_media");const{Component,xml,useState,useRef,onWillStart,useEffect}=require("@odoo/owl");const IMAGE_MIMETYPES=__exports.IMAGE_MIMETYPES=["image/jpg","image/jpeg","image/jpe","image/png","image/svg+xml","image/gif","image/webp",];const IMAGE_EXTENSIONS=__exports.IMAGE_EXTENSIONS=[".jpg",".jpeg",".jpe",".png",".svg",".gif",".webp"];class RemoveButton extends Component{static template=xml`<i class="fa fa-trash o_existing_attachment_remove position-absolute top-0 end-0 p-2 bg-white-25 cursor-pointer opacity-0 opacity-100-hover z-1 transition-base" t-att-title="removeTitle" role="img" t-att-aria-label="removeTitle" t-on-click="this.remove"/>`;static props=["model?","remove"];setup(){this.removeTitle=_t("This file is attached to the current record.");if(this.props.model==="ir.ui.view"){this.removeTitle=_t("This file is a public view attachment.");}}
remove(ev){ev.stopPropagation();this.props.remove();}}
const AttachmentError=__exports.AttachmentError=class AttachmentError extends Component{static components={Dialog};static template="html_editor.AttachmentError";static props=["views","close"];setup(){this.title=_t("Alert");}}
const Attachment=__exports.Attachment=class Attachment extends Component{static template="";static components={RemoveButton,};static props=["*"];setup(){this.dialogs=useService("dialog");}
remove(){this.dialogs.add(ConfirmationDialog,{body:_t("Are you sure you want to delete this file?"),confirm:async()=>{const prevented=await rpc("/html_editor/attachment/remove",{ids:[this.props.id],});if(!Object.keys(prevented).length){this.props.onRemoved(this.props.id);}else{this.dialogs.add(AttachmentError,{views:prevented[this.props.id],});}},});}}
const FileSelectorControlPanel=__exports.FileSelectorControlPanel=class FileSelectorControlPanel extends Component{static template="html_editor.FileSelectorControlPanel";static components={SearchMedia,};static props={uploadUrl:Function,validateUrl:Function,uploadFiles:Function,changeSearchService:Function,changeShowOptimized:Function,search:Function,accept:{type:String,optional:true},addText:{type:String,optional:true},multiSelect:{type:true,optional:true},needle:{type:String,optional:true},searchPlaceholder:{type:String,optional:true},searchService:{type:String,optional:true},showOptimized:{type:Boolean,optional:true},showOptimizedOption:{type:String,optional:true},uploadText:{type:String,optional:true},urlPlaceholder:{type:String,optional:true},urlWarningTitle:{type:String,optional:true},useMediaLibrary:{type:Boolean,optional:true},useUnsplash:{type:Boolean,optional:true},};setup(){this.state=useState({showUrlInput:false,urlInput:"",isValidUrl:false,isValidFileFormat:false,isValidatingUrl:false,});this.debouncedValidateUrl=useDebounced(this.props.validateUrl,500);this.fileInput=useRef("file-input");const urlInputRef=useRef("urlInput");useEffect(()=>{if(this.state.showUrlInput){urlInputRef.el.focus();}},()=>[this.state.showUrlInput]);}
get showSearchServiceSelect(){return this.props.searchService&&this.props.needle;}
get enableUrlUploadClick(){return(!this.state.showUrlInput||(this.state.urlInput&&this.state.isValidUrl&&this.state.isValidFileFormat));}
async onUrlUploadClick(){if(!this.state.showUrlInput){this.state.showUrlInput=true;}else{await this.props.uploadUrl(this.state.urlInput);this.state.urlInput="";}}
async onUrlInput(ev){this.state.isValidatingUrl=true;const{isValidUrl,isValidFileFormat}=await this.debouncedValidateUrl(ev.target.value);this.state.isValidFileFormat=isValidFileFormat;this.state.isValidUrl=isValidUrl;this.state.isValidatingUrl=false;}
onClickUpload(){this.fileInput.el.click();}
async onChangeFileInput(){const inputFiles=this.fileInput.el.files;if(!inputFiles.length){return;}
await this.props.uploadFiles(inputFiles);const fileInputEl=this.fileInput.el;if(fileInputEl){fileInputEl.value="";}}}
const FileSelector=__exports.FileSelector=class FileSelector extends Component{static template="html_editor.FileSelector";static components={FileSelectorControlPanel,};static props=["*"];setup(){this.notificationService=useService("notification");this.orm=useService("orm");this.uploadService=useService("upload");this.keepLast=new KeepLast();this.loadMoreButtonRef=useRef("load-more-button");this.existingAttachmentsRef=useRef("existing-attachments");this.state=useState({attachments:[],canScrollAttachments:false,canLoadMoreAttachments:false,isFetchingAttachments:false,needle:"",});this.NUMBER_OF_ATTACHMENTS_TO_DISPLAY=30;onWillStart(async()=>{this.state.attachments=await this.fetchAttachments(this.NUMBER_OF_ATTACHMENTS_TO_DISPLAY,0);});this.debouncedOnScroll=useDebounced(this.updateScroll,15);this.debouncedScrollUpdate=useDebounced(this.updateScroll,500);useEffect((modalEl)=>{if(modalEl){modalEl.addEventListener("scroll",this.debouncedOnScroll);return()=>{modalEl.removeEventListener("scroll",this.debouncedOnScroll);};}},()=>[this.props.modalRef.el?.querySelector("main.modal-body")]);useEffect(()=>{this.loadMoreButtonRef.el.classList.add("o_hide_loading");this.state.canScrollAttachments=false;this.debouncedScrollUpdate();},()=>[this.allAttachments.length]);}
get canLoadMore(){return this.state.canLoadMoreAttachments;}
get hasContent(){return this.state.attachments.length;}
get isFetching(){return this.state.isFetchingAttachments;}
get selectedAttachmentIds(){return this.props.selectedMedia[this.props.id].filter((media)=>media.mediaType==="attachment").map(({id})=>id);}
get attachmentsDomain(){const domain=["&",["res_model","=",this.props.resModel],["res_id","=",this.props.resId||0],];domain.unshift("|",["public","=",true]);domain.push(["name","ilike",this.state.needle]);return domain;}
get allAttachments(){return this.state.attachments;}
validateUrl(url){const path=url.split("?")[0];const isValidUrl=/^.+\..+$/.test(path);const isValidFileFormat=true;return{isValidUrl,isValidFileFormat,path};}
async fetchAttachments(limit,offset){this.state.isFetchingAttachments=true;let attachments=[];try{attachments=await this.orm.call("ir.attachment","search_read",[],{domain:this.attachmentsDomain,fields:["name","mimetype","description","checksum","url","type","res_id","res_model","public","access_token","image_src","image_width","image_height","original_id",],order:"id desc",limit,offset,});attachments.forEach((attachment)=>(attachment.mediaType="attachment"));}catch(e){if(e.exceptionName!=="odoo.exceptions.AccessError"){throw e;}}
this.state.canLoadMoreAttachments=attachments.length>=this.NUMBER_OF_ATTACHMENTS_TO_DISPLAY;this.state.isFetchingAttachments=false;return attachments;}
async handleLoadMore(){await this.loadMore();}
async loadMore(){return this.keepLast.add(this.fetchAttachments(this.NUMBER_OF_ATTACHMENTS_TO_DISPLAY,this.state.attachments.length)).then((newAttachments)=>{this.state.attachments.push(...newAttachments);});}
async handleSearch(needle){await this.search(needle);}
async search(needle){this.state.attachments=[];this.state.needle=needle;return this.keepLast.add(this.fetchAttachments(this.NUMBER_OF_ATTACHMENTS_TO_DISPLAY,0)).then((attachments)=>{this.state.attachments=attachments;});}
async uploadFiles(files){await this.uploadService.uploadFiles(files,{resModel:this.props.resModel,resId:this.props.resId},(attachment)=>this.onUploaded(attachment));}
async uploadUrl(url){await fetch(url).then(async(result)=>{const blob=await result.blob();blob.id=new Date().getTime();blob.name=new URL(url,window.location.href).pathname.split("/").findLast((s)=>s);await this.uploadFiles([blob]);}).catch(async()=>{await new Promise((resolve)=>{const imageEl=document.createElement("img");imageEl.onerror=()=>{this.notificationService.add(_t("An error occurred while fetching the entered URL."),{type:"danger",sticky:true,});resolve();};imageEl.onload=()=>{this.onLoadUploadedUrl(url,resolve);};imageEl.src=url;});});}
async onLoadUploadedUrl(url,resolve){await this.uploadService.uploadUrl(url,{resModel:this.props.resModel,resId:this.props.resId,},(attachment)=>this.onUploaded(attachment));resolve();}
async onUploaded(attachment){this.state.attachments=[attachment,...this.state.attachments.filter((attach)=>attach.id!==attachment.id),];this.selectAttachment(attachment);if(!this.props.multiSelect){await this.props.save();}
if(this.props.onAttachmentChange){this.props.onAttachmentChange(attachment);}}
onRemoved(attachmentId){this.state.attachments=this.state.attachments.filter((attachment)=>attachment.id!==attachmentId);}
selectAttachment(attachment){this.props.selectMedia({...attachment,mediaType:"attachment"});}
selectInitialMedia(){return(this.props.media&&this.constructor.tagNames.includes(this.props.media.tagName)&&!this.selectedAttachmentIds.length);}
updateScroll(){const loadMoreTop=this.loadMoreButtonRef.el.getBoundingClientRect().top;const modalEl=this.props.modalRef.el.querySelector("main.modal-body");const modalBottom=modalEl.getBoundingClientRect().bottom;this.state.canScrollAttachments=loadMoreTop>=modalBottom;this.loadMoreButtonRef.el.classList.remove("o_hide_loading");}
isAttachmentHidden(attachmentEl){const attachmentBottom=Math.round(attachmentEl.getBoundingClientRect().bottom);const modalEl=this.props.modalRef.el.querySelector("main.modal-body");const modalBottom=modalEl.getBoundingClientRect().bottom;return attachmentBottom>modalBottom;}
handleScrollAttachments(){let scrollToEl=this.loadMoreButtonRef.el;const attachmentEls=[...this.existingAttachmentsRef.el.querySelectorAll(".o_existing_attachment_cell"),];const firstHiddenAttachmentEl=attachmentEls.find((el)=>this.isAttachmentHidden(el));if(firstHiddenAttachmentEl){const attachmentBottom=firstHiddenAttachmentEl.getBoundingClientRect().bottom;const attachmentIndex=attachmentEls.indexOf(firstHiddenAttachmentEl);const firstNextRowAttachmentEl=attachmentEls.slice(attachmentIndex).find((el)=>el.getBoundingClientRect().bottom>attachmentBottom);scrollToEl=firstNextRowAttachmentEl||scrollToEl;}
scrollToEl.scrollIntoView({block:"end",inline:"nearest",behavior:"smooth"});}}
return __exports;});;

/* /html_editor/static/src/main/media/media_dialog/icon_selector.js */
odoo.define('@html_editor/main/media/media_dialog/icon_selector',['@html_editor/main/media/media_dialog/search_media','@html_editor/utils/fonts','@odoo/owl'],function(require){'use strict';let __exports={};const{SearchMedia}=require("@html_editor/main/media/media_dialog/search_media");const{fonts}=require("@html_editor/utils/fonts");const{Component,useState}=require("@odoo/owl");const IconSelector=__exports.IconSelector=class IconSelector extends Component{static mediaSpecificClasses=["fa"];static mediaSpecificStyles=["color","background-color"];static mediaExtraClasses=["rounded-circle","rounded","img-thumbnail","shadow",/^text-\S+$/,/^bg-\S+$/,/^fa-\S+$/,];static tagNames=["SPAN","I"];static template="html_editor.IconSelector";static components={SearchMedia,};static props=["*"];setup(){this.state=useState({fonts:this.props.fonts,needle:"",});}
get selectedMediaIds(){return this.props.selectedMedia[this.props.id].map(({id})=>id);}
search(needle){this.state.needle=needle;if(!this.state.needle){this.state.fonts=this.props.fonts;}else{this.state.fonts=this.props.fonts.map((font)=>{const icons=font.icons.filter((icon)=>icon.alias.indexOf(this.state.needle.toLowerCase())>=0);return{...font,icons};});}}
async onClickIcon(font,icon){this.props.selectMedia({...icon,fontBase:font.base,initialIconChanged:this.props.media&&!icon.names.some((name)=>this.props.media.classList.contains(name)),});await this.props.save();}
static createElements(selectedMedia){return selectedMedia.map((icon)=>{const iconEl=document.createElement("span");iconEl.classList.add(icon.fontBase,icon.names[0]);return iconEl;});}
static initFonts(){fonts.computeFonts();const allFonts=fonts.fontIcons.map(({cssData,base})=>{const uniqueIcons=Array.from(new Map(cssData.map((icon)=>{const alias=icon.names.join(",");const id=`${base}_${alias}`;return[id,{...icon,alias,id}];})).values());return{base,icons:uniqueIcons};});return allFonts;}}
return __exports;});;

/* /html_editor/static/src/main/media/media_dialog/image_selector.js */
odoo.define('@html_editor/main/media/media_dialog/image_selector',['@odoo/owl','@web/core/l10n/translation','@web/core/network/rpc','@web/core/utils/concurrency','@html_editor/utils/color','@html_editor/utils/formatting','@html_editor/main/media/media_dialog/file_selector','@html_editor/utils/image'],function(require){'use strict';let __exports={};const{useRef,useState}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{rpc}=require("@web/core/network/rpc");const{KeepLast}=require("@web/core/utils/concurrency");const{DEFAULT_PALETTE}=require("@html_editor/utils/color");const{getCSSVariableValue,getHtmlStyle}=require("@html_editor/utils/formatting");const{Attachment,FileSelector,IMAGE_EXTENSIONS,IMAGE_MIMETYPES}=require("@html_editor/main/media/media_dialog/file_selector");const{isSrcCorsProtected}=require("@html_editor/utils/image");const AutoResizeImage=__exports.AutoResizeImage=class AutoResizeImage extends Attachment{static template="html_editor.AutoResizeImage";setup(){super.setup();this.image=useRef("auto-resize-image");this.container=useRef("auto-resize-image-container");this.state=useState({loaded:false,});}
async onImageLoaded(){if(!this.image.el){return;}
if(this.props.onLoaded){await this.props.onLoaded(this.image.el);if(!this.image.el){return;}}
const aspectRatio=this.image.el.offsetWidth/this.image.el.offsetHeight;const width=aspectRatio*this.props.minRowHeight;this.container.el.style.flexGrow=width;this.container.el.style.flexBasis=`${width}px`;this.state.loaded=true;}}
const newLocal="img-fluid";const ImageSelector=__exports.ImageSelector=class ImageSelector extends FileSelector{static mediaSpecificClasses=["img",newLocal,"o_we_custom_image"];static mediaSpecificStyles=["transform","width"];static mediaExtraClasses=["rounded-circle","rounded","img-thumbnail","shadow","w-25","w-50","w-75","w-100",];static tagNames=["IMG"];static attachmentsListTemplate="html_editor.ImagesListTemplate";static components={...FileSelector.components,AutoResizeImage,};setup(){super.setup();this.keepLastLibraryMedia=new KeepLast();this.state.libraryMedia=[];this.state.libraryResults=null;this.state.isFetchingLibrary=false;this.state.searchService="all";this.state.showOptimized=false;this.NUMBER_OF_MEDIA_TO_DISPLAY=10;this.uploadText=_t("Upload an image");this.urlPlaceholder="https://www.odoo.com/logo.png";this.addText=_t("Add URL");this.searchPlaceholder=_t("Search an image");this.urlWarningTitle=_t("Uploaded image's format is not supported. Try with: "+IMAGE_EXTENSIONS.join(", "));this.allLoadedText=_t("All images have been loaded");this.showOptimizedOption=this.env.debug;this.MIN_ROW_HEIGHT=128;this.fileMimetypes=IMAGE_MIMETYPES.join(",");this.isImageField=!!this.props.media?.closest("[data-oe-type=image]")||!!this.props.addFieldImage;}
get canLoadMore(){if(this.state.searchService==="media-library"){return(this.state.libraryResults&&this.state.libraryMedia.length<this.state.libraryResults);}
return super.canLoadMore;}
get hasContent(){if(this.state.searchService==="all"){return super.hasContent||!!this.state.libraryMedia.length;}else if(this.state.searchService==="media-library"){return!!this.state.libraryMedia.length;}
return super.hasContent;}
get isFetching(){return super.isFetching||this.state.isFetchingLibrary;}
get selectedMediaIds(){return this.props.selectedMedia[this.props.id].filter((media)=>media.mediaType==="libraryMedia").map(({id})=>id);}
get allAttachments(){return[...super.allAttachments,...this.state.libraryMedia];}
get attachmentsDomain(){const domain=super.attachmentsDomain;domain.push(["mimetype","in",IMAGE_MIMETYPES]);if(!this.props.useMediaLibrary){domain.push("|",["url","=",false],"!","|",["url","=ilike","/html_editor/shape/%"],["url","=ilike","/web_editor/shape/%"]);}
domain.push("!",["name","=like","%.crop"]);domain.push("|",["type","=","binary"],"!",["url","=like","/%/static/%"]);if(!this.env.debug){const subDomain=[false];const originalId=this.props.media&&this.props.media.dataset.originalId;if(originalId){subDomain.push(originalId);}
domain.push(["original_id","in",subDomain]);}
return domain;}
async uploadFiles(files){await this.uploadService.uploadFiles(files,{resModel:this.props.resModel,resId:this.props.resId,isImage:true},(attachment)=>this.onUploaded(attachment));}
async validateUrl(...args){const{isValidUrl,path}=super.validateUrl(...args);const isValidFileFormat=isValidUrl&&(await new Promise((resolve)=>{const img=new Image();img.src=path;img.onload=()=>resolve(true);img.onerror=()=>resolve(false);}));return{isValidFileFormat,isValidUrl};}
async onLoadUploadedUrl(url,resolve){const urlPathname=new URL(url,window.location.href).pathname;const imageExtension=IMAGE_EXTENSIONS.find((format)=>urlPathname.endsWith(format));if(this.isImageField&&imageExtension===".webp"){this.notificationService.add(_t("You can not replace a field by this image. If you want to use this image, first save it on your computer and then upload it here."),{type:"danger",sticky:true,});return resolve();}
super.onLoadUploadedUrl(url,resolve);}
isInitialMedia(attachment){if(this.props.media.dataset.originalSrc){return this.props.media.dataset.originalSrc===attachment.image_src;}
return this.props.media.getAttribute("src")===attachment.image_src;}
async fetchAttachments(limit,offset){const attachments=await super.fetchAttachments(limit,offset);if(this.isImageField){for(const attachment of attachments){if(attachment.mimetype==="image/webp"&&(await isSrcCorsProtected(attachment.image_src))){attachment.unselectable=true;}}}
const primaryColors={};const htmlStyle=getHtmlStyle(document);for(let color=1;color<=5;color++){primaryColors[color]=getCSSVariableValue("o-color-"+color,htmlStyle);}
return attachments.map((attachment)=>{if(attachment.image_src.startsWith("/")){const newURL=new URL(attachment.image_src,window.location.origin);if(attachment.image_src.startsWith("/html_editor/shape/")||attachment.image_src.startsWith("/web_editor/shape/")){newURL.searchParams.forEach((value,key)=>{const match=key.match(/^c([1-5])$/);if(match){newURL.searchParams.set(key,primaryColors[match[1]]);}});}else{newURL.searchParams.set("height",2*this.MIN_ROW_HEIGHT);}
attachment.thumbnail_src=newURL.pathname+newURL.search;}
if(this.selectInitialMedia()&&this.isInitialMedia(attachment)){this.selectAttachment(attachment);}
return attachment;});}
async fetchLibraryMedia(offset){if(!this.state.needle){return{media:[],results:null};}
this.state.isFetchingLibrary=true;try{const response=await rpc("/html_editor/media_library_search",{query:this.state.needle,offset:offset,},{silent:true,});this.state.isFetchingLibrary=false;const media=(response.media||[]).slice(0,this.NUMBER_OF_MEDIA_TO_DISPLAY);media.forEach((record)=>(record.mediaType="libraryMedia"));return{media,results:response.results};}catch{console.error(`Couldn't reach API endpoint.`);this.state.isFetchingLibrary=false;return{media:[],results:null};}}
async loadMore(...args){await super.loadMore(...args);if(!this.props.useMediaLibrary||this.state.searchService!=="media-library"){return;}
return this.keepLastLibraryMedia.add(this.fetchLibraryMedia(this.state.libraryMedia.length)).then(({media})=>{this.state.libraryMedia.push(...media);});}
async search(...args){await super.search(...args);if(!this.props.useMediaLibrary){return;}
if(!this.state.needle){this.state.searchService="all";}
this.state.libraryMedia=[];this.state.libraryResults=0;return this.keepLastLibraryMedia.add(this.fetchLibraryMedia(0)).then(({media,results})=>{this.state.libraryMedia=media;this.state.libraryResults=results;});}
async onClickAttachment(attachment){if(attachment.unselectable){this.notificationService.add(_t("You can not replace a field by this image. If you want to use this image, first save it on your computer and then upload it here."),{type:"danger",sticky:true,});return;}
this.selectAttachment(attachment);if(!this.props.multiSelect){await this.props.save();}}
async onClickMedia(media){this.props.selectMedia({...media,mediaType:"libraryMedia"});if(!this.props.multiSelect){await this.props.save();}}
static async createElements(selectedMedia,{orm}){const toSave=Object.fromEntries(selectedMedia.filter((media)=>media.mediaType==="libraryMedia").map((media)=>[media.id,{query:media.query||"",is_dynamic_svg:!!media.isDynamicSVG,dynamic_colors:media.dynamicColors,},]));let savedMedia=[];if(Object.keys(toSave).length!==0){savedMedia=await rpc("/html_editor/save_library_media",{media:toSave});}
const selected=selectedMedia.filter((media)=>media.mediaType==="attachment").concat(savedMedia).map((attachment)=>{if(attachment.image_src&&(attachment.image_src.startsWith("/html_editor/shape/")||attachment.image_src.startsWith("/web_editor/shape/"))){const colorCustomizedURL=new URL(attachment.image_src,window.location.origin);const htmlStyle=getHtmlStyle(document);colorCustomizedURL.searchParams.forEach((value,key)=>{const match=key.match(/^c([1-5])$/);if(match){colorCustomizedURL.searchParams.set(key,getCSSVariableValue(`o-color-${match[1]}`,htmlStyle));}});attachment.image_src=colorCustomizedURL.pathname+colorCustomizedURL.search;}
return attachment;});return Promise.all(selected.map(async(attachment)=>{const imageEl=document.createElement("img");let src=attachment.image_src;if(!attachment.public&&!attachment.url){let accessToken=attachment.access_token;if(!accessToken){[accessToken]=await orm.call("ir.attachment","generate_access_token",[attachment.id,]);}
src+=`?access_token=${encodeURIComponent(accessToken)}`;}
imageEl.src=src;imageEl.alt=attachment.description||"";imageEl.dataset.attachmentId=attachment.id;return imageEl;}));}
async onImageLoaded(imgEl,attachment){this.debouncedScrollUpdate();if(attachment.mediaType==="libraryMedia"&&!imgEl.src.startsWith("blob")){await this.onLibraryImageLoaded(imgEl,attachment);}}
async onLibraryImageLoaded(imgEl,media){const mediaUrl=imgEl.src;try{const response=await fetch(mediaUrl);if(response.headers.get("content-type").startsWith("image/svg+xml")){let svg=await response.text();const dynamicColors={};const combinedColorsRegex=new RegExp(Object.values(DEFAULT_PALETTE).join("|"),"gi");const htmlStyle=getHtmlStyle(document);svg=svg.replace(combinedColorsRegex,(match)=>{const colorId=Object.keys(DEFAULT_PALETTE).find((key)=>DEFAULT_PALETTE[key]===match.toUpperCase());const colorKey="c"+colorId;dynamicColors[colorKey]=getCSSVariableValue("o-color-"+colorId,htmlStyle);return dynamicColors[colorKey];});const fileName=mediaUrl.split("/").pop();const file=new File([svg],fileName,{type:"image/svg+xml",});imgEl.src=URL.createObjectURL(file);if(Object.keys(dynamicColors).length){media.isDynamicSVG=true;media.dynamicColors=dynamicColors;}}}catch{console.error("CORS is misconfigured on the API server, image will be treated as non-dynamic.");}}}
return __exports;});;

/* /html_editor/static/src/main/media/media_dialog/media_dialog.js */
odoo.define('@html_editor/main/media/media_dialog/media_dialog',['@web/core/l10n/translation','@web/core/utils/hooks','@web/core/dialog/dialog','@web/core/notebook/notebook','@html_editor/main/media/media_dialog/image_selector','@html_editor/main/media/media_dialog/icon_selector','@odoo/owl','@html_editor/utils/dom_info'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{useService,useChildRef}=require("@web/core/utils/hooks");const{Dialog}=require("@web/core/dialog/dialog");const{Notebook}=require("@web/core/notebook/notebook");const{ImageSelector}=require("@html_editor/main/media/media_dialog/image_selector");const{IconSelector}=require("@html_editor/main/media/media_dialog/icon_selector");const{Component,useState,useRef,useEffect}=require("@odoo/owl");const{iconClasses}=require("@html_editor/utils/dom_info");const TABS=__exports.TABS={IMAGES:{id:"IMAGES",title:_t("Images"),Component:ImageSelector,sequence:10,},ICONS:{id:"ICONS",title:_t("Icons"),Component:IconSelector,sequence:20,},};const DEFAULT_SEQUENCE=50;const sequence=(tab)=>tab.sequence??DEFAULT_SEQUENCE;const MediaDialog=__exports.MediaDialog=class MediaDialog extends Component{static template="html_editor.MediaDialog";static defaultProps={useMediaLibrary:true,extraTabs:[],};static components={Dialog,Notebook,};static props={extraTabs:{type:Array,optional:true,element:Object},visibleTabs:{type:Array,optional:true,element:String},activeTab:{type:String,optional:true},"*":true,};setup(){this.size="xl";this.contentClass="o_select_media_dialog h-100";this.title=_t("Select a media");this.modalRef=useChildRef();this.orm=useService("orm");this.notificationService=useService("notification");this.selectedMedia=useState({});this.addButtonRef=useRef("add-button");this.initialIconClasses=[];this.notebookPages=[];this.addTabs();this.notebookPages.sort((a,b)=>sequence(a)-sequence(b));this.tabs=Object.fromEntries(this.notebookPages.map((tab)=>[tab.id,tab]));this.errorMessages={};this.state=useState({activeTab:this.initialActiveTab,isSaving:false,});useEffect((nbSelectedAttachments)=>{this.addButtonRef.el.toggleAttribute("disabled",!nbSelectedAttachments||this.state.isSaving);},()=>[this.selectedMedia[this.state.activeTab].length,this.state.isSaving]);}
get initialActiveTab(){if(this.props.activeTab){return this.props.activeTab;}
if(this.props.media){const correspondingTab=Object.keys(this.tabs).find((id)=>this.tabs[id].Component.tagNames.includes(this.props.media.tagName));if(correspondingTab){return correspondingTab;}}
return this.notebookPages[0].id;}
addTab(tab,additionalProps={}){if(this.props.visibleTabs&&!this.props.visibleTabs.includes(tab.id)){return;}
this.selectedMedia[tab.id]=[];this.notebookPages.push({...tab,props:{...tab.props,...additionalProps,id:tab.id,resModel:this.props.resModel,resId:this.props.resId,media:this.props.media,selectedMedia:this.selectedMedia,selectMedia:(...args)=>this.selectMedia(...args,tab.id,additionalProps.multiSelect),save:this.save.bind(this),onAttachmentChange:this.props.onAttachmentChange,errorMessages:(errorMessage)=>(this.errorMessages[tab.id]=errorMessage),modalRef:this.modalRef,},});}
addTabs(){const onlyImages=this.props.onlyImages||(this.props.media&&this.props.media.parentElement&&(this.props.media.parentElement.dataset.oeField==="image"||this.props.media.parentElement.dataset.oeType==="image"));if(!this.props.noImages){this.addTab(TABS.IMAGES,{useMediaLibrary:this.props.useMediaLibrary,multiSelect:this.props.multiImages,addFieldImage:this.props.addFieldImage,});}
if(onlyImages){return;}
const addIcons=!this.props.visibleTabs||this.props.visibleTabs.includes(TABS.ICONS.id);if(addIcons){const fonts=TABS.ICONS.Component.initFonts();this.addTab(TABS.ICONS,{fonts,});if(this.props.media&&TABS.ICONS.Component.tagNames.includes(this.props.media.tagName)){const classes=this.props.media.className.split(/\s+/);const predefinedMediaFont=fonts.find((font)=>classes.includes(font.base));if(predefinedMediaFont){const selectedIcon=predefinedMediaFont.icons.find((icon)=>icon.names.some((name)=>classes.includes(name)));if(selectedIcon){this.initialIconClasses.push(...selectedIcon.names);this.selectMedia(selectedIcon,TABS.ICONS.id);}}else{const iconRegex=new RegExp(`\\b(?:${iconClasses.join("|")})(?:-\\S+)?\\b`);const fallbackIconClasses=classes.filter((cls)=>iconRegex.test(cls));this.initialIconClasses.push(...fallbackIconClasses);}}}
this.props.extraTabs.forEach((tab)=>this.addTab(tab));}
async renderMedia(selectedMedia){const elements=await this.tabs[this.state.activeTab].Component.createElements(selectedMedia,{orm:this.orm});elements.forEach((element)=>{if(this.props.media){element.classList.add(...this.props.media.classList);const style=this.props.media.getAttribute("style");if(style){element.setAttribute("style",style);}
if(this.state.activeTab===TABS.IMAGES.id){if(this.props.media.dataset.shape){element.dataset.shape=this.props.media.dataset.shape;}
if(this.props.media.dataset.shapeColors){element.dataset.shapeColors=this.props.media.dataset.shapeColors;}
if(this.props.media.dataset.shapeFlip){element.dataset.shapeFlip=this.props.media.dataset.shapeFlip;}
if(this.props.media.dataset.shapeRotate){element.dataset.shapeRotate=this.props.media.dataset.shapeRotate;}
if(this.props.media.dataset.hoverEffect){element.dataset.hoverEffect=this.props.media.dataset.hoverEffect;}
if(this.props.media.dataset.hoverEffectColor){element.dataset.hoverEffectColor=this.props.media.dataset.hoverEffectColor;}
if(this.props.media.dataset.hoverEffectStrokeWidth){element.dataset.hoverEffectStrokeWidth=this.props.media.dataset.hoverEffectStrokeWidth;}
if(this.props.media.dataset.hoverEffectIntensity){element.dataset.hoverEffectIntensity=this.props.media.dataset.hoverEffectIntensity;}}}
for(const otherTab of Object.keys(this.tabs).filter((key)=>key!==this.state.activeTab)){for(const property of this.tabs[otherTab].Component.mediaSpecificStyles){element.style.removeProperty(property);}
element.classList.remove(...this.tabs[otherTab].Component.mediaSpecificClasses);const extraClassesToRemove=[];for(const name of this.tabs[otherTab].Component.mediaExtraClasses){if(typeof name==="string"){extraClassesToRemove.push(name);}else{for(const className of element.classList){if(className.match(name)){extraClassesToRemove.push(className);}}}}
element.classList.remove(...extraClassesToRemove.filter((candidateName)=>{for(const name of this.tabs[this.state.activeTab].Component.mediaExtraClasses){if(typeof name==="string"){if(candidateName===name){return false;}}else{if(candidateName.match(name)){return false;}}}
return true;}));}
element.classList.remove(...this.initialIconClasses);element.classList.remove("o_modified_image_to_save");element.classList.remove("oe_edited_link");element.classList.add(...this.tabs[this.state.activeTab].Component.mediaSpecificClasses);});return elements;}
selectMedia(media,tabId,multiSelect){if(media&&!Object.keys(media).length){this.selectedMedia[tabId]=[];return;}
if(multiSelect){const isMediaSelected=this.selectedMedia[tabId].map(({id})=>id).includes(media.id);if(!isMediaSelected){this.selectedMedia[tabId].push(media);}else{this.selectedMedia[tabId]=this.selectedMedia[tabId].filter((m)=>m.id!==media.id);}}else{this.selectedMedia[tabId]=[media];}}
async save(){if(this.errorMessages[this.state.activeTab]){this.notificationService.add(this.errorMessages[this.state.activeTab],{type:"danger",});return;}
const selectedMedia=this.selectedMedia[this.state.activeTab];const saveSelectedMedia=selectedMedia.length&&(this.state.activeTab!==TABS.ICONS.id||selectedMedia[0].initialIconChanged||!this.props.media);this.state.isSaving=true;if(saveSelectedMedia){const elements=await this.renderMedia(selectedMedia);if(this.props.multiImages){await this.props.save(elements,selectedMedia,this.state.activeTab);}else{await this.props.save(elements[0],selectedMedia,this.state.activeTab);}}
this.props.close();this.state.isSaving=false;}
onTabChange(tab){this.state.activeTab=tab;}}
return __exports;});;

/* /html_editor/static/src/main/media/media_dialog/search_media.js */
odoo.define('@html_editor/main/media/media_dialog/search_media',['@web/core/utils/timing','@web/core/utils/hooks','@odoo/owl'],function(require){'use strict';let __exports={};const{useDebounced}=require("@web/core/utils/timing");const{useAutofocus}=require("@web/core/utils/hooks");const{Component,useEffect,useState}=require("@odoo/owl");const SearchMedia=__exports.SearchMedia=class SearchMedia extends Component{static template="html_editor.SearchMedia";static props=["searchPlaceholder","search","needle"];setup(){useAutofocus({mobile:true});this.debouncedSearch=useDebounced(this.props.search,1000);this.state=useState({input:this.props.needle||"",});useEffect((input)=>{if(this.hasRendered){this.debouncedSearch(input);}else{this.hasRendered=true;}},()=>[this.state.input]);}}
return __exports;});;

/* /html_editor/static/src/main/media/media_dialog/upload_progress_toast/upload_progress_toast.js */
odoo.define('@html_editor/main/media/media_dialog/upload_progress_toast/upload_progress_toast',['@web/core/l10n/translation','@web/core/utils/hooks','@odoo/owl'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{useService}=require("@web/core/utils/hooks");const{Component,useState}=require("@odoo/owl");const ProgressBar=__exports.ProgressBar=class ProgressBar extends Component{static template="html_editor.ProgressBar";static props={progress:{type:Number,optional:true},hasError:{type:Boolean,optional:true},uploaded:{type:Boolean,optional:true},name:String,size:{type:String,optional:true},errorMessage:{type:String,optional:true},};static defaultProps={progress:0,hasError:false,uploaded:false,size:"",errorMessage:"",};get errorMessage(){return this.props.errorMessage||_t("File could not be saved");}
get progress(){return Math.round(this.props.progress);}}
const UploadProgressToast=__exports.UploadProgressToast=class UploadProgressToast extends Component{static template="html_editor.UploadProgressToast";static components={ProgressBar,};static props={close:Function,};setup(){this.uploadService=useService("upload");this.state=useState(this.uploadService.progressToast);}}
return __exports;});;

/* /html_editor/static/src/main/media/media_dialog/upload_progress_toast/upload_service.js */
odoo.define('@html_editor/main/media/media_dialog/upload_progress_toast/upload_service',['@web/core/network/rpc','@web/core/registry','@html_editor/main/media/media_dialog/upload_progress_toast/upload_progress_toast','@web/core/l10n/translation','@web/core/utils/files','@web/core/utils/numbers','@web/core/utils/urls','@odoo/owl'],function(require){'use strict';let __exports={};const{rpc}=require("@web/core/network/rpc");const{registry}=require("@web/core/registry");const{UploadProgressToast}=require("@html_editor/main/media/media_dialog/upload_progress_toast/upload_progress_toast");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{checkFileSize}=require("@web/core/utils/files");const{humanNumber}=require("@web/core/utils/numbers");const{getDataURLFromFile}=require("@web/core/utils/urls");const{reactive}=require("@odoo/owl");const AUTOCLOSE_DELAY=__exports.AUTOCLOSE_DELAY=3000;const AUTOCLOSE_DELAY_LONG=__exports.AUTOCLOSE_DELAY_LONG=8000;const uploadService=__exports.uploadService={dependencies:["notification"],start(env,{notification}){let fileId=0;const progressToast=reactive({files:{},isVisible:false,});registry.category("main_components").add("UploadProgressToast",{Component:UploadProgressToast,props:{close:()=>(progressToast.isVisible=false),},});const addFile=(file)=>{progressToast.files[file.id]=file;progressToast.isVisible=true;return progressToast.files[file.id];};const deleteFile=(fileId)=>{delete progressToast.files[fileId];if(!Object.keys(progressToast.files).length){progressToast.isVisible=false;}};return{get progressToast(){return progressToast;},get fileId(){return fileId;},addFile,deleteFile,incrementId(){fileId++;},uploadUrl:async(url,{resModel,resId},onUploaded)=>{const attachment=await rpc("/html_editor/attachment/add_url",{url,res_model:resModel,res_id:resId,});await onUploaded(attachment);},uploadFiles:async(files,{resModel,resId,isImage},onUploaded)=>{const sortedFiles=Array.from(files).sort((a,b)=>a.size-b.size);for(const file of sortedFiles){let fileSize=file.size;if(!checkFileSize(fileSize,notification)){return null;}
if(!fileSize){fileSize="";}else{fileSize=humanNumber(fileSize)+"B";}
const id=++fileId;file.progressToastId=id;addFile({id,name:file.name,size:fileSize,});}
for(const sortedFile of sortedFiles){const file=progressToast.files[sortedFile.progressToastId];let dataURL;try{dataURL=await getDataURLFromFile(sortedFile);}catch{deleteFile(file.id);env.services.notification.add(_t('Could not load the file "%s".',sortedFile.name),{type:"danger"});continue;}
try{const xhr=new XMLHttpRequest();xhr.upload.addEventListener("progress",(ev)=>{const rpcComplete=(ev.loaded/ev.total)*100;file.progress=rpcComplete;});xhr.upload.addEventListener("load",function(){file.progress=100;});const attachment=await rpc("/html_editor/attachment/add_data",{name:file.name,data:dataURL.split(",")[1],res_id:resId,res_model:resModel,is_image:!!isImage,width:0,quality:0,},{xhr});if(attachment.error){file.hasError=true;file.errorMessage=attachment.error;}else{if(attachment.mimetype==="image/webp"){const image=document.createElement("img");image.src=`data:image/webp;base64,${dataURL.split(",")[1]}`;await new Promise((resolve)=>image.addEventListener("load",resolve));const canvas=document.createElement("canvas");canvas.width=image.width;canvas.height=image.height;const ctx=canvas.getContext("2d");ctx.fillStyle="rgb(255, 255, 255)";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.drawImage(image,0,0);const altDataURL=canvas.toDataURL("image/jpeg");await rpc("/html_editor/attachment/add_data",{name:file.name.replace(/\.webp$/,".jpg"),data:altDataURL.split(",")[1],res_id:attachment.id,res_model:"ir.attachment",is_image:true,width:0,quality:0,},{xhr});}
file.uploaded=true;await onUploaded(attachment);}
const message_autoclose_delay=file.hasError?AUTOCLOSE_DELAY_LONG:AUTOCLOSE_DELAY;setTimeout(()=>deleteFile(file.id),message_autoclose_delay);}catch(error){file.hasError=true;setTimeout(()=>deleteFile(file.id),AUTOCLOSE_DELAY_LONG);throw error;}}},};},};registry.category("services").add("upload",uploadService);return __exports;});;

/* /html_editor/static/src/main/media/media_dialog/video_selector.js */
odoo.define('@html_editor/main/media/media_dialog/video_selector',['@web/core/l10n/translation','@web/core/network/rpc','@web/core/utils/hooks','@web/core/utils/timing','@odoo/owl','@html_editor/components/switch/switch'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{rpc}=require("@web/core/network/rpc");const{useAutofocus,useService}=require("@web/core/utils/hooks");const{debounce}=require("@web/core/utils/timing");const{Component,useState,useRef,onMounted,status}=require("@odoo/owl");const{Switch}=require("@html_editor/components/switch/switch");class VideoOption extends Component{static template="html_editor.VideoOption";static components={Switch,};static props={description:{type:String,optional:true},label:{type:String,optional:true},onChangeOption:Function,onChangeStartAt:Function,value:{type:String,optional:true},name:{type:String,optional:true},};get showStartAtInput(){return this.props.name==="start_from";}}
class VideoIframe extends Component{static template="html_editor.VideoIframe";static props={src:{type:String},};}
const VideoSelector=__exports.VideoSelector=class VideoSelector extends Component{static mediaSpecificClasses=["media_iframe_video"];static mediaSpecificStyles=[];static mediaExtraClasses=[];static tagNames=["IFRAME","DIV"];static template="html_editor.VideoSelector";static components={VideoIframe,VideoOption,};static props={selectMedia:Function,errorMessages:Function,vimeoPreviewIds:{type:Array,optional:true},isForBgVideo:{type:Boolean,optional:true},media:{validate:(p)=>p.nodeType===Node.ELEMENT_NODE,optional:true},"*":true,};static defaultProps={vimeoPreviewIds:[],isForBgVideo:false,};setup(){this.http=useService("http");this.state=useState({options:[],src:"",urlInput:"",platform:null,vimeoPreviews:[],errorMessage:"",});this.PLATFORMS={youtube:"youtube",dailymotion:"dailymotion",vimeo:"vimeo",};this.platformParams={youtube:"start",dailymotion:"startTime",vimeo:"#t=",};this.OPTIONS={autoplay:{label:_t("Autoplay"),description:_t("Videos are muted when autoplay is enabled"),platforms:[this.PLATFORMS.youtube,this.PLATFORMS.vimeo,],urlParameter:()=>"autoplay=1",},loop:{label:_t("Loop"),platforms:[this.PLATFORMS.youtube,this.PLATFORMS.vimeo],urlParameter:()=>"loop=1",},hide_controls:{label:_t("Hide player controls"),platforms:[this.PLATFORMS.youtube,this.PLATFORMS.vimeo,],urlParameter:()=>"controls=0",},hide_fullscreen:{label:_t("Hide fullscreen button"),platforms:[this.PLATFORMS.youtube],urlParameter:()=>"fs=0",isHidden:()=>this.state.options.filter((option)=>option.id==="hide_controls")[0].value,},start_from:{label:_t("Start at"),platforms:[this.PLATFORMS.youtube,this.PLATFORMS.vimeo,this.PLATFORMS.dailymotion,],urlParameter:()=>this.platformParams[this.state.platform],},};this.urlInputRef=useRef("url-input");onMounted(async()=>{if(this.props.media){const src=this.props.media.dataset.oeExpression||this.props.media.dataset.src||(this.props.media.tagName==="IFRAME"&&this.props.media.getAttribute("src"))||"";if(src){this.state.urlInput=src;if(!src.startsWith("https:")&&!src.startsWith("http:")){this.state.urlInput="https:"+this.state.urlInput;}
await this.syncOptionsWithUrl();if(status(this)==="destroyed"){return;}}}
await this.prepareVimeoPreviews();});useAutofocus();this.onChangeUrl=debounce(()=>this.syncOptionsWithUrl(),500);this.onChangeStartAt=debounce(async(ev,optionId)=>{const start_from=this.convertTimestampToSeconds(ev.target.value);this.state.options=this.state.options.map((option)=>{if(option.id===optionId){return{...option,value:start_from==="0"?"00:00":start_from};}
return option;});await this.updateVideo();this.state.urlInput="https:"+this.state.src;},1000);}
get shownOptions(){if(this.props.isForBgVideo){return[];}
return this.state.options.filter((option)=>!this.OPTIONS[option.id].isHidden||!this.OPTIONS[option.id].isHidden());}
get value(){if(this.option.id==="start_from"&&this.option.value!=="00:00"){return this.convertSecondsToTimestamp(this.option.value);}
return this.option.value;}
async onChangeOption(optionId){this.state.options=this.state.options.map((option)=>{if(option.id===optionId){return{...option,value:!option.value&&"00:00"};}
return option;});await this.updateVideo();this.state.urlInput="https:"+this.state.src;}
async onClickSuggestion(src){this.state.urlInput=src;await this.updateVideo();}
async updateVideo(){if(!this.state.urlInput){this.state.src="";this.state.urlInput="";this.state.options=[];this.state.platform=null;this.state.errorMessage="";this.props.selectMedia({});return;}
const embedMatch=this.state.urlInput.match(/(src|href)=["']?([^"']+)?/);if(embedMatch&&embedMatch[2].length>0&&embedMatch[2].indexOf("instagram")){embedMatch[1]=embedMatch[2];}
const url=embedMatch?embedMatch[1]:this.state.urlInput;const options={};if(this.props.isForBgVideo&&URL.canParse(url)){const parsedUrl=new URL(url);const urlParams=parsedUrl.searchParams;const startFrom=urlParams.get("start")||urlParams.get("startTime")||urlParams.get("t");Object.keys(this.OPTIONS).forEach((key)=>{options[key]=key==="start_from"?startFrom:true;});}else{for(const option of this.shownOptions){options[option.id]=option.value;}}
const{embed_url:src,video_id:videoId,params,platform,}=await this._getVideoURLData(url,options);if(!src){this.state.errorMessage=_t("The provided url is not valid");}else if(!platform){this.state.errorMessage=_t("The provided url does not reference any supported video");}else{this.state.errorMessage="";}
this.props.errorMessages(this.state.errorMessage);const newOptions=[];if(platform&&platform!==this.state.platform){Object.keys(this.OPTIONS).forEach((key)=>{if(this.OPTIONS[key].platforms.includes(platform)){const{label,description}=this.OPTIONS[key];newOptions.push({id:key,label,description});}});}
this.state.src=src;this.props.selectMedia({id:src,src,platform,videoId,params,});if(platform!==this.state.platform){this.state.platform=platform;this.state.options=newOptions;}}
async _getVideoURLData(url,options){return await rpc("/html_editor/video_url/data",{video_url:url,...options,});}
static createElements(selectedMedia){return selectedMedia.map((video)=>{const div=document.createElement("div");div.dataset.oeExpression=video.src;div.innerHTML='<div class="css_editable_mode_display"></div>'+'<div class="media_iframe_video_size" contenteditable="false"></div>'+'<iframe frameborder="0" contenteditable="false" allowfullscreen="allowfullscreen"></iframe>';div.querySelector("iframe").src=video.src;return div;});}
async prepareVimeoPreviews(){await Promise.all(this.props.vimeoPreviewIds.map(async(videoId)=>{const{thumbnail_url:thumbnailSrc}=await this.http.get(`https://vimeo.com/api/oembed.json?url=http%3A//vimeo.com/${encodeURIComponent(
                        videoId
                    )}`);this.state.vimeoPreviews.push({id:videoId,thumbnailSrc,src:`https://player.vimeo.com/video/${encodeURIComponent(videoId)}`,});}));}
async syncOptionsWithUrl(){await this.updateVideo();if(!URL.canParse(this.state.urlInput)){return;}
const parsedUrl=new URL(this.state.urlInput);const urlParams=parsedUrl.searchParams;this.state.options=this.state.options.map((option)=>{const urlParameter=this.OPTIONS[option.id].urlParameter();let value="";switch(urlParameter){case"#t=":value=this.parseTimeToSeconds(this.state.urlInput.split("#t=")[1]);break;case"start":value=urlParams.get("start")||urlParams.get("t");break;case"startTime":value=urlParams.get("startTime")||urlParams.get("start");break;default:value=this.state.urlInput.includes(urlParameter);}
if(option.id==="start_from"&&value==="0"){return{...option,value:"00:00"};}
return{...option,value:value||""};});await this.updateVideo();}
convertTimestampToSeconds(timestamp){timestamp=timestamp.trim();const timeRegex=/^(?:(\d+):)?([0-5]?\d):([0-5]?\d)$/;if(timeRegex.test(timestamp)){return(timestamp=timestamp.split(":").reduce((acc,time)=>acc*60+ +time,0)+"");}
if(isNaN(timestamp)){return"0";}
return timestamp;}
convertSecondsToTimestamp(value){if(!value){return"";}
const match=value.match(/^\d+s?$/);if(!match){return"";}
const totalSeconds=parseInt(match[0],10);if(!Number.isFinite(totalSeconds)||totalSeconds<=0){return value;}
const hours=Math.floor(totalSeconds/3600);const minutes=Math.floor((totalSeconds%3600)/60);const seconds=totalSeconds%60;const pad=(n)=>String(n).padStart(2,"0");if(hours>0){return`${hours}:${pad(minutes)}:${pad(seconds)}`;}
return`${minutes}:${pad(seconds)}`;}
parseTimeToSeconds(value){const match=value?.match(/^(?:(\d+)m(\d+)s|(\d+)m|(\d+)s|(\d+))$/);if(!match){return value;}
let minutes=match[1]||match[3];minutes=parseInt(minutes||"0",10);let seconds=match[2]||match[4]||match[5];seconds=parseInt(seconds||"0",10);return String(minutes*60+seconds);}}
return __exports;});;

/* /website/static/src/components/media_dialog/image_selector.js */
odoo.define('@website/components/media_dialog/image_selector',['@web/core/utils/patch','@html_editor/main/media/media_dialog/image_selector'],function(require){'use strict';let __exports={};const{patch}=require("@web/core/utils/patch");const{ImageSelector:HtmlImageSelector}=require("@html_editor/main/media/media_dialog/image_selector");patch(HtmlImageSelector.prototype,{get attachmentsDomain(){const domain=super.attachmentsDomain;domain.push("|",["url","=",false],"!",["url","=like","/web/image/website.%"]);domain.push(["key","=",false]);return domain;},});return __exports;});;

/* /web_unsplash/static/src/media_dialog/image_selector_patch.js */
odoo.define('@web_unsplash/media_dialog/image_selector_patch',['@web/core/l10n/translation','@web/core/utils/patch','@web/core/utils/concurrency','@web/core/network/rpc','@web/core/utils/hooks','@html_editor/main/media/media_dialog/image_selector','@web_unsplash/unsplash_error/unsplash_error','@odoo/owl'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web_unsplash",...args);const{patch}=require("@web/core/utils/patch");const{KeepLast}=require("@web/core/utils/concurrency");const{rpc}=require("@web/core/network/rpc");const{useService}=require("@web/core/utils/hooks");const{ImageSelector}=require("@html_editor/main/media/media_dialog/image_selector");const{UnsplashError}=require("@web_unsplash/unsplash_error/unsplash_error");const{useState}=require("@odoo/owl");patch(ImageSelector.prototype,{setup(){super.setup();this.unsplash=useService("unsplash");this.keepLastUnsplash=new KeepLast();this.unsplashState=useState({unsplashRecords:[],isFetchingUnsplash:false,isMaxed:false,unsplashError:null,useUnsplash:true,});this.NUMBER_OF_RECORDS_TO_DISPLAY=30;this.errorMessages={key_not_found:{title:_t("Setup Unsplash to access royalty free photos."),subtitle:"",},401:{title:_t("Unauthorized Key"),subtitle:_t("Please check your Unsplash access key and application ID."),},403:{title:_t("Search is temporarily unavailable"),subtitle:_t("The max number of searches is exceeded. Please retry in an hour or extend to a better account."),},};},get canLoadMore(){if(this.state.searchService==="all"){return(super.canLoadMore||(this.state.needle&&!this.unsplashState.isMaxed&&!this.unsplashState.unsplashError));}else if(this.state.searchService==="unsplash"){return(this.state.needle&&!this.unsplashState.isMaxed&&!this.unsplashState.unsplashError);}
return super.canLoadMore;},get hasContent(){if(this.state.searchService==="all"){return super.hasContent||!!this.unsplashState.unsplashRecords.length;}else if(this.state.searchService==="unsplash"){return!!this.unsplashState.unsplashRecords.length;}
return super.hasContent;},get errorTitle(){if(this.errorMessages[this.unsplashState.unsplashError]){return this.errorMessages[this.unsplashState.unsplashError].title;}
return _t("Something went wrong");},get errorSubtitle(){if(this.errorMessages[this.unsplashState.unsplashError]){return this.errorMessages[this.unsplashState.unsplashError].subtitle;}
return _t("Please check your internet connection or contact administrator.");},get selectedRecordIds(){return this.props.selectedMedia[this.props.id].filter((media)=>media.mediaType==="unsplashRecord").map(({id})=>id);},get isFetching(){return super.isFetching||this.unsplashState.isFetchingUnsplash;},get combinedRecords(){function alternate(a,b){return[a.map((v,i)=>(i<b.length?[v,b[i]]:v)),b.slice(a.length)].flat(2);}
return alternate(this.unsplashState.unsplashRecords,this.state.libraryMedia);},get allAttachments(){return[...super.allAttachments,...this.unsplashState.unsplashRecords];},async fetchUnsplashRecords(offset){if(!this.state.needle){return{records:[],isMaxed:false};}
this.unsplashState.isFetchingUnsplash=true;try{const{isMaxed,images}=await this.unsplash.getImages(this.state.needle,offset,this.NUMBER_OF_RECORDS_TO_DISPLAY,this.props.orientation);this.unsplashState.isFetchingUnsplash=false;this.unsplashState.unsplashError=false;const existingIds=new Set(this.unsplashState.unsplashRecords.map(r=>r.id));const newImages=images.filter(record=>{if(existingIds.has(record.id)){return false;}
existingIds.add(record.id);return true;});const records=newImages.map((record)=>{const url=new URL(record.urls.regular);url.searchParams.set("h",2*this.MIN_ROW_HEIGHT);url.searchParams.delete("w");return Object.assign({},record,{url:url.toString(),mediaType:"unsplashRecord",});});return{isMaxed,records};}catch(e){this.unsplashState.isFetchingUnsplash=false;if(e==="no_access"){this.unsplashState.useUnsplash=false;}else{this.unsplashState.unsplashError=e;}
return{records:[],isMaxed:true};}},async loadMore(...args){await super.loadMore(...args);return this.keepLastUnsplash.add(this.fetchUnsplashRecords(this.unsplashState.unsplashRecords.length)).then(({records,isMaxed})=>{this.unsplashState.unsplashRecords.push(...records);this.unsplashState.isMaxed=isMaxed;});},async search(...args){await super.search(...args);await this.searchUnsplash();},async searchUnsplash(){if(!this.state.needle){this.unsplashState.unsplashError=false;this.unsplashState.unsplashRecords=[];this.unsplashState.isMaxed=false;}
return this.keepLastUnsplash.add(this.fetchUnsplashRecords(0)).then(({records,isMaxed})=>{this.unsplashState.unsplashRecords=records;this.unsplashState.isMaxed=isMaxed;});},async onClickRecord(media){this.props.selectMedia({...media,mediaType:"unsplashRecord",query:this.state.needle});if(!this.props.multiSelect){await this.props.save();}},async submitCredentials(key,appId){this.unsplashState.unsplashError=null;await rpc("/web_unsplash/save_unsplash",{key,appId});await this.searchUnsplash();},});ImageSelector.components={...ImageSelector.components,UnsplashError,};return __exports;});;

/* /web_unsplash/static/src/media_dialog/media_dialog_patch.js */
odoo.define('@web_unsplash/media_dialog/media_dialog_patch',['@html_editor/main/media/media_dialog/media_dialog','@web/core/utils/patch','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{MediaDialog,TABS}=require("@html_editor/main/media/media_dialog/media_dialog");const{patch}=require("@web/core/utils/patch");const{useService}=require("@web/core/utils/hooks");patch(MediaDialog.prototype,{setup(){super.setup();this.unsplashService=useService("unsplash");},async save(){const selectedImages=this.selectedMedia[TABS.IMAGES.id];if(selectedImages){const unsplashRecords=selectedImages.filter((media)=>media.mediaType==="unsplashRecord");if(unsplashRecords.length){await this.unsplashService.uploadUnsplashRecords(unsplashRecords,{resModel:this.props.resModel,resId:this.props.resId},(attachments)=>{this.selectedMedia[TABS.IMAGES.id]=this.selectedMedia[TABS.IMAGES.id].filter((media)=>media.mediaType!=="unsplashRecord");this.selectedMedia[TABS.IMAGES.id]=this.selectedMedia[TABS.IMAGES.id].concat(attachments.map((attachment)=>({...attachment,mediaType:"attachment",})));});}}
return super.save(...arguments);},});return __exports;});;

/* /web_unsplash/static/src/unsplash_credentials/unsplash_credentials.js */
odoo.define('@web_unsplash/unsplash_credentials/unsplash_credentials',['@odoo/owl'],function(require){'use strict';let __exports={};const{Component,useState}=require("@odoo/owl");const UnsplashCredentials=__exports.UnsplashCredentials=class UnsplashCredentials extends Component{static template="web_unsplash.UnsplashCredentials";static props={submitCredentials:Function,hasCredentialsError:Boolean,};setup(){this.state=useState({key:"",appId:"",hasKeyError:this.props.hasCredentialsError,hasAppIdError:this.props.hasCredentialsError,});}
submitCredentials(){if(this.state.key===""){this.state.hasKeyError=true;}else if(this.state.appId===""){this.state.hasAppIdError=true;}else{this.props.submitCredentials(this.state.key,this.state.appId);}}}
return __exports;});;

/* /web_unsplash/static/src/unsplash_error/unsplash_error.js */
odoo.define('@web_unsplash/unsplash_error/unsplash_error',['@odoo/owl','@web_unsplash/unsplash_credentials/unsplash_credentials'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const{UnsplashCredentials}=require("@web_unsplash/unsplash_credentials/unsplash_credentials");const UnsplashError=__exports.UnsplashError=class UnsplashError extends Component{static template="web_unsplash.UnsplashError";static components={UnsplashCredentials,};static props={title:String,subtitle:String,showCredentials:Boolean,submitCredentials:{type:Function,optional:true},hasCredentialsError:{type:Boolean,optional:true},};}
return __exports;});;

/* /web_unsplash/static/src/unsplash_service.js */
odoo.define('@web_unsplash/unsplash_service',['@web/core/network/rpc','@web/core/registry','@web/core/l10n/translation','@html_editor/main/media/media_dialog/upload_progress_toast/upload_service'],function(require){'use strict';let __exports={};const{rpc}=require("@web/core/network/rpc");const{registry}=require("@web/core/registry");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web_unsplash",...args);const{AUTOCLOSE_DELAY}=require("@html_editor/main/media/media_dialog/upload_progress_toast/upload_service");const unsplashService=__exports.unsplashService={dependencies:["upload"],async start(env,{upload}){const _cache={};return{async uploadUnsplashRecords(records,{resModel,resId},onUploaded){upload.incrementId();const file=upload.addFile({id:upload.fileId,name:records.length>1?_t("Uploading %(count)s '%(query)s' images.",{count:records.length,query:records[0].query,}):_t("Uploading '%s' image.",records[0].query),});try{const urls={};for(const record of records){const _1920Url=new URL(record.urls.regular);_1920Url.searchParams.set("w","1920");urls[record.id]={url:_1920Url.href,download_url:record.links.download_location,description:record.alt_description,};}
const xhr=new XMLHttpRequest();xhr.upload.addEventListener("progress",(ev)=>{const rpcComplete=(ev.loaded/ev.total)*100;file.progress=rpcComplete;});xhr.upload.addEventListener("load",function(){file.progress=100;});const attachments=await rpc("/web_unsplash/attachment/add",{res_id:resId,res_model:resModel,unsplashurls:urls,query:records[0].query,},{xhr});if(attachments.error){file.hasError=true;file.errorMessage=attachments.error;}else{file.uploaded=true;await onUploaded(attachments);}
setTimeout(()=>upload.deleteFile(file.id),AUTOCLOSE_DELAY);}catch(error){file.hasError=true;setTimeout(()=>upload.deleteFile(file.id),AUTOCLOSE_DELAY);throw error;}},async getImages(query,offset=0,pageSize=30,orientation){const from=offset;const to=offset+pageSize;let cachedData=orientation?_cache[query+orientation]:_cache[query];if(cachedData&&(cachedData.images.length>=to||(cachedData.totalImages!==0&&cachedData.totalImages<to))){return{images:cachedData.images.slice(from,to),isMaxed:to>cachedData.totalImages,};}
cachedData=await this._fetchImages(query,orientation);return{images:cachedData.images.slice(from,to),isMaxed:to>cachedData.totalImages,};},async _fetchImages(query,orientation){const key=orientation?query+orientation:query;if(!_cache[key]){_cache[key]={images:[],maxPages:0,totalImages:0,pageCached:0,};}
const cachedData=_cache[key];const payload={query:query,page:cachedData.pageCached+1,per_page:30,};if(orientation){payload.orientation=orientation;}
const result=await rpc("/web_unsplash/fetch_images",payload);if(result.error){return Promise.reject(result.error);}
cachedData.pageCached++;cachedData.images.push(...result.results);cachedData.maxPages=result.total_pages;cachedData.totalImages=result.total;return cachedData;},};},};registry.category("services").add("unsplash",unsplashService);return __exports;});;

/* /html_editor/static/src/components/html_viewer/html_viewer.js */
odoo.define('@html_editor/components/html_viewer/html_viewer',['@odoo/owl','@web/core/assets','@web/core/utils/functions','@html_editor/utils/clipboard','@html_editor/utils/sanitize','@html_editor/html_migrations/html_upgrade_manager','@html_editor/others/embedded_components/core/table_of_content/table_of_content_manager','@html_editor/utils/dom_info','@html_editor/utils/url'],function(require){'use strict';let __exports={};const{Component,markup,onMounted,onWillStart,onWillUnmount,onWillUpdateProps,useEffect,useRef,useState,}=require("@odoo/owl");const{getBundle}=require("@web/core/assets");const{memoize}=require("@web/core/utils/functions");const{fillHtmlTransferData}=require("@html_editor/utils/clipboard");const{fixInvalidHTML,instanceofMarkup}=require("@html_editor/utils/sanitize");const{HtmlUpgradeManager}=require("@html_editor/html_migrations/html_upgrade_manager");const{TableOfContentManager}=require("@html_editor/others/embedded_components/core/table_of_content/table_of_content_manager");const{getDeepestPosition}=require("@html_editor/utils/dom_info");const{scrollAndHighlightHeading}=require("@html_editor/utils/url");const HtmlViewer=__exports.HtmlViewer=class HtmlViewer extends Component{static template="html_editor.HtmlViewer";static props={config:{type:Object},migrateHTML:{type:Boolean,optional:true},};static defaultProps={migrateHTML:true,};setup(){this._cleanups=[];this.htmlUpgradeManager=new HtmlUpgradeManager();this.iframeRef=useRef("iframe");this.state=useState({iframeVisible:false,value:this.formatValue(this.props.config.value),});this.components=new Set();onWillUpdateProps((newProps)=>{const newValue=this.formatValue(newProps.config.value);if(newValue.toString()!==this.state.value.toString()){this.state.value=this.formatValue(newProps.config.value);if(this.props.config.embeddedComponents){this.destroyComponents();}
if(this.showIframe){this.updateIframeContent(this.state.value);}}});onWillUnmount(()=>{this.destroyComponents();});if(this.showIframe){onMounted(()=>{const onLoadIframe=()=>this.onLoadIframe(this.state.value);this.iframeRef.el.addEventListener("load",onLoadIframe,{once:true});this.iframeRef.el.after(this.iframeRef.el);});}else{this.readonlyElementRef=useRef("readonlyContent");useEffect(()=>{this.processReadonlyContent(this.readonlyElementRef.el);},()=>[this.props.config.value.toString(),this.readonlyElementRef?.el]);}
onMounted(()=>{scrollAndHighlightHeading(this.readonlyElementRef?.el||this.iframeRef?.el);});if(this.props.config.cssAssetId){onWillStart(async()=>{this.cssAsset=await getBundle(this.props.config.cssAssetId);});}
if(this.props.config.embeddedComponents){this.embeddedComponents=memoize((embeddedComponents=[])=>{const result={};for(const embedding of embeddedComponents){result[embedding.name]=embedding;}
return result;});useEffect(()=>{if(this.readonlyElementRef?.el){this.mountComponents();}},()=>[this.props.config.value.toString(),this.readonlyElementRef?.el]);this.tocManager=new TableOfContentManager(this.readonlyElementRef);}}
addDomListener(target,eventName,fn,capture=false){const handler=(ev)=>{fn?.call(this,ev);};target.addEventListener(eventName,handler,capture);this._cleanups.push(()=>target.removeEventListener(eventName,handler,capture));}
get showIframe(){return this.props.config.hasFullHtml||this.props.config.cssAssetId;}
formatValue(value){let newVal=fixInvalidHTML(value);if(this.props.migrateHTML){newVal=this.htmlUpgradeManager.processForUpgrade(newVal,{containsComplexHTML:this.props.config.hasFullHtml,env:this.env,});}
if(instanceofMarkup(value)){return markup(newVal);}
return newVal;}
processReadonlyContent(container){this.retargetLinks(container);this.applyAccessibilityAttributes(container);this.addDomListener(container,"copy",this.onCopy);}
onCopy(ev){ev.preventDefault();const selection=ev.target.ownerDocument.defaultView.getSelection();const[deepAnchorNode,deepAnchorOffset]=getDeepestPosition(selection.anchorNode,selection.anchorOffset);const[deepFocusNode,deepFocusOffset]=getDeepestPosition(selection.focusNode,selection.focusOffset);const range=new Range();range.setStart(deepAnchorNode,deepAnchorOffset);range.setEnd(deepFocusNode,deepFocusOffset);const clonedContents=range.cloneContents();fillHtmlTransferData(ev,"clipboardData",clonedContents,{textContent:selection.toString(),});}
applyAccessibilityAttributes(container){for(const el of container.querySelectorAll("[data-oe-role]")){el.setAttribute("role",el.dataset.oeRole);}
for(const el of container.querySelectorAll("[data-oe-aria-label]")){el.setAttribute("aria-label",el.dataset.oeAriaLabel);}}
retargetLinks(container){for(const link of container.querySelectorAll("a")){this.retargetLink(link);}}
retargetLink(link){link.setAttribute("target","_blank");link.setAttribute("rel","noreferrer");}
updateIframeContent(content){const contentWindow=this.iframeRef.el.contentWindow;const iframeTarget=this.props.config.hasFullHtml?contentWindow.document.documentElement:contentWindow.document.querySelector("#iframe_target");iframeTarget.innerHTML=content;this.processReadonlyContent(iframeTarget);}
onLoadIframe(value){const contentWindow=this.iframeRef.el.contentWindow;if(!this.props.config.hasFullHtml){contentWindow.document.open("text/html","replace").write(`<!DOCTYPE html><html>
                        <head>
                            <meta charset="utf-8"/>
                            <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
                            <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
                        </head>
                        <body class="o_in_iframe o_readonly" style="overflow: hidden;">
                            <div id="iframe_target"></div>
                        </body>
                    </html>`);}
if(this.cssAsset){for(const cssLib of this.cssAsset.cssLibs){const link=contentWindow.document.createElement("link");link.setAttribute("type","text/css");link.setAttribute("rel","stylesheet");link.setAttribute("href",cssLib);contentWindow.document.head.append(link);}}
this.updateIframeContent(this.state.value);this.state.iframeVisible=true;}
destroyComponent({root,host}){const{getEditableDescendants}=this.getEmbedding(host);const editableDescendants=getEditableDescendants?.(host)||{};root.destroy();this.components.delete(arguments[0]);host.append(...Object.values(editableDescendants));}
destroyComponents(){for(const cleanup of this._cleanups){cleanup();}
for(const info of[...this.components]){this.destroyComponent(info);}}
forEachEmbeddedComponentHost(elem,callback){const selector=`[data-embedded]`;const targets=[...elem.querySelectorAll(selector)];if(elem.matches(selector)){targets.unshift(elem);}
for(const host of targets){const embedding=this.getEmbedding(host);if(!embedding){continue;}
callback(host,embedding);}}
getEmbedding(host){return this.embeddedComponents(this.props.config.embeddedComponents)[host.dataset.embedded];}
setupNewComponent({name,env,props}){if(name==="tableOfContent"){Object.assign(props,{manager:this.tocManager,});}}
mountComponent(host,{Component,getEditableDescendants,getProps,name}){const props=getProps?.(host)||{};const env=Object.create(this.env);if(getEditableDescendants){env.getEditableDescendants=getEditableDescendants;}
this.setupNewComponent({name,env,props,});const root=this.__owl__.app.createRoot(Component,{props,env,});const promise=root.mount(host);promise.catch();const fiber=root.node.fiber;const fiberComplete=fiber.complete;fiber.complete=function(){host.replaceChildren();fiberComplete.call(this);};const info={root,host,};this.components.add(info);}
mountComponents(){this.forEachEmbeddedComponentHost(this.readonlyElementRef.el,(host,embedding)=>{this.mountComponent(host,embedding);});}}
return __exports;});;

/* /html_editor/static/src/local_overlay_container.js */
odoo.define('@html_editor/local_overlay_container',['@odoo/owl','@web/core/main_components_container','@web/core/utils/hooks','@web/core/registry','@web/core/registry_hook'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const{MainComponentsContainer}=require("@web/core/main_components_container");const{useForwardRefToParent}=require("@web/core/utils/hooks");const{registry}=require("@web/core/registry");const{useRegistry}=require("@web/core/registry_hook");const LocalOverlayContainer=__exports.LocalOverlayContainer=class LocalOverlayContainer extends MainComponentsContainer{static template="html_editor.LocalOverlayContainer";static props={localOverlay:{type:Function,optional:true},identifier:{type:String,optional:true},};static defaultProps={identifier:"overlay_components",};setup(){const overlayComponents=registry.category(this.props.identifier);if(!overlayComponents.validationSchema){overlayComponents.addValidation({Component:{validate:(c)=>c.prototype instanceof Component},props:{type:Object,optional:true},});}
this.Components=useRegistry(overlayComponents);useForwardRefToParent("localOverlay");}}
return __exports;});;

/* /html_editor/static/src/position_hook.js */
odoo.define('@html_editor/position_hook',['@html_editor/utils/dom_traversal','@web/core/utils/timing','@web/core/utils/scrolling','@odoo/owl'],function(require){'use strict';let __exports={};const{ancestors}=require("@html_editor/utils/dom_traversal");const{throttleForAnimation}=require("@web/core/utils/timing");const{couldBeScrollableX,couldBeScrollableY}=require("@web/core/utils/scrolling");const{useComponent,useEffect}=require("@odoo/owl");__exports.usePositionHook=usePositionHook;function usePositionHook(containerRef,document,callback){const comp=useComponent();const onLayoutGeometryChange=throttleForAnimation(callback.bind(comp));const resizeObserver=new ResizeObserver(onLayoutGeometryChange);const cleanups=[];const addDomListener=(target,eventName,capture)=>{target.addEventListener(eventName,onLayoutGeometryChange,capture);cleanups.push(()=>target.removeEventListener(eventName,onLayoutGeometryChange,capture));};useEffect(()=>{if(containerRef.el){resizeObserver.observe(document.body);resizeObserver.observe(containerRef.el);addDomListener(window,"resize");if(document.defaultView!==window){addDomListener(document.defaultView,"resize");}
addDomListener(document,"scroll");const scrollableElements=[containerRef.el,...ancestors(containerRef.el)].filter((node)=>couldBeScrollableX(node)||couldBeScrollableY(node));for(const scrollableElement of scrollableElements){addDomListener(scrollableElement,"scroll");resizeObserver.observe(scrollableElement);}}
return()=>{resizeObserver.disconnect();for(const cleanup of cleanups.toReversed()){cleanup();cleanups.pop();}};},()=>[containerRef.el]);}
return __exports;});;

/* /html_editor/static/src/html_migrations/html_migrations_utils.js */
odoo.define('@html_editor/html_migrations/html_migrations_utils',['@web/core/registry'],function(require){'use strict';let __exports={};const{registry}=require("@web/core/registry");__exports.htmlEditorVersions=htmlEditorVersions;function htmlEditorVersions(){return Object.keys(registry.category("html_editor_upgrade").subRegistries).sort(compareVersions);}
const VERSION_SELECTOR=__exports.VERSION_SELECTOR="[data-oe-version]";__exports.stripVersion=stripVersion;function stripVersion(element){element.querySelectorAll(VERSION_SELECTOR).forEach((el)=>{delete el.dataset.oeVersion;});}
__exports.compareVersions=compareVersions;function compareVersions(version1,version2){version1=version1.split(".").map((v)=>parseInt(v));version2=version2.split(".").map((v)=>parseInt(v));if(version1[0]<version2[0]||(version1[0]===version2[0]&&version1[1]<version2[1])){return-1;}else if(version1[0]===version2[0]&&version1[1]===version2[1]){return 0;}else{return 1;}}
return __exports;});;

/* /html_editor/static/src/html_migrations/html_upgrade_manager.js */
odoo.define('@html_editor/html_migrations/html_upgrade_manager',['@odoo/owl','@html_editor/html_migrations/html_migrations_utils','@web/core/registry','@html_editor/utils/sanitize'],function(require){'use strict';let __exports={};const{markup}=require("@odoo/owl");const{compareVersions,VERSION_SELECTOR,htmlEditorVersions,}=require("@html_editor/html_migrations/html_migrations_utils");const{registry}=require("@web/core/registry");const{fixInvalidHTML}=require("@html_editor/utils/sanitize");const HtmlUpgradeManager=__exports.HtmlUpgradeManager=class HtmlUpgradeManager{constructor(){this.upgradeRegistry=registry.category("html_editor_upgrade");this.parser=new DOMParser();this.originalValue=undefined;this.upgradedValue=undefined;this.element=undefined;this.env={};}
get value(){return this.upgradedValue;}
processForUpgrade(value,{containsComplexHTML,env}={}){this.env=env||{};this.containsComplexHTML=containsComplexHTML;const strValue=value.toString();if(strValue===this.originalValue?.toString()||strValue===this.upgradedValue?.toString()){return this.value;}
this.originalValue=value;this.upgradedValue=value;this.element=this.parser.parseFromString(fixInvalidHTML(value),"text/html")[this.containsComplexHTML?"documentElement":"body"];const versionNode=this.element.querySelector(VERSION_SELECTOR);const version=versionNode?.dataset.oeVersion||"0.0";const VERSIONS=htmlEditorVersions();const currentVersion=VERSIONS.at(-1);if(!currentVersion||version===currentVersion){return this.value;}
try{const upgradeSequence=VERSIONS.filter((subVersion)=>compareVersions(subVersion,version)>0);this.upgradedValue=this.upgrade(upgradeSequence);}catch{}
return this.value;}
upgrade(upgradeSequence){for(const version of upgradeSequence){const modules=this.upgradeRegistry.category(version);for(const[key,module]of modules.getEntries()){const migrate=odoo.loader.modules.get(module).migrate;if(!migrate){console.error(`A "${key}" migrate function could not be found at "${module}" or it did not load.`);}
migrate(this.element,this.env);}}
return markup(this.element[this.containsComplexHTML?"outerHTML":"innerHTML"]);}}
return __exports;});;

/* /html_editor/static/src/html_migrations/manifest.js */
odoo.define('@html_editor/html_migrations/manifest',['@web/core/registry'],function(require){'use strict';let __exports={};const{registry}=require("@web/core/registry");const html_upgrade=registry.category("html_editor_upgrade");html_upgrade.category("1.0");html_upgrade.category("1.1").add("html_editor","@html_editor/html_migrations/migration-1.1");html_upgrade.category("1.2").add("html_editor","@html_editor/html_migrations/migration-1.2");html_upgrade.category("2.0");return __exports;});;

/* /html_editor/static/src/html_migrations/migration-1.1.js */
odoo.define('@html_editor/html_migrations/migration-1.1',[],function(require){'use strict';let __exports={};__exports.migrate=migrate;function migrate(container){const excalidrawContainers=container.querySelectorAll("[data-embedded='draw']");for(const excalidrawContainer of excalidrawContainers){const source=JSON.parse(excalidrawContainer.dataset.embeddedProps).source;const newParagraph=document.createElement("P");const anchor=document.createElement("A");newParagraph.append(anchor);anchor.append(document.createTextNode(source));anchor.href=source;excalidrawContainer.after(newParagraph);excalidrawContainer.remove();}}
return __exports;});;

/* /html_editor/static/src/html_migrations/migration-1.2.js */
odoo.define('@html_editor/html_migrations/migration-1.2',['@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const ARIA_LABELS={".o_editor_banner.alert-danger":_t("Banner Danger"),".o_editor_banner.alert-info":_t("Banner Info"),".o_editor_banner.alert-success":_t("Banner Success"),".o_editor_banner.alert-warning":_t("Banner Warning"),};function getAriaLabel(element){for(const[selector,ariaLabel]of Object.entries(ARIA_LABELS)){if(element.matches(selector)){return ariaLabel;}}}
__exports.migrate=migrate;function migrate(container){const bannerContainers=container.querySelectorAll(".o_editor_banner");for(const bannerContainer of bannerContainers){bannerContainer.classList.remove("o_not_editable");bannerContainer.classList.add("o-contenteditable-false");bannerContainer.dataset.oeRole="status";const icon=bannerContainer.querySelector(".o_editor_banner_icon");if(icon){const ariaLabel=getAriaLabel(bannerContainer);if(ariaLabel){icon.dataset.oeAriaLabel=ariaLabel;}}
const bannerContent=bannerContainer.querySelector(".o_editor_banner_icon ~ div");if(bannerContent){bannerContent.classList.remove("o_editable");bannerContent.classList.add("o_editor_banner_content");bannerContent.classList.add("o-contenteditable-true");}}}
return __exports;});;

/* /html_editor/static/src/others/embedded_component_utils.js */
odoo.define('@html_editor/others/embedded_component_utils',['@odoo/owl'],function(require){'use strict';let __exports={};const{onMounted,onRendered,onPatched,onWillDestroy,reactive,toRaw,useComponent,useRef,useState,}=require("@odoo/owl");__exports.getEditableDescendants=getEditableDescendants;function getEditableDescendants(host){const editableDescendants={};for(const candidate of host.querySelectorAll("[data-embedded-editable]")){if(candidate.closest("[data-embedded]")===host){editableDescendants[candidate.dataset.embeddedEditable]=candidate;}}
return editableDescendants;}
__exports.useEditableDescendants=useEditableDescendants;function useEditableDescendants(host){const component=useComponent();if(!component.env.getEditableDescendants){throw new Error("Missing `getEditableDescendants` function in the `embedding` provided to the `EmbeddedComponentPlugin`.");}
const editableDescendants=Object.freeze(component.env.getEditableDescendants(host));const refs={};const renders={};for(const name of Object.keys(editableDescendants)){refs[name]=useRef(name);renders[name]=()=>refs[name].el.replaceChildren(editableDescendants[name]);}
let _restoreSelection;const restoreSelection=()=>{if(_restoreSelection){_restoreSelection();_restoreSelection=undefined;}};if(component.env.editorShared?.selection){onRendered(()=>{_restoreSelection=component.env.editorShared.selection.preserveSelection().restore;});}
onMounted(()=>{for(const render of Object.values(renders)){render();}
restoreSelection();});onPatched(()=>{for(const[name,render]of Object.entries(renders)){if(!host.contains(editableDescendants[name])){render();}}
restoreSelection();});return editableDescendants;}
function embeddedStateProxyHandler(state,stateChangeManager){return{set(target,key,value,receiver){if(value!==Reflect.get(target,key,receiver)&&!stateChangeManager.previousEmbeddedState){stateChangeManager.previousEmbeddedState=JSON.parse(JSON.stringify(stateChangeManager.embeddedState));}
return Reflect.set(target,key,value,receiver);},deleteProperty(target,key){if(Reflect.has(target,key)&&!stateChangeManager.previousEmbeddedState){stateChangeManager.previousEmbeddedState=JSON.parse(JSON.stringify(stateChangeManager.embeddedState));}
return Reflect.deleteProperty(target,key);},get(target,key,receiver){Reflect.get(state,key,state);return Reflect.get(target,key,receiver);},ownKeys(target){Reflect.ownKeys(state);return Reflect.ownKeys(target);},has(target,key){Reflect.has(state,key);return Reflect.has(target,key);},};}
function observeAllKeys(reactive){for(const key in reactive){const prop=reactive[key];if(prop instanceof Object){observeAllKeys(prop);}}}
__exports.getEmbeddedProps=getEmbeddedProps;function getEmbeddedProps(host){return host.dataset.embeddedProps?JSON.parse(host.dataset.embeddedProps):{};}
function sortedCopy(obj){const result={};const propNames=Object.keys(obj).sort();for(const propName of propNames){result[propName]=obj[propName];}
return result;}
__exports.applyObjectPropertyDifference=applyObjectPropertyDifference;function applyObjectPropertyDifference(container,key,previous,next){if(!container[key]){container[key]={};}
const obj1={...(previous||{})};const obj2={...(next||{})};const dest=container[key];for(const key in obj2){if(JSON.stringify(obj1[key])!==JSON.stringify(obj2[key])){dest[key]=obj2[key];}
delete obj1[key];}
for(const key in obj1){delete dest[key];}
if(!Object.keys(dest).length&&!next){delete container[key];}}
__exports.replaceProperty=replaceProperty;function replaceProperty(container,key,value){if(value===undefined){delete container[key];}else{container[key]=value;}}
const StateChangeManager=__exports.StateChangeManager=class StateChangeManager{constructor(config){this.config=config;}
setup(){const defaultState=sortedCopy(this.getEmbeddedState());const defaultStateChange={stateChangeId:null,previous:defaultState,next:defaultState,};this.defaultStateChange=defaultStateChange;this.previousStateChange=defaultStateChange;this.batchId=0;this.setupUnmounted();}
setupUnmounted(){this.previousEmbeddedState=null;this.state=null;this.embeddedState=null;this.embeddedStateProxy=null;this.isLiveComponent=false;this.batchId+=1;}
constructEmbeddedState(state){this.state=state;this.embeddedState=reactive(this.assignDeepProxyCopy({},state),this.batchedChangeState());this.embeddedStateProxy=new Proxy(this.embeddedState,embeddedStateProxyHandler(state,this));observeAllKeys(this.embeddedStateProxy);this.isLiveComponent=true;return this.embeddedStateProxy;}
getState(){let state=this.state;if(!this.isLiveComponent){state=this.getEmbeddedState();}
return state;}
onStateChanged(attrState,{reverse=false,forNewStep=false}={}){const stateChange=attrState?JSON.parse(attrState):this.defaultStateChange;const state=this.getState();if(reverse){this.reverseStateChange(stateChange);}
if(!this.areStateChangesEqual(this.previousStateChange,stateChange)){const previous=JSON.stringify(sortedCopy(state));this.commitStateChange(state,stateChange.previous,stateChange.next);const sortedState=sortedCopy(state);this.config.host.dataset.embeddedProps=JSON.stringify(this.stateToEmbeddedProps(this.config.host,sortedState));if(this.isLiveComponent&&!this.previousEmbeddedState){this.assignDeepProxyCopy(toRaw(this.embeddedState),sortedState);}
if(!forNewStep){this.previousStateChange=stateChange;}else{const next=JSON.stringify(sortedState);if(previous!==next){this.previousStateChange={stateChangeId:this.generateId(),previous:JSON.parse(previous),next:JSON.parse(next),};return JSON.stringify(this.previousStateChange);}}}}
batchedChangeState(){let scheduled=false;const batchId=this.batchId;return async()=>{if(this.isLiveComponent&&!scheduled){scheduled=true;await Promise.resolve();scheduled=false;if(batchId===this.batchId){this.changeState();}}};}
changeState(){if(!this.previousEmbeddedState){return;}
const previousEmbeddedState=this.previousEmbeddedState;this.previousEmbeddedState=null;const previous=JSON.stringify(sortedCopy(this.state));this.commitStateChange(this.state,previousEmbeddedState,JSON.parse(JSON.stringify(this.embeddedState)));const sortedState=sortedCopy(this.state);const next=JSON.stringify(sortedState);this.assignDeepProxyCopy(toRaw(this.embeddedState),sortedState);if(previous!==next){this.previousStateChange={stateChangeId:this.generateId(),previous:JSON.parse(previous),next:JSON.parse(next),};this.config.host.dataset.embeddedState=JSON.stringify(this.previousStateChange);this.config.host.dataset.embeddedProps=JSON.stringify(this.stateToEmbeddedProps(this.config.host,sortedState));this.config.commitStateChanges();}
observeAllKeys(this.embeddedStateProxy);}
areStateChangesEqual(sc1,sc2){return(sc1.stateChangeId===sc2.stateChangeId&&JSON.stringify(sc1.previous)===JSON.stringify(sc2.previous)&&JSON.stringify(sc1.next)===JSON.stringify(sc2.next));}
reverseStateChange(stateChange){const previous=stateChange.previous;stateChange.previous=stateChange.next;stateChange.next=previous;}
assignDeepProxyCopy(target,source){for(const key of Object.keys(target)){delete target[key];}
for(const key of Object.keys(source)){target[key]=this.deepProxyCopy(source[key]);}
return target;}
deepProxyCopy(value){if(value instanceof Object){const copy=value instanceof Array?[]:{};for(const prop in value){copy[prop]=this.deepProxyCopy(value[prop]);}
return new Proxy(copy,embeddedStateProxyHandler(value,this));}
return value;}
generateId(){return Math.floor(Math.random()*Math.pow(2,52));}
commitStateChange(state,previous,next){const currentKeys=new Set([...Object.keys(state),...Object.keys(previous),...Object.keys(next),]);for(const key of currentKeys){if(key in(this.config.propertyUpdater||{})){this.config.propertyUpdater[key](state,previous,next);}else if(JSON.stringify(previous[key])!==JSON.stringify(next[key])){replaceProperty(state,key,next[key]);}}}
getEmbeddedState(){const host=this.config.host;return this.config.getEmbeddedState?.(host)||getEmbeddedProps(host);}
stateToEmbeddedProps(host,state){const props=this.config.stateToEmbeddedProps?.(host,state)||state;for(const key of Object.keys(props)){if(props[key]===undefined){delete props[key];}}
return props;}}
__exports.useEmbeddedState=useEmbeddedState;function useEmbeddedState(host){const component=useComponent();if(!component.env.getStateChangeManager){throw new Error("Missing `getStateChangeManager` function in the `embedding` provided to the `EmbeddedComponentPlugin`.");}
const stateChangeManager=component.env.getStateChangeManager(host);onWillDestroy(()=>stateChangeManager.setupUnmounted());const state=useState(stateChangeManager.getEmbeddedState());return stateChangeManager.constructEmbeddedState(state);}
return __exports;});;

/* /html_editor/static/src/others/embedded_components/core/embedded_component_toolbar/embedded_component_toolbar.js */
odoo.define('@html_editor/others/embedded_components/core/embedded_component_toolbar/embedded_component_toolbar',['@odoo/owl','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const{useForwardRefToParent}=require("@web/core/utils/hooks");const EmbeddedComponentToolbar=__exports.EmbeddedComponentToolbar=class EmbeddedComponentToolbar extends Component{static props={buttonsGroupClass:{type:String,optional:true},slots:Object,};static template="html_editor.EmbeddedComponentToolbar";}
const EmbeddedComponentToolbarButton=__exports.EmbeddedComponentToolbarButton=class EmbeddedComponentToolbarButton extends Component{static props={buttonRef:{type:Function,optional:true},hidden:{type:Boolean,optional:true},icon:{type:String,optional:true},label:String,name:{type:String,optional:true},onClick:Function,title:{type:String,optional:true},};static template="html_editor.EmbeddedComponentToolbarButton";setup(){useForwardRefToParent("buttonRef");}}
return __exports;});;

/* /html_editor/static/src/others/embedded_components/core/file/readonly_file.js */
odoo.define('@html_editor/others/embedded_components/core/file/readonly_file',['@web/core/l10n/translation','@web/core/network/download','@web/core/file_viewer/file_viewer_hook','@web/core/utils/hooks','@web/core/confirmation_dialog/confirmation_dialog','@html_editor/others/embedded_components/core/embedded_component_toolbar/embedded_component_toolbar','@html_editor/others/embedded_components/core/file/state_file_model','@html_editor/others/embedded_component_utils','@odoo/owl'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{downloadFile}=require("@web/core/network/download");const{useFileViewer}=require("@web/core/file_viewer/file_viewer_hook");const{useService}=require("@web/core/utils/hooks");const{AlertDialog}=require("@web/core/confirmation_dialog/confirmation_dialog");const{EmbeddedComponentToolbar,EmbeddedComponentToolbarButton,}=require("@html_editor/others/embedded_components/core/embedded_component_toolbar/embedded_component_toolbar");const{StateFileModel}=require("@html_editor/others/embedded_components/core/file/state_file_model");const{getEmbeddedProps}=require("@html_editor/others/embedded_component_utils");const{Component,useState}=require("@odoo/owl");const ReadonlyEmbeddedFileComponent=__exports.ReadonlyEmbeddedFileComponent=class ReadonlyEmbeddedFileComponent extends Component{static components={EmbeddedComponentToolbar,EmbeddedComponentToolbarButton,};static props={fileData:{type:Object},host:{type:Object},};static template="html_editor.ReadonlyEmbeddedFile";setup(){this.dialogService=useService("dialog");this.state=useState({fileData:{...this.props.fileData},});this.fileModel=new StateFileModel(this.state);this.attachmentViewer=useFileViewer();}
async download(){try{await downloadFile(this.fileModel.downloadUrl);}catch{this.dialogService.add(AlertDialog,{body:_t("Oops, the file %s could not be found. Please replace this file box by a new one to re-upload the file.",this.fileModel.name),title:_t("Missing File"),confirm:()=>{},confirmLabel:_t("Close"),});}}
onClickFileImage(){if(this.fileModel.isViewable){this.attachmentViewer.open(this.fileModel);}else{this.download();}}}
const readonlyFileEmbedding=__exports.readonlyFileEmbedding={name:"file",Component:ReadonlyEmbeddedFileComponent,getProps:(host)=>({host,...getEmbeddedProps(host)}),};return __exports;});;

/* /html_editor/static/src/others/embedded_components/core/file/state_file_model.js */
odoo.define('@html_editor/others/embedded_components/core/file/state_file_model',['@web/core/file_viewer/file_model'],function(require){'use strict';let __exports={};const{FileModel}=require("@web/core/file_viewer/file_model");const StateFileModel=__exports.StateFileModel=class StateFileModel extends FileModel{constructor(state){super();this.state=state;for(const property of["access_token","checksum","extension","filename","id","mimetype","name","type","tmpUrl","url","uploading",]){Object.defineProperty(this,property,{get(){return this.state.fileData[property];},set(value){this.state.fileData[property]=value;},configurable:true,enumerable:true,});}}
get urlRoute(){if(this.isUrl&&!this.id){return this.url;}
return super.urlRoute;}}
return __exports;});;

/* /html_editor/static/src/others/embedded_components/core/syntax_highlighting/readonly_syntax_highlighting.js */
odoo.define('@html_editor/others/embedded_components/core/syntax_highlighting/readonly_syntax_highlighting',['@odoo/owl','@web/core/assets','@web/core/browser/cookie','@html_editor/others/embedded_components/core/syntax_highlighting/syntax_highlighting_utils'],function(require){'use strict';let __exports={};const{Component,onMounted,onWillStart,xml}=require("@odoo/owl");const{loadBundle}=require("@web/core/assets");const{cookie}=require("@web/core/browser/cookie");const{DEFAULT_LANGUAGE_ID,getPreValue,highlightPre}=require("@html_editor/others/embedded_components/core/syntax_highlighting/syntax_highlighting_utils");const ReadonlySyntaxHighlightingComponent=__exports.ReadonlySyntaxHighlightingComponent=class ReadonlySyntaxHighlightingComponent extends Component{static props={value:{type:String},languageId:{type:String},host:{type:Object},};static template=xml`<span/>`;setup(){onWillStart(()=>loadBundle(`html_editor.assets_prism${cookie.get("color_scheme") === "dark" ? "_dark" : ""}`,{targetDoc:this.props.host.ownerDocument}));onMounted(()=>{const owlRoot=[...(this.props.host.children||[])].find((child)=>child.nodeName==="OWL-ROOT");highlightPre(owlRoot||this.props.host,this.props.value,this.props.languageId);});}}
const readonlySyntaxHighlightingEmbedding=__exports.readonlySyntaxHighlightingEmbedding={name:"readonlySyntaxHighlighting",Component:ReadonlySyntaxHighlightingComponent,getProps:(host)=>({host,languageId:host.dataset.languageId||DEFAULT_LANGUAGE_ID,value:getPreValue(host),}),};return __exports;});;

/* /html_editor/static/src/others/embedded_components/core/syntax_highlighting/syntax_highlighting_utils.js */
odoo.define('@html_editor/others/embedded_components/core/syntax_highlighting/syntax_highlighting_utils',['@html_editor/utils/dom','@html_editor/utils/dom_traversal'],function(require){'use strict';let __exports={};const{fillEmpty}=require("@html_editor/utils/dom");const{descendants,lastLeaf}=require("@html_editor/utils/dom_traversal");const DEFAULT_LANGUAGE_ID=__exports.DEFAULT_LANGUAGE_ID="plaintext";const newlinesToLineBreaks=__exports.newlinesToLineBreaks=(element,doc=element.ownerDocument||document)=>{for(const node of descendants(element).filter((node)=>node.nodeType===Node.TEXT_NODE)){let newline=node.textContent.indexOf("\n");while(newline!==-1){node.before(doc.createTextNode(node.textContent.slice(0,newline)));node.before(doc.createElement("BR"));node.textContent=node.textContent.slice(newline+1);newline=node.textContent.indexOf("\n");}
if(!node.textContent){node.remove();}}
const trailingBr=lastLeaf(element);if(trailingBr?.nodeName==="BR"){element.append(trailingBr);trailingBr.after(doc.createElement("BR"));}
fillEmpty(element);};const getPreValue=__exports.getPreValue=(pre)=>{const trailingBrs=pre.innerHTML.match(/(<br>)+$/)?.length||0;return pre.innerText.slice(0,pre.innerText.length-(trailingBrs>1?trailingBrs-1:trailingBrs)).replace(/[\u200B\uFEFF]/g,"");};const highlightPre=__exports.highlightPre=(pre,value,languageId)=>{const fakeElement=pre.ownerDocument.createElement("pre");if(window.Prism){fakeElement.innerHTML=Prism.highlight(value,Prism.languages[languageId],languageId);}else{fakeElement.innerHTML=value;}
newlinesToLineBreaks(fakeElement,pre.ownerDocument);[...pre.childNodes].forEach((child)=>child.remove());[...fakeElement.childNodes].forEach((child)=>pre.append(child));};return __exports;});;

/* /html_editor/static/src/others/embedded_components/core/table_of_content/table_of_content.js */
odoo.define('@html_editor/others/embedded_components/core/table_of_content/table_of_content',['@odoo/owl','@html_editor/others/embedded_components/core/table_of_content/table_of_content_manager'],function(require){'use strict';let __exports={};const{Component,onWillStart,useState}=require("@odoo/owl");const{TableOfContentManager}=require("@html_editor/others/embedded_components/core/table_of_content/table_of_content_manager");const EmbeddedTableOfContentComponent=__exports.EmbeddedTableOfContentComponent=class EmbeddedTableOfContentComponent extends Component{static template="html_editor.EmbeddedTableOfContent";static props={manager:{type:TableOfContentManager},readonly:{type:Boolean,optional:true},};setup(){this.state=useState({toc:this.props.manager.structure,folded:false});onWillStart(async()=>{await this.props.manager.batchedUpdateStructure();});}
displayTocHint(){return this.state.toc.headings.length<2&&!this.props.readonly;}
onTocLinkClick(heading){this.props.manager.scrollIntoView(heading);}}
const tableOfContentEmbedding=__exports.tableOfContentEmbedding={name:"tableOfContent",Component:EmbeddedTableOfContentComponent,};const readonlyTableOfContentEmbedding=__exports.readonlyTableOfContentEmbedding={name:"tableOfContent",Component:EmbeddedTableOfContentComponent,getProps:(host)=>({readonly:true,}),};return __exports;});;

/* /html_editor/static/src/others/embedded_components/core/table_of_content/table_of_content_manager.js */
odoo.define('@html_editor/others/embedded_components/core/table_of_content/table_of_content_manager',['@odoo/owl'],function(require){'use strict';let __exports={};const{batched,reactive}=require("@odoo/owl");const HEADINGS=__exports.HEADINGS=["H1","H2","H3","H4","H5","H6"];const TableOfContentManager=__exports.TableOfContentManager=class TableOfContentManager{constructor(containerRef){this.containerRef=containerRef;this.structure=reactive({headings:[],});this.batchedUpdateStructure=batched(this.updateStructure.bind(this));}
getContainerEl(){return this.containerRef.el;}
fetchValidHeadings(element){const inEmbeddedHeadings=new Set(element.querySelectorAll(HEADINGS.map((heading)=>`[data-embedded] ${heading}`).join(",")));return Array.from(element.querySelectorAll(HEADINGS.join(","))).filter((heading)=>heading.innerText.trim().replaceAll("\u200B","").length>0).filter((heading)=>!inEmbeddedHeadings.has(heading));}
scrollIntoView(heading){if(!heading){return;}
const{target}=heading;target.scrollIntoView({behavior:"smooth"});target.classList.add("o_embedded_toc_header_highlight");window.setTimeout(()=>{target.classList.remove("o_embedded_toc_header_highlight");},2000);}
updateStructure(){const container=this.getContainerEl();if(!container){return;}
const tagDepthStack=[];this.structure.headings=this.fetchValidHeadings(container).map((heading)=>{while(tagDepthStack.at(-1)>=heading.tagName){tagDepthStack.pop();}
const depth=tagDepthStack.length;tagDepthStack.push(heading.tagName);return{depth,name:heading.innerText,target:heading,};});}}
return __exports;});;

/* /html_editor/static/src/others/embedded_components/core/toggle_block/toggle_block.js */
odoo.define('@html_editor/others/embedded_components/core/toggle_block/toggle_block',['@html_editor/others/embedded_component_utils','@web/core/browser/browser','@odoo/owl'],function(require){'use strict';let __exports={};const{getEditableDescendants,getEmbeddedProps,useEditableDescendants,}=require("@html_editor/others/embedded_component_utils");const{browser}=require("@web/core/browser/browser");const{Component,useEffect,useExternalListener,useState}=require("@odoo/owl");const sessionStorage=browser.sessionStorage;const EmbeddedToggleBlockComponent=__exports.EmbeddedToggleBlockComponent=class EmbeddedToggleBlockComponent extends Component{static template="html_editor.EmbeddedToggleBlock";static props={host:{type:Object},toggleBlockId:{type:String},};setup(){useEditableDescendants(this.props.host);this.state=useState({showContent:sessionStorage.getItem(this.toggleStorageKey)==="true",});this.neutralRestoreSelection=()=>{};this.restoreSelection=this.neutralRestoreSelection;useExternalListener(this.props.host,"forceToggle",this.onToggle);useEffect(()=>{this.restoreSelection();this.restoreSelection=this.neutralRestoreSelection;},()=>[this.restoreSelection]);}
get toggleStorageKey(){return`html_editor.ToggleBlock${this.props.toggleBlockId}.showContent`;}
onToggle(ev){let{showContent,restoreSelection}=ev.detail??{};showContent??=!this.state.showContent;restoreSelection??=this.neutralRestoreSelection;if(this.state.showContent!==showContent){this.restoreSelection=restoreSelection;this.state.showContent=showContent;sessionStorage.setItem(this.toggleStorageKey,this.state.showContent);}else{restoreSelection();}}}
const toggleBlockEmbedding=__exports.toggleBlockEmbedding={name:"toggleBlock",Component:EmbeddedToggleBlockComponent,getProps:(host)=>({host,...getEmbeddedProps(host)}),getEditableDescendants:getEditableDescendants,};return __exports;});;

/* /html_editor/static/src/others/embedded_components/core/video/readonly_video.js */
odoo.define('@html_editor/others/embedded_components/core/video/readonly_video',['@html_editor/others/embedded_component_utils','@html_editor/utils/url','@odoo/owl'],function(require){'use strict';let __exports={};const{getEmbeddedProps}=require("@html_editor/others/embedded_component_utils");const{getVideoUrl}=require("@html_editor/utils/url");const{Component}=require("@odoo/owl");const ReadonlyEmbeddedVideoComponent=__exports.ReadonlyEmbeddedVideoComponent=class ReadonlyEmbeddedVideoComponent extends Component{static template="html_editor.EmbeddedVideo";static props={platform:{type:String},videoId:{type:String},params:{type:Object,optional:true},};get url(){return getVideoUrl(this.props.platform,this.props.videoId,this.props.params).toString();}}
const readonlyVideoEmbedding=__exports.readonlyVideoEmbedding={name:"video",Component:ReadonlyEmbeddedVideoComponent,getProps:(host)=>({...getEmbeddedProps(host)}),};return __exports;});;

/* /html_editor/static/src/utils/base_container.js */
odoo.define('@html_editor/utils/base_container',[],function(require){'use strict';let __exports={};const BASE_CONTAINER_CLASS=__exports.BASE_CONTAINER_CLASS="o-paragraph";const SUPPORTED_BASE_CONTAINER_NAMES=__exports.SUPPORTED_BASE_CONTAINER_NAMES=["P","DIV"];__exports.getBaseContainerSelector=getBaseContainerSelector;function getBaseContainerSelector(nodeName){if(!nodeName){return baseContainerGlobalSelector;}
nodeName=SUPPORTED_BASE_CONTAINER_NAMES.includes(nodeName)?nodeName:"P";let suffix="";if(nodeName!=="P"){suffix=`.${BASE_CONTAINER_CLASS}`;}
return`${nodeName}${suffix}`;}
const baseContainerGlobalSelector=__exports.baseContainerGlobalSelector=`:is(${SUPPORTED_BASE_CONTAINER_NAMES.map((name) =>
    getBaseContainerSelector(name)
).join(",")})`;__exports.createBaseContainer=createBaseContainer;function createBaseContainer(nodeName,document){if(!document&&window){document=window.document;}
nodeName=nodeName&&SUPPORTED_BASE_CONTAINER_NAMES.includes(nodeName)?nodeName:"P";const el=document.createElement(nodeName);if(nodeName!=="P"){el.className=BASE_CONTAINER_CLASS;}
return el;}
return __exports;});;

/* /html_editor/static/src/utils/blocks.js */
odoo.define('@html_editor/utils/blocks',['@html_editor/utils/dom_traversal'],function(require){'use strict';let __exports={};const{closestPath,findNode}=require("@html_editor/utils/dom_traversal");const blockTagNames=["ADDRESS","ARTICLE","ASIDE","BLOCKQUOTE","DETAILS","DIALOG","DD","DIV","DL","DT","FIELDSET","FIGCAPTION","FIGURE","FOOTER","FORM","H1","H2","H3","H4","H5","H6","HEADER","HGROUP","HR","LI","MAIN","NAV","OL","P","PRE","SECTION","TABLE","UL","SELECT","OPTION","TR","TD","TBODY","THEAD","TH",];const computedStyleDisplayCache=new WeakMap();__exports.isBlock=isBlock;function isBlock(node){if(!node||node.nodeType!==Node.ELEMENT_NODE){return false;}
const tagName=node.nodeName.toUpperCase();if(tagName==="BR"){return false;}
if(!node.isConnected){return blockTagNames.includes(tagName);}
let display=computedStyleDisplayCache.get(node);if(display===undefined){const style=node.ownerDocument.defaultView.getComputedStyle(node);display=style.display;computedStyleDisplayCache.set(node,display);}
if(display&&display!=="none"){return!display.includes("inline")&&display!=="contents";}
return blockTagNames.includes(tagName);}
__exports.closestBlock=closestBlock;function closestBlock(node){return findNode(closestPath(node),(node)=>isBlock(node));}
return __exports;});;

/* /html_editor/static/src/utils/clipboard.js */
odoo.define('@html_editor/utils/clipboard',[],function(require){'use strict';let __exports={};function prependOriginToImages(doc,origin){doc.querySelectorAll("img").forEach((img)=>{const src=img.getAttribute("src");if(src&&!/^(http|\/\/|data:)/.test(src)){img.src=origin+(src.startsWith("/")?src:"/"+src);}});}
__exports.fillHtmlTransferData=fillHtmlTransferData;function fillHtmlTransferData(ev,transferObjectProperty,clonedContents,{setEditorTransferData=true,textContent}={}){const doc=ev.target.ownerDocument;const dataHtmlElement=doc.createElement("data");dataHtmlElement.append(clonedContents);prependOriginToImages(dataHtmlElement,doc.defaultView.location.origin);const htmlContent=dataHtmlElement.innerHTML;if(textContent){ev[transferObjectProperty].setData("text/plain",textContent);}
ev[transferObjectProperty].setData("text/html",htmlContent);if(setEditorTransferData){ev[transferObjectProperty].setData("application/vnd.odoo.odoo-editor",htmlContent);}}
return __exports;});;

/* /html_editor/static/src/utils/color.js */
odoo.define('@html_editor/utils/color',['@html_editor/utils/dom_traversal','@web/core/utils/colors','@html_editor/utils/dom_info'],function(require){'use strict';let __exports={};const{closestElement}=require("@html_editor/utils/dom_traversal");const{isColorGradient}=require("@web/core/utils/colors");const{isElement}=require("@html_editor/utils/dom_info");const COLOR_PALETTE_COMPATIBILITY_COLOR_NAMES=__exports.COLOR_PALETTE_COMPATIBILITY_COLOR_NAMES=["primary","secondary","alpha","beta","gamma","delta","epsilon","success","info","warning","danger",];const DEFAULT_PALETTE=__exports.DEFAULT_PALETTE={1:"#3AADAA",2:"#7C6576",3:"#F6F6F6",4:"#FFFFFF",5:"#383E45",};const EDITOR_COLOR_CSS_VARIABLES=__exports.EDITOR_COLOR_CSS_VARIABLES=[...COLOR_PALETTE_COMPATIBILITY_COLOR_NAMES];for(let i=1;i<=5;i++){EDITOR_COLOR_CSS_VARIABLES.push(`o-color-${i}`);EDITOR_COLOR_CSS_VARIABLES.push(`o-cc${i}-bg`);EDITOR_COLOR_CSS_VARIABLES.push(`o-cc${i}-bg-gradient`);EDITOR_COLOR_CSS_VARIABLES.push(`o-cc${i}-headings`);EDITOR_COLOR_CSS_VARIABLES.push(`o-cc${i}-text`);EDITOR_COLOR_CSS_VARIABLES.push(`o-cc${i}-btn-primary`);EDITOR_COLOR_CSS_VARIABLES.push(`o-cc${i}-btn-primary-text`);EDITOR_COLOR_CSS_VARIABLES.push(`o-cc${i}-btn-secondary`);EDITOR_COLOR_CSS_VARIABLES.push(`o-cc${i}-btn-secondary-text`);EDITOR_COLOR_CSS_VARIABLES.push(`o-cc${i}-btn-primary-border`);EDITOR_COLOR_CSS_VARIABLES.push(`o-cc${i}-btn-secondary-border`);}
for(let i=100;i<=900;i+=100){EDITOR_COLOR_CSS_VARIABLES.push(`${i}`);}
EDITOR_COLOR_CSS_VARIABLES.push("black","black-15","black-25","black-50","black-75","white","white-25","white-50","white-75","white-85");__exports.isColorCombinationName=isColorCombinationName;function isColorCombinationName(name){const number=parseInt(name);return!isNaN(number)&&number%100!==0;}
const TEXT_CLASSES_REGEX=__exports.TEXT_CLASSES_REGEX=/\btext-(primary|secondary|success|danger|warning|info|light|dark|body|muted|white|black|reset|gradient|opacity-\d{1,3}|o-[^\s]+|\d+)\b/;const BG_CLASSES_REGEX=__exports.BG_CLASSES_REGEX=/\bbg-[^\s]*\b/;const COLOR_COMBINATION_CLASSES_REGEX=__exports.COLOR_COMBINATION_CLASSES_REGEX=/\bo_cc[0-9]+\b/g;__exports.hasTextColorClass=hasTextColorClass;function hasTextColorClass(element,mode){if(!element||!isElement(element)){return false;}
const classRegex=mode==="color"?TEXT_CLASSES_REGEX:BG_CLASSES_REGEX;const parent=element.parentNode;return(classRegex.test(element.className)&&(!parent||getComputedStyle(element)[mode]!==getComputedStyle(parent)[mode]));}
__exports.hasColor=hasColor;function hasColor(element,mode){const style=element.style;const parent=element.parentNode;if(element.classList.contains("btn")){return false;}
if(isColorGradient(style["background-image"])){if(element.classList.contains("text-gradient")){if(mode==="color"){return true;}}else{if(mode!=="color"){return true;}}}
return((style[mode]&&style[mode]!=="inherit"&&(!parent||style[mode]!==parent.style[mode]))||hasTextColorClass(element,mode));}
__exports.hasAnyNodesColor=hasAnyNodesColor;function hasAnyNodesColor(nodes,mode){for(const node of nodes){if(hasColor(closestElement(node),mode)){return true;}}
return false;}
__exports.getTextColorOrClass=getTextColorOrClass;function getTextColorOrClass(node){if(!node){return null;}
if(node.style.color){return{type:"style",value:node.style.color};}
const textColorClass=[...node.classList].find((cls)=>TEXT_CLASSES_REGEX.test(cls));if(textColorClass){return{type:"class",value:textColorClass};}
return null;}
return __exports;});;

/* /html_editor/static/src/utils/content_types.js */
odoo.define('@html_editor/utils/content_types',[],function(require){'use strict';let __exports={};const CTYPES=__exports.CTYPES={CONTENT:1,SPACE:2,BLOCK_OUTSIDE:4,BLOCK_INSIDE:8,BR:16,};__exports.ctypeToString=ctypeToString;function ctypeToString(ctype){return Object.keys(CTYPES).find((key)=>CTYPES[key]===ctype);}
const CTGROUPS=__exports.CTGROUPS={INLINE:CTYPES.CONTENT|CTYPES.SPACE,BLOCK:CTYPES.BLOCK_OUTSIDE|CTYPES.BLOCK_INSIDE,BR:CTYPES.BR,};return __exports;});;

/* /html_editor/static/src/utils/dom.js */
odoo.define('@html_editor/utils/dom',['@html_editor/utils/blocks','@html_editor/utils/dom_info','@html_editor/utils/selection','@html_editor/utils/dom_traversal','@html_editor/utils/position','@html_editor/utils/base_container'],function(require){'use strict';let __exports={};const{closestBlock,isBlock}=require("@html_editor/utils/blocks");const{isEmptyTextNode,isParagraphRelatedElement,isShrunkBlock,isVisible,nextLeaf,previousLeaf,}=require("@html_editor/utils/dom_info");const{callbacksForCursorUpdate}=require("@html_editor/utils/selection");const{isEmptyBlock,isPhrasingContent}=require("@html_editor/utils/dom_info");const{childNodes,descendants}=require("@html_editor/utils/dom_traversal");const{childNodeIndex,DIRECTIONS}=require("@html_editor/utils/position");const{baseContainerGlobalSelector,createBaseContainer,}=require("@html_editor/utils/base_container");__exports.makeContentsInline=makeContentsInline;function makeContentsInline(node){const document=node.ownerDocument;let currentNode=node.firstChild;while(currentNode){if(isBlock(currentNode)){if(currentNode.previousSibling&&isParagraphRelatedElement(currentNode)){currentNode.before(document.createElement("br"));}
currentNode=unwrapContents(currentNode)[0];}else{currentNode=currentNode.nextSibling;}}}
__exports.wrapInlinesInBlocks=wrapInlinesInBlocks;function wrapInlinesInBlocks(element,{baseContainerNodeName="P",cursors={update:()=>{}}}={}){const wrapInBlock=(node,cursors)=>{const block=isPhrasingContent(node)?createBaseContainer(baseContainerNodeName,node.ownerDocument):node.ownerDocument.createElement("DIV");cursors.update(callbacksForCursorUpdate.append(block,node));cursors.update(callbacksForCursorUpdate.before(node,block));if(node.nextSibling){const sibling=node.nextSibling;node.remove();sibling.before(block);}else{const parent=node.parentElement;node.remove();parent.append(block);}
block.append(node);return block;};const appendToCurrentBlock=(currentBlock,node,cursors)=>{if(currentBlock.matches(baseContainerGlobalSelector)&&!isPhrasingContent(node)){const block=currentBlock.ownerDocument.createElement("DIV");cursors.update(callbacksForCursorUpdate.before(currentBlock,block));currentBlock.before(block);for(const child of childNodes(currentBlock)){cursors.update(callbacksForCursorUpdate.append(block,child));block.append(child);}
cursors.update(callbacksForCursorUpdate.remove(currentBlock));currentBlock.remove();currentBlock=block;}
cursors.update(callbacksForCursorUpdate.append(currentBlock,node));currentBlock.append(node);return currentBlock;};const removeNode=(node,cursors)=>{cursors.update(callbacksForCursorUpdate.remove(node));node.remove();};const children=childNodes(element);const visibleNodes=new Set(children.filter(isVisible));let currentBlock;let shouldBreakLine=true;for(const node of children){if(isBlock(node)){shouldBreakLine=true;}else if(!visibleNodes.has(node)){removeNode(node,cursors);}else if(node.nodeName==="BR"){if(shouldBreakLine){wrapInBlock(node,cursors);}else{removeNode(node,cursors);shouldBreakLine=true;}}else if(shouldBreakLine){currentBlock=wrapInBlock(node,cursors);shouldBreakLine=false;}else{currentBlock=appendToCurrentBlock(currentBlock,node,cursors);}}}
__exports.unwrapContents=unwrapContents;function unwrapContents(node){const contents=childNodes(node);for(const child of contents){node.parentNode.insertBefore(child,node);}
node.parentNode.removeChild(node);return contents;}
__exports.removeClass=removeClass;function removeClass(element,...classNames){const classNamesSet=new Set(classNames);if([...element.classList].every((className)=>classNamesSet.has(className))){element.removeAttribute("class");}else{element.classList.remove(...classNames);}}
__exports.removeStyle=removeStyle;function removeStyle(element,...styleProperties){const propsToRemoveSet=new Set(styleProperties);if([...element.style].every((prop)=>propsToRemoveSet.has(prop))){element.removeAttribute("style");}else{styleProperties.forEach((prop)=>element.style.removeProperty(prop));}}
__exports.fillEmpty=fillEmpty;function fillEmpty(el){const document=el.ownerDocument;if(!isBlock(el)&&!isVisible(el)&&!el.hasAttribute("data-oe-zws-empty-inline")){const zws=document.createTextNode("\u200B");el.appendChild(zws);el.setAttribute("data-oe-zws-empty-inline","");const previousSibling=el.previousSibling;if(previousSibling&&previousSibling.nodeName==="BR"){previousSibling.remove();}
return{zws};}else{return fillShrunkPhrasingParent(el);}}
__exports.fillShrunkPhrasingParent=fillShrunkPhrasingParent;function fillShrunkPhrasingParent(el){const document=el.ownerDocument;const fillers={};const blockEl=closestBlock(el);if(isShrunkBlock(blockEl)){const br=document.createElement("br");blockEl.appendChild(br);fillers.br=br;}
return fillers;}
__exports.cleanTrailingBR=cleanTrailingBR;function cleanTrailingBR(el,predicates=[]){const candidate=el?.lastChild;if(candidate?.nodeName==="BR"&&candidate.previousSibling?.nodeName!=="BR"&&!isEmptyBlock(el)&&!predicates.some((predicate)=>predicate(candidate))){candidate.remove();return candidate;}}
__exports.toggleClass=toggleClass;function toggleClass(element,className,force){element.classList.toggle(className,force);if(!element.className){element.removeAttribute("class");}}
__exports.cleanTextNode=cleanTextNode;function cleanTextNode(node,char,cursors){const removedIndexes=[];node.textContent=node.textContent.replaceAll(char,(_,offset)=>{removedIndexes.push(offset);return"";});if(isEmptyTextNode(node)){cursors?.update(callbacksForCursorUpdate.remove(node));node.remove();}else{cursors?.update((cursor)=>{if(cursor.node===node){cursor.offset-=removedIndexes.filter((index)=>cursor.offset>index).length;}});}}
__exports.splitTextNode=splitTextNode;function splitTextNode(textNode,offset,originalNodeSide=DIRECTIONS.RIGHT){const document=textNode.ownerDocument;let parentOffset=childNodeIndex(textNode);if(offset>0){parentOffset++;if(offset<textNode.length){const left=textNode.nodeValue.substring(0,offset);const right=textNode.nodeValue.substring(offset);if(originalNodeSide===DIRECTIONS.LEFT){const newTextNode=document.createTextNode(right);textNode.after(newTextNode);textNode.nodeValue=left;}else{const newTextNode=document.createTextNode(left);textNode.before(newTextNode);textNode.nodeValue=right;}}}
return parentOffset;}
__exports.removeInvisibleWhitespace=removeInvisibleWhitespace;function removeInvisibleWhitespace(el,cursors){const[countLeadingWhitespace,countTrailingWhitespace]=[/^\s+/,/\s+$/].map((regex)=>(node)=>node?.textContent.match(regex)?.[0]?.length||0);const isInlineElement=(node)=>node?.nodeType===Node.ELEMENT_NODE&&!isBlock(node);const textChildren=descendants(el).filter((child)=>child.nodeType===Node.TEXT_NODE);let removedTrailingSpaceBefore=false;let index=0;for(const child of textChildren){let leadingWhitespace=countLeadingWhitespace(child);let trailingWhitespace=countTrailingWhitespace(child);const previous=previousLeaf(child,el);if(leadingWhitespace&&previous&&(isInlineElement(child.previousSibling)||removedTrailingSpaceBefore)){leadingWhitespace-=1;}else if(trailingWhitespace&&index!==textChildren.length-1&&isInlineElement(child.nextSibling)&&!countTrailingWhitespace(nextLeaf(child,el))){trailingWhitespace-=1;}
removedTrailingSpaceBefore=!!trailingWhitespace;cursors?.shiftOffset(child,-leadingWhitespace);child.textContent=child.textContent.substring(leadingWhitespace,child.textContent.length-trailingWhitespace||leadingWhitespace).replace(/^\s+/," ").replace(/\s+$/," ");if(!child.textContent){child.remove();}
index+=1;}}
return __exports;});;

/* /html_editor/static/src/utils/dom_info.js */
odoo.define('@html_editor/utils/dom_info',['@html_editor/utils/base_container','@html_editor/utils/blocks','@html_editor/utils/dom_traversal','@html_editor/utils/position'],function(require){'use strict';let __exports={};const{baseContainerGlobalSelector}=require("@html_editor/utils/base_container");const{closestBlock,isBlock}=require("@html_editor/utils/blocks");const{childNodes,closestElement,firstLeaf,lastLeaf}=require("@html_editor/utils/dom_traversal");const{DIRECTIONS,nodeSize}=require("@html_editor/utils/position");__exports.isEmpty=isEmpty;function isEmpty(el){if(isProtecting(el)||isProtected(el)){return false;}
const content=el.innerHTML.trim();if(content===""||content==="<br>"){return true;}
return false;}
__exports.isEmptyTextNode=isEmptyTextNode;function isEmptyTextNode(node){if(node.nodeType!==Node.TEXT_NODE){return false;}
if(!node.textContent){return true;}
const trimmedContent=node.textContent.trim();if(!trimmedContent){if(node.textContent.includes("\n")){return true;}
if(node.textContent){return false;}}
return!trimmedContent;}
__exports.isBold=isBold;function isBold(node){const fontWeight=+getComputedStyle(closestElement(node)).fontWeight;const referenceElement=closestElement(node,(el)=>isBlock(el)||+getComputedStyle(el).fontWeight!==fontWeight);return fontWeight>500||fontWeight>+getComputedStyle(referenceElement).fontWeight;}
__exports.isItalic=isItalic;function isItalic(node){return getComputedStyle(closestElement(node)).fontStyle==="italic";}
__exports.isUnderline=isUnderline;function isUnderline(node){let parent=closestElement(node);while(parent){if(getComputedStyle(parent).textDecorationLine.includes("underline")){return true;}
parent=parent.parentElement;}
return false;}
__exports.isStrikeThrough=isStrikeThrough;function isStrikeThrough(node){let parent=closestElement(node);while(parent){if(!parent.classList.contains("o_checked")&&getComputedStyle(parent).textDecorationLine.includes("line-through")){return true;}
parent=parent.parentElement;}
return false;}
__exports.isFontSize=isFontSize;function isFontSize(node,props){const element=closestElement(node);return getComputedStyle(element)["font-size"]===props.size;}
__exports.hasClass=hasClass;function hasClass(node,props){const element=closestElement(node);return element.classList.contains(props.className);}
__exports.isDirectionSwitched=isDirectionSwitched;function isDirectionSwitched(node,editable){const defaultDirection=editable.getAttribute("dir")||"ltr";return getComputedStyle(closestElement(node)).direction!==defaultDirection;}
__exports.isRow=isRow;function isRow(node){return["TH","TD"].includes(node.tagName);}
__exports.isZWS=isZWS;function isZWS(node){return node&&node.textContent==="\u200B";}
__exports.isInPre=isInPre;function isInPre(node){const element=node.nodeType===Node.TEXT_NODE?node.parentElement:node;return(!!element&&(!!element.closest("pre")||getComputedStyle(element).getPropertyValue("white-space")==="pre"));}
const ZERO_WIDTH_CHARS=__exports.ZERO_WIDTH_CHARS=["\u200b","\ufeff"];const whitespace=__exports.whitespace=`[^\\S\\u00A0\\u0009\\ufeff]`;const whitespaceRegex=new RegExp(`^${whitespace}*$`);__exports.isWhitespace=isWhitespace;function isWhitespace(value){const str=typeof value==="string"?value:value.nodeValue;return whitespaceRegex.test(str);}
const visibleCharRegex=/[^\s\u200b]|[\u00A0\u0009]$/;__exports.isVisibleTextNode=isVisibleTextNode;function isVisibleTextNode(testedNode){if(!testedNode||!testedNode.length||testedNode.nodeType!==Node.TEXT_NODE){return false;}
if(isProtected(testedNode)){return true;}
if(visibleCharRegex.test(testedNode.textContent)||(isInPre(testedNode)&&isWhitespace(testedNode))){return true;}
if(ZERO_WIDTH_CHARS.includes(testedNode.textContent)){return false;}
let preceding;let following;let foundTestedNode;const currentNodeParentBlock=closestBlock(testedNode);if(!currentNodeParentBlock){return false;}
const nodeIterator=document.createNodeIterator(currentNodeParentBlock);for(let node=nodeIterator.nextNode();node;node=nodeIterator.nextNode()){if(node.nodeType===Node.TEXT_NODE){if(foundTestedNode){following=node;break;}else if(testedNode===node){foundTestedNode=true;}else{preceding=node;}}else if(isBlock(node)){if(foundTestedNode){break;}else{preceding=null;}}else if(foundTestedNode&&!isWhitespace(node)){following=node;break;}}
while(following&&!visibleCharRegex.test(following.textContent)){following=following.nextSibling;}
if(!(preceding&&following)||currentNodeParentBlock!==closestBlock(preceding)||currentNodeParentBlock!==closestBlock(following)){return false;}
return visibleCharRegex.test(preceding.textContent);}
const selfClosingElementTags=["BR","IMG","INPUT","T","HR"];__exports.isSelfClosingElement=isSelfClosingElement;function isSelfClosingElement(node){return node&&selfClosingElementTags.includes(node.nodeName);}
__exports.isVisible=isVisible;function isVisible(node){return(!!node&&((node.nodeType===Node.TEXT_NODE&&isVisibleTextNode(node))||isSelfClosingElement(node)||isMediaElement(node)||hasVisibleContent(node)||isProtecting(node)||isEmbeddedComponent(node)));}
__exports.hasVisibleContent=hasVisibleContent;function hasVisibleContent(node){return(node?childNodes(node):[]).some((n)=>isVisible(n));}
__exports.isButton=isButton;function isButton(node){if(!node||node.nodeType!==Node.ELEMENT_NODE){return false;}
return node.nodeName==="BUTTON"||node.classList.contains("btn");}
__exports.isZwnbsp=isZwnbsp;function isZwnbsp(node){return node?.nodeType===Node.TEXT_NODE&&node.textContent==="\ufeff";}
__exports.isTangible=isTangible;function isTangible(node){return isVisible(node)||isZwnbsp(node)||hasTangibleContent(node);}
__exports.hasTangibleContent=hasTangibleContent;function hasTangibleContent(node){return(node?childNodes(node):[]).some((n)=>isTangible(n));}
const isNotEditableNode=__exports.isNotEditableNode=(node)=>node.getAttribute&&node.getAttribute("contenteditable")&&node.getAttribute("contenteditable").toLowerCase()==="false";const iconTags=["I","SPAN"];const iconClasses=__exports.iconClasses=["fa","fab","fad","far","oi"];const ICON_SELECTOR=__exports.ICON_SELECTOR=iconTags.map((tag)=>iconClasses.map((cls)=>`${tag}.${cls}`).join(", ")).join(", ");const MEDIA_SELECTOR=__exports.MEDIA_SELECTOR=`${ICON_SELECTOR} , .o_image, .media_iframe_video`;const EDITABLE_MEDIA_CLASS=__exports.EDITABLE_MEDIA_CLASS="o_editable_media";__exports.isIconElement=isIconElement;function isIconElement(node){return!!(node&&iconTags.includes(node.nodeName)&&iconClasses.some((cls)=>node.classList.contains(cls)));}
__exports.isMediaElement=isMediaElement;function isMediaElement(node){return(isIconElement(node)||(node.classList&&(node.classList.contains("o_image")||node.classList.contains("media_iframe_video")))||node.nodeName==="CANVAS");}
const phrasingTagNames=new Set(["ABBR","AUDIO","B","BDI","BDO","BR","BUTTON","CANVAS","CITE","CODE","DATA","DATALIST","DFN","EM","EMBED","I","IFRAME","IMG","INPUT","KBD","LABEL","MARK","MATH","METER","NOSCRIPT","OBJECT","OUTPUT","PICTURE","PROGRESS","Q","RUBY","S","SAMP","SCRIPT","SELECT","SLOT","SMALL","SPAN","STRONG","SUB","SUP","SVG","TEMPLATE","TEXTAREA","TIME","U","VAR","VIDEO","WBR","FONT","A","AREA","DEL","INS","LINK","MAP","META",]);__exports.isPhrasingContent=isPhrasingContent;function isPhrasingContent(node){if(node&&(node.nodeType===Node.TEXT_NODE||(node.nodeType===Node.ELEMENT_NODE&&phrasingTagNames.has(node.tagName)))){return true;}
return false;}
__exports.containsAnyInline=containsAnyInline;function containsAnyInline(element){if(!element){return false;}
let child=element.firstChild;while(child){if((!isBlock(child)&&child.nodeType===Node.ELEMENT_NODE)||(child.nodeType===Node.TEXT_NODE&&child.textContent.trim()!=="")){return true;}
child=child.nextSibling;}
return false;}
__exports.containsAnyNonPhrasingContent=containsAnyNonPhrasingContent;function containsAnyNonPhrasingContent(element){if(!element){return false;}
let child=element.firstChild;while(child){if(!isPhrasingContent(child)){return true;}
child=child.nextSibling;}
return false;}
__exports.isEmbeddedComponent=isEmbeddedComponent;function isEmbeddedComponent(node){return node.nodeType===Node.ELEMENT_NODE&&node.matches("[data-embedded]");}
__exports.isProtected=isProtected;function isProtected(node){if(!node){return false;}
const candidate=node.parentElement?closestElement(node.parentElement,"[data-oe-protected]"):null;if(!candidate||candidate.dataset.oeProtected==="false"){return false;}
return true;}
__exports.isProtecting=isProtecting;function isProtecting(node){if(!node){return false;}
return(node.nodeType===Node.ELEMENT_NODE&&node.dataset.oeProtected!=="false"&&node.dataset.oeProtected!==undefined);}
__exports.isUnprotecting=isUnprotecting;function isUnprotecting(node){if(!node){return false;}
return node.nodeType===Node.ELEMENT_NODE&&node.dataset.oeProtected==="false";}
const paragraphRelatedElements=__exports.paragraphRelatedElements=["P","H1","H2","H3","H4","H5","H6","PRE"];__exports.allowsParagraphRelatedElements=allowsParagraphRelatedElements;function allowsParagraphRelatedElements(node){return isBlock(node)&&!isParagraphRelatedElement(node);}
const phrasingContent=__exports.phrasingContent=new Set(["#text",...phrasingTagNames]);const flowContent=new Set([...phrasingContent,...paragraphRelatedElements,"DIV","HR"]);const listItem=__exports.listItem=new Set(["LI"]);const listContainers=new Set(["UL","OL"]);const allowedContent={BLOCKQUOTE:flowContent,DIV:flowContent,H1:phrasingContent,H2:phrasingContent,H3:phrasingContent,H4:phrasingContent,H5:phrasingContent,H6:phrasingContent,HR:new Set(),LI:flowContent,OL:listItem,UL:listItem,P:phrasingContent,PRE:phrasingContent,TD:flowContent,TR:new Set(["TD"]),};__exports.isParagraphRelatedElement=isParagraphRelatedElement;function isParagraphRelatedElement(node){if(!node){return false;}
return(paragraphRelatedElements.includes(node.nodeName)||(node.nodeType===Node.ELEMENT_NODE&&node.matches(baseContainerGlobalSelector)));}
const paragraphRelatedElementsSelector=__exports.paragraphRelatedElementsSelector=[...paragraphRelatedElements,baseContainerGlobalSelector,].join(",");__exports.isListItemElement=isListItemElement;function isListItemElement(node){return[...listItem].includes(node.nodeName);}
const listItemElementSelector=__exports.listItemElementSelector=[...listItem].join(",");__exports.isListElement=isListElement;function isListElement(node){return[...listContainers].includes(node.nodeName);}
const listElementSelector=__exports.listElementSelector=[...listContainers].join(",");__exports.isTableCell=isTableCell;function isTableCell(node){return["TH","TD"].includes(node.nodeName);}
__exports.isAllowedContent=isAllowedContent;function isAllowedContent(parentBlock,nodes){let allowedContentSet=allowedContent[parentBlock.nodeName];if(!allowedContentSet){return true;}
if(parentBlock.matches(baseContainerGlobalSelector)){allowedContentSet=phrasingContent;}
return nodes.every((node)=>allowedContentSet.has(node.nodeName));}
__exports.isEmptyBlock=isEmptyBlock;function isEmptyBlock(blockEl){if(!blockEl||blockEl.nodeType!==Node.ELEMENT_NODE){return false;}
if(visibleCharRegex.test(blockEl.textContent)){return false;}
if(blockEl.querySelectorAll("br").length>=2){return false;}
if(isProtecting(blockEl)||isProtected(blockEl)){return false;}
const nodes=blockEl.querySelectorAll("*");for(const node of nodes){if(node.nodeName!="BR"&&(isSelfClosingElement(node)||isMediaElement(node)||isProtecting(node)||isButton(node))){return false;}}
return isBlock(blockEl);}
__exports.isShrunkBlock=isShrunkBlock;function isShrunkBlock(blockEl){return isEmptyBlock(blockEl)&&!blockEl.querySelector("br")&&!isSelfClosingElement(blockEl);}
__exports.isEditorTab=isEditorTab;function isEditorTab(node){return node&&node.nodeName==="SPAN"&&node.classList.contains("oe-tabs");}
__exports.getDeepestPosition=getDeepestPosition;function getDeepestPosition(node,offset){let direction=DIRECTIONS.RIGHT;let next=node;while(next){if(isTangible(next)||(isZWS(next)&&isContentEditable(next))){if(next!==node){[node,offset]=[next,direction?0:nodeSize(next)];}
const childrenNodes=childNodes(node);direction=offset<childrenNodes.length;next=childrenNodes[direction?offset:offset-1];}else if(direction&&next.nextSibling&&closestBlock(node).contains(next.nextSibling)){next=next.nextSibling;}else{direction=DIRECTIONS.LEFT;next=closestBlock(node).contains(next.previousSibling)&&next.previousSibling;}
next=!isSelfClosingElement(next)&&next;}
return[node,offset];}
__exports.previousLeaf=previousLeaf;function previousLeaf(node,editable,skipInvisible=false){let ancestor=node;while(ancestor&&!ancestor.previousSibling&&ancestor!==editable){ancestor=ancestor.parentElement;}
if(ancestor&&ancestor!==editable){if(skipInvisible&&!isVisible(ancestor.previousSibling)){return previousLeaf(ancestor.previousSibling,editable,skipInvisible);}else{const last=lastLeaf(ancestor.previousSibling);if(skipInvisible&&!isVisible(last)){return previousLeaf(last,editable,skipInvisible);}else{return last;}}}}
__exports.nextLeaf=nextLeaf;function nextLeaf(node,editable,skipInvisible=false){let ancestor=node;while(ancestor&&!ancestor.nextSibling&&ancestor!==editable){ancestor=ancestor.parentElement;}
if(ancestor&&ancestor!==editable){if(skipInvisible&&ancestor.nextSibling&&!isVisible(ancestor.nextSibling)){return nextLeaf(ancestor.nextSibling,editable,skipInvisible);}else{const first=firstLeaf(ancestor.nextSibling);if(skipInvisible&&!isVisible(first)){return nextLeaf(first,editable,skipInvisible);}else{return first;}}}}
function hasPseudoElementContent(node,pseudoSelector){const content=getComputedStyle(node,pseudoSelector).getPropertyValue("content");return content&&content!=="none";}
const NOT_A_NUMBER=/[^\d]/g;__exports.areSimilarElements=areSimilarElements;function areSimilarElements(node,node2){if(![node,node2].every((n)=>n?.nodeType===Node.ELEMENT_NODE)){return false;}
if(node.nodeName!==node2.nodeName){return false;}
for(const name of new Set([...node.getAttributeNames(),...node2.getAttributeNames()])){if(name==="style"){if(!hasSameStyleAttributes(node,node2)){return false;}}else if(name==="class"){if(!hasSameClasses(node,node2)){return false;}}else if(node.getAttribute(name)!==node2.getAttribute(name)){return false;}}
if([node,node2].some((n)=>hasPseudoElementContent(n,":before")||hasPseudoElementContent(n,":after"))){return false;}
if(isBlock(node)){return false;}
const nodeStyle=getComputedStyle(node);const node2Style=getComputedStyle(node2);if(node.matches("code.o_inline_code")){if(nodeStyle.padding===node2Style.padding&&nodeStyle.margin===node2Style.margin){return true;}}
return(!+nodeStyle.padding.replace(NOT_A_NUMBER,"")&&!+node2Style.padding.replace(NOT_A_NUMBER,"")&&!+nodeStyle.margin.replace(NOT_A_NUMBER,"")&&!+node2Style.margin.replace(NOT_A_NUMBER,""));}
__exports.hasSameStyleAttributes=hasSameStyleAttributes;function hasSameStyleAttributes(node,node2){const getNodeStyles=(node)=>(node.getAttribute("style")||"").split(";").map((style)=>style.trim()).filter(Boolean);const[nodeStyles,node2Styles]=[node,node2].map(getNodeStyles);return(nodeStyles.length===node2Styles.length&&nodeStyles.every((style)=>node2Styles.includes(style)));}
__exports.hasSameClasses=hasSameClasses;function hasSameClasses(node,node2){const getNodeClasses=(node)=>(node.getAttribute("class")||"").split(/\s+/).map((c)=>c.trim()).filter(Boolean);const[nodeClasses,node2Classes]=[node,node2].map(getNodeClasses);return(nodeClasses.length===node2Classes.length&&nodeClasses.every((cls)=>node2Classes.includes(cls)));}
__exports.isTextNode=isTextNode;function isTextNode(node){return node.nodeType===Node.TEXT_NODE;}
__exports.isElement=isElement;function isElement(node){return node.nodeType===Node.ELEMENT_NODE;}
__exports.isContentEditable=isContentEditable;function isContentEditable(node){const element=isTextNode(node)?node.parentElement:node;return element&&element.isContentEditable;}
__exports.isContentEditableAncestor=isContentEditableAncestor;function isContentEditableAncestor(node){if(node.nodeType!==Node.ELEMENT_NODE){return false;}
return node.isContentEditable&&node.matches("[contenteditable]");}
function hasClassesSubset(node,node2){const getNodeClasses=(n)=>(n||"").trim().split(/\s+/).filter(Boolean);const[nodeClasses,node2Classes]=[node,node2].map(getNodeClasses);return nodeClasses.every((cls)=>node2Classes.includes(cls));}
function hasStylesSubset(node,node2){const getNodeStyles=(n)=>(n||"").split(";").map((s)=>s.trim()).filter(Boolean);const[nodeStyles,node2Styles]=[node,node2].map(getNodeStyles);return nodeStyles.every((style)=>node2Styles.includes(style));}
__exports.isRedundantElement=isRedundantElement;function isRedundantElement(node){if(!node||node.nodeType!==Node.ELEMENT_NODE||!node.parentElement){return false;}
const closestEl=closestElement(node.parentElement,node.tagName);if(!closestEl){return false;}
for(const{name:attrName,value:nodeAttrVal}of node.attributes){const closestElAttrVal=closestEl.getAttribute(attrName);if(!closestElAttrVal){return false;}
if(attrName==="class"){if(!hasClassesSubset(nodeAttrVal,closestElAttrVal)){return false;}}else if(attrName==="style"){if(!hasStylesSubset(nodeAttrVal,closestElAttrVal)){return false;}}else{if(nodeAttrVal!==closestElAttrVal){return false;}}}
return true;}
return __exports;});;

/* /html_editor/static/src/utils/dom_state.js */
odoo.define('@html_editor/utils/dom_state',['@html_editor/utils/blocks','@html_editor/utils/content_types','@html_editor/utils/dom_info','@html_editor/utils/dom_traversal','@html_editor/utils/position'],function(require){'use strict';let __exports={};const{isBlock}=require("@html_editor/utils/blocks");const{CTGROUPS,CTYPES,ctypeToString}=require("@html_editor/utils/content_types");const{isInPre,isVisible,isWhitespace,whitespace}=require("@html_editor/utils/dom_info");const{PATH_END_REASONS,ancestors,closestElement,closestPath,createDOMPathGenerator,}=require("@html_editor/utils/dom_traversal");const{DIRECTIONS,leftPos,rightPos}=require("@html_editor/utils/position");const prepareUpdateLockedEditables=new Set();__exports.prepareUpdate=prepareUpdate;function prepareUpdate(...args){const closestRoot=args.length&&ancestors(args[0]).find((ancestor)=>ancestor.classList.contains("odoo-editor-editable"));const isPrepareUpdateLocked=closestRoot&&prepareUpdateLockedEditables.has(closestRoot);const hash=(Math.random()+1).toString(36).substring(7);const options={allowReenter:true,label:hash,debug:false,...(args.length&&args[args.length-1]instanceof Object?args.pop():{}),};if(options.debug){console.log("%cPreparing%c update: "+
options.label+
(options.label===hash?"":` (${hash})`)+"%c"+
(isPrepareUpdateLocked?" LOCKED":""),"color: cyan;","color: white;","color: red; font-weight: bold;");}
if(isPrepareUpdateLocked){return()=>{if(options.debug){console.log("%cRestoring%c update: "+
options.label+
(options.label===hash?"":` (${hash})`)+"%c LOCKED","color: lightgreen;","color: white;","color: red; font-weight: bold;");}};}
if(!options.allowReenter&&closestRoot){prepareUpdateLockedEditables.add(closestRoot);}
const positions=[...args];const restoreData=[];let el,offset;while(positions.length){offset=positions.pop();el=positions.pop();const left=getState(el,offset,DIRECTIONS.LEFT);const right=getState(el,offset,DIRECTIONS.RIGHT,left.cType);if(options.debug){const editable=el&&closestElement(el,".odoo-editor-editable");const oldEditableHTML=(editable&&editable.innerHTML.replaceAll(" ","_").replaceAll("\u200B","ZWS"))||"";left.oldEditableHTML=oldEditableHTML;right.oldEditableHTML=oldEditableHTML;}
restoreData.push(left,right);}
return function restoreStates(){if(options.debug){console.log("%cRestoring%c update: "+
options.label+
(options.label===hash?"":` (${hash})`),"color: lightgreen;","color: white;");}
for(const data of restoreData){restoreState(data,options.debug);}
if(!options.allowReenter&&closestRoot){prepareUpdateLockedEditables.delete(closestRoot);}};}
const leftLeafOnlyNotBlockPath=__exports.leftLeafOnlyNotBlockPath=createDOMPathGenerator(DIRECTIONS.LEFT,{leafOnly:true,stopTraverseFunction:isBlock,stopFunction:isBlock,});const rightLeafOnlyNotBlockPath=createDOMPathGenerator(DIRECTIONS.RIGHT,{leafOnly:true,stopTraverseFunction:isBlock,stopFunction:isBlock,});__exports.getState=getState;function getState(el,offset,direction,leftCType){const leftDOMPath=leftLeafOnlyNotBlockPath;const rightDOMPath=rightLeafOnlyNotBlockPath;let domPath;let inverseDOMPath;const whitespaceAtStartRegex=new RegExp("^"+whitespace+"+");const whitespaceAtEndRegex=new RegExp(whitespace+"+$");const reasons=[];if(direction===DIRECTIONS.LEFT){domPath=leftDOMPath(el,offset,reasons);inverseDOMPath=rightDOMPath(el,offset);}else{domPath=rightDOMPath(el,offset,reasons);inverseDOMPath=leftDOMPath(el,offset);}
const boundaryNode=inverseDOMPath.next().value;let cType=undefined;let lastSpace=null;for(const node of domPath){if(node.nodeType===Node.TEXT_NODE){const value=node.nodeValue;if(direction===DIRECTIONS.LEFT){if(!isWhitespace(value)){if(lastSpace){cType=CTYPES.SPACE;}else{const rightLeaf=rightLeafOnlyNotBlockPath(node).next().value;const hasContentRight=rightLeaf&&!whitespaceAtStartRegex.test(rightLeaf.textContent);cType=!hasContentRight&&whitespaceAtEndRegex.test(node.textContent)?CTYPES.SPACE:CTYPES.CONTENT;}
break;}
if(value.length){lastSpace=node;}}else{leftCType=leftCType||getState(el,offset,DIRECTIONS.LEFT).cType;if(whitespaceAtStartRegex.test(value)){const leftLeaf=leftLeafOnlyNotBlockPath(node).next().value;const hasContentLeft=leftLeaf&&!whitespaceAtEndRegex.test(leftLeaf.textContent);const rct=!isWhitespace(value)?CTYPES.CONTENT:getState(...rightPos(node),DIRECTIONS.RIGHT).cType;cType=leftCType&CTYPES.CONTENT&&rct&(CTYPES.CONTENT|CTYPES.BR)&&!hasContentLeft?CTYPES.SPACE:rct;break;}
if(!isWhitespace(value)){cType=CTYPES.CONTENT;break;}}}else if(node.nodeName==="BR"){cType=CTYPES.BR;break;}else if(isVisible(node)){cType=CTYPES.CONTENT;break;}}
if(cType===undefined){cType=reasons.includes(PATH_END_REASONS.BLOCK_HIT)?CTYPES.BLOCK_OUTSIDE:CTYPES.BLOCK_INSIDE;}
return{node:boundaryNode,direction:direction,cType:cType,};}
const priorityRestoreStateRules=[[{cType1:CTYPES.CONTENT,cType2:CTYPES.SPACE|CTGROUPS.BLOCK},{spaceVisibility:true},],[{direction:DIRECTIONS.LEFT,cType1:CTGROUPS.INLINE,cType2:CTGROUPS.BR},{spaceVisibility:true},],[{direction:DIRECTIONS.RIGHT,cType1:CTGROUPS.CONTENT,cType2:CTGROUPS.BR},{spaceVisibility:true},],[{direction:DIRECTIONS.RIGHT,cType1:CTGROUPS.BR,cType2:CTYPES.SPACE},{spaceVisibility:true},],[{direction:DIRECTIONS.RIGHT,cType1:CTGROUPS.BR,cType2:CTGROUPS.BLOCK},{spaceVisibility:true,brVisibility:true},],[{cType1:CTYPES.SPACE},{spaceVisibility:false},],[{direction:DIRECTIONS.LEFT,cType1:CTGROUPS.BR},{spaceVisibility:false},],[{cType1:CTGROUPS.BLOCK,cType2:CTGROUPS.INLINE|CTGROUPS.BR},{spaceVisibility:false},],[{direction:DIRECTIONS.RIGHT,cType1:CTGROUPS.INLINE,cType2:CTGROUPS.BLOCK},{brVisibility:true},],[{direction:DIRECTIONS.RIGHT,cType1:CTGROUPS.BLOCK,cType2:CTGROUPS.INLINE|CTGROUPS.BR,},{brVisibility:false},],[{direction:DIRECTIONS.LEFT,cType1:CTGROUPS.BR|CTGROUPS.BLOCK,cType2:CTGROUPS.INLINE,},{brVisibility:false,extraBRRemovalCondition:(brNode)=>isFakeLineBreak(brNode)},],];function restoreStateRuleHashCode(direction,cType1,cType2){return`${direction}-${cType1}-${cType2}`;}
const allRestoreStateRules=(function(){const map=new Map();const keys=["direction","cType1","cType2"];for(const direction of Object.values(DIRECTIONS)){for(const cType1 of Object.values(CTYPES)){for(const cType2 of Object.values(CTYPES)){const rule={direction:direction,cType1:cType1,cType2:cType2};const matchedRules=[];for(const entry of priorityRestoreStateRules){let priority=0;for(const key of keys){const entryKeyValue=entry[0][key];if(entryKeyValue!==undefined){if(typeof entryKeyValue==="boolean"?rule[key]===entryKeyValue:rule[key]&entryKeyValue){priority++;}else{priority=-1;break;}}}
if(priority>=0){matchedRules.push([priority,entry[1]]);}}
const finalRule={};for(let p=0;p<=keys.length;p++){for(const entry of matchedRules){if(entry[0]===p){Object.assign(finalRule,entry[1]);}}}
const hashCode=restoreStateRuleHashCode(direction,cType1,cType2);map.set(hashCode,finalRule);}}}
return map;})();__exports.restoreState=restoreState;function restoreState(prevStateData,debug=false){const{node,direction,cType:cType1,oldEditableHTML}=prevStateData;if(!node||!node.parentNode){return;}
const[el,offset]=direction===DIRECTIONS.LEFT?leftPos(node):rightPos(node);const{cType:cType2}=getState(el,offset,direction);const ruleHashCode=restoreStateRuleHashCode(direction,cType1,cType2);const rule=allRestoreStateRules.get(ruleHashCode);if(debug){const editable=closestElement(node,".odoo-editor-editable");console.log("%c"+
node.textContent.replaceAll(" ","_").replaceAll("\u200B","ZWS")+"\n"+"%c"+
(direction===DIRECTIONS.LEFT?"left":"right")+"\n"+"%c"+
ctypeToString(cType1)+"\n"+"%c"+
ctypeToString(cType2)+"\n"+"%c"+"BEFORE: "+
(oldEditableHTML||"(unavailable)")+"\n"+"%c"+"AFTER:  "+
(editable?editable.innerHTML.replaceAll(" ","_").replaceAll("\u200B","ZWS"):"(unavailable)")+"\n","color: white; display: block; width: 100%;","color: "+
(direction===DIRECTIONS.LEFT?"magenta":"lightgreen")+"; display: block; width: 100%;","color: pink; display: block; width: 100%;","color: lightblue; display: block; width: 100%;","color: white; display: block; width: 100%;","color: white; display: block; width: 100%;",rule);}
if(Object.values(rule).filter((x)=>x!==undefined).length){const inverseDirection=direction===DIRECTIONS.LEFT?DIRECTIONS.RIGHT:DIRECTIONS.LEFT;enforceWhitespace(el,offset,inverseDirection,rule);}
return rule;}
__exports.isFakeLineBreak=isFakeLineBreak;function isFakeLineBreak(brEl){return!(getState(...rightPos(brEl),DIRECTIONS.RIGHT).cType&(CTYPES.CONTENT|CTGROUPS.BR));}
__exports.enforceWhitespace=enforceWhitespace;function enforceWhitespace(el,offset,direction,rule){const document=el.ownerDocument;let domPath,whitespaceAtEdgeRegex;if(direction===DIRECTIONS.LEFT){domPath=leftLeafOnlyNotBlockPath(el,offset);whitespaceAtEdgeRegex=new RegExp(whitespace+"+$");}else{domPath=rightLeafOnlyNotBlockPath(el,offset);whitespaceAtEdgeRegex=new RegExp("^"+whitespace+"+");}
const invisibleSpaceTextNodes=[];let foundVisibleSpaceTextNode=null;for(const node of domPath){if(node.nodeName==="BR"){if(rule.brVisibility===undefined){break;}
if(rule.brVisibility){node.before(document.createElement("br"));}else{if(!rule.extraBRRemovalCondition||rule.extraBRRemovalCondition(node)){node.remove();}}
break;}else if(node.nodeType===Node.TEXT_NODE&&!isInPre(node)){if(whitespaceAtEdgeRegex.test(node.nodeValue)){if(!isWhitespace(node)){foundVisibleSpaceTextNode=node;break;}else{invisibleSpaceTextNodes.push(node);}}else if(!isWhitespace(node)){break;}}else{break;}}
if(rule.spaceVisibility===undefined){return;}
if(!rule.spaceVisibility){for(const node of invisibleSpaceTextNodes){node.nodeValue="";const ancestorPath=closestPath(node.parentNode);let toRemove=null;for(const pNode of ancestorPath){if(toRemove){toRemove.remove();}
if(pNode.childNodes.length===1&&!isBlock(pNode)){pNode.after(node);toRemove=pNode;}else{break;}}}}
const spaceNode=foundVisibleSpaceTextNode||invisibleSpaceTextNodes[0];if(spaceNode){let spaceVisibility=rule.spaceVisibility;if(spaceVisibility&&!foundVisibleSpaceTextNode&&getState(...rightPos(spaceNode),DIRECTIONS.RIGHT).cType&CTGROUPS.BLOCK&&getState(...leftPos(spaceNode),DIRECTIONS.LEFT).cType!==CTYPES.CONTENT){spaceVisibility=false;}
spaceNode.nodeValue=spaceNode.nodeValue.replace(whitespaceAtEdgeRegex,spaceVisibility?"\u00A0":"");}}
__exports.observeMutations=observeMutations;function observeMutations(target,observerOptions){const records=[];const observerCallback=(mutations)=>records.push(...mutations);const observer=new MutationObserver(observerCallback);observer.observe(target,observerOptions);return()=>{observerCallback(observer.takeRecords());observer.disconnect();return records;};}
return __exports;});;

/* /html_editor/static/src/utils/dom_traversal.js */
odoo.define('@html_editor/utils/dom_traversal',['@html_editor/utils/position'],function(require){'use strict';let __exports={};const{DIRECTIONS}=require("@html_editor/utils/position");const closestPath=__exports.closestPath=function*(node){while(node){yield node;node=node.parentNode;}};__exports.findNode=findNode;function findNode(domPath,findCallback=()=>true,stopCallback=()=>false){for(const node of domPath){if(findCallback(node)){return node;}
if(stopCallback(node)){break;}}
return null;}
__exports.findUpTo=findUpTo;function findUpTo(node,limitAncestor,predicate){while(node!==limitAncestor){if(predicate(node)){return node;}
node=node.parentElement;}
return null;}
__exports.findFurthest=findFurthest;function findFurthest(node,limitAncestor,predicate){const nodes=[];while(node!==limitAncestor){nodes.push(node);node=node.parentNode;}
return nodes.findLast(predicate);}
__exports.closestElement=closestElement;function closestElement(node,predicate="*"){let element=node.nodeType===Node.ELEMENT_NODE?node:node.parentElement;const editable=element?.closest(".odoo-editor-editable");if(typeof predicate==="function"){while(element&&!predicate(element)){element=element.parentElement;}}else{element=element?.closest(predicate);}
if((editable&&editable.contains(element))||!node.isConnected){return element;}
return null;}
__exports.ancestors=ancestors;function ancestors(node,editable){const result=[];while(node&&node.parentElement&&node!==editable){result.push(node.parentElement);node=node.parentElement;}
return result;}
__exports.children=children;function children(elem){const children=[];let child=elem.firstElementChild;while(child){children.push(child);child=child.nextElementSibling;}
return children;}
__exports.childNodes=childNodes;function childNodes(node){const childNodes=[];let child=node.firstChild;while(child){childNodes.push(child);child=child.nextSibling;}
return childNodes;}
__exports.descendants=descendants;function descendants(node,posterity=[]){let child=node.firstChild;while(child){posterity.push(child);descendants(child,posterity);child=child.nextSibling;}
return posterity;}
const PATH_END_REASONS=__exports.PATH_END_REASONS={NO_NODE:0,BLOCK_OUT:1,BLOCK_HIT:2,OUT_OF_SCOPE:3,};__exports.createDOMPathGenerator=createDOMPathGenerator;function createDOMPathGenerator(direction,{leafOnly=false,inScope=false,stopTraverseFunction,stopFunction}={}){const nextDeepest=direction===DIRECTIONS.LEFT?(node)=>lastLeaf(node.previousSibling,stopTraverseFunction):(node)=>firstLeaf(node.nextSibling,stopTraverseFunction);const firstNode=direction===DIRECTIONS.LEFT?(node,offset)=>lastLeaf(node.childNodes[offset-1],stopTraverseFunction):(node,offset)=>firstLeaf(node.childNodes[offset],stopTraverseFunction);return function*(node,offset,reasons=[]){let movedUp=false;let currentNode=firstNode(node,offset);if(!currentNode){movedUp=true;currentNode=node;}
while(currentNode){if(stopFunction&&stopFunction(currentNode)){reasons.push(movedUp?PATH_END_REASONS.BLOCK_OUT:PATH_END_REASONS.BLOCK_HIT);break;}
if(inScope&&currentNode===node){reasons.push(PATH_END_REASONS.OUT_OF_SCOPE);break;}
if(!(leafOnly&&movedUp)){yield currentNode;}
movedUp=false;let nextNode=nextDeepest(currentNode);if(!nextNode){movedUp=true;nextNode=currentNode.parentNode;}
currentNode=nextNode;}
reasons.push(PATH_END_REASONS.NO_NODE);};}
__exports.lastLeaf=lastLeaf;function lastLeaf(node,stopTraverseFunction){while(node&&node.lastChild&&!(stopTraverseFunction&&stopTraverseFunction(node))){node=node.lastChild;}
return node;}
__exports.firstLeaf=firstLeaf;function firstLeaf(node,stopTraverseFunction){while(node&&node.firstChild&&!(stopTraverseFunction&&stopTraverseFunction(node))){node=node.firstChild;}
return node;}
__exports.getAdjacentPreviousSiblings=getAdjacentPreviousSiblings;function getAdjacentPreviousSiblings(node,predicate=(n)=>!!n){let previous=node.previousSibling;const list=[];while(previous&&predicate(previous)){list.push(previous);previous=previous.previousSibling;}
return list;}
__exports.getAdjacentNextSiblings=getAdjacentNextSiblings;function getAdjacentNextSiblings(node,predicate=(n)=>!!n){let next=node.nextSibling;const list=[];while(next&&predicate(next)){list.push(next);next=next.nextSibling;}
return list;}
__exports.getAdjacents=getAdjacents;function getAdjacents(node,predicate=(n)=>!!n){const previous=getAdjacentPreviousSiblings(node,predicate);const next=getAdjacentNextSiblings(node,predicate);return predicate(node)?[...previous.reverse(),node,...next]:[];}
__exports.getCommonAncestor=getCommonAncestor;function getCommonAncestor(nodes,root=undefined){const pathsToRoot=nodes.map((node)=>[node,...ancestors(node,root)]);let candidate=pathsToRoot[0]?.at(-1);if(root&&candidate!==root){return null;}
let commonAncestor=null;while(candidate&&pathsToRoot.every((path)=>path.at(-1)===candidate)){commonAncestor=candidate;pathsToRoot.forEach((path)=>path.pop());candidate=pathsToRoot[0].at(-1);}
return commonAncestor;}
const selectElements=__exports.selectElements=function*(root,selector){if(root.matches(selector)){yield root;}
for(const elem of root.querySelectorAll(selector)){yield elem;}};return __exports;});;

/* /html_editor/static/src/utils/drag_and_drop.js */
odoo.define('@html_editor/utils/drag_and_drop',['@web/core/utils/draggable_hook_builder','@web/core/utils/objects','@odoo/owl','@web/core/utils/timing','@web/core/utils/ui'],function(require){'use strict';let __exports={};const{makeDraggableHook}=require("@web/core/utils/draggable_hook_builder");const{pick}=require("@web/core/utils/objects");const{reactive}=require("@odoo/owl");const{throttleForAnimation}=require("@web/core/utils/timing");const{closest,touching}=require("@web/core/utils/ui");__exports.useNativeDraggable=useNativeDraggable;function useNativeDraggable(hookParams,initialParams){const setupFunctions=new Map();const cleanupFunctions=[];const currentParams={...initialParams};const setupHooks={wrapState:reactive,throttle:throttleForAnimation,addListener:(el,type,callback,options)=>{el.addEventListener(type,callback,options);cleanupFunctions.push(()=>el.removeEventListener(type,callback));},setup:(setupFn,depsFn)=>setupFunctions.set(setupFn,depsFn),teardown:(cleanupFn)=>{cleanupFunctions.push(cleanupFn);},};const el=initialParams.ref.el;el.classList.add("o_draggable");cleanupFunctions.push(()=>el.classList.remove("o_draggable"));const draggableState=makeDraggableHook({setupHooks,...hookParams})(currentParams);draggableState.enable=true;const draggableComponent={state:draggableState,update:(newParams)=>{Object.assign(currentParams,newParams);setupFunctions.forEach((depsFn,setupFn)=>setupFn(...depsFn()));},destroy:()=>{cleanupFunctions.forEach((cleanupFn)=>cleanupFn());},};draggableComponent.update({});return draggableComponent;}
function updateElementPosition(el,{x,y},styleFn,offset={x:0,y:0}){return styleFn(el,{top:`${y - offset.y}px`,left:`${x - offset.x}px`});}
const dragAndDropHookParams={name:"useDragAndDrop",acceptedParams:{dropzones:[Function],scrollingElement:[Function],helper:[Function],extraWindow:[Object,Function],},edgeScrolling:{enabled:true},onComputeParams({ctx,params}){ctx.followCursor=false;ctx.getScrollingElement=params.scrollingElement;ctx.getHelper=params.helper;ctx.getDropZones=params.dropzones;},onWillStartDrag:({ctx})=>{ctx.current.container=ctx.getScrollingElement();ctx.current.helperOffset={x:0,y:0};},onDragStart:({ctx,addStyle,addCleanup})=>{ctx.current.helper=ctx.getHelper({...ctx.current,...ctx.pointer});ctx.current.helper.style.position="fixed";ctx.current.element.classList.remove("o_dragged");ctx.current.helper.style.cursor=ctx.cursor;ctx.current.helper.style.pointerEvents="auto";const frameElement=ctx.current.helper.ownerDocument.defaultView.frameElement;if(frameElement){addStyle(frameElement,{pointerEvents:"auto"});}
addCleanup(()=>ctx.current.helper.remove());updateElementPosition(ctx.current.helper,ctx.pointer,addStyle,ctx.current.helperOffset);return pick(ctx.current,"element","helper");},onDrag:({ctx,addStyle,callHandler})=>{ctx.current.helper.classList.add("o_draggable_dragging");updateElementPosition(ctx.current.helper,ctx.pointer,addStyle,ctx.current.helperOffset);let helperRect=ctx.current.helper.getBoundingClientRect();helperRect={x:helperRect.x,y:helperRect.y,width:helperRect.width,height:helperRect.height,};const dropzoneEl=closest(touching(ctx.getDropZones(),helperRect),helperRect);if(ctx.current.dropzone?.el&&ctx.current.dropzone.el.classList.contains("oe_grid_zone")){ctx.current.dropzone.rect=ctx.current.dropzone.el.getBoundingClientRect();}
if(ctx.current.dropzone&&(ctx.current.dropzone.el===dropzoneEl||(!dropzoneEl&&touching([ctx.current.helper],ctx.current.dropzone.rect).length>0))){return pick(ctx.current,"element","dropzone","helper");}
if(ctx.current.dropzone&&dropzoneEl!==ctx.current.dropzone.el){callHandler("dropzoneOut",{dropzone:ctx.current.dropzone,helper:ctx.current.helper,});delete ctx.current.dropzone;}
if(dropzoneEl){const rect=DOMRect.fromRect(dropzoneEl.getBoundingClientRect());ctx.current.dropzone={el:dropzoneEl,rect:{x:rect.x,y:rect.y,width:rect.width,height:rect.height,},};callHandler("dropzoneOver",{dropzone:ctx.current.dropzone,helper:ctx.current.helper,});}
return pick(ctx.current,"element","dropzone","helper");},onDragEnd({ctx}){return pick(ctx.current,"element","dropzone","helper");},};__exports.useDragAndDrop=useDragAndDrop;function useDragAndDrop(initialParams){return useNativeDraggable(dragAndDropHookParams,initialParams);}
return __exports;});;

/* /html_editor/static/src/utils/fonts.js */
odoo.define('@html_editor/utils/fonts',[],function(require){'use strict';let __exports={};const fonts=__exports.fonts={cacheCssSelectors:{},getCssSelectors:function(filter){if(this.cacheCssSelectors[filter]){return this.cacheCssSelectors[filter];}
this.cacheCssSelectors[filter]=[];var sheets=document.styleSheets;for(var i=0;i<sheets.length;i++){var rules;try{rules=sheets[i].rules||sheets[i].cssRules;}catch{continue;}
if(!rules){continue;}
for(var r=0;r<rules.length;r++){var selectorText=rules[r].selectorText;if(!selectorText){continue;}
var selectors=selectorText.split(/\s*,\s*/);var data=null;for(var s=0;s<selectors.length;s++){var match=selectors[s].trim().match(filter);if(!match){continue;}
if(!data){data={selector:match[0],css:rules[r].cssText.replace(/(^.*\{\s*)|(\s*\}\s*$)/g,""),names:[match[1]],};}else{data.selector+=", "+match[0];data.names.push(match[1]);}}
if(data){this.cacheCssSelectors[filter].push(data);}}}
return this.cacheCssSelectors[filter];},fontIcons:[{base:"fa",parser:/\.(fa-(?:\w|-)+)::?before/i}],computedFonts:false,computeFonts:function(){if(!this.computedFonts){var self=this;this.fontIcons.forEach((data)=>{data.cssData=self.getCssSelectors(data.parser);data.alias=data.cssData.map((x)=>x.names).flat();});this.computedFonts=true;}},};return __exports;});;

/* /html_editor/static/src/utils/formatting.js */
odoo.define('@html_editor/utils/formatting',['@web/core/utils/colors','@html_editor/utils/dom','@html_editor/utils/dom_info','@html_editor/utils/dom_traversal','@html_editor/utils/blocks'],function(require){'use strict';let __exports={};const{normalizeCSSColor}=require("@web/core/utils/colors");const{removeClass}=require("@html_editor/utils/dom");const{isBold,isDirectionSwitched,isItalic,isStrikeThrough,isUnderline}=require("@html_editor/utils/dom_info");const{closestElement,closestPath,findNode}=require("@html_editor/utils/dom_traversal");const{closestBlock,isBlock}=require("@html_editor/utils/blocks");const FONT_SIZE_CLASSES=__exports.FONT_SIZE_CLASSES=["display-1-fs","display-2-fs","display-3-fs","display-4-fs","h1-fs","h2-fs","h3-fs","h4-fs","h5-fs","h6-fs","base-fs","small","o_small-fs",];const TEXT_STYLE_CLASSES=__exports.TEXT_STYLE_CLASSES=["display-1","display-2","display-3","display-4","lead"];const DEFAULT_FONT_SIZE_CLASSES=__exports.DEFAULT_FONT_SIZE_CLASSES=["h1","h2","h3","h4","h5","h6","o_default_font_size",];const FORMATTABLE_TAGS=__exports.FORMATTABLE_TAGS=["SPAN","FONT","B","STRONG","I","EM","U","S","CODE"];const formatsSpecs=__exports.formatsSpecs={italic:{tagName:"em",isFormatted:isItalic,isTag:(node)=>["EM","I"].includes(node.tagName),hasStyle:(node)=>Boolean(node.style&&node.style["font-style"]),addStyle:(node)=>(node.style["font-style"]="italic"),addNeutralStyle:(node)=>(node.style["font-style"]="normal"),removeStyle:(node)=>removeStyle(node,"font-style"),},bold:{tagName:"strong",isFormatted:isBold,isTag:(node)=>["STRONG","B"].includes(node.tagName),hasStyle:(node)=>Boolean(node.style&&node.style["font-weight"]),addStyle:(node)=>(node.style["font-weight"]="bolder"),addNeutralStyle:(node)=>{node.style["font-weight"]="normal";},removeStyle:(node)=>removeStyle(node,"font-weight"),},underline:{tagName:"u",isFormatted:isUnderline,isTag:(node)=>node.tagName==="U",hasStyle:(node)=>node.style&&(node.style["text-decoration"].includes("underline")||node.style["text-decoration-line"].includes("underline")),addStyle:(node)=>(node.style["text-decoration-line"]+=" underline"),removeStyle:(node)=>removeStyle(node,node.style["text-decoration"].includes("underline")?"text-decoration":"text-decoration-line","underline"),},strikeThrough:{tagName:"s",isFormatted:isStrikeThrough,isTag:(node)=>node.tagName==="S",hasStyle:(node)=>node.style&&(node.style["text-decoration"].includes("line-through")||node.style["text-decoration-line"].includes("line-through")),addStyle:(node)=>(node.style["text-decoration-line"]+=" line-through"),removeStyle:(node)=>removeStyle(node,node.style["text-decoration"].includes("line-through")?"text-decoration":"text-decoration-line","line-through"),},fontFamily:{isFormatted:(node)=>!!closestElement(node,(el)=>el.style["font-family"]),hasStyle:(node)=>node.style&&node.style["font-family"],addStyle:(node,props)=>{removeStyle(node,"font-family");if(props.fontFamily){node.style["font-family"]=props.fontFamily;}},removeStyle:(node)=>removeStyle(node,"font-family"),},fontSize:{isFormatted:(node,props)=>{const fontSize=(findNode(closestPath(node),(el)=>el.style?.["font-size"],isBlock)||closestElement(node,"li"))?.style["font-size"];return props?.size?fontSize===props.size:fontSize;},hasStyle:(node)=>node.style&&node.style["font-size"],addStyle:(node,props)=>{node.style["font-size"]=props.size;removeClass(node,...FONT_SIZE_CLASSES);},removeStyle:(node)=>removeStyle(node,"font-size"),},setFontSizeClassName:{isFormatted:(node,props)=>props?.className?FONT_SIZE_CLASSES.includes(props.className)&&!!(findNode(closestPath(node),(el)=>el.classList?.contains(props.className),(el)=>el===closestBlock(node).parentElement)||closestElement(node,"li")?.classList?.contains(props.className)):!!findNode(closestPath(node),(el)=>FONT_SIZE_CLASSES.find((cls)=>el.classList?.contains(cls)),(el)=>el===closestBlock(node).parentElement)||FONT_SIZE_CLASSES.find((cls)=>closestElement(node,"li")?.classList.contains(cls)),hasStyle:(node,props)=>[...FONT_SIZE_CLASSES,...TEXT_STYLE_CLASSES,...DEFAULT_FONT_SIZE_CLASSES].find((cls)=>node.classList.contains(cls)),addStyle:(node,props)=>{node.style.removeProperty("font-size");node.classList.add(props.className);},removeStyle:(node)=>{removeStyle(node,"font-size");removeClass(node,...FONT_SIZE_CLASSES);if(!isBlock(node)){removeClass(node,...TEXT_STYLE_CLASSES,...DEFAULT_FONT_SIZE_CLASSES);}},addNeutralStyle:function(node){const block=closestBlock(node);if(["H1","H2","H3","H4","H5","H6"].includes(block.nodeName)){node.classList.add(block.nodeName.toLowerCase());}else{node.classList.add("o_default_font_size");}},},switchDirection:{isFormatted:(node,props)=>isDirectionSwitched(node,props.editable),},};function removeStyle(node,styleName,item){if(item){const newStyle=node.style[styleName].split(" ").filter((x)=>x!==item).join(" ");node.style[styleName]=newStyle||null;}else{node.style[styleName]=null;}
if(node.getAttribute("style")===""){node.removeAttribute("style");}}
__exports.getCSSVariableValue=getCSSVariableValue;function getCSSVariableValue(key,htmlStyle){let value=htmlStyle.getPropertyValue(`--${key}`).trim();value=normalizeCSSColor(value);return value.replace(/"/g,"'");}
const CSS_UNITS_CONVERSION={"s-ms":()=>1000,"ms-s":()=>0.001,"rem-px":(htmlStyle)=>parseFloat(htmlStyle["font-size"]),"px-rem":(htmlStyle)=>1/parseFloat(htmlStyle["font-size"]),"%-px":()=>-1,"px-%":()=>-1,};__exports.convertNumericToUnit=convertNumericToUnit;function convertNumericToUnit(value,unitFrom,unitTo,htmlStyle){if(Math.abs(value)<Number.EPSILON||unitFrom===unitTo){return value;}
const converter=CSS_UNITS_CONVERSION[`${unitFrom}-${unitTo}`];if(converter===undefined){throw new Error(`Cannot convert '${unitFrom}' units into '${unitTo}' units !`);}
return value*converter(htmlStyle);}
__exports.getHtmlStyle=getHtmlStyle;function getHtmlStyle(document){return document.defaultView.getComputedStyle(document.documentElement);}
__exports.getFontSizeDisplayValue=getFontSizeDisplayValue;function getFontSizeDisplayValue(sel,document){const tagNameRelatedToFontSize=["h1","h2","h3","h4","h5","h6"];const styleClassesRelatedToFontSize=["display-1","display-2","display-3","display-4","lead",];const closestStartContainerEl=closestElement(sel.startContainer);const closestFontSizedEl=closestStartContainerEl.closest(`
        [style*='font-size'],
        ${FONT_SIZE_CLASSES.map((className) => `.${className}`)},
        ${styleClassesRelatedToFontSize.map((className) => `.${className}`)},
        ${tagNameRelatedToFontSize}
    `);let remValue;const htmlStyle=getHtmlStyle(document);if(closestFontSizedEl){const useFontSizeInput=closestFontSizedEl.style.fontSize;if(useFontSizeInput){return parseFloat(getComputedStyle(closestStartContainerEl).fontSize);}
const fontSizeClass=FONT_SIZE_CLASSES.find((className)=>closestFontSizedEl.classList.contains(className));let fsName;if(fontSizeClass){fsName=fontSizeClass.substring(0,fontSizeClass.length-3);}else{fsName=styleClassesRelatedToFontSize.find((className)=>closestFontSizedEl.classList.contains(className))||closestFontSizedEl.tagName.toLowerCase();}
remValue=parseFloat(getCSSVariableValue(`${fsName}-font-size`,htmlStyle));}
const pxValue=remValue&&convertNumericToUnit(remValue,"rem","px",htmlStyle);return pxValue||parseFloat(getComputedStyle(closestStartContainerEl).fontSize);}
__exports.getFontSizeOrClass=getFontSizeOrClass;function getFontSizeOrClass(node){if(!node){return null;}
if(node.style.fontSize){return{type:"font-size",value:node.style.fontSize};}
const fontSizeClass=FONT_SIZE_CLASSES.find((cls)=>node.classList.contains(cls));if(fontSizeClass){return{type:"class",value:fontSizeClass};}
return null;}
return __exports;});;

/* /html_editor/static/src/utils/functions.js */
odoo.define('@html_editor/utils/functions',[],function(require){'use strict';let __exports={};__exports.weakMemoize=weakMemoize;function weakMemoize(func){const cache=new WeakMap();const funcName=func.name?func.name+" (memoized)":"memoized";return{[funcName](firstArg,...args){if(!cache.has(firstArg)){cache.set(firstArg,func(firstArg,...args));}
return cache.get(firstArg);},}[funcName];}
return __exports;});;

/* /html_editor/static/src/utils/html.js */
odoo.define('@html_editor/utils/html',[],function(require){'use strict';let __exports={};__exports.parseHTML=parseHTML;function parseHTML(document,html){const fragment=document.createDocumentFragment();const parser=new document.defaultView.DOMParser();const parsedDocument=parser.parseFromString(html,"text/html");fragment.replaceChildren(...parsedDocument.body.childNodes);return fragment;}
__exports.normalizeHTML=normalizeHTML;function normalizeHTML(content,cleanup=()=>{}){const parser=new document.defaultView.DOMParser();const body=parser.parseFromString(content,"text/html").body;cleanup(body);return body.innerHTML;}
return __exports;});;

/* /html_editor/static/src/utils/image.js */
odoo.define('@html_editor/utils/image',['@web/core/utils/colors'],function(require){'use strict';let __exports={};const{isColorGradient}=require("@web/core/utils/colors");__exports.backgroundImageCssToParts=backgroundImageCssToParts;function backgroundImageCssToParts(css=""){const parts={};if(css.startsWith("url(")){const urlEnd=css.indexOf(")")+1;parts.url=css.substring(0,urlEnd).trim();const commaPos=css.indexOf(",",urlEnd);css=commaPos>0?css.substring(commaPos+1):"";}
if(isColorGradient(css)){parts.gradient=css.trim();}
return parts;}
__exports.backgroundImagePartsToCss=backgroundImagePartsToCss;function backgroundImagePartsToCss(parts){return[parts.url,parts.gradient].filter(Boolean).join(", ")||"";}
__exports.getMimetype=getMimetype;function getMimetype(image,data=image.dataset){const src=getImageSrc(image);return(data.mimetype||data.mimetypeBeforeConversion||(src&&((src.endsWith(".png")&&"image/png")||(src.endsWith(".webp")&&"image/webp")||(src.endsWith(".jpg")&&"image/jpeg")||(src.endsWith(".jpeg")&&"image/jpeg")))||null);}
__exports.isImageCorsProtected=isImageCorsProtected;async function isImageCorsProtected(img){const src=img.getAttribute("src");if(!src){return false;}
let isCorsProtected=false;if(!src.startsWith("/")||/\/web\/image\/\d+-redirect\//.test(src)){isCorsProtected=await fetch(src,{method:"HEAD"}).then(()=>false).catch(()=>true);}
return isCorsProtected;}
__exports.isSrcCorsProtected=isSrcCorsProtected;async function isSrcCorsProtected(src){const dummyImg=document.createElement("img");dummyImg.src=src;return isImageCorsProtected(dummyImg);}
__exports.getImageSrc=getImageSrc;function getImageSrc(el){if(el.tagName==="IMG"){return el.getAttribute("src");}
if(el.querySelector(".s_parallax_bg")){el=el.querySelector(".s_parallax_bg");}
const url=backgroundImageCssToParts(el.style.backgroundImage).url;return url&&getBgImageURLFromURL(url);}
__exports.getBgImageURLFromURL=getBgImageURLFromURL;function getBgImageURLFromURL(url){const match=url.match(/^url\((['"])(.*?)\1\)$/);if(!match){return"";}
const matchedURL=match[2];const fullURL=new URL(matchedURL,window.location.origin);if(fullURL.origin===window.location.origin){return fullURL.href.slice(fullURL.origin.length);}
return matchedURL;}
return __exports;});;

/* /html_editor/static/src/utils/image_processing.js */
odoo.define('@html_editor/utils/image_processing',['@web/core/network/rpc','@web/core/utils/objects','@web/core/assets','@html_editor/utils/image'],function(require){'use strict';let __exports={};const{rpc}=require("@web/core/network/rpc");const{pick}=require("@web/core/utils/objects");const{loadBundle}=require("@web/core/assets");const{getImageSrc}=require("@html_editor/utils/image");const cropperDataFields=__exports.cropperDataFields=["x","y","width","height","rotate","scaleX","scaleY"];const cropperDataFieldsWithAspectRatio=__exports.cropperDataFieldsWithAspectRatio=[...cropperDataFields,"aspectRatio"];const isGif=__exports.isGif=(mimetype)=>mimetype==="image/gif";let _isWebGLEnabled;__exports.isWebGLEnabled=isWebGLEnabled;function isWebGLEnabled(){if(_isWebGLEnabled!==undefined){return _isWebGLEnabled;}
try{const canvas=document.createElement("canvas");_isWebGLEnabled=!!(window.WebGLRenderingContext&&(canvas.getContext("webgl")||canvas.getContext("experimental-webgl")));}catch{_isWebGLEnabled=false;}
return _isWebGLEnabled;}
const modifierFields=["filter","quality","mimetype","glFilter","originalId","originalSrc","resizeWidth","aspectRatio","mimetypeBeforeConversion",];const removeOnImageChangeAttrs=__exports.removeOnImageChangeAttrs=[...cropperDataFields,...modifierFields];const cache={};const placeholderHref="/web/image/__odoo__unknown__src__/";function _getValidSrc(src){if(src in cache){return cache[src];}
const prom=new Promise((resolve)=>{fetch(src).then((response)=>{resolve(response.ok?src:placeholderHref);}).catch(()=>{resolve(placeholderHref);});});cache[src]=prom;return prom;}
__exports.loadImage=loadImage;async function loadImage(src,img=new Image()){const source=await _getValidSrc(src);return new Promise((resolve,reject)=>{img.addEventListener("load",()=>resolve(img),{once:true});img.addEventListener("error",reject,{once:true});img.src=source;});}
const imageCache=new Map();function _loadImageObjectURL(src){return _updateImageData(src);}
__exports.loadImageDataURL=loadImageDataURL;function loadImageDataURL(src){return _updateImageData(src,"dataURL");}
async function _updateImageData(src,key="objectURL"){const currentImageData=imageCache.get(src);if(currentImageData&&currentImageData[key]){return currentImageData[key];}
let value="";const blob=await fetch(src).then((res)=>res.blob());if(key==="dataURL"){value=await createDataURL(blob);}else{value=URL.createObjectURL(blob);}
imageCache.set(src,Object.assign(currentImageData||{},{[key]:value,size:blob.size}));return value;}
__exports.getImageSizeFromCache=getImageSizeFromCache;function getImageSizeFromCache(src){return imageCache.get(src).size;}
__exports.activateCropper=activateCropper;async function activateCropper(image,aspectRatio,dataset){await loadBundle("html_editor.assets_image_cropper");const oldSrc=image.src;const newSrc=await _loadImageObjectURL(image.getAttribute("src"));image.src=newSrc;let readyResolve;const readyPromise=new Promise((resolve)=>(readyResolve=resolve));const cropper=new Cropper(image,{viewMode:2,dragMode:"move",autoCropArea:1.0,aspectRatio:aspectRatio,data:Object.fromEntries(Object.entries(pick(dataset,...cropperDataFields)).map(([key,value])=>[key,parseFloat(value),])),minContainerWidth:1,minContainerHeight:1,ready:readyResolve,});if(oldSrc===newSrc&&image.complete){return;}
await readyPromise;return cropper;}
__exports.loadImageInfo=loadImageInfo;async function loadImageInfo(el,attachmentSrc=""){const newDataset={};const elSrc=getImageSrc(el);const src=attachmentSrc||elSrc;if((el.dataset.originalSrc&&el.dataset.mimetypeBeforeConversion)||!src){return newDataset;}
let docHref=el.ownerDocument.defaultView.location.href;if(docHref.startsWith("about:")){docHref=window.location.href;}
const srcUrl=new URL(src,docHref);let relativeSrc=decodeURI(srcUrl.pathname);let match=relativeSrc.match(/\/(?:web_editor|html_editor)\/image_shape\/(\w+\.\w+)/);if(el.dataset.shape&&match){match=match[1];if(match.endsWith("_perspective")){match=match.slice(0,-12);}
relativeSrc=`/web/image/${encodeURIComponent(match)}`;}
const{original}=await rpc("/html_editor/get_image_info",{src:relativeSrc},{cache:true});if(original&&original.image_src&&!/\/web\/image\/\d+-redirect\//.test(original.image_src)){newDataset.originalId=original.id;newDataset.originalSrc=original.image_src;newDataset.mimetypeBeforeConversion=original.mimetype;}
return newDataset;}
__exports.createDataURL=createDataURL;function createDataURL(blob){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.addEventListener("load",()=>resolve(reader.result));reader.addEventListener("abort",reject);reader.addEventListener("error",reject);reader.readAsDataURL(blob);});}
__exports.getDataURLBinarySize=getDataURLBinarySize;function getDataURLBinarySize(dataURL){return(dataURL.split(",")[1].length/4)*3;}
__exports.getAspectRatio=getAspectRatio;function getAspectRatio(ratio){if(typeof ratio==="number"){return ratio;}
const[a,b]=ratio.split(/[:/]/).map((n)=>parseFloat(n));if(!b){return a;}
return a/b;}
return __exports;});;

/* /html_editor/static/src/utils/perspective_utils.js */
odoo.define('@html_editor/utils/perspective_utils',[],function(require){'use strict';let __exports={};__exports.transform=transform;function transform([[a,b,c],[d,e,f],[g,h,i]],[x,y]){const z=g*x+h*y+i;return[(a*x+b*y+c)/z,(d*x+e*y+f)/z];}
function invert([[a,b,c],[d,e,f],[g,h,i]]){const determinant=a*e*i-a*f*h-b*d*i+b*f*g+c*d*h-c*e*g;return[[(e*i-h*f)/determinant,(h*c-b*i)/determinant,(b*f-e*c)/determinant,],[(g*f-d*i)/determinant,(a*i-g*c)/determinant,(d*c-a*f)/determinant,],[(d*h-g*e)/determinant,(g*b-a*h)/determinant,(a*e-d*b)/determinant,],];}
function multiply(a,b){const[[a0,a1,a2],[a3,a4,a5],[a6,a7,a8]]=a;const[[b0,b1,b2],[b3,b4,b5],[b6,b7,b8]]=b;return[[a0*b0+a1*b3+a2*b6,a0*b1+a1*b4+a2*b7,a0*b2+a1*b5+a2*b8],[a3*b0+a4*b3+a5*b6,a3*b1+a4*b4+a5*b7,a3*b2+a4*b5+a5*b8],[a6*b0+a7*b3+a8*b6,a6*b1+a7*b4+a8*b7,a6*b2+a7*b5+a8*b8],];}
__exports.getProjective=getProjective;function getProjective(width,height,[[x0,y0],[x1,y1],[x2,y2],[x3,y3]]){const denominator=x3*(y1-y2)+x1*(y2-y3)+x2*(y3-y1);const a=(x0*(y2-y3)+x2*(y3-y0)+x3*(y0-y2))/denominator;const b=(x0*(y3-y1)+x3*(y1-y0)+x1*(y0-y3))/denominator;const c=(x0*(y1-y2)+x1*(y2-y0)+x2*(y0-y1))/denominator;const reverse=invert([[width,-width,0],[0,-height,height],[1,-1,1],]);const forward=[[a*x1,b*x2,c*x3],[a*y1,b*y2,c*y3],[a,b,c],];return multiply(forward,reverse);}
__exports.getAffineApproximation=getAffineApproximation;function getAffineApproximation(projective,[[x0,y0],[x1,y1],[x2,y2]]){const a=transform(projective,[x0,y0]);const b=transform(projective,[x1,y1]);const c=transform(projective,[x2,y2]);return multiply([[a[0],b[0],c[0]],[a[1],b[1],c[1]],[1,1,1],],invert([[x0,x1,x2],[y0,y1,y2],[1,1,1],]));}
return __exports;});;

/* /html_editor/static/src/utils/position.js */
odoo.define('@html_editor/utils/position',[],function(require){'use strict';let __exports={};const DIRECTIONS=__exports.DIRECTIONS={LEFT:false,RIGHT:true,};__exports.leftPos=leftPos;function leftPos(node){return[node.parentElement,childNodeIndex(node)];}
__exports.rightPos=rightPos;function rightPos(node){return[node.parentElement,childNodeIndex(node)+1];}
__exports.boundariesOut=boundariesOut;function boundariesOut(node){const index=childNodeIndex(node);return[node.parentElement,index,node.parentElement,index+1];}
__exports.boundariesIn=boundariesIn;function boundariesIn(node){return[node,0,node,nodeSize(node)];}
__exports.startPos=startPos;function startPos(node){return[node,0];}
__exports.endPos=endPos;function endPos(node){return[node,nodeSize(node)];}
__exports.childNodeIndex=childNodeIndex;function childNodeIndex(node){let i=0;while(node.previousSibling){i++;node=node.previousSibling;}
return i;}
__exports.nodeSize=nodeSize;function nodeSize(node){const isTextNode=node.nodeType===Node.TEXT_NODE;if(isTextNode){return node.length;}else{const child=node.lastChild;return child?childNodeIndex(child)+1:0;}}
return __exports;});;

/* /html_editor/static/src/utils/regex.js */
odoo.define('@html_editor/utils/regex',[],function(require){'use strict';let __exports={};const tldWhitelist=['com','net','org','ac','ad','ae','af','ag','ai','al','am','an','ao','aq','ar','as','at','au','aw','ax','az','ba','bb','bd','be','bf','bg','bh','bi','bj','bl','bm','bn','bo','br','bq','bs','bt','bv','bw','by','bz','ca','cc','cd','cf','cg','ch','ci','ck','cl','cm','cn','co','cr','cs','cu','cv','cw','cx','cy','cz','dd','de','dj','dk','dm','do','dz','ec','ee','eg','eh','er','es','et','eu','fi','fj','fk','fm','fo','fr','ga','gb','gd','ge','gf','gg','gh','gi','gl','gm','gn','gp','gq','gr','gs','gt','gu','gw','gy','hk','hm','hn','hr','ht','hu','id','ie','il','im','in','io','iq','ir','is','it','je','jm','jo','jp','ke','kg','kh','ki','km','kn','kp','kr','kw','ky','kz','la','lb','lc','li','lk','lr','ls','lt','lu','lv','ly','ma','mc','md','me','mf','mg','mh','mk','ml','mm','mn','mo','mp','mq','mr','ms','mt','mu','mv','mw','mx','my','mz','na','nc','ne','nf','ng','ni','nl','no','np','nr','nu','nz','om','pa','pe','pf','pg','ph','pk','pl','pm','pn','pr','ps','pt','pw','py','qa','re','ro','rs','ru','rw','sa','sb','sc','sd','se','sg','sh','si','sj','sk','sl','sm','sn','so','sr','ss','st','su','sv','sx','sy','sz','tc','td','tf','tg','th','tj','tk','tl','tm','tn','to','tp','tr','tt','tv','tw','tz','ua','ug','uk','um','us','uy','uz','va','vc','ve','vg','vi','vn','vu','wf','ws','ye','yt','yu','za','zm','zr','zw','co\\.uk'];const urlRegexBase=`|(?:www.))[-a-zA-Z0-9@:%._\\+~#=]{2,256}\\.[a-zA-Z][a-zA-Z0-9]{1,62}|(?:[-a-zA-Z0-9@:%._\\+~#=]{2,256}\\.(?:${tldWhitelist.join('|')})\\b))(?:(?:[/?#])[^\\s]*[^!.,})\\]'"\\s]|(?:[^!(){}.,[\\]'"\\s]+))?`;const httpCapturedRegex=`(https?:\\/\\/)`;const URL_REGEX=__exports.URL_REGEX=new RegExp(`((?:(?:${httpCapturedRegex}${urlRegexBase})`,'i');return __exports;});;

/* /html_editor/static/src/utils/resource.js */
odoo.define('@html_editor/utils/resource',[],function(require){'use strict';let __exports={};const resourceSequenceSymbol=__exports.resourceSequenceSymbol=Symbol("resourceSequence");__exports.withSequence=withSequence;function withSequence(sequenceNumber,object){if(typeof sequenceNumber!=="number"){throw new Error(`sequenceNumber must be a number. Got ${sequenceNumber} (${typeof sequenceNumber}).`);}
return{[resourceSequenceSymbol]:sequenceNumber,object,};}
return __exports;});;

/* /html_editor/static/src/utils/sanitize.js */
odoo.define('@html_editor/utils/sanitize',['@html_editor/utils/dom_info','@html_editor/utils/dom','@odoo/owl','@web/core/utils/html'],function(require){'use strict';let __exports={};const{containsAnyInline}=require("@html_editor/utils/dom_info");const{wrapInlinesInBlocks}=require("@html_editor/utils/dom");const{markup}=require("@odoo/owl");const{htmlReplace}=require("@web/core/utils/html");__exports.initElementForEdition=initElementForEdition;function initElementForEdition(element,options={}){if(element?.nodeType===Node.ELEMENT_NODE&&containsAnyInline(element)&&!options.allowInlineAtRoot){wrapInlinesInBlocks(element,{baseContainerNodeName:"DIV",});}
for(const img of element.querySelectorAll("img[width], img[height]")){const width=img.getAttribute("width");const height=img.getAttribute("height");img.removeAttribute("height");img.removeAttribute("width");img.style.setProperty("width",isNaN(width)?width:`${width}px`);img.style.setProperty("height",isNaN(height)?height:`${height}px`);}}
__exports.fixInvalidHTML=fixInvalidHTML;function fixInvalidHTML(content){if(!content){return content;}
const regex=/<\s*(?!area\b|base\b|br\b|col\b|embed\b|hr\b|img\b|input\b|link\b|meta\b|param\b|source\b|track\b|wbr\b)([a-zA-Z0-9:-]+)\s*((?:(?:\s+[\w:-]+(?:\s*=\s*(?:"[^"]*"|'[^']*'|[^\s"'=<>`]+))?)*))\s*\/>/g;return htmlReplace(content,regex,(match,tag,attributes)=>{attributes=markup(attributes);return markup`<${tag}${attributes}></${tag}>`;});}
let Markup=null;__exports.instanceofMarkup=instanceofMarkup;function instanceofMarkup(value){if(!Markup){Markup=markup("").constructor;}
return value instanceof Markup;}
return __exports;});;

/* /html_editor/static/src/utils/selection.js */
odoo.define('@html_editor/utils/selection',['@html_editor/utils/blocks','@html_editor/utils/dom_info','@html_editor/utils/dom_state','@html_editor/utils/dom_traversal','@html_editor/utils/position'],function(require){'use strict';let __exports={};const{closestBlock,isBlock}=require("@html_editor/utils/blocks");const{getDeepestPosition,isContentEditable,isNotEditableNode,isSelfClosingElement,nextLeaf,previousLeaf,}=require("@html_editor/utils/dom_info");const{isFakeLineBreak}=require("@html_editor/utils/dom_state");const{closestElement,createDOMPathGenerator}=require("@html_editor/utils/dom_traversal");const{DIRECTIONS,childNodeIndex,endPos,leftPos,nodeSize,rightPos,startPos,}=require("@html_editor/utils/position");__exports.getCursorDirection=getCursorDirection;function getCursorDirection(anchorNode,anchorOffset,focusNode,focusOffset){if(anchorNode===focusNode){if(anchorOffset===focusOffset){return false;}
return anchorOffset<focusOffset?DIRECTIONS.RIGHT:DIRECTIONS.LEFT;}
return anchorNode.compareDocumentPosition(focusNode)&Node.DOCUMENT_POSITION_FOLLOWING?DIRECTIONS.RIGHT:DIRECTIONS.LEFT;}
__exports.findInSelection=findInSelection;function findInSelection(selection,selector){const selectorInStartAncestors=closestElement(selection.startContainer,selector);if(selectorInStartAncestors){return selectorInStartAncestors;}else{const commonElementAncestor=closestElement(selection.commonAncestorContainer);return(commonElementAncestor&&[...commonElementAncestor.querySelectorAll(selector)].find((node)=>selection.intersectsNode(node)));}}
const leftLeafOnlyInScopeNotBlockEditablePath=createDOMPathGenerator(DIRECTIONS.LEFT,{leafOnly:true,inScope:true,stopTraverseFunction:(node)=>isNotEditableNode(node)||isBlock(node),stopFunction:(node)=>isNotEditableNode(node)||isBlock(node),});const rightLeafOnlyInScopeNotBlockEditablePath=createDOMPathGenerator(DIRECTIONS.RIGHT,{leafOnly:true,inScope:true,stopTraverseFunction:(node)=>isNotEditableNode(node)||isBlock(node),stopFunction:(node)=>isNotEditableNode(node)||isBlock(node),});__exports.normalizeSelfClosingElement=normalizeSelfClosingElement;function normalizeSelfClosingElement(node,offset){if(isSelfClosingElement(node)){[node,offset]=rightPos(node);}
return[node,offset];}
__exports.normalizeNotEditableNode=normalizeNotEditableNode;function normalizeNotEditableNode(node,offset,position="right"){const editable=closestElement(node,".odoo-editor-editable");let closest=closestElement(node);while(closest&&closest!==editable&&!closest.isContentEditable){[node,offset]=position==="right"?rightPos(node):leftPos(node);closest=node;}
return[node,offset];}
__exports.normalizeCursorPosition=normalizeCursorPosition;function normalizeCursorPosition(node,offset,position="right"){[node,offset]=normalizeSelfClosingElement(node,offset);[node,offset]=normalizeNotEditableNode(node,offset,position);return[node,offset];}
__exports.normalizeFakeBR=normalizeFakeBR;function normalizeFakeBR(node,offset){const prevNode=node.nodeType===Node.ELEMENT_NODE&&node.childNodes[offset-1];if(prevNode&&prevNode.nodeName==="BR"&&isFakeLineBreak(prevNode)){offset--;}
return[node,offset];}
__exports.normalizeDeepCursorPosition=normalizeDeepCursorPosition;function normalizeDeepCursorPosition(node,offset){let el;let elOffset;if(node.nodeType===Node.ELEMENT_NODE){el=node;elOffset=offset;}else if(node.nodeType===Node.TEXT_NODE){if(offset===0){el=node.parentNode;elOffset=childNodeIndex(node);}else if(offset===node.length){el=node.parentNode;elOffset=childNodeIndex(node)+1;}}
if(el){const leftInlineNode=leftLeafOnlyInScopeNotBlockEditablePath(el,elOffset).next().value;let leftVisibleEmpty=false;if(leftInlineNode){leftVisibleEmpty=isSelfClosingElement(leftInlineNode)||!isContentEditable(leftInlineNode);[node,offset]=leftVisibleEmpty?rightPos(leftInlineNode):endPos(leftInlineNode);}
if(!leftInlineNode||leftVisibleEmpty){const rightInlineNode=rightLeafOnlyInScopeNotBlockEditablePath(el,elOffset).next().value;if(rightInlineNode){const closest=closestElement(rightInlineNode);const rightVisibleEmpty=isSelfClosingElement(rightInlineNode)||!closest||!closest.isContentEditable;if(!(leftVisibleEmpty&&rightVisibleEmpty)){[node,offset]=rightVisibleEmpty?leftPos(rightInlineNode):startPos(rightInlineNode);}}}}
return[node,offset];}
function updateCursorBeforeMove(destParent,destIndex,node,cursor){if(cursor.node===destParent&&cursor.offset>=destIndex){cursor.offset+=1;}else if(cursor.node===node.parentNode){const childIndex=childNodeIndex(node);if(cursor.offset===childIndex&&cursor.offset===0){[cursor.node,cursor.offset]=[destParent,destIndex];}else if(cursor.offset===childIndex+1&&cursor.offset===nodeSize(cursor.node)){[cursor.node,cursor.offset]=[destParent,destIndex+1];}else if(cursor.offset>childIndex){cursor.offset-=1;}}}
function updateCursorBeforeRemove(node,cursor){if(node.contains(cursor.node)){[cursor.node,cursor.offset]=[node.parentNode,childNodeIndex(node)];}else if(cursor.node===node.parentNode&&cursor.offset>childNodeIndex(node)){cursor.offset-=1;}}
function updateCursorBeforeUnwrap(node,cursor){if(cursor.node===node){[cursor.node,cursor.offset]=[node.parentNode,cursor.offset+childNodeIndex(node)];}else if(cursor.node===node.parentNode&&cursor.offset>childNodeIndex(node)){cursor.offset+=nodeSize(node)-1;}}
function updateCursorBeforeMergeIntoPreviousSibling(node,cursor){if(cursor.node===node){cursor.node=node.previousSibling;cursor.offset+=node.previousSibling.childNodes.length;}else if(cursor.node===node.parentNode){const childIndex=childNodeIndex(node);if(cursor.offset===childIndex){cursor.node=node.previousSibling;cursor.offset=node.previousSibling.childNodes.length;}else if(cursor.offset>childIndex){cursor.offset--;}}}
const callbacksForCursorUpdate=__exports.callbacksForCursorUpdate={remove:(node)=>(cursor)=>updateCursorBeforeRemove(node,cursor),before:(ref,node)=>(cursor)=>updateCursorBeforeMove(ref.parentNode,childNodeIndex(ref),node,cursor),after:(ref,node)=>(cursor)=>updateCursorBeforeMove(ref.parentNode,childNodeIndex(ref)+1,node,cursor),append:(to,node)=>(cursor)=>updateCursorBeforeMove(to,to.childNodes.length,node,cursor),prepend:(to,node)=>(cursor)=>updateCursorBeforeMove(to,0,node,cursor),unwrap:(node)=>(cursor)=>updateCursorBeforeUnwrap(node,cursor),merge:(node)=>(cursor)=>updateCursorBeforeMergeIntoPreviousSibling(node,cursor),};__exports.getAdjacentCharacter=getAdjacentCharacter;function getAdjacentCharacter(selection,side,editable){let{focusNode,focusOffset}=selection;[focusNode,focusOffset]=getDeepestPosition(focusNode,focusOffset);const originalBlock=closestBlock(focusNode);let adjacentCharacter;while(!adjacentCharacter&&focusNode){if(side==="previous"){adjacentCharacter=focusOffset>0&&focusNode.textContent[focusOffset-1];}else{adjacentCharacter=focusNode.textContent[focusOffset];}
if(!adjacentCharacter){if(side==="previous"){focusNode=previousLeaf(focusNode,editable);focusOffset=focusNode&&nodeSize(focusNode);}else{focusNode=nextLeaf(focusNode,editable);focusOffset=0;}
const characterIndex=side==="previous"?focusOffset-1:focusOffset;adjacentCharacter=focusNode&&focusNode.textContent[characterIndex];}}
if(!focusNode||!isContentEditable(focusNode)||closestBlock(focusNode)!==originalBlock){return undefined;}
return adjacentCharacter;}
return __exports;});;

/* /html_editor/static/src/utils/table.js */
odoo.define('@html_editor/utils/table',['@html_editor/utils/dom_traversal'],function(require){'use strict';let __exports={};const{closestElement}=require("@html_editor/utils/dom_traversal");__exports.getRowIndex=getRowIndex;function getRowIndex(trOrTd){const tr=closestElement(trOrTd,"tr");return tr.rowIndex;}
__exports.getColumnIndex=getColumnIndex;function getColumnIndex(td){return td.cellIndex;}
__exports.getTableCells=getTableCells;function getTableCells(table){return[...table.querySelectorAll("td, th")].filter((cell)=>closestElement(cell,"table")===table);}
return __exports;});;

/* /html_editor/static/src/utils/tracking.js */
odoo.define('@html_editor/utils/tracking',[],function(require){'use strict';let __exports={};__exports.trackOccurrences=trackOccurrences;function trackOccurrences(){const visited=new Set();return function isFirstOccurrence(key){if(visited.has(key)){return false;}
visited.add(key);return true;};}
__exports.trackOccurrencesPair=trackOccurrencesPair;function trackOccurrencesPair(){const visited=new Map();return function isFirstOccurrence(a,b){if(!visited.has(a)){visited.set(a,trackOccurrences());}
return visited.get(a)(b);};}
return __exports;});;

/* /html_editor/static/src/utils/url.js */
odoo.define('@html_editor/utils/url',['@web/core/browser/browser','@web/session'],function(require){'use strict';let __exports={};const{browser}=require("@web/core/browser/browser");const{session}=require("@web/session");const ODOO_DOMAIN_REGEX=new RegExp(`^https?://${session.db}\\.odoo\\.com(/.*)?$`);__exports.checkURL=checkURL;function checkURL(url,hostnameList){if(url){let potentialURL;try{potentialURL=new URL(url);}catch{return false;}
if(hostnameList.includes(potentialURL.hostname)){return`https://${potentialURL.hostname}${potentialURL.pathname}`;}}
return false;}
__exports.isImageUrl=isImageUrl;function isImageUrl(url){const urlFileExtention=url.split(".").pop();return["jpg","jpeg","png","gif","svg","webp"].includes(urlFileExtention.toLowerCase());}
__exports.getVideoUrl=getVideoUrl;function getVideoUrl(platform,videoId,params){let url;switch(platform){case"youtube":url=new URL(`https://www.youtube.com/embed/${videoId}`);break;case"vimeo":url=new URL(`https://player.vimeo.com/video/${videoId}`);break;case"dailymotion":url=new URL(`https://www.dailymotion.com/embed/video/${videoId}`);break;case"instagram":url=new URL(`https://www.instagram.com/p/${videoId}/embed`);break;default:throw new Error(`Unsupported platform: ${platform}`);}
url.search=new URLSearchParams(params);return url;}
__exports.isAbsoluteURLInCurrentDomain=isAbsoluteURLInCurrentDomain;function isAbsoluteURLInCurrentDomain(url,env=null){let hasProtocol;try{hasProtocol=!!new URL(url).protocol;}catch{hasProtocol=false;}
if(!hasProtocol){return false;}
const urlObj=new URL(url,window.location.origin);return(urlObj.origin===window.location.origin||ODOO_DOMAIN_REGEX.test(urlObj.origin));}
__exports.scrollAndHighlightHeading=scrollAndHighlightHeading;function scrollAndHighlightHeading(content,headingId=browser?.location?.hash?.replace?.(/^#/,"")){if(content&&headingId){setTimeout(()=>{const heading=content.querySelector(`[data-heading-link-id="${headingId}"]`);if(heading){heading.scrollIntoView({behavior:"smooth"});heading.classList.add("o-highlight-heading");setTimeout(()=>{heading.classList.remove("o-highlight-heading");},2000);}},500);}}
return __exports;});;

/* /html_editor/static/src/dropdown_autovisibility_hook.js */
odoo.define('@html_editor/dropdown_autovisibility_hook',['@odoo/owl'],function(require){'use strict';let __exports={};const{useEffect,useState}=require("@odoo/owl");__exports.useDropdownAutoVisibility=useDropdownAutoVisibility;function useDropdownAutoVisibility(overlayState,popoverRef){if(!overlayState){return;}
const state=useState(overlayState);useEffect(()=>{if(popoverRef.el){if(!state.isOverlayVisible){popoverRef.el.style.visibility="hidden";}else{popoverRef.el.style.visibility="visible";}}},()=>[state.isOverlayVisible]);}
return __exports;});;

/* /html_editor/static/src/editor.js */
odoo.define('@html_editor/editor',['@html_editor/plugin_sets','@html_editor/utils/base_container','@html_editor/utils/dom','@html_editor/utils/dom_info','@html_editor/utils/resource','@html_editor/utils/sanitize','@web/core/utils/html'],function(require){'use strict';let __exports={};const{MAIN_PLUGINS}=require("@html_editor/plugin_sets");const{createBaseContainer,SUPPORTED_BASE_CONTAINER_NAMES}=require("@html_editor/utils/base_container");const{fillShrunkPhrasingParent,removeClass}=require("@html_editor/utils/dom");const{isEmpty}=require("@html_editor/utils/dom_info");const{resourceSequenceSymbol,withSequence}=require("@html_editor/utils/resource");const{fixInvalidHTML,initElementForEdition}=require("@html_editor/utils/sanitize");const{setElementContent}=require("@web/core/utils/html");function sortPlugins(plugins){const initialPlugins=new Set(plugins);const inResult=new Set();const result=[];let P;function findPlugin(){for(const P of initialPlugins){if(P.dependencies.every((dep)=>inResult.has(dep))){initialPlugins.delete(P);return P;}}}
while((P=findPlugin())){inResult.add(P.id);result.push(P);}
if(initialPlugins.size){const messages=[];for(const P of initialPlugins){messages.push(`"${P.id}" is missing (${P.dependencies
                    .filter((d) => !inResult.has(d))
                    .join(", ")})`);}
throw new Error(`Missing dependencies:  ${messages.join(", ")}`);}
return result;}
const Editor=__exports.Editor=class Editor{constructor(config,services){this.isReady=false;this.isDestroyed=false;this.config=config;this.services=services;this.resources=null;this.plugins=[];this.editable=null;this.document=null;this.shared={};}
attachTo(editable){if(this.isDestroyed||this.editable){throw new Error("Cannot re-attach an editor");}
this.editable=editable;this.document=editable.ownerDocument;this.preparePlugins();if("content"in this.config){setElementContent(editable,fixInvalidHTML(this.config.content));if(isEmpty(editable)){const baseContainer=createBaseContainer(this.config.baseContainers[0],this.document);fillShrunkPhrasingParent(baseContainer);editable.replaceChildren(baseContainer);}}
editable.setAttribute("contenteditable",true);initElementForEdition(editable,{allowInlineAtRoot:!!this.config.allowInlineAtRoot});editable.classList.add("odoo-editor-editable");if(this.config.classList){editable.classList.add(...this.config.classList);}
if(this.config.height){editable.style.height=this.config.height;}
if(!this.config.baseContainers.every((name)=>SUPPORTED_BASE_CONTAINER_NAMES.includes(name))){throw new Error(`Invalid baseContainers: ${this.config.baseContainers.join(
                    ", "
                )}. Supported: ${SUPPORTED_BASE_CONTAINER_NAMES.join(", ")}`);}
this.startPlugins();this.isReady=true;this.config.onEditorReady?.();}
preparePlugins(){const Plugins=sortPlugins(this.config.Plugins||MAIN_PLUGINS);this.config=Object.assign({},...Plugins.map((P)=>P.defaultConfig),this.config);this.pluginsMap=new Map();for(const P of Plugins){if(P.id===""){throw new Error(`Missing plugin id (class ${P.name})`);}
if(this.pluginsMap.has(P.id)){throw new Error(`Duplicate plugin id: ${P.id}`);}
this.pluginsMap.set(P.id,P);const plugin=new P(this.getEditorContext(P.dependencies));plugin.__editor=this;this.plugins.push(plugin);const exports={};for(const h of P.shared){if(!(h in plugin)){throw new Error(`Missing helper implementation: ${h} in plugin ${P.id}`);}
exports[h]=plugin[h].bind(plugin);}
this.shared[P.id]=exports;}
const resources=this.createResources();for(const plugin of this.plugins){plugin._resources=resources;}
this.resources=resources;}
startPlugins(){for(const plugin of this.plugins){plugin.setup();}
this.resources["normalize_handlers"].forEach((cb)=>cb(this.editable));this.resources["start_edition_handlers"].forEach((cb)=>cb());}
getDependencies(dependencies){const deps={};for(const depName of dependencies){if(!(depName in this.shared)){throw new Error(`Missing dependency: ${depName}`);}
deps[depName]=this.shared[depName];}
return deps;}
createResources(){const resources={};function registerResources(obj){for(const key in obj){if(!(key in resources)){resources[key]=[];}
resources[key].push(obj[key]);}}
if(this.config.resources){registerResources(this.config.resources);}
for(const plugin of this.plugins){if(plugin.resources){registerResources(plugin.resources);}}
for(const key in resources){const resource=resources[key].flat().map((r)=>{const isObjectWithSequence=typeof r==="object"&&r!==null&&resourceSequenceSymbol in r;return isObjectWithSequence?r:withSequence(10,r);}).sort((a,b)=>a[resourceSequenceSymbol]-b[resourceSequenceSymbol]).map((r)=>r.object);resources[key]=resource;Object.freeze(resources[key]);}
return Object.freeze(resources);}
getEditorContext(dependencies=[]){return{document:this.document,editable:this.editable,dependencies:this.getDependencies(dependencies),config:this.config,services:this.services,getResource:this.getResource.bind(this),dispatchTo:this.dispatchTo.bind(this),delegateTo:this.delegateTo.bind(this),};}
getResource(resourceId){return this.resources[resourceId]||[];}
dispatchTo(resourceId,...args){this.getResource(resourceId).forEach((handler)=>handler(...args));}
delegateTo(resourceId,...args){return this.getResource(resourceId).some((fn)=>fn(...args));}
getContent(){return this.getElContent().innerHTML;}
getElContent(){const el=this.editable.cloneNode(true);this.resources["clean_for_save_handlers"].forEach((cb)=>cb({root:el}));return el;}
destroy(willBeRemoved){if(this.editable){let plugin;while((plugin=this.plugins.pop())){plugin.destroy();}
this.shared={};if(!willBeRemoved){this.editable.removeAttribute("contenteditable");removeClass(this.editable,"odoo-editor-editable");}
this.editable=null;}
this.isDestroyed=true;}}
return __exports;});;

/* /html_editor/static/src/plugin.js */
odoo.define('@html_editor/plugin',['@html_editor/utils/dom_info'],function(require){'use strict';let __exports={};const{isProtected,isProtecting,isUnprotecting}=require("@html_editor/utils/dom_info");const isValidTargetForDomListener=__exports.isValidTargetForDomListener=(target)=>!isProtecting(target)&&(!isProtected(target)||isUnprotecting(target));const Plugin=__exports.Plugin=class Plugin{static id="";static dependencies=[];static shared=[];static defaultConfig={};resources;constructor(context){this.document=context.document;this.window=context.document.defaultView;this.editable=context.editable;this.config=context.config;this.services=context.services;this.dependencies=context.dependencies;this.getResource=context.getResource;this.dispatchTo=context.dispatchTo;this.delegateTo=context.delegateTo;this._cleanups=[];this.isDestroyed=false;}
setup(){}
isValidTargetForDomListener(ev){return isValidTargetForDomListener(ev.target);}
addDomListener(target,eventName,fn,capture=false,isGlobal=false){const handler=(ev)=>{if(isGlobal||this.isValidTargetForDomListener(ev)){fn?.call(this,ev);}};target.addEventListener(eventName,handler,capture);this._cleanups.push(()=>target.removeEventListener(eventName,handler,capture));}
addGlobalDomListener(eventName,fn,capture=false){this.addDomListener(this.document,eventName,fn,capture,true);}
destroy(){for(const cleanup of this._cleanups){cleanup();}
this.isDestroyed=true;}}
return __exports;});;

/* /html_editor/static/src/plugin_sets.js */
odoo.define('@html_editor/plugin_sets',['@html_editor/core/base_container_plugin','@html_editor/core/clipboard_plugin','@html_editor/core/comment_plugin','@html_editor/core/delete_plugin','@html_editor/core/dialog_plugin','@html_editor/core/dom_plugin','@html_editor/main/separator_plugin','@html_editor/core/format_plugin','@html_editor/core/history_plugin','@html_editor/core/input_plugin','@html_editor/core/line_break_plugin','@html_editor/core/no_inline_root_plugin','@html_editor/core/overlay_plugin','@html_editor/core/protected_node_plugin','@html_editor/core/sanitize_plugin','@html_editor/core/selection_plugin','@html_editor/core/shortcut_plugin','@html_editor/core/split_plugin','@html_editor/core/user_command_plugin','@html_editor/main/align/align_plugin','@html_editor/main/banner_plugin','@html_editor/main/chatgpt/chatgpt_translate_plugin','@html_editor/main/column_plugin','@html_editor/main/emoji_plugin','@html_editor/main/font/color_plugin','@html_editor/main/font/color_ui_plugin','@html_editor/main/feff_plugin','@html_editor/main/font/font_plugin','@html_editor/main/font/font_family_plugin','@html_editor/main/hint_plugin','@html_editor/main/inline_code','@html_editor/main/link/link_paste_plugin','@html_editor/main/link/link_plugin','@html_editor/main/link/link_selection_odoo_plugin','@html_editor/main/link/link_selection_plugin','@html_editor/main/list/list_plugin','@html_editor/main/local_overlay_plugin','@html_editor/main/media/file_plugin','@html_editor/main/media/icon_plugin','@html_editor/main/media/icon_color_plugin','@html_editor/main/media/image_crop_plugin','@html_editor/main/media/image_plugin','@html_editor/main/media/image_save_plugin','@html_editor/main/media/media_plugin','@html_editor/main/movenode_plugin','@html_editor/main/power_buttons_plugin','@html_editor/main/position_plugin','@html_editor/main/powerbox/powerbox_plugin','@html_editor/main/link/powerbox_url_paste_plugin','@html_editor/main/powerbox/search_powerbox_plugin','@html_editor/main/star_plugin','@html_editor/main/table/table_align_plugin','@html_editor/main/table/table_plugin','@html_editor/main/table/table_resize_plugin','@html_editor/main/table/table_ui_plugin','@html_editor/main/tabulation_plugin','@html_editor/main/text_direction_plugin','@html_editor/main/toolbar/toolbar_plugin','@html_editor/main/media/video_plugin','@html_editor/main/youtube_plugin','@html_editor/main/placeholder_plugin','@html_editor/others/collaboration/collaboration_odoo_plugin','@html_editor/others/collaboration/collaboration_plugin','@html_editor/others/collaboration/collaboration_selection_avatar_plugin','@html_editor/others/collaboration/collaboration_selection_plugin','@html_editor/others/embedded_component_plugin','@html_editor/others/embedded_components/plugins/table_of_content_plugin/table_of_content_plugin','@html_editor/others/embedded_components/plugins/toggle_block_plugin/toggle_block_plugin','@html_editor/others/embedded_components/plugins/video_plugin/embedded_video_plugin','@html_editor/others/embedded_components/plugins/video_plugin/embedded_youtube_plugin','@html_editor/others/embedded_components/plugins/caption_plugin/caption_plugin','@html_editor/others/embedded_components/plugins/embedded_file_plugin/embedded_file_plugin','@html_editor/others/embedded_components/plugins/syntax_highlighting_plugin/syntax_highlighting_plugin','@html_editor/others/qweb_plugin','@html_editor/core/editor_version_plugin','@html_editor/main/media/image_post_process_plugin','@html_editor/main/media/dblclick_image_preview_plugin','@html_editor/core/style_plugin','@html_editor/core/content_editable_plugin','@html_editor/main/selection_placeholder_plugin'],function(require){'use strict';let __exports={};const{BaseContainerPlugin}=require("@html_editor/core/base_container_plugin");const{ClipboardPlugin}=require("@html_editor/core/clipboard_plugin");const{CommentPlugin}=require("@html_editor/core/comment_plugin");const{DeletePlugin}=require("@html_editor/core/delete_plugin");const{DialogPlugin}=require("@html_editor/core/dialog_plugin");const{DomPlugin}=require("@html_editor/core/dom_plugin");const{SeparatorPlugin}=require("@html_editor/main/separator_plugin");const{FormatPlugin}=require("@html_editor/core/format_plugin");const{HistoryPlugin}=require("@html_editor/core/history_plugin");const{InputPlugin}=require("@html_editor/core/input_plugin");const{LineBreakPlugin}=require("@html_editor/core/line_break_plugin");const{NoInlineRootPlugin}=require("@html_editor/core/no_inline_root_plugin");const{OverlayPlugin}=require("@html_editor/core/overlay_plugin");const{ProtectedNodePlugin}=require("@html_editor/core/protected_node_plugin");const{SanitizePlugin}=require("@html_editor/core/sanitize_plugin");const{SelectionPlugin}=require("@html_editor/core/selection_plugin");const{ShortCutPlugin}=require("@html_editor/core/shortcut_plugin");const{SplitPlugin}=require("@html_editor/core/split_plugin");const{UserCommandPlugin}=require("@html_editor/core/user_command_plugin");const{AlignPlugin}=require("@html_editor/main/align/align_plugin");const{BannerPlugin}=require("@html_editor/main/banner_plugin");const{ChatGPTTranslatePlugin}=require("@html_editor/main/chatgpt/chatgpt_translate_plugin");const{ColumnPlugin}=require("@html_editor/main/column_plugin");const{EmojiPlugin}=require("@html_editor/main/emoji_plugin");const{ColorPlugin}=require("@html_editor/main/font/color_plugin");const{ColorUIPlugin}=require("@html_editor/main/font/color_ui_plugin");const{FeffPlugin}=require("@html_editor/main/feff_plugin");const{FontPlugin}=require("@html_editor/main/font/font_plugin");const{FontFamilyPlugin}=require("@html_editor/main/font/font_family_plugin");const{HintPlugin}=require("@html_editor/main/hint_plugin");const{InlineCodePlugin}=require("@html_editor/main/inline_code");const{LinkPastePlugin}=require("@html_editor/main/link/link_paste_plugin");const{LinkPlugin}=require("@html_editor/main/link/link_plugin");const{OdooLinkSelectionPlugin}=require("@html_editor/main/link/link_selection_odoo_plugin");const{LinkSelectionPlugin}=require("@html_editor/main/link/link_selection_plugin");const{ListPlugin}=require("@html_editor/main/list/list_plugin");const{LocalOverlayPlugin}=require("@html_editor/main/local_overlay_plugin");const{FilePlugin}=require("@html_editor/main/media/file_plugin");const{IconPlugin}=require("@html_editor/main/media/icon_plugin");const{IconColorPlugin}=require("@html_editor/main/media/icon_color_plugin");const{ImageCropPlugin}=require("@html_editor/main/media/image_crop_plugin");const{ImagePlugin}=require("@html_editor/main/media/image_plugin");const{ImageSavePlugin}=require("@html_editor/main/media/image_save_plugin");const{MediaPlugin}=require("@html_editor/main/media/media_plugin");const{MoveNodePlugin}=require("@html_editor/main/movenode_plugin");const{PowerButtonsPlugin}=require("@html_editor/main/power_buttons_plugin");const{PositionPlugin}=require("@html_editor/main/position_plugin");const{PowerboxPlugin}=require("@html_editor/main/powerbox/powerbox_plugin");const{MediaUrlPastePlugin}=require("@html_editor/main/link/powerbox_url_paste_plugin");const{SearchPowerboxPlugin}=require("@html_editor/main/powerbox/search_powerbox_plugin");const{StarPlugin}=require("@html_editor/main/star_plugin");const{TableAlignPlugin}=require("@html_editor/main/table/table_align_plugin");const{TablePlugin}=require("@html_editor/main/table/table_plugin");const{TableResizePlugin}=require("@html_editor/main/table/table_resize_plugin");const{TableUIPlugin}=require("@html_editor/main/table/table_ui_plugin");const{TabulationPlugin}=require("@html_editor/main/tabulation_plugin");const{TextDirectionPlugin}=require("@html_editor/main/text_direction_plugin");const{ToolbarPlugin}=require("@html_editor/main/toolbar/toolbar_plugin");const{VideoPlugin}=require("@html_editor/main/media/video_plugin");const{YoutubePlugin}=require("@html_editor/main/youtube_plugin");const{PlaceholderPlugin}=require("@html_editor/main/placeholder_plugin");const{CollaborationOdooPlugin}=require("@html_editor/others/collaboration/collaboration_odoo_plugin");const{CollaborationPlugin}=require("@html_editor/others/collaboration/collaboration_plugin");const{CollaborationSelectionAvatarPlugin}=require("@html_editor/others/collaboration/collaboration_selection_avatar_plugin");const{CollaborationSelectionPlugin}=require("@html_editor/others/collaboration/collaboration_selection_plugin");const{EmbeddedComponentPlugin}=require("@html_editor/others/embedded_component_plugin");const{TableOfContentPlugin}=require("@html_editor/others/embedded_components/plugins/table_of_content_plugin/table_of_content_plugin");const{ToggleBlockPlugin}=require("@html_editor/others/embedded_components/plugins/toggle_block_plugin/toggle_block_plugin");const{EmbeddedVideoPlugin}=require("@html_editor/others/embedded_components/plugins/video_plugin/embedded_video_plugin");const{EmbeddedYoutubePlugin}=require("@html_editor/others/embedded_components/plugins/video_plugin/embedded_youtube_plugin");const{CaptionPlugin}=require("@html_editor/others/embedded_components/plugins/caption_plugin/caption_plugin");const{EmbeddedFilePlugin}=require("@html_editor/others/embedded_components/plugins/embedded_file_plugin/embedded_file_plugin");const{SyntaxHighlightingPlugin}=require("@html_editor/others/embedded_components/plugins/syntax_highlighting_plugin/syntax_highlighting_plugin");const{QWebPlugin}=require("@html_editor/others/qweb_plugin");const{EditorVersionPlugin}=require("@html_editor/core/editor_version_plugin");const{ImagePostProcessPlugin}=require("@html_editor/main/media/image_post_process_plugin");const{DoubleClickImagePreviewPlugin}=require("@html_editor/main/media/dblclick_image_preview_plugin");const{StylePlugin}=require("@html_editor/core/style_plugin");const{ContentEditablePlugin}=require("@html_editor/core/content_editable_plugin");const{SelectionPlaceholderPlugin}=require("@html_editor/main/selection_placeholder_plugin");const CORE_PLUGINS=__exports.CORE_PLUGINS=[BaseContainerPlugin,ClipboardPlugin,CommentPlugin,DeletePlugin,DialogPlugin,DomPlugin,FormatPlugin,HistoryPlugin,InputPlugin,LineBreakPlugin,NoInlineRootPlugin,OverlayPlugin,ProtectedNodePlugin,SanitizePlugin,SelectionPlugin,SplitPlugin,UserCommandPlugin,StylePlugin,ContentEditablePlugin,];const MAIN_PLUGINS=__exports.MAIN_PLUGINS=[...CORE_PLUGINS,BannerPlugin,ChatGPTTranslatePlugin,ColorPlugin,ColorUIPlugin,SeparatorPlugin,ColumnPlugin,EmojiPlugin,HintPlugin,AlignPlugin,ListPlugin,MediaPlugin,ImageSavePlugin,ShortCutPlugin,PowerboxPlugin,SearchPowerboxPlugin,MediaUrlPastePlugin,StarPlugin,TablePlugin,TableAlignPlugin,TableUIPlugin,TabulationPlugin,ToolbarPlugin,FontPlugin,FontFamilyPlugin,IconPlugin,IconColorPlugin,ImagePlugin,ImagePostProcessPlugin,ImageCropPlugin,DoubleClickImagePreviewPlugin,LinkPlugin,LinkPastePlugin,FeffPlugin,LinkSelectionPlugin,OdooLinkSelectionPlugin,PowerButtonsPlugin,MoveNodePlugin,LocalOverlayPlugin,PositionPlugin,TextDirectionPlugin,InlineCodePlugin,TableResizePlugin,PlaceholderPlugin,SelectionPlaceholderPlugin,];const COLLABORATION_PLUGINS=__exports.COLLABORATION_PLUGINS=[CollaborationPlugin,CollaborationOdooPlugin,CollaborationSelectionPlugin,CollaborationSelectionAvatarPlugin,];const EMBEDDED_COMPONENT_PLUGINS=__exports.EMBEDDED_COMPONENT_PLUGINS=[EmbeddedComponentPlugin,TableOfContentPlugin,ToggleBlockPlugin,EmbeddedVideoPlugin,EmbeddedYoutubePlugin,CaptionPlugin,EmbeddedFilePlugin,SyntaxHighlightingPlugin,];const NO_EMBEDDED_COMPONENTS_FALLBACK_PLUGINS=__exports.NO_EMBEDDED_COMPONENTS_FALLBACK_PLUGINS=[FilePlugin,VideoPlugin,YoutubePlugin];const EXTRA_PLUGINS=__exports.EXTRA_PLUGINS=[...COLLABORATION_PLUGINS,...MAIN_PLUGINS,...EMBEDDED_COMPONENT_PLUGINS,EditorVersionPlugin,QWebPlugin,];return __exports;});;

/* /html_editor/static/src/wysiwyg.js */
odoo.define('@html_editor/wysiwyg',['@odoo/owl','@html_editor/editor','@html_editor/main/toolbar/toolbar','@web/core/utils/hooks','@html_editor/local_overlay_container','@web/core/utils/functions'],function(require){'use strict';let __exports={};const{Component,onMounted,onWillDestroy,useRef,useSubEnv}=require("@odoo/owl");const{Editor}=require("@html_editor/editor");const{Toolbar}=require("@html_editor/main/toolbar/toolbar");const{useChildRef,useSpellCheck}=require("@web/core/utils/hooks");const{LocalOverlayContainer}=require("@html_editor/local_overlay_container");const{uniqueId}=require("@web/core/utils/functions");function copyCssRules(sourceDoc,targetDoc){for(const sheet of sourceDoc.styleSheets){const rules=[];for(const r of sheet.cssRules){rules.push(r.cssText);}
const cssRules=rules.join(" ");const styleTag=targetDoc.createElement("style");styleTag.appendChild(targetDoc.createTextNode(cssRules));targetDoc.head.appendChild(styleTag);}}
const Wysiwyg=__exports.Wysiwyg=class Wysiwyg extends Component{static template="html_editor.Wysiwyg";static components={Toolbar,LocalOverlayContainer};static props={config:{type:Object,optional:true},class:{type:String,optional:true},contentClass:{type:String,optional:true},style:{type:String,optional:true},iframe:{type:Boolean,optional:true},copyCss:{type:Boolean,optional:true},onLoad:{type:Function,optional:true},onBlur:{type:Function,optional:true},dynamicPlaceholder:{type:Boolean,optional:true},};static defaultProps={onLoad:()=>{},onBlur:()=>{},};setup(){this.overlayRef=useChildRef();useSubEnv({localOverlayContainerKey:uniqueId("wysiwyg"),});const contentRef=useRef("content");this.editor=this.props.editor;const config=this.getEditorConfig();this.editor=new Editor(config,this.env.services);this.props.onLoad(this.editor);useSpellCheck({refName:"content",});onMounted(()=>{const el=contentRef.el;if(el.tagName==="IFRAME"){const attachEditor=()=>{if(!this.editor.isDestroyed){if(this.props.copyCss){copyCssRules(document,el.contentDocument);}
const additionalClasses=el.dataset.class?.trim().split(" ");if(additionalClasses){for(const c of additionalClasses){el.contentDocument.body.classList.add(c);}}
this.editor.attachTo(el.contentDocument.body);}};if(el.contentDocument.readyState==="complete"){attachEditor();}else{el.addEventListener("load",()=>{attachEditor();this.render();},{once:true});}}else{this.editor.attachTo(el);}});onWillDestroy(()=>this.editor.destroy(true));}
getEditorConfig(){return{...this.props.config,localOverlayContainers:{key:this.env.localOverlayContainerKey,ref:this.overlayRef,},};}}
return __exports;});;

/* /html_editor/static/src/components/history_dialog/history_dialog.js */
odoo.define('@html_editor/components/history_dialog/history_dialog',['@web/core/dialog/dialog','@web/core/notebook/notebook','@web/core/l10n/dates','@web/core/utils/hooks','@web/core/utils/functions','@odoo/owl','@web/core/l10n/translation','@web/core/user','@html_editor/components/html_viewer/html_viewer','@html_editor/others/embedded_components/embedding_sets','@web/core/browser/browser','@web/core/browser/cookie','@web/core/assets','@web/core/utils/html'],function(require){'use strict';let __exports={};const{Dialog}=require("@web/core/dialog/dialog");const{Notebook}=require("@web/core/notebook/notebook");const{formatDateTime}=require("@web/core/l10n/dates");const{useService}=require("@web/core/utils/hooks");const{memoize}=require("@web/core/utils/functions");const{Component,onMounted,useState,markup,onWillStart,onWillDestroy}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{user}=require("@web/core/user");const{HtmlViewer}=require("@html_editor/components/html_viewer/html_viewer");const{READONLY_MAIN_EMBEDDINGS}=require("@html_editor/others/embedded_components/embedding_sets");const{browser}=require("@web/core/browser/browser");const{cookie}=require("@web/core/browser/cookie");const{loadBundle}=require("@web/core/assets");const{htmlReplaceAll}=require("@web/core/utils/html");const{DateTime}=luxon;const HistoryDialog=__exports.HistoryDialog=class HistoryDialog extends Component{static template="html_editor.HistoryDialog";static components={Dialog,HtmlViewer,Notebook};static props={recordId:Number,recordModel:String,close:Function,restoreRequested:Function,historyMetadata:Array,versionedFieldName:String,title:{String,optional:true},noContentHelper:{String,optional:true},embeddedComponents:{Array,optional:true},};DEFAULT_AVATAR="/mail/static/src/img/smiley/avatar.jpg";static defaultProps={title:_t("History"),noContentHelper:markup(""),embeddedComponents:[...READONLY_MAIN_EMBEDDINGS],};state=useState({revisionsData:[],currentView:"content",isComparisonSplit:false,revisionContent:null,revisionComparison:null,revisionId:null,revisionLoading:true,cssMaxHeight:400,});setup(){this.size="fullscreen";this.title=this.props.title;this.orm=useService("orm");this.resizeObserver=null;onWillStart(async()=>{let revisionId=-1;const revisionData=[];for(const metadata of this.props.historyMetadata){revisionData.push({...metadata,revision_id:revisionId});revisionId=metadata["revision_id"];}
const record=await this.orm.read(this.props.recordModel,[this.props.recordId],["create_date","create_uid"]);revisionData.push({revision_id:revisionId,create_date:DateTime.fromFormat(record[0]["create_date"],"yyyy-MM-dd HH:mm:ss").toISO(),create_uid:record[0]["create_uid"][0],create_user_name:record[0]["create_uid"][1],});this.state.revisionsData=revisionData;this.resizeObserver=new ResizeObserver(this.resize.bind(this));this.resizeObserver.observe(document.body);});onMounted(()=>this.init());onWillDestroy(()=>{this.resizeObserver?.disconnect();});}
resize(){const dialogContainer=document.querySelector(".html-history-dialog-container");const computedStyle=getComputedStyle(dialogContainer);this.state.cssMaxHeight=parseInt(computedStyle.height.replace("px",""))-160;}
getConfig(value){return{value:this.state[value],embeddedComponents:this.props.embeddedComponents,};}
async init(){if(this.env.debug){await loadBundle("html_editor.assets_history_diff");}
await this.updateCurrentRevision(this.state.revisionsData[0]["revision_id"]);this.resize();}
async updateCurrentRevision(revisionId){if(this.state.revisionId===revisionId){return;}
this.state.revisionLoading=true;this.state.revisionId=revisionId;this.state.revisionContent=await this.getRevisionContent(revisionId);this.state.revisionComparison=await this.getRevisionComparison(revisionId);this.state.revisionComparisonSplit=await this.getRevisionComparisonSplit(revisionId);this.state.revisionLoading=false;}
getRevisionComparison=memoize(async function getRevisionComparison(revisionId){if(revisionId===-1){return"";}
const comparison=await this.orm.call(this.props.recordModel,"html_field_history_get_comparison_at_revision",[this.props.recordId,this.props.versionedFieldName,revisionId]);return this._removeExternalBlockHtml(markup(comparison));}.bind(this));getRevisionComparisonSplit=memoize(async function getRevisionComparisonSplit(revisionId){if(!this.env.debug||revisionId===-1){return"";}
let unifiedDiffString=await this.orm.call(this.props.recordModel,"html_field_history_get_unified_diff_at_revision",[this.props.recordId,this.props.versionedFieldName,revisionId]);unifiedDiffString=unifiedDiffString.replace(/^\s*[\r\n]/gm,"");const colorScheme=cookie.get("color_scheme")==="dark"?"dark":"light";const diffHtml=Diff2Html.html(unifiedDiffString,{drawFileList:false,matching:"lines",outputFormat:"side-by-side",colorScheme:colorScheme,});return markup(diffHtml);}.bind(this));getRevisionContent=memoize(async function getRevisionContent(revisionId){if(revisionId===-1){const curentContent=await this.orm.read(this.props.recordModel,[this.props.recordId],[this.props.versionedFieldName]);if(!curentContent||!curentContent.length){return this.props.noContentHelper;}
return this._removeExternalBlockHtml(markup(curentContent[0][this.props.versionedFieldName]));}
const content=await this.orm.call(this.props.recordModel,"html_field_history_get_content_at_revision",[this.props.recordId,this.props.versionedFieldName,revisionId]);return this._removeExternalBlockHtml(markup(content));}.bind(this));async _onRestoreRevisionClick(){this.env.services.ui.block();const restoredContent=await this.getRevisionContent(this.state.revisionId);this.props.restoreRequested(restoredContent,this.props.close);this.env.services.ui.unblock();}
_removeExternalBlockHtml(baseHtml){const filteringRegex=/<[a-z ]+data-embedded="(?:(?!<).)+<\/[a-z]+>/gim;const placeholderHtml=markup`<div class="embedded-history-dialog-placeholder">${_t(
            "Dynamic element"
        )}</div>`;return htmlReplaceAll(baseHtml,filteringRegex,()=>placeholderHtml);}
getRevisionDate(revision){if(!revision||!revision["create_date"]){return"--";}
const userTZ=user.tz||"local";return formatDateTime(DateTime.fromISO(revision["create_date"],{zone:"utc"}).setZone(userTZ),{showSeconds:false});}
getRevisionClasses(revision){let classesStr="btn";if(this.state.revisionId!==-1&&(this.state.revisionId<revision.revision_id||revision.revision_id===-1)){classesStr+=" targeted";}else if(this.state.revisionId===revision.revision_id){classesStr+=" selected";}
return classesStr;}
getRevisionAuthorAvatar(revision){if(!revision||!revision["create_uid"]){return this.DEFAULT_AVATAR;}
return`${browser.location.origin}/web/image?model=res.users&field=avatar_128&id=${revision["create_uid"]}`;}
get currentRevision(){const id=this.state?.revisionId||this.state.revisionsData[0]["revision_id"];return this.state.revisionsData.find((revision)=>revision["revision_id"]===id);}}
return __exports;});;

/* /html_editor/static/src/core/base_container_plugin.js */
odoo.define('@html_editor/core/base_container_plugin',['@html_editor/utils/dom_info','@html_editor/plugin','@html_editor/utils/dom','@html_editor/utils/base_container','@html_editor/utils/resource','@html_editor/utils/dom_traversal','@html_editor/utils/position'],function(require){'use strict';let __exports={};const{containsAnyNonPhrasingContent,getDeepestPosition,isContentEditable,isElement,isEmpty,isMediaElement,isProtected,isProtecting,}=require("@html_editor/utils/dom_info");const{Plugin}=require("@html_editor/plugin");const{fillEmpty}=require("@html_editor/utils/dom");const{BASE_CONTAINER_CLASS,baseContainerGlobalSelector,createBaseContainer,}=require("@html_editor/utils/base_container");const{withSequence}=require("@html_editor/utils/resource");const{selectElements}=require("@html_editor/utils/dom_traversal");const{childNodeIndex}=require("@html_editor/utils/position");const BaseContainerPlugin=__exports.BaseContainerPlugin=class BaseContainerPlugin extends Plugin{static id="baseContainer";static shared=["createBaseContainer","getDefaultNodeName","isCandidateForBaseContainer"];static defaultConfig={baseContainers:["P","DIV"],};static dependencies=["selection"];hasNonPhrasingContentPredicate=(element)=>element?.nodeType===Node.ELEMENT_NODE&&containsAnyNonPhrasingContent(element);isUnsplittablePredicate=(element)=>this.getResource("unsplittable_node_predicates").some((fn)=>fn(element));resources={clean_for_save_handlers:this.cleanForSave.bind(this),normalize_handlers:withSequence(Infinity,this.normalizeDivBaseContainers.bind(this)),delete_handlers:()=>{if(this.config.cleanEmptyStructuralContainers===false){return;}
this.cleanEmptyStructuralContainers();},unsplittable_node_predicates:(node)=>{if(node.nodeName!=="DIV"){return false;}
return!this.isCandidateForBaseContainerAllowUnsplittable(node);},invalid_for_base_container_predicates:[(node)=>!node||node.nodeType!==Node.ELEMENT_NODE||!this.config.baseContainers.includes(node.tagName)||isProtected(node)||isProtecting(node)||isMediaElement(node),this.isUnsplittablePredicate,this.hasNonPhrasingContentPredicate,],system_classes:[BASE_CONTAINER_CLASS],};createBaseContainer(nodeName=this.getDefaultNodeName()){return createBaseContainer(nodeName,this.document);}
getDefaultNodeName(){return this.config.baseContainers[0];}
cleanEmptyStructuralContainers(){const node=this.document.getSelection().anchorNode;if(!isElement(node)||!isEmpty(node)){return;}
const closestEditable=(n)=>isContentEditable(n.parentElement)?closestEditable(n.parentElement):n;const isUnsplittable=this.isUnsplittablePredicate(node);const isCandidateForBase=this.isCandidateForBaseContainerAllowUnsplittable(node);if(isUnsplittable||!isCandidateForBase){return;}
let anchorNode=node.parentElement;if(anchorNode===closestEditable(node)||!this.config.baseContainers.includes(anchorNode.nodeName)||this.getResource("unremovable_node_predicates").some((p)=>p(anchorNode))){return;}
if(isEmpty(anchorNode)){fillEmpty(anchorNode);}
let anchorOffset=childNodeIndex(node);node.remove();[anchorNode,anchorOffset]=getDeepestPosition(anchorNode,anchorOffset);this.dependencies.selection.setSelection({anchorNode,anchorOffset,});}
isCandidateForBaseContainer(element){return!this.getResource("invalid_for_base_container_predicates").some((fn)=>fn(element));}
isCandidateForBaseContainerAllowUnsplittable(element){for(const predicate of this.getResource("invalid_for_base_container_predicates")){if(predicate===this.isUnsplittablePredicate){continue;}
if(predicate(element)){return false;}}
return true;}
shallowIsCandidateForBaseContainer(element){const predicates=this.getResource("invalid_for_base_container_predicates");for(const predicate of predicates){if(predicate===this.hasNonPhrasingContentPredicate){continue;}
if(predicate(element)){return false;}}
return true;}
cleanForSave({root}){for(const baseContainer of selectElements(root,`.${BASE_CONTAINER_CLASS}`)){baseContainer.classList.remove(BASE_CONTAINER_CLASS);if(baseContainer.classList.length===0){baseContainer.removeAttribute("class");}}}
normalizeDivBaseContainers(element=this.editable){if(this.config.baseContainers&&!this.config.baseContainers.includes("DIV")){return;}
const newBaseContainers=[];const divSelector=`div:not(.${BASE_CONTAINER_CLASS})`;const targets=[...element.querySelectorAll(divSelector)];if(element.matches(divSelector)){targets.unshift(element);}
for(const div of targets){if(!div.parentElement?.matches(baseContainerGlobalSelector)&&this.shallowIsCandidateForBaseContainer(div)&&!containsAnyNonPhrasingContent(div)){div.classList.add(BASE_CONTAINER_CLASS);newBaseContainers.push(div);fillEmpty(div);}}}}
return __exports;});;

/* /html_editor/static/src/core/clipboard_plugin.js */
odoo.define('@html_editor/core/clipboard_plugin',['@html_editor/utils/dom_info','@html_editor/plugin','@html_editor/utils/blocks','@html_editor/utils/dom','@html_editor/utils/clipboard','@html_editor/utils/dom_traversal','@html_editor/utils/html','@html_editor/utils/base_container','@html_editor/utils/position','@html_editor/core/selection_plugin'],function(require){'use strict';let __exports={};const{isTextNode,isParagraphRelatedElement,isEmptyBlock,isContentEditable,}=require("@html_editor/utils/dom_info");const{Plugin}=require("@html_editor/plugin");const{closestBlock}=require("@html_editor/utils/blocks");const{unwrapContents,wrapInlinesInBlocks,splitTextNode,fillEmpty}=require("@html_editor/utils/dom");const{fillHtmlTransferData}=require("@html_editor/utils/clipboard");const{childNodes,closestElement}=require("@html_editor/utils/dom_traversal");const{parseHTML}=require("@html_editor/utils/html");const{baseContainerGlobalSelector,getBaseContainerSelector,}=require("@html_editor/utils/base_container");const{DIRECTIONS}=require("@html_editor/utils/position");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const CLIPBOARD_BLACKLISTS={unwrap:[".Apple-interchange-newline","DIV",],remove:["META","STYLE","SCRIPT"],};const CLIPBOARD_WHITELISTS=__exports.CLIPBOARD_WHITELISTS={nodes:["P","H1","H2","H3","H4","H5","H6","BLOCKQUOTE","PRE","UL","OL","LI","I","B","U","S","EM","FONT","STRONG","TABLE","THEAD","TH","TBODY","TR","TD","IMG","BR","A",".fa",],classes:[/^float-/,"d-block","mx-auto","img-fluid","img-thumbnail","rounded","rounded-circle","o_table","table","table-bordered",/^padding-/,/^shadow/,/^text-o-/,/^bg-o-/,"o_checked","o_checklist","oe-nested",/^btn/,/^fa/,],attributes:["class","href","src","target"],styledTags:["SPAN","B","STRONG","I","S","U","FONT","TD"],};const ONLY_LINK_REGEX=/^(https?:\/\/)?([\w-]+\.)+[\w-]+(\/[\w-./?%&=]*)?$/i;const ClipboardPlugin=__exports.ClipboardPlugin=class ClipboardPlugin extends Plugin{static id="clipboard";static dependencies=["baseContainer","dom","selection","sanitize","history","split","delete","lineBreak",];static shared=["pasteText"];setup(){this.addDomListener(this.editable,"copy",this.onCopy);this.addDomListener(this.editable,"cut",this.onCut);this.addDomListener(this.editable,"paste",this.onPaste);this.addDomListener(this.editable,"dragstart",this.onDragStart);this.addDomListener(this.editable,"drop",this.onDrop);}
onCut(ev){const selection=this.dependencies.selection.getEditableSelection();this.dispatchTo("before_cut_handlers",selection);this.onCopy(ev);this.dependencies.history.stageSelection();this.dependencies.delete.deleteSelection();this.dependencies.history.addStep();}
onCopy(ev){ev.preventDefault();this.setSelectionTransferData(ev,"clipboardData");}
setSelectionTransferData(ev,transferObjectProperty){const selection=this.dependencies.selection.getEditableSelection();let clonedContents=selection.cloneContents();if(!clonedContents.hasChildNodes()){return;}
let textContent=selection.textContent();for(const processor of this.getResource("clipboard_text_processors")){textContent=processor(textContent);}
for(const processor of this.getResource("clipboard_content_processors")){clonedContents=processor(clonedContents,selection)||clonedContents;}
this.dependencies.dom.removeSystemProperties(clonedContents);fillHtmlTransferData(ev,transferObjectProperty,clonedContents,{setEditorTransferData:isContentEditable(selection.commonAncestorContainer)||this.dependencies.selection.isNodeEditable(selection.commonAncestorContainer),textContent,});}
onPaste(ev){let selection=this.dependencies.selection.getEditableSelection();if(!selection.anchorNode.isConnected||!closestElement(selection.anchorNode).isContentEditable){return;}
ev.preventDefault();this.dependencies.history.stageSelection();this.dispatchTo("before_paste_handlers",selection,ev);selection=this.dependencies.selection.getEditableSelection();this.handlePasteUnsupportedHtml(selection,ev.clipboardData)||this.handlePasteOdooEditorHtml(ev.clipboardData)||this.handlePasteHtml(selection,ev.clipboardData)||this.handlePasteText(selection,ev.clipboardData);this.dispatchTo("after_paste_handlers",selection);this.dependencies.history.addStep();}
handlePasteUnsupportedHtml(selection,clipboardData){if(!isHtmlContentSupported(selection)){const text=clipboardData.getData("text/plain");this.dependencies.dom.insert(text);return true;}}
handlePasteOdooEditorHtml(clipboardData){const odooEditorHtml=clipboardData.getData("application/vnd.odoo.odoo-editor");const textContent=clipboardData.getData("text/plain");if(ONLY_LINK_REGEX.test(textContent)){return false;}
if(odooEditorHtml){const fragment=parseHTML(this.document,odooEditorHtml);this.dependencies.sanitize.sanitize(fragment);if(fragment.hasChildNodes()){this.dependencies.dom.insert(fragment);}
return true;}}
handlePasteHtml(selection,clipboardData){const files=this.delegateTo("bypass_paste_image_files")?[]:getImageFiles(clipboardData);const clipboardHtml=clipboardData.getData("text/html");const textContent=clipboardData.getData("text/plain");if(ONLY_LINK_REGEX.test(textContent)){return false;}
if(files.length||clipboardHtml){const clipboardElem=this.prepareClipboardData(clipboardHtml);if(files.length&&!clipboardElem.querySelector("table")){return this.addImagesFiles(files).then((html)=>{this.dependencies.dom.insert(html);this.dependencies.history.addStep();});}else if(clipboardElem.hasChildNodes()){if(closestElement(selection.anchorNode,"a")){this.dependencies.dom.insert(clipboardElem.textContent);}else{this.dependencies.dom.insert(clipboardElem);}}
return true;}}
handlePasteText(selection,clipboardData){const text=clipboardData.getData("text/plain");if(this.delegateTo("paste_text_overrides",selection,text)){return;}else{this.pasteText(text);}}
pasteText(text){const textFragments=text.split(/\r?\n/);let selection=this.dependencies.selection.getEditableSelection();const preEl=closestElement(selection.anchorNode,"PRE");let textIndex=1;for(const textFragment of textFragments){let modifiedTextFragment=textFragment;if(!preEl){modifiedTextFragment=textFragment.replace(/( {2,})/g,(match)=>{let alternateValue=false;return match.replace(/ /g,()=>{alternateValue=!alternateValue;const replaceContent=alternateValue?"\u00A0":" ";return replaceContent;});});}
this.dependencies.dom.insert(modifiedTextFragment);if(textIndex<textFragments.length){selection=this.dependencies.selection.getEditableSelection();const block=closestBlock(selection.anchorNode);if(this.dependencies.split.isUnsplittable(block)||closestElement(selection.anchorNode).tagName==="PRE"){this.dependencies.lineBreak.insertLineBreak();}else{const[blockBefore]=this.dependencies.split.splitBlock();if(block&&block.matches(baseContainerGlobalSelector)&&blockBefore&&!blockBefore.matches(getBaseContainerSelector("DIV"))){const div=this.dependencies.baseContainer.createBaseContainer("DIV");const cursors=this.dependencies.selection.preserveSelection();blockBefore.before(div);div.replaceChildren(...childNodes(blockBefore));blockBefore.remove();cursors.remapNode(blockBefore,div).restore();}}}
textIndex++;}}
prepareClipboardData(clipboardData){const fragment=parseHTML(this.document,clipboardData);this.dependencies.sanitize.sanitize(fragment);const container=this.document.createElement("fake-container");container.append(fragment);for(const tableElement of container.querySelectorAll("table")){tableElement.classList.add("table","table-bordered","o_table");}
if(this.delegateTo("bypass_paste_image_files")){for(const imgElement of container.querySelectorAll("img")){imgElement.remove();}}
const progId=container.querySelector('meta[name="ProgId"]');if(progId&&progId.content==="Excel.Sheet"){const xlStylesheet=container.querySelector("style");const xlNodes=container.querySelectorAll("[class*=xl],[class*=font]");for(const xlNode of xlNodes){for(const xlClass of xlNode.classList){const xlStyle=xlStylesheet.textContent.match(`.${xlClass}[^{]*{(?<xlStyle>[^}]*)}`).groups.xlStyle.replace("background:","background-color:");xlNode.setAttribute("style",xlNode.style.cssText+";"+xlStyle);}}}
const childContent=childNodes(container);for(const child of childContent){this.cleanForPaste(child);}
const selection=this.dependencies.selection.getEditableSelection();const closestBaseContainer=selection.anchorNode&&closestElement(selection.anchorNode,baseContainerGlobalSelector);wrapInlinesInBlocks(container,{baseContainerNodeName:closestBaseContainer?.nodeName||this.dependencies.baseContainer.getDefaultNodeName(),});const result=this.document.createDocumentFragment();result.replaceChildren(...childNodes(container));const brs=result.querySelectorAll("br");for(const br of brs){const block=closestBlock(br);if((isParagraphRelatedElement(block)||this.dependencies.baseContainer.isCandidateForBaseContainer(block))&&block.nodeName!=="PRE"){const isEmptyLine=block.firstChild.nodeName==="BR";const remainingBrContainer=this.dependencies.split.splitAroundUntil(br,block);if(!isEmptyLine){remainingBrContainer.remove();}}}
return result;}
cleanForPaste(node){if(!this.isWhitelisted(node)||this.isBlacklisted(node)||(node.id&&node.id.startsWith("docs-internal-guid"))){if(!node.matches||node.matches(CLIPBOARD_BLACKLISTS.remove.join(","))){node.remove();}else{let childrenNodes;if(node.nodeName==="DIV"){if(!node.hasChildNodes()){node.remove();return;}else if(this.dependencies.baseContainer.isCandidateForBaseContainer(node)){const whiteSpace=node.style?.whiteSpace;if(whiteSpace&&!["normal","nowrap"].includes(whiteSpace)){node.innerHTML=node.innerHTML.replace(/\n/g,"<br>");}
const baseContainer=this.dependencies.baseContainer.createBaseContainer();const dir=node.getAttribute("dir");if(dir){baseContainer.setAttribute("dir",dir);}
baseContainer.append(...node.childNodes);node.replaceWith(baseContainer);childrenNodes=childNodes(baseContainer);}else{childrenNodes=unwrapContents(node);}}else{childrenNodes=unwrapContents(node);}
for(const child of childrenNodes){this.cleanForPaste(child);}}}else if(node.nodeType!==Node.TEXT_NODE){if(node.nodeName==="THEAD"){const tbody=node.nextElementSibling;if(tbody){tbody.prepend(...node.children);node.remove();node=tbody;}else{node=this.dependencies.dom.setTagName(node,"TBODY");}}else if(["TD","TH"].includes(node.nodeName)){if(isEmptyBlock(node)){const baseContainer=this.dependencies.baseContainer.createBaseContainer();fillEmpty(baseContainer);node.replaceChildren(baseContainer);}
if(node.hasAttribute("bgcolor")&&!node.style["background-color"]){node.style["background-color"]=node.getAttribute("bgcolor");}}else if(node.nodeName==="FONT"){if(node.hasAttribute("color")&&!node.style["color"]){node.style["color"]=node.getAttribute("color");}
if(node.hasAttribute("size")&&!node.style["font-size"]){node.style["font-size"]=+node.getAttribute("size")+10+"pt";}}else if(["S","U"].includes(node.nodeName)&&childNodes(node).length===1&&node.firstChild.nodeName==="FONT"){const fontNode=node.firstChild;node.before(fontNode);node.replaceChildren(...childNodes(fontNode));fontNode.appendChild(node);}else if(node.nodeName==="IMG"&&node.getAttribute("aria-roledescription")==="checkbox"){const checklist=node.closest("ul");const closestLi=node.closest("li");if(checklist){checklist.classList.add("o_checklist");if(node.getAttribute("alt")==="checked"){closestLi.classList.add("o_checked");}
node.remove();node=checklist;}}
for(const attribute of[...node.attributes]){if(CLIPBOARD_WHITELISTS.styledTags.includes(node.nodeName)&&attribute.name==="style"){node.removeAttribute(attribute.name);if(["SPAN","FONT"].includes(node.tagName)){for(const unwrappedNode of unwrapContents(node)){this.cleanForPaste(unwrappedNode);}}}else if(!this.isWhitelisted(attribute)){node.removeAttribute(attribute.name);}}
for(const klass of[...node.classList]){if(!this.isWhitelisted(klass)){node.classList.remove(klass);}}
for(const child of childNodes(node)){this.cleanForPaste(child);}}}
isWhitelisted(item){if(item.nodeType===Node.ATTRIBUTE_NODE){return CLIPBOARD_WHITELISTS.attributes.includes(item.name);}else if(typeof item==="string"){return CLIPBOARD_WHITELISTS.classes.some((okClass)=>okClass instanceof RegExp?okClass.test(item):okClass===item);}else{return isTextNode(item)||item.matches?.(CLIPBOARD_WHITELISTS.nodes.join(","));}}
isBlacklisted(node){return(!isTextNode(node)&&node.matches([].concat(...Object.values(CLIPBOARD_BLACKLISTS)).join(",")));}
onDragStart(ev){const selection=this.dependencies.selection.getEditableSelection();this.dispatchTo("before_drag_handlers",selection);this.setSelectionTransferData(ev,"dataTransfer");}
async onDrop(ev){ev.preventDefault();const selection=this.dependencies.selection.getEditableSelection();if(!isHtmlContentSupported(selection)){return;}
const nodeToSplit=selection.direction===DIRECTIONS.RIGHT?selection.focusNode:selection.anchorNode;const offsetToSplit=selection.direction===DIRECTIONS.RIGHT?selection.focusOffset:selection.anchorOffset;if(nodeToSplit.nodeType===Node.TEXT_NODE&&!selection.isCollapsed){const selectionToRestore=this.dependencies.selection.preserveSelection();splitTextNode(nodeToSplit,offsetToSplit,DIRECTIONS.LEFT);selectionToRestore.restore();}
const dataTransfer=(ev.originalEvent||ev).dataTransfer;const odooEditorHtml=ev.dataTransfer.getData("application/vnd.odoo.odoo-editor");const fileTransferItems=!odooEditorHtml&&getImageFiles(dataTransfer);const htmlTransferItem=[...dataTransfer.items].find((item)=>item.type==="text/html");if(fileTransferItems.length||htmlTransferItem||odooEditorHtml){const deleteAndSetSelection=(offsetNode,offset)=>{if(offsetNode.nodeType===Node.ELEMENT_NODE&&offset>1){const initialLength=offsetNode.childNodes.length;this.dependencies.delete.deleteSelection();const removedCount=initialLength-offsetNode.childNodes.length;offset-=removedCount;}else{this.dependencies.delete.deleteSelection();}
this.dependencies.selection.setSelection({anchorNode:offsetNode,anchorOffset:offset,});};if(this.document.caretPositionFromPoint){const range=this.document.caretPositionFromPoint(ev.clientX,ev.clientY);deleteAndSetSelection(range.offsetNode,range.offset);}else if(this.document.caretRangeFromPoint){const range=this.document.caretRangeFromPoint(ev.clientX,ev.clientY);deleteAndSetSelection(range.startContainer,range.startOffset);}}
if(odooEditorHtml){const fragment=parseHTML(this.document,odooEditorHtml);this.dependencies.sanitize.sanitize(fragment);if(fragment.hasChildNodes()){this.dependencies.dom.insert(fragment);this.dependencies.history.addStep();}}else if(fileTransferItems.length){const html=await this.addImagesFiles(fileTransferItems);this.dependencies.dom.insert(html);this.dependencies.history.addStep();}else if(htmlTransferItem){htmlTransferItem.getAsString((pastedText)=>{this.dependencies.dom.insert(this.prepareClipboardData(pastedText));this.dependencies.history.addStep();});}}
async addImagesFiles(imageFiles){const promises=[];for(const imageFile of imageFiles){const imageNode=this.document.createElement("img");imageNode.classList.add("img-fluid");this.dispatchTo("added_image_handlers",imageNode);imageNode.dataset.fileName=imageFile.name;promises.push(getImageUrl(imageFile).then((url)=>{imageNode.src=url;return imageNode;}));}
const nodes=await Promise.all(promises);const fragment=this.document.createDocumentFragment();fragment.append(...nodes);return fragment;}}
function getImageFiles(dataTransfer){return[...dataTransfer.items].filter((item)=>item.kind==="file"&&item.type.includes("image/")).map((item)=>item.getAsFile());}
function getImageUrl(file){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.readAsDataURL(file);reader.onloadend=(e)=>{if(reader.error){return reject(reader.error);}
resolve(e.target.result);};});}
return __exports;});;

/* /html_editor/static/src/core/comment_plugin.js */
odoo.define('@html_editor/core/comment_plugin',['@html_editor/utils/dom_info','@html_editor/plugin','@html_editor/utils/dom_traversal'],function(require){'use strict';let __exports={};const{isProtected}=require("@html_editor/utils/dom_info");const{Plugin}=require("@html_editor/plugin");const{descendants}=require("@html_editor/utils/dom_traversal");const CommentPlugin=__exports.CommentPlugin=class CommentPlugin extends Plugin{static id="comment";resources={normalize_handlers:this.removeComment.bind(this),};removeComment(node){for(const el of[node,...descendants(node)]){if(el.nodeType===Node.COMMENT_NODE&&!isProtected(el)){el.remove();}}}}
return __exports;});;

/* /html_editor/static/src/core/content_editable_plugin.js */
odoo.define('@html_editor/core/content_editable_plugin',['@html_editor/core/selection_plugin','@html_editor/plugin','@html_editor/utils/dom_traversal','@html_editor/utils/resource'],function(require){'use strict';let __exports={};const{isArtificialVoidElement}=require("@html_editor/core/selection_plugin");const{Plugin}=require("@html_editor/plugin");const{selectElements}=require("@html_editor/utils/dom_traversal");const{withSequence}=require("@html_editor/utils/resource");const ContentEditablePlugin=__exports.ContentEditablePlugin=class ContentEditablePlugin extends Plugin{static id="contentEditablePlugin";resources={normalize_handlers:withSequence(5,this.normalize.bind(this)),clean_for_save_handlers:withSequence(Infinity,this.cleanForSave.bind(this)),};normalize(root){const contentNotEditableEls=[];for(const fn of this.getResource("content_not_editable_providers")){contentNotEditableEls.push(...fn(root));}
for(const contentNotEditableEl of contentNotEditableEls){contentNotEditableEl.setAttribute("contenteditable","false");}
const contentEditableEls=[];for(const fn of this.getResource("content_editable_providers")){contentEditableEls.push(...fn(root));}
const filteredContentEditableEls=contentEditableEls.filter((contentEditableEl)=>this.getResource("valid_contenteditable_predicates").every((p)=>p(contentEditableEl)));for(const contentEditableEl of filteredContentEditableEls){if(!contentEditableEl.isContentEditable){if(isArtificialVoidElement(contentEditableEl)||contentEditableEl.nodeName==="IMG"){contentEditableEl.classList.add("o_editable_media");continue;}
if(!contentNotEditableEls.includes(contentEditableEl)){contentEditableEl.setAttribute("contenteditable",true);}}}}
cleanForSave({root}){const toRemoveSelector=this.getResource("contenteditable_to_remove_selector").join(",");const contenteditableEls=toRemoveSelector?[...selectElements(root,toRemoveSelector)]:[];for(const contenteditableEl of contenteditableEls){contenteditableEl.removeAttribute("contenteditable");}}}
return __exports;});;

/* /html_editor/static/src/core/delete_plugin.js */
odoo.define('@html_editor/core/delete_plugin',['@html_editor/plugin','@html_editor/utils/blocks','@html_editor/utils/dom_info','@html_editor/utils/dom_state','@html_editor/utils/dom_traversal','@html_editor/utils/position','@html_editor/utils/content_types','@html_editor/utils/resource','@html_editor/main/list/utils','@web/core/browser/feature_detection','@html_editor/utils/selection'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{closestBlock,isBlock}=require("@html_editor/utils/blocks");const{isAllowedContent,isButton,isContentEditable,isEmpty,isInPre,isProtected,isShrunkBlock,isTangible,isTextNode,isVisibleTextNode,isWhitespace,isZwnbsp,isZWS,nextLeaf,previousLeaf,isEmptyBlock,}=require("@html_editor/utils/dom_info");const{getState,isFakeLineBreak,observeMutations,prepareUpdate}=require("@html_editor/utils/dom_state");const{childNodes,closestElement,findUpTo,descendants,firstLeaf,getCommonAncestor,lastLeaf,findFurthest,}=require("@html_editor/utils/dom_traversal");const{DIRECTIONS,childNodeIndex,endPos,leftPos,nodeSize,rightPos,startPos,}=require("@html_editor/utils/position");const{CTYPES}=require("@html_editor/utils/content_types");const{withSequence}=require("@html_editor/utils/resource");const{compareListTypes}=require("@html_editor/main/list/utils");const{hasTouch,isBrowserChrome,isMacOS}=require("@web/core/browser/feature_detection");const{normalizeDeepCursorPosition,normalizeFakeBR}=require("@html_editor/utils/selection");const unremovableNodePredicates=__exports.unremovableNodePredicates=[(node)=>node.classList?.contains("oe_unremovable"),(node)=>node.matches?.("[data-oe-type='monetary'] > span"),];const DeletePlugin=__exports.DeletePlugin=class DeletePlugin extends Plugin{static dependencies=["baseContainer","selection","history","input","userCommand"];static id="delete";static shared=["deleteBackward","deleteForward","deleteRange","deleteSelection","delete"];resources={user_commands:[{id:"deleteBackward",run:()=>this.delete("backward","character")},{id:"deleteForward",run:()=>this.delete("forward","character")},{id:"deleteBackwardWord",run:()=>this.delete("backward","word")},{id:"deleteForwardWord",run:()=>this.delete("forward","word")},{id:"deleteBackwardLine",run:()=>this.delete("backward","line")},{id:"deleteForwardLine",run:()=>this.delete("forward","line")},],shortcuts:[{hotkey:"backspace",commandId:"deleteBackward"},{hotkey:"delete",commandId:"deleteForward"},{hotkey:"control+backspace",commandId:"deleteBackwardWord"},{hotkey:"control+delete",commandId:"deleteForwardWord"},{hotkey:"control+shift+backspace",commandId:"deleteBackwardLine"},{hotkey:"control+shift+delete",commandId:"deleteForwardLine"},],beforeinput_handlers:[withSequence(5,this.onBeforeInputInsertText.bind(this)),this.onBeforeInputDelete.bind(this),],input_handlers:(ev)=>this.onAndroidChromeInput?.(ev),selectionchange_handlers:withSequence(5,()=>this.onAndroidChromeSelectionChange?.()),delete_backward_overrides:withSequence(30,this.deleteBackwardUnmergeable.bind(this)),delete_backward_word_overrides:withSequence(20,this.deleteBackwardUnmergeable.bind(this)),delete_backward_line_overrides:this.deleteBackwardUnmergeable.bind(this),delete_forward_overrides:withSequence(20,this.deleteForwardUnmergeable.bind(this)),delete_forward_word_overrides:this.deleteForwardUnmergeable.bind(this),delete_forward_line_overrides:this.deleteForwardUnmergeable.bind(this),unremovable_node_predicates:unremovableNodePredicates,invalid_for_base_container_predicates:(node)=>this.isUnremovable(node,this.editable),};setup(){this.findPreviousPosition=this.makeFindPositionFn("backward");this.findNextPosition=this.makeFindPositionFn("forward");if(isMacOS()){this.addDomListener(this.editable,"keydown",(event)=>{const runCommand=(commandId)=>{this.dependencies.userCommand.getCommand(commandId).run();event.stopImmediatePropagation();event.preventDefault();};if(event.altKey&&event.key==="Backspace"){return runCommand("deleteBackwardWord");}
if(event.altKey&&event.key==="Delete"){return runCommand("deleteForwardWord");}
if(event.metaKey&&event.key==="Backspace"){return runCommand("deleteBackwardLine");}
if(event.metaKey&&event.key==="Delete"){return runCommand("deleteForwardLine");}});}}
getNormalizedRange(selection){let{startContainer,startOffset,endContainer,endOffset,isCollapsed}=selection;for(const normalizer of[normalizeDeepCursorPosition,normalizeFakeBR]){[startContainer,startOffset]=normalizer(startContainer,startOffset);[endContainer,endOffset]=isCollapsed?[startContainer,startOffset]:normalizer(endContainer,endOffset);}
const range=this.document.createRange();range.setStart(startContainer,startOffset);range.setEnd(endContainer,endOffset);return range;}
deleteSelection(selection=this.dependencies.selection.getEditableSelection()){let range=this.getNormalizedRange(selection);if(range.collapsed){return;}
const selectedNodes=this.dependencies.selection.getTargetedNodes();const canBeDeleted=(node)=>this.dependencies.selection.isNodeEditable(node)||selectedNodes.includes(closestElement(node,(node)=>this.dependencies.selection.isNodeEditable(node)));if(selectedNodes.some((node)=>!canBeDeleted(node))){return;}
range=this.adjustRange(range,[this.expandRangeToIncludeNonEditables,this.includeEndOrStartBlock,this.fullyIncludeLinks,]);if(this.delegateTo("delete_range_overrides",range)){return;}
range=this.deleteRange(range);this.setCursorFromRange(range);}
delete(direction,granularity){const selection=this.dependencies.selection.getEditableSelection();this.dispatchTo("before_delete_handlers");if(!selection.isCollapsed){this.deleteSelection(selection);}else if(direction==="backward"){this.deleteBackward(selection,granularity);}else if(direction==="forward"){this.deleteForward(selection,granularity);}else{throw new Error("Invalid direction");}
this.dispatchTo("delete_handlers");this.dependencies.history.addStep();}
deleteBackward(selection,granularity){const{endContainer,endOffset}=this.getNormalizedRange(selection);if(!closestElement(endContainer).isContentEditable){return;}
let range=this.getRangeForDelete(endContainer,endOffset,"backward",granularity);const resourceIds={character:"delete_backward_overrides",word:"delete_backward_word_overrides",line:"delete_backward_line_overrides",};if(this.delegateTo(resourceIds[granularity],range)){return;}
range=this.adjustRange(range,[this.includeEmptyInlineEnd,this.includePreviousZWS,this.includeEndOrStartBlock,]);range=this.deleteRange(range);this.document.getSelection()?.removeAllRanges();this.setCursorFromRange(range,{collapseToEnd:true});}
deleteForward(selection,granularity){const{startContainer,startOffset}=this.getNormalizedRange(selection);if(!closestElement(startContainer).isContentEditable){return;}
let range=this.getRangeForDelete(startContainer,startOffset,"forward",granularity);const resourceIds={character:"delete_forward_overrides",word:"delete_forward_word_overrides",line:"delete_forward_line_overrides",};if(this.delegateTo(resourceIds[granularity],range)){return;}
range=this.adjustRange(range,[this.includeEmptyInlineStart,this.includeNextZWS,this.includeEndOrStartBlock,]);range=this.deleteRange(range);this.setCursorFromRange(range);}
getRangeForDelete(node,offset,direction,granularity){let destContainer,destOffset;if(granularity==="word"){const blockEl=closestBlock(node);if((direction==="backward"&&this.isCursorAtStartOfElement(blockEl,node,offset))||(direction==="forward"&&this.isCursorAtEndOfElement(blockEl,node,offset))){granularity="character";}}
switch(granularity){case"character":[destContainer,destOffset]=this.findAdjacentPosition(node,offset,direction);break;case"word":({focusNode:destContainer,focusOffset:destOffset}=this.dependencies.selection.modifySelection("extend",direction,"word"));break;case"line":[destContainer,destOffset]=this.findLineBoundary(node,offset,direction);break;default:throw new Error("Invalid granularity");}
if(!destContainer){[destContainer,destOffset]=[node,offset];}
const[startContainer,startOffset,endContainer,endOffset]=direction==="forward"?[node,offset,destContainer,destOffset]:[destContainer,destOffset,node,offset];return{startContainer,startOffset,endContainer,endOffset};}
deleteRange(range){if(range.startContainer===range.endContainer&&range.startOffset===range.endOffset){return range;}
range=this.splitTextNodes(range);const{startContainer,startOffset,endContainer,endOffset}=range;const restoreSpaces=prepareUpdate(startContainer,startOffset,endContainer,endOffset);let restoreFakeBRs;({restoreFakeBRs,range}=this.removeFakeBRs(range));let allNodesRemoved;({allNodesRemoved,range}=this.removeNodes(range));this.fillEmptyInlines(range);const originalCommonAncestor=range.commonAncestorContainer;if(allNodesRemoved){range=this.joinFragments(range);}
restoreFakeBRs();this.fillShrunkBlocks(originalCommonAncestor);restoreSpaces();return range;}
splitTextNodes({startContainer,startOffset,endContainer,endOffset}){const split=(textNode,offset)=>{let didSplit=false;if(offset===0){offset=childNodeIndex(textNode);}else if(offset===nodeSize(textNode)){offset=childNodeIndex(textNode)+1;}else{textNode.splitText(offset);didSplit=true;offset=childNodeIndex(textNode)+1;}
return[textNode.parentElement,offset,didSplit];};if(endContainer.nodeType===Node.TEXT_NODE){[endContainer,endOffset]=split(endContainer,endOffset);}
if(startContainer.nodeType===Node.TEXT_NODE){let didSplit;[startContainer,startOffset,didSplit]=split(startContainer,startOffset);if(startContainer===endContainer&&didSplit){endOffset+=1;}}
return{startContainer,startOffset,endContainer,endOffset,commonAncestorContainer:getCommonAncestor([startContainer,endContainer],this.editable),};}
removeFakeBRs(range){let{startContainer,startOffset,endContainer,endOffset,commonAncestorContainer}=range;const visitedNodes=new Set();const removeBRs=(container,offset)=>{let node=container;while(node!==commonAncestorContainer){const lastBR=childNodes(node).findLast((child)=>child.nodeName==="BR");if(lastBR&&isFakeLineBreak(lastBR)){if(lastBR===container){[container,offset]=leftPos(lastBR);}else if(node===container&&offset>childNodeIndex(lastBR)){offset-=1;}
lastBR.remove();}
visitedNodes.add(node);node=node.parentNode;}
return[container,offset];};[startContainer,startOffset]=removeBRs(startContainer,startOffset);[endContainer,endOffset]=removeBRs(endContainer,endOffset);range={startContainer,startOffset,endContainer,endOffset,commonAncestorContainer};const restoreFakeBRs=()=>{for(const node of visitedNodes){if(!node.isConnected){continue;}
const lastBR=childNodes(node).findLast((child)=>child.nodeName==="BR");if(lastBR&&isFakeLineBreak(lastBR)){lastBR.after(this.document.createElement("br"));}}};return{restoreFakeBRs,range};}
fillEmptyInlines(range){const nodes=[range.startContainer];if(range.endContainer!==range.startContainer){nodes.push(range.endContainer);}
for(const node of nodes){if(!isBlock(node)&&!isTangible(node)&&!isZWS(node)&&!isZwnbsp(node)){node.appendChild(this.document.createTextNode("\u200B"));node.setAttribute("data-oe-zws-empty-inline","");}}}
fillShrunkBlocks(commonAncestor){const fillBlock=(block)=>{if(block.matches("div[contenteditable='true']")&&!block.parentElement.isContentEditable){const baseContainer=this.dependencies.baseContainer.createBaseContainer();baseContainer.appendChild(this.document.createElement("br"));block.appendChild(baseContainer);}else{block.appendChild(this.document.createElement("br"));}};for(const node of descendants(commonAncestor).reverse()){if(isBlock(node)&&isShrunkBlock(node)){fillBlock(node);}}
const containingBlock=closestBlock(commonAncestor);if(isShrunkBlock(containingBlock)){fillBlock(containingBlock);}}
removeNodes(range){const{startContainer,startOffset,endContainer,commonAncestorContainer}=range;let{endOffset}=range;const nodesToRemove=[];let node=startContainer;let startRemoveIndex=startOffset;while(node!==commonAncestorContainer){for(let i=startRemoveIndex;i<node.childNodes.length;i++){nodesToRemove.push(node.childNodes[i]);}
startRemoveIndex=childNodeIndex(node)+1;node=node.parentElement;}
node=endContainer;let endRemoveIndex=endOffset;while(node!==commonAncestorContainer){for(let i=0;i<endRemoveIndex;i++){nodesToRemove.push(node.childNodes[i]);}
endRemoveIndex=childNodeIndex(node);node=node.parentElement;}
for(let i=startRemoveIndex;i<endRemoveIndex;i++){nodesToRemove.push(commonAncestorContainer.childNodes[i]);}
let allNodesRemoved=true;for(const node of nodesToRemove){const parent=node.parentNode;const didRemove=this.removeNode(node);allNodesRemoved&&=didRemove;if(didRemove&&endContainer===parent){endOffset-=1;}}
const endContainerList=closestElement(endContainer,"UL, OL");if(["OL","UL"].includes(startContainer.nodeName)&&endContainerList&&!compareListTypes(startContainer,endContainerList)){const newRange=this.document.createRange();newRange.setStart(range.endContainer,endOffset);return{allNodesRemoved,range:newRange};}
return{allNodesRemoved,range:{...range,endOffset}};}
isUnremovable(node,root=undefined){return this.getResource("unremovable_node_predicates").some((p)=>p(node,root));}
removeNode(node){const root=node;const remove=(node)=>{let customHandling=false;let customIsUnremovable;for(const cb of this.getResource("removable_descendants_providers")){const descendantsToRemove=cb(node);if(descendantsToRemove){for(const descendant of descendantsToRemove){remove(descendant);}
customHandling=true;customIsUnremovable=this.isUnremovable(node,root);if(!customIsUnremovable){node.remove();}}}
if(customHandling){return!customIsUnremovable;}
for(const child of[...node.childNodes]){remove(child);}
if(this.isUnremovable(node,root)){return false;}
if(node.hasChildNodes()){node.before(...node.childNodes);node.remove();return false;}
node.remove();return true;};return remove(node);}
joinFragments(range){const joinableLeft=this.getJoinableFragment(range,"start");const joinableRight=this.getJoinableFragment(range,"end");const join=this.getJoinOperation(joinableLeft.type,joinableRight.type);const didJoin=join(joinableLeft.node,joinableRight.node,range.commonAncestorContainer);return didJoin?this.collapseRange(range):range;}
getJoinableFragment(range,side){const commonAncestor=range.commonAncestorContainer;const container=side==="start"?range.startContainer:range.endContainer;const offset=side==="start"?range.startOffset:range.endOffset;if(container===range.commonAncestorContainer){const sibling=childNodes(commonAncestor)[side==="start"?offset-1:offset];if(sibling&&!isBlock(sibling)&&!(sibling.nodeType===Node.TEXT_NODE&&!isVisibleTextNode(sibling))){return{node:sibling,type:"inline"};}
return{node:null,type:"null"};}
let last;let element=container;while(element!==commonAncestor){if(isBlock(element)){return{node:element,type:"block"};}
last=element;element=element.parentElement;}
return{node:last,type:"inline"};}
getJoinOperation(leftType,rightType){return({"block + block":this.joinBlocks,"block + inline":this.joinInlineIntoBlock,"inline + block":this.joinBlockIntoInline,}[leftType+" + "+rightType]||(()=>true)).bind(this);}
isUnmergeable(node){return this.getResource("unsplittable_node_predicates").some((p)=>p(node));}
joinBlocks(left,right,commonAncestor){const canMerge=(n)=>!findUpTo(n,commonAncestor,this.isUnmergeable.bind(this));if(!canMerge(left)||!canMerge(right)){return false;}
const rightChildNodes=childNodes(right);if(!isAllowedContent(left,rightChildNodes)){return false;}
left.append(...rightChildNodes);let toRemove=right;let parent=right.parentElement;while(parent!==commonAncestor&&parent.childNodes.length===1){toRemove=parent;parent=parent.parentElement;}
toRemove.remove();return true;}
joinInlineIntoBlock(leftBlock,rightInline,commonAncestor){if(findUpTo(leftBlock,commonAncestor,(node)=>this.isUnmergeable(node))){return false;}
while(rightInline&&!isBlock(rightInline)){const toAppend=rightInline;rightInline=rightInline.nextSibling;leftBlock.append(toAppend);}
return true;}
joinBlockIntoInline(leftInline,rightBlock,commonAncestor){if(findUpTo(rightBlock,commonAncestor,(node)=>this.isUnmergeable(node))){return false;}
leftInline.after(...childNodes(rightBlock));let toRemove=rightBlock;let parent=rightBlock.parentElement;while(parent!==commonAncestor&&parent.childNodes.length===1){toRemove=parent;parent=parent.parentElement;}
if(parent===commonAncestor){const rightSibling=toRemove.nextSibling;if(rightSibling&&!isBlock(rightSibling)){rightSibling.before(this.document.createElement("br"));}}
toRemove.remove();return true;}
adjustRange({startContainer,startOffset,endContainer,endOffset},callbacks){let range=this.document.createRange();range.setStart(startContainer,startOffset);range.setEnd(endContainer,endOffset);for(const callback of callbacks){range=callback.call(this,range);}
({startContainer,startOffset,endOffset,endContainer}=range);return{startContainer,startOffset,endOffset,endContainer};}
includeBlockStart(block,range){const{startContainer,startOffset,commonAncestorContainer}=range;if(block===commonAncestorContainer||!this.isCursorAtStartOfElement(block,startContainer,startOffset)){return range;}
range.setStartBefore(block);return this.includeBlockStart(block.parentNode,range);}
includeBlockEnd(block,range){const{startContainer,endContainer,endOffset,commonAncestorContainer}=range;const startList=closestElement(startContainer,"UL, OL");const endList=closestElement(endContainer,"UL, OL");if(block===commonAncestorContainer||!this.isCursorAtEndOfElement(block,endContainer,endOffset)||(startList&&endList&&!compareListTypes(startList,endList)&&!startList.contains(endList))){return range;}
range.setEndAfter(block);return this.includeBlockEnd(block.parentNode,range);}
includeEndOrStartBlock(range){const{startContainer,endContainer,commonAncestorContainer}=range;const startBlock=findUpTo(startContainer,commonAncestorContainer,isBlock);const endBlock=findUpTo(endContainer,commonAncestorContainer,isBlock);if(!startBlock||!endBlock){return range;}
range=this.includeBlockEnd(endBlock,range);if(range.endContainer===endContainer){range=this.includeBlockStart(startBlock,range);}
return range;}
fullyIncludeLinks(range){const{startContainer,startOffset,endContainer,endOffset,commonAncestorContainer}=range;const[startLink,endLink]=[startContainer,endContainer].map((container)=>findUpTo(container,commonAncestorContainer,(node)=>node.nodeName==="A"));if(startLink&&this.isCursorAtStartOfElement(startLink,startContainer,startOffset)){range.setStartBefore(startLink);}
if(endLink&&this.isCursorAtEndOfElement(endLink,endContainer,endOffset)){range.setEndAfter(endLink);}
return range;}
includeEmptyInlineStart(range){const element=closestElement(range.startContainer);if(this.isEmptyInline(element)){range.setStartBefore(element);}
return range;}
includeEmptyInlineEnd(range){const element=closestElement(range.endContainer);if(this.isEmptyInline(element)){range.setEndAfter(element);}
return range;}
includeNextZWS(range){const{endContainer,endOffset}=range;if(isTextNode(endContainer)&&endContainer.textContent[endOffset]==="\u200B"){range.setEnd(endContainer,endOffset+1);}
return range;}
includePreviousZWS(range){const{startContainer,startOffset}=range;if(isTextNode(startContainer)&&startContainer.textContent[startOffset-1]==="\u200B"){range.setStart(startContainer,startOffset-1);}
return range;}
expandRangeToIncludeNonEditables(range){const{startContainer,startOffset,endContainer,endOffset,commonAncestorContainer:commonAncestor,}=range;const isNonEditable=(node)=>!isContentEditable(node);const startUneditable=startOffset===0&&!previousLeaf(startContainer,closestBlock(startContainer))&&findFurthest(startContainer,commonAncestor,isNonEditable);if(startUneditable){range.setStartBefore(startUneditable);}
const endUneditable=endOffset===nodeSize(endContainer)&&!nextLeaf(endContainer,closestBlock(endContainer))&&findFurthest(endContainer,commonAncestor,isNonEditable);if(endUneditable){range.setEndAfter(endUneditable);}
return range;}
findAdjacentPosition(node,offset,direction){return direction==="forward"?this.findNextPosition(node,offset):this.findPreviousPosition(node,offset);}
makeFindPositionFn(direction){const isDirectionForward=direction==="forward";const findVisibleChar=(isDirectionForward?this.findNextVisibleChar:this.findPreviousVisibleChar).bind(this);const charLeftPos=(index,char)=>index;const charRightPos=(index,char)=>index+char.length;const indexBeforeChar=isDirectionForward?charLeftPos:charRightPos;const indexAfterChar=isDirectionForward?charRightPos:charLeftPos;const textEdgePos=isDirectionForward?startPos:endPos;const adjacentLeaf=(isDirectionForward?this.nextLeaf:this.previousLeaf).bind(this);const adjacentLeafFromPos=(isDirectionForward?this.nextLeafFromPos:this.previousLeafFromPos).bind(this);const beforePos=isDirectionForward?leftPos:rightPos;const afterPos=isDirectionForward?rightPos:leftPos;return function findPosition(node,offset){if(node.nodeType===Node.TEXT_NODE){const[char,index]=findVisibleChar(node,offset);if(char){return[node,indexAfterChar(index,char)];}}
const isEditableRoot=(n)=>n.isContentEditable&&!n.parentNode.isContentEditable;const editableRoot=findUpTo(node,this.editable.parentNode,isEditableRoot);let blockSwitch;const nodeClosestBlock=closestBlock(node);let leaf=adjacentLeafFromPos(node,offset,editableRoot);while(leaf){const leafClosestBlock=closestBlock(leaf);blockSwitch||=leafClosestBlock!==nodeClosestBlock;if(this.shouldSkip(leaf,blockSwitch)){leaf=adjacentLeaf(leaf,editableRoot);continue;}
if(leaf.nodeType===Node.TEXT_NODE&&!(blockSwitch&&isEmptyBlock(leafClosestBlock))){const[char,index]=findVisibleChar(...textEdgePos(leaf));if(char){const idx=(blockSwitch?indexBeforeChar:indexAfterChar)(index,char);return[leaf,idx];}}else if(!leaf.isContentEditable&&isBlock(leaf)){return afterPos(leaf);}else{return blockSwitch?beforePos(leaf):afterPos(leaf);}
leaf=adjacentLeaf(leaf,editableRoot);}
return[null,null];};}
findLineBoundary(container,offset,direction){const adjacentLeaf=direction==="forward"?nextLeaf:previousLeaf;const edgeIndex=(node)=>(direction==="forward"?nodeSize(node):0);const block=closestBlock(container);let last=container;let node=adjacentLeaf(container,this.editable);while(node&&node.nodeName!=="BR"&&closestBlock(node)===block){last=node;node=adjacentLeaf(node,this.editable);}
if(last===container&&offset===edgeIndex(container)){return this.findAdjacentPosition(container,offset,direction);}
return direction==="forward"?rightPos(last):leftPos(last);}
isVisibleChar(char,textNode,offset){if(isProtected(textNode)){return true;}
const isZwnbspLinkPad=(node)=>isButton(node.previousSibling)||isButton(node.nextSibling);if(isZwnbsp(textNode)&&isZwnbspLinkPad(textNode)){return true;}
if(["\u200B","\uFEFF"].includes(char)){return false;}
if(!isWhitespace(char)||isInPre(textNode)){return true;}
if(offset){return!isWhitespace(textNode.textContent[offset-char.length]);}else if(!(getState(...leftPos(textNode),DIRECTIONS.LEFT).cType&CTYPES.CONTENT)){return false;}
const charsToTheRight=textNode.textContent.slice(offset+char.length);for(char of charsToTheRight){if(!isWhitespace(char)){return true;}}
if(getState(...rightPos(textNode),DIRECTIONS.RIGHT).cType&CTYPES.CONTENT){return true;}
return false;}
shouldSkip(leaf,blockSwitch){const systemNodeSelectors=this.getResource("system_node_selectors").join(",");if(systemNodeSelectors&&closestElement(leaf,systemNodeSelectors)){return true;}
if(leaf.nodeType===Node.TEXT_NODE){return false;}
if(blockSwitch){return false;}
if(leaf.nodeName==="BR"&&isFakeLineBreak(leaf)){return true;}
if(this.getResource("functional_empty_node_predicates").some((predicate)=>predicate(leaf))){return false;}
if(isEmpty(leaf)||isZWS(leaf)){return true;}
return false;}
findPreviousVisibleChar(textNode,index){const chars=[...textNode.textContent.slice(0,index)];let char=chars.pop();while(char){index-=char.length;if(this.isVisibleChar(char,textNode,index)){return[char,index];}
char=chars.pop();}
return[null,null];}
findNextVisibleChar(textNode,index){for(const char of textNode.textContent.slice(index)){if(this.isVisibleChar(char,textNode,index)){return[char,index];}
index+=char.length;}
return[null,null];}
adjustedLeaf(leaf,refEditableRoot){const isNonEditable=(node)=>!isContentEditable(node);const nonEditableRoot=leaf&&findFurthest(leaf,refEditableRoot,isNonEditable);return nonEditableRoot||leaf;}
previousLeaf(node,editableRoot){return this.adjustedLeaf(previousLeaf(node,editableRoot),editableRoot);}
nextLeaf(node,editableRoot){return this.adjustedLeaf(nextLeaf(node,editableRoot),editableRoot);}
previousLeafFromPos(node,offset,editableRoot){const leaf=node.hasChildNodes()&&offset>0?lastLeaf(node.childNodes[offset-1]):previousLeaf(node,editableRoot);return this.adjustedLeaf(leaf,editableRoot);}
nextLeafFromPos(node,offset,editableRoot){const leaf=node.hasChildNodes()&&offset<nodeSize(node)?firstLeaf(node.childNodes[offset]):nextLeaf(node,editableRoot);return this.adjustedLeaf(leaf,editableRoot);}
onBeforeInputDelete(ev){const handledInputTypes={deleteContentBackward:["backward","character"],deleteContentForward:["forward","character"],deleteWordBackward:["backward","word"],deleteWordForward:["forward","word"],deleteHardLineBackward:["backward","line"],deleteHardLineForward:["forward","line"],};const argsForDelete=handledInputTypes[ev.inputType];if(argsForDelete){this.delete(...argsForDelete);ev.preventDefault();if(isBrowserChrome()&&hasTouch()){this.preventDefaultDeleteAndroidChrome(ev);}}}
onBeforeInputInsertText(ev){if(ev.inputType==="insertText"){const selection=this.dependencies.selection.getSelectionData().deepEditableSelection;if(!selection.isCollapsed){this.dispatchTo("before_delete_handlers");this.deleteSelection(selection);this.dispatchTo("delete_handlers");}}}
preventDefaultDeleteAndroidChrome(beforeInputEvent){const restoreDOM=this.dependencies.history.makeSavePoint();this.onAndroidChromeInput=(ev)=>{if(ev.inputType!==beforeInputEvent.inputType){return;}
restoreDOM();const{restore:restoreSelection}=this.dependencies.selection.preserveSelection();const observerOptions={childList:true,subtree:true,characterData:true};const getMutationRecords=observeMutations(this.editable,observerOptions);this.onAndroidChromeSelectionChange=()=>{const shouldRevertSelectionChanges=!getMutationRecords().length;if(shouldRevertSelectionChanges){restoreSelection();}};setTimeout(()=>delete this.onAndroidChromeSelectionChange);};}
deleteBackwardUnmergeable(range){const{startContainer,startOffset,endContainer,endOffset}=range;return this.deleteCharUnmergeable(endContainer,endOffset,startContainer,startOffset);}
deleteForwardUnmergeable(range){const{startContainer,startOffset,endContainer,endOffset}=range;return this.deleteCharUnmergeable(startContainer,startOffset,endContainer,endOffset);}
deleteCharUnmergeable(sourceContainer,sourceOffset,destContainer,destOffset){if(!destContainer){return;}
const commonAncestor=getCommonAncestor([sourceContainer,destContainer],this.editable);const closestUnmergeable=findUpTo(sourceContainer,commonAncestor,(node)=>this.isUnmergeable(node));if(!closestUnmergeable){return;}
if((isEmpty(closestUnmergeable)||this.getResource("is_empty_predicates").some((p)=>p(closestUnmergeable)))&&!this.isUnremovable(closestUnmergeable)){closestUnmergeable.remove();this.dependencies.selection.setSelection({anchorNode:destContainer,anchorOffset:destOffset,});}else{this.dependencies.selection.setSelection({anchorNode:sourceContainer,anchorOffset:sourceOffset,});}
return true;}
isEmptyInline(element){if(isBlock(element)){return false;}
if(isZWS(element)){return true;}
return element.innerHTML.trim()==="";}
isCursorAtStartOfElement(element,cursorNode,cursorOffset){const[node]=this.findPreviousPosition(cursorNode,cursorOffset);return!element.contains(node);}
isCursorAtEndOfElement(element,cursorNode,cursorOffset){const[node]=this.findNextPosition(cursorNode,cursorOffset);return!element.contains(node);}
setCursorFromRange(range,{collapseToEnd=false}={}){range=this.collapseRange(range,{toEnd:collapseToEnd});const[anchorNode,anchorOffset]=this.normalizeEnterBlock(range.startContainer,range.startOffset);this.dependencies.selection.setSelection({anchorNode,anchorOffset});}
normalizeEnterBlock(node,offset){while(isBlock(node.childNodes[offset])){[node,offset]=[node.childNodes[offset],0];}
return[node,offset];}
collapseRange(range,{toEnd=false}={}){let{startContainer,startOffset,endContainer,endOffset}=range;if(toEnd){[startContainer,startOffset]=[endContainer,endOffset];}else{[endContainer,endOffset]=[startContainer,startOffset];}
const commonAncestorContainer=startContainer;return{startContainer,startOffset,endContainer,endOffset,commonAncestorContainer};}}
return __exports;});;

/* /html_editor/static/src/core/dialog_plugin.js */
odoo.define('@html_editor/core/dialog_plugin',['@html_editor/plugin'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const DialogPlugin=__exports.DialogPlugin=class DialogPlugin extends Plugin{static id="dialog";static dependencies=["selection"];static shared=["addDialog"];addDialog(DialogClass,props,options={}){return new Promise((resolve)=>{this.services.dialog.add(DialogClass,props,{onClose:()=>{this.dependencies.selection.focusEditable();resolve();},...options,});});}}
return __exports;});;

/* /html_editor/static/src/core/dom_plugin.js */
odoo.define('@html_editor/core/dom_plugin',['@html_editor/plugin','@html_editor/utils/blocks','@html_editor/utils/dom','@html_editor/utils/dom_info','@html_editor/utils/dom_traversal','@html_editor/utils/formatting','@html_editor/utils/position','@html_editor/utils/selection','@html_editor/utils/base_container','@html_editor/core/selection_plugin'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{closestBlock,isBlock}=require("@html_editor/utils/blocks");const{cleanTrailingBR,fillEmpty,fillShrunkPhrasingParent,makeContentsInline,removeClass,removeStyle,unwrapContents,wrapInlinesInBlocks,}=require("@html_editor/utils/dom");const{allowsParagraphRelatedElements,getDeepestPosition,isContentEditable,isContentEditableAncestor,isEmptyBlock,isListElement,isListItemElement,isParagraphRelatedElement,isProtecting,isProtected,isSelfClosingElement,isShrunkBlock,isTangible,isUnprotecting,listElementSelector,isEditorTab,isPhrasingContent,}=require("@html_editor/utils/dom_info");const{childNodes,children,closestElement,descendants,firstLeaf,lastLeaf,}=require("@html_editor/utils/dom_traversal");const{FONT_SIZE_CLASSES,TEXT_STYLE_CLASSES}=require("@html_editor/utils/formatting");const{childNodeIndex,nodeSize,rightPos}=require("@html_editor/utils/position");const{normalizeCursorPosition}=require("@html_editor/utils/selection");const{baseContainerGlobalSelector}=require("@html_editor/utils/base_container");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");function getConnectedParents(nodes){const parents=new Set();for(const node of nodes){if(node.isConnected&&node.parentElement){parents.add(node.parentElement);}}
return parents;}
const DomPlugin=__exports.DomPlugin=class DomPlugin extends Plugin{static id="dom";static dependencies=["baseContainer","selection","history","split","delete","lineBreak"];static shared=["insert","copyAttributes","canSetBlock","setBlock","setTagName","removeSystemProperties",];resources={user_commands:[{id:"insertFontAwesome",run:this.insertFontAwesome.bind(this),isAvailable:isHtmlContentSupported,},{id:"setTag",run:this.setBlock.bind(this),isAvailable:isHtmlContentSupported,},],clean_for_save_handlers:({root})=>{this.removeEmptyClassAndStyleAttributes(root);},clipboard_content_processors:this.removeEmptyClassAndStyleAttributes.bind(this),functional_empty_node_predicates:[isSelfClosingElement,isEditorTab],};setup(){this.systemClasses=this.getResource("system_classes");this.systemAttributes=this.getResource("system_attributes");this.systemStyleProperties=this.getResource("system_style_properties");this.systemPropertiesSelector=[...this.systemClasses.map((className)=>`.${className}`),...this.systemAttributes.map((attr)=>`[${attr}]`),...this.systemStyleProperties.map((prop)=>`[style*="${prop}"]`),].join(",");}
insert(content){if(!content){return;}
let selection=this.dependencies.selection.getEditableSelection();if(!selection.isCollapsed){this.dependencies.delete.deleteSelection();selection=this.dependencies.selection.getEditableSelection();}
let container=this.document.createElement("fake-element");const containerFirstChild=this.document.createElement("fake-element-fc");const containerLastChild=this.document.createElement("fake-element-lc");if(typeof content==="string"){container.textContent=content;}else{if(content.nodeType===Node.ELEMENT_NODE){this.dispatchTo("normalize_handlers",content);}else{for(const child of children(content)){this.dispatchTo("normalize_handlers",child);}}
container.replaceChildren(content);}
const block=closestBlock(selection.anchorNode);for(const cb of this.getResource("before_insert_processors")){container=cb(container,block);}
if(!container.hasChildNodes()){return[];}
selection=this.dependencies.selection.getEditableSelection();let startNode;let insertBefore=false;if(selection.startContainer.nodeType===Node.TEXT_NODE){insertBefore=!selection.startOffset;if(selection.startOffset!==0&&selection.startOffset!==selection.startContainer.length){selection.startContainer.splitText(selection.startOffset);}
startNode=selection.startContainer;}
const allInsertedNodes=[];const hasSingleChild=nodeSize(container)===1;if(closestElement(selection.anchorNode,listElementSelector)&&isListElement(container.firstChild)){unwrapContents(container.firstChild);}
if(closestElement(selection.focusNode,listElementSelector)&&isListElement(container.lastChild)&&!hasSingleChild){unwrapContents(container.lastChild);}
startNode=startNode||this.dependencies.selection.getEditableSelection().anchorNode;const shouldUnwrap=(node)=>(isParagraphRelatedElement(node)||isListItemElement(node))&&!isEmptyBlock(block)&&!isEmptyBlock(node)&&isContentEditable(block)&&(isContentEditable(node)||(!node.isConnected&&!closestElement(node,"[contenteditable]")))&&!this.dependencies.split.isUnsplittable(node)&&(node.nodeName===block.nodeName||(this.dependencies.baseContainer.isCandidateForBaseContainer(node)&&this.dependencies.baseContainer.isCandidateForBaseContainer(block))||block.nodeName==="PRE"||(block.nodeName==="DIV"&&this.dependencies.split.isUnsplittable(block)))&&!this.isEditionBoundary(selection.anchorNode);const firstLeafNode=firstLeaf(container);if(isBlock(firstLeafNode)&&!(closestElement(firstLeafNode,"[contenteditable]")?.contentEditable==="false")){fillEmpty(firstLeafNode);}
const lastLeafNode=lastLeaf(container);if(isBlock(lastLeafNode)&&!(closestElement(lastLeafNode,"[contenteditable]")?.contentEditable==="false")){fillEmpty(lastLeafNode);}
if(container.childElementCount===1&&(this.dependencies.baseContainer.isCandidateForBaseContainer(container.firstChild)||shouldUnwrap(container.firstChild))){const nodeToUnwrap=container.firstElementChild;container.replaceChildren(...childNodes(nodeToUnwrap));}else if(container.childElementCount>1){const isSelectionAtStart=firstLeaf(block)===selection.anchorNode&&selection.anchorOffset===0;const isSelectionAtEnd=lastLeaf(block)===selection.focusNode&&selection.focusOffset===nodeSize(selection.focusNode);if(shouldUnwrap(container.firstChild)&&!isSelectionAtStart){if(isListItemElement(container.firstChild)){const deepestBlock=closestBlock(firstLeaf(container.firstChild));this.dependencies.split.splitAroundUntil(deepestBlock,container.firstChild);container.firstElementChild.replaceChildren(...childNodes(deepestBlock));}
containerFirstChild.replaceChildren(...childNodes(container.firstElementChild));container.firstElementChild.remove();}
if(shouldUnwrap(container.lastChild)&&!isSelectionAtEnd){if(isListItemElement(container.lastChild)){const deepestBlock=closestBlock(lastLeaf(container.lastChild));this.dependencies.split.splitAroundUntil(deepestBlock,container.lastChild);container.lastElementChild.replaceChildren(...childNodes(deepestBlock));}
containerLastChild.replaceChildren(...childNodes(container.lastElementChild));container.lastElementChild.remove();}}
const textNode=this.document.createTextNode("");if(startNode.nodeType===Node.ELEMENT_NODE){if(selection.anchorOffset===0){if(isSelfClosingElement(startNode)){startNode.parentNode.insertBefore(textNode,startNode);}else{startNode.prepend(textNode);}
startNode=textNode;allInsertedNodes.push(textNode);}else{startNode=childNodes(startNode).at(selection.anchorOffset-1);}}
let currentNode=startNode;const _insertAt=(reference,nodes,insertBefore)=>{for(const child of insertBefore?nodes.reverse():nodes){reference[insertBefore?"before":"after"](child);reference=child;}};const lastInsertedNodes=childNodes(containerLastChild);if(containerLastChild.hasChildNodes()){const toInsert=childNodes(containerLastChild);_insertAt(currentNode,[...toInsert],insertBefore);currentNode=insertBefore?toInsert[0]:currentNode;toInsert[toInsert.length-1];}
const firstInsertedNodes=childNodes(containerFirstChild);if(containerFirstChild.hasChildNodes()){const toInsert=childNodes(containerFirstChild);_insertAt(currentNode,[...toInsert],insertBefore);currentNode=toInsert[toInsert.length-1];insertBefore=false;}
allInsertedNodes.push(...firstInsertedNodes);if(!container.hasChildNodes()){if(this.dependencies.split.isUnsplittable(closestBlock(currentNode.nextSibling))){this.dependencies.lineBreak.insertLineBreakNode({targetNode:currentNode.nextSibling,targetOffset:0,});}else{const parent=currentNode.nextSibling.parentElement;const index=childNodes(parent).indexOf(currentNode.nextSibling);this.dependencies.split.splitBlockNode({targetNode:parent,targetOffset:index,});}}
let nodeToInsert;let doesCurrentNodeAllowsP=allowsParagraphRelatedElements(currentNode);const candidatesForRemoval=[];const insertedNodes=childNodes(container);while((nodeToInsert=container.firstChild)){if(isBlock(nodeToInsert)&&!doesCurrentNodeAllowsP){while(!this.isEditionBoundary(currentNode)&&(!allowsParagraphRelatedElements(currentNode.parentElement)||(isListItemElement(currentNode.parentElement)&&!this.dependencies.split.isUnsplittable(nodeToInsert)))){if(this.dependencies.split.isUnsplittable(currentNode.parentElement)){if(this.dependencies.split.isUnsplittable(nodeToInsert)){if(this.isEditionBoundary(currentNode.parentElement)){break;}
currentNode=currentNode.parentElement;doesCurrentNodeAllowsP=allowsParagraphRelatedElements(currentNode);continue;}else{makeContentsInline(container);nodeToInsert=container.firstChild;break;}}
let offset=childNodeIndex(currentNode);if(!insertBefore){offset+=1;}
if(offset){const[left,right]=this.dependencies.split.splitElement(currentNode.parentElement,offset);currentNode=insertBefore?right:left;const otherNode=insertBefore?left:right;if(isBlock(otherNode)){fillShrunkPhrasingParent(otherNode);}
candidatesForRemoval.push(right);}else{if(isBlock(currentNode)){fillShrunkPhrasingParent(currentNode);}
currentNode=currentNode.parentElement;}
doesCurrentNodeAllowsP=allowsParagraphRelatedElements(currentNode);}
if(isListItemElement(currentNode.parentElement)&&isBlock(nodeToInsert)&&this.dependencies.split.isUnsplittable(nodeToInsert)){const br=document.createElement("br");currentNode[isEmptyBlock(currentNode)||!isTangible(currentNode)?"before":"after"](br);}}
const block=closestBlock(currentNode);for(const processor of this.getResource("node_to_insert_processors")){nodeToInsert=processor({nodeToInsert,container:block});}
if(insertBefore){currentNode.before(nodeToInsert);insertBefore=false;}else{currentNode.after(nodeToInsert);}
allInsertedNodes.push(nodeToInsert);if(currentNode.tagName!=="BR"&&isShrunkBlock(currentNode)){currentNode.remove();}
currentNode=nodeToInsert;}
textNode.remove();allInsertedNodes.push(...lastInsertedNodes);this.getResource("after_insert_handlers").forEach((handler)=>handler(allInsertedNodes));let insertedNodesParents=getConnectedParents(allInsertedNodes);for(const parent of insertedNodesParents){if(!this.config.allowInlineAtRoot&&this.isEditionBoundary(parent)&&allowsParagraphRelatedElements(parent)){wrapInlinesInBlocks(parent,{baseContainerNodeName:this.dependencies.baseContainer.getDefaultNodeName(),});}}
insertedNodesParents=getConnectedParents(allInsertedNodes);for(const parent of insertedNodesParents){if(!isProtecting(parent)&&!(isProtected(parent)&&!isUnprotecting(parent))&&parent.isContentEditable){cleanTrailingBR(parent);}}
for(const candidateForRemoval of candidatesForRemoval){if(candidateForRemoval.isConnected&&(isParagraphRelatedElement(candidateForRemoval)||isListItemElement(candidateForRemoval))&&candidateForRemoval.parentElement.isContentEditable&&isEmptyBlock(candidateForRemoval)){candidateForRemoval.remove();}}
const lastInsertedNode=allInsertedNodes.findLast((node)=>node.isConnected);if(!lastInsertedNode){return;}
let lastPosition=isParagraphRelatedElement(lastInsertedNode)||isListItemElement(lastInsertedNode)||isListElement(lastInsertedNode)?rightPos(lastLeaf(lastInsertedNode)):rightPos(lastInsertedNode);lastPosition=normalizeCursorPosition(lastPosition[0],lastPosition[1],"right");if(!this.config.allowInlineAtRoot&&this.isEditionBoundary(lastPosition[0])){lastPosition=getDeepestPosition(...lastPosition);}
this.dependencies.selection.setSelection({anchorNode:lastPosition[0],anchorOffset:lastPosition[1]},{normalize:false});return firstInsertedNodes.concat(insertedNodes).concat(lastInsertedNodes);}
isEditionBoundary(node){if(!node){return false;}
if(node===this.editable){return true;}
return isContentEditableAncestor(node);}
copyAttributes(source,target){if(source?.nodeType!==Node.ELEMENT_NODE||target?.nodeType!==Node.ELEMENT_NODE){return;}
const ignoredAttrs=new Set(this.getResource("system_attributes"));const ignoredClasses=new Set(this.getResource("system_classes"));for(const attr of source.attributes){if(ignoredAttrs.has(attr.name)){continue;}
if(attr.name!=="class"||ignoredClasses.size===0){target.setAttribute(attr.name,attr.value);}else{const classes=[...source.classList];for(const className of classes){if(!ignoredClasses.has(className)){target.classList.add(className);}}}}}
setTagName(el,newTagName){const document=el.ownerDocument;if(el.tagName===newTagName){return el;}
const newEl=document.createElement(newTagName);const content=childNodes(el);if(isListItemElement(el)){el.append(newEl);newEl.replaceChildren(...content);}else{if(el.parentElement){el.before(newEl);}
this.copyAttributes(el,newEl);newEl.replaceChildren(...content);el.remove();}
return newEl;}
removeSystemProperties(root){const clean=(element)=>{removeClass(element,...this.systemClasses);this.systemAttributes.forEach((attr)=>element.removeAttribute(attr));removeStyle(element,...this.systemStyleProperties);};if(root.matches?.(this.systemPropertiesSelector)){clean(root);}
for(const element of root.querySelectorAll(this.systemPropertiesSelector)){clean(element);}}
insertFontAwesome({faClass="fa fa-star"}={}){const fontAwesomeNode=document.createElement("i");fontAwesomeNode.className=faClass;this.insert(fontAwesomeNode);this.dependencies.history.addStep();const[anchorNode,anchorOffset]=rightPos(fontAwesomeNode);this.dependencies.selection.setSelection({anchorNode,anchorOffset});}
isRetaggingSafe(block){return!((isParagraphRelatedElement(block)||isListItemElement(block)||isPhrasingContent(block))&&this.getResource("unremovable_node_predicates").some((predicate)=>predicate(block)));}
getBlocksToSet(){const targetedBlocks=[...this.dependencies.selection.getTargetedBlocks()];return targetedBlocks.filter((block)=>this.isRetaggingSafe(block)&&!descendants(block).some((descendant)=>targetedBlocks.includes(descendant))&&block.isContentEditable);}
canSetBlock(){return this.getBlocksToSet().length>0;}
setBlock({tagName,extraClass=""}){let newCandidate=this.document.createElement(tagName.toUpperCase());if(extraClass){newCandidate.classList.add(extraClass);}
if(this.dependencies.baseContainer.isCandidateForBaseContainer(newCandidate)){const baseContainer=this.dependencies.baseContainer.createBaseContainer(newCandidate.nodeName);this.copyAttributes(newCandidate,baseContainer);newCandidate=baseContainer;}
const cursors=this.dependencies.selection.preserveSelection();const newEls=[];for(const block of this.getBlocksToSet()){if(isParagraphRelatedElement(block)||isListItemElement(block)||isPhrasingContent(block)||block.nodeName==="BLOCKQUOTE"){if(newCandidate.matches(baseContainerGlobalSelector)&&isListItemElement(block)){continue;}
this.dispatchTo("before_set_tag_handlers",block,tagName,cursors);const newEl=this.setTagName(block,tagName);cursors.remapNode(block,newEl);const headingClasses=["h1","h2","h3","h4","h5","h6"];removeClass(newEl,...FONT_SIZE_CLASSES,...TEXT_STYLE_CLASSES,...headingClasses);delete newEl.style.fontSize;if(extraClass){newEl.classList.add(extraClass);}
newEls.push(newEl);}else{newCandidate.append(...childNodes(block));block.append(newCandidate);cursors.remapNode(block,newCandidate);}}
cursors.restore();this.dependencies.history.addStep();}
removeEmptyClassAndStyleAttributes(root){for(const node of[root,...descendants(root)]){if(node.classList&&!node.classList.length){node.removeAttribute("class");}
if(node.style&&!node.style.length){node.removeAttribute("style");}}}}
return __exports;});;

/* /html_editor/static/src/core/editor_version_plugin.js */
odoo.define('@html_editor/core/editor_version_plugin',['@html_editor/html_migrations/html_migrations_utils','@html_editor/plugin'],function(require){'use strict';let __exports={};const{htmlEditorVersions,stripVersion,VERSION_SELECTOR,}=require("@html_editor/html_migrations/html_migrations_utils");const{Plugin}=require("@html_editor/plugin");const EditorVersionPlugin=__exports.EditorVersionPlugin=class EditorVersionPlugin extends Plugin{static id="editorVersion";resources={clean_for_save_handlers:this.cleanForSave.bind(this),normalize_handlers:this.normalize.bind(this),};normalize(element){if(element.matches(VERSION_SELECTOR)&&element!==this.editable){delete element.dataset.oeVersion;}
stripVersion(element);}
cleanForSave({root}){const VERSIONS=htmlEditorVersions();const firstChild=root.firstElementChild;const version=VERSIONS.at(-1);if(firstChild&&version){firstChild.dataset.oeVersion=version;}}}
return __exports;});;

/* /html_editor/static/src/core/format_plugin.js */
odoo.define('@html_editor/core/format_plugin',['@html_editor/utils/dom_state','@html_editor/utils/resource','@html_editor/utils/selection','@web/core/l10n/translation','@html_editor/plugin','@html_editor/utils/blocks','@html_editor/utils/dom','@html_editor/utils/dom_info','@html_editor/utils/dom_traversal','@html_editor/utils/formatting','@html_editor/utils/position','@html_editor/core/selection_plugin'],function(require){'use strict';let __exports={};const{prepareUpdate}=require("@html_editor/utils/dom_state");const{withSequence}=require("@html_editor/utils/resource");const{callbacksForCursorUpdate}=require("@html_editor/utils/selection");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{Plugin}=require("@html_editor/plugin");const{closestBlock,isBlock}=require("@html_editor/utils/blocks");const{cleanTextNode,fillEmpty,removeClass,splitTextNode,unwrapContents}=require("@html_editor/utils/dom");const{areSimilarElements,isContentEditable,isElement,isEmptyBlock,isEmptyTextNode,isSelfClosingElement,isTextNode,isVisibleTextNode,isZwnbsp,isZWS,previousLeaf,}=require("@html_editor/utils/dom_info");const{isFakeLineBreak}=require("@html_editor/utils/dom_state");const{childNodes,closestElement,descendants,findFurthest,selectElements,}=require("@html_editor/utils/dom_traversal");const{formatsSpecs,FORMATTABLE_TAGS}=require("@html_editor/utils/formatting");const{boundariesIn,boundariesOut,DIRECTIONS,leftPos,rightPos}=require("@html_editor/utils/position");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const allWhitespaceRegex=/^[\s\u200b]*$/;function isFormatted(formatPlugin,format){return(sel,nodes)=>formatPlugin.isSelectionFormat(format,nodes);}
const FormatPlugin=__exports.FormatPlugin=class FormatPlugin extends Plugin{static id="format";static dependencies=["selection","history","input","split"];static shared=["isSelectionFormat","insertAndSelectZws","mergeAdjacentInlines","formatSelection",];resources={user_commands:[{id:"formatBold",description:_t("Toggle bold"),icon:"fa-bold",run:this.formatSelection.bind(this,"bold"),isAvailable:isHtmlContentSupported,},{id:"formatItalic",description:_t("Toggle italic"),icon:"fa-italic",run:this.formatSelection.bind(this,"italic"),isAvailable:isHtmlContentSupported,},{id:"formatUnderline",description:_t("Toggle underline"),icon:"fa-underline",run:this.formatSelection.bind(this,"underline"),isAvailable:isHtmlContentSupported,},{id:"formatStrikethrough",description:_t("Toggle strikethrough"),icon:"fa-strikethrough",run:this.formatSelection.bind(this,"strikeThrough"),isAvailable:isHtmlContentSupported,},{id:"formatFontSize",run:({size})=>this.formatSelection("fontSize",{applyStyle:true,formatProps:{size},}),isAvailable:isHtmlContentSupported,},{id:"formatFontSizeClassName",run:({className})=>this.formatSelection("setFontSizeClassName",{applyStyle:true,formatProps:{className},}),isAvailable:isHtmlContentSupported,},{id:"removeFormat",description:(sel,nodes)=>nodes&&this.hasAnyFormat(nodes)?_t("Remove Format"):_t("Selection has no format"),icon:"fa-eraser",run:this.removeAllFormats.bind(this),isAvailable:isHtmlContentSupported,},],shortcuts:[{hotkey:"control+b",commandId:"formatBold"},{hotkey:"control+i",commandId:"formatItalic"},{hotkey:"control+u",commandId:"formatUnderline"},{hotkey:"control+5",commandId:"formatStrikethrough"},{hotkey:"control+space",commandId:"removeFormat"},],toolbar_groups:withSequence(20,{id:"decoration"}),toolbar_items:[{id:"bold",groupId:"decoration",namespaces:["compact","expanded"],commandId:"formatBold",isActive:isFormatted(this,"bold"),},{id:"italic",groupId:"decoration",namespaces:["compact","expanded"],commandId:"formatItalic",isActive:isFormatted(this,"italic"),},{id:"underline",groupId:"decoration",namespaces:["compact","expanded"],commandId:"formatUnderline",isActive:isFormatted(this,"underline"),},{id:"strikethrough",groupId:"decoration",commandId:"formatStrikethrough",isActive:isFormatted(this,"strikeThrough"),},withSequence(20,{id:"remove_format",groupId:"decoration",commandId:"removeFormat",isDisabled:(sel,nodes)=>!this.hasAnyFormat(nodes),}),],beforeinput_handlers:withSequence(20,this.onBeforeInput.bind(this)),clean_for_save_handlers:this.cleanForSave.bind(this),normalize_handlers:this.normalize.bind(this),selectionchange_handlers:this.removeEmptyInlineElement.bind(this),before_set_tag_handlers:this.removeFontSizeFormat.bind(this),before_insert_processors:this.unwrapEmptyFormat.bind(this),intangible_char_for_keyboard_navigation_predicates:(_,char)=>char==="\u200b",};removeFormats(formats,targetedNodes){for(const format of formats){if(!formatsSpecs[format].removeStyle||!this.hasSelectionFormat(format,targetedNodes)){continue;}
this.formatSelection(format,{applyStyle:false,removeFormat:true});}}
unwrapEmptyFormat(insertedNode){const anchorNode=this.dependencies.selection.getEditableSelection().anchorNode;if(!allWhitespaceRegex.test(insertedNode.textContent)){return insertedNode;}
const emptyZWS=closestElement(anchorNode,"[data-oe-zws-empty-inline]");if(!emptyZWS||!emptyZWS.parentElement.isContentEditable||this.getResource("unremovable_node_predicates").some((p)=>p(emptyZWS))){return insertedNode;}
const cursors=this.dependencies.selection.preserveSelection();cursors.update(callbacksForCursorUpdate.remove(emptyZWS));emptyZWS.remove();cursors.restore();return insertedNode;}
removeAllFormats(){const targetedNodes=this.dependencies.selection.getTargetedNodes();this.removeFormats(Object.keys(formatsSpecs),targetedNodes);this.dispatchTo("remove_all_formats_handlers");this.dependencies.history.addStep();}
removeFontSizeFormat(el){this.removeFormats(["fontSize","setFontSizeClassName"],[el,...descendants(el)]);}
hasSelectionFormat(format,targetedNodes=this.dependencies.selection.getTargetedNodes()){const targetedTextNodes=targetedNodes.filter(isTextNode);const isFormatted=formatsSpecs[format].isFormatted;return targetedTextNodes.some((n)=>isFormatted(n,{editable:this.editable}));}
isSelectionFormat(format,targetedNodes=this.dependencies.selection.getTargetedNodes()){const targetedTextNodes=targetedNodes.filter(isTextNode);const isFormatted=formatsSpecs[format].isFormatted;return(targetedTextNodes.length&&targetedTextNodes.every((node)=>isZwnbsp(node)||isEmptyTextNode(node)||isFormatted(node,{editable:this.editable})));}
hasAnyFormat(targetedNodes){for(const format of Object.keys(formatsSpecs)){if(formatsSpecs[format].removeStyle&&this.hasSelectionFormat(format,targetedNodes)){return true;}}
return targetedNodes.some((node)=>this.getResource("has_format_predicates").some((predicate)=>predicate(node)));}
formatSelection(formatName,options){this.dispatchTo("format_selection_handlers",formatName,options);if(this._formatSelection(formatName,options)&&!options?.removeFormat){this.dependencies.history.addStep();}}
_formatSelection(formatName,{applyStyle,formatProps}={}){this.dependencies.selection.selectAroundNonEditable();const selection=this.dependencies.split.splitSelection();if(typeof applyStyle==="undefined"){applyStyle=!this.isSelectionFormat(formatName);}
let zws;if(selection.isCollapsed){if(isTextNode(selection.anchorNode)&&selection.anchorNode.textContent==="\u200b"){zws=selection.anchorNode;this.dependencies.selection.setSelection({anchorNode:zws,anchorOffset:0,focusNode:zws,focusOffset:1,});}else{zws=this.insertAndSelectZws();}}
const selectedTextNodes=(this.dependencies.selection.getTargetedNodes().filter((n)=>this.dependencies.selection.areNodeContentsFullySelected(n)&&((isTextNode(n)&&(isVisibleTextNode(n)||isZWS(n)))||(n.nodeName==="BR"&&(isFakeLineBreak(n)||previousLeaf(n,closestBlock(n))?.nodeName==="BR")))&&isContentEditable(n)));const unformattedTextNodes=selectedTextNodes.filter((n)=>{const listItem=closestElement(n,"li");if(listItem&&this.dependencies.selection.areNodeContentsFullySelected(listItem)){const hasFontSizeStyle=formatName==="setFontSizeClassName"?listItem.classList.contains(formatProps?.className):listItem.style.fontSize;return!hasFontSizeStyle;}
return true;});const tagetedFieldNodes=new Set(this.dependencies.selection.getTargetedNodes().map((n)=>closestElement(n,"*[t-field],*[t-out],*[t-esc]")).filter(Boolean));const formatSpec=formatsSpecs[formatName];for(const node of unformattedTextNodes){const inlineAncestors=[];let currentNode=node;let parentNode=node.parentElement;const isClassListSplittable=(classList)=>[...classList].every((className)=>this.getResource("format_class_predicates").some((cb)=>cb(className)));while(parentNode&&!isBlock(parentNode)&&!this.dependencies.split.isUnsplittable(parentNode)&&(parentNode.classList.length===0||isClassListSplittable(parentNode.classList))){const isUselessZws=parentNode.tagName==="SPAN"&&parentNode.hasAttribute("data-oe-zws-empty-inline")&&parentNode.getAttributeNames().length===1;if(isUselessZws){unwrapContents(parentNode);}else{const newLastAncestorInlineFormat=this.dependencies.split.splitAroundUntil(currentNode,parentNode);removeFormat(newLastAncestorInlineFormat,formatSpec);if(["setFontSizeClassName","fontSize"].includes(formatName)&&applyStyle){removeClass(newLastAncestorInlineFormat,"o_default_font_size");}
if(newLastAncestorInlineFormat.isConnected){inlineAncestors.push(newLastAncestorInlineFormat);currentNode=newLastAncestorInlineFormat;}}
parentNode=currentNode.parentElement;}
const firstBlockOrClassHasFormat=formatSpec.isFormatted(parentNode,formatProps);if(firstBlockOrClassHasFormat&&!applyStyle){const isParentNodeBlockAndCompletelySelected=isBlock(parentNode)&&this.dependencies.selection.areNodeContentsFullySelected(parentNode);if(isParentNodeBlockAndCompletelySelected&&formatName==="setFontSizeClassName"){for(const node of[parentNode,...descendants(parentNode).filter(isElement)]){removeFormat(node,formatSpec);}}else{formatSpec.addNeutralStyle&&formatSpec.addNeutralStyle(getOrCreateSpan(node,inlineAncestors));}}else if((!firstBlockOrClassHasFormat||parentNode.nodeName==="LI")&&applyStyle){const tag=formatSpec.tagName&&this.document.createElement(formatSpec.tagName);if(tag){node.after(tag);tag.append(node);if(!formatSpec.isFormatted(tag,formatProps)){tag.after(node);tag.remove();formatSpec.addStyle(getOrCreateSpan(node,inlineAncestors),formatProps);}}else if(formatName!=="fontSize"||formatProps.size!==undefined){formatSpec.addStyle(getOrCreateSpan(node,inlineAncestors),formatProps);}}}
for(const targetedFieldNode of tagetedFieldNodes){if(applyStyle){formatSpec.addStyle(targetedFieldNode,formatProps);}else{formatSpec.removeStyle(targetedFieldNode);}}
if(zws){const siblings=[...zws.parentElement.childNodes];if(!isBlock(zws.parentElement)&&unformattedTextNodes.includes(siblings[0])&&unformattedTextNodes.includes(siblings[siblings.length-1])){zws.parentElement.setAttribute("data-oe-zws-empty-inline","");}else{const span=this.document.createElement("span");span.setAttribute("data-oe-zws-empty-inline","");zws.before(span);span.append(zws);}}
if(unformattedTextNodes.length===1&&unformattedTextNodes[0]&&unformattedTextNodes[0].textContent==="\u200B"){this.dependencies.selection.setCursorStart(unformattedTextNodes[0]);}else if(selectedTextNodes.length){const firstNode=selectedTextNodes[0];const lastNode=selectedTextNodes[selectedTextNodes.length-1];let newSelection;if(selection.direction===DIRECTIONS.RIGHT){newSelection={anchorNode:firstNode,anchorOffset:0,focusNode:lastNode,focusOffset:lastNode.length,};}else{newSelection={anchorNode:lastNode,anchorOffset:lastNode.length,focusNode:firstNode,focusOffset:0,};}
this.dependencies.selection.setSelection(newSelection,{normalize:false});return true;}
if(tagetedFieldNodes.size>0){return true;}}
normalize(root){for(const el of selectElements(root,"[data-oe-zws-empty-inline]")){if(!allWhitespaceRegex.test(el.textContent)){delete el.dataset.oeZwsEmptyInline;this.cleanZWS(el);if(el.tagName==="SPAN"&&el.getAttributeNames().length===0&&el.classList.length===0){unwrapContents(el);}}}
this.mergeAdjacentInlines(root);}
cleanForSave({root,preserveSelection=false}={}){for(const element of root.querySelectorAll("[data-oe-zws-empty-inline]")){let currentElement=element.parentElement;this.cleanElement(element,{preserveSelection});while(currentElement&&!isBlock(currentElement)&&!currentElement.childNodes.length){const parentElement=currentElement.parentElement;currentElement.remove();currentElement=parentElement;}
if(currentElement&&isBlock(currentElement)){fillEmpty(currentElement);}}
this.mergeAdjacentInlines(root,{preserveSelection});}
removeEmptyInlineElement(selectionData){const{anchorNode}=selectionData.editableSelection;const blockEl=closestBlock(anchorNode);if(!blockEl){return;}
const inlineElement=findFurthest(closestElement(anchorNode),blockEl,(e)=>!isBlock(e)&&e.textContent==="\u200b");if(this.lastEmptyInlineElement?.isConnected&&this.lastEmptyInlineElement!==inlineElement){this.cleanElement(this.lastEmptyInlineElement,{preserveSelection:true});}
if(inlineElement&&!isEmptyBlock(blockEl)){this.lastEmptyInlineElement=inlineElement;}else{this.lastEmptyInlineElement=null;}}
cleanElement(element,{preserveSelection}){delete element.dataset.oeZwsEmptyInline;if(!allWhitespaceRegex.test(element.textContent)){this.cleanZWS(element,{preserveSelection});return;}
if(this.getResource("unremovable_node_predicates").some((p)=>p(element))){return;}
if(![...element.classList].every((c)=>this.getResource("format_class_predicates").some((p)=>p(c)))){return;}
const restore=prepareUpdate(...leftPos(element),...rightPos(element));element.remove();restore();}
cleanZWS(element,{preserveSelection=true}={}){const textNodes=descendants(element).filter(isTextNode);const cursors=preserveSelection?this.dependencies.selection.preserveSelection():null;for(const node of textNodes){cleanTextNode(node,"\u200B",cursors);}
cursors?.restore();}
insertText(selection,content){if(selection.anchorNode.nodeType===Node.TEXT_NODE){selection=this.dependencies.selection.setSelection({anchorNode:selection.anchorNode.parentElement,anchorOffset:splitTextNode(selection.anchorNode,selection.anchorOffset),},{normalize:false});}
const txt=this.document.createTextNode(content||"#");const restore=prepareUpdate(selection.anchorNode,selection.anchorOffset);selection.anchorNode.insertBefore(txt,selection.anchorNode.childNodes[selection.anchorOffset]);restore();const[anchorNode,anchorOffset,focusNode,focusOffset]=boundariesOut(txt);this.dependencies.selection.setSelection({anchorNode,anchorOffset,focusNode,focusOffset},{normalize:false});return txt;}
insertAndSelectZws(){const selection=this.dependencies.selection.getEditableSelection();const zws=this.insertText(selection,"\u200B");splitTextNode(zws,selection.anchorOffset);return zws;}
onBeforeInput(ev){if(ev.inputType.startsWith("format")&&!isHtmlContentSupported(this.dependencies.selection.getEditableSelection())){ev.preventDefault();}
if(ev.inputType==="insertText"){const selection=this.dependencies.selection.getEditableSelection();if(!selection.isCollapsed){return;}
const element=closestElement(selection.anchorNode);if(element.hasAttribute("data-oe-zws-empty-inline")){const[anchorNode,anchorOffset,focusNode,focusOffset]=boundariesIn(element);this.dependencies.selection.setSelection({anchorNode,anchorOffset,focusNode,focusOffset,});}}}
mergeAdjacentInlines(root,{preserveSelection=true}={}){let selectionToRestore=null;for(const node of[root,...descendants(root)].filter(isElement)){if(this.shouldBeMergedWithPreviousSibling(node)){if(preserveSelection){selectionToRestore??=this.dependencies.selection.preserveSelection();selectionToRestore.update(callbacksForCursorUpdate.merge(node));}
if(node.matches("code.o_inline_code")){while(node.previousSibling?.nodeType===Node.TEXT_NODE&&/^\uFEFF*$/.test(node.previousSibling.nodeValue)){node.previousSibling.remove();}}
node.previousSibling.append(...childNodes(node));node.remove();}}
selectionToRestore?.restore();}
shouldBeMergedWithPreviousSibling(node){const isMergeable=(node)=>FORMATTABLE_TAGS.includes(node.nodeName)&&!this.getResource("unsplittable_node_predicates").some((predicate)=>predicate(node));let previousSibling=node.previousSibling;if(node.matches("code.o_inline_code")){while(previousSibling?.nodeType===Node.TEXT_NODE&&/^\uFEFF*$/.test(previousSibling.nodeValue)){previousSibling=previousSibling.previousSibling;}}
return(!isSelfClosingElement(node)&&areSimilarElements(node,previousSibling)&&isMergeable(node));}}
function getOrCreateSpan(node,ancestors){const document=node.ownerDocument;const span=ancestors.find((element)=>element.tagName==="SPAN"&&element.isConnected);const lastInlineAncestor=ancestors.findLast((element)=>!isBlock(element)&&element.isConnected);if(span){return span;}else{const span=document.createElement("span");if(lastInlineAncestor){lastInlineAncestor.after(span);span.append(lastInlineAncestor);}else{node.after(span);span.append(node);}
return span;}}
function removeFormat(node,formatSpec){const document=node.ownerDocument;node=closestElement(node);if(formatSpec.hasStyle(node)){formatSpec.removeStyle(node);if(["SPAN","FONT"].includes(node.tagName)&&!node.getAttributeNames().length){return unwrapContents(node);}}
if(formatSpec.isTag&&formatSpec.isTag(node)){const attributesNames=node.getAttributeNames().filter((name)=>name!=="data-oe-zws-empty-inline");if(attributesNames.length){const newNode=document.createElement("span");while(node.firstChild){newNode.appendChild(node.firstChild);}
for(let index=node.attributes.length-1;index>=0;--index){newNode.attributes.setNamedItem(node.attributes[index].cloneNode());}
node.parentNode.replaceChild(newNode,node);}else{unwrapContents(node);}}}
return __exports;});;

/* /html_editor/static/src/core/history_plugin.js */
odoo.define('@html_editor/core/history_plugin',['@web/core/l10n/translation','@html_editor/plugin','@html_editor/utils/dom_traversal','@web/core/browser/feature_detection','@html_editor/utils/resource','@web/core/utils/concurrency','@html_editor/utils/dom','@web/core/utils/objects','@html_editor/utils/tracking'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{Plugin}=require("@html_editor/plugin");const{childNodes,descendants,getCommonAncestor}=require("@html_editor/utils/dom_traversal");const{hasTouch}=require("@web/core/browser/feature_detection");const{withSequence}=require("@html_editor/utils/resource");const{Deferred}=require("@web/core/utils/concurrency");const{toggleClass}=require("@html_editor/utils/dom");const{omit,pick}=require("@web/core/utils/objects");const{trackOccurrences,trackOccurrencesPair}=require("@html_editor/utils/tracking");const HistoryPlugin=__exports.HistoryPlugin=class HistoryPlugin extends Plugin{static id="history";static dependencies=["selection","sanitize"];static shared=["addCustomMutation","applyCustomMutation","addExternalStep","addStep","canRedo","canUndo","ignoreDOMMutations","getHistorySteps","getNodeById","makePreviewableOperation","makePreviewableAsyncOperation","makeSavePoint","makeSnapshotStep","redo","reset","resetFromSteps","serializeSelection","stageSelection","stageFocus","undo","getIsPreviewing","setStepExtra","getIsCurrentStepModified",];resources={user_commands:[{id:"historyUndo",description:_t("Undo"),icon:"fa-undo",run:this.undo.bind(this),},{id:"historyRedo",description:_t("Redo"),icon:"fa-repeat",run:this.redo.bind(this),},],...(hasTouch()&&{toolbar_groups:withSequence(5,{id:"historyMobile"}),toolbar_items:[{id:"undo",groupId:"historyMobile",commandId:"historyUndo",isDisabled:()=>!this.canUndo(),namespaces:["compact","expanded"],},{id:"redo",groupId:"historyMobile",commandId:"historyRedo",isDisabled:()=>!this.canRedo(),namespaces:["compact","expanded"],},],}),shortcuts:[{hotkey:"control+z",commandId:"historyUndo",global:true},{hotkey:"control+y",commandId:"historyRedo",global:true},{hotkey:"control+shift+z",commandId:"historyRedo",global:true},],start_edition_handlers:()=>{this.enableObserver();this.reset(this.config.content);},on_prepare_drag_handlers:this.disableIsCurrentStepModifiedWarning.bind(this),};setup(){this.mutationFilteredClasses=new Set(this.getResource("system_classes"));this.mutationFilteredAttributes=new Set(this.getResource("system_attributes"));this._onKeyupResetContenteditableNodes=[];this.addDomListener(this.document,"beforeinput",this._onDocumentBeforeInput.bind(this));this.addDomListener(this.document,"input",this._onDocumentInput.bind(this));this.addGlobalDomListener("pointerup",(ev)=>{if(this.editable.contains(ev.target)){this.stageSelection();}});this.observer=new MutationObserver((records)=>this.handleNewRecords(records));this.enableObserverCallbacks=new Set();this._cleanups.push(()=>this.observer.disconnect());this.clean();}
getIsPreviewing(){return this.isPreviewing;}
clean(){this.handleObserverRecords();this.steps=[];this.currentStep=this.processHistoryStep({selection:{},mutations:[],id:this.generateId(),previousStepId:undefined,extraStepInfos:{},});this.revertedSteps=new Set();this.discardedSteps=new Set();this.nodeMap=new NodeMap();this.lastObservedState=new WeakMap();this.setNodeId(this.editable);this.dispatchTo("history_cleaned_handlers");}
getNodeById(id){return this.nodeMap.getNode(id);}
reset(content){this.clean();this.stageSelection();this.steps.push(this.makeSnapshotStep());this.dispatchTo("history_reset_handlers",content);}
resetFromSteps(steps){this.withObserverOff(()=>{this.editable.replaceChildren();this.clean();this.stageSelection();for(const step of steps){this.applyMutations(step.mutations);}
this.steps=steps;this.dispatchTo("history_reset_from_steps_handlers");});this.dispatchTo("history_reset_from_steps_handlers");}
makeSnapshotStep(){return{selection:{anchorNode:undefined,anchorOffset:undefined,focusNode:undefined,focusOffset:undefined,},mutations:childNodes(this.editable).filter((node)=>this.nodeMap.hasNode(node)).map((node)=>({type:"add",parentNodeId:"root",nodeId:this.nodeMap.getId(node),serializedNode:this.serializeNode(node),nextNodeId:null,})),id:this.steps[this.steps.length-1]?.id||this.generateId(),previousStepId:undefined,};}
getHistorySteps(){return this.steps;}
processHistoryStep(step){for(const fn of this.getResource("history_step_processors")){step=fn(step);}
return step;}
enableObserver(){this.observer.observe(this.editable,{childList:true,subtree:true,attributes:true,attributeOldValue:true,characterData:true,characterDataOldValue:true,});}
disableObserver(){const enableObserver=()=>{this.enableObserverCallbacks.delete(enableObserver);if(this.enableObserverCallbacks.size>0){return;}
this.handleObserverRecords();this.isObserverDisabled=false;};this.enableObserverCallbacks.add(enableObserver);this.handleObserverRecords();this.isObserverDisabled=true;return enableObserver;}
ignoreDOMMutations(callback){const enableObserver=this.disableObserver();try{return callback();}finally{enableObserver();}}
withObserverOff(callback){this.handleObserverRecords();this.observer.disconnect();callback();this.enableObserver();}
handleObserverRecords(dispatch=true){this.handleNewRecords(this.observer.takeRecords(),dispatch);}
processNewRecords(mutationRecords){if(this.observer.takeRecords().length){throw new Error("MutationObserver has pending records");}
mutationRecords=this.filterMutationRecords(mutationRecords);let records=this.transformToHistoryMutationRecords(mutationRecords);records=records.filter((record)=>!this.isSystemMutationRecord(record));records=this.filterAndAdjustHistoryMutationRecords(records);this.stageRecords(records);records.filter(({type})=>type==="attributes").forEach((record)=>this.dispatchTo("attribute_change_handlers",record));return records;}
isValidRecord(record){switch(record.type){case"attributes":case"classList":case"characterData":return record.value!==record.oldValue;case"childList":return((record.addedTrees.length||record.removedTrees.length)&&(record.previousSibling!==undefined||record.nextSibling!==undefined));}}
dispatchContentUpdated(){if(!this.currentStep?.mutations?.length){return;}
const root=this.getMutationsRoot(this.currentStep.mutations);if(!root){return;}
this.dispatchTo("content_updated_handlers",root);}
handleNewRecords(records,dispatch=true){const processedRecords=this.processNewRecords(records);if(processedRecords.length){if(dispatch){const stepType=this.currentStep.type;this.dispatchTo("handleNewRecords",processedRecords,stepType);}
this.processNewRecords(this.observer.takeRecords());this.dispatchContentUpdated();}}
setIdOnAddedNodes(record){if(record.type!=="childList"){return;}
record.addedTrees.flatMap(treeToNodes).filter((node)=>!this.nodeMap.hasNode(node)).forEach((node)=>this.nodeMap.set(this.generateId(),node));}
filterMutationRecords(records){records=this.filterAttributeMutationRecords(records);records=this.filterSameTextContentMutationRecords(records);records=this.filterOutIntermediateStateMutationRecords(records);return records;}
filterAttributeMutationRecords(records){return records.filter((record)=>{if(record.type!=="attributes"){return true;}
if(record.target===this.editable){return false;}
if(record.attributeName==="contenteditable"){return false;}
return true;});}
filterSameTextContentMutationRecords(records){const filteredRecords=[];for(const record of records){if(record.type==="childList"&&this.isSameTextContentMutation(record)){const{addedNodes,removedNodes}=record;const oldId=this.nodeMap.getId(removedNodes[0]);if(oldId){this.nodeMap.set(oldId,addedNodes[0]);continue;}}
filteredRecords.push(record);}
return filteredRecords;}
filterOutIntermediateStateMutationRecords(records){const isFirstAttributeOccurrence=trackOccurrencesPair();const isFirstCharDataOccurence=trackOccurrences();const filteredRecords=[];for(const record of records){if(record.type==="attributes"){if(isFirstAttributeOccurrence(record.target,record.attributeName)){filteredRecords.push(record);}}else if(record.type==="characterData"){if(isFirstCharDataOccurence(record.target)){filteredRecords.push(record);}}else{filteredRecords.push(record);}}
return filteredRecords;}
transformToHistoryMutationRecords(records){records=this.transformChildListRecords(records);return records.flatMap((record)=>{if(record.type==="attributes"){if(record.attributeName==="class"){return this.splitClassMutationRecord(record);}
const oldValue=record.oldValue===undefined?null:record.oldValue;const value=record.target.getAttribute(record.attributeName);return{...pick(record,"type","target","attributeName"),oldValue,value};}
if(record.type==="characterData"){const value=record.target.textContent;return{...pick(record,"type","target","oldValue"),value};}
return record;});}
transformChildListRecords(records){const childListSnapshot=new WeakMap();const getChildListSnapshot=(node)=>childListSnapshot.get(node)||childNodes(node);const makeSnapshotTree=(node)=>({node,children:getChildListSnapshot(node).map(makeSnapshotTree),});const reconstructChildList=(childListAfter,record)=>{const{removedNodes,previousSibling,nextSibling}=record;const previousSiblingNodes=previousSibling?childListAfter.slice(0,childListAfter.indexOf(previousSibling)+1):[];const nextSiblingNodes=nextSibling?childListAfter.slice(childListAfter.indexOf(nextSibling)):[];return[...previousSiblingNodes,...removedNodes,...nextSiblingNodes];};return records.toReversed().map((record)=>{if(record.type!=="childList"){return record;}
const transformedRecord={...pick(record,"type","previousSibling","nextSibling","target"),addedTrees:[...record.addedNodes].map(makeSnapshotTree),removedTrees:[...record.removedNodes].map(makeSnapshotTree),};const childListAfterMutation=getChildListSnapshot(record.target);const childListBefore=reconstructChildList(childListAfterMutation,record);childListSnapshot.set(record.target,childListBefore);return transformedRecord;}).toReversed();}
splitClassMutationRecord(record){const oldValue=record.oldValue?.split(" ").filter(Boolean);const classesBefore=new Set(oldValue);const classesAfter=new Set(record.target.classList);const setDifference=(setA,setB)=>{const diff=new Set(setA);setB.forEach((item)=>diff.delete(item));return diff;};const addedClasses=setDifference(classesAfter,classesBefore);const removedClasses=setDifference(classesBefore,classesAfter);const createClassRecord=(className,isAdded)=>({type:"classList",target:record.target,className,value:isAdded,oldValue:!isAdded,});return[...[...addedClasses].map((cls)=>createClassRecord(cls,true)),...[...removedClasses].map((cls)=>createClassRecord(cls,false)),];}
isSystemMutationRecord(record){if(record.type==="attributes"){return this.mutationFilteredAttributes.has(record.attributeName);}
if(record.type==="classList"){return this.mutationFilteredClasses.has(record.className);}
return false;}
filterAndAdjustHistoryMutationRecords(records){this.dispatchTo("before_filter_mutation_record_handlers",records);const savableRecordPredicates=this.getResource("savable_mutation_record_predicates");const isRecordSavable=(record)=>savableRecordPredicates.every((p)=>p(record));const result=[];for(const record of records){if(!this.isObservedNode(record.target)){continue;}
if(this.isObserverDisabled||!isRecordSavable(record)){if(record.type!=="childList"){this.storeOldValue(record);}
continue;}
const updatedRecord=record.type==="childList"?this.updateChildListRecord(record):this.updateOldValue(record);if(this.isValidRecord(updatedRecord)){this.setIdOnAddedNodes(record);result.push(updatedRecord);}}
return result;}
isObservedNode(node){return this.nodeMap.hasNode(node);}
storeOldValue(record){const{stateMap,key}=this.getObservedStateStorage(record);if(!stateMap.has(key)){stateMap.set(key,record.oldValue);}}
updateOldValue(record){const{stateMap,key}=this.getObservedStateStorage(record);if(!stateMap.has(key)){return record;}
const lastObservedValue=stateMap.get(key);stateMap.delete(key);return{...record,oldValue:lastObservedValue};}
getObservedStateStorage(record){if(!this.lastObservedState.has(record.target)){this.lastObservedState.set(record.target,{attributes:new Map(),classList:new Map(),characterData:new Map(),});}
const stateMap=this.lastObservedState.get(record.target)[record.type];switch(record.type){case"attributes":return{stateMap,key:record.attributeName};case"classList":return{stateMap,key:record.className};case"characterData":return{stateMap,key:"textContent"};default:throw new Error(`Unsupported mutation type: ${record.type}`);}}
updateChildListRecord(record){const isValidReference=(node)=>node===null||this.isObservedNode(node);const updateSibling=(sibling)=>(isValidReference(sibling)?sibling:undefined);const previousSibling=updateSibling(record.previousSibling);const nextSibling=updateSibling(record.nextSibling);const removeUnobservedNodes=(tree)=>{if(!this.isObservedNode(tree.node)){return null;}
return{node:tree.node,children:tree.children.map(removeUnobservedNodes).filter(Boolean),};};const removedTrees=record.removedTrees.map(removeUnobservedNodes).filter(Boolean);return{...record,previousSibling,nextSibling,removedTrees,};}
isSameTextContentMutation(record){const{addedNodes,removedNodes}=record;return(record.type==="childList"&&addedNodes.length===1&&removedNodes.length===1&&addedNodes[0].nodeType===Node.TEXT_NODE&&removedNodes[0].nodeType===Node.TEXT_NODE&&addedNodes[0].textContent===removedNodes[0].textContent);}
stageSelection(){this.stageFocus();const selection=this.dependencies.selection.getEditableSelection();if(this.getIsCurrentStepModified()){console.warn(`should not have any "characterData", "remove" or "add" mutations in current step when you update the selection`);return;}
this.currentStep.selection=this.serializeSelection(selection);}
stageFocus(){let activeElement=this.document.activeElement;if(activeElement.contains(this.editable)){activeElement=this.editable;}
if(this.editable.contains(activeElement)){this.currentStep.activeElementId=this.setNodeId(activeElement);}}
stageRecords(records){for(const record of records){switch(record.type){case"characterData":case"classList":case"attributes":{const nodeId=this.nodeMap.getId(record.target);this.currentStep.mutations.push({...omit(record,"target"),nodeId});break;}
case"childList":{this.currentStep.mutations.push(...this.splitChildListRecord(record));break;}}}}
splitChildListRecord(record){const parentNodeId=this.nodeMap.getId(record.target);if(!parentNodeId){throw new Error("Unknown parent node");}
const makeSingleNodeRecords=(trees,type)=>trees.map((tree,index,treeList)=>{const node=tree.node;const nodeList=treeList.map((t)=>t.node);const[previousSibling,nextSibling]=type==="add"?[nodeList[index-1]||record.previousSibling,record.nextSibling]:[record.previousSibling,nodeList[index+1]||record.nextSibling];const[nextNodeId,previousNodeId]=[nextSibling,previousSibling].map((sibling)=>sibling?this.nodeMap.getId(sibling):sibling);const nodeId=this.nodeMap.getId(node);const serializedNode=this.serializeTree(tree);return{type,nodeId,parentNodeId,serializedNode,nextNodeId,previousNodeId};});return[...makeSingleNodeRecords(record.removedTrees,"remove"),...makeSingleNodeRecords(record.addedTrees,"add"),];}
applyCustomMutation({apply,revert}){apply();this.addCustomMutation({apply,revert});}
addCustomMutation({apply,revert}){const customMutation={type:"custom",apply:()=>{apply();this.addCustomMutation({apply,revert});},revert:()=>{revert();this.addCustomMutation({apply:revert,revert:apply});},};this.currentStep.mutations.push(customMutation);}
setNodeId(node){let id=this.nodeMap.getId(node);if(!id){id=node===this.editable?"root":this.generateId();this.nodeMap.set(id,node);node=node.firstChild;while(node){this.setNodeId(node);node=node.nextSibling;}}
return id;}
generateId(){return Math.floor(Math.random()*Math.pow(2,52)).toString();}
addStep({type="original",extraStepInfos}={}){const currentStep=this.currentStep;currentStep.type=type;this.handleObserverRecords();const currentMutationsCount=currentStep.mutations.length;if(currentMutationsCount===0){return false;}
const stepCommonAncestor=this.getMutationsRoot(currentStep.mutations)||this.editable;this.dispatchTo("normalize_handlers",stepCommonAncestor,type);this.handleObserverRecords(false);if(currentMutationsCount===currentStep.mutations.length){this.dispatchContentUpdated();}
currentStep.previousStepId=this.steps.at(-1)?.id;currentStep.selectionAfter=this.serializeSelection(this.dependencies.selection.getEditableSelection());this.steps.push(currentStep);this.dispatchTo("before_add_step_handlers");if(extraStepInfos){currentStep.extraStepInfos=extraStepInfos;}
this.currentStep=this.processHistoryStep({id:this.generateId(),type:undefined,selection:{},mutations:[],previousStepId:undefined,extraStepInfos:{},});this.stageSelection();this.dispatchTo("step_added_handlers",{step:currentStep,stepCommonAncestor,isPreviewing:this.isPreviewing,});this.config.onChange?.({isPreviewing:this.isPreviewing});return currentStep;}
canUndo(){return this.getNextUndoIndex()>0;}
canRedo(){return this.getNextRedoIndex()>0;}
undo(){if(this.steps.length===1){return;}
this.handleObserverRecords();const lastStep=this.currentStep;this.revertMutations(lastStep.mutations);this.observer.takeRecords();lastStep.mutations=[];const pos=this.getNextUndoIndex();let revertedStep;if(pos>0){revertedStep=this.steps[pos];this.revertedSteps.add(revertedStep.id);this.revertMutations(revertedStep.mutations,{forNewStep:true});this.setSerializedFocus(revertedStep.activeElementId);this.stageFocus();this.setSerializedSelection(revertedStep.selection);this.currentStep.selection=revertedStep.selectionAfter;this.addStep({type:"undo",extraStepInfos:revertedStep.extraStepInfos});}
this.dispatchTo("post_undo_handlers",revertedStep);}
redo(){this.handleObserverRecords();this.revertMutations(this.currentStep.mutations);this.observer.takeRecords();this.currentStep.mutations=[];const pos=this.getNextRedoIndex();let revertedStep;if(pos>0){revertedStep=this.steps[pos];this.revertedSteps.add(revertedStep.id);this.revertMutations(revertedStep.mutations,{forNewStep:true});this.setSerializedFocus(revertedStep.activeElementId);this.stageFocus();this.setSerializedSelection(revertedStep.selection);this.currentStep.selection=revertedStep.selectionAfter;this.addStep({type:"redo",extraStepInfos:revertedStep.extraStepInfos});}
this.dispatchTo("post_redo_handlers",revertedStep);}
setSerializedSelection(selection){if(!selection.anchorNodeId){return;}
const anchorNode=this.nodeMap.getNode(selection.anchorNodeId);if(!anchorNode){return;}
const newSelection={anchorNode,anchorOffset:selection.anchorOffset,};const focusNode=this.nodeMap.getNode(selection.focusNodeId);if(focusNode){newSelection.focusNode=focusNode;newSelection.focusOffset=selection.focusOffset;}
this.dependencies.selection.setSelection(newSelection,{normalize:false});}
setSerializedFocus(activeElementId){const elementToFocus=activeElementId==="root"?this.editable:activeElementId&&this.nodeMap.getNode(activeElementId);if(elementToFocus?.isConnected&&elementToFocus!==this.document.activeElement){elementToFocus.focus();}}
getNextUndoIndex(){for(let index=this.steps.length-1;index>=0;index--){const step=this.steps[index];if(!this.isReversibleStep(index)||this.discardedSteps.has(step.id)){continue;}
if(["original","redo"].includes(step.type)&&!this.revertedSteps.has(step.id)){return index;}}
return-1;}
isReversibleStep(index){const step=this.steps[index];if(!step){return false;}
return!this.getResource("unreversible_step_predicates").some((predicate)=>predicate(step));}
getNextRedoIndex(){for(let index=this.steps.length-1;index>=0;index--){const step=this.steps[index];if(!this.isReversibleStep(index)||this.discardedSteps.has(step.id)){continue;}
if(step.type==="original"){return-1;}
if(step.type==="undo"&&!this.revertedSteps.has(step.id)){return index;}}
return-1;}
addExternalStep(newStep,index){this.withObserverOff(()=>{this.revertMutations(this.currentStep.mutations);const stepsAfterNewStep=this.steps.slice(index);for(const stepToRevert of stepsAfterNewStep.slice().reverse()){this.revertMutations(stepToRevert.mutations);}
this.applyMutations(newStep.mutations);this.dispatchTo("normalize_handlers",this.getMutationsRoot(newStep.mutations)||this.editable);this.steps.splice(index,0,newStep);for(const stepToApply of stepsAfterNewStep){this.applyMutations(stepToApply.mutations);}
this.applyMutations(this.currentStep.mutations);this.dispatchTo("external_step_added_handlers");});}
applyMutations(mutations,{forNewStep=false,reverse}={}){if(forNewStep){this.fixClassListMutationsForNewStep(mutations);}
for(const mutation of mutations){switch(mutation.type){case"custom":{mutation.apply();break;}
case"characterData":{const node=this.nodeMap.getNode(mutation.nodeId);if(node){node.textContent=mutation.value;}
break;}
case"classList":{const node=this.nodeMap.getNode(mutation.nodeId);if(node){toggleClass(node,mutation.className,mutation.value);}
break;}
case"attributes":{const node=this.nodeMap.getNode(mutation.nodeId);if(node){let value=mutation.value;for(const cb of this.getResource("attribute_change_processors")){value=cb({target:node,attributeName:mutation.attributeName,oldValue:mutation.oldValue,value,reverse,},{forNewStep});}
this.setAttribute(node,mutation.attributeName,value);}
break;}
case"remove":{this.applyRemoveMutation(mutation);break;}
case"add":{this.applyAddMutation(mutation);break;}}}}
fixClassListMutationsForNewStep(mutations){const isFirstOcurrence=trackOccurrencesPair();const nonObservableClassMutations=mutations.filter((mutation)=>mutation.type==="classList").filter(({nodeId,className})=>isFirstOcurrence(nodeId,className)).map((mutation)=>({...mutation,node:this.nodeMap.getNode(mutation.nodeId)})).filter(({node,className,value})=>value===node?.classList.contains(className));if(nonObservableClassMutations.length){const setToOldValue=({node,className,oldValue})=>toggleClass(node,className,oldValue);this.withObserverOff(()=>nonObservableClassMutations.forEach(setToOldValue));}}
applyRemoveMutation(mutation){const parent=this.nodeMap.getNode(mutation.parentNodeId);const toRemove=this.nodeMap.getNode(mutation.nodeId);if(!toRemove){console.warn("Mutation could not be applied, node to remove is unknown.",mutation);return;}
if(toRemove.parentElement!==parent){console.warn("Mutation could not be applied, parent node does not match.",mutation);return;}
toRemove.remove();}
applyAddMutation(mutation){const{nodeId,serializedNode,parentNodeId,nextNodeId,previousNodeId}=mutation;const toAdd=this.nodeMap.getNode(nodeId)||this.unserializeNode(serializedNode);if(!toAdd){return;}
const parent=this.nodeMap.getNode(parentNodeId);if(!parent){console.warn("Mutation could not be applied, parent node is missing.",mutation);return;}
if(previousNodeId===null){parent.prepend(toAdd);return;}
if(nextNodeId===null){parent.append(toAdd);return;}
const isValid=(node)=>node?.parentNode===parent;const previousNode=this.nodeMap.getNode(previousNodeId);if(isValid(previousNode)){previousNode.after(toAdd);return;}
const nextNode=this.nodeMap.getNode(nextNodeId);if(isValid(nextNode)){nextNode.before(toAdd);return;}
console.warn("Mutation could not be applied, reference nodes are invalid.",mutation);}
revertMutations(mutations,{forNewStep=false}={}){const revertedMutations=mutations.map((mutation)=>{switch(mutation.type){case"characterData":case"classList":case"attributes":return{...mutation,value:mutation.oldValue,oldValue:mutation.value};case"remove":return{...mutation,type:"add"};case"add":return{...mutation,type:"remove"};case"custom":return{...mutation,apply:mutation.revert,revert:mutation.apply};default:throw new Error(`Unknown mutation type: ${mutation.type}`);}});this.applyMutations(revertedMutations.toReversed(),{forNewStep,reverse:true});}
serializeSelection(selection){return{anchorNodeId:this.nodeMap.getId(selection.anchorNode),anchorOffset:selection.anchorOffset,focusNodeId:this.nodeMap.getId(selection.focusNode),focusOffset:selection.focusOffset,};}
getMutationsRoot(mutations){const nodes=mutations.map((m)=>this.nodeMap.getNode(m.parentNodeId||m.nodeId)).filter((node)=>this.editable.contains(node));let commonAncestor=getCommonAncestor(nodes,this.editable);if(commonAncestor?.nodeType===Node.TEXT_NODE){commonAncestor=commonAncestor.parentElement;}
return commonAncestor;}
makeSavePoint(){this.handleObserverRecords();const draftMutations=this.currentStep.mutations.slice();const step=this.steps.at(-1);let applied=false;const selectionToRestore=this.dependencies.selection.preserveSelection();const extraToRestore={...this.currentStep.extraStepInfos};return()=>{if(applied){return;}
applied=true;const stepIndex=this.steps.findLastIndex((item)=>item===step);this.restoreToStep(stepIndex);this.applyMutations(draftMutations,{forNewStep:true});this.handleObserverRecords();selectionToRestore.restore();this.currentStep.extraStepInfos=extraToRestore;this.dispatchTo("restore_savepoint_handlers");};}
makePreviewableOperation(operation){let revertOperation=()=>{};return{preview:(...args)=>{revertOperation();revertOperation=this.makeSavePoint();this.isPreviewing=true;this.stageSelection();operation(...args);this.addStep();},commit:(...args)=>{revertOperation();this.isPreviewing=false;operation(...args);this.addStep();},revert:()=>{revertOperation();revertOperation=()=>{};this.isPreviewing=false;},};}
makePreviewableAsyncOperation(operation){let revertOperation=()=>{};return{preview:async(...args)=>{await revertOperation();const def=new Deferred();const revertSavePoint=this.makeSavePoint();revertOperation=async()=>{await def;revertSavePoint();};this.isPreviewing=true;try{await operation(...args);}catch(error){revertSavePoint();throw error;}finally{def.resolve();}
if(this.isDestroyed){return;}
this.addStep();},commit:async(...args)=>{await revertOperation();this.isPreviewing=false;const revertSavePoint=this.makeSavePoint();try{await operation(...args);}catch(error){revertSavePoint();throw error;}
if(this.isDestroyed){return;}
this.addStep();},revert:async()=>{await revertOperation();revertOperation=()=>{};this.isPreviewing=false;},};}
restoreToStep(stepIndex){this.handleObserverRecords();this.revertMutations(this.currentStep.mutations);this.observer.takeRecords();this.currentStep.mutations=[];let lastRevertedStep=this.currentStep;if(stepIndex===this.steps.length-1){return;}
for(let i=this.steps.length-1;i>stepIndex;i--){const currentStep=this.steps[i];this.revertMutations(currentStep.mutations,{forNewStep:true});this.processNewRecords(this.observer.takeRecords());if(this.isReversibleStep(i)){this.discardedSteps.add(currentStep.id);lastRevertedStep=currentStep;}}
for(let i=stepIndex+1;i<this.steps.length;i++){const currentStep=this.steps[i];if(!this.isReversibleStep(i)){this.applyMutations(currentStep.mutations,{forNewStep:true});this.processNewRecords(this.observer.takeRecords());}}
this.setSerializedSelection(lastRevertedStep.selection);this.dispatchContentUpdated();this.addStep({type:"restore"});}
setStepExtra(key,value){this.currentStep.extraStepInfos[key]=value;}
disableIsCurrentStepModifiedWarning(){this.ignoreIsCurrentStepModified=true;return()=>{this.ignoreIsCurrentStepModified=false;};}
getIsCurrentStepModified(){if(this.ignoreIsCurrentStepModified){return false;}
return this.currentStep.mutations.find((m)=>["characterData","remove","add"].includes(m.type));}
setAttribute(node,attributeName,attributeValue){if(this.delegateTo("set_attribute_overrides",node,attributeName,attributeValue)){return;}
if(attributeValue!==null){node.setAttribute(attributeName,attributeValue);}else{node.removeAttribute(attributeName);}}
serializeNode(node){return this.serializeTree(nodeToTree(node));}
unserializeNode(node){let[unserializedNode,newNodesMap]=this._unserializeNode(node,this.nodeMap);if(!unserializedNode){return null;}
const fakeNode=this.document.createElement("fake-el");fakeNode.appendChild(unserializedNode);this.dependencies.sanitize.sanitize(fakeNode,{IN_PLACE:true});unserializedNode=fakeNode.firstChild;if(!unserializedNode){return null;}
for(const node of[unserializedNode,...descendants(unserializedNode)]){if(this.nodeMap.hasNode(node)){continue;}
const id=newNodesMap.get(node);if(id){this.nodeMap.set(id,node);}}
return unserializedNode;}
serializeTree(tree){const node=tree.node;const nodeId=this.nodeMap.getId(node);if(!nodeId){return null;}
const result={nodeType:node.nodeType,nodeId:nodeId,};if(node.nodeType===Node.TEXT_NODE){result.textValue=node.nodeValue;}else if(node.nodeType===Node.ELEMENT_NODE){let childTreesToSerialize=tree.children;for(const cb of this.getResource("serializable_descendants_processors")){childTreesToSerialize=cb(node,childTreesToSerialize);}
result.tagName=node.tagName;result.attributes=Object.fromEntries([...node.attributes].map((attr)=>[attr.name,attr.value]));result.children=childTreesToSerialize.map((tree)=>this.serializeTree(tree)).filter(Boolean);}
return result;}
_unserializeNode(serializedNode,nodeMap=new NodeMap(),_map=new Map()){let node=nodeMap.getNode(serializedNode.nodeId);if(node){return[node,_map];}
if(serializedNode.nodeType===Node.TEXT_NODE){node=this.document.createTextNode(serializedNode.textValue);}else if(serializedNode.nodeType===Node.ELEMENT_NODE){node=this.document.createElement(serializedNode.tagName);for(const key in serializedNode.attributes){node.setAttribute(key,serializedNode.attributes[key]);}
node.append(...serializedNode.children.map((child)=>this._unserializeNode(child,nodeMap,_map)[0]).filter(Boolean));}else{console.warn("unknown node type");return[null,_map];}
_map.set(node,serializedNode.nodeId);return[node,_map];}
_onDocumentBeforeInput(ev){if(this.editable.contains(ev.target)){return;}
if(["historyUndo","historyRedo"].includes(ev.inputType)){this._onKeyupResetContenteditableNodes.push(...this.editable.querySelectorAll("[contenteditable=true]"));if(this.editable.getAttribute("contenteditable")==="true"){this._onKeyupResetContenteditableNodes.push(this.editable);}
for(const node of this._onKeyupResetContenteditableNodes){node.setAttribute("contenteditable",false);}}}
_onDocumentInput(ev){if(["historyUndo","historyRedo"].includes(ev.inputType)&&this._onKeyupResetContenteditableNodes.length){for(const node of this._onKeyupResetContenteditableNodes){node.setAttribute("contenteditable",true);}
this._onKeyupResetContenteditableNodes=[];}}}
__exports.nodeToTree=nodeToTree;function nodeToTree(node){return{node,children:childNodes(node).map(nodeToTree),};}
function treeToNodes(tree){return[tree.node,...tree.children.flatMap(treeToNodes)];}
class NodeMap{constructor(){const idToNodeMap=new Map();const nodeToIdMap=new Map();this.set=(id,node)=>{if(!id||!node){throw new Error("Id and Node cannot be nullish");}
const oldNode=idToNodeMap.get(id);nodeToIdMap.delete(oldNode);const oldId=nodeToIdMap.get(node);idToNodeMap.delete(oldId);idToNodeMap.set(id,node);nodeToIdMap.set(node,id);};this.getNode=(id)=>idToNodeMap.get(id);this.getId=(node)=>nodeToIdMap.get(node);this.hasNode=(node)=>nodeToIdMap.has(node);}}
return __exports;});;

/* /html_editor/static/src/core/input_plugin.js */
odoo.define('@html_editor/core/input_plugin',['@html_editor/plugin'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const InputPlugin=__exports.InputPlugin=class InputPlugin extends Plugin{static id="input";static dependencies=["history"];setup(){this.addDomListener(this.editable,"beforeinput",this.onBeforeInput);this.addDomListener(this.editable,"input",this.onInput);}
onBeforeInput(ev){this.dependencies.history.stageSelection();this.dispatchTo("beforeinput_handlers",ev);}
onInput(ev){this.dependencies.history.addStep();this.dispatchTo("input_handlers",ev);}}
return __exports;});;

/* /html_editor/static/src/core/line_break_plugin.js */
odoo.define('@html_editor/core/line_break_plugin',['@html_editor/utils/dom','@html_editor/plugin','@html_editor/utils/content_types','@html_editor/utils/dom_state','@html_editor/utils/position','@html_editor/utils/dom_traversal','@html_editor/utils/blocks','@html_editor/utils/dom_info'],function(require){'use strict';let __exports={};const{splitTextNode}=require("@html_editor/utils/dom");const{Plugin}=require("@html_editor/plugin");const{CTGROUPS,CTYPES}=require("@html_editor/utils/content_types");const{getState,isFakeLineBreak,prepareUpdate}=require("@html_editor/utils/dom_state");const{DIRECTIONS,leftPos,rightPos}=require("@html_editor/utils/position");const{closestElement}=require("@html_editor/utils/dom_traversal");const{closestBlock,isBlock}=require("@html_editor/utils/blocks");const{nextLeaf}=require("@html_editor/utils/dom_info");const LineBreakPlugin=__exports.LineBreakPlugin=class LineBreakPlugin extends Plugin{static dependencies=["selection","history","input","delete"];static id="lineBreak";static shared=["insertLineBreak","insertLineBreakNode","insertLineBreakElement"];resources={beforeinput_handlers:this.onBeforeInput.bind(this),legit_feff_predicates:[(node)=>!node.nextSibling&&!isBlock(closestElement(node))&&nextLeaf(node,closestBlock(node)),],};insertLineBreak(){this.dispatchTo("before_line_break_handlers");let selection=this.dependencies.selection.getSelectionData().deepEditableSelection;if(!selection.isCollapsed){this.dependencies.delete.deleteSelection();selection=this.dependencies.selection.getEditableSelection();}else if(!closestElement(selection.anchorNode).isContentEditable){selection=this.dependencies.selection.getEditableSelection();}
const targetNode=selection.anchorNode;const targetOffset=selection.anchorOffset;this.insertLineBreakNode({targetNode,targetOffset});this.dependencies.history.addStep();}
insertLineBreakNode({targetNode,targetOffset}){const closestEl=closestElement(targetNode);if(closestEl&&!closestEl.isContentEditable){return;}
if(targetNode.nodeType===Node.TEXT_NODE){targetOffset=splitTextNode(targetNode,targetOffset);targetNode=targetNode.parentElement;}
if(this.delegateTo("insert_line_break_element_overrides",{targetNode,targetOffset})){return;}
this.insertLineBreakElement({targetNode,targetOffset});}
insertLineBreakElement({targetNode,targetOffset}){const closestEl=closestElement(targetNode);if(closestEl&&!closestEl.isContentEditable){return;}
const restore=prepareUpdate(targetNode,targetOffset);const brEl=this.document.createElement("br");const brEls=[brEl];if(targetOffset>=targetNode.childNodes.length){targetNode.appendChild(brEl);if(!isBlock(closestElement(targetNode))&&nextLeaf(targetNode,closestBlock(targetNode))){targetNode.appendChild(this.document.createTextNode("\uFEFF"));}}else{targetNode.insertBefore(brEl,targetNode.childNodes[targetOffset]);}
if(isFakeLineBreak(brEl)&&!(getState(...leftPos(brEl),DIRECTIONS.LEFT).cType&(CTGROUPS.BLOCK|CTYPES.BR))){const brEl2=this.document.createElement("br");brEl.before(brEl2);brEls.unshift(brEl2);}
restore();for(const el of brEls){if(el.parentNode){const pos=rightPos(el);this.dependencies.selection.setSelection({anchorNode:pos[0],anchorOffset:pos[1],});break;}}}
onBeforeInput(e){if(e.inputType==="insertLineBreak"){e.preventDefault();this.insertLineBreak();}}}
return __exports;});;

/* /html_editor/static/src/core/no_inline_root_plugin.js */
odoo.define('@html_editor/core/no_inline_root_plugin',['@html_editor/utils/dom_info','@html_editor/plugin','@html_editor/core/selection_plugin','@html_editor/utils/position','@html_editor/utils/dom_traversal'],function(require){'use strict';let __exports={};const{getDeepestPosition,isParagraphRelatedElement}=require("@html_editor/utils/dom_info");const{Plugin}=require("@html_editor/plugin");const{isNotAllowedContent}=require("@html_editor/core/selection_plugin");const{endPos,startPos}=require("@html_editor/utils/position");const{childNodes}=require("@html_editor/utils/dom_traversal");const NoInlineRootPlugin=__exports.NoInlineRootPlugin=class NoInlineRootPlugin extends Plugin{static id="noInlineRoot";static dependencies=["baseContainer","selection","history"];resources={fix_selection_on_editable_root_overrides:this.fixSelectionOnEditableRoot.bind(this),};setup(){this.addDomListener(this.editable,"keydown",(ev)=>{this.currentKeyDown=ev.key;});this.addDomListener(this.editable,"pointerdown",()=>{this.isPointerDown=true;});this.addDomListener(this.editable,"pointerup",()=>{this.isPointerDown=false;});}
fixSelectionOnEditableRoot(selection){if(!selection.isCollapsed||selection.anchorNode!==this.editable){return false;}
const children=childNodes(this.editable);const nodeAfterCursor=children[selection.anchorOffset];const nodeBeforeCursor=children[selection.anchorOffset-1];const key=this.currentKeyDown;delete this.currentKeyDown;if(key?.startsWith("Arrow")){return this.fixSelectionOnEditableRootArrowKeys(nodeAfterCursor,nodeBeforeCursor,key);}
return this.fixSelectionOnEditableRootGeneric(nodeAfterCursor,nodeBeforeCursor);}
fixSelectionOnEditableRootArrowKeys(nodeAfterCursor,nodeBeforeCursor,key){if(!["ArrowRight","ArrowLeft","ArrowUp","ArrowDown"].includes(key)){return false;}
const directionForward=["ArrowRight","ArrowDown"].includes(key);let node=directionForward?nodeAfterCursor:nodeBeforeCursor;while(node&&isNotAllowedContent(node)){node=directionForward?node.nextElementSibling:node.previousElementSibling;}
if(!node){return false;}
let[anchorNode,anchorOffset]=directionForward?startPos(node):endPos(node);[anchorNode,anchorOffset]=getDeepestPosition(anchorNode,anchorOffset);this.dependencies.selection.setSelection({anchorNode,anchorOffset});return true;}
fixSelectionOnEditableRootGeneric(nodeAfterCursor,nodeBeforeCursor){if(isParagraphRelatedElement(nodeAfterCursor)){this.dependencies.selection.setCursorStart(nodeAfterCursor);return true;}
if(isParagraphRelatedElement(nodeBeforeCursor)){this.dependencies.selection.setCursorEnd(nodeBeforeCursor);return true;}
return false;}}
return __exports;});;

/* /html_editor/static/src/core/overlay.js */
odoo.define('@html_editor/core/overlay',['@odoo/owl','@web/core/overlay/overlay_container','@web/core/position/position_hook','@web/core/ui/ui_service'],function(require){'use strict';let __exports={};const{Component,onWillDestroy,useEffect,useExternalListener,useRef,useState,useSubEnv,xml,}=require("@odoo/owl");const{OVERLAY_SYMBOL}=require("@web/core/overlay/overlay_container");const{usePosition}=require("@web/core/position/position_hook");const{useActiveElement}=require("@web/core/ui/ui_service");const EditorOverlay=__exports.EditorOverlay=class EditorOverlay extends Component{static template=xml`
        <div t-ref="root" class="overlay" t-att-class="props.className" t-on-pointerdown.stop="() => {}">
            <t t-component="props.Component" t-props="props.props"/>
        </div>`;static props={target:{validate:(el)=>el.nodeType===Node.ELEMENT_NODE,optional:true},initialSelection:{type:Object,optional:true},Component:Function,props:{type:Object,optional:true},editable:{validate:(el)=>el.nodeType===Node.ELEMENT_NODE},bus:Object,shared:Object,close:Function,isOverlayOpen:Function,positionOptions:{type:Object,optional:true},className:{type:String,optional:true},closeOnPointerdown:{type:Boolean,optional:true},hasAutofocus:{type:Boolean,optional:true},};static defaultProps={className:"",closeOnPointerdown:true,hasAutofocus:false,};setup(){this.lastSelection=this.props.initialSelection;const editable=this.props.editable;let getTarget,position;if(this.props.target){getTarget=()=>this.props.target;}else{this.rangeElement=editable.ownerDocument.createElement("range-el");editable.after(this.rangeElement);onWillDestroy(()=>{this.rangeElement.remove();});getTarget=this.getSelectionTarget.bind(this);}
useExternalListener(this.props.bus,"updatePosition",()=>{position.unlock();});const rootRef=useRef("root");if(this.props.positionOptions?.updatePositionOnResize??true){const resizeObserver=new ResizeObserver(()=>{position.unlock();});useEffect((root)=>{resizeObserver.observe(root);return()=>{resizeObserver.unobserve(root);};},()=>[rootRef.el]);}
if(this.props.closeOnPointerdown){const clickAway=(ev)=>{if(!this.env[OVERLAY_SYMBOL]?.contains(ev.composedPath()[0])){this.props.close();}};const editableDocument=this.props.editable.ownerDocument;useExternalListener(editableDocument,"pointerdown",clickAway);if(editableDocument!==document){useExternalListener(document,"pointerdown",clickAway);}}
if(this.props.hasAutofocus){useActiveElement("root");}
const topDocument=editable.ownerDocument.defaultView.top.document;const scrollContainer=getScrollContainer(editable);const container=scrollContainer||topDocument.documentElement;const resizeObserver=new ResizeObserver(()=>position.unlock());resizeObserver.observe(container);onWillDestroy(()=>resizeObserver.disconnect());const positionOptions={position:"bottom-start",container:container,...this.props.positionOptions,onPositioned:(el,solution)=>{this.props.positionOptions?.onPositioned?.(el,solution);this.updateVisibility(el,solution,scrollContainer);},};position=usePosition("root",getTarget,positionOptions);this.overlayState=useState({isOverlayVisible:true});useSubEnv({overlayState:this.overlayState});}
getSelectionTarget(){const doc=this.props.editable.ownerDocument;const selection=doc.getSelection();const selectionData=this.props.shared.getSelectionData();if(!selection||!selection.rangeCount||!this.props.isOverlayOpen()){return null;}
const inEditable=selectionData.currentSelectionIsInEditable;let range;if(inEditable){range=selection.getRangeAt(0);this.lastSelection={range};}else{if(!this.lastSelection){return null;}
range=this.lastSelection.range;}
let rect=range.getBoundingClientRect();if(rect.x===0&&rect.width===0&&rect.height===0){this.props.shared.ignoreDOMMutations(()=>{const clonedRange=range.cloneRange();const shadowCaret=doc.createTextNode("|");clonedRange.insertNode(shadowCaret);clonedRange.selectNode(shadowCaret);rect=clonedRange.getBoundingClientRect();shadowCaret.remove();clonedRange.detach();});}
this.rangeElement.getBoundingClientRect=()=>rect;return this.rangeElement;}
updateVisibility(overlayElement,solution,scrollContainer){if(this.env.isSmall){return;}
const shouldBeVisible=this.shouldOverlayBeVisible(overlayElement,solution,scrollContainer);overlayElement.style.visibility=shouldBeVisible?"visible":"hidden";this.overlayState.isOverlayVisible=shouldBeVisible;}
shouldOverlayBeVisible(overlayElement,solution,scrollContainer){if(!scrollContainer){return true;}
const scrollContainerRect=scrollContainer.getBoundingClientRect();const top=Math.max(scrollContainerRect.top,0);const bottom=top+scrollContainerRect.height;const overflowsTop=solution.top<top;const overflowsBottom=solution.top+overlayElement.offsetHeight>bottom;const canFlip=this.props.positionOptions?.flip??true;if(overflowsTop){if(overflowsBottom){return true;}
if(solution.direction==="top"&&canFlip){return true;}
return false;}
if(overflowsBottom){if(solution.direction==="bottom"&&canFlip){return true;}
return false;}
return true;}}
__exports.getScrollContainer=getScrollContainer;function getScrollContainer(el){const isScrollable=(el)=>{if(el.tagName==="HTML"){return el.scrollHeight>el.ownerDocument.defaultView.visualViewport.height;}
return(el.scrollHeight>el.clientHeight&&/\bauto\b|\bscroll\b/.test(getComputedStyle(el)["overflow-y"]));};const isFixed=(el)=>getComputedStyle(el).position==="fixed";while(el){if(isScrollable(el)){return el;}
if(isFixed(el)){el=el.ownerDocument.defaultView.frameElement;continue;}
el=el.parentElement||el.ownerDocument.defaultView.frameElement;}
return null;}
return __exports;});;

/* /html_editor/static/src/core/overlay_plugin.js */
odoo.define('@html_editor/core/overlay_plugin',['@odoo/owl','@html_editor/plugin','@html_editor/core/overlay'],function(require){'use strict';let __exports={};const{markRaw,EventBus}=require("@odoo/owl");const{Plugin}=require("@html_editor/plugin");const{EditorOverlay}=require("@html_editor/core/overlay");const OverlayPlugin=__exports.OverlayPlugin=class OverlayPlugin extends Plugin{static id="overlay";static dependencies=["history","selection"];static shared=["createOverlay"];overlays=[];destroy(){super.destroy();for(const overlay of this.overlays){overlay.close();}}
createOverlay(Component,props={},options){const overlay=new Overlay(this,Component,props,options);this.overlays.push(overlay);return overlay;}}
const Overlay=__exports.Overlay=class Overlay{constructor(plugin,C,props,options){this.plugin=plugin;this.C=C;this.editorOverlayProps=props;this.options=options;this.isOpen=false;this._remove=null;this.component=null;this.bus=new EventBus();}
open({target,props}){if(this.isOpen){this.updatePosition();}else{this.isOpen=true;const selection=this.plugin.editable.ownerDocument.getSelection();let initialSelection;if(selection&&selection.type!=="None"){initialSelection={range:selection.getRangeAt(0),};}
this._remove=this.plugin.services.overlay.add(EditorOverlay,markRaw({...this.editorOverlayProps,Component:this.C,editable:this.plugin.editable,props,target,initialSelection,bus:this.bus,close:this.close.bind(this),isOverlayOpen:this.isOverlayOpen.bind(this),shared:{ignoreDOMMutations:this.plugin.dependencies.history.ignoreDOMMutations,getSelectionData:this.plugin.dependencies.selection.getSelectionData,},}),{...this.options,});}}
close(){this.isOpen=false;if(this._remove){this._remove();}}
isOverlayOpen(){return this.isOpen;}
updatePosition(){this.bus.trigger("updatePosition");}}
return __exports;});;

/* /html_editor/static/src/core/protected_node_plugin.js */
odoo.define('@html_editor/core/protected_node_plugin',['@html_editor/plugin','@html_editor/utils/dom_info','@html_editor/utils/dom_traversal','@html_editor/utils/resource'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{isProtecting,isUnprotecting}=require("@html_editor/utils/dom_info");const{childNodes}=require("@html_editor/utils/dom_traversal");const{withSequence}=require("@html_editor/utils/resource");const PROTECTED_SELECTOR=`[data-oe-protected="true"],[data-oe-protected=""]`;const UNPROTECTED_SELECTOR=`[data-oe-protected="false"]`;const ProtectedNodePlugin=__exports.ProtectedNodePlugin=class ProtectedNodePlugin extends Plugin{static id="protectedNode";static shared=["setProtectingNode"];resources={clean_for_save_handlers:({root})=>this.cleanForSave(root),normalize_handlers:withSequence(0,this.normalize.bind(this)),before_filter_mutation_record_handlers:this.beforeFilteringMutationRecords.bind(this),unsplittable_node_predicates:[isProtecting,isUnprotecting,],savable_mutation_record_predicates:this.isMutationRecordSavable.bind(this),removable_descendants_providers:this.filterDescendantsToRemove.bind(this),};setup(){this.protectedNodes=new WeakSet();}
filterDescendantsToRemove(elem){if(isProtecting(elem)){const descendantsToRemove=[];for(const candidate of elem.querySelectorAll(UNPROTECTED_SELECTOR)){if(candidate.closest(PROTECTED_SELECTOR)===elem){descendantsToRemove.push(...childNodes(candidate));}}
return descendantsToRemove;}}
protectNode(node){if(node.nodeType===Node.ELEMENT_NODE){if(node.matches(UNPROTECTED_SELECTOR)){this.unProtectDescendants(node);}else if(!this.protectedNodes.has(node)){this.protectDescendants(node);}}
this.protectedNodes.add(node);}
unProtectNode(node){if(node.nodeType===Node.ELEMENT_NODE){if(node.matches(PROTECTED_SELECTOR)){this.protectDescendants(node);}else if(this.protectedNodes.has(node)){this.unProtectDescendants(node);}}
this.protectedNodes.delete(node);}
protectDescendants(node){let child=node.firstChild;while(child){this.protectNode(child);child=child.nextSibling;}}
unProtectDescendants(node){let child=node.firstChild;while(child){this.unProtectNode(child);child=child.nextSibling;}}
beforeFilteringMutationRecords(records){for(const record of records){if(record.type==="childList"){if(record.target.nodeType!==Node.ELEMENT_NODE){return;}
const addedNodes=record.addedTrees.map((tree)=>tree.node);if((this.protectedNodes.has(record.target)&&!record.target.matches(UNPROTECTED_SELECTOR))||record.target.matches(PROTECTED_SELECTOR)){for(const addedNode of addedNodes){this.protectNode(addedNode);}}else if(!this.protectedNodes.has(record.target)||record.target.matches(UNPROTECTED_SELECTOR)){for(const addedNode of addedNodes){this.unProtectNode(addedNode);}}}}}
isMutationRecordSavable(record){if(record.type==="childList"){return!((this.protectedNodes.has(record.target)&&!record.target.matches(UNPROTECTED_SELECTOR))||record.target.matches(PROTECTED_SELECTOR));}
return!this.protectedNodes.has(record.target);}
forEachProtectingElem(elem,callback){const selector=`[data-oe-protected]`;const protectingNodes=[...elem.querySelectorAll(selector)].reverse();if(elem.matches(selector)){protectingNodes.push(elem);}
for(const protectingNode of protectingNodes){if(protectingNode.dataset.oeProtected==="false"){callback(protectingNode,false);}else{callback(protectingNode,true);}}}
normalize(elem){this.forEachProtectingElem(elem,this.setProtectingNode.bind(this));}
setProtectingNode(elem,protecting){elem.dataset.oeProtected=protecting;if(protecting){elem.setAttribute("contenteditable","false");this.protectDescendants(elem);}else{elem.setAttribute("contenteditable","true");this.unProtectDescendants(elem);}}
cleanForSave(clone){this.forEachProtectingElem(clone,(protectingNode)=>{protectingNode.removeAttribute("contenteditable");});}}
return __exports;});;

/* /html_editor/static/src/core/sanitize_plugin.js */
odoo.define('@html_editor/core/sanitize_plugin',['@html_editor/utils/dom_traversal','@html_editor/plugin'],function(require){'use strict';let __exports={};const{selectElements}=require("@html_editor/utils/dom_traversal");const{Plugin}=require("@html_editor/plugin");const SanitizePlugin=__exports.SanitizePlugin=class SanitizePlugin extends Plugin{static id="sanitize";static shared=["sanitize"];resources={clean_for_save_handlers:this.cleanForSave.bind(this),normalize_handlers:this.normalize.bind(this),};setup(){if(!window.DOMPurify){throw new Error("DOMPurify is not available");}
this.DOMPurify=DOMPurify(this.window);}
sanitize(elem){return this.DOMPurify.sanitize(elem,{IN_PLACE:true,ADD_TAGS:["#document-fragment","fake-el"],ADD_ATTR:["contenteditable","t-field","t-out","t-esc"],});}
normalize(element){for(const el of selectElements(element,".o-contenteditable-false, .o-contenteditable-true")){el.contentEditable=el.matches(".o-contenteditable-true");}
for(const el of selectElements(element,"[data-oe-role]")){el.setAttribute("role",el.dataset.oeRole);}
for(const el of selectElements(element,"[data-oe-aria-label]")){el.setAttribute("aria-label",el.dataset.oeAriaLabel);}}
cleanForSave({root}){for(const el of selectElements(root,".o-contenteditable-false, .o-contenteditable-true")){el.removeAttribute("contenteditable");}
for(const el of selectElements(root,"[data-oe-role]")){el.removeAttribute("role");}
for(const el of selectElements(root,"[data-oe-aria-label]")){el.removeAttribute("aria-label");}}}
return __exports;});;

/* /html_editor/static/src/core/selection_plugin.js */
odoo.define('@html_editor/core/selection_plugin',['@html_editor/utils/blocks','@html_editor/utils/dom_info','@html_editor/utils/dom_traversal','@web/core/hotkeys/hotkey_service','@html_editor/plugin','@html_editor/utils/position','@html_editor/utils/selection','@web/core/utils/scrolling','@html_editor/utils/functions'],function(require){'use strict';let __exports={};const{closestBlock}=require("@html_editor/utils/blocks");const{getDeepestPosition,isMediaElement,isProtected,isProtecting,isUnprotecting,}=require("@html_editor/utils/dom_info");const{childNodes,closestElement,descendants,firstLeaf,lastLeaf,}=require("@html_editor/utils/dom_traversal");const{getActiveHotkey}=require("@web/core/hotkeys/hotkey_service");const{Plugin}=require("@html_editor/plugin");const{DIRECTIONS,leftPos,nodeSize,rightPos}=require("@html_editor/utils/position");const{getAdjacentCharacter,normalizeDeepCursorPosition,normalizeFakeBR,normalizeNotEditableNode,normalizeSelfClosingElement,}=require("@html_editor/utils/selection");const{closestScrollableY}=require("@web/core/utils/scrolling");const{weakMemoize}=require("@html_editor/utils/functions");const VOID_ELEMENT_NAMES=["AREA","BASE","BR","COL","EMBED","HR","IMG","INPUT","KEYGEN","LINK","META","PARAM","SOURCE","TRACK","WBR",];__exports.isArtificialVoidElement=isArtificialVoidElement;function isArtificialVoidElement(node){return isMediaElement(node)||node.nodeName==="HR";}
__exports.isNotAllowedContent=isNotAllowedContent;function isNotAllowedContent(node){return isArtificialVoidElement(node)||VOID_ELEMENT_NAMES.includes(node.nodeName);}
const isHtmlContentSupported=__exports.isHtmlContentSupported=weakMemoize((selection)=>!closestElement(selection.focusNode,'[data-oe-model]:not([data-oe-type="html"]):not([data-oe-field="arch"]):not([data-oe-translation-source-sha])'));function getUnselectedEdgeTextNodes(selection){const startEdgeNodes=(node,offset)=>node===selection.commonAncestorContainer||offset<nodeSize(node)?[]:[node,...startEdgeNodes(...rightPos(node))];const endEdgeNodes=(node,offset)=>node===selection.commonAncestorContainer||offset>0?[]:[node,...endEdgeNodes(...leftPos(node))];return new Set([...startEdgeNodes(selection.startContainer,selection.startOffset),...endEdgeNodes(selection.endContainer,selection.endOffset),].filter((node)=>node.nodeType===Node.TEXT_NODE));}
function scrollToSelection(selection){const range=selection.getRangeAt(0);const container=closestScrollableY(range.startContainer.parentElement);if(!container){return;}
let rect=range.getBoundingClientRect();if(rect.width===0&&rect.height===0&&selection.isCollapsed){rect=closestElement(selection.anchorNode).getBoundingClientRect();}
const containerRect=container.getBoundingClientRect();const offsetTop=rect.top-containerRect.top+container.scrollTop;const offsetBottom=rect.bottom-containerRect.top+container.scrollTop;if(rect.bottom>containerRect.top&&rect.top<containerRect.bottom){return;}
if(rect.top<containerRect.top){container.scrollTo({top:offsetTop,behavior:"instant"});}else if(rect.bottom>containerRect.bottom){container.scrollTo({top:offsetBottom-container.clientHeight,behavior:"instant"});}}
const SelectionPlugin=__exports.SelectionPlugin=class SelectionPlugin extends Plugin{static id="selection";static shared=["getSelectionData","getEditableSelection","setSelection","setCursorStart","setCursorEnd","extractContent","preserveSelection","resetSelection","getTargetedNodes","getTargetedBlocks","modifySelection","rectifySelection","areNodeContentsFullySelected","focusEditable","isSelectionInEditable","isNodeEditable","selectAroundNonEditable",];resources={user_commands:{id:"selectAll",run:this.selectAll.bind(this)},shortcuts:[{hotkey:"control+a",commandId:"selectAll"}],};setup(){this.resetSelection();this.addGlobalDomListener("selectionchange",()=>{this.updateActiveSelection();const selection=this.document.getSelection();if(this.isSelectionInEditable(selection)){scrollToSelection(selection);}});this.addDomListener(this.editable,"mousedown",(ev)=>{if(ev.detail&&ev.detail%3===2){this.onDoubleClick(ev);}
if(ev.detail&&ev.detail%3===0){this.onTripleClick(ev);}});this.addDomListener(this.editable,"keydown",(ev)=>{const handled=["arrowright","shift+arrowright","arrowleft","shift+arrowleft","shift+arrowup","shift+arrowdown",];if(handled.includes(getActiveHotkey(ev))){this.onKeyDownArrows(ev);}});this.focusEditableDocument=true;if(this.document!==document){const focusEditable=()=>{this.focusEditableDocument=true;};const unFocusEditable=(ev)=>{if(this.focusEditableDocument){if(ev.target.tagName==="IFRAME"){return;}
const preventClosing=ev.target?.closest?.("[data-prevent-closing-overlay]");if(preventClosing?.dataset?.preventClosingOverlay==="true"){return;}
this.focusEditableDocument=false;this.dispatchTo("selection_leave_handlers");}};this.addDomListener(this.document,"focusin",focusEditable,{capture:true});this.addDomListener(document,"focusin",unFocusEditable,{capture:true});this.addDomListener(this.document,"pointerdown",focusEditable,{capture:true});this.addDomListener(document,"pointerdown",unFocusEditable,{capture:true});}}
selectAll(){const selection=this.getEditableSelection();const containerSelector="#wrap > *, .oe_structure > *, [contenteditable]";const container=selection&&closestElement(selection.anchorNode,containerSelector);const[anchorNode,anchorOffset]=getDeepestPosition(container,0);const[focusNode,focusOffset]=getDeepestPosition(container,nodeSize(container));if(this.delegateTo("select_all_overrides",{anchorNode,anchorOffset,focusNode,focusOffset,})){return;}
this.setSelection({anchorNode,anchorOffset,focusNode,focusOffset});}
resetSelection(){this.activeSelection=this.makeActiveSelection();}
onDoubleClick(ev){const selectionData=this.getSelectionData();if(selectionData.documentSelectionIsInEditable){if(this.delegateTo("double_click_overrides",ev)){return;}}}
onTripleClick(ev){const selectionData=this.getSelectionData();if(selectionData.documentSelectionIsInEditable){if(this.delegateTo("triple_click_overrides",ev)){return;}
const{documentSelection}=selectionData;const block=closestBlock(documentSelection.anchorNode);const[anchorNode,anchorOffset]=getDeepestPosition(block,0);const[focusNode,focusOffset]=getDeepestPosition(block,nodeSize(block));this.setSelection({anchorNode,anchorOffset,focusNode,focusOffset});ev.preventDefault();return;}}
updateActiveSelection(){this.previousActiveSelection=this.activeSelection;const selectionData=this.getSelectionData();if(this.fixSelectionOnEditableRoot(selectionData)){return;}
this.dispatchTo("selectionchange_handlers",selectionData);}
makeActiveSelection(selection){let range;let activeSelection;if(!selection||!selection.rangeCount){const[targetNode,targetOffset]=this.config.allowInlineAtRoot?[this.editable,0]:getDeepestPosition(this.editable,0);activeSelection={anchorNode:targetNode,anchorOffset:targetOffset,focusNode:targetNode,focusOffset:targetOffset,startContainer:targetNode,startOffset:targetOffset,endContainer:targetNode,endOffset:targetOffset,commonAncestorContainer:targetNode,isCollapsed:true,direction:DIRECTIONS.RIGHT,textContent:()=>"",intersectsNode:()=>false,};}else{range=selection.getRangeAt(0);let{anchorNode,anchorOffset,focusNode,focusOffset}=selection;let direction=anchorNode===range.startContainer?DIRECTIONS.RIGHT:DIRECTIONS.LEFT;if(anchorNode===focusNode&&focusOffset<anchorOffset){direction=!direction;}
if(this.activeSelection&&(isProtecting(anchorNode)||(isProtected(anchorNode)&&!isUnprotecting(anchorNode)))){return this.activeSelection;}
[anchorNode,anchorOffset]=normalizeSelfClosingElement(anchorNode,anchorOffset);[focusNode,focusOffset]=normalizeSelfClosingElement(focusNode,focusOffset);const[startContainer,startOffset,endContainer,endOffset]=direction===DIRECTIONS.RIGHT?[anchorNode,anchorOffset,focusNode,focusOffset]:[focusNode,focusOffset,anchorNode,anchorOffset];range=this.document.createRange();range.setStart(startContainer,startOffset);range.setEnd(endContainer,endOffset);activeSelection={anchorNode,anchorOffset,focusNode,focusOffset,startContainer,startOffset,endContainer,endOffset,commonAncestorContainer:range.commonAncestorContainer,isCollapsed:range.collapsed,direction,textContent:()=>(range.collapsed?"":selection.toString()),intersectsNode:(node)=>range.intersectsNode(node),};}
Object.freeze(activeSelection);return activeSelection;}
extractContent(selection){const range=new Range();range.setStart(selection.startContainer,selection.startOffset);range.setEnd(selection.endContainer,selection.endOffset);this.setSelection({anchorNode:selection.startContainer,anchorOffset:selection.startOffset,});return range.extractContents();}
createEditorSelection(anchorNode,anchorOffset,focusNode,focusOffset,direction){let startContainer,startOffset,endContainer,endOffset;const range=new Range();if(direction){[startContainer,startOffset]=[anchorNode,anchorOffset];[endContainer,endOffset]=[focusNode,focusOffset];}else{[startContainer,startOffset]=[focusNode,focusOffset];[endContainer,endOffset]=[anchorNode,anchorOffset];}
range.setStart(startContainer,startOffset);range.setEnd(endContainer,endOffset);return Object.freeze({...this.activeSelection,anchorNode,anchorOffset,focusNode,focusOffset,startContainer,startOffset,endContainer,endOffset,commonAncestorContainer:range.commonAncestorContainer,cloneContents:()=>range.cloneContents(),});}
getEditableSelection(){return this.getSelectionData().editableSelection;}
getSelectionData(){const selection=this.document.getSelection();const documentSelectionIsInEditable=selection&&this.isSelectionInEditable(selection);const documentSelection=selection?.anchorNode&&selection?.focusNode?Object.freeze({get isCollapsed(){if(this.collapsed===undefined){this.collapsed=selection.isCollapsed;}
return this.collapsed;},anchorNode:selection.anchorNode,anchorOffset:selection.anchorOffset,focusNode:selection.focusNode,focusOffset:selection.focusOffset,commonAncestorContainer:selection.rangeCount?selection.getRangeAt(0).commonAncestorContainer:null,}):null;if(documentSelectionIsInEditable){this.activeSelection=this.makeActiveSelection(selection);}else if(!this.activeSelection.anchorNode.isConnected){this.activeSelection=this.makeActiveSelection();}
let{anchorNode,anchorOffset,focusNode,focusOffset,isCollapsed,direction}=this.activeSelection;const editableSelection=this.createEditorSelection(anchorNode,anchorOffset,focusNode,focusOffset,direction);const selectionData={documentSelection:documentSelection,editableSelection:editableSelection,documentSelectionIsInEditable:documentSelectionIsInEditable,currentSelectionIsInEditable:documentSelectionIsInEditable&&this.focusEditableDocument,};Object.defineProperty(selectionData,"deepEditableSelection",{get:function(){[anchorNode,anchorOffset]=getDeepestPosition(anchorNode,anchorOffset);[focusNode,focusOffset]=isCollapsed?[anchorNode,anchorOffset]:getDeepestPosition(focusNode,focusOffset);return this.createEditorSelection(anchorNode,anchorOffset,focusNode,focusOffset,direction);}.bind(this),});Object.defineProperty(selectionData,"documentSelectionIsProtecting",{get:function(){return documentSelection?.anchorNode?isProtecting(documentSelection.anchorNode):false;}.bind(this),});Object.defineProperty(selectionData,"documentSelectionIsProtected",{get:function(){return documentSelection?.anchorNode?isProtected(documentSelection.anchorNode):false;}.bind(this),});return Object.freeze(selectionData);}
validateSelection({anchorNode,anchorOffset,focusNode,focusOffset}){const validateNode=(node)=>{if(!this.editable.contains(node)){console.warn("Invalid selection. Node is not part of the editable:",node);return false;}
return true;};const validateOffset=(node,offset)=>{if(offset<0||offset>nodeSize(node)){console.warn("Invalid selection. Offset is out of bounds:",offset,node);return false;}
return true;};const isCollapsed=anchorNode===focusNode&&anchorOffset===focusOffset;return(validateNode(anchorNode)&&(focusNode===anchorNode||validateNode(focusNode))&&validateOffset(anchorNode,anchorOffset)&&(isCollapsed||validateOffset(focusNode,focusOffset)));}
setSelection({anchorNode,anchorOffset,focusNode=anchorNode,focusOffset=anchorOffset},{normalize=true}={}){if(!this.validateSelection({anchorNode,anchorOffset,focusNode,focusOffset})){return null;}
const restore=this.preserveTextareaSelections();const isCollapsed=anchorNode===focusNode&&anchorOffset===focusOffset;[focusNode,focusOffset]=normalizeSelfClosingElement(focusNode,focusOffset,"right");[anchorNode,anchorOffset]=isCollapsed?[focusNode,focusOffset]:normalizeSelfClosingElement(anchorNode,anchorOffset,"left");if(normalize){[anchorNode,anchorOffset]=normalizeDeepCursorPosition(anchorNode,anchorOffset);[focusNode,focusOffset]=isCollapsed?[anchorNode,anchorOffset]:normalizeDeepCursorPosition(focusNode,focusOffset);}
[anchorNode,anchorOffset]=normalizeFakeBR(anchorNode,anchorOffset);[focusNode,focusOffset]=normalizeFakeBR(focusNode,focusOffset);const selection=this.document.getSelection();const documentSelectionIsInEditable=selection&&this.isSelectionInEditable(selection);if(selection){if(documentSelectionIsInEditable||selection.anchorNode===null){selection.setBaseAndExtent(anchorNode,anchorOffset,focusNode,focusOffset);this.activeSelection=this.makeActiveSelection(selection,true);}else{let range=new Range();range.setStart(anchorNode,anchorOffset);range.setEnd(focusNode,focusOffset);if(anchorNode!==focusNode||anchorOffset!==focusOffset){if(range.collapsed){range=new Range();range.setEnd(anchorNode,anchorOffset);range.setStart(focusNode,focusOffset);}}
this.activeSelection=this.makeActiveSelection({anchorNode,anchorOffset,focusNode,focusOffset,getRangeAt:()=>range,rangeCount:1,});}}
restore();return this.activeSelection;}
preserveTextareaSelections(){const focusedTextarea=this.document.activeElement?.nodeName==="TEXTAREA"&&this.document.activeElement;const selections=[...this.editable.querySelectorAll("textarea")].map((textarea)=>({textarea,start:textarea.selectionStart,end:textarea.selectionEnd,direction:textarea.selectionDirection,}));return()=>{if(focusedTextarea){focusedTextarea.focus();}
for(const{textarea,start,end,direction}of selections){textarea.setSelectionRange(start,end,direction);}};}
setCursorStart(node){return this.setSelection({anchorNode:node,anchorOffset:0});}
setCursorEnd(node){return this.setSelection({anchorNode:node,anchorOffset:nodeSize(node)});}
preserveSelection(){const hadSelection=this.document.getSelection()&&this.document.getSelection().anchorNode!==null;const selectionData=this.getSelectionData();const selection=selectionData.editableSelection;const anchor={node:selection.anchorNode,offset:selection.anchorOffset};const focus={node:selection.focusNode,offset:selection.focusOffset};return{restore:()=>{if(!hadSelection){return;}
this.setSelection({anchorNode:anchor.node,anchorOffset:anchor.offset,focusNode:focus.node,focusOffset:focus.offset,},{normalize:false});},update(callback){callback(anchor);callback(focus);return this;},remapNode(node,newNode){return this.update((cursor)=>{if(cursor.node===node){cursor.node=newNode;}});},setOffset(node,newOffset){return this.update((cursor)=>{if(cursor.node===node){cursor.offset=newOffset;}});},shiftOffset(node,shiftOffset){return this.update((cursor)=>{if(cursor.node===node){cursor.offset+=shiftOffset;}});},};}
areNodeContentsFullySelected(node){const selection=this.getEditableSelection();const range=new Range();range.setStart(selection.startContainer,selection.startOffset);range.setEnd(selection.endContainer,selection.endOffset);const firstLeafNode=firstLeaf(node);const lastLeafNode=lastLeaf(node);return(this.getResource("fully_selected_node_predicates").some((cb)=>cb(node,selection,range))||(range.isPointInRange(firstLeafNode,0)&&range.isPointInRange(lastLeafNode,nodeSize(lastLeafNode))));}
getTargetedNodes(){const selectionData=this.getSelectionData();const selection=selectionData.deepEditableSelection;const{commonAncestorContainer:root}=selectionData.editableSelection;let targetedNodes=[];if(selection.isCollapsed&&selection.anchorNode.nodeType!==Node.TEXT_NODE){targetedNodes=[root];}
targetedNodes.push(...descendants(root));if(!targetedNodes.length){targetedNodes=[root];}
targetedNodes=targetedNodes.filter((node)=>selectionData.editableSelection.intersectsNode(node)||(node.nodeType===Node.TEXT_NODE&&(node===selection.anchorNode||node===selection.focusNode)));const modifiers=[(nodes)=>(nodes[0]===this.editable?nodes.slice(1):nodes),(nodes)=>{if(selection.isCollapsed){return nodes;}else{const edgeTextNodes=getUnselectedEdgeTextNodes(selection);return nodes.filter((node)=>!edgeTextNodes.has(node));}},...this.getResource("targeted_nodes_processors"),];for(const modifier of modifiers){targetedNodes=modifier(targetedNodes);}
return targetedNodes;}
getTargetedBlocks(){return new Set(this.getTargetedNodes().map(closestBlock).filter(Boolean));}
fixSelectionOnEditableRoot(selectionData){const{editableSelection,documentSelectionIsInEditable}=selectionData;if(this.config.allowInlineAtRoot||!documentSelectionIsInEditable){return false;}
const isSelectionOnEditableRoot=(s)=>s.isCollapsed&&s.anchorNode===this.editable;if(!isSelectionOnEditableRoot(editableSelection)){return false;}
if(this.delegateTo("fix_selection_on_editable_root_overrides",editableSelection)){return true;}
if(isSelectionOnEditableRoot(this.previousActiveSelection)){return false;}
const selection=this.document.getSelection();if(!selection){return false;}
const{anchorNode,anchorOffset,focusNode,focusOffset}=this.previousActiveSelection;selection.setBaseAndExtent(anchorNode,anchorOffset,focusNode,focusOffset);return true;}
rectifySelection(selection){if(!this.isSelectionInEditable(selection)){return null;}
const anchorNode=selection.anchorNode;let anchorOffset=selection.anchorOffset;const focusNode=selection.focusNode;let focusOffset=selection.focusOffset;const anchorSize=nodeSize(anchorNode);const focusSize=nodeSize(focusNode);if(anchorSize<anchorOffset){anchorOffset=anchorSize;}
if(focusSize<focusOffset){focusOffset=focusSize;}
const anchorTarget=childNodes(anchorNode).at(anchorOffset);const focusTarget=childNodes(focusNode).at(focusOffset);const protectionCheck=(node)=>isProtecting(node)||(isProtected(node)&&!isUnprotecting(node));if(focusTarget!==anchorTarget&&focusTarget.previousSibling===anchorTarget&&protectionCheck(anchorTarget)){return;}
if(protectionCheck(anchorNode)||protectionCheck(focusNode)){return;}
return this.setSelection({anchorNode,anchorOffset,focusNode,focusOffset,});}
modifySelection(alter,direction,granularity){const selectionData=this.getSelectionData();if(!selectionData.documentSelectionIsInEditable){return selectionData.editableSelection;}
const selection=this.document.getSelection();if(!selection){return selectionData.editableSelection;}
selection.modify(alter,direction,granularity);if(!this.isSelectionInEditable(selection)){return this.setSelection(selectionData.editableSelection);}
this.activeSelection=this.makeActiveSelection(selection);return this.activeSelection;}
onKeyDownArrows(ev){const selection=this.document.getSelection();if(!selection||!this.isSelectionInEditable(selection)){return;}
const mode=ev.shiftKey?"extend":"move";if(["ArrowLeft","ArrowRight"].includes(ev.key)){const screenDirection=ev.key==="ArrowLeft"?"left":"right";const isRtl=closestElement(selection.focusNode,"[dir]")?.dir==="rtl";const domDirection=(screenDirection==="left")^isRtl?"previous":"next";const shouldSkipCallbacks=this.getResource("intangible_char_for_keyboard_navigation_predicates");let adjacentCharacter=getAdjacentCharacter(selection,domDirection,this.editable);let shouldSkip=shouldSkipCallbacks.some((cb)=>cb(ev,adjacentCharacter));while(shouldSkip){const{focusNode:nodeBefore,focusOffset:offsetBefore}=selection;selection.modify(mode,screenDirection,"character");const hasSelectionChanged=nodeBefore!==selection.focusNode||offsetBefore!==selection.focusOffset;const lastSkippedChar=adjacentCharacter;adjacentCharacter=getAdjacentCharacter(selection,domDirection,this.editable);shouldSkip=hasSelectionChanged&&shouldSkipCallbacks.some((cb)=>cb(ev,adjacentCharacter,lastSkippedChar));}}
const{focusNode,focusOffset}=selection;if(mode==="extend"){const selectingBackward=["ArrowLeft","ArrowUp"].includes(ev.key);const currentBlock=closestBlock(focusNode);const isAtBoundary=selectingBackward?firstLeaf(currentBlock)===focusNode&&focusOffset===0:lastLeaf(currentBlock)===focusNode&&focusOffset===nodeSize(focusNode);const adjacentBlock=selectingBackward?currentBlock.previousElementSibling:currentBlock.nextElementSibling;const targetBlock=selectingBackward?adjacentBlock?.previousElementSibling:adjacentBlock?.nextElementSibling;if(!adjacentBlock?.isContentEditable&&targetBlock&&isAtBoundary){const leafNode=selectingBackward?lastLeaf(targetBlock):firstLeaf(targetBlock);const offset=selectingBackward?nodeSize(leafNode):0;selection.extend(leafNode,offset);ev.preventDefault();}}}
isSelectionInEditable({anchorNode,focusNode}={}){return(!!anchorNode&&!!focusNode&&this.editable.contains(anchorNode)&&(focusNode===anchorNode||this.editable.contains(focusNode)));}
isNodeEditable(node){const results=this.getResource("is_node_editable_predicates").map((p)=>p(node)).filter((r)=>r!==undefined);if(!results.length){return node.parentElement?.isContentEditable;}
return results.every((r)=>r);}
focusEditable(){const{editableSelection,currentSelectionIsInEditable}=this.getSelectionData();if(this.editable.contains(this.document.activeElement)&&currentSelectionIsInEditable){return;}
const closestNonEditable=(node)=>closestElement(node,(el)=>!el.isContentEditable);if(!closestNonEditable(editableSelection.anchorNode)&&!closestNonEditable(editableSelection.focusNode)){this.editable.focus({preventScroll:true});}
if(!currentSelectionIsInEditable){const{anchorNode,anchorOffset,focusNode,focusOffset}=editableSelection;const selection=this.document.getSelection();if(selection){selection.setBaseAndExtent(anchorNode,anchorOffset,focusNode,focusOffset);}}}
selectAroundNonEditable(){const{editableSelection}=this.getSelectionData();const isInUneditable=(node)=>!!closestElement(node,(elem)=>!elem.isContentEditable);let{startContainer:start,endContainer:end}=editableSelection;if(!(isInUneditable(start)||(end!==start&&isInUneditable(end)))){return editableSelection;}
let{startOffset,endOffset,direction}=editableSelection;[start,startOffset]=normalizeNotEditableNode(start,startOffset,"left");[end,endOffset]=normalizeNotEditableNode(end,endOffset,"right");const[anchorNode,anchorOffset,focusNode,focusOffset]=direction?[start,startOffset,end,endOffset]:[end,endOffset,start,startOffset];return this.setSelection({anchorNode,anchorOffset,focusNode,focusOffset});}}
return __exports;});;

/* /html_editor/static/src/core/shortcut_plugin.js */
odoo.define('@html_editor/core/shortcut_plugin',['@html_editor/plugin','@html_editor/utils/blocks','@html_editor/utils/dom','@html_editor/utils/dom_state','@html_editor/utils/dom_traversal'],function(require){'use strict';let __exports={};const{Plugin,isValidTargetForDomListener}=require("@html_editor/plugin");const{closestBlock}=require("@html_editor/utils/blocks");const{fillEmpty}=require("@html_editor/utils/dom");const{leftLeafOnlyNotBlockPath}=require("@html_editor/utils/dom_state");const{closestElement}=require("@html_editor/utils/dom_traversal");const ShortCutPlugin=__exports.ShortCutPlugin=class ShortCutPlugin extends Plugin{static id="shortcut";static dependencies=["userCommand","selection"];resources={input_handlers:this.onInput.bind(this),};setup(){const hotkeyService=this.services.hotkey;if(!hotkeyService){throw new Error("ShorcutPlugin needs hotkey service to properly work");}
if(document!==this.document){hotkeyService.registerIframe({contentWindow:this.window});}
for(const shortcut of this.getResource("shortcuts")){const command=this.dependencies.userCommand.getCommand(shortcut.commandId);this.addShortcut(shortcut.hotkey,()=>{command.run(shortcut.commandParams);},{isAvailable:command.isAvailable,global:!!shortcut.global,});}}
addShortcut(hotkey,action,{isAvailable,global}){this._cleanups.push(this.services.hotkey.add(hotkey,action,{area:()=>this.editable,bypassEditableProtection:true,allowRepeat:true,isAvailable:(target)=>(!isAvailable||isAvailable(this.dependencies.selection.getEditableSelection()))&&(global||isValidTargetForDomListener(target)),}));}
onInput(ev){if(ev.data!==" "){return;}
const selection=this.dependencies.selection.getEditableSelection();const blockEl=closestBlock(selection.anchorNode);const leftDOMPath=leftLeafOnlyNotBlockPath(selection.anchorNode);let spaceOffset=selection.anchorOffset;let leftLeaf=leftDOMPath.next().value;while(leftLeaf){spaceOffset+=leftLeaf.length;leftLeaf=leftDOMPath.next().value;}
const precedingText=blockEl.textContent.substring(0,spaceOffset-1);const matchedShortcut=this.getResource("shorthands").find(({pattern})=>pattern.test(precedingText));if(matchedShortcut){const command=this.dependencies.userCommand.getCommand(matchedShortcut.commandId);if(command){this.dependencies.selection.setSelection({anchorNode:blockEl.firstChild,anchorOffset:0,focusNode:selection.focusNode,focusOffset:selection.focusOffset,});this.dependencies.selection.extractContent(this.dependencies.selection.getEditableSelection());fillEmpty(closestElement(selection.focusNode));command.run(matchedShortcut.commandParams);}}}}
return __exports;});;

/* /html_editor/static/src/core/split_plugin.js */
odoo.define('@html_editor/core/split_plugin',['@html_editor/utils/selection','@html_editor/plugin','@html_editor/utils/blocks','@html_editor/utils/dom','@html_editor/utils/dom_info','@html_editor/utils/dom_state','@html_editor/utils/dom_traversal','@html_editor/utils/position'],function(require){'use strict';let __exports={};const{callbacksForCursorUpdate}=require("@html_editor/utils/selection");const{Plugin}=require("@html_editor/plugin");const{isBlock}=require("@html_editor/utils/blocks");const{fillEmpty,splitTextNode}=require("@html_editor/utils/dom");const{isContentEditable,isContentEditableAncestor,isElement,isTextNode,isVisible,}=require("@html_editor/utils/dom_info");const{prepareUpdate}=require("@html_editor/utils/dom_state");const{childNodes,closestElement,descendants,firstLeaf,lastLeaf,}=require("@html_editor/utils/dom_traversal");const{DIRECTIONS,childNodeIndex,nodeSize}=require("@html_editor/utils/position");const{isProtected,isProtecting}=require("@html_editor/utils/dom_info");const SplitPlugin=__exports.SplitPlugin=class SplitPlugin extends Plugin{static dependencies=["baseContainer","selection","history","input","delete","lineBreak"];static id="split";static shared=["splitBlock","splitBlockNode","splitElementBlock","splitElement","splitAroundUntil","splitSelection","isUnsplittable",];resources={beforeinput_handlers:this.onBeforeInput.bind(this),unsplittable_node_predicates:[(node)=>this.getResource("unremovable_node_predicates").some((predicate)=>predicate(node)),(node)=>node.classList?.contains("oe_unbreakable"),(node)=>{const isExplicitlyNotContentEditable=(node)=>!isContentEditable(node)&&(node.isConnected||closestElement(node,"[contenteditable]"));return(isExplicitlyNotContentEditable(node)||(node.parentElement&&isContentEditableAncestor(node)&&isExplicitlyNotContentEditable(node.parentElement)));},(node)=>node.nodeName==="SECTION",],selection_blocker_predicates:(blocker)=>{if(this.isUnsplittable(blocker)){return true;}},};splitBlock(){this.dispatchTo("before_split_block_handlers");let selection=this.dependencies.selection.getSelectionData().deepEditableSelection;if(!selection.isCollapsed){this.dependencies.delete.deleteSelection();selection=this.dependencies.selection.getEditableSelection();}else if(!closestElement(selection.anchorNode).isContentEditable){selection=this.dependencies.selection.getEditableSelection();}
return this.splitBlockNode({targetNode:selection.anchorNode,targetOffset:selection.anchorOffset,});}
splitBlockNode({targetNode,targetOffset}){if(targetNode.nodeType===Node.TEXT_NODE){targetOffset=splitTextNode(targetNode,targetOffset);targetNode=targetNode.parentElement;}
const blockToSplit=closestElement(targetNode,isBlock);const params={targetNode,targetOffset,blockToSplit};if(this.delegateTo("split_element_block_overrides",params)){return[undefined,undefined];}
return this.splitElementBlock(params);}
splitElementBlock({targetNode,targetOffset,blockToSplit}){if(this.isUnsplittable(blockToSplit)){this.dependencies.lineBreak.insertLineBreakElement({targetNode,targetOffset});return[undefined,undefined];}
const restore=prepareUpdate(targetNode,targetOffset);const[beforeElement,afterElement]=this.splitElementUntil(targetNode,targetOffset,blockToSplit.parentElement);restore();const fillEmptyElement=(node)=>{if(isProtecting(node)||isProtected(node)){return;}else if(node.nodeType===Node.TEXT_NODE&&!isVisible(node)){const parent=node.parentElement;node.remove();fillEmptyElement(parent);}else if(node.nodeType===Node.ELEMENT_NODE){if(node.hasAttribute("data-oe-zws-empty-inline")){delete node.dataset.oeZwsEmptyInline;}
fillEmpty(node);}};fillEmptyElement(lastLeaf(beforeElement));fillEmptyElement(firstLeaf(afterElement));this.dependencies.selection.setCursorStart(afterElement);return[beforeElement,afterElement];}
isUnsplittable(node){return this.getResource("unsplittable_node_predicates").some((p)=>p(node));}
splitElement(element,offset){const firstPart=element.cloneNode();const secondPart=element.cloneNode();element.before(firstPart);element.after(secondPart);const children=childNodes(element);firstPart.append(...children.slice(0,offset));secondPart.append(...children.slice(offset));element.remove();this.dispatchTo("after_split_element_handlers",{firstPart,secondPart});return[firstPart,secondPart];}
splitElementUntil(element,offset,limitAncestor){if(element===limitAncestor){return[element,element];}
let[before,after]=this.splitElement(element,offset);if(after.parentElement!==limitAncestor){const afterIndex=childNodeIndex(after);[before,after]=this.splitElementUntil(after.parentElement,afterIndex,limitAncestor);}
return[before,after];}
splitAroundUntil(elements,limitAncestor,cursors=null){elements=Array.isArray(elements)?elements:[elements];const firstNode=elements[0];const lastNode=elements[elements.length-1];if([firstNode,lastNode].includes(limitAncestor)){return limitAncestor;}
let before=firstNode.previousSibling;let after=lastNode.nextSibling;let beforeSplit,afterSplit;if(!before&&!after&&firstNode.parentElement!==limitAncestor&&lastNode.parentElement!==limitAncestor){return this.splitAroundUntil([firstNode.parentElement,lastNode.parentElement],limitAncestor,cursors);}else if(!after&&lastNode.parentElement!==limitAncestor){return this.splitAroundUntil([firstNode,lastNode.parentElement],limitAncestor,cursors);}else if(!before&&firstNode.parentElement!==limitAncestor){return this.splitAroundUntil([firstNode.parentElement,lastNode],limitAncestor,cursors);}
while(after&&after.parentElement!==limitAncestor){afterSplit=this.splitElement(after.parentElement,childNodeIndex(after))[0];after=afterSplit.nextSibling;}
if(after){afterSplit=this.splitElement(limitAncestor,childNodeIndex(after))[0];limitAncestor=afterSplit;}
while(before&&before.parentElement!==limitAncestor){beforeSplit=this.splitElement(before.parentElement,childNodeIndex(before)+1)[1];before=beforeSplit.previousSibling;}
if(before){beforeSplit=this.splitElement(limitAncestor,childNodeIndex(before)+1)[1];}
const result=beforeSplit||afterSplit||limitAncestor;this.fixSplitAroundUntilEmptyNodes(result.parentElement,cursors);return result;}
fixSplitAroundUntilEmptyNodes(node,cursors){node&&descendants(node).filter((node)=>isElement(node)&&node.childNodes.length&&[...node.childNodes].every((n)=>isTextNode(n))&&!node.textContent.replaceAll("\ufeff","")).forEach((node)=>{cursors?.update(callbacksForCursorUpdate.remove(node));node.remove();});}
splitSelection(){let{startContainer,startOffset,endContainer,endOffset,direction}=this.dependencies.selection.getEditableSelection();const isInSingleContainer=startContainer===endContainer;if(isTextNode(endContainer)&&endOffset>0&&endOffset<nodeSize(endContainer)){const endParent=endContainer.parentNode;const splitOffset=splitTextNode(endContainer,endOffset);endContainer=endParent.childNodes[splitOffset-1]||endParent.firstChild;if(isInSingleContainer){startContainer=endContainer;}
endOffset=endContainer.textContent.length;}
if(isTextNode(startContainer)&&startOffset>0&&startOffset<nodeSize(startContainer)){splitTextNode(startContainer,startOffset);startOffset=0;if(isInSingleContainer){endOffset=startContainer.textContent.length;}}
const selection=direction===DIRECTIONS.RIGHT?{anchorNode:startContainer,anchorOffset:startOffset,focusNode:endContainer,focusOffset:endOffset,}:{anchorNode:endContainer,anchorOffset:endOffset,focusNode:startContainer,focusOffset:startOffset,};return this.dependencies.selection.setSelection(selection,{normalize:false});}
onBeforeInput(e){if(e.inputType==="insertParagraph"){e.preventDefault();this.splitBlock();this.dependencies.history.addStep();}}}
return __exports;});;

/* /html_editor/static/src/core/style_plugin.js */
odoo.define('@html_editor/core/style_plugin',['@html_editor/plugin','@html_editor/utils/image'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{backgroundImageCssToParts,backgroundImagePartsToCss}=require("@html_editor/utils/image");const StylePlugin=__exports.StylePlugin=class StylePlugin extends Plugin{static id="style";static shared=["setBackgroundImageUrl"];setBackgroundImageUrl(el,value){const parts=backgroundImageCssToParts(el.style["background-image"]);if(value){parts.url=`url('${value}')`;}else{delete parts.url;}
el.style["background-image"]=backgroundImagePartsToCss(parts);}}
return __exports;});;

/* /html_editor/static/src/core/user_command_plugin.js */
odoo.define('@html_editor/core/user_command_plugin',['@html_editor/plugin'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const UserCommandPlugin=__exports.UserCommandPlugin=class UserCommandPlugin extends Plugin{static id="userCommand";static shared=["getCommand"];setup(){this.commands={};for(const command of this.getResource("user_commands")){if(command.id in this.commands){throw new Error(`Duplicate user command id: ${command.id}`);}
this.commands[command.id]=command;}
Object.freeze(this.commands);}
getCommand(commandId){const command=this.commands[commandId];if(!command){throw new Error(`Unknown user command id: ${commandId}`);}
return command;}}
return __exports;});;

/* /html_editor/static/src/main/align/align_plugin.js */
odoo.define('@html_editor/main/align/align_plugin',['@html_editor/plugin','@html_editor/utils/blocks','@html_editor/utils/dom_info','@web/core/l10n/translation','@html_editor/main/align/align_selector','@odoo/owl','@html_editor/core/selection_plugin','@html_editor/utils/functions'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{closestBlock}=require("@html_editor/utils/blocks");const{isVisibleTextNode}=require("@html_editor/utils/dom_info");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{AlignSelector}=require("@html_editor/main/align/align_selector");const{reactive}=require("@odoo/owl");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const{weakMemoize}=require("@html_editor/utils/functions");const alignmentItems=[{mode:"left"},{mode:"center"},{mode:"right"},{mode:"justify"},];const AlignPlugin=__exports.AlignPlugin=class AlignPlugin extends Plugin{static id="align";static dependencies=["history","selection"];resources={user_commands:[{id:"alignLeft",run:()=>this.setAlignment("left"),isAvailable:this.canSetAlignment.bind(this),},{id:"alignCenter",run:()=>this.setAlignment("center"),isAvailable:this.canSetAlignment.bind(this),},{id:"alignRight",run:()=>this.setAlignment("right"),isAvailable:this.canSetAlignment.bind(this),},{id:"justify",run:()=>this.setAlignment("justify"),isAvailable:this.canSetAlignment.bind(this),},],toolbar_items:[{id:"alignment",groupId:"layout",description:_t("Align text"),Component:AlignSelector,props:{getItems:()=>alignmentItems,getDisplay:()=>this.alignment,onSelected:(item)=>{this.setAlignment(item.mode);},},isAvailable:this.canSetAlignment.bind(this),},],selectionchange_handlers:this.updateAlignmentParams.bind(this),post_undo_handlers:this.updateAlignmentParams.bind(this),post_redo_handlers:this.updateAlignmentParams.bind(this),remove_all_formats_handlers:this.setAlignment.bind(this),has_format_predicates:(node)=>closestBlock(node)?.style.textAlign,};setup(){this.alignment=reactive({displayName:""});this.canSetAlignmentMemoized=weakMemoize((selection)=>isHtmlContentSupported(selection)&&this.getBlocksToAlign().length>0);}
get alignmentMode(){const sel=this.dependencies.selection.getSelectionData().deepEditableSelection;const block=closestBlock(sel?.anchorNode);const textAlign=this.getTextAlignment(block);return["center","right","justify"].includes(textAlign)?textAlign:"left";}
getTextAlignment(block){const{direction,textAlign}=getComputedStyle(block);if(textAlign==="start"){return direction==="rtl"?"right":"left";}else if(textAlign==="end"){return direction==="rtl"?"left":"right";}
return textAlign;}
getBlocksToAlign(){return this.dependencies.selection.getTargetedNodes().filter((node)=>isVisibleTextNode(node)||node.nodeName==="BR").map((node)=>closestBlock(node)).filter((block)=>block.isContentEditable);}
setAlignment(mode=""){const visitedBlocks=new Set();let isAlignmentUpdated=false;for(const block of this.getBlocksToAlign()){if(!visitedBlocks.has(block)){const currentTextAlign=this.getTextAlignment(block);if(currentTextAlign!==mode){block.style.textAlign=mode;isAlignmentUpdated=true;}
visitedBlocks.add(block);}}
if(mode&&isAlignmentUpdated){this.dependencies.history.addStep();}
this.updateAlignmentParams();}
canSetAlignment(selection){return this.canSetAlignmentMemoized(selection);}
updateAlignmentParams(){this.alignment.displayName=this.alignmentMode;}}
return __exports;});;

/* /html_editor/static/src/main/align/align_selector.js */
odoo.define('@html_editor/main/align/align_selector',['@odoo/owl','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_item','@html_editor/main/toolbar/toolbar','@html_editor/dropdown_autovisibility_hook','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Component,useState}=require("@odoo/owl");const{Dropdown}=require("@web/core/dropdown/dropdown");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{toolbarButtonProps}=require("@html_editor/main/toolbar/toolbar");const{useDropdownAutoVisibility}=require("@html_editor/dropdown_autovisibility_hook");const{useChildRef}=require("@web/core/utils/hooks");const AlignSelector=__exports.AlignSelector=class AlignSelector extends Component{static template="html_editor.AlignSelector";static props={getItems:Function,getDisplay:Function,onSelected:Function,...toolbarButtonProps,};static components={Dropdown,DropdownItem};setup(){this.items=this.props.getItems();this.state=useState(this.props.getDisplay());this.menuRef=useChildRef();useDropdownAutoVisibility(this.env.overlayState,this.menuRef);}
onSelected(item){this.props.onSelected(item);}}
return __exports;});;

/* /html_editor/static/src/main/banner_plugin.js */
odoo.define('@html_editor/main/banner_plugin',['@html_editor/plugin','@html_editor/utils/dom','@html_editor/utils/dom_traversal','@html_editor/utils/html','@html_editor/utils/resource','@odoo/owl','@web/core/l10n/translation','@html_editor/utils/blocks','@html_editor/utils/dom_info','@html_editor/core/selection_plugin'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{fillEmpty,fillShrunkPhrasingParent}=require("@html_editor/utils/dom");const{closestElement}=require("@html_editor/utils/dom_traversal");const{parseHTML}=require("@html_editor/utils/html");const{withSequence}=require("@html_editor/utils/resource");const{htmlEscape}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{closestBlock}=require("@html_editor/utils/blocks");const{isEmptyBlock,isParagraphRelatedElement}=require("@html_editor/utils/dom_info");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");function isAvailable(selection){return(isHtmlContentSupported(selection)&&!closestElement(selection.anchorNode,".o_editor_banner"));}
const BannerPlugin=__exports.BannerPlugin=class BannerPlugin extends Plugin{static id="banner";static dependencies=["baseContainer","history","dom","emoji","selection","sanitize"];static shared=["insertBanner"];resources={user_commands:[{id:"banner_info",title:_t("Banner Info"),description:_t("Insert an info banner"),icon:"fa-info-circle",isAvailable,run:()=>{this.insertBanner(_t("Banner Info"),"","info");},},{id:"banner_success",title:_t("Banner Success"),description:_t("Insert a success banner"),icon:"fa-check-circle",isAvailable,run:()=>{this.insertBanner(_t("Banner Success"),"","success");},},{id:"banner_warning",title:_t("Banner Warning"),description:_t("Insert a warning banner"),icon:"fa-exclamation-triangle",isAvailable,run:()=>{this.insertBanner(_t("Banner Warning"),"","warning");},},{id:"banner_danger",title:_t("Banner Danger"),description:_t("Insert a danger banner"),icon:"fa-exclamation-circle",isAvailable,run:()=>{this.insertBanner(_t("Banner Danger"),"","danger");},},{id:"banner_monospace",title:_t("Monospace"),description:_t("Insert a monospace banner"),icon:"fa-laptop",isAvailable,run:()=>{this.insertBanner(_t("Monospace Banner"),undefined,"secondary","font-monospace");},},],powerbox_categories:withSequence(20,{id:"banner",name:_t("Banner")}),powerbox_items:[{commandId:"banner_info",categoryId:"banner",},{commandId:"banner_success",categoryId:"banner",},{commandId:"banner_warning",categoryId:"banner",},{commandId:"banner_danger",categoryId:"banner",},{commandId:"banner_monospace",categoryId:"banner",},],power_buttons_visibility_predicates:({anchorNode})=>!closestElement(anchorNode,".o_editor_banner"),move_node_blacklist_selectors:".o_editor_banner *",move_node_whitelist_selectors:".o_editor_banner",delete_backward_overrides:this.handleDeleteBackward.bind(this),delete_backward_word_overrides:this.handleDeleteBackward.bind(this),};setup(){this.addDomListener(this.editable,"click",(e)=>{if(e.target.classList.contains("o_editor_banner_icon")){this.onBannerEmojiChange(e.target);}});}
insertBanner(title,emoji,alertClass,containerClass="",contentClass=""){containerClass=containerClass?`${containerClass} `:"";contentClass=contentClass?`${contentClass} `:"";const selection=this.dependencies.selection.getEditableSelection();const blockEl=closestBlock(selection.anchorNode);let baseContainer;if(isParagraphRelatedElement(blockEl)){baseContainer=this.document.createElement(blockEl.nodeName);baseContainer.append(...blockEl.childNodes);}else if(blockEl.nodeName==="LI"){baseContainer=this.dependencies.baseContainer.createBaseContainer();baseContainer.append(...blockEl.childNodes);fillShrunkPhrasingParent(blockEl);}else{baseContainer=this.dependencies.baseContainer.createBaseContainer();fillShrunkPhrasingParent(baseContainer);}
const baseContainerHtml=baseContainer.outerHTML;const emojiHtml=emoji?`<i class="o_editor_banner_icon mb-3 fst-normal" data-oe-aria-label="${htmlEscape(
                  title
              )}">${emoji}</i>`:"";const bannerElement=parseHTML(this.document,`<div class="${containerClass}o_editor_banner user-select-none o-contenteditable-false ${
                emoji ? "lh-1 " : ""
            }d-flex align-items-center alert alert-${alertClass} pb-0 pt-3" data-oe-role="status">
                ${emojiHtml}
                <div class="${contentClass}o_editor_banner_content o-contenteditable-true w-100 px-3">
                    ${baseContainerHtml}
                </div>
            </div>`).childNodes[0];this.dependencies.dom.insert(bannerElement);this.dependencies.selection.setCursorEnd(bannerElement.querySelector(`.o_editor_banner_content > ${baseContainer.tagName}`));this.dependencies.history.addStep();}
onBannerEmojiChange(iconElement){this.dependencies.emoji.showEmojiPicker({target:iconElement,onSelect:(emoji)=>{iconElement.textContent=emoji;this.dependencies.history.addStep();},});}
handleDeleteBackward(range){const editorBannerContent=closestElement(range.endContainer,".o_editor_banner_content");if(!isEmptyBlock(editorBannerContent)){return;}
const bannerElement=closestElement(editorBannerContent,".o_editor_banner");const baseContainer=this.dependencies.baseContainer.createBaseContainer();fillEmpty(baseContainer);bannerElement.replaceWith(baseContainer);this.dependencies.selection.setCursorStart(baseContainer);return true;}}
return __exports;});;

/* /html_editor/static/src/main/chatgpt/chatgpt_dialog.js */
odoo.define('@html_editor/main/chatgpt/chatgpt_dialog',['@web/core/l10n/translation','@web/core/dialog/dialog','@web/core/network/rpc','@web/core/utils/hooks','@odoo/owl'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{Dialog}=require("@web/core/dialog/dialog");const{rpc}=require("@web/core/network/rpc");const{useService}=require("@web/core/utils/hooks");const{Component,useState,onWillDestroy,status,markup}=require("@odoo/owl");const POSTPROCESS_GENERATED_CONTENT=(content,baseContainer)=>{let lines=content.split("\n");if(baseContainer.toUpperCase()==="P"){lines=lines.filter((line)=>line.trim().length);}
const fragment=document.createDocumentFragment();let parentUl,parentOl;let lineIndex=0;for(const line of lines){if(line.trim().startsWith("- ")){parentUl=parentUl||document.createElement("ul");const li=document.createElement("li");li.innerText=line.trim().slice(2);parentUl.appendChild(li);}else if((parentOl&&line.startsWith(`${parentOl.children.length + 1}. `))||(!parentOl&&line.startsWith("1. ")&&lines[lineIndex+1]?.startsWith("2. "))){parentOl=parentOl||document.createElement("ol");const li=document.createElement("li");li.innerText=line.slice(line.indexOf(".")+2);parentOl.appendChild(li);}else if(line.trim().length===0){const emptyLine=document.createElement("DIV");emptyLine.append(document.createElement("BR"));fragment.appendChild(emptyLine);}else{[parentUl,parentOl].forEach((list)=>list&&fragment.appendChild(list));parentUl=parentOl=undefined;const block=document.createElement(line.startsWith("Title: ")?"h2":baseContainer);block.innerText=line;fragment.appendChild(block);}
lineIndex+=1;}
[parentUl,parentOl].forEach((list)=>list&&fragment.appendChild(list));return fragment;};const ChatGPTDialog=__exports.ChatGPTDialog=class ChatGPTDialog extends Component{static template="";static components={Dialog};static props={insert:{type:Function},close:{type:Function},sanitize:{type:Function},baseContainer:{type:String,optional:true},};static defaultProps={baseContainer:"DIV",};setup(){this.notificationService=useService("notification");this.state=useState({selectedMessageId:null});onWillDestroy(()=>this.pendingRpcPromise?.abort());}
selectMessage(ev){this.state.selectedMessageId=+ev.currentTarget.getAttribute("data-message-id");}
insertMessage(ev){this.selectMessage(ev);this._confirm();}
formatContent(content){const fragment=POSTPROCESS_GENERATED_CONTENT(content,this.props.baseContainer);let result="";for(const child of fragment.children){this.props.sanitize(child,{IN_PLACE:true});result+=child.outerHTML;}
return markup(result);}
generate(prompt,callback){const protectedCallback=(...args)=>{if(status(this)!=="destroyed"){delete this.pendingRpcPromise;return callback(...args);}};this.pendingRpcPromise=rpc("/html_editor/generate_text",{prompt,conversation_history:this.state.conversationHistory,},{silent:true});return this.pendingRpcPromise.then((content)=>protectedCallback(content)).catch((error)=>protectedCallback(_t(error.data?.message||error.message),true));}
_cancel(){this.props.close();}
_confirm(){try{this.props.close();const text=this.state.messages.find((message)=>message.id===this.state.selectedMessageId)?.text;this.notificationService.add(_t("Your content was successfully generated."),{title:_t("Content generated"),type:"success",});const fragment=POSTPROCESS_GENERATED_CONTENT(text||"",this.props.baseContainer);this.props.sanitize(fragment,{IN_PLACE:true});this.props.insert(fragment);}catch(e){this.props.close();throw e;}}}
return __exports;});;

/* /html_editor/static/src/main/chatgpt/chatgpt_translate_dialog.js */
odoo.define('@html_editor/main/chatgpt/chatgpt_translate_dialog',['@odoo/owl','@html_editor/main/chatgpt/chatgpt_dialog'],function(require){'use strict';let __exports={};const{useState}=require("@odoo/owl");const{ChatGPTDialog}=require("@html_editor/main/chatgpt/chatgpt_dialog");const ChatGPTTranslateDialog=__exports.ChatGPTTranslateDialog=class ChatGPTTranslateDialog extends ChatGPTDialog{static template="html_editor.ChatGPTTranslateDialog";static props={...super.props,originalText:String,language:String,};setup(){super.setup();this.state=useState({...this.state,conversationHistory:[{role:"system",content:"You are a translation assistant. You goal is to translate text while maintaining the original format and"+"respecting specific instructions. \n"+"Instructions: \n"+"- You must respect the format (wrapping the translated text between <generated_text> and </generated_text>)\n"+"- Do not write HTML.",},],messages:[],translationInProgress:true,});this.translate();}
async translate(){const query=`Translate <generated_text>${this.props.originalText}</generated_text> to ${this.props.language}`;const messageId=new Date().getTime();await this.generate(query,(content,isError)=>{let translatedText=content.replace(/^[\s\S]*<generated_text>/,"").replace(/<\/generated_text>[\s\S]*$/,"");if(!this.formatContent(translatedText).length){isError=true;translatedText="You didn't select any text.";}
this.state.translationInProgress=false;if(!isError){this.state.conversationHistory.push({role:"user",content:query,},{role:"assistant",content,});}
this.state.messages.push({author:"assistant",text:translatedText,id:messageId,isError,});this.state.selectedMessageId=messageId;});}}
return __exports;});;

/* /html_editor/static/src/main/chatgpt/chatgpt_translate_plugin.js */
odoo.define('@html_editor/main/chatgpt/chatgpt_translate_plugin',['@web/core/l10n/translation','@html_editor/plugin','@html_editor/utils/dom_traversal','@html_editor/main/chatgpt/chatgpt_translate_dialog','@html_editor/main/chatgpt/language_selector','@html_editor/utils/resource','@web/core/user','@html_editor/utils/dom_info'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{Plugin}=require("@html_editor/plugin");const{closestElement}=require("@html_editor/utils/dom_traversal");const{ChatGPTTranslateDialog}=require("@html_editor/main/chatgpt/chatgpt_translate_dialog");const{LanguageSelector}=require("@html_editor/main/chatgpt/language_selector");const{withSequence}=require("@html_editor/utils/resource");const{user}=require("@web/core/user");const{isContentEditable}=require("@html_editor/utils/dom_info");const ChatGPTTranslatePlugin=__exports.ChatGPTTranslatePlugin=class ChatGPTTranslatePlugin extends Plugin{static id="chatgpt_translate";static dependencies=["baseContainer","selection","history","dom","sanitize","dialog","split",];resources={toolbar_groups:withSequence(50,{id:"ai",}),toolbar_items:[{id:"translate",groupId:"ai",description:_t("Translate with AI"),isAvailable:(selection)=>!selection.isCollapsed&&user.userId,isDisabled:this.isNotReplaceableByAI.bind(this),Component:LanguageSelector,props:{onSelected:(language)=>this.openDialog({language}),},},],};isNotReplaceableByAI(selection=this.dependencies.selection.getEditableSelection()){const isEmpty=!selection.textContent().replace(/\s+/g,"");const cannotReplace=this.dependencies.selection.getTargetedNodes().find((el)=>this.dependencies.split.isUnsplittable(el)||!isContentEditable(el));return cannotReplace||isEmpty;}
openDialog(params={}){const selection=this.dependencies.selection.getEditableSelection();const dialogParams={insert:(content)=>{const insertedNodes=this.dependencies.dom.insert(content);this.dependencies.history.addStep();const start=insertedNodes?.length&&closestElement(insertedNodes[0]);const end=insertedNodes?.length&&closestElement(insertedNodes[insertedNodes.length-1]);if(start&&end){const divContainer=this.editable.parentElement;let[parent,left,top]=[start.offsetParent,start.offsetLeft,start.offsetTop-start.scrollTop,];while(parent&&!parent.contains(divContainer)){left+=parent.offsetLeft;top+=parent.offsetTop-parent.scrollTop;parent=parent.offsetParent;}
let[endParent,endTop]=[end.offsetParent,end.offsetTop-end.scrollTop];while(endParent&&!endParent.contains(divContainer)){endTop+=endParent.offsetTop-endParent.scrollTop;endParent=endParent.offsetParent;}
const div=document.createElement("div");div.classList.add("o-chatgpt-content");const FRAME_PADDING=3;div.style.left=`${left - FRAME_PADDING}px`;div.style.top=`${top - FRAME_PADDING}px`;div.style.width=`${
                        Math.max(start.offsetWidth, end.offsetWidth) + FRAME_PADDING * 2
                    }px`;div.style.height=`${endTop + end.offsetHeight - top + FRAME_PADDING * 2}px`;divContainer.prepend(div);setTimeout(()=>div.remove(),2000);}},...params,};dialogParams.baseContainer=this.dependencies.baseContainer.getDefaultNodeName();const sanitize=this.dependencies.sanitize.sanitize;const originalText=selection.textContent()||"";this.dependencies.dialog.addDialog(ChatGPTTranslateDialog,{...dialogParams,originalText,sanitize,});if(this.services.ui.isSmall){Promise.resolve().then(()=>{this.document.getSelection()?.removeAllRanges();});}}}
return __exports;});;

/* /html_editor/static/src/main/chatgpt/language_selector.js */
odoo.define('@html_editor/main/chatgpt/language_selector',['@odoo/owl','@web/core/utils/hooks','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_item','@web/core/l10n/translation','@web/core/l10n/utils','@html_editor/main/toolbar/toolbar','@web/core/user','@html_editor/dropdown_autovisibility_hook'],function(require){'use strict';let __exports={};const{Component,onWillStart,useState}=require("@odoo/owl");const{useChildRef,useService}=require("@web/core/utils/hooks");const{Dropdown}=require("@web/core/dropdown/dropdown");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{loadLanguages}=require("@web/core/l10n/translation");const{jsToPyLocale}=require("@web/core/l10n/utils");const{toolbarButtonProps}=require("@html_editor/main/toolbar/toolbar");const{user}=require("@web/core/user");const{useDropdownAutoVisibility}=require("@html_editor/dropdown_autovisibility_hook");const LanguageSelector=__exports.LanguageSelector=class LanguageSelector extends Component{static template="html_editor.LanguageSelector";static props={...toolbarButtonProps,onSelected:{type:Function},};static components={Dropdown,DropdownItem};setup(){this.orm=useService("orm");this.state=useState({languages:[],});this.menuRef=useChildRef();useDropdownAutoVisibility(this.env.overlayState,this.menuRef);onWillStart(()=>{if(user.userId){const userLang=jsToPyLocale(user.lang);loadLanguages(this.orm).then((res)=>{const userLangIndex=res.findIndex((lang)=>lang[0]===userLang);if(userLangIndex!==-1){const[userLangItem]=res.splice(userLangIndex,1);res.unshift(userLangItem);}
this.state.languages=res;});}});}
onSelected(language){this.props.onSelected(language);}}
return __exports;});;

/* /html_editor/static/src/main/column_plugin.js */
odoo.define('@html_editor/main/column_plugin',['@web/core/l10n/translation','@html_editor/plugin','@html_editor/utils/blocks','@html_editor/utils/dom','@html_editor/utils/dom_traversal','@html_editor/utils/base_container','@html_editor/core/selection_plugin'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{Plugin}=require("@html_editor/plugin");const{closestBlock}=require("@html_editor/utils/blocks");const{unwrapContents}=require("@html_editor/utils/dom");const{closestElement,firstLeaf}=require("@html_editor/utils/dom_traversal");const{baseContainerGlobalSelector}=require("@html_editor/utils/base_container");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const REGEX_BOOTSTRAP_COLUMN=/(?:^| )col(-[a-zA-Z]+)?(-\d+)?(?= |$)/;function isUnremovableColumn(node,root){const isColumnInnerStructure=node.nodeName==="DIV"&&[...node.classList].some((cls)=>/^row$|^col$|^col-/.test(cls));if(!isColumnInnerStructure){return false;}
if(!root){return true;}
const closestColumnContainer=closestElement(node,"div.o_text_columns");return!root.contains(closestColumnContainer);}
function columnIsAvailable(numberOfColumns){return(selection)=>{const row=closestElement(selection.anchorNode,".o_text_columns .row");return!(row&&row.childElementCount===numberOfColumns);};}
const ColumnPlugin=__exports.ColumnPlugin=class ColumnPlugin extends Plugin{static id="column";static dependencies=["baseContainer","selection","history","dom"];resources={user_commands:[{id:"columnize",title:_t("Columnize"),description:_t("Convert into columns"),icon:"fa-columns",run:this.columnize.bind(this),isAvailable:isHtmlContentSupported,},],powerbox_items:[{title:_t("2 columns"),description:_t("Convert into 2 columns"),categoryId:"structure",isAvailable:columnIsAvailable(2),commandId:"columnize",commandParams:2,},{title:_t("3 columns"),description:_t("Convert into 3 columns"),categoryId:"structure",isAvailable:columnIsAvailable(3),commandId:"columnize",commandParams:3,},{title:_t("4 columns"),description:_t("Convert into 4 columns"),categoryId:"structure",isAvailable:columnIsAvailable(4),commandId:"columnize",commandParams:4,},{title:_t("Remove columns"),description:_t("Back to one column"),categoryId:"structure",isAvailable:(selection)=>!!closestElement(selection.anchorNode,".o_text_columns .row"),commandId:"columnize",commandParams:0,},],hints:[{selector:`.odoo-editor-editable .o_text_columns div[class^='col-'],
                            .odoo-editor-editable .o_text_columns div[class^='col-']>${baseContainerGlobalSelector}:first-child`,text:_t("Empty column"),},],unremovable_node_predicates:isUnremovableColumn,power_buttons_visibility_predicates:({anchorNode})=>!closestElement(anchorNode,".o_text_columns"),move_node_whitelist_selectors:".o_text_columns",move_node_blacklist_selectors:".o_text_columns *",hint_targets_providers:(selectionData)=>{if(!selectionData.documentSelection){return[];}
const anchorNode=selectionData.documentSelection.anchorNode;const columnContainer=closestElement(anchorNode,"div.o_text_columns");if(!columnContainer){return[];}
const closestColumn=closestElement(anchorNode,"div[class^='col-']");const closestBlockEl=closestBlock(anchorNode);return[...columnContainer.querySelectorAll("div[class^='col-']")].map((column)=>{const block=closestBlock(firstLeaf(column));return column===closestColumn&&block!==closestBlockEl?null:block;}).filter(Boolean);},};columnize(numberOfColumns){const selectionToRestore=this.dependencies.selection.getEditableSelection();const anchor=selectionToRestore.anchorNode;const hasColumns=!!closestElement(anchor,".o_text_columns");if(hasColumns){if(numberOfColumns){this.changeColumnsNumber(anchor,numberOfColumns);}else{this.removeColumns(anchor);}}else if(numberOfColumns){this.createColumns(anchor,numberOfColumns);}
this.dependencies.selection.setSelection(selectionToRestore);this.dependencies.history.addStep();}
removeColumns(anchor){const container=closestElement(anchor,".o_text_columns");const rows=unwrapContents(container);for(const row of rows){const columns=unwrapContents(row);for(const column of columns){unwrapContents(column);}}}
createColumns(anchor,numberOfColumns){const container=this.document.createElement("div");if(!closestElement(anchor,".container")){container.classList.add("container");}
container.classList.add("o_text_columns","o-contenteditable-false");const row=this.document.createElement("div");row.classList.add("row");container.append(row);const block=closestBlock(anchor);const columnSize=Math.floor(12/numberOfColumns);const columns=[];for(let i=0;i<numberOfColumns;i++){const column=this.document.createElement("div");column.classList.add(`col-${columnSize}`,"o-contenteditable-true");row.append(column);columns.push(column);}
columns.shift().append(block);for(const column of columns){const baseContainer=this.dependencies.baseContainer.createBaseContainer();baseContainer.append(this.document.createElement("br"));column.append(baseContainer);}
this.dependencies.dom.insert(container);}
changeColumnsNumber(anchor,numberOfColumns){const row=closestElement(anchor,".row");const columns=[...row.children];const columnSize=Math.floor(12/numberOfColumns);const diff=numberOfColumns-columns.length;if(!diff){return;}
for(const column of columns){column.className=column.className.replace(REGEX_BOOTSTRAP_COLUMN,`col$1-${columnSize}`);}
if(diff>0){let lastColumn=columns[columns.length-1];for(let i=0;i<diff;i++){const column=this.document.createElement("div");column.classList.add(`col-${columnSize}`,"o-contenteditable-true");const baseContainer=this.dependencies.baseContainer.createBaseContainer();baseContainer.append(this.document.createElement("br"));column.append(baseContainer);lastColumn.after(column);lastColumn=column;}}else if(diff<0){const contents=[];for(let i=diff;i<0;i++){const column=columns.pop();const columnContents=unwrapContents(column);contents.unshift(...columnContents);}
columns[columns.length-1].append(...contents);}}}
return __exports;});;

/* /html_editor/static/src/main/emoji_plugin.js */
odoo.define('@html_editor/main/emoji_plugin',['@html_editor/plugin','@web/core/emoji_picker/emoji_picker','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{EmojiPicker}=require("@web/core/emoji_picker/emoji_picker");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const EmojiPlugin=__exports.EmojiPlugin=class EmojiPlugin extends Plugin{static id="emoji";static dependencies=["history","overlay","dom","selection"];static shared=["showEmojiPicker"];resources={user_commands:[{id:"addEmoji",title:_t("Emoji"),description:_t("Add an emoji"),icon:"fa-smile-o",run:this.showEmojiPicker.bind(this),},],powerbox_items:[{categoryId:"widget",commandId:"addEmoji",},],};setup(){this.overlay=this.dependencies.overlay.createOverlay(EmojiPicker,{hasAutofocus:true,className:"popover",});}
showEmojiPicker({target,onSelect}={}){this.overlay.open({props:{close:()=>{this.overlay.close();this.dependencies.selection.focusEditable();},onSelect:(str)=>{if(onSelect){onSelect(str);return;}
this.dependencies.dom.insert(str);this.dependencies.history.addStep();},},target,});}}
return __exports;});;

/* /html_editor/static/src/main/feff_plugin.js */
odoo.define('@html_editor/main/feff_plugin',['@html_editor/plugin','@html_editor/utils/dom','@html_editor/utils/dom_info','@html_editor/utils/dom_state','@html_editor/utils/dom_traversal','@html_editor/utils/position','@html_editor/utils/selection'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{cleanTextNode}=require("@html_editor/utils/dom");const{isTextNode,isZwnbsp}=require("@html_editor/utils/dom_info");const{prepareUpdate}=require("@html_editor/utils/dom_state");const{descendants,selectElements}=require("@html_editor/utils/dom_traversal");const{leftPos,rightPos}=require("@html_editor/utils/position");const{callbacksForCursorUpdate}=require("@html_editor/utils/selection");const FeffPlugin=__exports.FeffPlugin=class FeffPlugin extends Plugin{static id="feff";static dependencies=["selection"];static shared=["addFeff","removeFeffs","surroundWithFeffs"];resources={normalize_handlers:this.updateFeffs.bind(this),clean_for_save_handlers:this.cleanForSave.bind(this),intangible_char_for_keyboard_navigation_predicates:(ev,char,lastSkipped)=>char==="\uFEFF"&&(ev.shiftKey||lastSkipped!=="\uFEFF"),clipboard_content_processors:this.processContentForClipboard.bind(this),clipboard_text_processors:(text)=>text.replace(/\ufeff/g,""),};cleanForSave({root,preserveSelection=false}){if(preserveSelection){const cursors=this.getCursors();this.removeFeffs(root,cursors);cursors.restore();}else{this.removeFeffs(root,null);}}
removeFeffs(root,cursors,{exclude=()=>false}={}){const hasFeff=(node)=>isTextNode(node)&&node.textContent.includes("\ufeff");const isEditable=(node)=>node.parentElement.isContentEditable;const composedFilter=(node)=>hasFeff(node)&&isEditable(node)&&!exclude(node);for(const node of descendants(root).filter(composedFilter)){const restoreSpaces=prepareUpdate(...leftPos(node),...rightPos(node));cleanTextNode(node,"\ufeff",cursors);restoreSpaces();}}
addFeff(element,position,cursors){const feff=this.document.createTextNode("\ufeff");cursors?.update(callbacksForCursorUpdate[position](element,feff));element[position](feff);return feff;}
surroundWithFeffs(node,cursors){const addFeff=(position)=>{const c=position==="append"?null:cursors;return this.addFeff(node,position,c);};const zwnbspNodes=[];for(const[position,relation]of[["before","previousSibling"],["after","nextSibling"],["prepend","firstChild"],["append","lastChild"],]){const candidate=node[relation];const feff=isZwnbsp(candidate)&&!zwnbspNodes.includes(candidate)?candidate:addFeff(position);zwnbspNodes.push(feff);}
return zwnbspNodes;}
padWithFeffs(root,cursors){const combinedSelector=this.getResource("selectors_for_feff_providers").map((provider)=>provider()).join(", ");if(!combinedSelector){return[];}
const elements=[...selectElements(root,combinedSelector)];const isEditable=(node)=>node.parentElement?.isContentEditable;const feffNodes=elements.filter(isEditable).flatMap((el)=>{const addFeff=(position)=>this.addFeff(el,position,cursors);return[isZwnbsp(el.previousSibling)?el.previousSibling:addFeff("before"),isZwnbsp(el.nextSibling)?el.nextSibling:addFeff("after"),];}).filter((feff,i,array)=>!(i>0&&areCloseSiblings(array[i-1],feff)));return feffNodes;}
updateFeffs(root){const cursors=this.getCursors();const feffNodesBasedOnSelectors=this.padWithFeffs(root,cursors);const customFeffNodes=this.getResource("feff_providers").flatMap((p)=>p(root,cursors));const feffNodesToKeep=new Set([...feffNodesBasedOnSelectors,...customFeffNodes]);this.removeFeffs(root,cursors,{exclude:(node)=>feffNodesToKeep.has(node)||this.getResource("legit_feff_predicates").some((predicate)=>predicate(node)),});cursors.restore();}
getCursors(){const cursors=this.dependencies.selection.preserveSelection();const originalUpdate=cursors.update.bind(cursors);const originalRestore=cursors.restore.bind(cursors);let shouldRestore=false;cursors.update=(...args)=>{shouldRestore=true;return originalUpdate(...args);};cursors.restore=()=>{if(shouldRestore){originalRestore();}};return cursors;}
processContentForClipboard(clonedContent){descendants(clonedContent).filter(isTextNode).filter((node)=>node.textContent.includes("\ufeff")).forEach((node)=>(node.textContent=node.textContent.replace(/\ufeff/g,"")));return clonedContent;}}
function areCloseSiblings(a,b){let next=a.nextSibling;while(next&&isTextNode(next)&&!next.textContent){next=next.nextSibling;}
return next===b;}
return __exports;});;

/* /html_editor/static/src/main/font/color_picker_gradient_tab.js */
odoo.define('@html_editor/main/font/color_picker_gradient_tab',['@odoo/owl','@web/core/l10n/translation','@web/core/registry','@web/core/utils/colors','@html_editor/main/font/gradient_picker/gradient_picker'],function(require){'use strict';let __exports={};const{Component,useState}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{registry}=require("@web/core/registry");const{applyOpacityToGradient,isColorGradient}=require("@web/core/utils/colors");const{GradientPicker}=require("@html_editor/main/font/gradient_picker/gradient_picker");const DEFAULT_GRADIENT_COLORS=["linear-gradient(135deg, rgb(255, 204, 51) 0%, rgb(226, 51, 255) 100%)","linear-gradient(135deg, rgb(102, 153, 255) 0%, rgb(255, 51, 102) 100%)","linear-gradient(135deg, rgb(47, 128, 237) 0%, rgb(178, 255, 218) 100%)","linear-gradient(135deg, rgb(203, 94, 238) 0%, rgb(75, 225, 236) 100%)","linear-gradient(135deg, rgb(214, 255, 127) 0%, rgb(0, 179, 204) 100%)","linear-gradient(135deg, rgb(255, 222, 69) 0%, rgb(69, 33, 0) 100%)","linear-gradient(135deg, rgb(222, 222, 222) 0%, rgb(69, 69, 69) 100%)","linear-gradient(135deg, rgb(255, 222, 202) 0%, rgb(202, 115, 69) 100%)",];const ColorPickerGradientTab=__exports.ColorPickerGradientTab=class ColorPickerGradientTab extends Component{static template="html_editor.ColorPickerGradientTab";static components={GradientPicker};static props={applyColor:Function,onColorClick:Function,onColorPreview:Function,onColorPointerOver:Function,onColorPointerOut:Function,onFocusin:Function,onFocusout:Function,setOnCloseCallback:{type:Function,optional:true},setOperationCallbacks:{type:Function,optional:true},defaultOpacity:{type:Number,optional:true},noTransparency:{type:Boolean,optional:true},selectedColor:{type:String,optional:true},"*":{optional:true},};setup(){this.state=useState({showGradientPicker:false,});this.applyOpacityToGradient=applyOpacityToGradient;this.DEFAULT_GRADIENT_COLORS=DEFAULT_GRADIENT_COLORS;}
getCurrentGradientColor(){if(isColorGradient(this.props.selectedColor)){return this.props.selectedColor;}}
toggleGradientPicker(){this.state.showGradientPicker=!this.state.showGradientPicker;}}
registry.category("color_picker_tabs").add("html_editor.gradient",{id:"gradient",name:_t("Gradient"),component:ColorPickerGradientTab,},{sequence:60});return __exports;});;

/* /html_editor/static/src/main/font/color_plugin.js */
odoo.define('@html_editor/main/font/color_plugin',['@html_editor/plugin','@html_editor/utils/color','@html_editor/utils/dom','@html_editor/utils/dom_info','@html_editor/utils/dom_traversal','@web/core/utils/colors','@html_editor/utils/image','@html_editor/core/selection_plugin','@html_editor/utils/blocks'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{BG_CLASSES_REGEX,COLOR_COMBINATION_CLASSES_REGEX,hasAnyNodesColor,hasColor,TEXT_CLASSES_REGEX,hasTextColorClass,}=require("@html_editor/utils/color");const{fillEmpty,unwrapContents}=require("@html_editor/utils/dom");const{isEmptyBlock,isRedundantElement,isTextNode,isVisibleTextNode,isWhitespace,isZWS,}=require("@html_editor/utils/dom_info");const{closestElement,descendants,selectElements}=require("@html_editor/utils/dom_traversal");const{isColorGradient,rgbaToHex}=require("@web/core/utils/colors");const{backgroundImageCssToParts,backgroundImagePartsToCss}=require("@html_editor/utils/image");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const{isBlock}=require("@html_editor/utils/blocks");const COLOR_COMBINATION_CLASSES=[1,2,3,4,5].map((i)=>`o_cc${i}`);const COLOR_COMBINATION_SELECTOR=COLOR_COMBINATION_CLASSES.map((c)=>`.${c}`).join(", ");const ColorPlugin=__exports.ColorPlugin=class ColorPlugin extends Plugin{static id="color";static dependencies=["selection","split","history","format"];static shared=["colorElement","removeAllColor","getElementColors","getColorCombination","applyColor",];resources={user_commands:[{id:"applyColor",run:({color,mode})=>{this.applyColor(color,mode);this.dependencies.history.addStep();},isAvailable:isHtmlContentSupported,},],remove_all_formats_handlers:this.removeAllColor.bind(this),color_combination_getters:getColorCombinationFromClass,has_format_predicates:[(node)=>hasColor(closestElement(node),"color"),(node)=>hasColor(closestElement(node),"backgroundColor"),],format_class_predicates:(className)=>TEXT_CLASSES_REGEX.test(className)||BG_CLASSES_REGEX.test(className),normalize_handlers:this.normalize.bind(this),};normalize(root){for(const el of selectElements(root,"font")){if(isRedundantElement(el)){unwrapContents(el);}}}
getElementColors(el){const elStyle=getComputedStyle(el);const backgroundImage=elStyle.backgroundImage;const gradient=backgroundImageCssToParts(backgroundImage).gradient;const hasGradient=isColorGradient(gradient);const hasTextGradientClass=el.classList.contains("text-gradient");let backgroundColor=elStyle.backgroundColor;for(const processor of this.getResource("get_background_color_processors")){backgroundColor=processor(backgroundColor);}
return{color:hasGradient&&hasTextGradientClass?gradient:rgbaToHex(elStyle.color),backgroundColor:hasGradient&&!hasTextGradientClass?gradient:rgbaToHex(backgroundColor),};}
removeAllColor(){const colorModes=["color","backgroundColor"];let someColorWasRemoved=true;while(someColorWasRemoved){someColorWasRemoved=false;for(const mode of colorModes){let max=40;const hasAnySelectedNodeColor=(mode)=>{const nodes=this.dependencies.selection.getTargetedNodes().filter((n)=>isTextNode(n)||(mode==="backgroundColor"&&n.classList.contains("o_selected_td")));return hasAnyNodesColor(nodes,mode);};while(hasAnySelectedNodeColor(mode)&&max>0){this.applyColor("",mode);someColorWasRemoved=true;max--;}
if(max===0){someColorWasRemoved=false;throw new Error("Infinite Loop in removeAllColor().");}}}}
applyColor(color,mode,previewMode=false){this.dependencies.selection.selectAroundNonEditable();if(mode==="backgroundColor"){for(const processor of this.getResource("apply_background_color_processors")){color=processor(color,mode);}}
if(this.delegateTo("color_apply_overrides",color,mode,previewMode)){return;}
let selection=this.dependencies.selection.getEditableSelection();let targetedNodes;if(selection.isCollapsed){let zws;if(selection.anchorNode.nodeType===Node.TEXT_NODE&&selection.anchorNode.textContent==="\u200b"){zws=selection.anchorNode;}else{zws=this.dependencies.format.insertAndSelectZws();}
selection=this.dependencies.selection.setSelection({anchorNode:zws,anchorOffset:0,},{normalize:false});targetedNodes=[zws];}else{selection=this.dependencies.split.splitSelection();targetedNodes=this.dependencies.selection.getTargetedNodes().filter((node)=>this.dependencies.selection.isNodeEditable(node)&&node.nodeName!=="T");if(isEmptyBlock(selection.endContainer)){targetedNodes.push(selection.endContainer,...descendants(selection.endContainer));}}
const findTopMostDecoration=(current)=>{const decoration=closestElement(current.parentNode,"s, u");return decoration?.textContent===current.textContent?findTopMostDecoration(decoration):current;};const hexColor=rgbaToHex(color).toLowerCase();const selectedNodes=targetedNodes.filter((node)=>{if(mode==="backgroundColor"&&color){return!closestElement(node,"table.o_selected_table");}
if(closestElement(node).classList.contains("o_default_color")){return false;}
const li=closestElement(node,"li");if(li&&color&&this.dependencies.selection.areNodeContentsFullySelected(li)){return rgbaToHex(li.style.color).toLowerCase()!==hexColor;}
return true;}).map((node)=>findTopMostDecoration(node));const targetedFieldNodes=new Set(this.dependencies.selection.getTargetedNodes().map((n)=>closestElement(n,"*[t-field],*[t-out],*[t-esc]")).filter(Boolean));const getFonts=(selectedNodes)=>selectedNodes.flatMap((node)=>{if(!node.isConnected){return[];}
let font=closestElement(node,"font")||closestElement(node,'[style*="color"]:not(li), [style*="background-color"]:not(li), [style*="background-image"]:not(li)')||closestElement(node,"span")||closestElement(node,(node)=>hasTextColorClass(node,mode));const faNodes=font?.querySelectorAll(".fa");if(faNodes&&Array.from(faNodes).some((faNode)=>faNode.contains(node))){return font;}
const children=font&&descendants(font);const hasInlineGradient=font&&isColorGradient(font.style["background-image"]);const isFullySelected=children&&children.every((child)=>selectedNodes.includes(child));const isTextGradient=hasInlineGradient&&font.classList.contains("text-gradient");const shouldReplaceExistingGradient=isFullySelected&&((mode==="color"&&isTextGradient)||(mode==="backgroundColor"&&!isTextGradient));if(font&&font.nodeName!=="T"&&(font.nodeName!=="SPAN"||font.style[mode]||font.style.backgroundImage||hasTextColorClass(font,mode))&&(isColorGradient(color)||color===""||!hasInlineGradient||shouldReplaceExistingGradient)&&!this.dependencies.split.isUnsplittable(font)){const selectedChildren=children.filter((child)=>selectedNodes.includes(child));if(selectedChildren.length){if(isBlock(font)){const colorStyles=["color","background-color","background-image"];const newFont=this.document.createElement("font");for(const style of colorStyles){const styleValue=font.style[style];if(styleValue){this.colorElement(newFont,styleValue,style);font.style.removeProperty(style);}}
font.classList.forEach((className)=>{if(TEXT_CLASSES_REGEX.test(className)){font.classList.remove(className);newFont.classList.add(className);}});newFont.append(...font.childNodes);font.append(newFont);font=newFont;}
const closestGradientEl=closestElement(node,'font[style*="background-image"], span[style*="background-image"]');const isGradientBeingUpdated=closestGradientEl&&isColorGradient(color);const splitnode=isGradientBeingUpdated?closestGradientEl:font;const cursors=this.dependencies.selection.preserveSelection();font=this.dependencies.split.splitAroundUntil(selectedChildren,splitnode,cursors);cursors.restore();if(isGradientBeingUpdated){const classRegex=mode==="color"?TEXT_CLASSES_REGEX:BG_CLASSES_REGEX;for(const node of descendants(font)){if(node.nodeType===Node.ELEMENT_NODE&&(node.style[mode]||classRegex.test(node.className))){this.colorElement(node,"",mode);node.style.webkitTextFillColor="";if(!node.getAttribute("style")){unwrapContents(node);}}}}else if(mode==="color"&&(font.style.webkitTextFillColor||(closestGradientEl&&closestGradientEl.classList.contains("text-gradient")&&!shouldReplaceExistingGradient))){font.style.webkitTextFillColor=color;}}else{font=[];}}else if((node.nodeType===Node.TEXT_NODE&&(isVisibleTextNode(node)||isZWS(node)))||(node.nodeName==="BR"&&isEmptyBlock(node.parentNode))||(node.nodeType===Node.ELEMENT_NODE&&["inline","inline-block"].includes(getComputedStyle(node).display)&&!isWhitespace(node.textContent)&&!node.classList.contains("btn")&&!node.querySelector("font")&&node.nodeName!=="A"&&!(node.nodeName==="SPAN"&&node.style["fontSize"]))){const previous=node.previousSibling;const classRegex=mode==="color"?BG_CLASSES_REGEX:TEXT_CLASSES_REGEX;if(previous&&previous.nodeName==="FONT"&&!previous.style[mode==="color"?"backgroundColor":"color"]&&!classRegex.test(previous.className)&&selectedNodes.includes(previous.firstChild)&&selectedNodes.includes(previous.lastChild)){font=previous;}else{font=this.document.createElement("font");node.after(font);if(isTextGradient&&mode==="color"){font.style.webkitTextFillColor=color;}}
if(node.textContent){font.appendChild(node);}else{fillEmpty(font);}}else{font=[];}
return font;});for(const fieldNode of targetedFieldNodes){this.colorElement(fieldNode,color,mode);}
let fonts=getFonts(selectedNodes);if(!fonts.every((font)=>font.isConnected)){fonts=getFonts(selectedNodes);}
const fontsSet=new Set(fonts);for(const font of fontsSet){this.colorElement(font,color,mode);if(!hasColor(font,"color")&&!hasColor(font,"backgroundColor")&&["FONT","SPAN"].includes(font.nodeName)&&(!font.hasAttribute("style")||!color)){for(const child of[...font.childNodes]){font.parentNode.insertBefore(child,font);}
font.parentNode.removeChild(font);fontsSet.delete(font);}}
this.dependencies.selection.setSelection(selection,{normalize:false});}
colorElement(element,color,mode){let parts=backgroundImageCssToParts(element.style["background-image"]);const oldClassName=element.getAttribute("class")||"";if(element.matches(COLOR_COMBINATION_SELECTOR)){removePresetGradient(element);}
const hasGradientStyle=element.style.backgroundImage.includes("-gradient");if(mode==="backgroundColor"){if(!color){element.classList.remove("o_cc",...COLOR_COMBINATION_CLASSES);}
const hasGradient=getComputedStyle(element).backgroundImage.includes("-gradient");delete parts.gradient;let newBackgroundImage=backgroundImagePartsToCss(parts);if(hasGradient&&!newBackgroundImage){newBackgroundImage="none";}
element.style.backgroundImage=newBackgroundImage;element.style["background-color"]="";}
const newClassName=oldClassName.replace(mode==="color"?TEXT_CLASSES_REGEX:BG_CLASSES_REGEX,"").replace(/\btext-gradient\b/g,"").replace(/\s+/," ");if(oldClassName!==newClassName){element.setAttribute("class",newClassName);}
if(color.startsWith("text")||color.startsWith("bg-")){element.style[mode]="";element.classList.add(color);}else if(isColorGradient(color)){element.style[mode]="";parts.gradient=color;if(mode==="color"){element.style["background-color"]="";element.classList.add("text-gradient");}
this.applyColorStyle(element,"background-image",backgroundImagePartsToCss(parts));}else{delete parts.gradient;if(hasGradientStyle&&!backgroundImagePartsToCss(parts)){element.style["background-image"]="";}
mode=mode.replace("backgroundColor","background-color");this.applyColorStyle(element,mode,color);}
if(color.startsWith("o_cc")){parts=backgroundImageCssToParts(element.style["background-image"]);element.classList.remove(...COLOR_COMBINATION_CLASSES);element.classList.add("o_cc",color);const hasBackgroundColor=!!getComputedStyle(element).backgroundColor;const hasGradient=getComputedStyle(element).backgroundImage.includes("-gradient");const backgroundImage=element.style["background-image"];if(hasBackgroundColor&&hasGradient&&!backgroundImage){element.style.backgroundImage="none";}}
this.fixColorCombination(element,color);}
fixColorCombination(element,color){const parts=backgroundImageCssToParts(element.style["background-image"]);const hasBackgroundColor=element.style["background-color"]||!!element.className.match(/\bbg-/)||parts.gradient;if(!hasBackgroundColor&&(isColorGradient(color)||color.startsWith("o_cc"))){element.style["background-image"]="";parts.gradient=backgroundImageCssToParts(getComputedStyle(element).backgroundImage).gradient;element.style["background-image"]=backgroundImagePartsToCss(parts);}}
getColorCombination(el,actionParam){for(const handler of this.getResource("color_combination_getters")){const value=handler(el,actionParam);if(value){return value;}}}
applyColorStyle(element,mode,color){if(this.delegateTo("apply_color_style_overrides",element,mode,color)){return;}
element.style[mode]=color;}}
function getColorCombinationFromClass(el){return el.className.match?.(COLOR_COMBINATION_CLASSES_REGEX)?.[0];}
function removePresetGradient(element){const oldBackgroundImage=element.style["background-image"];const parts=backgroundImageCssToParts(oldBackgroundImage);const currentGradient=parts.gradient;element.style.removeProperty("background-image");const styleWithoutGradient=getComputedStyle(element);const presetGradient=backgroundImageCssToParts(styleWithoutGradient.backgroundImage).gradient;if(presetGradient!==currentGradient){const withGradient=backgroundImagePartsToCss(parts);element.style["background-image"]=withGradient==="none"?"":withGradient;}else{delete parts.gradient;const withoutGradient=backgroundImagePartsToCss(parts);element.style["background-image"]=withoutGradient==="none"?"":withoutGradient;}}
return __exports;});;

/* /html_editor/static/src/main/font/color_selector.js */
odoo.define('@html_editor/main/font/color_selector',['@web/core/utils/colors','@odoo/owl','@web/core/color_picker/color_picker','@web/core/utils/reactive','@html_editor/main/toolbar/toolbar','@html_editor/utils/formatting','@web/core/utils/hooks','@html_editor/dropdown_autovisibility_hook'],function(require){'use strict';let __exports={};const{isColorGradient}=require("@web/core/utils/colors");const{Component,useState}=require("@odoo/owl");const{useColorPicker,DEFAULT_COLORS,DEFAULT_THEME_COLOR_VARS,}=require("@web/core/color_picker/color_picker");const{effect}=require("@web/core/utils/reactive");const{toolbarButtonProps}=require("@html_editor/main/toolbar/toolbar");const{getCSSVariableValue,getHtmlStyle}=require("@html_editor/utils/formatting");const{useChildRef}=require("@web/core/utils/hooks");const{useDropdownAutoVisibility}=require("@html_editor/dropdown_autovisibility_hook");const ColorSelector=__exports.ColorSelector=class ColorSelector extends Component{static template="html_editor.ColorSelector";static props={...toolbarButtonProps,mode:{type:String},type:{type:String},getSelectedColors:Function,applyColor:Function,applyColorPreview:Function,applyColorResetPreview:Function,getUsedCustomColors:Function,getTargetedElements:Function,colorPrefix:{type:String},enabledTabs:{type:Array,optional:true},cssVarColorPrefix:{type:String,optional:true},onClose:Function,};static defaultProps={cssVarColorPrefix:"",enabledTabs:["solid","gradient","custom"],};setup(){this.state=useState({});const htmlStyle=getHtmlStyle(document);const defaultThemeColors=DEFAULT_THEME_COLOR_VARS.map((color)=>getCSSVariableValue(color,htmlStyle));this.solidColors=[...DEFAULT_COLORS.flat(),...defaultThemeColors,getCSSVariableValue("body-color",htmlStyle),"#00000000",];effect((selectedColors)=>{this.state.selectedColor=selectedColors[this.props.mode];this.state.defaultTab="solid";this.state.selectedTab=this.getCorrespondingColorTab(selectedColors[this.props.mode]);this.state.getTargetedElements=this.props.getTargetedElements;this.state.mode=this.props.mode;},[this.props.getSelectedColors()]);const colorPickerRef=useChildRef();this.colorPicker=useColorPicker("root",{state:this.state,applyColor:this.props.applyColor,applyColorPreview:this.props.applyColorPreview,applyColorResetPreview:this.props.applyColorResetPreview,getUsedCustomColors:this.props.getUsedCustomColors,colorPrefix:this.props.colorPrefix,enabledTabs:this.props.enabledTabs,cssVarColorPrefix:this.props.cssVarColorPrefix,},{env:this.__owl__.childEnv,onClose:()=>{this.props.applyColorResetPreview();this.props.onClose();},ref:colorPickerRef,});useDropdownAutoVisibility(this.env.overlayState,colorPickerRef);}
getCorrespondingColorTab(color){if(!color||this.solidColors.includes(color.toUpperCase())){return"solid";}else if(isColorGradient(color)){return"gradient";}else{return"custom";}}
getSelectedColorStyle(){if(isColorGradient(this.state.selectedColor)){return`border-bottom: 2px solid transparent; border-image: ${this.state.selectedColor}; border-image-slice: 1`;}
return`border-bottom: 2px solid ${this.state.selectedColor}`;}}
return __exports;});;

/* /html_editor/static/src/main/font/color_ui_plugin.js */
odoo.define('@html_editor/main/font/color_ui_plugin',['@html_editor/core/selection_plugin','@html_editor/plugin','@web/core/l10n/translation','@html_editor/main/font/color_selector','@odoo/owl','@html_editor/utils/dom_info','@html_editor/utils/dom_traversal','@web/core/utils/colors'],function(require){'use strict';let __exports={};const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const{Plugin}=require("@html_editor/plugin");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{ColorSelector}=require("@html_editor/main/font/color_selector");const{reactive}=require("@odoo/owl");const{isTextNode}=require("@html_editor/utils/dom_info");const{closestElement}=require("@html_editor/utils/dom_traversal");const{isCSSColor,RGBA_REGEX,rgbaToHex}=require("@web/core/utils/colors");const RGBA_OPACITY=0.6;const HEX_OPACITY="99";const ColorUIPlugin=__exports.ColorUIPlugin=class ColorUIPlugin extends Plugin{static id="colorUi";static dependencies=["color","history","selection"];static shared=["getPropsForColorSelector"];resources={toolbar_items:[{id:"forecolor",groupId:"decoration",namespaces:["compact","expanded"],description:_t("Apply Font Color"),Component:ColorSelector,props:this.getPropsForColorSelector("foreground"),isAvailable:isHtmlContentSupported,},{id:"backcolor",groupId:"decoration",description:_t("Apply Background Color"),Component:ColorSelector,props:this.getPropsForColorSelector("background"),isAvailable:isHtmlContentSupported,},],selectionchange_handlers:this.updateSelectedColor.bind(this),get_background_color_processors:this.getBackgroundColorProcessor.bind(this),apply_background_color_processors:this.applyBackgroundColorProcessor.bind(this),};setup(){this.selectedColors=reactive({color:"",backgroundColor:""});this.previewableApplyColor=this.dependencies.history.makePreviewableOperation((color,mode,previewMode)=>this.dependencies.color.applyColor(color,mode,previewMode));}
getPropsForColorSelector(type){const mode=type==="foreground"?"color":"backgroundColor";return{type,mode,getUsedCustomColors:()=>this.getUsedCustomColors(mode),getSelectedColors:()=>this.selectedColors,applyColor:(color)=>this.applyColorCommit({color,mode}),applyColorPreview:(color)=>this.applyColorPreview({color,mode}),applyColorResetPreview:this.applyColorResetPreview.bind(this),colorPrefix:mode==="color"?"text-":"bg-",onClose:()=>this.dependencies.selection.focusEditable(),getTargetedElements:()=>{const nodes=this.dependencies.selection.getTargetedNodes().filter(isTextNode);return nodes.map((node)=>closestElement(node));},};}
applyColorCommit({color,mode}){this.previewableApplyColor.commit(color,mode);this.updateSelectedColor();}
applyColorPreview({color,mode}){this.previewableApplyColor.preview(color,mode,true);this.updateSelectedColor();}
applyColorResetPreview(){this.previewableApplyColor.revert();this.updateSelectedColor();}
getUsedCustomColors(mode){const allFont=this.editable.querySelectorAll("font");const usedCustomColors=new Set();for(const font of allFont){if(isCSSColor(font.style[mode])){usedCustomColors.add(rgbaToHex(font.style[mode]));}}
return usedCustomColors;}
updateSelectedColor(){const nodes=this.dependencies.selection.getTargetedNodes().filter(isTextNode);if(nodes.length===0){return;}
const el=closestElement(nodes[0]);if(!el){return;}
Object.assign(this.selectedColors,this.dependencies.color.getElementColors(el));}
getBackgroundColorProcessor(backgroundColor){const activeTab=document.querySelector(".o_font_color_selector button.active")?.innerHTML.trim();if(backgroundColor.startsWith("rgba")&&(!activeTab||activeTab==="Solid")){const values=backgroundColor.match(RGBA_REGEX)||[];const alpha=parseFloat(values.pop());if(alpha===RGBA_OPACITY){backgroundColor=`rgb(${values.slice(0, 3).join(", ")})`;}}
return backgroundColor;}
applyBackgroundColorProcessor(brackgroundColor){const activeTab=document.querySelector(".o_font_color_selector button.active")?.innerHTML.trim();if(activeTab==="Solid"&&brackgroundColor.startsWith("#")){brackgroundColor+=HEX_OPACITY;}
return brackgroundColor;}}
return __exports;});;

/* /html_editor/static/src/main/font/font_family_plugin.js */
odoo.define('@html_editor/main/font/font_family_plugin',['@html_editor/plugin','@web/core/l10n/translation','@html_editor/main/font/font_family_selector','@odoo/owl','@html_editor/utils/dom_traversal','@html_editor/utils/resource','@html_editor/core/selection_plugin'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{FontFamilySelector}=require("@html_editor/main/font/font_family_selector");const{reactive}=require("@odoo/owl");const{closestElement}=require("@html_editor/utils/dom_traversal");const{withSequence}=require("@html_editor/utils/resource");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const defaultFontFamily=__exports.defaultFontFamily={name:"Default system font",nameShort:"Default font",fontFamily:false,};const fontFamilyItems=__exports.fontFamilyItems=[defaultFontFamily,{name:"Arial (sans-serif)",nameShort:"Arial",fontFamily:"Arial, sans-serif"},{name:"Verdana (sans-serif)",nameShort:"Verdana",fontFamily:"Verdana, sans-serif"},{name:"Tahoma (sans-serif)",nameShort:"Tahoma",fontFamily:"Tahoma, sans-serif"},{name:"Trebuchet MS (sans-serif)",nameShort:"Trebuchet MS",fontFamily:'"Trebuchet MS", sans-serif',},{name:"Courier New (monospace)",nameShort:"Courier New",fontFamily:'"Courier New", monospace',},];const FontFamilyPlugin=__exports.FontFamilyPlugin=class FontFamilyPlugin extends Plugin{static id="fontFamily";static dependencies=["split","selection","dom","format","font"];fontFamily=reactive({displayName:defaultFontFamily.nameShort});resources={toolbar_items:[withSequence(15,{id:"font-family",groupId:"font",description:_t("Select font family"),Component:FontFamilySelector,props:{fontFamilyItems:fontFamilyItems,currentFontFamily:this.fontFamily,onSelected:(item)=>{this.dependencies.format.formatSelection("fontFamily",{applyStyle:item.fontFamily!==false,formatProps:item,});this.fontFamily.displayName=item.nameShort;},},isAvailable:(selection)=>isHtmlContentSupported(selection)&&(this.config.allowFontFamily??true),}),],selectionchange_handlers:this.updateCurrentFontFamily.bind(this),post_undo_handlers:this.updateCurrentFontFamily.bind(this),post_redo_handlers:this.updateCurrentFontFamily.bind(this),};updateCurrentFontFamily(ev){const selelectionData=this.dependencies.selection.getSelectionData();if(!selelectionData.documentSelectionIsInEditable){return;}
const anchorElement=closestElement(selelectionData.editableSelection.anchorNode);const anchorElementFontFamily=getComputedStyle(anchorElement).fontFamily;const currentFontItem=anchorElementFontFamily&&fontFamilyItems.find((item)=>item.fontFamily===anchorElementFontFamily);this.fontFamily.displayName=(currentFontItem||defaultFontFamily).nameShort;}}
return __exports;});;

/* /html_editor/static/src/main/font/font_family_selector.js */
odoo.define('@html_editor/main/font/font_family_selector',['@odoo/owl','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_item','@html_editor/main/toolbar/toolbar','@html_editor/dropdown_autovisibility_hook','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const{Dropdown}=require("@web/core/dropdown/dropdown");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{toolbarButtonProps}=require("@html_editor/main/toolbar/toolbar");const{useDropdownAutoVisibility}=require("@html_editor/dropdown_autovisibility_hook");const{useChildRef}=require("@web/core/utils/hooks");const FontFamilySelector=__exports.FontFamilySelector=class FontFamilySelector extends Component{static template="html_editor.FontFamilySelector";static props={document:{optional:true},fontFamilyItems:Object,currentFontFamily:Object,onSelected:Function,...toolbarButtonProps,};static components={Dropdown,DropdownItem};setup(){this.menuRef=useChildRef();useDropdownAutoVisibility(this.env.overlayState,this.menuRef);}}
return __exports;});;

/* /html_editor/static/src/main/font/font_plugin.js */
odoo.define('@html_editor/main/font/font_plugin',['@html_editor/plugin','@html_editor/utils/blocks','@html_editor/utils/dom','@html_editor/utils/dom_info','@html_editor/utils/dom_traversal','@html_editor/utils/formatting','@html_editor/utils/position','@web/core/l10n/translation','@html_editor/main/font/font_selector','@html_editor/utils/base_container','@html_editor/utils/resource','@odoo/owl','@html_editor/main/font/font_size_selector','@html_editor/core/selection_plugin','@html_editor/utils/functions'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{isBlock,closestBlock}=require("@html_editor/utils/blocks");const{unwrapContents}=require("@html_editor/utils/dom");const{isParagraphRelatedElement,isRedundantElement,isEmptyBlock,isVisibleTextNode,isZWS,isContentEditableAncestor,}=require("@html_editor/utils/dom_info");const{ancestors,childNodes,closestElement,createDOMPathGenerator,descendants,selectElements,}=require("@html_editor/utils/dom_traversal");const{convertNumericToUnit,getCSSVariableValue,getHtmlStyle,getFontSizeDisplayValue,FONT_SIZE_CLASSES,}=require("@html_editor/utils/formatting");const{DIRECTIONS}=require("@html_editor/utils/position");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{FontSelector}=require("@html_editor/main/font/font_selector");const{getBaseContainerSelector,SUPPORTED_BASE_CONTAINER_NAMES,}=require("@html_editor/utils/base_container");const{withSequence}=require("@html_editor/utils/resource");const{reactive}=require("@odoo/owl");const{FontSizeSelector}=require("@html_editor/main/font/font_size_selector");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const{weakMemoize}=require("@html_editor/utils/functions");const fontSizeItems=__exports.fontSizeItems=[{variableName:"display-1-font-size",className:"display-1-fs"},{variableName:"display-2-font-size",className:"display-2-fs"},{variableName:"display-3-font-size",className:"display-3-fs"},{variableName:"display-4-font-size",className:"display-4-fs"},{variableName:"h1-font-size",className:"h1-fs"},{variableName:"h2-font-size",className:"h2-fs"},{variableName:"h3-font-size",className:"h3-fs"},{variableName:"h4-font-size",className:"h4-fs"},{variableName:"h5-font-size",className:"h5-fs"},{variableName:"h6-font-size",className:"h6-fs"},{variableName:"font-size-base",className:"base-fs"},{variableName:"small-font-size",className:"o_small-fs"},];const rightLeafOnlyNotBlockPath=createDOMPathGenerator(DIRECTIONS.RIGHT,{leafOnly:true,stopTraverseFunction:isBlock,stopFunction:isBlock,});const headingTags=["H1","H2","H3","H4","H5","H6"];const handledElemSelector=[...headingTags,"PRE","BLOCKQUOTE"].join(", ");const FontPlugin=__exports.FontPlugin=class FontPlugin extends Plugin{static id="font";static dependencies=["baseContainer","input","split","selection","dom","format","lineBreak",];resources={font_items:[withSequence(10,{name:_t("Header 1 Display 1"),tagName:"h1",extraClass:"display-1",}),...[{name:_t("Header 1"),tagName:"h1"},{name:_t("Header 2"),tagName:"h2"},{name:_t("Header 3"),tagName:"h3"},{name:_t("Header 4"),tagName:"h4"},{name:_t("Header 5"),tagName:"h5"},{name:_t("Header 6"),tagName:"h6"},].map((item)=>withSequence(20,item)),withSequence(30,{name:_t("Normal"),tagName:"div",selector:getBaseContainerSelector("DIV"),}),withSequence(40,{name:_t("Paragraph"),tagName:"p"}),withSequence(50,{name:_t("Code"),tagName:"pre"}),withSequence(60,{name:_t("Quote"),tagName:"blockquote"}),],user_commands:[{id:"setTagHeading",run:({level}={})=>this.dependencies.dom.setBlock({tagName:`H${level ?? 1}`}),isAvailable:this.blockFormatIsAvailable.bind(this),},{id:"setTagHeading1",title:_t("Heading 1"),description:_t("Big section heading"),icon:"fa-header",run:()=>this.dependencies.dom.setBlock({tagName:"H1"}),isAvailable:this.blockFormatIsAvailable.bind(this),},{id:"setTagHeading2",title:_t("Heading 2"),description:_t("Medium section heading"),icon:"fa-header",run:()=>this.dependencies.dom.setBlock({tagName:"H2"}),isAvailable:this.blockFormatIsAvailable.bind(this),},{id:"setTagHeading3",title:_t("Heading 3"),description:_t("Small section heading"),icon:"fa-header",run:()=>this.dependencies.dom.setBlock({tagName:"H3"}),isAvailable:this.blockFormatIsAvailable.bind(this),},{id:"setTagParagraph",title:_t("Text"),description:_t("Paragraph block"),icon:"fa-paragraph",run:()=>{this.dependencies.dom.setBlock({tagName:this.dependencies.baseContainer.getDefaultNodeName(),});},isAvailable:this.blockFormatIsAvailable.bind(this),},{id:"setTagQuote",title:_t("Quote"),description:_t("Add a blockquote section"),icon:"fa-quote-right",run:()=>this.dependencies.dom.setBlock({tagName:"blockquote"}),isAvailable:this.blockFormatIsAvailable.bind(this),},{id:"setTagPre",title:_t("Code"),description:_t("Add a code section"),icon:"fa-code",run:()=>this.dependencies.dom.setBlock({tagName:"pre"}),isAvailable:this.blockFormatIsAvailable.bind(this),},],toolbar_groups:[withSequence(10,{id:"font",}),],toolbar_items:[withSequence(10,{id:"font",groupId:"font",namespaces:["compact","expanded"],description:_t("Select font style"),Component:FontSelector,props:{getItems:()=>this.availableFontItems,getDisplay:()=>this.font,onSelected:(item)=>{this.dependencies.dom.setBlock({tagName:item.tagName,extraClass:item.extraClass,});this.updateFontSelectorParams();},},isAvailable:this.blockFormatIsAvailable.bind(this),}),withSequence(20,{id:"font-size",groupId:"font",namespaces:["compact","expanded"],description:_t("Select font size"),Component:FontSizeSelector,props:{getItems:()=>this.fontSizeItems,getDisplay:()=>this.fontSize,onFontSizeInput:(size)=>{this.dependencies.format.formatSelection("fontSize",{formatProps:{size},applyStyle:true,});this.updateFontSizeSelectorParams();},onSelected:(item)=>{this.dependencies.format.formatSelection("setFontSizeClassName",{formatProps:{className:item.className},applyStyle:true,});this.updateFontSizeSelectorParams();},onBlur:()=>this.dependencies.selection.focusEditable(),document:this.document,},isAvailable:isHtmlContentSupported,}),],powerbox_categories:withSequence(5,{id:"format",name:_t("Format")}),powerbox_items:[{categoryId:"format",commandId:"setTagHeading1",keywords:[_t("title")],},{categoryId:"format",commandId:"setTagHeading2",keywords:[_t("title")],},{categoryId:"format",commandId:"setTagHeading3",keywords:[_t("title")],},{categoryId:"format",commandId:"setTagParagraph",},{categoryId:"format",commandId:"setTagQuote",},{categoryId:"format",commandId:"setTagPre",},],shorthands:[{pattern:/^#$/,commandId:"setTagHeading",commandParams:{level:1},},{pattern:/^##$/,commandId:"setTagHeading",commandParams:{level:2},},{pattern:/^###$/,commandId:"setTagHeading",commandParams:{level:3},},{pattern:/^####$/,commandId:"setTagHeading",commandParams:{level:4},},{pattern:/^#####$/,commandId:"setTagHeading",commandParams:{level:5},},{pattern:/^######$/,commandId:"setTagHeading",commandParams:{level:6},},{pattern:/^>$/,commandId:"setTagQuote",},],hints:[{selector:"H1",text:_t("Heading 1")},{selector:"H2",text:_t("Heading 2")},{selector:"H3",text:_t("Heading 3")},{selector:"H4",text:_t("Heading 4")},{selector:"H5",text:_t("Heading 5")},{selector:"H6",text:_t("Heading 6")},{selector:"PRE",text:_t("Code")},{selector:"BLOCKQUOTE",text:_t("Quote")},],selectionchange_handlers:[this.updateFontSelectorParams.bind(this),this.updateFontSizeSelectorParams.bind(this),],post_undo_handlers:[this.updateFontSelectorParams.bind(this),this.updateFontSizeSelectorParams.bind(this),],post_redo_handlers:[this.updateFontSelectorParams.bind(this),this.updateFontSizeSelectorParams.bind(this),],normalize_handlers:this.normalize.bind(this),split_element_block_overrides:[this.handleSplitBlockHeading.bind(this),this.handleSplitBlockPRE.bind(this),this.handleSplitBlockquote.bind(this),],delete_backward_overrides:withSequence(20,this.handleDeleteBackward.bind(this)),delete_backward_word_overrides:this.handleDeleteBackward.bind(this),clipboard_content_processors:this.processContentForClipboard.bind(this),before_insert_processors:this.handleInsertWithinPre.bind(this),format_class_predicates:(className)=>[...FONT_SIZE_CLASSES,"o_default_font_size"].includes(className),};setup(){this.fontSize=reactive({displayName:""});this.font=reactive({displayName:""});this.blockFormatIsAvailableMemoized=weakMemoize((selection)=>isHtmlContentSupported(selection)&&this.dependencies.dom.canSetBlock());this.availableFontItems=this.getResource("font_items").filter(({tagName})=>!SUPPORTED_BASE_CONTAINER_NAMES.includes(tagName.toUpperCase())||this.config.baseContainers.includes(tagName.toUpperCase()));}
normalize(root){for(const el of selectElements(root,"strong, b, span[style*='font-weight: bolder'], small")){if(isRedundantElement(el)){unwrapContents(el);}}}
get fontName(){const sel=this.dependencies.selection.getSelectionData().deepEditableSelection;const anchorNode=sel.anchorNode;const block=closestBlock(anchorNode);const tagName=block.tagName.toLowerCase();const matchingItems=this.availableFontItems.filter((item)=>item.selector?block.matches(item.selector):item.tagName===tagName);const matchingItemsWitoutExtraClass=matchingItems.filter((item)=>!item.extraClass);if(!matchingItems.length){return _t("Normal");}
return(matchingItems.find((item)=>block.classList.contains(item.extraClass))||(matchingItemsWitoutExtraClass.length&&matchingItemsWitoutExtraClass[0])).name;}
get fontSizeName(){const sel=this.dependencies.selection.getSelectionData().deepEditableSelection;if(!sel){return fontSizeItems[0].name;}
return Math.round(getFontSizeDisplayValue(sel,this.document));}
get fontSizeItems(){const style=getHtmlStyle(this.document);const nameAlreadyUsed=new Set();return fontSizeItems.flatMap((item)=>{const strValue=getCSSVariableValue(item.variableName,style);if(!strValue){return[];}
const remValue=parseFloat(strValue);const pxValue=convertNumericToUnit(remValue,"rem","px",style);const roundedValue=Math.round(pxValue);if(nameAlreadyUsed.has(roundedValue)){return[];}
nameAlreadyUsed.add(roundedValue);return[{...item,tagName:"span",name:roundedValue}];}).sort((a,b)=>a.name-b.name);}
blockFormatIsAvailable(selection){return this.blockFormatIsAvailableMemoized(selection);}
handleSplitBlockPRE({targetNode,targetOffset}){const closestPre=closestElement(targetNode,"pre");const closestBlockNode=closestBlock(targetNode);if(!closestPre||(closestBlockNode.nodeName!=="PRE"&&((closestBlockNode.textContent&&!isZWS(closestBlockNode))||closestBlockNode.nextSibling))){return;}
const nodesAfterTarget=[...rightLeafOnlyNotBlockPath(targetNode,targetOffset)];if(!nodesAfterTarget.length||(nodesAfterTarget.length===1&&nodesAfterTarget[0].nodeName==="BR")||isEmptyBlock(closestBlockNode)){const[beforeElement,afterElement]=this.dependencies.split.splitElementBlock({targetNode,targetOffset,blockToSplit:closestBlockNode,});const isPreBlock=beforeElement.nodeName==="PRE";const baseContainer=isPreBlock?this.dependencies.baseContainer.createBaseContainer():afterElement;if(isPreBlock){baseContainer.replaceChildren(...afterElement.childNodes);afterElement.replaceWith(baseContainer);}else{beforeElement.remove();closestPre.after(afterElement);}
const dir=closestBlockNode.getAttribute("dir")||closestPre.getAttribute("dir");if(dir){baseContainer.setAttribute("dir",dir);}
this.dependencies.selection.setCursorStart(baseContainer);}else{const lineBreak=this.document.createElement("br");targetNode.insertBefore(lineBreak,targetNode.childNodes[targetOffset]);this.dependencies.selection.setCursorEnd(lineBreak);}
return true;}
handleSplitBlockquote({targetNode,targetOffset,blockToSplit}){const closestQuote=closestElement(targetNode,"blockquote");const closestBlockNode=closestBlock(targetNode);const blockQuotedir=closestQuote&&closestQuote.getAttribute("dir");if(!closestQuote||closestBlockNode.nodeName!=="BLOCKQUOTE"){if(closestBlockNode.parentElement===closestQuote&&closestBlockNode.parentElement.lastElementChild===closestBlockNode&&!closestBlockNode.textContent){closestQuote.after(closestBlockNode);if(blockQuotedir&&!closestBlockNode.getAttribute("dir")){closestBlockNode.setAttribute("dir",blockQuotedir);}
this.dependencies.selection.setSelection({anchorNode:closestBlockNode,anchorOffset:0,});return true;}
return;}
const selection=this.dependencies.selection.getEditableSelection();const previousElementSibling=selection.anchorNode?.childNodes[selection.anchorOffset-1];const nextElementSibling=selection.anchorNode?.childNodes[selection.anchorOffset];if(previousElementSibling?.tagName==="BR"&&nextElementSibling?.tagName==="BR"){nextElementSibling.remove();previousElementSibling.remove();this.dependencies.split.splitElementBlock({targetNode,targetOffset,blockToSplit,});this.dependencies.dom.setBlock({tagName:this.dependencies.baseContainer.getDefaultNodeName(),});return true;}
this.dependencies.lineBreak.insertLineBreakElement({targetNode,targetOffset});return true;}
handleSplitBlockHeading(params){const closestHeading=closestElement(params.targetNode,(element)=>headingTags.includes(element.tagName));if(closestHeading){const[,newElement]=this.dependencies.split.splitElementBlock(params);if(newElement&&headingTags.includes(newElement.tagName)&&!descendants(newElement).some(isVisibleTextNode)){const baseContainer=this.dependencies.baseContainer.createBaseContainer();const dir=newElement.getAttribute("dir");if(dir){baseContainer.setAttribute("dir",dir);}
baseContainer.replaceChildren(...newElement.childNodes);newElement.replaceWith(baseContainer);this.dependencies.selection.setCursorStart(baseContainer);}
return true;}}
handleDeleteBackward({startContainer,startOffset,endContainer,endOffset}){const rangeIsCollapsed=startContainer===endContainer&&startOffset===endOffset;const closestHandledElement=closestElement(endContainer,handledElemSelector);if(!rangeIsCollapsed&&closestHandledElement?.tagName!=="BLOCKQUOTE"){return;}
if(!closestHandledElement||closestHandledElement.textContent.length){return;}
if(this.getResource("unremovable_node_predicates").some((p)=>p(closestHandledElement))){return;}
const baseContainer=this.dependencies.baseContainer.createBaseContainer();baseContainer.append(...closestHandledElement.childNodes);closestHandledElement.after(baseContainer);closestHandledElement.remove();this.dependencies.selection.setCursorStart(baseContainer);return true;}
updateFontSelectorParams(){this.font.displayName=this.fontName;}
updateFontSizeSelectorParams(){this.fontSize.displayName=this.fontSizeName;}
processContentForClipboard(clonedContents,selection){const commonAncestorElement=closestElement(selection.commonAncestorContainer);if(commonAncestorElement&&!isBlock(clonedContents.firstChild)){const blockEl=closestBlock(commonAncestorElement);const ancestorsList=[commonAncestorElement,...ancestors(commonAncestorElement,blockEl),];for(const ancestor of ancestorsList){if(isContentEditableAncestor(ancestor)){break;}
if(!isBlock(ancestor)||isParagraphRelatedElement(ancestor)){const clone=ancestor.cloneNode();clone.append(...childNodes(clonedContents));clonedContents.appendChild(clone);}}}
return clonedContents;}
handleInsertWithinPre(insertContainer,block){if(block.nodeName!=="PRE"){return insertContainer;}
for(const cb of this.getResource("before_insert_within_pre_processors")){insertContainer=cb(insertContainer);}
const isDeepestBlock=(node)=>isBlock(node)&&![...node.querySelectorAll("*")].some(isBlock);let linebreak;const processNode=(node)=>{const children=childNodes(node);if(isDeepestBlock(node)&&node.nextSibling){linebreak=this.document.createTextNode("\n");node.append(linebreak);}
if(node.nodeType===Node.ELEMENT_NODE){unwrapContents(node);}
for(const child of children){processNode(child);}};for(const node of childNodes(insertContainer)){processNode(node);}
return insertContainer;}}
return __exports;});;

/* /html_editor/static/src/main/font/font_selector.js */
odoo.define('@html_editor/main/font/font_selector',['@odoo/owl','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_item','@html_editor/main/toolbar/toolbar','@html_editor/dropdown_autovisibility_hook','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Component,useState}=require("@odoo/owl");const{Dropdown}=require("@web/core/dropdown/dropdown");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{toolbarButtonProps}=require("@html_editor/main/toolbar/toolbar");const{useDropdownAutoVisibility}=require("@html_editor/dropdown_autovisibility_hook");const{useChildRef}=require("@web/core/utils/hooks");const FontSelector=__exports.FontSelector=class FontSelector extends Component{static template="html_editor.FontSelector";static props={...toolbarButtonProps,getItems:Function,getDisplay:Function,onSelected:Function,};static components={Dropdown,DropdownItem};setup(){this.items=this.props.getItems();this.state=useState(this.props.getDisplay());this.menuRef=useChildRef();useDropdownAutoVisibility(this.env.overlayState,this.menuRef);}
onSelected(item){this.props.onSelected(item);}}
return __exports;});;

/* /html_editor/static/src/main/font/font_size_selector.js */
odoo.define('@html_editor/main/font/font_size_selector',['@odoo/owl','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_item','@html_editor/main/toolbar/toolbar','@web/core/dropdown/dropdown_hooks','@web/core/utils/timing','@web/core/browser/cookie','@html_editor/utils/formatting','@html_editor/dropdown_autovisibility_hook','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Component,onMounted,useEffect,useRef,useState}=require("@odoo/owl");const{Dropdown}=require("@web/core/dropdown/dropdown");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{toolbarButtonProps}=require("@html_editor/main/toolbar/toolbar");const{useDropdownState}=require("@web/core/dropdown/dropdown_hooks");const{useDebounced}=require("@web/core/utils/timing");const{cookie}=require("@web/core/browser/cookie");const{getCSSVariableValue,getHtmlStyle}=require("@html_editor/utils/formatting");const{useDropdownAutoVisibility}=require("@html_editor/dropdown_autovisibility_hook");const{useChildRef}=require("@web/core/utils/hooks");const MAX_FONT_SIZE=144;const FontSizeSelector=__exports.FontSizeSelector=class FontSizeSelector extends Component{static template="html_editor.FontSizeSelector";static props={getItems:Function,getDisplay:Function,onFontSizeInput:Function,onSelected:Function,onBlur:{type:Function,optional:true},document:{validate:(p)=>p.nodeType===Node.DOCUMENT_NODE},...toolbarButtonProps,};static components={Dropdown,DropdownItem};setup(){this.items=this.props.getItems();this.state=useState(this.props.getDisplay());this.dropdown=useDropdownState();this.menuRef=useChildRef();useDropdownAutoVisibility(this.env.overlayState,this.menuRef);this.iframeContentRef=useRef("iframeContent");this.debouncedCustomFontSizeInput=useDebounced(this.onCustomFontSizeInput,200);onMounted(()=>{const iframeEl=this.iframeContentRef.el;const initFontSizeInput=()=>{const iframeDoc=iframeEl.contentWindow.document;if(this.fontSizeInput||!iframeDoc.body){return;}
this.fontSizeInput=iframeDoc.createElement("input");const isDarkMode=cookie.get("color_scheme")==="dark";const htmlStyle=getHtmlStyle(document);const backgroundColor=getCSSVariableValue(isDarkMode?"gray-200":"white",htmlStyle);const color=getCSSVariableValue("black",htmlStyle);const fontFamily=getCSSVariableValue("o-system-fonts",htmlStyle);Object.assign(iframeDoc.body.style,{padding:"0",margin:"0",});Object.assign(this.fontSizeInput.style,{width:"100%",height:"100%",border:"none",outline:"none",textAlign:"center",backgroundColor:backgroundColor,color:color,fontFamily:fontFamily,});this.fontSizeInput.type="text";this.fontSizeInput.name="font-size-input";this.fontSizeInput.autocomplete="off";this.fontSizeInput.value=this.state.displayName;iframeDoc.body.appendChild(this.fontSizeInput);this.fontSizeInput.addEventListener("click",()=>{if(!this.dropdown.isOpen){this.dropdown.open();}});this.fontSizeInput.addEventListener("input",this.debouncedCustomFontSizeInput);this.fontSizeInput.addEventListener("keydown",this.onKeyDownFontSizeInput.bind(this));};if(iframeEl.contentDocument.readyState==="complete"){initFontSizeInput();}else{iframeEl.addEventListener("load",()=>{initFontSizeInput();},{once:true});}});useEffect(()=>{if(this.fontSizeInput){this.fontSizeInput.value=this.state.displayName;}},()=>[this.state.displayName]);useEffect(()=>{if(this.fontSizeInput){if(this.dropdown.isOpen){this.fontSizeInput.select();}else if(this.iframeContentRef.el?.contains(this.props.document.activeElement)){this.fontSizeInput.blur();this.props.onBlur?.();}}},()=>[this.dropdown.isOpen]);}
onCustomFontSizeInput(ev){let fontSize=parseInt(ev.target.value,10);if(fontSize>0){fontSize=Math.min(fontSize,MAX_FONT_SIZE);if(this.state.displayName!==fontSize){this.props.onFontSizeInput(`${fontSize}px`);}else{this.fontSizeInput.value=this.state.displayName;}}
this.fontSizeInput.focus();}
onKeyDownFontSizeInput(ev){if(["Enter","Tab"].includes(ev.key)&&this.dropdown.isOpen){this.dropdown.close();}else if(["ArrowUp","ArrowDown"].includes(ev.key)){const fontSizeSelectorMenu=document.querySelector(".o_font_size_selector_menu div");if(!fontSizeSelectorMenu){return;}
ev.target.blur();const fontSizeMenuItemToFocus=ev.key==="ArrowUp"?fontSizeSelectorMenu.lastElementChild:fontSizeSelectorMenu.firstElementChild;if(fontSizeMenuItemToFocus){fontSizeMenuItemToFocus.focus();}}}
onSelected(item){this.props.onSelected(item);}}
return __exports;});;

/* /html_editor/static/src/main/font/gradient_picker/gradient_picker.js */
odoo.define('@html_editor/main/font/gradient_picker/gradient_picker',['@odoo/owl','@web/core/color_picker/custom_color_picker/custom_color_picker','@web/core/utils/colors'],function(require){'use strict';let __exports={};const{Component,onWillUpdateProps,useState,useRef}=require("@odoo/owl");const{CustomColorPicker:ColorPicker}=require("@web/core/color_picker/custom_color_picker/custom_color_picker");const{isColorGradient,standardizeGradient,rgbaToHex,convertCSSColorToRgba,}=require("@web/core/utils/colors");const GradientPicker=__exports.GradientPicker=class GradientPicker extends Component{static components={ColorPicker};static template="html_editor.GradientPicker";static props={onGradientChange:{type:Function,optional:true},onGradientPreview:{type:Function,optional:true},setOnCloseCallback:{type:Function,optional:true},setOperationCallbacks:{type:Function,optional:true},selectedGradient:{type:String,optional:true},noTransparency:{type:Boolean,optional:true},};setup(){this.state=useState({type:"linear",angle:135,currentColorIndex:0,size:"closest-side",});this.positions=useState({x:25,y:25});this.colors=useState([{hex:"#DF7CC4",percentage:0},{hex:"#6C3582",percentage:100},]);this.cssGradients=useState({preview:"",linear:"",radial:"",sliderThumbStyle:""});this.knobRef=useRef("gradientAngleKnob");if(this.props.selectedGradient&&isColorGradient(this.props.selectedGradient)){this.setGradientFromString(this.props.selectedGradient);}else{this.onColorGradientChange();}
onWillUpdateProps((newProps)=>{if(newProps.selectedGradient){this.setGradientFromString(newProps.selectedGradient);}});}
setGradientFromString(gradient){if(!gradient||!isColorGradient(gradient)){return;}
gradient=standardizeGradient(gradient);const colors=[...gradient.matchAll(/(#[0-9a-f]{6}|rgba?\(\s*[0-9]+\s*,\s*[0-9]+\s*,\s*[0-9]+\s*[,\s*[0-9.]*]?\s*\)|[a-z]+)\s*([[0-9]+%]?)/g),].filter((color)=>rgbaToHex(color[1])!=="#");this.colors.splice(0,this.colors.length);for(const color of colors){this.colors.push({hex:rgbaToHex(color[1]),percentage:color[2].replace("%","")});}
const isLinear=gradient.startsWith("linear-gradient(");if(isLinear){const angle=gradient.match(/(-?[0-9]+)deg/);if(angle){this.state.angle=parseInt(angle[1]);}}else{this.state.type="radial";const sizeMatch=gradient.match(/(closest|farthest)-(side|corner)/);const size=sizeMatch?sizeMatch[0]:"farthest-corner";this.state.size=size;const position=gradient.match(/ at ([0-9]+)% ([0-9]+)%/)||["","50","50"];this.positions.x=position[1];this.positions.y=position[2];}
this.updateCssGradients();}
selectType(type){this.state.type=type;this.onColorGradientChange();}
onAngleChange(ev){const angle=parseInt(ev.target.value);if(!isNaN(angle)){const clampedAngle=Math.min(Math.max(angle,0),360);ev.target.value=clampedAngle;this.state.angle=clampedAngle;this.onColorGradientChange();}}
onPositionChange(position,ev){const inputValue=parseFloat(ev.target.value);if(!isNaN(inputValue)){const clampedValue=Math.min(Math.max(inputValue,0),100);ev.target.value=clampedValue;this.positions[position]=clampedValue;this.onColorGradientChange();}}
onColorChange(color){const hex=rgbaToHex(color.cssColor);this.colors[this.state.currentColorIndex].hex=hex;this.onColorGradientChange();}
onColorPreview(color){const hex=rgbaToHex(color.cssColor);this.colors[this.state.currentColorIndex].hex=hex;this.onColorGradientPreview();}
onSizeChange(size){this.state.size=size;this.onColorGradientChange();}
onColorPercentageChange(colorIndex,ev){this.state.currentColorIndex=colorIndex;this.colors[colorIndex].percentage=ev.target.value;this.sortColors();this.onColorGradientChange();}
onGradientPreviewClick(ev){const width=parseInt(window.getComputedStyle(ev.target).width,10);const percentage=Math.round((100*ev.offsetX)/width);this.addColorStop(percentage);}
addColorStop(percentage){let color;let previousColor=this.colors.findLast((color)=>color.percentage<=percentage);let nextColor=this.colors.find((color)=>color.percentage>percentage);if(!previousColor&&nextColor){color=nextColor.hex;}else if(!nextColor&&previousColor){color=previousColor.hex;}else if(nextColor&&previousColor){const previousRatio=(nextColor.percentage-percentage)/(nextColor.percentage-previousColor.percentage);const nextRatio=1-previousRatio;previousColor=convertCSSColorToRgba(previousColor.hex);nextColor=convertCSSColorToRgba(nextColor.hex);const red=Math.round(previousRatio*previousColor.red+nextRatio*nextColor.red);const green=Math.round(previousRatio*previousColor.green+nextRatio*nextColor.green);const blue=Math.round(previousRatio*previousColor.blue+nextRatio*nextColor.blue);const opacity=Math.round(previousRatio*previousColor.opacity+nextRatio*nextColor.opacity);color=`rgba(${red}, ${green}, ${blue}, ${opacity / 100})`;}
this.colors.push({hex:color,percentage});this.sortColors();this.state.currentColorIndex=this.colors.findIndex((color)=>color.percentage===percentage);this.onColorGradientChange();}
removeColor(colorIndex){if(this.colors.length<=2){return;}
this.colors.splice(colorIndex,1);this.state.currentColorIndex=0;this.onColorGradientChange();}
sortColors(){this.colors=this.colors.sort((a,b)=>a.percentage-b.percentage);}
updateCssGradients(){const gradientColors=this.colors.map((color)=>`${color.hex} ${color.percentage}%`).join(", ");let sliderThumbStyle="";for(let i=0;i<this.colors.length;i++){const selector=`.gradient-colors div:nth-child(${i + 1}) input[type="range"]`;const style=`background-color: ${this.colors[i].hex};`;sliderThumbStyle+=`${selector}::-webkit-slider-thumb { ${style} }\n`;sliderThumbStyle+=`${selector}::-moz-range-thumb { ${style} }\n`;}
this.cssGradients.preview=`linear-gradient(90deg, ${gradientColors})`;this.cssGradients.linear=`linear-gradient(${this.state.angle}deg, ${gradientColors})`;this.cssGradients.radial=`radial-gradient(circle ${this.state.size} at ${this.positions.x}% ${this.positions.y}%, ${gradientColors})`;this.cssGradients.sliderThumbStyle=sliderThumbStyle;}
onColorGradientChange(){this.updateCssGradients();this.props?.onGradientChange(this.cssGradients[this.state.type]);}
onColorGradientPreview(){this.updateCssGradients();this.props.onGradientPreview?.({gradient:this.cssGradients[this.state.type]});}
get currentColorHex(){return this.colors?.[this.state.currentColorIndex]?.hex||"#000000";}
onKnobMouseDown(ev){const knobEl=this.knobRef.el;if(!knobEl){return;}
const knobRadius=knobEl.offsetWidth/2;const knobRect=knobEl.getBoundingClientRect();const centerX=knobRect.left+knobRadius;const centerY=knobRect.top+knobRadius;const updateAngle=(ev)=>{const distanceX=ev.clientX-centerX;const distanceY=ev.clientY-centerY;const angle=Math.atan2(distanceY,distanceX)*(180/Math.PI);this.state.angle=Math.round((angle+360)%360);};updateAngle(ev);this.onColorGradientChange();const onKnobMouseMove=(ev)=>{updateAngle(ev);this.onColorGradientChange();};const onKnobMouseUp=()=>document.removeEventListener("mousemove",onKnobMouseMove);document.addEventListener("mousemove",onKnobMouseMove);document.addEventListener("mouseup",onKnobMouseUp,{once:true});}}
return __exports;});;

/* /html_editor/static/src/main/hint_plugin.js */
odoo.define('@html_editor/main/hint_plugin',['@html_editor/plugin','@html_editor/utils/dom_info','@html_editor/utils/dom','@html_editor/utils/dom_traversal','@html_editor/utils/blocks'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{isEditorTab,isEmptyBlock,isProtected}=require("@html_editor/utils/dom_info");const{removeClass}=require("@html_editor/utils/dom");const{descendants,selectElements}=require("@html_editor/utils/dom_traversal");const{closestBlock}=require("@html_editor/utils/blocks");const HintPlugin=__exports.HintPlugin=class HintPlugin extends Plugin{static id="hint";static dependencies=["history","selection"];resources={selectionchange_handlers:this.updateHints.bind(this),external_history_step_handlers:()=>{this.clearHints();this.updateHints();},normalize_handlers:this.normalize.bind(this),clean_for_save_handlers:({root})=>this.clearHints(root),content_updated_handlers:this.updateHints.bind(this),hint_targets_providers:(selectionData,editable)=>{if(!selectionData.currentSelectionIsInEditable||!selectionData.documentSelection){return[];}
const blockEl=closestBlock(selectionData.documentSelection.anchorNode);if(this.dependencies.selection.isNodeEditable(blockEl)){return[blockEl];}else{return[];}},system_classes:["o-we-hint"],system_attributes:["o-we-hint-text"],};setup(){this.updateHints(this.editable);}
destroy(){super.destroy();this.clearHints();}
normalize(){this.clearHints();this.updateHints();}
updateHints(){const selectionData=this.dependencies.selection.getSelectionData();const editableSelection=selectionData.editableSelection;this.clearHints();if(editableSelection.isCollapsed){const hints=this.getResource("hints");for(const provideTargets of this.getResource("hint_targets_providers")){for(const target of provideTargets(selectionData,this.editable)){const nodeHint=hints.find((h)=>target.matches(h.selector))?.text;if(target&&nodeHint&&isEmptyBlock(target)&&!isProtected(target)&&!descendants(target).some(isEditorTab)){this.makeHint(target,nodeHint);}}}}}
makeHint(el,text){this.dispatchTo("make_hint_handlers",el);el.setAttribute("o-we-hint-text",text);el.classList.add("o-we-hint");}
removeHint(el){el.removeAttribute("o-we-hint-text");removeClass(el,"o-we-hint");this.getResource("system_style_properties").forEach((n)=>el.style.removeProperty(n));}
clearHints(root=this.editable){for(const elem of selectElements(root,".o-we-hint")){this.removeHint(elem);}}}
return __exports;});;

/* /html_editor/static/src/main/inline_code.js */
odoo.define('@html_editor/main/inline_code',['@html_editor/plugin','@html_editor/utils/blocks','@html_editor/utils/dom','@html_editor/utils/dom_info','@html_editor/utils/dom_traversal','@html_editor/utils/position'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{isBlock,closestBlock}=require("@html_editor/utils/blocks");const{splitTextNode,unwrapContents}=require("@html_editor/utils/dom");const{isElement,isTextNode,isZwnbsp}=require("@html_editor/utils/dom_info");const{closestElement,selectElements,findFurthest}=require("@html_editor/utils/dom_traversal");const{DIRECTIONS,nodeSize}=require("@html_editor/utils/position");const InlineCodePlugin=__exports.InlineCodePlugin=class InlineCodePlugin extends Plugin{static id="inlineCode";static dependencies=["selection","history","input","split","feff"];resources={input_handlers:this.onInput.bind(this),selectionchange_handlers:this.handleSelectionChange.bind(this),normalize_handlers:this.normalize.bind(this),feff_providers:(root,cursors)=>[...selectElements(root,".o_inline_code")].flatMap((code)=>this.dependencies.feff.surroundWithFeffs(code,cursors)),};setup(){this.addDomListener(this.document,"keydown",this.onKeyDown.bind(this));}
handleSelectionChange(){if(this.historySavePointRestore){delete this.historySavePointRestore;}}
onKeyDown(){const selection=this.dependencies.selection.getEditableSelection();if(selection.isCollapsed||closestElement(selection.anchorNode,"code")||closestElement(selection.focusNode,"code")){return;}
const targetBlocks=this.dependencies.selection.getTargetedBlocks();const hasTextNode=this.dependencies.selection.getTargetedNodes().some(isTextNode);if(targetBlocks.size===1&&hasTextNode){this.historySavePointRestore=this.dependencies.history.makeSavePoint();}}
onInput(ev){const selection=this.dependencies.selection.getEditableSelection();if(ev.data!=="`"||closestElement(selection.anchorNode,"code")){return;}
if(this.historySavePointRestore){this.historySavePointRestore();let{anchorNode,anchorOffset,focusNode,focusOffset,direction}=this.dependencies.split.splitSelection();const blockEl=closestBlock(anchorNode);const deepChild=(node,offset)=>(node===blockEl?node.childNodes[offset]:node);anchorNode=deepChild(anchorNode,anchorOffset);focusNode=deepChild(focusNode,focusOffset);if(direction===DIRECTIONS.LEFT){[anchorNode,anchorOffset,focusNode,focusOffset]=[focusNode,focusOffset,anchorNode,anchorOffset,];}
const furthestAnchorElement=findFurthest(anchorNode,blockEl,(n)=>!isBlock(n));let start=this.dependencies.split.splitAroundUntil(anchorNode,furthestAnchorElement);const furthestFocusElement=findFurthest(focusNode,blockEl,(n)=>!isBlock(n));const end=this.dependencies.split.splitAroundUntil(focusNode,furthestFocusElement);let codeElement=this.document.createElement("code");codeElement.classList.add("o_inline_code");start.before(codeElement);while(start){if(isElement(start)){for(const code of selectElements(start,"code")){start=unwrapContents(code)[0];}}
const next=start.nextSibling;if(start.nodeName==="IMG"){if(start!==end&&next){codeElement=this.document.createElement("code");codeElement.classList.add("o_inline_code");}}else{if(!codeElement.isConnected){start.before(codeElement);}
codeElement.appendChild(start);}
if(start===end){break;}
start=next;}
this.dispatchTo("to_inline_code_processors",codeElement);this.dependencies.selection.setSelection({anchorNode:codeElement,anchorOffset:nodeSize(codeElement),});this.dependencies.history.addStep();delete this.historySavePointRestore;return;}
let textNode=selection.startContainer;const wholeText=textNode.wholeText;const textHasTwoTicks=/`[^`]+`/.test(wholeText);if(textHasTwoTicks&&wholeText.replace(/`/g,"").length){let offset=selection.startOffset;let sibling=textNode.previousSibling;while(sibling&&sibling.nodeType===Node.TEXT_NODE){if(!isZwnbsp(sibling)){offset+=sibling.textContent.length;}
sibling.textContent+=textNode.textContent;textNode.remove();textNode=sibling;sibling=sibling.previousSibling;}
sibling=textNode.nextSibling;while(sibling&&sibling.nodeType===Node.TEXT_NODE){if(!isZwnbsp(sibling)){textNode.textContent+=sibling.textContent;}
sibling.remove();sibling=sibling.nextSibling;}
this.dependencies.selection.setSelection({anchorNode:textNode,anchorOffset:offset,});this.dependencies.history.addStep();const insertedBacktickIndex=offset-1;const textBeforeInsertedBacktick=textNode.textContent.substring(0,insertedBacktickIndex);let startOffset,endOffset;const isClosingForward=textBeforeInsertedBacktick.includes("`");if(isClosingForward){startOffset=textBeforeInsertedBacktick.lastIndexOf("`");endOffset=insertedBacktickIndex;}else{const textAfterInsertedBacktick=textNode.textContent.substring(offset);startOffset=insertedBacktickIndex;endOffset=offset+textAfterInsertedBacktick.indexOf("`");}
if(endOffset&&endOffset<textNode.textContent.length){splitTextNode(textNode,endOffset+1,DIRECTIONS.LEFT);}
if(startOffset){splitTextNode(textNode,startOffset);}
textNode.textContent=textNode.textContent.substring(1,textNode.textContent.length-1);const codeElement=this.document.createElement("code");codeElement.classList.add("o_inline_code");textNode.before(codeElement);codeElement.append(textNode);if(!codeElement.textContent.length){this.dependencies.history.addStep();this.dependencies.selection.setSelection({anchorNode:codeElement.firstChild,anchorOffset:1,});}else if(isClosingForward){this.dependencies.history.addStep();this.dependencies.selection.setSelection({anchorNode:codeElement.nextSibling,anchorOffset:1,});}else{this.dependencies.history.addStep();this.dependencies.selection.setSelection({anchorNode:codeElement.firstChild,anchorOffset:0,});}}}
normalize(rootEl){for(const el of selectElements(rootEl,"code.o_inline_code")){if([...el.childNodes].every((node)=>node.nodeType===Node.TEXT_NODE&&/^\uFEFF*$/.test(node.nodeValue))){el.remove();}}}}
return __exports;});;

/* /html_editor/static/src/main/link/command_category.js */
odoo.define('@html_editor/main/link/command_category',['@web/core/registry'],function(require){'use strict';let __exports={};const{registry}=require("@web/core/registry");const commandCategoryRegistry=registry.category("command_categories");commandCategoryRegistry.add("shortcut_conflict",{},{sequence:5});return __exports;});;

/* /html_editor/static/src/main/link/link_paste_plugin.js */
odoo.define('@html_editor/main/link/link_paste_plugin',['@html_editor/utils/dom_traversal','@html_editor/main/link/utils','@html_editor/utils/url','@html_editor/plugin','@html_editor/utils/position'],function(require){'use strict';let __exports={};const{closestElement}=require("@html_editor/utils/dom_traversal");const{URL_REGEX,cleanZWChars}=require("@html_editor/main/link/utils");const{isImageUrl}=require("@html_editor/utils/url");const{Plugin}=require("@html_editor/plugin");const{childNodeIndex}=require("@html_editor/utils/position");const LinkPastePlugin=__exports.LinkPastePlugin=class LinkPastePlugin extends Plugin{static id="linkPaste";static dependencies=["link","clipboard","selection","dom","history"];resources={before_paste_handlers:this.selectFullySelectedLink.bind(this),paste_text_overrides:this.handlePasteText.bind(this),};handlePasteText(selection,text){let splitAroundUrl;if(!text.match(/\${.*}/gi)){splitAroundUrl=text.split(URL_REGEX);splitAroundUrl=splitAroundUrl.filter((_,index)=>(index+1)%3);}
if(!splitAroundUrl||splitAroundUrl.length<3||closestElement(selection.anchorNode,"pre")){return false;}
if(splitAroundUrl.length===3&&!splitAroundUrl[0]&&!splitAroundUrl[2]){this.handlePasteTextUrl(selection,text);}else{this.handlePasteTextMultiUrl(selection,splitAroundUrl);}
return true;}
handlePasteTextUrl(selection,text){const selectionIsInsideALink=!!closestElement(selection.anchorNode,"a");const url=/^https?:\/\//i.test(text)?text:"http://"+text;if(selectionIsInsideALink){this.handlePasteTextUrlInsideLink(text,url);return;}
if(this.delegateTo("paste_url_overrides",text,url)){return;}
this.dependencies.link.insertLink(url,text);}
handlePasteTextUrlInsideLink(text,url){if(isImageUrl(url)){const img=this.document.createElement("IMG");img.setAttribute("src",url);this.dependencies.dom.insert(img);}else{this.dependencies.dom.insert(text);}}
handlePasteTextMultiUrl(selection,splitAroundUrl){const selectionIsInsideALink=!!closestElement(selection.anchorNode,"a");for(let i=0;i<splitAroundUrl.length;i++){const url=/^https?:\/\//gi.test(splitAroundUrl[i])?splitAroundUrl[i]:"http://"+splitAroundUrl[i];if(i%2&&!selectionIsInsideALink){this.dependencies.dom.insert(this.dependencies.link.createLink(url,splitAroundUrl[i]));}else if(splitAroundUrl[i]!==""){this.dependencies.clipboard.pasteText(splitAroundUrl[i]);}}}
selectFullySelectedLink(selection){const link=closestElement(selection.anchorNode,"a");if(link?.parentElement?.isContentEditable&&cleanZWChars(selection.textContent())===cleanZWChars(link.innerText)&&!this.getResource("unremovable_node_predicates").some((p)=>p(link))){this.dependencies.selection.setSelection({anchorNode:link.parentElement,anchorOffset:childNodeIndex(link)+(selection.direction?0:1),focusNode:link.parentElement,focusOffset:childNodeIndex(link)+(selection.direction?1:0),});}}}
return __exports;});;

/* /html_editor/static/src/main/link/link_plugin.js */
odoo.define('@html_editor/main/link/link_plugin',['@html_editor/plugin','@html_editor/utils/dom','@html_editor/utils/dom_traversal','@html_editor/utils/selection','@web/core/l10n/translation','@html_editor/main/link/link_popover','@html_editor/utils/position','@html_editor/main/link/utils','@html_editor/utils/dom_info','@web/core/utils/concurrency','@web/core/network/rpc','@web/core/utils/functions','@html_editor/utils/resource','@html_editor/utils/blocks','@html_editor/core/selection_plugin','@web/core/browser/feature_detection'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{unwrapContents}=require("@html_editor/utils/dom");const{closestElement,descendants,selectElements}=require("@html_editor/utils/dom_traversal");const{findInSelection,callbacksForCursorUpdate}=require("@html_editor/utils/selection");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{LinkPopover}=require("@html_editor/main/link/link_popover");const{DIRECTIONS,leftPos,nodeSize,rightPos}=require("@html_editor/utils/position");const{EMAIL_REGEX,URL_REGEX,cleanZWChars,deduceURLfromText}=require("@html_editor/main/link/utils");const{isElement,isVisible,isZwnbsp}=require("@html_editor/utils/dom_info");const{KeepLast}=require("@web/core/utils/concurrency");const{rpc}=require("@web/core/network/rpc");const{memoize}=require("@web/core/utils/functions");const{withSequence}=require("@html_editor/utils/resource");const{isBlock,closestBlock}=require("@html_editor/utils/blocks");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const{isBrowserFirefox}=require("@web/core/browser/feature_detection");function isLinkActive(selection){const linkElementAnchor=closestElement(selection.anchorNode,"A");const linkElementFocus=closestElement(selection.focusNode,"A");if(linkElementFocus&&linkElementAnchor){return linkElementAnchor===linkElementFocus;}
if(linkElementAnchor||linkElementFocus){return true;}
return false;}
function isPositionAtEdgeofLink(link,offset){const childNodes=[...link.childNodes];if(!childNodes.length){return"end";}
let firstVisibleIndex=childNodes.findIndex(isVisible);firstVisibleIndex=firstVisibleIndex===-1?0:firstVisibleIndex;if(offset<=firstVisibleIndex){return"start";}
let lastVisibleIndex=childNodes.reverse().findIndex(isVisible);lastVisibleIndex=lastVisibleIndex===-1?0:childNodes.length-lastVisibleIndex;if(offset>=lastVisibleIndex){return"end";}
return false;}
async function fetchExternalMetaData(url){try{return await rpc("/html_editor/link_preview_external",{preview_url:url,});}catch{return;}}
async function fetchInternalMetaData(url){const keepLastPromise=new KeepLast();const urlParsed=new URL(url);if(urlParsed.protocol!==window.location.protocol){urlParsed.protocol=window.location.protocol;}
const result=await keepLastPromise.add(fetch(urlParsed)).then((response)=>response.text()).then(async(content)=>{const html_parser=new window.DOMParser();const doc=html_parser.parseFromString(content,"text/html");const internalUrlMetaData=await rpc("/html_editor/link_preview_internal",{preview_url:urlParsed.href,});internalUrlMetaData["favicon"]=doc.querySelector("link[rel~='icon']");internalUrlMetaData["ogTitle"]=doc.querySelector("[property='og:title']");internalUrlMetaData["title"]=doc.querySelector("title");return internalUrlMetaData;}).catch((error)=>{if(error instanceof Error){return Promise.reject(error);}});return result;}
async function fetchAttachmentMetaData(url,ormService){try{const urlParsed=new URL(url,window.location.origin);const attachementId=parseInt(urlParsed.pathname.split("/").pop());return(await ormService.read("ir.attachment",[attachementId],["name","mimetype","type"]))[0];}catch{return{name:url};}}
const LinkPlugin=__exports.LinkPlugin=class LinkPlugin extends Plugin{static id="link";static dependencies=["dom","history","input","selection","split","lineBreak","overlay","color","baseContainer","feff",];static defaultConfig={allowStripDomain:true,};static shared=["createLink","insertLink","getPathAsUrlCommand"];resources={user_commands:[{id:"openLinkTools",title:_t("Link"),description:_t("Add a link"),icon:"fa-link",run:({link,type}={})=>this.openLinkTools(link,type),isAvailable:(selection)=>{const linkEl=findInSelection(selection,"a");return linkEl?this.getResource("link_popovers").some((p)=>p.isAvailable(linkEl)):isHtmlContentSupported(selection);},},{id:"removeLinkFromSelection",title:_t("Remove Link"),description:_t("Remove Link"),icon:"fa-unlink",isAvailable:(selection)=>{if(!isHtmlContentSupported(selection)){return false;}
for(const node of this.dependencies.selection.getTargetedNodes()){const linkEl=closestElement(node,"a");if(linkEl&&!this.isLinkImmutable(linkEl)&&linkEl.parentElement.isContentEditable){return true;}}},run:this.removeLinkFromSelection.bind(this),},],toolbar_groups:[withSequence(40,{id:"link",namespaces:["compact","expanded"]}),withSequence(30,{id:"image_link",namespaces:["image"]}),],toolbar_items:[{id:"link",groupId:"link",commandId:"openLinkTools",isActive:isLinkActive,isDisabled:()=>!this.isLinkAllowedOnSelection(),},{id:"unlink",groupId:"link",commandId:"removeLinkFromSelection",isDisabled:()=>this.removeLinkFromSelectionIsDisabled(),},{id:"link",groupId:"image_link",commandId:"openLinkTools",isActive:isLinkActive,isDisabled:()=>!this.isLinkAllowedOnSelection(),},{id:"unlink",groupId:"image_link",commandId:"removeLinkFromSelection",isDisabled:()=>this.removeLinkFromSelectionIsDisabled(),},],powerbox_categories:withSequence(50,{id:"navigation",name:_t("Navigation")}),powerbox_items:[{categoryId:"navigation",commandId:"openLinkTools",},{title:_t("Button"),description:_t("Add a button"),categoryId:"navigation",commandId:"openLinkTools",commandParams:{type:"primary"},},],power_buttons:withSequence(10,{commandId:"openLinkTools",commandParams:{type:"primary"},description:_t("Add a button"),icon:"fa-square",}),link_popovers:[withSequence(50,{PopoverClass:LinkPopover,isAvailable:(linkEl)=>!linkEl||!this.isLinkImmutable(linkEl),getProps:(props)=>props,}),],immutable_link_selectors:['[data-bs-toggle="tab"]','[data-bs-toggle="collapse"]','[data-bs-toggle="dropdown"]',".dropdown-item","[data-oe-model]",":has(>[data-oe-model])",".o_prevent_link_editor a",],legit_empty_link_predicates:(linkEl)=>linkEl.hasAttribute("data-mimetype"),beforeinput_handlers:withSequence(5,this.onBeforeInput.bind(this)),input_handlers:this.onInputDeleteNormalizeLink.bind(this),before_delete_handlers:this.updateCurrentLinkSyncState.bind(this),delete_handlers:this.onInputDeleteNormalizeLink.bind(this),before_paste_handlers:this.updateCurrentLinkSyncState.bind(this),after_paste_handlers:this.onPasteNormalizeLink.bind(this),selectionchange_handlers:this.handleSelectionChange.bind(this),clean_for_save_handlers:({root})=>this.removeEmptyLinks(root),normalize_handlers:this.normalizeLink.bind(this),after_insert_handlers:this.handleAfterInsert.bind(this),on_will_remove_handlers:()=>this.closeLinkTools(),split_element_block_overrides:this.handleSplitBlock.bind(this),insert_line_break_element_overrides:this.handleInsertLineBreak.bind(this),delete_image_overrides:this.deleteImageLink.bind(this),double_click_overrides:this.doubleClickLinkOverrides.bind(this),triple_click_overrides:this.tripleClickButtonOverrides.bind(this),to_inline_code_processors:(node)=>{this.removeEmptyLinks(node);for(const btn of selectElements(node,"a.btn")){[...btn.attributes].forEach((attr)=>attr.name!=="href"&&btn.removeAttribute(attr.name));}},};setup(){this.initializePopovers();this.currentOverlay=this.getActivePopover().overlay;this.addDomListener(this.editable,"click",(ev)=>{const linkEl=ev.target.closest("a");if(linkEl){if(ev.ctrlKey||ev.metaKey){window.open(linkEl.href,"_blank");}
ev.preventDefault();}});this.addDomListener(this.editable,"mousedown",()=>{this._isNavigatingByMouse=true;});this.addDomListener(this.editable,"keydown",()=>{delete this._isNavigatingByMouse;});this.addDomListener(this.editable,"auxclick",(ev)=>{if(ev.button===1){const link=closestElement(ev.target,"a");if(link?.href){window.open(link.href,"_blank");ev.preventDefault();}}});this.unregisterLinkCommandCallback=this.services.command?.add("Create link",()=>{this.dependencies.selection.focusEditable();setTimeout(()=>this.openLinkTools());},{hotkey:"control+k",category:"shortcut_conflict",isAvailable:()=>{const selectionData=this.dependencies.selection.getSelectionData();return(selectionData.documentSelectionIsInEditable&&isHtmlContentSupported(selectionData.editableSelection));},});this.getExternalMetaData=memoize(fetchExternalMetaData);this.getInternalMetaData=memoize(fetchInternalMetaData);this.getAttachmentMetadata=memoize((url)=>fetchAttachmentMetaData(url,this.services.orm));this.LinkPopoverState={editing:false};this.newlyInsertedLinks=new Set();}
destroy(){this.unregisterLinkCommandCallback?.();}
createLink(url,label=""){const link=this.document.createElement("a");if(url!==undefined){link.setAttribute("href",url);}
for(const[param,value]of Object.entries(this.config.defaultLinkAttributes||{})){link.setAttribute(param,`${value}`);}
link.innerText=label;this.dispatchTo("create_link_handlers",link);return link;}
insertLink(url,label){const selection=this.dependencies.selection.getEditableSelection();let link=closestElement(selection.anchorNode,"a");if(link){link.setAttribute("href",url);link.innerText=label;}else{link=this.createLink(url,label);this.dependencies.dom.insert(link);}
this.dependencies.history.addStep();const linkParent=link.parentElement;const linkOffset=Array.from(linkParent.childNodes).indexOf(link);this.dependencies.selection.setSelection({anchorNode:linkParent,anchorOffset:linkOffset+1},{normalize:false});}
getPathAsUrlCommand(text,url){const pasteAsURLCommand={title:_t("Paste as URL"),description:_t("Create an URL."),icon:"fa-link",run:()=>{this.dependencies.dom.insert(this.createLink(url,text));this.dependencies.history.addStep();},};return pasteAsURLCommand;}
isLinkAllowedOnSelection(){if(this.getResource("link_compatible_selection_predicates").some((p)=>p())){return true;}
const targetedNodes=this.dependencies.selection.getTargetedNodes();const targetedBlocks=targetedNodes.filter(isBlock);const linksInSelection=targetedNodes.filter((n)=>n.tagName==="A");return(linksInSelection.length<2&&targetedBlocks.every((node)=>targetedNodes.every((other)=>node.contains(other)||other.contains(node))));}
openLinkTools(linkElement,type){this.currentOverlay.close();this.LinkPopoverState.editing=false;if(!this.isLinkAllowedOnSelection()){return this.services.notification.add(_t("Unable to create a link on the current selection."),{type:"danger"});}
let selection=this.dependencies.selection.getEditableSelection();let cursorsToRestore=this.dependencies.selection.preserveSelection();const commonAncestor=closestElement(selection.commonAncestorContainer);linkElement=linkElement||findInSelection(selection,"a");this.type=type;if(linkElement&&(!linkElement.contains(selection.anchorNode)||!linkElement.contains(selection.focusNode))){this.extendLinkToSelection(linkElement,selection);linkElement=findInSelection(selection,"a");this.dependencies.history.addStep();cursorsToRestore=this.dependencies.selection.preserveSelection();}
this.linkInDocument=linkElement;if(!linkElement){linkElement=this.createLink(undefined,selection.textContent());}
const selectionTextContent=selection?.textContent();const isImage=!!findInSelection(selection,"img");const applyCallback=(url,label,classes,customStyle,linkTarget,attachmentId,relValue)=>{if(this.linkInDocument){if(url){this.linkInDocument.href=url;}else{this.linkInDocument.removeAttribute("href");}
if(relValue){this.linkInDocument.setAttribute("rel",relValue);}else{this.linkInDocument.removeAttribute("rel");}
if(linkTarget){this.linkInDocument.setAttribute("target",linkTarget);}else{this.linkInDocument.removeAttribute("target");}
if(!isImage){if(classes){this.linkInDocument.className=classes;}else{this.linkInDocument.removeAttribute("class");}
if(customStyle){this.linkInDocument.setAttribute("style",customStyle);}else{this.linkInDocument.removeAttribute("style");}
if(this.linkInDocument.childElementCount==0&&cleanZWChars(this.linkInDocument.innerText)!==label){this.linkInDocument.innerText=label;cursorsToRestore=null;}}}else if(url){if((selectionTextContent&&selectionTextContent===label)||isImage){const link=this.createLink(url);if(relValue){link.setAttribute("rel",relValue);}
const image=isImage&&findInSelection(selection,"img");const figure=image?.parentElement?.matches("figure[contenteditable=false]")&&image.parentElement;if(figure){figure.before(link);link.append(figure);if(link.parentElement===this.editable){const baseContainer=this.dependencies.baseContainer.createBaseContainer();link.before(baseContainer);baseContainer.append(link);}}else{const content=this.dependencies.selection.extractContent(selection);link.append(content);link.normalize();cursorsToRestore=null;selection=this.dependencies.selection.getEditableSelection();const anchorClosestElement=closestElement(selection.anchorNode);if(commonAncestor!==anchorClosestElement){const[anchorNode,anchorOffset]=rightPos(anchorClosestElement);this.dependencies.selection.setSelection({anchorNode,anchorOffset},{normalize:false});}
this.dependencies.dom.insert(link);}
this.linkInDocument=link;}else if(label){const link=this.createLink(url,label);if(classes){link.className=classes;}
if(customStyle){link.setAttribute("style",customStyle);}
if(linkTarget){link.setAttribute("target",linkTarget);}
this.linkInDocument=link;cursorsToRestore=null;this.dependencies.dom.insert(link);}}
if(attachmentId){this.linkInDocument.dataset.attachmentId=attachmentId;}};this.restoreSavePoint=this.dependencies.history.makeSavePoint();const props={document:this.document,linkElement,isImage:isImage,onApply:(...args)=>{delete this._isNavigatingByMouse;applyCallback(...args);this.closeLinkTools(cursorsToRestore);this.dependencies.selection.focusEditable();this.dependencies.history.addStep();},onChange:applyCallback,onDiscard:()=>{this.restoreSavePoint();if(linkElement.isConnected){this.openLinkTools(linkElement);}else{this.linkInDocument=null;this.currentOverlay.close();}
this.dependencies.selection.focusEditable();},onRemove:()=>{this.removeLinkInDocument();this.linkInDocument=null;this.currentOverlay.close();},onCopy:()=>{this.linkInDocument=null;this.currentOverlay.close();},onEdit:()=>{this.restoreSavePoint=this.dependencies.history.makeSavePoint();},getInternalMetaData:this.getInternalMetaData,getExternalMetaData:this.getExternalMetaData,getAttachmentMetadata:this.getAttachmentMetadata,recordInfo:this.config.getRecordInfo?.()||{},canEdit:!this.linkInDocument||!this.linkInDocument.classList.contains("o_link_readonly"),canRemove:this.linkInDocument&&this.linkInDocument.parentElement.isContentEditable&&!this.isUnremovable(this.linkInDocument),canUpload:this.config.allowFile,onUpload:this.config.onAttachmentChange,type:this.type||"",LinkPopoverState:this.LinkPopoverState,showReplaceTitleBanner:this.newlyInsertedLinks.has(linkElement),allowCustomStyle:this.config.allowCustomStyle,allowTargetBlank:this.config.allowTargetBlank,allowStripDomain:this.config.allowStripDomain,};const popover=this.getActivePopover(linkElement);if(popover){this.currentOverlay=popover.overlay;if(!linkElement.href){this.LinkPopoverState.editing=true;}
this.currentOverlay.open({props:popover.getProps(props)});if(this.linkInDocument){if(this.newlyInsertedLinks.has(this.linkInDocument)){this.newlyInsertedLinks.delete(this.linkInDocument);}}}}
closeLinkTools(cursors=null){const link=this.linkInDocument;this.linkInDocument=null;if(this.currentOverlay.isOpen&&document.querySelector(".o-we-linkpopover")){this.currentOverlay.close();if(link&&link.isConnected){this.dependencies.selection.setSelection({anchorNode:link,anchorOffset:0,focusNode:link,focusOffset:nodeSize(link),});const saveCustomStyle=link.getAttribute("style");link.removeAttribute("style");this.dependencies.color.removeAllColor();if(saveCustomStyle&&this.config.allowCustomStyle&&link.className.includes("custom")){link.setAttribute("style",saveCustomStyle);}
if(cleanZWChars(link.textContent)===""&&!link.querySelector("img")){const[anchorNode,anchorOffset]=rightPos(link);this.dependencies.selection.setSelection({anchorNode,anchorOffset},{normalize:false});link.remove();}else if(cursors){cursors.restore();}else{this.dependencies.selection.setCursorEnd(link);}}}}
normalizeLink(root){for(const anchorEl of selectElements(root,"a")){if(/btn(-[a-z0-9_-]*)custom/.test(anchorEl.className)){continue;}
const{color}=anchorEl.style;const childNodes=[...anchorEl.childNodes];if(color&&childNodes.every((n)=>!isBlock(n))){anchorEl.style.removeProperty("color");const font=selectElements(anchorEl,"font").next().value;if(font&&cleanZWChars(anchorEl.textContent)===font.textContent){continue;}
const newFont=this.document.createElement("font");newFont.append(...childNodes);anchorEl.appendChild(newFont);this.dependencies.color.colorElement(newFont,color,"color");}
const hasUnsupportedMedia=anchorEl.querySelector("a, iframe");if(hasUnsupportedMedia){this.removeLinkInDocument(anchorEl);}}}
handleSelectionChange(selectionData){const selection=selectionData.editableSelection;if(this._isNavigatingByMouse&&selection.isCollapsed&&selectionData.documentSelectionIsInEditable){delete this._isNavigatingByMouse;const{startContainer,startOffset,endContainer,endOffset}=selection;const linkElement=closestElement(startContainer,"a");if(linkElement&&linkElement.textContent.startsWith("\uFEFF")&&linkElement.textContent.endsWith("\uFEFF")){const linkDescendants=descendants(linkElement);const isCursorAtStartOfLink=isZwnbsp(startContainer)?linkDescendants.indexOf(startContainer)===0:startContainer.nodeType===Node.TEXT_NODE&&linkDescendants.indexOf(startContainer)===1&&startOffset===0;const isCursorAtEndOfLink=isZwnbsp(endContainer)?linkDescendants.indexOf(endContainer)===linkDescendants.length-1:endContainer.nodeType===Node.TEXT_NODE&&linkDescendants.indexOf(endContainer)===linkDescendants.length-2&&endOffset===nodeSize(endContainer);if(isCursorAtStartOfLink||isCursorAtEndOfLink){const[targetNode,targetOffset]=isCursorAtStartOfLink?leftPos(linkElement):rightPos(linkElement);this.dependencies.selection.setSelection({anchorNode:targetNode,anchorOffset:isCursorAtStartOfLink?targetOffset-1:targetOffset+1,});return;}}}
if(!selectionData.currentSelectionIsInEditable){const popoverEl=document.querySelector(".o-we-linkpopover");const anchorNode=document.getSelection()?.anchorNode;if((popoverEl&&!selectionData.documentSelection)||(anchorNode&&isElement(anchorNode)&&anchorNode.closest(".o-we-linkpopover"))){return;}
this.linkInDocument=null;this.closeLinkTools();}else if(!selection.isCollapsed){const imageNode=findInSelection(selection,"img");const parentElement=imageNode?.parentElement;const linkContainingImage=imageNode&&closestElement(imageNode,"a");if(linkContainingImage&&this.isLinkAllowedOnSelection()&&parentElement.contains(selection.anchorNode)&&parentElement.contains(selection.focusNode)){this.openLinkTools(linkContainingImage);}else{this.linkInDocument=null;this.closeLinkTools();}}else{const closestLinkElement=closestElement(selection.anchorNode,"A");const isLinkEditable=this.getResource("is_link_editable_predicates").some((p)=>p(closestLinkElement));if(closestLinkElement&&closestLinkElement.isContentEditable){if(closestLinkElement!==this.linkInDocument||!this.currentOverlay.isOpen){this.openLinkTools(closestLinkElement);}}else if(isLinkEditable){this.openLinkTools(closestLinkElement);}else{this.linkInDocument=null;this.closeLinkTools();}}}
extendLinkToSelection(linkElement){this.dependencies.split.splitSelection();const selectedNodes=this.dependencies.selection.getTargetedNodes();let before=linkElement.previousSibling;while(before!==null&&selectedNodes.includes(before)){linkElement.insertBefore(before,linkElement.firstChild);before=linkElement.previousSibling;}
let after=linkElement.nextSibling;while(after&&selectedNodes.includes(after)){linkElement.appendChild(after);after=linkElement.nextSibling;}
this.dependencies.selection.setCursorEnd(linkElement);}
isUnremovable(linkEl){return this.getResource("unremovable_node_predicates").some((p)=>p(linkEl));}
removeLinkInDocument(link=this.linkInDocument){if(!link.parentElement.isContentEditable||this.isUnremovable(link)){return;}
const cursors=this.dependencies.selection.preserveSelection();if(link&&link.isContentEditable&&link.parentElement.isContentEditable){cursors.update(callbacksForCursorUpdate.unwrap(link));unwrapContents(link);}
cursors.restore();this.linkInDocument=null;this.dependencies.selection.focusEditable();this.dependencies.history.addStep();}
removeLinkFromSelectionIsDisabled(selection){for(const node of this.dependencies.selection.getTargetedNodes()){const linkEl=closestElement(node,"a");if(linkEl&&!this.isLinkImmutable(linkEl)&&!this.isUnremovable(linkEl)){return false;}}
return true;}
removeLinkFromSelection(){const selection=this.dependencies.split.splitSelection();let{anchorNode,focusNode,anchorOffset,focusOffset}=selection;const direction=selection.direction;let[startLink,endLink]=[closestElement(anchorNode,"a"),closestElement(focusNode,"a"),];let cursors;if(startLink){cursors=this.dependencies.selection.preserveSelection();this.dependencies.feff.removeFeffs(startLink,cursors);cursors.restore();}
if(endLink&&startLink!==endLink){cursors=this.dependencies.selection.preserveSelection();this.dependencies.feff.removeFeffs(endLink,cursors);cursors.restore();}
({anchorNode,focusNode,anchorOffset,focusOffset}=this.dependencies.selection.getEditableSelection());cursors=this.dependencies.selection.preserveSelection();let targetedNodes=this.dependencies.selection.getTargetedNodes();const selectedImageNodes=targetedNodes.filter((node)=>node.tagName==="IMG");if(selectedImageNodes.length&&startLink&&endLink&&startLink===endLink){for(const imageNode of selectedImageNodes){let imageLink;const figure=closestElement(imageNode,"figure");if(direction===DIRECTIONS.RIGHT){imageLink=this.dependencies.split.splitAroundUntil(figure||imageNode,endLink);}else{imageLink=this.dependencies.split.splitAroundUntil(figure||imageNode,startLink);}
cursors.update(callbacksForCursorUpdate.unwrap(imageLink));unwrapContents(imageLink);if(figure&&figure.parentElement!==this.editable){unwrapContents(figure.parentElement);}
[startLink,endLink]=[closestElement(anchorNode,"a"),closestElement(focusNode,"a"),];}
cursors.restore();if(selectedImageNodes.length===1&&selectedImageNodes.length===targetedNodes.length){this.dependencies.history.addStep();return;}}
const startBlock=closestBlock(startLink);const endBlock=closestBlock(endLink);if(startLink&&startLink.isConnected&&startLink.parentElement.isContentEditable&&!this.isUnremovable(startLink)){anchorNode=this.dependencies.split.splitAroundUntil(anchorNode,startLink);anchorOffset=direction===DIRECTIONS.RIGHT?0:nodeSize(anchorNode);this.dependencies.selection.setSelection({anchorNode,anchorOffset,focusNode,focusOffset},{normalize:true});}
if(endLink&&endLink.isConnected&&endLink.parentElement.isContentEditable&&!this.isUnremovable(endLink)){focusNode=this.dependencies.split.splitAroundUntil(focusNode,endLink);focusOffset=direction===DIRECTIONS.RIGHT?nodeSize(focusNode):0;this.dependencies.selection.setSelection({anchorNode,anchorOffset,focusNode,focusOffset},{normalize:true});}
targetedNodes=this.dependencies.selection.getTargetedNodes();const links=new Set(targetedNodes.map((node)=>closestElement(node,"a")).filter((a)=>a&&a.isContentEditable&&a.parentElement.isContentEditable&&!this.isUnremovable(a)));if(links.size){for(const link of links){cursors.update(callbacksForCursorUpdate.unwrap(link));unwrapContents(link);}
cursors.restore();}
if(startBlock){this.removeEmptyLinks(startBlock);}
if(endBlock&&endBlock!==startBlock){this.removeEmptyLinks(endBlock);}
this.dependencies.history.addStep();}
removeEmptyLinks(root){const remove=(node)=>{for(const child of node.childNodes){remove(child);}
if(!this.isUnremovable(node)){node.before(...node.childNodes);node.remove();}};for(const link of root.querySelectorAll("a")){if([...link.childNodes].some(isVisible)||!link.parentElement.isContentEditable||this.isUnremovable(link)||this.getResource("legit_empty_link_predicates").some((p)=>p(link))){continue;}
remove(link);}}
updateCurrentLinkSyncState(){const{anchorNode}=this.dependencies.selection.getEditableSelection();const linkEl=closestElement(anchorNode,"a");if(linkEl&&linkEl.isContentEditable){const label=linkEl.innerText;const url=deduceURLfromText(label,linkEl);const href=linkEl.getAttribute("href");if(url&&(url===href||url+"/"===href||url===deduceURLfromText(href,linkEl))){this.isCurrentLinkInSync=true;}}}
onBeforeInput(ev){if(ev.inputType==="insertParagraph"||ev.inputType==="insertLineBreak"){const nodeForSelectionRestore=this.handleAutomaticLinkInsertion();if(nodeForSelectionRestore){this.dependencies.selection.setCursorStart(nodeForSelectionRestore);this.dependencies.history.addStep();}}
if(ev.inputType==="insertText"&&ev.data===" "){const nodeForSelectionRestore=this.handleAutomaticLinkInsertion();if(nodeForSelectionRestore){this.dependencies.selection.setSelection({anchorNode:nodeForSelectionRestore,anchorOffset:0,});this.dependencies.history.addStep();nodeForSelectionRestore.textContent="\u00A0"+nodeForSelectionRestore.textContent;this.dependencies.selection.setSelection({anchorNode:nodeForSelectionRestore,anchorOffset:1,});this.dependencies.history.addStep();ev.preventDefault();}}
this.updateCurrentLinkSyncState();}
onInputDeleteNormalizeLink(){const{anchorNode}=this.dependencies.selection.getEditableSelection();const linkEl=closestElement(anchorNode,"a");if(linkEl&&linkEl.isContentEditable){const label=linkEl.innerText;const url=deduceURLfromText(label,linkEl);if(url&&this.isCurrentLinkInSync){linkEl.setAttribute("href",url);this.isCurrentLinkInSync=false;if(this.currentOverlay.isOpen){this.currentOverlay.close();}}}}
onPasteNormalizeLink(){this.updateCurrentLinkSyncState();this.onInputDeleteNormalizeLink();}
deleteImageLink(imageToDelete){if(imageToDelete.parentElement.tagName==="A"&&!this.isUnremovable(imageToDelete.parentElement)&&imageToDelete.parentElement.parentElement.isContentEditable){const cursors=this.dependencies.selection.preserveSelection();cursors.update(callbacksForCursorUpdate.remove(imageToDelete));imageToDelete.remove();this.closeLinkTools(cursors);this.dependencies.history.addStep();return true;}
return false;}
handleAutomaticLinkInsertion(){let selection=this.dependencies.selection.getEditableSelection();if(isHtmlContentSupported(selection)&&!closestElement(selection.anchorNode,"a")&&selection.anchorNode.nodeType===Node.TEXT_NODE){selection.anchorNode.parentNode.normalize();selection=this.dependencies.selection.getEditableSelection();const textSliced=selection.anchorNode.textContent.slice(0,selection.anchorOffset);const textNodeSplitted=textSliced.split(/\s/);const potentialUrl=textNodeSplitted.pop();const match=[...potentialUrl.matchAll(new RegExp(URL_REGEX,"g"))].pop();if(match&&!EMAIL_REGEX.test(match[0])){const nodeForSelectionRestore=selection.anchorNode.splitText(selection.anchorOffset);const url=match[2]?match[0]:"https://"+match[0];const startOffset=selection.anchorOffset-potentialUrl.length+match.index;const text=selection.anchorNode.textContent.slice(startOffset,startOffset+match[0].length);const link=this.createLink(url,text);const textNodeToReplace=selection.anchorNode.splitText(startOffset);textNodeToReplace.splitText(match[0].length);selection.anchorNode.parentElement.replaceChild(link,textNodeToReplace);if(link.getAttribute("href")===link.textContent){this.newlyInsertedLinks.add(link);}
return nodeForSelectionRestore;}}}
handleSplitBlock(params){return this.handleEnterAtEdgeOfLink(params,this.dependencies.split.splitElementBlock);}
handleInsertLineBreak(params){return this.handleEnterAtEdgeOfLink(params,this.dependencies.lineBreak.insertLineBreakElement);}
handleEnterAtEdgeOfLink(params,splitOrLineBreakCallback){let{targetNode,targetOffset,blockToSplit}=params;if(targetNode.tagName!=="A"){return;}
const edge=isPositionAtEdgeofLink(targetNode,targetOffset);if(!edge){return;}
[targetNode,targetOffset]=edge==="start"?leftPos(targetNode):rightPos(targetNode);blockToSplit=targetNode;splitOrLineBreakCallback({...params,targetNode,targetOffset,blockToSplit});return true;}
handleAfterInsert(insertedNodes){for(const node of insertedNodes){if(node.nodeType===Node.ELEMENT_NODE){for(const link of selectElements(node,"A")){if(link.getAttribute("href")===link.textContent&&!this.isImage){this.newlyInsertedLinks.add(link);}}}}}
initializePopovers(){this.overlays=[];this.getResource("link_popovers").map((link_popover)=>{this.overlays.push({overlay:this.dependencies.overlay.createOverlay(link_popover.PopoverClass,{closeOnPointerdown:true,},{sequence:50,}),isAvailable:link_popover.isAvailable,getProps:link_popover.getProps,});});}
getActivePopover(linkElement){return this.overlays.find((overlay)=>overlay.isAvailable(linkElement));}
isLinkImmutable(linkEl){return this.getResource("immutable_link_selectors").some((s)=>linkEl.matches(s));}
doubleClickLinkOverrides(ev){const clickedLink=closestElement(ev.target,"a");if(clickedLink){this.dependencies.selection.modifySelection("extend","backward","word");this.document.getSelection().collapseToStart();this.dependencies.selection.modifySelection("extend","forward","word");const{anchorNode,focusNode,anchorOffset,focusOffset}=this.dependencies.selection.getEditableSelection();if(clickedLink.contains(anchorNode)&&!clickedLink.contains(focusNode)){this.dependencies.selection.setSelection({anchorNode,anchorOffset,focusNode:clickedLink,focusOffset:nodeSize(clickedLink)-1,});}else if(!clickedLink.contains(anchorNode)&&clickedLink.contains(focusNode)){this.dependencies.selection.setSelection({anchorNode:clickedLink,anchorOffset:1,focusNode,focusOffset,});}else if(!clickedLink.contains(anchorNode)&&!clickedLink.contains(focusNode)){this.dependencies.selection.setSelection({anchorNode:clickedLink,anchorOffset:1,focusNode:clickedLink,focusOffset:nodeSize(clickedLink)-1,});}else{this.dependencies.selection.setSelection({anchorNode,anchorOffset,focusNode,focusOffset,});}
return true;}}
tripleClickButtonOverrides(ev){const selection=this.dependencies.selection.getEditableSelection();const buttonElement=isBrowserFirefox()?findInSelection(selection,"a.btn"):closestElement(selection.anchorNode,"a.btn");if(buttonElement){this.dependencies.selection.setSelection({anchorNode:buttonElement,anchorOffset:0,focusNode:buttonElement,focusOffset:nodeSize(buttonElement),});ev.preventDefault();return true;}}}
return __exports;});;

/* /html_editor/static/src/main/link/link_popover.js */
odoo.define('@html_editor/main/link/link_popover',['@web/session','@web/core/l10n/translation','@odoo/owl','@web/core/utils/hooks','@web/core/browser/browser','@html_editor/main/link/utils','@web/core/color_picker/color_picker','@web/core/checkbox/checkbox'],function(require){'use strict';let __exports={};const{session}=require("@web/session");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{Component,useState,useRef,useEffect,useExternalListener}=require("@odoo/owl");const{useService}=require("@web/core/utils/hooks");const{browser}=require("@web/core/browser/browser");const{cleanZWChars,deduceURLfromText}=require("@html_editor/main/link/utils");const{useColorPicker}=require("@web/core/color_picker/color_picker");const{CheckBox}=require("@web/core/checkbox/checkbox");const DEFAULT_CUSTOM_TEXT_COLOR="#714B67";const DEFAULT_CUSTOM_FILL_COLOR="#ffffff";const isCSSVariable=(color)=>color.match(/^o-color-\d$|^\d{3}$/);const formatColor=(color)=>{if(color.match(/^o-color-\d$/gm)){return`var(--hb-cp-${color})`;}
if(color.match(/^\d{3}$/gm)){return`var(--${color})`;}
return color;};const LinkPopover=__exports.LinkPopover=class LinkPopover extends Component{static template="html_editor.linkPopover";static props={document:{validate:(p)=>p.nodeType===Node.DOCUMENT_NODE},linkElement:{validate:(el)=>el.nodeType===Node.ELEMENT_NODE},onApply:Function,onChange:Function,onDiscard:Function,onRemove:Function,onCopy:Function,onEdit:Function,getInternalMetaData:Function,getExternalMetaData:Function,getAttachmentMetadata:Function,isImage:Boolean,showReplaceTitleBanner:Boolean,type:String,LinkPopoverState:Object,recordInfo:Object,canEdit:{type:Boolean,optional:true},canRemove:{type:Boolean,optional:true},canUpload:{type:Boolean,optional:true},onUpload:{type:Function,optional:true},allowCustomStyle:{type:Boolean,optional:true},allowTargetBlank:{type:Boolean,optional:true},allowStripDomain:{type:Boolean,optional:true},formatColor:{type:Function,optional:true},};static defaultProps={canEdit:true,canRemove:true,formatColor:formatColor,};static components={CheckBox};colorsData=[{type:"",label:_t("Link"),btnPreview:"link"},{type:"primary",label:_t("Button Primary"),btnPreview:"primary"},{type:"secondary",label:_t("Button Secondary"),btnPreview:"secondary"},{type:"custom",label:_t("Custom"),btnPreview:"custom"},];buttonSizesData=[{size:"sm",label:_t("Small")},{size:"",label:_t("Medium")},{size:"lg",label:_t("Large")},];borderData=[{style:"solid",label:""},{style:"dashed",label:""},{style:"dotted",label:""},{style:"double",label:""},];buttonShapeData=[{shape:"",label:"Default"},{shape:"rounded-circle",label:"Default + Rounded"},{shape:"outline",label:"Outline"},{shape:"outline rounded-circle",label:"Outline + Rounded"},{shape:"fill",label:"Fill"},{shape:"fill rounded-circle",label:"Fill + Rounded"},{shape:"flat",label:"Flat"},];setup(){this.ui=useService("ui");this.notificationService=useService("notification");this.uploadService=useService("uploadLocalFiles");const linkElement=this.props.linkElement;const textContent=cleanZWChars(linkElement.textContent);const labelEqualsUrl=textContent===linkElement.getAttribute("href")||textContent+"/"===linkElement.getAttribute("href");const computedStyle=this.props.document.defaultView.getComputedStyle(linkElement);const currentRelValues=linkElement.rel.split(" ");this.state=useState({editing:this.props.LinkPopoverState.editing,url:linkElement.getAttribute("href")||this.deduceUrl(textContent),label:labelEqualsUrl?"":textContent,previewIcon:{type:"fa",value:"fa-globe",},urlTitle:"",urlDescription:"",linkPreviewName:"",imgSrc:"",type:this.props.type||linkElement.className.match(/btn(-[a-z0-9_-]*)(primary|secondary|custom)/)?.pop()||"",linkTarget:linkElement.target==="_blank"?"_blank":"",directDownload:true,isDocument:false,buttonSize:linkElement.className.match(/btn-(sm|lg)/)?.[1]||"",buttonShape:this.getButtonShape(),customBorderSize:computedStyle.borderWidth.replace("px","")||"0",customBorderStyle:computedStyle.borderStyle||"solid",isImage:this.props.isImage,showReplaceTitleBanner:this.props.showReplaceTitleBanner,showLabel:!linkElement.childElementCount,stripDomain:true,showAdvancedOptions:false,relAttributeOptions:{nofollow:{label:"nofollow",description:_t("Tells search engines not to follow this link"),isChecked:currentRelValues.includes("nofollow"),},noreferrer:{label:"noreferrer",description:_t("Removes referrer information sent to the target site"),isChecked:currentRelValues.includes("noreferrer"),},sponsored:{label:"sponsored",description:_t("Indicates the link is sponsored or paid content"),isChecked:currentRelValues.includes("sponsored"),},noopener:{label:"noopener",description:_t("Prevents the new page from accessing the original window (security)"),isChecked:currentRelValues.includes("noopener"),},},});const getTargetedElements=()=>[this.props.linkElement];this.customTextColorState=useState({selectedColor:computedStyle.color||DEFAULT_CUSTOM_TEXT_COLOR,defaultTab:"solid",getTargetedElements,mode:"color",});this.customTextResetPreviewColor=this.customTextColorState.selectedColor;this.customFillColorState=useState({selectedColor:(computedStyle.backgroundImage==="none"?undefined:computedStyle.backgroundImage)||computedStyle.backgroundColor||DEFAULT_CUSTOM_FILL_COLOR,defaultTab:"solid",getTargetedElements,mode:"background-color",});this.customFillResetPreviewColor=this.customFillColorState.selectedColor;this.customBorderColorState=useState({selectedColor:computedStyle.borderColor||DEFAULT_CUSTOM_TEXT_COLOR,defaultTab:"solid",getTargetedElements,mode:"border-color",});this.customBorderResetPreviewColor=this.customBorderColorState.selectedColor;if(this.props.allowCustomStyle){const createCustomColorPicker=(refName,colorStateRef,resetValueRef)=>useColorPicker(refName,{state:this[colorStateRef],enabledTabs:colorStateRef==="customFillColorState"?["solid","custom","gradient"]:["solid","custom"],getUsedCustomColors:()=>[],colorPrefix:"",cssVarColorPrefix:"hb-cp-",applyColor:(colorValue)=>{this[colorStateRef].selectedColor=colorValue;this[resetValueRef]=colorValue;},applyColorPreview:(colorValue)=>{this[colorStateRef].selectedColor=colorValue;this.onChange();},applyColorResetPreview:()=>{this[colorStateRef].selectedColor=this[resetValueRef];this.onChange();},},{env:this.__owl__.childEnv,});this.customTextColorPicker=createCustomColorPicker("customTextColorButton","customTextColorState","customTextResetPreviewColor");this.customFillColorPicker=createCustomColorPicker("customFillColorButton","customFillColorState","customFillResetPreviewColor");this.customBorderColorPicker=createCustomColorPicker("customBorderColorButton","customBorderColorState","customBorderResetPreviewColor");}
this.updateDocumentState();this.editingWrapper=useRef("editing-wrapper");this.inputRef=useRef(this.state.isImage||(this.state.label&&!this.state.url)?"url":"label");useEffect((el)=>{if(el){el.focus();}},()=>[this.inputRef.el]);if(!this.state.editing){this.loadAsyncLinkPreview();}
const onPointerDown=(ev)=>{if(this.state.isImage){return;}
this.state.url||="#";if(this.editingWrapper?.el&&!this.editingWrapper.el.contains(ev.target)){this.onClickApply();}};useExternalListener(this.props.document,"pointerdown",onPointerDown);if(this.props.document!==document){useExternalListener(document,"pointerdown",onPointerDown);}}
toggleAdvancedOptions(){this.state.showAdvancedOptions=!this.state.showAdvancedOptions;}
toggleRelAttr(attr){const option=this.state.relAttributeOptions[attr];option.isChecked=!option.isChecked;}
onChange(){this.props.onChange(this.state.url,this.state.label,this.classes,this.customStyles,this.state.linkTarget,this.state.attachmentId);this.updateDocumentState();}
onClickApply(){const relOptions=this.state.relAttributeOptions;const relValue=Object.keys(relOptions).filter((key)=>relOptions[key].isChecked).join(" ");this.state.editing=false;this.applyDeducedUrl();this.props.onApply(this.state.url,this.state.label,this.classes,this.customStyles,this.state.linkTarget,this.state.attachmentId,relValue);}
applyDeducedUrl(){if(this.state.label===""){this.state.label=this.state.url;}
const deducedUrl=this.deduceUrl(this.state.url);this.state.url=deducedUrl?this.correctLink(deducedUrl):this.correctLink(this.state.url);if(this.props.allowStripDomain&&this.state.stripDomain&&this.isAbsoluteURLInCurrentDomain()){const urlObj=new URL(this.state.url,window.location.origin);this.state.url=this.state.url.replace(urlObj.origin,"");}}
onClickEdit(){this.state.editing=true;this.props.onEdit();this.updateUrlAndLabel();}
updateUrlAndLabel(){this.state.url=this.props.linkElement.getAttribute("href");const textContent=cleanZWChars(this.props.linkElement.textContent);const labelEqualsUrl=textContent===this.props.linkElement.getAttribute("href")||textContent+"/"===this.props.linkElement.getAttribute("href");this.state.label=labelEqualsUrl?"":textContent;}
async onClickCopy(ev){ev.preventDefault();await browser.navigator.clipboard.writeText(this.props.linkElement.href||"");this.notificationService.add(_t("Link copied to clipboard."),{type:"success",});this.props.onCopy();}
onClickRemove(){this.props.onRemove();}
onKeydownEnter(ev){const isAutoCompleteDropdownOpen=document.querySelector(".o-autocomplete--dropdown-menu");if(ev.key==="Enter"&&!isAutoCompleteDropdownOpen&&this.state.url){ev.preventDefault();this.onClickApply();}}
onKeydown(ev){if(ev.key==="Escape"){ev.preventDefault();ev.stopImmediatePropagation();this.onClickApply();}else if(ev.key=="Tab"){ev.preventDefault();const focusableElements=[...this.editingWrapper.el.querySelectorAll("input, select, button:not([disabled])"),];const currentIndex=focusableElements.indexOf(document.activeElement);const nextIndex=(currentIndex+(ev.shiftKey?-1:1)+focusableElements.length)%focusableElements.length;focusableElements[nextIndex].focus();}}
onInput(){this.onChange();}
onClickReplaceTitle(){this.state.label=this.state.urlTitle;this.onClickApply();}
onClickDirectDownload(checked){this.state.directDownload=checked;this.state.url=this.state.url.replace("&download=true","");if(this.state.directDownload){this.state.url+="&download=true";}}
onClickNewWindow(checked){this.state.linkTarget=checked?"_blank":"";if(!checked){this.state.relAttributeOptions.noopener.isChecked=false;}}
onClickStripDomain(checked){this.state.stripDomain=checked;}
async updateDocumentState(){const url=this.state.url;const urlObject=URL.parse(url,this.props.document.URL);if(url&&(url.startsWith("/web/content/")||(urlObject&&urlObject.pathname.startsWith("/web/content")&&urlObject.host===document.location.host))){const{type}=await this.props.getAttachmentMetadata(url);this.state.isDocument=type!=="url";this.state.directDownload=url.includes("&download=true");}else{this.state.isDocument=false;this.state.directDownload=true;}}
correctLink(url){if(url&&!url.startsWith("tel:")&&!url.startsWith("mailto:")&&!url.includes("://")&&!url.startsWith("/")&&!url.startsWith("#")&&!url.startsWith("${")){url="https://"+url;}
if(url&&(url.startsWith("http:")||url.startsWith("https:"))){url=URL.parse(url)?url:"";}
return url;}
deduceUrl(text){text=text.trim();if(/^(https?:|mailto:|tel:)/.test(text)){return text;}else{return deduceURLfromText(text,this.props.linkElement)||"";}}
getButtonShape(){const shapeToRegex=(shape)=>{const parts=shape.trim().split(/\s+/);const regexParts=parts.map((cls)=>{if(["outline","fill"].includes(cls)){cls=`btn-${cls}`;}
return`(?=.*\\b${cls}\\b)`;});return{regex:new RegExp(regexParts.join("")),nbParts:parts.length};};let shapeMatched="";let matchScore=0;for(const{shape}of this.buttonShapeData){if(!shape){continue;}
const{regex,nbParts}=shapeToRegex(shape);if(regex.test(this.props.linkElement.className)){if(matchScore<nbParts){matchScore=nbParts;shapeMatched=shape;}}}
return shapeMatched;}
resetPreview(){this.state.previewIcon={type:"fa",value:"fa-globe"};this.state.urlTitle=this.state.url||_t("No URL specified");this.state.urlDescription="";this.state.linkPreviewName="";}
async loadAsyncLinkPreview(){let url;if(this.state.url===""){this.resetPreview();this.state.previewIcon.value="fa-question-circle-o";return;}
if(this.isLogoutUrl()){this.resetPreview();this.state.urlTitle=_t("Logout");this.state.previewIcon.value="fa-sign-out";return;}
if(this.isAttachmentUrl()){const{name,mimetype}=await this.props.getAttachmentMetadata(this.state.url);this.resetPreview();this.state.urlTitle=name;this.state.previewIcon={type:"mimetype",value:mimetype};return;}
try{url=new URL(this.state.url,this.props.document.URL);}catch{this.notificationService.add(_t("This URL is invalid. Preview couldn't be updated."),{type:"danger",});return;}
this.resetPreview();const protocol=url.protocol;if(!protocol.startsWith("http")){const faMap={"mailto:":"fa-envelope-o","tel:":"fa-phone"};const icon=faMap[protocol];if(icon){this.state.previewIcon.value=icon;}}else if(window.location.hostname!==url.hostname&&!new RegExp(`^https?://${session.db}\\.odoo\\.com(/.*)?$`).test(url.origin)){this.state.previewIcon={type:"imgSrc",value:`https://www.google.com/s2/favicons?sz=16&domain=${encodeURIComponent(url)}`,};const externalMetadata=await this.props.getExternalMetaData(this.state.url).catch((error)=>{console.warn(`Error fetching external metadata for ${url.href}:`,error);return{};});this.state.urlTitle=externalMetadata?.og_title||this.state.url;this.state.urlDescription=externalMetadata?.og_description||"";this.state.imgSrc=externalMetadata?.og_image||"";if(externalMetadata?.og_image&&this.state.label&&this.state.urlTitle===this.state.url){this.state.urlTitle=this.state.label;}}else{const internalMetadata=await this.props.getInternalMetaData(url.href).catch((error)=>{console.warn(`Error fetching internal metadata for ${url.href}:`,error);return{};});if(internalMetadata.favicon){this.state.previewIcon={type:"imgSrc",value:internalMetadata.favicon.href,};}
if(internalMetadata.error_msg){this.notificationService.add(internalMetadata.error_msg,{type:"warning",});}else if(internalMetadata.other_error_msg){console.error("Internal meta data retrieve error for link preview: "+
internalMetadata.other_error_msg);}else{this.state.linkPreviewName=internalMetadata.link_preview_name||internalMetadata.display_name||internalMetadata.name;this.state.urlDescription=internalMetadata?.description||"";this.state.urlTitle=this.state.linkPreviewName?this.state.linkPreviewName:this.state.url;}
if((internalMetadata.ogTitle||internalMetadata.title)&&!this.state.linkPreviewName){this.state.urlTitle=internalMetadata.ogTitle?internalMetadata.ogTitle.getAttribute("content"):internalMetadata.title.text.trim();}}}
get classes(){const classes=[...this.props.linkElement.classList].filter((value)=>!value.match(/^(btn.*|rounded-circle|flat|(text|bg)-(o-color-\d$|\d{3}$))$/));let stylePrefix="";if(this.state.type){if(this.state.buttonSize){classes.push(`btn-${this.state.buttonSize}`);}
if(this.state.buttonShape){const buttonShape=this.state.buttonShape.split(" ");if(["outline","fill"].includes(buttonShape[0])){stylePrefix=`${buttonShape[0]}-`;}
classes.push(buttonShape.slice(stylePrefix?1:0).join(" "));}
classes.push(`btn`,`btn-${stylePrefix}${this.state.type}`);}
const textColor=this.customTextColorState.selectedColor;if(isCSSVariable(textColor)){classes.push(`text-${textColor}`);}
const fillColor=this.customFillColorState.selectedColor;if(isCSSVariable(fillColor)){classes.push(`bg-${fillColor}`);}
return classes.filter(Boolean).join(" ");}
get customStyles(){if(!this.props.allowCustomStyle||this.state.type!=="custom"){return false;}
let customStyles="";const textColor=this.customTextColorState.selectedColor;if(!isCSSVariable(textColor)){customStyles+=`color: ${textColor}; `;}
const fillColor=this.customFillColorState.selectedColor;if(!isCSSVariable(fillColor)){const backgroundProperty=fillColor.includes("gradient")?"background-image":"background-color";customStyles+=`${backgroundProperty}: ${fillColor}; `;}
const borderColor=this.customBorderColorState.selectedColor;customStyles+=`border-width: ${this.state.customBorderSize}px; `;customStyles+=`border-color: ${formatColor(borderColor)}; `;customStyles+=`border-style: ${this.state.customBorderStyle}; `;return customStyles;}
async uploadFile(){const{upload,getURL}=this.uploadService;const{resModel,resId}=this.props.recordInfo;const[attachment]=await upload({resModel,resId,accessToken:true});if(!attachment){return;}
this.props.onUpload?.(attachment);this.state.url=getURL(attachment,{download:true,unique:true,accessToken:true});this.state.label||=attachment.name;this.state.attachmentId=attachment.id;this.onChange();}
isLogoutUrl(){return!!this.state.url.match(/\/web\/session\/logout\b/);}
isAttachmentUrl(){return!!this.state.url.match(/\/web\/content\/\d+/);}
isAbsoluteURLInCurrentDomain(){let hasProtocol;try{hasProtocol=!!new URL(this.state.url).protocol;}catch{hasProtocol=false;}
if(!hasProtocol){return false;}
const urlObj=new URL(this.state.url,window.location.origin);return(urlObj.origin===window.location.origin||new RegExp(`^https?://${session.db}\\.odoo\\.com(/.*)?$`).test(urlObj.origin));}}
return __exports;});;

/* /html_editor/static/src/main/link/link_selection_odoo_plugin.js */
odoo.define('@html_editor/main/link/link_selection_odoo_plugin',['@html_editor/plugin','@html_editor/utils/blocks'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{isBlock}=require("@html_editor/utils/blocks");const OdooLinkSelectionPlugin=__exports.OdooLinkSelectionPlugin=class OdooLinkSelectionPlugin extends Plugin{static id="odooLinkSelection";resources={ineligible_link_for_zwnbsp_predicates:[(link)=>[link,...link.querySelectorAll("*")].some((el)=>el.nodeName==="IMG"||isBlock(el)),(link)=>link.matches("a.nav-link"),],ineligible_link_for_selection_indication_predicates:(link)=>link.matches(".btn"),};}
return __exports;});;

/* /html_editor/static/src/main/link/link_selection_plugin.js */
odoo.define('@html_editor/main/link/link_selection_plugin',['@html_editor/plugin','@html_editor/utils/dom_traversal','@html_editor/utils/dom','@html_editor/utils/dom_info'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{closestElement,selectElements}=require("@html_editor/utils/dom_traversal");const{removeClass}=require("@html_editor/utils/dom");const{isProtected,isProtecting}=require("@html_editor/utils/dom_info");const LinkSelectionPlugin=__exports.LinkSelectionPlugin=class LinkSelectionPlugin extends Plugin{static id="linkSelection";static dependencies=["selection","feff"];static shared=["padLinkWithZwnbsp"];resources={selectionchange_handlers:this.resetLinkInSelection.bind(this),clean_for_save_handlers:({root})=>this.clearLinkInSelectionClass(root),normalize_handlers:()=>this.resetLinkInSelection(),feff_providers:this.addFeffsToLinks.bind(this),system_classes:["o_link_in_selection"],selection_placeholder_container_predicates:(container)=>{if(container.nodeName==="BUTTON"||container.nodeName==="A"){return false;}},};addFeffsToLinks(root,cursors){return[...selectElements(root,"a")].filter(this.isLinkEligibleForZwnbsp.bind(this)).flatMap((link)=>this.dependencies.feff.surroundWithFeffs(link,cursors));}
padLinkWithZwnbsp(link){const cursors=this.dependencies.selection.preserveSelection();this.dependencies.feff.surroundWithFeffs(link,cursors);cursors.restore();}
isLinkEligibleForZwnbsp(link){return(link.isContentEditable&&link.parentElement.isContentEditable&&this.editable.contains(link)&&!isProtected(link)&&!isProtecting(link)&&!this.getResource("ineligible_link_for_zwnbsp_predicates").some((p)=>p(link)));}
isLinkEligibleForVisualIndication(link){return(this.isLinkEligibleForZwnbsp(link)&&!this.getResource("ineligible_link_for_selection_indication_predicates").some((predicate)=>predicate(link)));}
resetLinkInSelection(selectionData=this.dependencies.selection.getSelectionData()){this.clearLinkInSelectionClass(this.editable);const{anchorNode,focusNode}=selectionData.editableSelection;const[anchorLink,focusLink]=[anchorNode,focusNode].map((node)=>closestElement(node,"a"));const singleLinkInSelection=anchorLink===focusLink&&anchorLink;if(singleLinkInSelection&&this.isLinkEligibleForVisualIndication(singleLinkInSelection)&&this.document.activeElement===this.editable){singleLinkInSelection.classList.add("o_link_in_selection");}}
clearLinkInSelectionClass(root){for(const link of selectElements(root,".o_link_in_selection")){removeClass(link,"o_link_in_selection");}}}
return __exports;});;

/* /html_editor/static/src/main/link/powerbox_url_paste_plugin.js */
odoo.define('@html_editor/main/link/powerbox_url_paste_plugin',['@html_editor/plugin'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const MediaUrlPastePlugin=__exports.MediaUrlPastePlugin=class MediaUrlPastePlugin extends Plugin{static id="mediaUrlPaste";static dependencies=["link","dom","history","powerbox"];resources={paste_url_overrides:this.openPowerboxOnUrlPaste.bind(this),};openPowerboxOnUrlPaste(text,url){const commands=this.getResource("paste_media_url_command_providers").map((provider)=>provider(url)).filter(Boolean);if(commands.length){commands.push(this.dependencies.link.getPathAsUrlCommand(text,url));const restoreSavepoint=this.dependencies.history.makeSavePoint();this.dependencies.dom.insert(text);this.dependencies.history.addStep();this.dependencies.powerbox.openPowerbox({commands,onApplyCommand:restoreSavepoint});return true;}}}
return __exports;});;

/* /html_editor/static/src/main/link/utils.js */
odoo.define('@html_editor/main/link/utils',[],function(require){'use strict';let __exports={};const tldWhitelist=["com","net","org","ac","ad","ae","af","ag","ai","al","am","an","ao","aq","ar","as","at","au","aw","ax","az","ba","bb","bd","be","bf","bg","bh","bi","bj","bl","bm","bn","bo","br","bq","bs","bt","bv","bw","by","bz","ca","cc","cd","cf","cg","ch","ci","ck","cl","cm","cn","co","cr","cs","cu","cv","cw","cx","cy","cz","dd","de","dj","dk","dm","do","dz","ec","ee","eg","eh","er","es","et","eu","fi","fj","fk","fm","fo","fr","ga","gb","gd","ge","gf","gg","gh","gi","gl","gm","gn","gp","gq","gr","gs","gt","gu","gw","gy","hk","hm","hn","hr","ht","hu","id","ie","il","im","in","io","iq","ir","is","it","je","jm","jo","jp","ke","kg","kh","ki","km","kn","kp","kr","kw","ky","kz","la","lb","lc","li","lk","lr","ls","lt","lu","lv","ly","ma","mc","md","me","mf","mg","mh","mk","ml","mm","mn","mo","mp","mq","mr","ms","mt","mu","mv","mw","mx","my","mz","na","nc","ne","nf","ng","ni","nl","no","np","nr","nu","nz","om","pa","pe","pf","pg","ph","pk","pl","pm","pn","pr","ps","pt","pw","py","qa","re","ro","rs","ru","rw","sa","sb","sc","sd","se","sg","sh","si","sj","sk","sl","sm","sn","so","sr","ss","st","su","sv","sx","sy","sz","tc","td","tf","tg","th","tj","tk","tl","tm","tn","to","tp","tr","tt","tv","tw","tz","ua","ug","uk","um","us","uy","uz","va","vc","ve","vg","vi","vn","vu","wf","ws","ye","yt","yu","za","zm","zr","zw","co\\.uk"];const urlRegexBase=`|(?:www.))[-a-zA-Z0-9@:%._\\+~#=]{2,256}\\.[a-zA-Z][a-zA-Z0-9]{1,62}|(?:[-a-zA-Z0-9@:%._\\+~#=]{2,256}\\.(?:${tldWhitelist.join(
    "|"
)})\\b))(?:(?:[/?#])[^\\s]*[^!.,})\\]'"\\s]|(?:[^!(){}.,[\\]'"\\s]+))?`;const httpCapturedRegex=`(https?:\\/\\/)`;const URL_REGEX=__exports.URL_REGEX=new RegExp(`((?:(?:${httpCapturedRegex}${urlRegexBase})`,"i");const EMAIL_REGEX=__exports.EMAIL_REGEX=/^(mailto:)?[\w-.]+@(?:[\w-]+\.)+[\w-]{2,4}$/i;const PHONE_REGEX=__exports.PHONE_REGEX=/^(tel:(?:\/\/)?)?\+?[\d\s.\-()/]{3,25}$/;__exports.cleanZWChars=cleanZWChars;function cleanZWChars(text){return text.replace(/\u200B|\uFEFF/g,"");}
__exports.deduceURLfromText=deduceURLfromText;function deduceURLfromText(text,link){const label=cleanZWChars(text).trim();let match=label.match(EMAIL_REGEX);if(match){return match[1]?match[0]:"mailto:"+match[0];}
match=label.match(URL_REGEX);if(match&&match[0]===label){const currentHttpProtocol=(link?.href.match(/^http(s)?:\/\//gi)||[])[0];if(match[2]){return match[0];}else if(currentHttpProtocol){return currentHttpProtocol+match[0];}else{return"https://"+match[0];}}
match=label.match(PHONE_REGEX);if(match){return(match[1]?match[0]:"tel:"+match[0]).replace(/\s+/g,"");}
return null;}
return __exports;});;

/* /html_editor/static/src/main/list/list_plugin.js */
odoo.define('@html_editor/main/list/list_plugin',['@html_editor/plugin','@html_editor/utils/blocks','@html_editor/utils/dom','@html_editor/utils/dom_info','@html_editor/utils/dom_traversal','@html_editor/utils/position','@web/core/l10n/translation','@html_editor/main/list/utils','@html_editor/utils/selection','@html_editor/utils/resource','@html_editor/utils/formatting','@html_editor/utils/color','@html_editor/utils/base_container','@html_editor/main/list/list_selector','@odoo/owl','@html_editor/main/toolbar/toolbar','@html_editor/core/selection_plugin','@web/core/utils/objects','@html_editor/utils/functions','@web/core/utils/colors'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{closestBlock,isBlock}=require("@html_editor/utils/blocks");const{removeClass,removeStyle,toggleClass,unwrapContents,wrapInlinesInBlocks,}=require("@html_editor/utils/dom");const{getDeepestPosition,isElement,isEmptyBlock,isListElement,isListItemElement,isParagraphRelatedElement,isProtected,isProtecting,isShrunkBlock,isVisibleTextNode,listElementSelector,}=require("@html_editor/utils/dom_info");const{closestElement,descendants,getAdjacents,selectElements,ancestors,childNodes,firstLeaf,lastLeaf,}=require("@html_editor/utils/dom_traversal");const{childNodeIndex,nodeSize}=require("@html_editor/utils/position");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{compareListTypes,createList,insertListAfter,isListItem}=require("@html_editor/main/list/utils");const{callbacksForCursorUpdate}=require("@html_editor/utils/selection");const{withSequence}=require("@html_editor/utils/resource");const{FONT_SIZE_CLASSES,getFontSizeOrClass,getHtmlStyle}=require("@html_editor/utils/formatting");const{getTextColorOrClass,TEXT_CLASSES_REGEX}=require("@html_editor/utils/color");const{baseContainerGlobalSelector}=require("@html_editor/utils/base_container");const{ListSelector}=require("@html_editor/main/list/list_selector");const{reactive}=require("@odoo/owl");const{composeToolbarButton}=require("@html_editor/main/toolbar/toolbar");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const{pick}=require("@web/core/utils/objects");const{weakMemoize}=require("@html_editor/utils/functions");const{isColorGradient}=require("@web/core/utils/colors");const listSelectorItems=[{id:"bulleted_list",commandId:"toggleListUL",mode:"UL",},{id:"numbered_list",commandId:"toggleListOL",mode:"OL",},{id:"checklist",commandId:"toggleListCL",mode:"CL",},];const ListPlugin=__exports.ListPlugin=class ListPlugin extends Plugin{static id="list";static dependencies=["baseContainer","tabulation","history","input","split","selection","delete","dom","color",];static defaultConfig={allowChecklist:true,};toolbarListSelectorKey=reactive({value:0});resources={user_commands:[{id:"toggleListUL",title:_t("Bulleted list"),description:_t("Create a simple bulleted list"),icon:"fa-list-ul",run:()=>this.toggleListCommand({mode:"UL"}),isAvailable:this.canToggleList.bind(this),},{id:"toggleListOL",title:_t("Numbered list"),description:_t("Create a list with numbering"),icon:"fa-list-ol",run:({listStyle}={})=>this.toggleListCommand({mode:"OL",listStyle}),isAvailable:this.canToggleList.bind(this),},{id:"toggleListCL",title:_t("Checklist"),description:_t("Track tasks with a checklist"),icon:"fa-check-square-o",run:()=>this.toggleListCommand({mode:"CL"}),isAvailable:(selection)=>this.config.allowChecklist&&this.canToggleList(selection),},],shortcuts:[{hotkey:"control+shift+7",commandId:"toggleListOL"},{hotkey:"control+shift+8",commandId:"toggleListUL"},{hotkey:"control+shift+9",commandId:"toggleListCL"},],shorthands:[{pattern:/^1[.)]$/,commandId:"toggleListOL",},{pattern:/^a[.)]$/,commandId:"toggleListOL",commandParams:{listStyle:"lower-alpha"},},{pattern:/^A[.)]$/,commandId:"toggleListOL",commandParams:{listStyle:"upper-alpha"},},{pattern:/^[-*]$/,commandId:"toggleListUL",},{pattern:/^\[\]$/,commandId:"toggleListCL",},],toolbar_items:[withSequence(5,{id:"list",groupId:"layout",description:_t("Toggle List"),Component:ListSelector,props:{getButtons:()=>this.listSelectorButtons,getListMode:this.getListMode.bind(this),key:this.toolbarListSelectorKey,},isAvailable:this.canToggleList.bind(this),}),],powerbox_items:[{categoryId:"structure",commandId:"toggleListUL",},{categoryId:"structure",commandId:"toggleListOL",},{categoryId:"structure",commandId:"toggleListCL",},].map((item)=>withSequence(5,item)),power_buttons:[{commandId:"toggleListUL"},{commandId:"toggleListOL"},{commandId:"toggleListCL"},].map((item)=>withSequence(15,item)),hints:[{selector:`LI, LI > ${baseContainerGlobalSelector}`,text:_t("List")}],normalize_handlers:this.normalize.bind(this),step_added_handlers:this.updateToolbarButtons.bind(this),delete_handlers:this.adjustListPaddingOnDelete.bind(this),delete_backward_overrides:this.handleDeleteBackward.bind(this),delete_range_overrides:this.handleDeleteRange.bind(this),tab_overrides:this.handleTab.bind(this),shift_tab_overrides:this.handleShiftTab.bind(this),split_element_block_overrides:this.handleSplitBlock.bind(this),color_apply_overrides:this.applyColorToListItem.bind(this),format_selection_handlers:this.applyFormatToListItem.bind(this),node_to_insert_processors:this.processNodeToInsert.bind(this),clipboard_content_processors:this.processContentForClipboard.bind(this),before_insert_within_pre_processors:this.insertListWithinPre.bind(this),triple_click_overrides:this.handleTripleClick.bind(this),fully_selected_node_predicates:(node,selection,range)=>{if(node.nodeName==="LI"){const nonListChildren=childNodes(node).filter((n)=>!["UL","OL"].includes(n.nodeName));if(!nonListChildren.length){return;}
const startLeaf=firstLeaf(nonListChildren[0]);const endLeaf=lastLeaf(nonListChildren[nonListChildren.length-1]);return(range.isPointInRange(startLeaf,0)&&range.isPointInRange(endLeaf,nodeSize(endLeaf)));}},};setup(){this.addDomListener(this.editable,"touchstart",this.onPointerdown);this.addDomListener(this.editable,"mousedown",this.onPointerdown);this.listSelectorButtons=this.getListSelectorButtons();this.canToggleListMemoized=weakMemoize((selection)=>isHtmlContentSupported(selection)&&this.getBlocksToToggleList().length>0);}
toggleListCommand({mode,listStyle}={}){this.toggleList(mode,listStyle);this.dependencies.history.addStep();}
getBlocksToToggleList(){const targetedBlocks=[...this.dependencies.selection.getTargetedBlocks()];return targetedBlocks.filter((block)=>!descendants(block).some((descendant)=>targetedBlocks.includes(descendant))&&block.isContentEditable&&!["OL","UL"].includes(block.tagName));}
canToggleList(selection){return this.canToggleListMemoized(selection);}
toggleList(mode,listStyle){if(!["UL","OL","CL"].includes(mode)){throw new Error(`Invalid list type: ${mode}`);}
if(mode==="CL"&&!!listStyle){throw new Error(`listStyle is not compatible with "CL" list type`);}
const sameModeListItems=new Set();const nonListBlocks=new Set();const listsToSwitch=new Set();for(const block of this.getBlocksToToggleList()){const li=closestElement(block,isListItem);if(li){if(this.getListMode(li.parentElement)===mode){sameModeListItems.add(li);}else{listsToSwitch.add(li.parentElement);}}else{nonListBlocks.add(block);}}
if(listsToSwitch.size||nonListBlocks.size){for(const list of listsToSwitch){const cursors=this.dependencies.selection.preserveSelection();const newList=this.switchListMode(list,mode);cursors.remapNode(list,newList).restore();}
for(const block of nonListBlocks){const list=this.blockToList(block,mode,listStyle);if(listStyle){list.style.listStyle=listStyle;}}}else{for(const li of sameModeListItems){this.liToBlocks(li);}}}
normalize(root=this.editable){const closestNestedLI=closestElement(root,"li:has(ul, ol)");if(closestNestedLI&&closestNestedLI.closest("ul, ol")){root=closestNestedLI.parentElement;}
for(let element of selectElements(root,"ul, ol, li")){if(isProtected(element)||isProtecting(element)){continue;}
for(const fn of[this.liWithoutParentToP,this.mergeSimilarLists,this.normalizeLI,this.normalizeNestedList,]){const updatedElement=fn.call(this,element);if(updatedElement){element=updatedElement;}}}}
blockToList(element,mode){if(element.matches(baseContainerGlobalSelector)){return this.baseContainerToList(element,mode);}
if(element.matches("td, th, li.nav-item")){return this.blockContentsToList(element,mode);}
let list;const cursors=this.dependencies.selection.preserveSelection();if(element===this.editable){const callingNode=element.firstChild;const group=getAdjacents(callingNode,(n)=>!isBlock(n));list=insertListAfter(this.document,callingNode,mode,group);}else{const parent=element.parentNode;const childIndex=childNodeIndex(element);list=insertListAfter(this.document,element,mode,[element]);cursors.update((cursor)=>{if(cursor.node===parent){if(cursor.offset===childIndex){[cursor.node,cursor.offset]=[list.firstChild,0];}else if(cursor.offset===childIndex+1){[cursor.node,cursor.offset]=[list.firstChild,1];}}});if(element.hasAttribute("dir")){list.setAttribute("dir",element.getAttribute("dir"));}}
cursors.restore();return list;}
baseContainerToList(baseContainer,mode){const cursors=this.dependencies.selection.preserveSelection();const list=insertListAfter(this.document,baseContainer,mode,childNodes(baseContainer));const textAlign=baseContainer.style.getPropertyValue("text-align");if(textAlign){list.firstElementChild.style.setProperty("text-align",textAlign);baseContainer.style.removeProperty("text-align");}
this.dependencies.dom.copyAttributes(baseContainer,list);this.adjustListPadding(list);baseContainer.remove();cursors.remapNode(baseContainer,list.firstChild).restore();return list;}
blockContentsToList(block,mode){const cursors=this.dependencies.selection.preserveSelection();const list=insertListAfter(this.document,block.lastChild,mode,[...block.childNodes]);cursors.remapNode(block,list.firstChild).restore();return list;}
convertList(node,newMode){if(!["UL","OL","LI"].includes(node.tagName)){return;}
const listMode=this.getListMode(node);if(listMode&&newMode!==listMode){node=this.switchListMode(node,newMode);}
for(const child of node.children){this.convertList(child,newMode);}
return node;}
getListMode(listContainerEl){if(!["UL","OL"].includes(listContainerEl.tagName)){return;}
if(listContainerEl.tagName==="OL"){return"OL";}
return listContainerEl.classList.contains("o_checklist")?"CL":"UL";}
switchListMode(list,newMode){if(this.getListMode(list)===newMode){return;}
const newTag=newMode==="CL"?"UL":newMode;const newList=this.dependencies.dom.setTagName(list,newTag);newList.style.removeProperty("list-style");for(const li of newList.children){li.style.removeProperty("list-style");}
removeClass(newList,"o_checklist");if(newMode==="CL"){newList.classList.add("o_checklist");}
this.adjustListPadding(newList);return newList;}
liToBlocks(li){while(li){li=this.outdentLI(li);}}
liWithoutParentToP(element){const isOrphan=element.nodeName==="LI"&&!element.closest("ul, ol");if(!isOrphan){return;}
if(element.children.length&&[...element.children].every(isBlock)){unwrapContents(element);}else{const paragraph=this.dependencies.baseContainer.createBaseContainer();element.replaceWith(paragraph);paragraph.replaceChildren(...element.childNodes);}}
mergeSimilarLists(element){if(!element.matches("ul, ol, li.oe-nested")||(element.matches("li.oe-nested")&&!element.querySelector("ul, ol"))){return;}
const previousSibling=element.previousElementSibling;if(previousSibling&&element.isContentEditable&&previousSibling.isContentEditable&&(compareListTypes(previousSibling,element)||(element.tagName==="LI"&&isListItem(previousSibling)&&isListElement(element.firstChild)))){const cursors=this.dependencies.selection.preserveSelection();cursors.update(callbacksForCursorUpdate.merge(element));previousSibling.append(...element.childNodes);element.remove();this.adjustListPadding(previousSibling);cursors.restore();return previousSibling;}}
normalizeLI(element){if(!isListItem(element)){return;}
if(element.firstChild?.nodeType===Node.ELEMENT_NODE&&isListElement(element.firstChild)){element.classList.add("oe-nested");}
if([...element.children].some((child)=>isBlock(child)&&!this.dependencies.split.isUnsplittable(child))){const cursors=this.dependencies.selection.preserveSelection();wrapInlinesInBlocks(element,{baseContainerNodeName:this.dependencies.baseContainer.getDefaultNodeName(),cursors,});cursors.restore();}}
normalizeNestedList(element){if(element.tagName==="LI"){return;}
if(["UL","OL"].includes(element.parentElement?.tagName)){const cursors=this.dependencies.selection.preserveSelection();let li;if(element.previousElementSibling?.nodeName==="LI"){li=element.previousElementSibling;}else{li=this.document.createElement("li");li.classList.add("oe-nested");}
element.parentElement.insertBefore(li,element);li.appendChild(element);cursors.restore();}}
indentLI(li){const lip=li.previousElementSibling||this.document.createElement("li");if(!lip.hasChildNodes()){lip.classList.add("oe-nested");}
const parentLi=li.parentElement;const nextSiblingLi=li.nextSibling;const destul=li.previousElementSibling?.querySelector("ol, ul")||li.querySelector("ol, ul")||li.closest("ol, ul");const cursors=this.dependencies.selection.preserveSelection();parentLi.removeChild(li);const ul=createList(this.document,this.getListMode(destul));lip.append(ul);li.before(lip);ul.append(li);const nestedLists=childNodes(li).filter((n)=>isListElement(n));ul.after(...nestedLists);parentLi.insertBefore(lip,nextSiblingLi);cursors.update((cursor)=>{if(cursor.node===lip.parentNode){const childIndex=childNodeIndex(lip);if(cursor.offset===childIndex){[cursor.node,cursor.offset]=[ul,0];}else if(cursor.offset===childIndex+1){[cursor.node,cursor.offset]=[ul,1];}}});cursors.restore();}
outdentLI(li){const listToSplit=li.querySelector("ol, ul")||li.nextElementSibling;if(listToSplit){this.splitList(listToSplit);}
if(isListItem(li.parentNode.parentNode)){this.outdentNestedLI(li);return li;}
this.outdentTopLevelLI(li);return null;}
splitList(node){const cursors=this.dependencies.selection.preserveSelection();const currentList=closestElement(node,"ul, ol");const newList=currentList.cloneNode(false);const isList=isListElement(node);const wrapperLi=isList?this.document.createElement("li"):node;if(isList){wrapperLi.classList.add("oe-nested");newList.append(wrapperLi);cursors.update(callbacksForCursorUpdate.after(node.parentNode.parentNode,newList));node.parentNode.parentNode.after(newList);}else if(isListItem(node.parentNode.parentNode)){const lip=this.document.createElement("li");lip.classList.add("oe-nested");lip.append(newList);cursors.update(callbacksForCursorUpdate.after(node.parentNode.parentNode,lip));node.parentNode.parentNode.after(lip);}else{cursors.update(callbacksForCursorUpdate.after(node.parentNode,newList));node.parentNode.after(newList);}
const moveFrom=isList?node.parentElement:node;while(moveFrom.nextSibling){cursors.update(callbacksForCursorUpdate.append(newList,moveFrom.nextSibling));newList.append(moveFrom.nextSibling);}
const moveTo=isList?wrapperLi:newList;cursors.update(callbacksForCursorUpdate.prepend(moveTo,node));moveTo.prepend(node);cursors.restore();this.adjustListPadding(currentList);this.adjustListPadding(newList);return newList;}
outdentNestedLI(li){const cursors=this.dependencies.selection.preserveSelection();const ul=li.parentNode;const lip=ul.parentNode;cursors.update(callbacksForCursorUpdate.after(lip,li));lip.after(li);while(ul.nextSibling){cursors.update(callbacksForCursorUpdate.append(li,ul.nextSibling));li.append(ul.nextSibling);}
if(!ul.children.length){cursors.update(callbacksForCursorUpdate.remove(ul));ul.remove();}
if(!lip.children.length&&lip.classList.contains("oe-nested")){cursors.update(callbacksForCursorUpdate.remove(lip));lip.remove();}
this.adjustListPadding(li.parentElement);cursors.restore();}
outdentTopLevelLI(li){const cursors=this.dependencies.selection.preserveSelection();const ul=li.parentNode;const children=childNodes(li);if(!children.every(isBlock)){const baseContainer=this.dependencies.baseContainer.createBaseContainer();for(const child of children){cursors.update(callbacksForCursorUpdate.append(baseContainer,child));baseContainer.append(child);}
if(isShrunkBlock(baseContainer)){baseContainer.append(this.document.createElement("br"));}
li.append(baseContainer);cursors.remapNode(li,baseContainer);}
const blocksToMove=childNodes(li);for(const block of blocksToMove.toReversed()){cursors.update(callbacksForCursorUpdate.after(ul,block));ul.after(block);}
const dir=li.getAttribute("dir")||ul.getAttribute("dir");const textAlign=li.style.getPropertyValue("text-align");const liColorStyle=getTextColorOrClass(li);const liFontSizeStyle=getFontSizeOrClass(li);const wrapChildren=(parent,tag)=>{const wrapper=this.document.createElement(tag);wrapper.append(...parent.childNodes);parent.replaceChildren(wrapper);cursors.remapNode(parent,wrapper);return wrapper;};for(const block of blocksToMove){if(dir&&!block.getAttribute("dir")){block.setAttribute("dir",dir);}
if(textAlign&&!block.style.getPropertyValue("text-align")){block.style.setProperty("text-align",textAlign);}
if(liColorStyle){const font=wrapChildren(block,"font");this.dependencies.color.colorElement(font,liColorStyle.value,"color");}
if(liFontSizeStyle&&!isEmptyBlock(block)){const span=wrapChildren(block,"span");if(liFontSizeStyle.type==="font-size"){span.style.fontSize=liFontSizeStyle.value;}else if(liFontSizeStyle.type==="class"){span.classList.add(liFontSizeStyle.value);}}}
cursors.update(callbacksForCursorUpdate.remove(li));li.remove();if(!ul.firstElementChild){cursors.update(callbacksForCursorUpdate.remove(ul));ul.remove();}else{this.adjustListPadding(ul);}
cursors.restore();}
indentListNodes(listNodes){for(const li of listNodes){this.indentLI(li);}}
outdentListNodes(listNodes){for(const li of listNodes){this.outdentLI(li);}}
separateListItems(){const listItems=new Set();const navListItems=new Set();const nonListItems=[];const blocks=[...this.dependencies.selection.getTargetedBlocks()].filter((n)=>!n.querySelector("li"));for(const block of blocks){const closestLI=block.closest("li");if(closestLI){if(closestLI.classList.contains("nav-item")){navListItems.add(closestLI);}else if(closestLI.isContentEditable){listItems.add(closestLI);}}else if(!["UL","OL"].includes(block.tagName)){nonListItems.push(block);}}
return{listItems:[...listItems],navListItems:[...navListItems],nonListItems};}
processNodeToInsert({nodeToInsert,container}){if(isListItemElement(container)&&isParagraphRelatedElement(nodeToInsert)){nodeToInsert=this.dependencies.dom.setTagName(nodeToInsert,"LI");}
const listEl=container&&closestElement(container,listElementSelector);if(!listEl){return nodeToInsert;}
const mode=container&&this.getListMode(listEl);if(isListItemElement(nodeToInsert)&&nodeToInsert.querySelector("ol, ul")){return this.convertList(nodeToInsert,mode);}
if(isListElement(nodeToInsert)){return this.convertList(nodeToInsert,this.getListMode(nodeToInsert));}
return nodeToInsert;}
handleTab(){const selection=this.dependencies.selection.getEditableSelection();const closestLI=closestElement(selection.anchorNode,"LI");if(closestLI){const block=closestBlock(selection.anchorNode);const isLiContainsUnSpittable=isParagraphRelatedElement(block)&&ancestors(block,closestLI).find((node)=>this.dependencies.split.isUnsplittable(node));if(isLiContainsUnSpittable){return;}}
const{listItems,navListItems,nonListItems}=this.separateListItems();if(listItems.length||navListItems.length){this.indentListNodes(listItems);this.dependencies.tabulation.indentBlocks(nonListItems);const listsToAdjustPadding=new Set(listItems.map((li)=>closestElement(li,"ul, ol")).filter(Boolean));for(const list of listsToAdjustPadding){this.adjustListPadding(list);}
this.dependencies.history.addStep();return true;}}
handleShiftTab(){const selection=this.dependencies.selection.getEditableSelection();const closestLI=closestElement(selection.anchorNode,"LI");if(closestLI){const block=closestBlock(selection.anchorNode);const isLiContainsUnSpittable=isParagraphRelatedElement(block)&&ancestors(block,closestLI).find((node)=>this.dependencies.split.isUnsplittable(node));if(isLiContainsUnSpittable){return;}}
const{listItems,navListItems,nonListItems}=this.separateListItems();if(listItems.length||navListItems.length){this.outdentListNodes(listItems);this.dependencies.tabulation.outdentBlocks(nonListItems);this.dependencies.history.addStep();return true;}}
handleSplitBlock(params){const closestLI=closestElement(params.targetNode,"LI");const isBlockUnsplittable=closestLI&&Array.from(closestLI.childNodes).some((node)=>isBlock(node)&&this.dependencies.split.isUnsplittable(node));if(!closestLI||isBlockUnsplittable){return;}
if(isEmptyBlock(closestLI)){this.outdentLI(closestLI);return true;}
const[,newLI]=this.dependencies.split.splitElementBlock({...params,blockToSplit:closestLI,});if(newLI){if(closestLI.classList.contains("o_checked")){removeClass(newLI,"o_checked");}
const[anchorNode,anchorOffset]=getDeepestPosition(newLI,0);this.dependencies.selection.setSelection({anchorNode,anchorOffset});this.adjustListPadding(newLI.parentElement);}
return true;}
handleDeleteBackward(range){const{startContainer,startOffset,endContainer,endOffset}=range;const closestLIendContainer=closestElement(endContainer,"LI");if(!closestLIendContainer){return;}
const isCursorAtStartofLI=(startContainer===endContainer&&startOffset===endOffset)||closestElement(startContainer,"LI")!==closestLIendContainer;if(!isCursorAtStartofLI){return;}
let element=closestLIendContainer;while(["LI","UL","OL"].includes(element.tagName)){if(this.dependencies.split.isUnsplittable(element)){return;}
element=element.parentElement;}
if(!closestLIendContainer.classList.contains("oe-nested")){closestLIendContainer.classList.add("oe-nested");closestLIendContainer.classList.remove("o_checked");}else{const list=closestElement(closestLIendContainer,"ul[dir], ol[dir]");const dir=list?.getAttribute("dir");if(dir){closestLIendContainer.setAttribute("dir",dir);}
this.liToBlocks(closestLIendContainer);}
return true;}
handleDeleteRange(range){const{startContainer,endContainer}=range;const startCheckedLi=closestElement(startContainer,"li.o_checked");if(!startCheckedLi){return;}
const endLi=closestElement(endContainer,"li");if(startCheckedLi===endLi){return;}
range=this.dependencies.delete.deleteRange(range);this.dependencies.selection.setSelection({anchorNode:range.startContainer,anchorOffset:range.startOffset,});if(isEmptyBlock(startCheckedLi)){removeClass(startCheckedLi,"o_checked");}
return true;}
processContentForClipboard(clonedContents,selection){if(clonedContents.firstChild.nodeName==="LI"){const list=selection.commonAncestorContainer.cloneNode();list.replaceChildren(...childNodes(clonedContents));clonedContents=list;}
return clonedContents;}
insertListWithinPre(node){const listItems=node.querySelectorAll("li:not(.oe-nested)");for(const li of listItems){const nestingLvl=ancestors(li).filter(isListElement).length-1;const list=closestElement(li,"ul, ol");const listMode=this.getListMode(list);let char;if(listMode==="CL"){char="[] ";}else if(listMode==="OL"){const children=childNodes(li.parentElement).filter((n)=>!n.classList.contains("oe-nested"));char=`${children.indexOf(li) + 1}. `;}else{char="* ";}
const prefix=" ".repeat(nestingLvl*4)+char;li.prepend(this.document.createTextNode(prefix));}
return node;}
onPointerdown(ev){const node=ev.target;const isChecklistItem=node.tagName=="LI"&&this.getListMode(node.parentElement)=="CL";if(!isChecklistItem){return;}
let offsetX=ev.offsetX;let offsetY=ev.offsetY;if(ev.type==="touchstart"){const rect=node.getBoundingClientRect();offsetX=ev.touches[0].clientX-rect.x;offsetY=ev.touches[0].clientY-rect.y;}
if(isChecklistItem&&this.isPointerInsideCheckbox(node,offsetX,offsetY)){toggleClass(node,"o_checked");const{documentSelectionIsInEditable}=this.dependencies.selection.getSelectionData();if(!documentSelectionIsInEditable){this.editable.focus();this.dependencies.selection.setSelection({anchorNode:node,anchorOffset:0});}
ev.preventDefault();this.dependencies.history.addStep();}}
handleTripleClick(ev){const node=ev.target;const isChecklistItem=node.tagName==="LI"&&this.getListMode(node.parentElement)==="CL";if(isChecklistItem&&this.isPointerInsideCheckbox(node,ev.offsetX,ev.offsetY)){return true;}}
isPointerInsideCheckbox(li,pointerOffsetX,pointerOffsetY){const beforeStyle=this.window.getComputedStyle(li,":before");const checkboxPosition={left:parseInt(beforeStyle.left),top:parseInt(beforeStyle.top),};checkboxPosition.right=checkboxPosition.left+parseInt(beforeStyle.width);checkboxPosition.bottom=checkboxPosition.top+parseInt(beforeStyle.height);return(pointerOffsetX>=checkboxPosition.left&&pointerOffsetX<=checkboxPosition.right&&pointerOffsetY>=checkboxPosition.top&&pointerOffsetY<=checkboxPosition.bottom);}
applyColorToListItem(color,mode){this.dependencies.split.splitSelection();const targetedNodes=this.dependencies.selection.getTargetedNodes();const listItems=new Set(targetedNodes.map((n)=>closestElement(n,"li")).filter(Boolean));if(!listItems.size||mode!=="color"||isColorGradient(color)){return;}
const cursors=this.dependencies.selection.preserveSelection();for(const listItem of listItems){if(this.dependencies.selection.areNodeContentsFullySelected(listItem)){for(const node of[listItem,...descendants(listItem).filter((n)=>isElement(n)&&closestElement(n,"LI")===listItem),]){const classesToRemove=[...node.classList].filter((cls)=>cls==="o_default_color"||TEXT_CLASSES_REGEX.test(cls));removeClass(node,...classesToRemove);if(node.style.color){removeStyle(node,"color");}}
if(color){this.dependencies.color.colorElement(listItem,color,mode);const sublists=childNodes(listItem).filter(isListElement);for(const list of sublists){list.classList.add("o_default_color");}}}else if(color===""&&(listItem.style.color||[...listItem.classList].some((cls)=>TEXT_CLASSES_REGEX.test(cls)))){const textNodes=targetedNodes.filter((n)=>isVisibleTextNode(n)&&closestElement(n,"li")===listItem);for(const node of textNodes){const font=this.document.createElement("font");font.classList.add("o_default_color");node.before(font);cursors.update(callbacksForCursorUpdate.before(node,font));font.append(node);cursors.update(callbacksForCursorUpdate.append(font,node));}}}
cursors.restore();}
applyFormatToListItem(formatName,{formatProps,applyStyle}={}){if(!["setFontSizeClassName","fontSize"].includes(formatName)){return;}
this.dependencies.split.splitSelection();const targetedNodes=this.dependencies.selection.getTargetedNodes();const listItems=new Set(targetedNodes.map((n)=>closestElement(n,"li")).filter(Boolean));if(!listItems.size){return false;}
const listsSet=new Set();const cursors=this.dependencies.selection.preserveSelection();for(const listItem of listItems){const hasOnlyBaseBlocks=[...descendants(listItem)].filter(isBlock).every((n)=>n.matches(`${baseContainerGlobalSelector}, ol, ul, li`));const hasExistingFontSize=FONT_SIZE_CLASSES.some((c)=>listItem.classList.contains(c))||listItem.style.fontSize;if(!hasOnlyBaseBlocks||(!applyStyle&&!hasExistingFontSize)){continue;}
if(this.dependencies.selection.areNodeContentsFullySelected(listItem)){for(const node of[listItem,...descendants(listItem).filter((n)=>isElement(n)&&closestElement(n,"LI")===listItem),]){removeClass(node,...FONT_SIZE_CLASSES,"o_default_font_size");if(node.style.fontSize){node.style.fontSize="";}}
if(applyStyle){if(formatName==="setFontSizeClassName"){listItem.classList.add(formatProps.className);}else if(formatName==="fontSize"){listItem.style.fontSize=formatProps.size;}
const sublists=childNodes(listItem).filter(isListElement);for(const list of sublists){list.classList.add("o_default_font_size");}}}else if(!applyStyle&&hasExistingFontSize){const textNodes=targetedNodes.filter((n)=>isVisibleTextNode(n)&&closestElement(n,"li")===listItem);for(const node of textNodes){const span=this.document.createElement("span");span.classList.add("o_default_font_size");node.before(span);cursors.update(callbacksForCursorUpdate.before(node,span));span.append(node);cursors.update(callbacksForCursorUpdate.append(span,node));}}
listsSet.add(listItem.parentElement);}
cursors.restore();for(const list of listsSet){this.adjustListPadding(list);}
return true;}
adjustListPadding(list){if(!isListElement(list)){return;}
list.style.removeProperty("padding-inline-start");if(list.classList.contains("o_checklist")){return;}
const largestMarker=list.children[Symbol.iterator]().map((li)=>{const markerWidth=parseFloat(this.window.getComputedStyle(li,"::marker").width);return isNaN(markerWidth)?0:markerWidth;}).reduce((accumulator,currentValue)=>Math.max(accumulator,currentValue));const largestMarkerPadding=Math.round(largestMarker)*(list.nodeName==="UL"?2:1);const defaultPadding=parseFloat(getHtmlStyle(this.document).fontSize)*2;if(largestMarkerPadding>defaultPadding){list.style.paddingInlineStart=`${largestMarkerPadding}px`;}}
adjustListPaddingOnDelete(){const selection=this.document.getSelection();if(!selection.isCollapsed||!selection.anchorNode){return;}
const listItem=closestElement(selection.anchorNode);if(isListItem(listItem)){this.adjustListPadding(listItem.parentElement);}}
updateToolbarButtons(){this.toolbarListSelectorKey.value++;}
getListSelectorButtons(){return listSelectorItems.filter((item)=>item.commandId!="toggleListCL"||this.config.allowChecklist).map((item)=>{const command=this.resources.user_commands.find((cmd)=>cmd.id===item.commandId);const button=composeToolbarButton(command,item);return{...pick(button,"id","icon","run","mode"),description:command.title,};});}}
return __exports;});;

/* /html_editor/static/src/main/list/list_selector.js */
odoo.define('@html_editor/main/list/list_selector',['@odoo/owl','@web/core/dropdown/dropdown','@html_editor/main/toolbar/toolbar','@html_editor/utils/dom_traversal','@html_editor/dropdown_autovisibility_hook','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const{Dropdown}=require("@web/core/dropdown/dropdown");const{toolbarButtonProps}=require("@html_editor/main/toolbar/toolbar");const{closestElement}=require("@html_editor/utils/dom_traversal");const{useDropdownAutoVisibility}=require("@html_editor/dropdown_autovisibility_hook");const{useChildRef}=require("@web/core/utils/hooks");const ListSelector=__exports.ListSelector=class ListSelector extends Component{static template="html_editor.ListSelector";static props={...toolbarButtonProps,getButtons:Function,getListMode:Function,key:Object,};static components={Dropdown};setup(){this.menuRef=useChildRef();useDropdownAutoVisibility(this.env.overlayState,this.menuRef);}
getActiveMode(){const{editableSelection:selection}=this.props.getSelection();const closestLI=closestElement(selection.anchorNode,"LI");return closestLI&&this.props.getListMode(closestLI.parentNode);}}
return __exports;});;

/* /html_editor/static/src/main/list/utils.js */
odoo.define('@html_editor/main/list/utils',['@html_editor/utils/dom','@html_editor/utils/dom_traversal','@html_editor/utils/formatting'],function(require){'use strict';let __exports={};const{unwrapContents}=require("@html_editor/utils/dom");const{closestElement,firstLeaf,lastLeaf}=require("@html_editor/utils/dom_traversal");const{getFontSizeOrClass}=require("@html_editor/utils/formatting");__exports.createList=createList;function createList(document,mode){const node=document.createElement(mode==="OL"?"OL":"UL");if(mode==="CL"){node.classList.add("o_checklist");}
return node;}
__exports.insertListAfter=insertListAfter;function insertListAfter(document,afterNode,mode,content=[]){const list=createList(document,mode);afterNode.after(list);const li=document.createElement("LI");li.append(...content);if(content.length===1&&content[0].nodeType===Node.ELEMENT_NODE){const firstLeafNode=firstLeaf(content[0]);const lastLeafNode=lastLeaf(content[0]);const firstClosestFont=closestElement(firstLeafNode,"font");const lastClosestFont=closestElement(lastLeafNode,"font");if(firstClosestFont&&lastClosestFont&&firstClosestFont===lastClosestFont){li.style.color=firstClosestFont.style.color;unwrapContents(firstClosestFont);}
const firstClosestSpan=closestElement(firstLeafNode,"span");const lastClosestSpan=closestElement(lastLeafNode,"span");let fontSizeStyle;if(firstClosestSpan&&lastClosestSpan&&firstClosestSpan===lastClosestSpan&&(fontSizeStyle=getFontSizeOrClass(firstClosestSpan))){if(fontSizeStyle.type==="font-size"){li.style.fontSize=fontSizeStyle.value;}else if(fontSizeStyle.type==="class"){li.classList.add(fontSizeStyle.value);}
unwrapContents(firstClosestSpan);}}
list.append(li);return list;}
__exports.compareListTypes=compareListTypes;function compareListTypes(a,b){if(!a||!b||a.tagName!==b.tagName){return false;}
if(a.classList.contains("o_checklist")!==b.classList.contains("o_checklist")){return false;}
if(a.tagName==="LI"){if(a.classList.contains("oe-nested")!==b.classList.contains("oe-nested")){return false;}
return compareListTypes(a.firstElementChild,b.firstElementChild);}
return true;}
__exports.isListItem=isListItem;function isListItem(node){return node.nodeName==="LI"&&!node.classList.contains("nav-item");}
return __exports;});;

/* /html_editor/static/src/main/local_overlay_plugin.js */
odoo.define('@html_editor/main/local_overlay_plugin',['@html_editor/plugin'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const LocalOverlayPlugin=__exports.LocalOverlayPlugin=class LocalOverlayPlugin extends Plugin{static id="localOverlay";static shared=["makeLocalOverlay"];setup(){this.localOverlayContainer=this.config.localOverlayContainers?.ref.el;this.localOverlays=new Set();}
makeLocalOverlay(containerId){const container=this.document.createElement("div");container.className=`oe-local-overlay`;container.setAttribute("data-oe-local-overlay-id",containerId);if(this.localOverlayContainer){this.localOverlayContainer.append(container);this.localOverlays.add(container);}
return container;}
destroy(){for(const container of this.localOverlays){container.remove();}
this.localOverlays.clear();super.destroy();}}
return __exports;});;

/* /html_editor/static/src/main/media/dblclick_image_preview_plugin.js */
odoo.define('@html_editor/main/media/dblclick_image_preview_plugin',['@html_editor/plugin'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const DoubleClickImagePreviewPlugin=__exports.DoubleClickImagePreviewPlugin=class DoubleClickImagePreviewPlugin extends Plugin{static id="dblclickImagePreview";static dependencies=["image"];setup(){this.addDomListener(this.editable,"dblclick",(e)=>{if(e.target.tagName==="IMG"){this.dependencies.image.previewImage();}});}}
return __exports;});;

/* /html_editor/static/src/main/media/file_plugin.js */
odoo.define('@html_editor/main/media/file_plugin',['@html_editor/main/media/media_dialog/document_selector','@html_editor/plugin','@html_editor/utils/resource','@web/core/l10n/translation','@html_editor/core/selection_plugin'],function(require){'use strict';let __exports={};const{DocumentSelector,renderStaticFileBox,}=require("@html_editor/main/media/media_dialog/document_selector");const{Plugin}=require("@html_editor/plugin");const{withSequence}=require("@html_editor/utils/resource");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const FilePlugin=__exports.FilePlugin=class FilePlugin extends Plugin{static id="file";static dependencies=["dom","history"];static defaultConfig={allowFile:true,};resources={user_commands:{id:"uploadFile",title:_t("Upload a file"),description:_t("Add a download box"),icon:"fa-upload",run:this.uploadAndInsertFiles.bind(this),isAvailable:(selection)=>this.isUploadCommandAvailable(selection)&&isHtmlContentSupported(selection),},powerbox_items:{categoryId:"media",commandId:"uploadFile",keywords:[_t("file"),_t("document")],},power_buttons:withSequence(5,{commandId:"uploadFile",description:_t("Upload a file"),}),unsplittable_node_predicates:(node)=>node.classList?.contains("o_file_box"),...(this.config.allowFile&&this.config.allowMediaDocuments&&{media_dialog_extra_tabs:{id:"DOCUMENTS",title:_t("Documents"),Component:this.componentForMediaDialog,sequence:15,},}),selectors_for_feff_providers:()=>".o_file_box",functional_empty_node_predicates:(node)=>node?.nodeName==="SPAN"&&node.classList.contains("o_file_box"),is_node_editable_predicates:(node)=>{if(node?.nodeName==="SPAN"&&node.classList.contains("o_file_box")){return false;}},};get recordInfo(){return this.config.getRecordInfo?.()||{};}
isUploadCommandAvailable(){return this.config.allowFile;}
get componentForMediaDialog(){return DocumentSelector;}
async uploadAndInsertFiles(){const attachments=await this.services.uploadLocalFiles.upload(this.recordInfo,{multiple:true,accessToken:true,});if(!attachments.length){this.editable.focus();return;}
if(this.config.onAttachmentChange){attachments.forEach(this.config.onAttachmentChange);}
const fileCards=attachments.map(this.renderDownloadBox.bind(this));fileCards.forEach(this.dependencies.dom.insert);this.dependencies.history.addStep();}
renderDownloadBox(attachment){const url=this.services.uploadLocalFiles.getURL(attachment,{download:true,unique:true,accessToken:true,});const{name:filename,mimetype,id}=attachment;return renderStaticFileBox(filename,mimetype,url,id);}}
return __exports;});;

/* /html_editor/static/src/main/media/icon_color_plugin.js */
odoo.define('@html_editor/main/media/icon_color_plugin',['@html_editor/plugin','@html_editor/utils/resource','@web/core/l10n/translation','@html_editor/main/font/color_selector','@html_editor/core/selection_plugin'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{withSequence}=require("@html_editor/utils/resource");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{ColorSelector}=require("@html_editor/main/font/color_selector");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const IconColorPlugin=__exports.IconColorPlugin=class IconColorPlugin extends Plugin{static id="iconColor";static dependencies=["icon","colorUi"];resources={toolbar_groups:withSequence(1,{id:"icon_color",namespaces:["icon"]}),toolbar_items:[{id:"icon_forecolor",groupId:"icon_color",description:_t("Select Font Color"),Component:ColorSelector,props:this.dependencies.colorUi.getPropsForColorSelector("foreground"),isAvailable:isHtmlContentSupported,},{id:"icon_backcolor",groupId:"icon_color",description:_t("Select Background Color"),Component:ColorSelector,props:this.dependencies.colorUi.getPropsForColorSelector("background"),isAvailable:isHtmlContentSupported,},],};}
return __exports;});;

/* /html_editor/static/src/main/media/icon_plugin.js */
odoo.define('@html_editor/main/media/icon_plugin',['@html_editor/utils/resource','@html_editor/plugin','@web/core/l10n/translation','@html_editor/main/media/media_dialog/media_dialog','@html_editor/core/selection_plugin','@html_editor/utils/dom_info'],function(require){'use strict';let __exports={};const{withSequence}=require("@html_editor/utils/resource");const{Plugin}=require("@html_editor/plugin");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{MediaDialog}=require("@html_editor/main/media/media_dialog/media_dialog");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const{ICON_SELECTOR,isElement}=require("@html_editor/utils/dom_info");const IconPlugin=__exports.IconPlugin=class IconPlugin extends Plugin{static id="icon";static dependencies=["history","selection","dialog"];toolbarNamespace="icon";resources={user_commands:[{id:"resizeIcon1",description:_t("Resize icon 1x"),run:()=>this.resizeIcon({size:"1"}),isAvailable:isHtmlContentSupported,},{id:"resizeIcon2",description:_t("Resize icon 2x"),run:()=>this.resizeIcon({size:"2"}),isAvailable:isHtmlContentSupported,},{id:"resizeIcon3",description:_t("Resize icon 3x"),run:()=>this.resizeIcon({size:"3"}),isAvailable:isHtmlContentSupported,},{id:"resizeIcon4",description:_t("Resize icon 4x"),run:()=>this.resizeIcon({size:"4"}),isAvailable:isHtmlContentSupported,},{id:"resizeIcon5",description:_t("Resize icon 5x"),run:()=>this.resizeIcon({size:"5"}),isAvailable:isHtmlContentSupported,},{id:"toggleSpinIcon",description:_t("Toggle icon spin"),icon:"fa-play",run:this.toggleSpinIcon.bind(this),isAvailable:isHtmlContentSupported,},{id:"replaceIcon",description:_t("Replace icon"),run:this.openIconDialog.bind(this),isAvailable:isHtmlContentSupported,},],toolbar_namespace_providers:[(targetedNodes)=>{if(targetedNodes.length&&targetedNodes.every((node)=>node.classList?.contains("fa")||node.parentElement.classList.contains("fa")||(node.querySelector?.(".fa")&&node.isContentEditable!==false))){return this.toolbarNamespace;}},],toolbar_groups:[withSequence(2,{id:"icon_size",namespaces:["icon"]}),withSequence(3,{id:"icon_spin",namespaces:["icon"]}),withSequence(3,{id:"icon_replace",namespaces:["icon"]}),],toolbar_items:[{id:"icon_size_1",groupId:"icon_size",commandId:"resizeIcon1",text:"1x",isActive:()=>this.hasIconSize("1"),},{id:"icon_size_2",groupId:"icon_size",commandId:"resizeIcon2",text:"2x",isActive:()=>this.hasIconSize("2"),},{id:"icon_size_3",groupId:"icon_size",commandId:"resizeIcon3",text:"3x",isActive:()=>this.hasIconSize("3"),},{id:"icon_size_4",groupId:"icon_size",commandId:"resizeIcon4",text:"4x",isActive:()=>this.hasIconSize("4"),},{id:"icon_size_5",groupId:"icon_size",commandId:"resizeIcon5",text:"5x",isActive:()=>this.hasIconSize("5"),},{id:"icon_spin",groupId:"icon_spin",commandId:"toggleSpinIcon",isActive:()=>this.hasSpinIcon(),},{id:"icon_replace",groupId:"icon_replace",commandId:"replaceIcon",text:_t("Replace"),},],};getTargetedIcon(){const targetedNodes=this.dependencies.selection.getTargetedNodes();return targetedNodes.find((node)=>isElement(node)&&node.matches(ICON_SELECTOR));}
resizeIcon({size}){const targetedIcon=this.getTargetedIcon();if(!targetedIcon){return;}
for(const classString of targetedIcon.classList){if(classString.match(/^fa-[2-5]x$/)){targetedIcon.classList.remove(classString);}}
if(size!=="1"){targetedIcon.classList.add(`fa-${size}x`);}
this.dependencies.history.addStep();}
toggleSpinIcon(){const selectedIcon=this.getTargetedIcon();if(!selectedIcon){return;}
selectedIcon.classList.toggle("fa-spin");this.dependencies.history.addStep();}
hasIconSize(size){const selectedIcon=this.getTargetedIcon();if(!selectedIcon){return;}
if(size==="1"){return![...selectedIcon.classList].some((classString)=>classString.match(/^fa-[2-5]x$/));}
return selectedIcon.classList.contains(`fa-${size}x`);}
hasSpinIcon(){const selectedIcon=this.getTargetedIcon();if(!selectedIcon){return;}
return selectedIcon.classList.contains("fa-spin");}
openIconDialog(){const selectedIcon=this.getTargetedIcon();if(!selectedIcon){return;}
this.dependencies.dialog.addDialog(MediaDialog,{visibleTabs:["ICONS"],media:selectedIcon,save:(el)=>this.onSaveIcon(el,selectedIcon),});}
onSaveIcon(icon,prevIcon){for(const attribute of icon.attributes){prevIcon.setAttribute(attribute.nodeName,attribute.nodeValue);}
this.dependencies.history.addStep();}}
return __exports;});;

/* /html_editor/static/src/main/media/image_crop.js */
odoo.define('@html_editor/main/media/image_crop',['@html_editor/utils/image_processing','@html_editor/main/media/image_plugin','@web/core/l10n/translation','@odoo/owl','@web/core/utils/hooks','@web/core/utils/scrolling'],function(require){'use strict';let __exports={};const{activateCropper,loadImage,loadImageInfo,cropperDataFieldsWithAspectRatio,}=require("@html_editor/utils/image_processing");const{IMAGE_SHAPES}=require("@html_editor/main/media/image_plugin");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{Component,useRef,onMounted,onWillDestroy,markup,useExternalListener,status,}=require("@odoo/owl");const{useService}=require("@web/core/utils/hooks");const{scrollTo,closestScrollableY}=require("@web/core/utils/scrolling");const cropperAspectRatios=__exports.cropperAspectRatios={"0/0":{label:_t("Flexible"),value:0},"16/9":{label:"16:9",value:16/9},"4/3":{label:"4:3",value:4/3},"1/1":{label:"1:1",value:1},"2/3":{label:"2:3",value:2/3},};const ImageCrop=__exports.ImageCrop=class ImageCrop extends Component{static template="html_editor.ImageCrop";static props={document:{validate:(p)=>p.nodeType===Node.DOCUMENT_NODE},media:{optional:true},onClose:{type:Function,optional:true},onSave:{type:Function,optional:true},};setup(){this.aspectRatios=cropperAspectRatios;this.notification=useService("notification");this.media=this.props.media;this.document=this.props.document;this.elRef=useRef("el");this.cropperWrapper=useRef("cropperWrapper");this.imageRef=useRef("imageRef");this.isCropperActive=false;useExternalListener(this.document,"mousedown",this.onDocumentMousedown,{capture:true,});useExternalListener(this.document,"keydown",this.onDocumentKeydown,{capture:true,});useExternalListener(this.document,"selectionchange",()=>{if(!this.props.media.isConnected){this.closeCropper();}},{capture:true});onMounted(()=>{this.hasModifiedImageClass=this.media.classList.contains("o_modified_image_to_save");if(this.hasModifiedImageClass){this.media.classList.remove("o_modified_image_to_save");}
this.show();});onWillDestroy(this.closeCropper);}
closeCropper(){if(!this.isCropperActive&&!this.forceClose){return;}
this.cropper?.destroy?.();this.media.setAttribute("src",this.initialSrc);if(this.hasModifiedImageClass&&!this.media.classList.contains("o_modified_image_to_save")){this.media.classList.add("o_modified_image_to_save");}
this.props?.onClose?.();this.isCropperActive=false;}
async reset(){if(this.cropper){this.cropper.reset();if(this.aspectRatio!=="0/0"){this.aspectRatio="0/0";this.cropper.setAspectRatio(cropperAspectRatios[this.aspectRatio].value);}
await this.save();}}
async show(){if(this.isCropperActive){return;}
const src=this.media.getAttribute("src");const data={...this.media.dataset};this.initialSrc=src;this.aspectRatio=data.aspectRatio||"0/0";Object.assign(this.media.dataset,await loadImageInfo(this.media));const isIllustration=/^\/(?:html|web)_editor\/shape\/illustration\//.test(this.media.dataset.originalSrc);this.uncroppable=false;if(this.media.dataset.originalSrc&&!isIllustration){this.originalSrc=this.media.dataset.originalSrc;this.originalId=this.media.dataset.originalId;}else{this.uncroppable=true;}
if(this.uncroppable){this.notification.add(markup(_t("This type of image is not supported for cropping.<br/>If you want to crop it, please first download it from the original source and upload it in Odoo.")),{title:_t("This image is an external image"),type:"warning",});this.forceClose=true;return this.closeCropper();}
await this.scrollToInvisibleImage();await loadImage(this.originalSrc,this.media);if(status(this)!=="mounted"){return;}
const cropperImage=this.imageRef.el;[cropperImage.style.width,cropperImage.style.height]=[this.media.width+"px",this.media.height+"px",];const sel=this.document.getSelection();sel&&sel.removeAllRanges();let offset=undefined;if(!this.media.getClientRects().length){offset={top:0,left:0};}else{const rect=this.media.getBoundingClientRect();offset={top:rect.top,left:rect.left,};}
offset.left+=parseInt(this.media.style.paddingLeft||0);offset.top+=parseInt(this.media.style.paddingRight||0);const frameElement=this.media.ownerDocument.defaultView.frameElement;if(frameElement){const frameRect=frameElement.getBoundingClientRect();offset.left+=frameRect.left;offset.top+=frameRect.top;}
this.cropperWrapper.el.style.left=`${offset.left}px`;this.cropperWrapper.el.style.top=`${offset.top}px`;await loadImage(this.originalSrc,cropperImage);if(status(this)!=="mounted"){return;}
this.cropper=await activateCropper(cropperImage,cropperAspectRatios[this.aspectRatio]?.value||0,this.media.dataset);this.cropper.element.addEventListener("ready",()=>{const cropperMove=this.cropperWrapper.el.querySelector(".cropper-face.cropper-move");for(const shape of IMAGE_SHAPES){if(this.media.classList.contains(shape)){cropperMove.classList.add(shape);}else{cropperMove.classList.remove(shape);}}});this.isCropperActive=true;}
async save(){const cropperData=this.getCropperData(this.cropper);this.props.onSave?.({aspectRatio:this.aspectRatio,...cropperData,});this.closeCropper();}
resetCropBox(){this.cropper.clear();this.cropper.crop();}
async scrollToInvisibleImage(){const rect=this.media.getBoundingClientRect();const viewportTop=this.document.documentElement.scrollTop||0;const viewportBottom=viewportTop+window.innerHeight;const scrollable=closestScrollableY(this.media);if(rect.top<viewportTop||viewportBottom-rect.bottom<100){await scrollTo(this.media,{behavior:"smooth",...(scrollable&&{scrollable}),});}}
onZoom(scale){this.cropper.zoom(scale);}
onReset(){this.cropper.reset();}
onRotate(degree){this.cropper.rotate(degree);}
onFlip(scaleDirection){const amount=this.cropper.getData()[scaleDirection]*-1;this.cropper[scaleDirection](amount);}
setAspectRatio(ratio){this.cropper.reset();this.aspectRatio=ratio;this.cropper.setAspectRatio(cropperAspectRatios[this.aspectRatio].value);}
onDocumentMousedown(ev){if(this.props.document.body.contains(ev.target)&&(this.elRef.el===ev.target||!this.elRef.el.contains(ev.target))){return this.closeCropper();}}
onDocumentKeydown(ev){if(ev.key==="Enter"){return this.save();}else if(ev.key==="Escape"){ev.stopImmediatePropagation();return this.closeCropper();}}
getCropperData(cropper){return Object.fromEntries(cropperDataFieldsWithAspectRatio.map((field)=>[field,cropper.getData()[field]]).filter(([,value])=>value));}
async onCropZoom(){await new Promise((res)=>setTimeout(res,0));this.resetCropBox();}}
return __exports;});;

/* /html_editor/static/src/main/media/image_crop_plugin.js */
odoo.define('@html_editor/main/media/image_crop_plugin',['@web/core/l10n/translation','@web/core/registry','@html_editor/plugin','@html_editor/main/media/image_crop','@html_editor/core/selection_plugin'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{registry}=require("@web/core/registry");const{Plugin}=require("@html_editor/plugin");const{ImageCrop}=require("@html_editor/main/media/image_crop");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const ImageCropPlugin=__exports.ImageCropPlugin=class ImageCropPlugin extends Plugin{static id="imageCrop";static dependencies=["selection","history","imagePostProcess"];static shared=["openCropImage"];resources={user_commands:[{id:"cropImage",run:this.openCropImage.bind(this),description:_t("Crop image"),icon:"fa-crop",isAvailable:isHtmlContentSupported,},],toolbar_items:[{id:"image_crop",commandId:"cropImage",groupId:"image_modifiers",},],};getTargetedImage(){const targetedNodes=this.dependencies.selection.getTargetedNodes();return targetedNodes.find((node)=>node.tagName==="IMG");}
async openCropImage(targetedImg,imageCropProps={}){targetedImg=targetedImg||this.getTargetedImage();if(!targetedImg){return;}
return registry.category("main_components").add("ImageCropping",{Component:ImageCrop,props:{media:targetedImg,onSave:async(newDataset)=>{const updateImageAttributes=await this.dependencies.imagePostProcess.processImage({img:targetedImg,newDataset,});updateImageAttributes();this.dependencies.history.addStep();},document:this.document,...imageCropProps,onClose:()=>{registry.category("main_components").remove("ImageCropping");imageCropProps.onClose?.();},},});}}
return __exports;});;

/* /html_editor/static/src/main/media/image_description.js */
odoo.define('@html_editor/main/media/image_description',['@odoo/owl','@web/core/dialog/dialog','@html_editor/main/toolbar/toolbar','@web/core/hotkeys/hotkey_hook'],function(require){'use strict';let __exports={};const{Component,useEffect,useRef}=require("@odoo/owl");const{Dialog}=require("@web/core/dialog/dialog");const{toolbarButtonProps}=require("@html_editor/main/toolbar/toolbar");const{useHotkey}=require("@web/core/hotkeys/hotkey_hook");const ImageDescription=__exports.ImageDescription=class ImageDescription extends Component{static components={Dialog};static props={...toolbarButtonProps,openImageDescriptionPopover:Function,};static template="html_editor.ImageDescription";}
const ImageDescriptionPopover=__exports.ImageDescriptionPopover=class ImageDescriptionPopover extends Component{static props={close:Function,description:{type:String,optional:true,},onConfirm:Function,tooltip:{type:String,optional:true,},};static template="html_editor.ImageDescriptionPopover";setup(){this.state={description:this.props.description,tooltip:this.props.tooltip,};this.inputRef=useRef("description");useEffect((el)=>el?.focus(),()=>[this.inputRef.el]);useHotkey("escape",()=>this.props.close());}
onSave(){this.props.onConfirm(this.state.description||"",this.state.tooltip||"");this.props.close();}}
return __exports;});;

/* /html_editor/static/src/main/media/image_plugin.js */
odoo.define('@html_editor/main/media/image_plugin',['@html_editor/plugin','@web/core/l10n/translation','@html_editor/utils/url','@html_editor/main/media/image_description','@html_editor/main/media/image_toolbar_dropdown','@web/core/file_viewer/file_viewer_hook','@html_editor/core/selection_plugin','@html_editor/utils/position','@html_editor/utils/resource','@html_editor/main/media/image_transform_button','@html_editor/utils/selection','@html_editor/utils/blocks','@html_editor/utils/dom','@odoo/owl'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{isImageUrl}=require("@html_editor/utils/url");const{ImageDescription,ImageDescriptionPopover}=require("@html_editor/main/media/image_description");const{ImageToolbarDropdown}=require("@html_editor/main/media/image_toolbar_dropdown");const{createFileViewer}=require("@web/core/file_viewer/file_viewer_hook");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const{boundariesOut}=require("@html_editor/utils/position");const{withSequence}=require("@html_editor/utils/resource");const{ImageTransformButton}=require("@html_editor/main/media/image_transform_button");const{callbacksForCursorUpdate}=require("@html_editor/utils/selection");const{closestBlock}=require("@html_editor/utils/blocks");const{fillEmpty}=require("@html_editor/utils/dom");const{reactive}=require("@odoo/owl");function hasShape(imagePlugin,shapeName){return()=>imagePlugin.isSelectionShaped(shapeName);}
const IMAGE_SHAPES=__exports.IMAGE_SHAPES=["rounded","rounded-circle","shadow","img-thumbnail"];const IMAGE_PADDING=[{name:"None",value:0},{name:"Small",value:1},{name:"Medium",value:2},{name:"Large",value:3},{name:"XL",value:5},];const IMAGE_SIZE=[{name:"Default",value:""},{name:"100%",value:"100%"},{name:"50%",value:"50%"},{name:"25%",value:"25%"},];const ImagePlugin=__exports.ImagePlugin=class ImagePlugin extends Plugin{static id="image";static dependencies=["history","dom","selection","overlay"];static shared=["getTargetedImage","previewImage","resetImageTransformation"];static defaultConfig={allowImageTransform:true};toolbarNamespace="image";resources={user_commands:[{id:"deleteImage",description:_t("Remove (DELETE) image"),icon:"fa-trash text-danger",run:this.deleteImage.bind(this),isAvailable:isHtmlContentSupported,},{id:"previewImage",description:_t("Preview image"),icon:"fa-search-plus",run:this.previewImage.bind(this),isAvailable:isHtmlContentSupported,},{id:"setImageShapeRounded",description:_t("Set shape: Rounded"),icon:"fa-square",run:()=>this.setImageShape("rounded",{excludeClasses:["rounded-circle"]}),isAvailable:isHtmlContentSupported,},{id:"setImageShapeCircle",description:_t("Set shape: Circle"),icon:"fa-circle-o",run:()=>this.setImageShape("rounded-circle",{excludeClasses:["rounded"]}),isAvailable:isHtmlContentSupported,},{id:"setImageShapeShadow",description:_t("Set shape: Shadow"),icon:"fa-sun-o",run:()=>this.setImageShape("shadow"),isAvailable:isHtmlContentSupported,},{id:"setImageShapeThumbnail",description:_t("Set shape: Thumbnail"),icon:"fa-picture-o",run:()=>this.setImageShape("img-thumbnail"),isAvailable:isHtmlContentSupported,},{id:"resizeImage",run:this.resizeImage.bind(this),isAvailable:isHtmlContentSupported,},],toolbar_namespace_providers:[(targetedNodes)=>{if(targetedNodes.length&&targetedNodes.every((node)=>node.nodeName==="IMG")){return this.toolbarNamespace;}},],toolbar_groups:[withSequence(23,{id:"image_preview",namespaces:["image"]}),withSequence(24,{id:"image_description",namespaces:["image"]}),withSequence(25,{id:"image_shape",namespaces:["image"]}),withSequence(26,{id:"image_padding",namespaces:["image"]}),withSequence(26,{id:"image_size",namespaces:["image"]}),withSequence(26,{id:"image_modifiers",namespaces:["image"]}),withSequence(32,{id:"image_delete",namespaces:["image"]}),],toolbar_items:[{id:"image_preview",groupId:"image_preview",commandId:"previewImage",},{id:"image_description",description:_t("Edit media description"),groupId:"image_description",Component:ImageDescription,props:{openImageDescriptionPopover:this.openImageDescriptionPopover.bind(this),},isAvailable:isHtmlContentSupported,},{id:"shape_rounded",groupId:"image_shape",commandId:"setImageShapeRounded",isActive:hasShape(this,"rounded"),},{id:"shape_circle",groupId:"image_shape",commandId:"setImageShapeCircle",isActive:hasShape(this,"rounded-circle"),},{id:"shape_shadow",groupId:"image_shape",commandId:"setImageShapeShadow",isActive:hasShape(this,"shadow"),},{id:"shape_thumbnail",groupId:"image_shape",commandId:"setImageShapeThumbnail",isActive:hasShape(this,"img-thumbnail"),},{id:"image_padding",groupId:"image_padding",description:_t("Set image padding"),Component:ImageToolbarDropdown,props:{name:"image_padding",icon:"html_editor.ImagePaddingIcon",items:IMAGE_PADDING,onSelected:(item)=>{this.setImagePadding({size:item.value});},},isAvailable:isHtmlContentSupported,},{id:"image_size",groupId:"image_size",description:_t("Resize image"),Component:ImageToolbarDropdown,props:{name:"image_size",getDisplay:()=>this.imageSize,items:IMAGE_SIZE,onSelected:(item)=>{this.resizeImage({size:item.value});this.updateImageParams();},},isAvailable:(selection)=>isHtmlContentSupported(selection)&&(this.config.allowImageResize??true),},{id:"image_transform",groupId:"image_modifiers",description:_t("Transform the picture (click twice to reset transformation)"),Component:ImageTransformButton,props:this.getImageTransformProps(),isAvailable:(selection)=>this.config.allowImageTransform&&isHtmlContentSupported(selection),},{id:"image_delete",groupId:"image_delete",commandId:"deleteImage",},],selectionchange_handlers:this.updateImageParams.bind(this),post_undo_handlers:this.updateImageParams.bind(this),post_redo_handlers:this.updateImageParams.bind(this),paste_media_url_command_providers:this.getCommandForImageUrlPaste.bind(this),};setup(){this.imageSize=reactive({displayName:"Default"});this.addDomListener(this.editable,"pointerdown",(e)=>{const selection=this.dependencies.selection.getEditableSelection();if(selection.isCollapsed&&e.target.tagName==="IMG"){this.setSelectionAroundImage(e.target);}});this.addDomListener(this.editable,"pointerup",(e)=>{if(e.target.tagName==="IMG"){this.setSelectionAroundImage(e.target);}});this.fileViewer=createFileViewer();this.overlay=this.dependencies.overlay.createOverlay(ImageDescriptionPopover,{className:"popover",});}
destroy(){super.destroy();}
get imageSizeName(){const targetedImg=this.getTargetedImage();if(!targetedImg){return"Default";}
return targetedImg.style.width||"Default";}
setImagePadding({size}={}){const targetedImg=this.getTargetedImage();if(!targetedImg){return;}
for(const classString of targetedImg.classList){if(classString.match(/^p-[0-9]$/)){targetedImg.classList.remove(classString);}}
targetedImg.classList.add(`p-${size}`);this.dependencies.history.addStep();}
resizeImage({size}={}){const targetedImg=this.getTargetedImage();if(!targetedImg){return;}
targetedImg.style.width=size||"";this.dependencies.history.addStep();}
setImageShape(className,{excludeClasses=[]}={}){const targetedImg=this.getTargetedImage();if(!targetedImg){return;}
for(const classString of excludeClasses){if(targetedImg.classList.contains(classString)){targetedImg.classList.remove(classString);}}
targetedImg.classList.toggle(className);this.dependencies.history.addStep();}
previewImage(){const targetedImg=this.getTargetedImage();if(!targetedImg){return;}
let imageName;this.getResource("image_name_predicates").find((p)=>{imageName=p(targetedImg);return imageName;});const fileModel={isImage:true,isViewable:true,name:imageName||targetedImg.src,defaultSource:targetedImg.src,downloadUrl:targetedImg.src,};this.document.getSelection().collapseToEnd();this.fileViewer.open(fileModel);}
deleteImage(){const targetedImg=this.getTargetedImage();if(targetedImg){if(this.delegateTo("delete_image_overrides",targetedImg)){return;}
const cursors=this.dependencies.selection.preserveSelection();cursors.update(callbacksForCursorUpdate.remove(targetedImg));const parentEl=closestBlock(targetedImg);targetedImg.remove();cursors.restore();fillEmpty(parentEl);this.dependencies.history.addStep();}}
getTargetedImage(){const targetedNodes=this.dependencies.selection.getTargetedNodes();return targetedNodes.find((node)=>node.tagName==="IMG");}
hasImageSize(size){const targetedImg=this.getTargetedImage();return targetedImg?.style?.width===size;}
isSelectionShaped(shape){const targetedNodes=this.dependencies.selection.getTargetedNodes().filter((n)=>n.tagName==="IMG"&&n.classList.contains(shape));return targetedNodes.length>0;}
getImageAttribute(attributeName){const targetedNodes=this.dependencies.selection.getTargetedNodes();const targetedImg=targetedNodes.find((node)=>node.tagName==="IMG");return targetedImg.getAttribute(attributeName)||undefined;}
getCommandForImageUrlPaste(url){if(isImageUrl(url)){return{title:_t("Embed Image"),description:_t("Embed the image in the document."),icon:"fa-image",run:()=>{const img=this.document.createElement("IMG");img.setAttribute("src",url);this.dependencies.dom.insert(img);this.dependencies.history.addStep();},};}}
updateImageDescription({description,tooltip}={}){const targetedImg=this.getTargetedImage();if(!targetedImg){return;}
targetedImg.setAttribute("alt",description);targetedImg.setAttribute("title",tooltip);this.dependencies.history.addStep();}
resetImageTransformation(image){image.setAttribute("style",(image.getAttribute("style")||"").replace(/[^;]*transform[\w:]*;?/g,""));image.style.removeProperty("width");image.style.removeProperty("height");this.dependencies.history.addStep();}
getImageTransformProps(){return{id:"image_transform",icon:"fa-object-ungroup",title:_t("Transform the picture (click twice to reset transformation)"),getTargetedImage:this.getTargetedImage.bind(this),resetImageTransformation:this.resetImageTransformation.bind(this),addStep:this.dependencies.history.addStep.bind(this),document:this.document,editable:this.editable,activeTitle:_t("Click again to reset transformation"),};}
updateImageParams(){this.imageSize.displayName=this.imageSizeName;}
openImageDescriptionPopover(){const image=this.getTargetedImage();if(image){this.overlay.open({target:image,props:{close:()=>this.overlay.close(),description:this.getImageAttribute("alt"),tooltip:this.getImageAttribute("title"),onConfirm:(description,tooltip)=>{this.updateImageDescription({description,tooltip});},},});}}
setSelectionAroundImage(img){const[anchorNode,anchorOffset,focusNode,focusOffset]=boundariesOut(img);this.dependencies.selection.setSelection({anchorNode,anchorOffset,focusNode,focusOffset,});this.dependencies.selection.focusEditable();}}
return __exports;});;

/* /html_editor/static/src/main/media/image_post_process_plugin.js */
odoo.define('@html_editor/main/media/image_post_process_plugin',['@html_editor/utils/image_processing','@html_editor/plugin','@html_editor/utils/perspective_utils'],function(require){'use strict';let __exports={};const{activateCropper,getAspectRatio,getDataURLBinarySize,getImageSizeFromCache,isGif,isWebGLEnabled,loadImage,loadImageDataURL,loadImageInfo,}=require("@html_editor/utils/image_processing");const{Plugin}=require("@html_editor/plugin");const{getAffineApproximation,getProjective}=require("@html_editor/utils/perspective_utils");const DEFAULT_IMAGE_QUALITY=__exports.DEFAULT_IMAGE_QUALITY="92";const ImagePostProcessPlugin=__exports.ImagePostProcessPlugin=class ImagePostProcessPlugin extends Plugin{static id="imagePostProcess";static dependencies=["style"];static shared=["processImage","getProcessedImageSize"];async _processImage({img,newDataset={},onImageInfoLoaded}){const processContext={};if(!newDataset.originalSrc||!newDataset.mimetypeBeforeConversion){Object.assign(newDataset,await loadImageInfo(img));}
if(onImageInfoLoaded){if(await onImageInfoLoaded(newDataset)){return;}}
for(const cb of this.getResource("process_image_warmup_handlers")){const addedContext=await cb(img,newDataset);if(addedContext){if(addedContext.newDataset){Object.assign(newDataset,addedContext.newDataset);}
Object.assign(processContext,addedContext);}}
const data=getImageTransformationData({...img.dataset,...newDataset});const{mimetypeBeforeConversion,formatMimetype,width,height,resizeWidth,filter,glFilter,filterOptions,aspectRatio,quality,}=data;const{postProcessCroppedCanvas,perspective,getHeight}=processContext;const originalImg=await loadImage(data.originalSrc);const originalSrc=originalImg.getAttribute("src");if(shouldPreventGifTransformation(data)){const[postUrl,postDataset]=await this.postProcessImage(await loadImageDataURL(originalSrc),newDataset,processContext);return{url:postUrl,newDataset:postDataset};}
const container=document.createElement("div");container.appendChild(originalImg);const cropper=await activateCropper(originalImg,aspectRatio,data);const croppedCanvas=cropper.getCroppedCanvas(width,height);cropper.destroy();const processedCanvas=(await postProcessCroppedCanvas?.(croppedCanvas))||croppedCanvas;const canvas=document.createElement("canvas");canvas.width=resizeWidth||processedCanvas.width;canvas.height=getHeight?getHeight(canvas):(processedCanvas.height*canvas.width)/processedCanvas.width;const ctx=canvas.getContext("2d");ctx.imageSmoothingQuality="high";ctx.mozImageSmoothingEnabled=true;ctx.webkitImageSmoothingEnabled=true;ctx.msImageSmoothingEnabled=true;ctx.imageSmoothingEnabled=true;if(perspective){const points=JSON.parse(perspective);const divisions=10;const w=processedCanvas.width,h=processedCanvas.height;const project=getProjective(w,h,[[(canvas.width/100)*points[0][0],(canvas.height/100)*points[0][1]],[(canvas.width/100)*points[1][0],(canvas.height/100)*points[1][1]],[(canvas.width/100)*points[2][0],(canvas.height/100)*points[2][1]],[(canvas.width/100)*points[3][0],(canvas.height/100)*points[3][1]],]);for(let i=0;i<divisions;i++){for(let j=0;j<divisions;j++){const[dx,dy]=[w/divisions,h/divisions];const upper={origin:[i*dx,j*dy],sides:[dx,dy],flange:0.1,overlap:0,};const lower={origin:[i*dx+dx,j*dy+dy],sides:[-dx,-dy],flange:0,overlap:0.1,};for(const{origin,sides,flange,overlap}of[upper,lower]){const[[a,c,e],[b,d,f]]=getAffineApproximation(project,[origin,[origin[0]+sides[0],origin[1]],[origin[0],origin[1]+sides[1]],]);const ox=(i!==divisions?overlap*sides[0]:0)+flange*sides[0];const oy=(j!==divisions?overlap*sides[1]:0)+flange*sides[1];origin[0]+=flange*sides[0];origin[1]+=flange*sides[1];sides[0]-=flange*sides[0];sides[1]-=flange*sides[1];ctx.save();ctx.setTransform(a,b,c,d,e,f);ctx.beginPath();ctx.moveTo(origin[0]-ox,origin[1]-oy);ctx.lineTo(origin[0]+sides[0],origin[1]-oy);ctx.lineTo(origin[0]+sides[0],origin[1]);ctx.lineTo(origin[0],origin[1]+sides[1]);ctx.lineTo(origin[0]-ox,origin[1]+sides[1]);ctx.closePath();ctx.clip();ctx.drawImage(processedCanvas,0,0);ctx.restore();}}}}else{ctx.drawImage(processedCanvas,0,0,processedCanvas.width,processedCanvas.height,0,0,canvas.width,canvas.height);}
const canUseWebGL=glFilter&&isWebGLEnabled()&&window.WebGLImageFilter;if(canUseWebGL){const glf=new window.WebGLImageFilter();const cv=document.createElement("canvas");cv.width=canvas.width;cv.height=canvas.height;applyAll=_applyAll.bind(null,canvas);glFilters[glFilter](glf,cv,filterOptions);const filtered=glf.apply(canvas);ctx.drawImage(filtered,0,0,filtered.width,filtered.height,0,0,canvas.width,canvas.height);}
ctx.fillStyle=filter||"#0000";ctx.fillRect(0,0,canvas.width,canvas.height);newDataset.mimetype=formatMimetype||mimetypeBeforeConversion;const dataURL=canvas.toDataURL(newDataset.mimetype,quality/100);const newSize=getDataURLBinarySize(dataURL);const originalSize=getImageSizeFromCache(originalSrc);const isChanged=!!perspective||!!glFilter||originalImg.width!==canvas.width||originalImg.height!==canvas.height||originalImg.width!==processedCanvas.width||originalImg.height!==processedCanvas.height;let url=isChanged||originalSize>=newSize?dataURL:await loadImageDataURL(originalSrc);[url,newDataset]=await this.postProcessImage(url,newDataset,processContext);return{url,newDataset};}
async processImage(params){const processed=await this._processImage(params);if(!processed){return()=>{};}
return()=>this.updateImageAttributes(params.img,processed.url,processed.newDataset);}
async getProcessedImageSize(img){const processed=await this._processImage({img});return getDataURLBinarySize(processed.url);}
async postProcessImage(url,newDataset,processContext){for(const cb of this.getResource("process_image_post_handlers")){const[newUrl,handlerDataset]=(await cb(url,newDataset,processContext))||[];url=newUrl||url;newDataset=handlerDataset||newDataset;}
return[url,newDataset];}
updateImageAttributes(el,url,newDataset){el.classList.add("o_modified_image_to_save");if(el.tagName==="IMG"){el.setAttribute("src",url);}else{this.dependencies.style.setBackgroundImageUrl(el,url);}
for(const key in newDataset){const value=newDataset[key];if(value){el.dataset[key]=value;}else{delete el.dataset[key];}}
this.dispatchTo("on_image_updated_handlers",{imageEl:el});}}
__exports.getImageTransformationData=getImageTransformationData;function getImageTransformationData(dataset){const data=Object.assign({glFilter:"",filter:"#0000",forceModification:false,},dataset);for(const key of["width","height","resizeWidth"]){data[key]=parseFloat(data[key]);}
if(!("quality"in data)){data.quality=DEFAULT_IMAGE_QUALITY;}
data.aspectRatio=data.aspectRatio?getAspectRatio(data.aspectRatio):0;return data;}
function shouldTransformImage(data){return(data.perspective||data.glFilter||data.width||data.height||data.resizeWidth||data.aspectRatio);}
__exports.shouldPreventGifTransformation=shouldPreventGifTransformation;function shouldPreventGifTransformation(data){return isGif(data.mimetypeBeforeConversion)&&!shouldTransformImage(data);}
const defaultImageFilterOptions=__exports.defaultImageFilterOptions={blend:"normal",filterColor:"",blur:"0",desaturateLuminance:"0",saturation:"0",contrast:"0",brightness:"0",sepia:"0",};const _applyAll=(result,filter,filters)=>{filters.forEach((f)=>{if(f[0]==="blend"){const cv=f[1];const ctx=result.getContext("2d");ctx.globalCompositeOperation=f[2];ctx.globalAlpha=f[3];ctx.drawImage(cv,0,0);ctx.globalCompositeOperation="source-over";ctx.globalAlpha=1.0;}else{filter.addFilter(...f);}});};let applyAll;const glFilters={blur:(filter)=>filter.addFilter("blur",10),1977:(filter,cv)=>{const ctx=cv.getContext("2d");ctx.fillStyle="rgb(243, 106, 188)";ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[["blend",cv,"screen",0.3],["brightness",0.1],["contrast",0.1],["saturation",0.3],]);},aden:(filter,cv)=>{const ctx=cv.getContext("2d");ctx.fillStyle="rgb(66, 10, 14)";ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[["blend",cv,"darken",0.2],["brightness",0.2],["contrast",-0.1],["saturation",-0.15],["hue",20],]);},brannan:(filter,cv)=>{const ctx=cv.getContext("2d");ctx.fillStyle="rgb(161, 44, 191)";ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[["blend",cv,"lighten",0.31],["sepia",0.5],["contrast",0.4],]);},earlybird:(filter,cv)=>{const ctx=cv.getContext("2d");const gradient=ctx.createRadialGradient(cv.width/2,cv.height/2,0,cv.width/2,cv.height/2,Math.hypot(cv.width,cv.height)/2);gradient.addColorStop(0.2,"#D0BA8E");gradient.addColorStop(1,"#1D0210");ctx.fillStyle=gradient;ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[["blend",cv,"overlay",0.2],["sepia",0.2],["contrast",-0.1],]);},inkwell:(filter,cv)=>{applyAll(filter,[["sepia",0.3],["brightness",0.1],["contrast",-0.1],["desaturateLuminance"],]);},maven:(filter,cv)=>{applyAll(filter,[["sepia",0.25],["brightness",-0.05],["contrast",-0.05],["saturation",0.5],]);},toaster:(filter,cv)=>{const ctx=cv.getContext("2d");const gradient=ctx.createRadialGradient(cv.width/2,cv.height/2,0,cv.width/2,cv.height/2,Math.hypot(cv.width,cv.height)/2);gradient.addColorStop(0,"#0F4E80");gradient.addColorStop(1,"#3B003B");ctx.fillStyle=gradient;ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[["blend",cv,"screen",0.5],["brightness",-0.1],["contrast",0.5],]);},walden:(filter,cv)=>{const ctx=cv.getContext("2d");ctx.fillStyle="#CC4400";ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[["blend",cv,"screen",0.3],["sepia",0.3],["brightness",0.1],["saturation",0.6],["hue",350],]);},valencia:(filter,cv)=>{const ctx=cv.getContext("2d");ctx.fillStyle="#3A0339";ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[["blend",cv,"exclusion",0.5],["sepia",0.08],["brightness",0.08],["contrast",0.08],]);},xpro:(filter,cv)=>{const ctx=cv.getContext("2d");const gradient=ctx.createRadialGradient(cv.width/2,cv.height/2,0,cv.width/2,cv.height/2,Math.hypot(cv.width,cv.height)/2);gradient.addColorStop(0.4,"#E0E7E6");gradient.addColorStop(1,"#2B2AA1");ctx.fillStyle=gradient;ctx.fillRect(0,0,cv.width,cv.height);applyAll(filter,[["blend",cv,"color-burn",0.7],["sepia",0.3],]);},custom:(filter,cv,filterOptions)=>{const options=Object.assign(defaultImageFilterOptions,JSON.parse(filterOptions||"{}"));const filters=[];if(options.filterColor){const ctx=cv.getContext("2d");ctx.fillStyle=options.filterColor;ctx.fillRect(0,0,cv.width,cv.height);filters.push(["blend",cv,options.blend,1]);}
delete options.blend;delete options.filterColor;filters.push(...Object.entries(options).map(([filter,amount])=>[filter,parseInt(amount)/100]));applyAll(filter,filters);},};return __exports;});;

/* /html_editor/static/src/main/media/image_save_plugin.js */
odoo.define('@html_editor/main/media/image_save_plugin',['@html_editor/plugin','@html_editor/utils/image','@web/core/network/rpc'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{backgroundImageCssToParts,backgroundImagePartsToCss,getImageSrc,}=require("@html_editor/utils/image");const{rpc}=require("@web/core/network/rpc");const ImageSavePlugin=__exports.ImageSavePlugin=class ImageSavePlugin extends Plugin{static id="imageSave";static shared=["savePendingImages"];resources={before_save_handlers:this.savePendingImages.bind(this),...(this.config.dropImageAsAttachment&&{added_image_handlers:(img)=>img.classList.add("o_b64_image_to_save"),}),};async savePendingImages(editableEl=this.editable){const getClosestSavable=(el)=>{for(const provider of this.getResource("closest_savable_providers")){const value=provider(el);if(value){return value;}}};const oldSrcToNewSrcMap=new Map();const b64Proms=[...editableEl.querySelectorAll(".o_b64_image_to_save")].map(async(el)=>{const{resModel,resId}=this.getRecordInfo(getClosestSavable(el));const oldSrc=el.getAttribute("src");await this.saveB64Image(el,resModel,resId);oldSrcToNewSrcMap.set(oldSrc,el.getAttribute("src"));});const modifiedProms=[...editableEl.querySelectorAll(".o_modified_image_to_save")].map(async(el)=>{const{resModel,resId}=this.getRecordInfo(getClosestSavable(el));const oldSrc=el.getAttribute("src");await this.saveModifiedImage(el,resModel,resId);oldSrcToNewSrcMap.set(oldSrc,el.getAttribute("src"));});const proms=[...b64Proms,...modifiedProms];const hasChange=!!proms.length;if(hasChange){await Promise.all(proms);}
return hasChange?oldSrcToNewSrcMap:undefined;}
createAttachment({el,imageData,resModel,resId}){return rpc("/html_editor/attachment/add_data",{name:el.dataset.fileName||"",data:imageData,is_image:true,res_model:resModel,res_id:resId,});}
async saveB64Image(el,resModel,resId){const imageData=el.getAttribute("src").split("base64,")[1];if(!imageData){el.classList.remove("o_b64_image_to_save");return;}
const attachment=await this.createAttachment({el,imageData,resId,resModel,});if(!attachment){return;}
if(attachment.mimetype==="image/webp"){el.classList.add("o_modified_image_to_save");el.dataset.originalId=attachment.id;el.dataset.mimetype=attachment.mimetype;el.dataset.fileName=attachment.name;return this.saveModifiedImage(el,resModel,resId);}else{let src=attachment.image_src;if(!attachment.public){let accessToken=attachment.access_token;if(!accessToken){[accessToken]=await this.services.orm.call("ir.attachment","generate_access_token",[attachment.id]);}
src+=`?access_token=${encodeURIComponent(accessToken)}`;}
el.setAttribute("src",src);}
el.classList.remove("o_b64_image_to_save");}
async saveModifiedImage(el,resModel,resId){const isBackground=!el.matches("img");let altData=undefined;const isImageField=!!el.closest("[data-oe-type=image]");if(el.dataset.mimetype==="image/webp"&&isImageField){altData={};const image=document.createElement("img");image.src=getImageSrc(el);await new Promise((resolve)=>image.addEventListener("load",resolve));const originalSize=Math.max(image.width,image.height);const smallerSizes=[1024,512,256,128].filter((size)=>size<originalSize);for(const size of[originalSize,...smallerSizes]){const ratio=size/originalSize;const canvas=document.createElement("canvas");canvas.width=image.width*ratio;canvas.height=image.height*ratio;const ctx=canvas.getContext("2d");ctx.fillStyle="rgb(255, 255, 255)";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.drawImage(image,0,0,image.width,image.height,0,0,canvas.width,canvas.height);altData[size]={"image/jpeg":canvas.toDataURL("image/jpeg").split(",")[1],};if(size!==originalSize){altData[size]["image/webp"]=canvas.toDataURL("image/webp").split(",")[1];}}}
const newAttachmentSrc=await rpc(`/html_editor/modify_image/${encodeURIComponent(el.dataset.originalId)}`,{res_model:resModel,res_id:parseInt(resId),data:getImageSrc(el).split(",")[1],alt_data:altData,mimetype:isBackground?el.dataset.mimetype:el.getAttribute("src").split(":")[1].split(";")[0],name:el.dataset.fileName?el.dataset.fileName:null,});el.classList.remove("o_modified_image_to_save");if(isBackground){const parts=backgroundImageCssToParts(el.style["background-image"]);parts.url=`url('${newAttachmentSrc}')`;const combined=backgroundImagePartsToCss(parts);el.style["background-image"]=combined;}else{el.setAttribute("src",newAttachmentSrc);}
this.dispatchTo("on_image_saved_handlers",{imageEl:el});}
getRecordInfo(editableEl=null){return this.config.getRecordInfo?this.config.getRecordInfo(editableEl):{};}}
return __exports;});;

/* /html_editor/static/src/main/media/image_toolbar_dropdown.js */
odoo.define('@html_editor/main/media/image_toolbar_dropdown',['@odoo/owl','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_item','@html_editor/main/toolbar/toolbar','@web/core/utils/hooks','@html_editor/dropdown_autovisibility_hook'],function(require){'use strict';let __exports={};const{Component,useState}=require("@odoo/owl");const{Dropdown}=require("@web/core/dropdown/dropdown");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{toolbarButtonProps}=require("@html_editor/main/toolbar/toolbar");const{useChildRef}=require("@web/core/utils/hooks");const{useDropdownAutoVisibility}=require("@html_editor/dropdown_autovisibility_hook");const ImageToolbarDropdown=__exports.ImageToolbarDropdown=class ImageToolbarDropdown extends Component{static components={Dropdown,DropdownItem};static props={...toolbarButtonProps,name:String,icon:{type:String,optional:true},onSelected:Function,items:Array,getDisplay:{type:Function,optional:true},};static template="html_editor.ImageToolbarDropdown";setup(){this.items=this.props.items;if(this.props.getDisplay){this.state=useState(this.props.getDisplay());}
this.menuRef=useChildRef();useDropdownAutoVisibility(this.env.overlayState,this.menuRef);}
onSelected(item){this.props.onSelected(item);}}
return __exports;});;

/* /html_editor/static/src/main/media/image_transform_button.js */
odoo.define('@html_editor/main/media/image_transform_button',['@odoo/owl','@html_editor/main/toolbar/toolbar','@web/core/registry','@html_editor/main/media/image_transformation'],function(require){'use strict';let __exports={};const{Component,useExternalListener,useState}=require("@odoo/owl");const{toolbarButtonProps}=require("@html_editor/main/toolbar/toolbar");const{registry}=require("@web/core/registry");const{ImageTransformation}=require("@html_editor/main/media/image_transformation");__exports.useImageTransform=useImageTransform;function useImageTransform({document,closeImageTransformation,buttonSelector}){let pointerDownInsideTransform=false;useExternalListener(document,"pointerdown",(ev)=>{if(isNodeInsideTransform(ev.target)){pointerDownInsideTransform=true;}else{closeImageTransformation();pointerDownInsideTransform=false;}});useExternalListener(document,"click",(ev)=>{if(!isNodeInsideTransform(ev.target)&&!pointerDownInsideTransform){closeImageTransformation();}
pointerDownInsideTransform=false;},{capture:true});useExternalListener(document,"selectionchange",(ev)=>{closeImageTransformation();});function isNodeInsideTransform(node){if(!node){return false;}
if(node.nodeType===Node.TEXT_NODE){node=node.parentElement;}
if(node.matches(buttonSelector)){return true;}
if(isImageTransformationOpen()&&node.matches(".transfo-controls, .transfo-controls *")){return true;}
return false;}
function isImageTransformationOpen(){return registry.category("main_components").contains("ImageTransformation");}
return{isImageTransformationOpen};}
const ImageTransformButton=__exports.ImageTransformButton=class ImageTransformButton extends Component{static template="html_editor.ImageTransformButton";static props={id:String,icon:String,title:String,getTargetedImage:Function,resetImageTransformation:Function,addStep:Function,document:{validate:(p)=>p.nodeType===Node.DOCUMENT_NODE},editable:{validate:(p)=>p.nodeType===Node.ELEMENT_NODE},...toolbarButtonProps,activeTitle:String,};setup(){this.state=useState({active:false});this.transform=useImageTransform({document:this.props.document,closeImageTransformation:this.closeImageTransformation.bind(this),buttonSelector:'[name="image_transform"], [name="image_transform"] *',});}
onButtonClick(){this.handleImageTransformation(this.props.getTargetedImage());}
handleImageTransformation(image){if(this.transform.isImageTransformationOpen()){this.props.resetImageTransformation(image);this.closeImageTransformation();}else{this.openImageTransformation(image);}}
openImageTransformation(image){this.state.active=true;registry.category("main_components").add("ImageTransformation",{Component:ImageTransformation,props:{image,document:this.props.document,editable:this.props.editable,destroy:()=>this.closeImageTransformation(),onChange:()=>this.props.addStep(),},});}
closeImageTransformation(){this.state.active=false;if(this.transform.isImageTransformationOpen()){registry.category("main_components").remove("ImageTransformation");}}}
return __exports;});;

/* /html_editor/static/src/main/media/image_transformation.js */
odoo.define('@html_editor/main/media/image_transformation',['@odoo/owl','@web/core/hotkeys/hotkey_hook','@html_editor/position_hook'],function(require){'use strict';let __exports={};const{Component,onMounted,useExternalListener,useRef}=require("@odoo/owl");const{useHotkey}=require("@web/core/hotkeys/hotkey_hook");const{usePositionHook}=require("@html_editor/position_hook");const rad=Math.PI/180;const MIN_IMAGE_SIZE=20;const ImageTransformation=__exports.ImageTransformation=class ImageTransformation extends Component{static template="html_editor.ImageTransformation";static props={document:{validate:(p)=>p.nodeType===Node.DOCUMENT_NODE},editable:{validate:(p)=>p.nodeType===Node.ELEMENT_NODE},image:{validate:(p)=>p.tagName==="IMG"},destroy:{type:Function},onChange:{type:Function},onApply:{type:Function,optional:true},onComponentMounted:{type:Function,optional:true},};static defaultProps={onComponentMounted:()=>{},};setup(){this.isCurrentlyTransforming=false;this.document=this.props.document;this.image=this.props.image;this.transfoContainer=useRef("transfoContainer");this.transfoControls=useRef("transfoControls");this.transfoCenter=useRef("transfoCenter");this.computeImageTransformations();onMounted(()=>{this.positionTransfoContainer();this.props.onComponentMounted();});useExternalListener(window,"mousemove",this.mouseMove);useExternalListener(window,"mouseup",this.mouseUp);if(this.document.defaultView.frameElement){const iframeWindow=this.document.defaultView;useExternalListener(iframeWindow,"mousemove",this.mouseMove);useExternalListener(iframeWindow,"mouseup",this.mouseUp);}
useExternalListener(this.document,"selectionchange",()=>this.destroy());useExternalListener(this.document,"keydown",(ev)=>{if(["Backspace","Delete"].includes(ev.key)){this.destroy();}});useHotkey("escape",()=>this.destroy());usePositionHook({el:this.props.editable},this.document,()=>{if(!this.isCurrentlyTransforming){this.resetHandlers();}});}
destroy(){this.props.onApply?.();this.props.destroy();}
mouseMove(ev){if(!this.transfo.active){return;}
ev.preventDefault();const{pageX,pageY}=this.normalizeCoordinates(ev);const settings=this.transfo.settings;const center=this.transfo.active.center;const cdx=center.left-pageX;const cdy=center.top-pageY;if(this.transfo.active.type=="rotator"){let ang;const dang=Math.atan(settings.width/settings.height)/rad;if(cdy){ang=Math.atan(-cdx/cdy)/rad;}else{ang=0;}
if(pageY>=center.top&&pageX>=center.left){ang+=180;}else if(pageY>=center.top&&pageX<center.left){ang+=180;}else if(pageY<center.top&&pageX<center.left){ang+=360;}
ang-=dang;if(!ev.ctrlKey){settings.angle=Math.round(ang/this.transfo.settings.rotationStep)*this.transfo.settings.rotationStep;}else{settings.angle=ang;}
this.positionTransfoContainer();const new_center=this.getOffset(this.transfoCenter.el);const x=center.left-new_center.left;const y=center.top-new_center.top;const angle=ang*rad;settings.translatex+=x*Math.cos(angle)-y*Math.sin(-angle);settings.translatey+=-x*Math.sin(angle)+y*Math.cos(-angle);}else if(this.transfo.active.type=="position"){const angle=settings.angle*rad;const x=pageX-this.transfo.active.pageX;const y=pageY-this.transfo.active.pageY;this.transfo.active.pageX=pageX;this.transfo.active.pageY=pageY;const dx=x*Math.cos(angle)-y*Math.sin(-angle);const dy=-x*Math.sin(angle)+y*Math.cos(-angle);settings.translatex+=dx;settings.translatey+=dy;}else if(this.transfo.active.type.length===2){const width=this.transfo.active.width;const height=this.transfo.active.height;const deltaX=pageX-this.transfo.active.pageX;const deltaY=pageY-this.transfo.active.pageY;let newWidth=width;let newHeight=height;if(this.transfo.active.type.indexOf("t")!=-1){newHeight=height-deltaY;}
if(this.transfo.active.type.indexOf("b")!=-1){newHeight=height+deltaY;}
if(this.transfo.active.type.indexOf("l")!=-1){newWidth=width-deltaX;}
if(this.transfo.active.type.indexOf("r")!=-1){newWidth=width+deltaX;}
if(newWidth<MIN_IMAGE_SIZE){newWidth=MIN_IMAGE_SIZE;}
if(newHeight<MIN_IMAGE_SIZE){newHeight=MIN_IMAGE_SIZE;}
if(ev.shiftKey&&(this.transfo.active.type==="tl"||this.transfo.active.type==="bl"||this.transfo.active.type==="tr"||this.transfo.active.type==="br")){const aspectRatio=width/height;if(Math.abs(deltaX)>Math.abs(deltaY)){newHeight=newWidth/aspectRatio;}else{newWidth=newHeight*aspectRatio;}}
this.image.style.width=newWidth+"px";this.image.style.height="auto";settings.width=newWidth;}
settings.angle=Math.round(settings.angle);settings.translatex=Math.round(settings.translatex);settings.translatey=Math.round(settings.translatey);const prevImageTransform=this.image.style.transform;this.image.style.transform="";this.transfo.settings.pos=this.getOffset(this.image);this.image.style.transform=prevImageTransform;this.positionTransfoContainer();}
convertPixelWidthToPercentage(){const currentPixelWidth=this.image.offsetWidth;const widthPercent=(currentPixelWidth/this.image.parentElement.offsetWidth)*100;this.image.style.width=widthPercent.toFixed(2)+"%";}
mouseUp(){this.isCurrentlyTransforming=false;this.transfo.active=null;this.convertPixelWidthToPercentage();this.props.onApply?.();this.props.onChange();}
mouseDown(ev){if(this.transfo.active){return;}
this.isCurrentlyTransforming=true;let type="position";const target=ev.target.closest("div");if(target.classList.contains("transfo-rotator")){type="rotator";}else if(target.classList.contains("transfo-scaler-tl")){type="tl";}else if(target.classList.contains("transfo-scaler-tr")){type="tr";}else if(target.classList.contains("transfo-scaler-br")){type="br";}else if(target.classList.contains("transfo-scaler-bl")){type="bl";}else if(target.classList.contains("transfo-scaler-tc")){type="tc";}else if(target.classList.contains("transfo-scaler-bc")){type="bc";}else if(target.classList.contains("transfo-scaler-ml")){type="ml";}else if(target.classList.contains("transfo-scaler-mr")){type="mr";}
const{pageX,pageY}=this.normalizeCoordinates(ev);this.transfo.active={type:type,pageX:pageX,pageY:pageY,width:parseFloat(getComputedStyle(this.image).width),height:parseFloat(getComputedStyle(this.image).height),center:this.getOffset(this.transfoCenter.el),};}
computeImageTransformations(){this.transfo={};const transform=this.image.style.transform||"";this.transfo.settings={};this.transfo.settings.angle=transform.indexOf("rotate")!=-1?parseFloat(transform.match(/rotate\(([^)]+)deg\)/)[1]):0;this.image.style.transform="";this.transfo.settings.pos=this.getOffset(this.image);this.transfo.settings.width=parseFloat(getComputedStyle(this.image).width);this.transfo.settings.height=parseFloat(getComputedStyle(this.image).height);const translatex=transform.match(/translateX\(([0-9.-]+)(%|px)\)/);const translatey=transform.match(/translateY\(([0-9.-]+)(%|px)\)/);this.transfo.settings.translate="%";if(translatex&&translatex[2]==="%"){this.transfo.settings.translatexp=parseFloat(translatex[1]);this.transfo.settings.translatex=(this.transfo.settings.translatexp/100)*this.transfo.settings.width;}else{this.transfo.settings.translatex=translatex?parseFloat(translatex[1]):0;}
if(translatey&&translatey[2]==="%"){this.transfo.settings.translateyp=parseFloat(translatey[1]);this.transfo.settings.translatey=(this.transfo.settings.translateyp/100)*this.transfo.settings.height;}else{this.transfo.settings.translatey=translatey?parseFloat(translatey[1]):0;}
this.transfo.settings.css=window.getComputedStyle(this.image,null);this.transfo.settings.rotationStep=5;}
positionTransfoContainer(){const settings=this.transfo.settings;const width=parseFloat(getComputedStyle(this.image).width);const height=parseFloat(getComputedStyle(this.image).height);settings.translatexp=Math.round((settings.translatex/width)*1000)/10;settings.translateyp=Math.round((settings.translatey/height)*1000)/10;this.setImageTransformation(this.image);this.transfoContainer.el.style.position="absolute";this.transfoContainer.el.style.width=width+"px";this.transfoContainer.el.style.height=height+"px";this.transfoContainer.el.style.top=settings.pos.top+"px";this.transfoContainer.el.style.left=settings.pos.left+"px";const controls=this.transfoControls.el;this.setImageTransformation(controls);controls.style.width=width+"px";controls.style.height=height+"px";controls.style.cursor="move";}
setImageTransformation(element){let transform="";if(this.transfo.settings.angle!==0){transform+=" rotate("+this.transfo.settings.angle+"deg) ";}
if(this.transfo.settings.translatex){transform+=" translateX("+
(this.transfo.settings.translate==="%"?this.transfo.settings.translatexp+"%":this.transfo.settings.translatex+"px")+") ";}
if(this.transfo.settings.translatey){transform+=" translateY("+
(this.transfo.settings.translate==="%"?this.transfo.settings.translateyp+"%":this.transfo.settings.translatey+"px")+") ";}
element.style.transform=transform;}
normalizeCoordinates(ev){const evView=ev.view;const iframeWindow=this.document.defaultView;const frameElement=iframeWindow.frameElement;if(evView===iframeWindow&&frameElement){const frameRect=frameElement.getBoundingClientRect();return{pageX:ev.clientX+frameRect.left+frameElement.clientLeft+window.pageXOffset,pageY:ev.clientY+frameRect.top+frameElement.clientTop+window.pageYOffset,};}
return{pageX:ev.pageX,pageY:ev.pageY};}
getOffset(target){if(!target.getClientRects().length){return{top:0,left:0};}else{const rect=target.getBoundingClientRect();const frameElement=target.ownerDocument.defaultView.frameElement;const offset={top:0,left:0};if(frameElement){const frameRect=frameElement.getBoundingClientRect();offset.left+=frameRect.left+frameElement.clientLeft;offset.top+=frameRect.top+frameElement.clientTop;}
return{top:rect.top+window.pageYOffset+offset.top,left:rect.left+window.pageXOffset+offset.left,};}}
resetHandlers(){this.computeImageTransformations();this.positionTransfoContainer();}}
return __exports;});;

/* /html_editor/static/src/main/media/media_plugin.js */
odoo.define('@html_editor/main/media/media_plugin',['@html_editor/plugin','@html_editor/utils/dom_info','@web/core/l10n/translation','@html_editor/main/media/media_dialog/media_dialog','@html_editor/core/selection_plugin','@html_editor/utils/position','@html_editor/utils/resource','@html_editor/utils/dom_traversal','@web/core/utils/search','@html_editor/utils/formatting'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{ICON_SELECTOR,MEDIA_SELECTOR,EDITABLE_MEDIA_CLASS,isIconElement,isMediaElement,isProtected,isProtecting,paragraphRelatedElementsSelector,isContentEditable,}=require("@html_editor/utils/dom_info");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{MediaDialog,TABS}=require("@html_editor/main/media/media_dialog/media_dialog");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const{boundariesOut,rightPos}=require("@html_editor/utils/position");const{withSequence}=require("@html_editor/utils/resource");const{closestElement}=require("@html_editor/utils/dom_traversal");const{fuzzyLookup}=require("@web/core/utils/search");const{FORMATTABLE_TAGS}=require("@html_editor/utils/formatting");const MediaPlugin=__exports.MediaPlugin=class MediaPlugin extends Plugin{static id="media";static dependencies=["selection","history","dom","dialog"];static shared=["openMediaDialog"];static defaultConfig={allowImage:true,allowMediaDocuments:true,};resources={user_commands:[{id:"replaceImage",description:_t("Replace media"),icon:"fa-exchange",run:this.replaceImage.bind(this),isAvailable:isHtmlContentSupported,},{id:"insertMedia",title:_t("Media"),description:this.config.allowVideo?_t("Insert image, icon or video"):_t("Insert image or icon"),icon:"fa-file-image-o",run:(params,context={})=>this.openMediaDialog({activeTab:this.getActiveDialogTab(context.searchTerm),}),isAvailable:isHtmlContentSupported,},],toolbar_groups:withSequence(31,{id:"replace_image",namespaces:["image"]}),toolbar_items:[{id:"replace_image",groupId:"replace_image",commandId:"replaceImage",},],powerbox_categories:withSequence(40,{id:"media",name:_t("Media")}),...(this.config.allowImage&&{powerbox_items:this.getInsertMediaPowerboxItem(),}),power_buttons:withSequence(1,{commandId:"insertMedia"}),closest_savable_providers:withSequence(20,(el)=>this.editable),clean_for_save_handlers:({root})=>this.cleanForSave(root),normalize_handlers:this.normalizeMedia.bind(this),selectionchange_handlers:this.selectAroundIcon.bind(this),unsplittable_node_predicates:isIconElement,is_node_editable_predicates:this.isEditableMediaElement.bind(this),clipboard_content_processors:this.clean.bind(this),clipboard_text_processors:(text)=>text.replace(/\u200B/g,""),functional_empty_node_predicates:isMediaElement,selectors_for_feff_providers:()=>`:is(${paragraphRelatedElementsSelector}, ${FORMATTABLE_TAGS.join(
                ", "
            )}, A) > :is(${ICON_SELECTOR})`,};setup(){this.availableTabs=[...Object.values(TABS),...this.getResource("media_dialog_extra_tabs"),];}
getInsertMediaPowerboxItem(){const self=this;return{categoryId:"media",commandId:"insertMedia",get keywords(){return self.availableTabs.map((tab)=>tab.title);},};}
getRecordInfo(editableEl=null){return this.config.getRecordInfo?this.config.getRecordInfo(editableEl):{};}
isEditableMediaElement(node){if((isMediaElement(node)||node.nodeName==="IMG")&&(node.classList.contains(EDITABLE_MEDIA_CLASS)||isContentEditable(node))){return true;}}
replaceImage(){const targetedNodes=this.dependencies.selection.getTargetedNodes();const node=targetedNodes.find((node)=>node.tagName==="IMG");if(node){this.openMediaDialog({node});this.dependencies.history.addStep();}}
normalizeMedia(node){const mediaElements=[...node.querySelectorAll(MEDIA_SELECTOR)];if(node.matches(MEDIA_SELECTOR)){mediaElements.push(node);}
for(const el of mediaElements){if(isProtected(el)||isProtecting(el)){continue;}
el.setAttribute("contenteditable",el.hasAttribute("contenteditable")?el.getAttribute("contenteditable"):"false");if(isIconElement(el)&&el.textContent!=="\u200B"){el.textContent="\u200B";}}}
clean(root){for(const el of root.querySelectorAll(MEDIA_SELECTOR)){if(isIconElement(el)){el.textContent="";}}}
cleanForSave(root){for(const el of root.querySelectorAll(MEDIA_SELECTOR)){if(isIconElement(el)){el.textContent="";}
el.removeAttribute("contenteditable");}}
async onSaveMediaDialog(element,{node}){if(!element){throw new Error("Element is required: onSaveMediaDialog");}
if(node){const changedIcon=isIconElement(node)&&isIconElement(element);if(changedIcon){for(const attribute of element.attributes){node.setAttribute(attribute.nodeName,attribute.nodeValue);}
element=node;}else{node.replaceWith(element);}
this.dispatchTo("on_replaced_media_handlers",{newMediaEl:element});}else{this.dependencies.dom.insert(element);this.dispatchTo("on_added_media_handlers",{newMediaEl:element});}
const[anchorNode,anchorOffset]=rightPos(element);this.dependencies.selection.setSelection({anchorNode,anchorOffset});this.dispatchTo("after_save_media_dialog_handlers",element);this.dependencies.history.addStep();}
openMediaDialog(params={},editableEl=null){const oldSave=params.save||((element)=>this.onSaveMediaDialog(element,{node:params.node}));params.save=async(...args)=>{const selection=args[0];const elements=selection?selection[Symbol.iterator]?selection:[selection]:[];for(const onMediaDialogSaved of this.getResource("on_media_dialog_saved_handlers")){await onMediaDialogSaved(elements,{node:params.node});}
return oldSave(...args);};const{resModel,resId,field,type}=this.getRecordInfo(editableEl);const mediaDialogClosedPromise=this.dependencies.dialog.addDialog(MediaDialog,{resModel,resId,useMediaLibrary:!!(field&&((resModel==="ir.ui.view"&&field==="arch")||type==="html")),media:params.node,onAttachmentChange:this.config.onAttachmentChange||(()=>{}),noImages:!this.config.allowImage,extraTabs:this.getResource("media_dialog_extra_tabs"),...this.config.mediaModalParams,...params,});return mediaDialogClosedPromise;}
selectAroundIcon({editableSelection}){if(!editableSelection.isCollapsed){return;}
const iconEl=closestElement(editableSelection.anchorNode,isIconElement);if(!iconEl){return;}
const[anchorNode,anchorOffset,focusNode,focusOffset]=boundariesOut(iconEl);const iconOuterBoundaries={anchorNode,anchorOffset,focusNode,focusOffset};this.dependencies.selection.setSelection(iconOuterBoundaries);}
getActiveDialogTab(searchTerm){if(!searchTerm){return undefined;}
const matchedTabs=fuzzyLookup(searchTerm,this.availableTabs,(tab)=>tab.title);if(!matchedTabs.length){return undefined;}
return matchedTabs[0].id;}}
return __exports;});;

/* /html_editor/static/src/main/media/video_plugin.js */
odoo.define('@html_editor/main/media/video_plugin',['@html_editor/plugin','@html_editor/main/media/media_dialog/video_selector','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{VideoSelector}=require("@html_editor/main/media/media_dialog/video_selector");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const VideoPlugin=__exports.VideoPlugin=class VideoPlugin extends Plugin{static id="video";static defaultConfig={allowVideo:true,};resources={...(this.config.allowVideo&&{media_dialog_extra_tabs:{id:"VIDEOS",title:_t("Videos"),Component:this.componentForMediaDialog,sequence:30,},}),};get componentForMediaDialog(){return VideoSelector;}}
return __exports;});;

/* /html_editor/static/src/main/movenode_plugin.js */
odoo.define('@html_editor/main/movenode_plugin',['@html_editor/utils/drag_and_drop','@html_editor/utils/position','@odoo/owl','@html_editor/plugin','@html_editor/utils/dom_traversal','@web/core/l10n/translation','@html_editor/utils/base_container','@html_editor/utils/dom_info'],function(require){'use strict';let __exports={};const{useNativeDraggable}=require("@html_editor/utils/drag_and_drop");const{childNodeIndex,endPos,leftPos,nodeSize,rightPos}=require("@html_editor/utils/position");const{xml}=require("@odoo/owl");const{Plugin}=require("@html_editor/plugin");const{closestElement}=require("@html_editor/utils/dom_traversal");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{baseContainerGlobalSelector}=require("@html_editor/utils/base_container");const{getDeepestPosition,isContentEditable}=require("@html_editor/utils/dom_info");const WIDGET_CONTAINER_WIDTH=25;const WIDGET_MOVE_SIZE=20;const ALLOWED_ELEMENTS="h1, h2, h3, p, hr, pre, blockquote, li";const MoveNodePlugin=__exports.MoveNodePlugin=class MoveNodePlugin extends Plugin{static id="movenode";static dependencies=["baseContainer","selection","history","position","localOverlay"];resources={layout_geometry_change_handlers:()=>{if(this.currentMovableElement){this.setMovableElement(this.currentMovableElement);}
this.updateHooks();},};setup(){this.intersectionObserver=new IntersectionObserver(this.intersectionObserverCallback.bind(this),{root:document,});this.visibleMovableElements=new Set();this.elementHookMap=new Map();this.addDomListener(this.editable,"mousemove",this.onMousemove,true);this.addDomListener(this.editable,"touchmove",this.onMousemove,true);this.addDomListener(this.document,"keydown",this.onDocumentKeydown,true);this.addDomListener(this.document,"mousemove",this.onDocumentMousemove,true);this.addDomListener(this.document,"touchmove",this.onDocumentMousemove,true);this.widgetHookContainer=this.dependencies.localOverlay.makeLocalOverlay("oe-widget-hooks-container");this.widgetContainer=this.dependencies.localOverlay.makeLocalOverlay("oe-widgets-container");this.dragHelperContainer=this.dependencies.localOverlay.makeLocalOverlay("oe-movenode-helper-container");this.dropzonesContainer=this.dependencies.localOverlay.makeLocalOverlay("oe-dropzones-container");this.dropzoneHintContainer=this.dependencies.localOverlay.makeLocalOverlay("oe-dropzone-hint-container");this.scrollableElement=closestElement(this.editable.parentElement);while(this.scrollableElement&&getComputedStyle(this.scrollableElement).overflowY!=="auto"){this.scrollableElement=this.scrollableElement.parentElement;}
this.scrollableElement=this.scrollableElement||this.editable;this.resetHooksNextMousemove=true;this.mutationObserver=new MutationObserver(()=>{this.resetHooksNextMousemove=true;this.removeMoveWidget();});this.mutationObserver.observe(this.editable,{childList:true,subtree:true,characterData:true,characterDataOldValue:true,});}
destroy(){super.destroy();this.intersectionObserver.disconnect();this.mutationObserver.disconnect();this.smoothScrollOnDrag&&this.smoothScrollOnDrag.destroy();}
intersectionObserverCallback(entries){for(const entry of entries){const element=entry.target;if(entry.isIntersecting&&element.isConnected){this.visibleMovableElements.add(element);this.resetHooksNextMousemove=true;}else{this.visibleMovableElements.delete(element);const hookElement=this.elementHookMap.get(element);if(hookElement){hookElement.style.display=`none`;}}}}
updateHooks(){const editableStyles=getComputedStyle(this.editable);this.editableRect=this.editable.getBoundingClientRect();const paddingLeft=parseInt(editableStyles.paddingLeft,10)||0;this.editableRect.x=this.editableRect.x+paddingLeft-(WIDGET_CONTAINER_WIDTH+5);this.editableRect.width=this.editableRect.width-paddingLeft+(WIDGET_CONTAINER_WIDTH+5);const containerRect=this.widgetHookContainer.getBoundingClientRect();const elements=this.getMovableElements();const elementsToGarbageCollect=new Set(this.elementHookMap.keys());for(const index in elements){const element=elements[index];elementsToGarbageCollect.delete(element);let hookElement=this.elementHookMap.get(element);if(!hookElement){hookElement=document.createElement("div");this.elementHookMap.set(element,hookElement);hookElement.classList.add("oe-dropzone-hook");hookElement.addEventListener("mouseenter",()=>{if(element!==this.currentMovableElement){this.setMovableElement(element);}});this.widgetHookContainer.append(hookElement);hookElement.style.display=`none`;this.intersectionObserver.observe(element);}
hookElement.style.zIndex=index;}
for(const element of elementsToGarbageCollect){this.visibleMovableElements.delete(element);this.elementHookMap.get(element).remove();this.intersectionObserver.unobserve(element);this.elementHookMap.delete(element);}
const visibleElements=[...this.visibleMovableElements];const elementRects=visibleElements.map((element)=>element.getBoundingClientRect());for(const index in visibleElements){const element=visibleElements[index];const elementRect=elementRects[index];const hookElement=this.elementHookMap.get(element);const style=getComputedStyle(element);const marginTop=parseInt(style.marginTop,10)||0;const marginBottom=parseInt(style.marginBottom,10)||0;let hookBox;if(element.tagName==="HR"){hookBox=new DOMRect(elementRect.x-containerRect.left-WIDGET_CONTAINER_WIDTH,elementRect.y-containerRect.top-marginTop,elementRect.width+WIDGET_CONTAINER_WIDTH,elementRect.height+marginTop+marginBottom);}else if(element.tagName==="LI"){hookBox=new DOMRect(elementRect.x-containerRect.left-WIDGET_CONTAINER_WIDTH-WIDGET_MOVE_SIZE,elementRect.y-containerRect.top-marginTop,WIDGET_CONTAINER_WIDTH,elementRect.height+marginTop+marginBottom);}else{hookBox=new DOMRect(elementRect.x-containerRect.left-WIDGET_CONTAINER_WIDTH,elementRect.y-containerRect.top-marginTop,WIDGET_CONTAINER_WIDTH,elementRect.height+marginTop+marginBottom);}
hookElement.style.left=`${hookBox.x}px`;hookElement.style.top=`${hookBox.y}px`;hookElement.style.width=`${hookBox.width}px`;hookElement.style.height=`${hookBox.height}px`;hookElement.style.display=`block`;}}
_updateAnchorWidgets(newAnchorWidget){const movableElement=newAnchorWidget&&closestElement(newAnchorWidget,(node)=>this.isNodeMovable(node)&&node.matches([ALLOWED_ELEMENTS,baseContainerGlobalSelector,...this.getResource("move_node_whitelist_selectors"),].join(", ")));if(movableElement&&movableElement!==this.currentMovableElement){this.setMovableElement(movableElement);}}
getMovableElements(){const elems=[];for(const el of this.editable.querySelectorAll([ALLOWED_ELEMENTS,baseContainerGlobalSelector,...this.getResource("move_node_whitelist_selectors"),].join(", "))){if(this.isNodeMovable(el)){elems.push(el);}}
return elems;}
getDroppableElements(draggableNode){return this.getMovableElements().filter((node)=>!closestElement(node.parentElement,(n)=>n===draggableNode));}
setMovableElement(movableElement){this.removeMoveWidget();this.currentMovableElement=movableElement;this.dispatchTo("set_movable_element_handlers",movableElement);const containerRect=this.widgetContainer.getBoundingClientRect();const anchorBlockRect=this.currentMovableElement.getBoundingClientRect();const anchorX=this.currentMovableElement.tagName==="LI"?anchorBlockRect.x-WIDGET_MOVE_SIZE:anchorBlockRect.x;let anchorY=anchorBlockRect.y;if(this.currentMovableElement.tagName.match(/H[1-6]/)){anchorY+=(anchorBlockRect.height-WIDGET_MOVE_SIZE)/2;}
this.moveWidget=this.document.createElement("div");this.moveWidget.className="oe-sidewidget-move oi oi-draggable";this.widgetContainer.append(this.moveWidget);let moveWidgetOffsetTop=0;if(movableElement.tagName==="HR"){const style=getComputedStyle(movableElement);moveWidgetOffsetTop=parseInt(style.marginTop,10)||0;}
this.moveWidget.style.width=`${WIDGET_MOVE_SIZE}px`;this.moveWidget.style.height=`${WIDGET_MOVE_SIZE}px`;this.moveWidget.style.top=`${anchorY - containerRect.y - moveWidgetOffsetTop}px`;this.moveWidget.style.left=`${anchorX - containerRect.x - WIDGET_CONTAINER_WIDTH}px`;this.services.tooltip.add(this.moveWidget,{template:xml`
                <div class="o-tooltip tooltip-inner text-start px-3">
                    ${_t("Drag to move")}<br/>
                    ${_t("Click to select")}
                </div>`,arrow:true,});this.addDomListener(this.moveWidget,"click",()=>{const isNodeContentEditable=isContentEditable(movableElement);const[anchorNode,anchorOffset]=isNodeContentEditable?getDeepestPosition(movableElement,0):leftPos(movableElement);const[focusNode,focusOffset]=isNodeContentEditable?getDeepestPosition(movableElement,nodeSize(movableElement)):rightPos(movableElement);this.dependencies.selection.setSelection({anchorNode,anchorOffset,focusNode,focusOffset,});this.dependencies.selection.focusEditable();});if(this.scrollableElement){this.smoothScrollOnDrag&&this.smoothScrollOnDrag.destroy();this.smoothScrollOnDrag=useNativeDraggable(simpleDraggableHook,{ref:{el:this.widgetContainer},elements:".oe-sidewidget-move",onDragStart:()=>this.startDropzones(movableElement,containerRect),onDragEnd:()=>this._stopDropzones(movableElement),helper:()=>{const container=movableElement.tagName==="LI"?movableElement.parentElement.cloneNode(false):document.createElement("div");if(container.tagName==="OL"){const originalIndex=childNodeIndex(movableElement)+1;container.setAttribute("start",originalIndex);}
container.append(movableElement.cloneNode(true));const style=getComputedStyle(movableElement);container.style.height=style.height;container.style.width=style.width;container.style.paddingLeft="25px";container.style.opacity="0.4";this.dragHelperContainer.append(container);return container;},});}}
removeMoveWidget(){this.dispatchTo("unset_movable_element_handlers");this.moveWidget?.remove();this.moveWidget=undefined;this.currentMovableElement=undefined;}
startDropzones(movableElement,containerRect,directions=["north","south"]){this.removeMoveWidget();const elements=this.getDroppableElements(movableElement);this.dropzonesContainer.replaceChildren();this.editable.classList.add("oe-editor-dragging");for(const element of elements){const originalRect=element.getBoundingClientRect();const style=getComputedStyle(element);const marginTop=parseInt(style.marginTop,10);const marginBottom=parseInt(style.marginBottom,10);const marginLeft=parseInt(style.marginLeft,10);const marginRight=parseInt(style.marginRight,10);const dropzoneRect=new DOMRect(originalRect.left-marginLeft-WIDGET_CONTAINER_WIDTH,originalRect.top-marginTop,originalRect.width+marginLeft+marginRight+WIDGET_CONTAINER_WIDTH,originalRect.height+marginTop+marginBottom);const dropzoneHintRect=new DOMRect(originalRect.left-marginLeft,originalRect.top-marginTop,originalRect.width+marginLeft+marginRight,originalRect.height+marginTop+marginBottom);const dropzoneBox=document.createElement("div");dropzoneBox.className=`oe-dropzone-box`;dropzoneBox.style.top=`${dropzoneRect.top - containerRect.top}px`;dropzoneBox.style.left=element.tagName=="LI"?`${dropzoneRect.left - containerRect.left - WIDGET_MOVE_SIZE}px`:`${dropzoneRect.left - containerRect.left}px`;dropzoneBox.style.width=`${dropzoneRect.width}px`;dropzoneBox.style.height=`${dropzoneRect.height}px`;const dropzoneHintBox=document.createElement("div");dropzoneHintBox.className=`oe-dropzone-box`;dropzoneHintBox.style.top=`${dropzoneHintRect.top - containerRect.top}px`;dropzoneHintBox.style.left=`${dropzoneHintRect.left - containerRect.left}px`;dropzoneHintBox.style.width=`${dropzoneHintRect.width}px`;dropzoneHintBox.style.height=`${dropzoneHintRect.height}px`;const sideElements={};for(const direction of directions){const sideElement=document.createElement("div");sideElement.className=`oe-dropzone-box-side oe-dropzone-box-side-${direction}`;sideElements[direction]=sideElement;dropzoneBox.append(sideElement);const onEnter=()=>{this._currentZone=[direction];removeDropHint();this._currentDropHint=document.createElement("div");this._currentDropHint.className=`oe-current-drop-hint`;const currentDropHintSize=4;const currentDropHintSizeHalf=currentDropHintSize/2;if(direction==="north"){this._currentDropHint.style["top"]=`-${currentDropHintSizeHalf}px`;this._currentDropHint.style["width"]=`100%`;this._currentDropHint.style["height"]=`${currentDropHintSize}px`;dropzoneHintBox.append(this._currentDropHint);this._currentDropHintElementPosition=["top",element];}else if(direction==="south"){this._currentDropHint.style["bottom"]=`-${currentDropHintSizeHalf}px`;this._currentDropHint.style["width"]=`100%`;this._currentDropHint.style["height"]=`${currentDropHintSize}px`;dropzoneHintBox.append(this._currentDropHint);this._currentDropHintElementPosition=["bottom",element];}else if(direction==="west"){this._currentDropHint.style["left"]=`-${currentDropHintSizeHalf}px`;this._currentDropHint.style["height"]=`100%`;this._currentDropHint.style["width"]=`${currentDropHintSize}px`;dropzoneHintBox.append(this._currentDropHint);this._currentDropHintElementPosition=["left",element];}else if(direction==="east"){this._currentDropHint.style["right"]=`-${currentDropHintSizeHalf}px`;this._currentDropHint.style["height"]=`100%`;this._currentDropHint.style["width"]=`${currentDropHintSize}px`;dropzoneHintBox.append(this._currentDropHint);this._currentDropHintElementPosition=["right",element];}};sideElement.addEventListener("mouseenter",onEnter);sideElement.addEventListener("pointerenter",onEnter);const removeDropHint=()=>{if(this._currentDropHint){this._currentDropHint.remove();this._currentDropHint=null;}
this._currentDropHintElementPosition=null;};dropzoneBox.addEventListener("mouseleave",removeDropHint);dropzoneBox.addEventListener("pointerleave",removeDropHint);}
this.dropzonesContainer.append(dropzoneBox);this.dropzoneHintContainer.append(dropzoneHintBox);}}
_stopDropzones(movableElement){this.editable.classList.remove("oe-editor-dragging");this.dropzonesContainer.replaceChildren();this.dropzoneHintContainer.replaceChildren();if(this._currentDropHintElementPosition){const[position,focusElelement]=this._currentDropHintElementPosition;this._currentDropHintElementPosition=undefined;const previousParent=movableElement.parentElement;const isFocusInsideList=["UL","OL"].includes(focusElelement?.parentElement?.tagName);if(movableElement.tagName==="LI"&&!isFocusInsideList){const wrapperList=previousParent.cloneNode(false);wrapperList.appendChild(movableElement);movableElement=wrapperList;}else if(movableElement.tagName!=="LI"&&isFocusInsideList){const wrapperLI=this.document.createElement("LI");wrapperLI.appendChild(movableElement);movableElement=wrapperLI;}
if(position==="top"){focusElelement.before(movableElement);}else if(position==="bottom"){focusElelement.after(movableElement);}
if(previousParent.innerHTML.trim()===""){if(["UL","OL"].includes(previousParent.tagName)){previousParent.remove();}else{const baseContainer=this.dependencies.baseContainer.createBaseContainer();const br=document.createElement("br");baseContainer.append(br);previousParent.append(baseContainer);}}
const selectionPosition=endPos(movableElement);this.dependencies.selection.setSelection({anchorNode:selectionPosition[0],anchorOffset:selectionPosition[1],});this.dependencies.history.addStep();}}
onMousemove(e){this._updateAnchorWidgets(e.target);}
onDocumentKeydown(){this.removeMoveWidget();}
onDocumentMousemove(e){if(this.resetHooksNextMousemove){this.resetHooksNextMousemove=false;this.removeMoveWidget();this.updateHooks();}
const clientX=e.clientX??e.touches?.[0]?.clientX;const clientY=e.clientY??e.touches?.[0]?.clientY;if(this.editableRect&&!isPointInside(this.editableRect,clientX,clientY)){this.removeMoveWidget();}}
isNodeMovable(node){const blacklistSelectors=this.getResource("move_node_blacklist_selectors").join(", ");if(blacklistSelectors&&node.matches(blacklistSelectors)){return false;}
return(node.parentElement?.getAttribute("contentEditable")==="true"||(node.tagName==="LI"&&node.parentElement.isContentEditable));}}
function isPointInside(rect,x,y){return rect.left<=x&&rect.right>=x&&rect.top<=y&&rect.bottom>=y;}
const simpleDraggableHook={acceptedParams:{helper:[Function],},edgeScrolling:{enable:true},onComputeParams({ctx,params}){ctx.helper=params.helper;ctx.followCursor=false;ctx.tolerance=0;},onDragStart({ctx}){ctx.current.element=ctx.helper();ctx.current.element.style.left=`${ctx.pointer.x + 10}px`;ctx.current.element.style.top=`${ctx.pointer.y + 10}px`;ctx.current.element.style.position="fixed";document.body.classList.remove("pe-none");document.body.style.cursor="grabbing";return ctx.current;},onDrag({ctx}){ctx.current.element.style.left=`${ctx.pointer.x}px`;ctx.current.element.style.top=`${ctx.pointer.y}px`;},onDragEnd({ctx}){ctx.current.element.remove();if(document.body.style.cursor==="grabbing"){document.body.style.cursor="";}
return ctx.current;},};return __exports;});;

/* /html_editor/static/src/main/placeholder_plugin.js */
odoo.define('@html_editor/main/placeholder_plugin',['@html_editor/utils/base_container','@html_editor/plugin','@html_editor/utils/dom_traversal','@html_editor/utils/dom_info','@html_editor/utils/resource'],function(require){'use strict';let __exports={};const{baseContainerGlobalSelector}=require("@html_editor/utils/base_container");const{Plugin}=require("@html_editor/plugin");const{childNodes}=require("@html_editor/utils/dom_traversal");const{isEmptyBlock}=require("@html_editor/utils/dom_info");const{withSequence}=require("@html_editor/utils/resource");const PlaceholderPlugin=__exports.PlaceholderPlugin=class PlaceholderPlugin extends Plugin{static id="placeholder";resources={...(this.config.placeholder&&{hints:[withSequence(1,{selector:`.odoo-editor-editable:not(:focus) > ${baseContainerGlobalSelector}:only-child`,text:this.config.placeholder,}),],hint_targets_providers:(selectionData,editable)=>{const el=editable.firstChild;if(!selectionData.documentSelectionIsInEditable&&childNodes(editable).length===1&&isEmptyBlock(el)&&el.matches(baseContainerGlobalSelector)){return[el];}else{return[];}},}),};}
return __exports;});;

/* /html_editor/static/src/main/position_plugin.js */
odoo.define('@html_editor/main/position_plugin',['@html_editor/utils/dom_traversal','@html_editor/plugin','@web/core/utils/timing','@web/core/utils/scrolling'],function(require){'use strict';let __exports={};const{ancestors}=require("@html_editor/utils/dom_traversal");const{Plugin}=require("@html_editor/plugin");const{throttleForAnimation}=require("@web/core/utils/timing");const{couldBeScrollableX,couldBeScrollableY}=require("@web/core/utils/scrolling");const PositionPlugin=__exports.PositionPlugin=class PositionPlugin extends Plugin{static id="position";resources={external_history_step_handlers:this.layoutGeometryChange.bind(this),history_reset_from_steps_handlers:this.layoutGeometryChange.bind(this),step_added_handlers:this.layoutGeometryChange.bind(this),};setup(){this.layoutGeometryChange=throttleForAnimation(this.layoutGeometryChange.bind(this));this.resizeObserver=new ResizeObserver(this.layoutGeometryChange);this.resizeObserver.observe(this.document.body);this.resizeObserver.observe(this.editable);this.addDomListener(window,"resize",this.layoutGeometryChange);if(this.window!==window){this.addDomListener(this.window,"resize",this.layoutGeometryChange);}
const scrollableElements=[this.editable,...ancestors(this.editable)].filter((node)=>couldBeScrollableX(node)||couldBeScrollableY(node));for(const scrollableElement of scrollableElements){this.addDomListener(scrollableElement,"scroll",()=>{this.layoutGeometryChange();});this.resizeObserver.observe(scrollableElement);}}
destroy(){this.resizeObserver.disconnect();super.destroy();}
layoutGeometryChange(){this.dispatchTo("layout_geometry_change_handlers");}}
return __exports;});;

/* /html_editor/static/src/main/power_buttons_plugin.js */
odoo.define('@html_editor/main/power_buttons_plugin',['@html_editor/plugin','@html_editor/utils/base_container','@html_editor/utils/blocks','@html_editor/utils/dom_info','@html_editor/utils/dom_traversal','@web/core/utils/objects'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{baseContainerGlobalSelector}=require("@html_editor/utils/base_container");const{closestBlock}=require("@html_editor/utils/blocks");const{isEditorTab,isEmptyBlock}=require("@html_editor/utils/dom_info");const{closestElement,descendants}=require("@html_editor/utils/dom_traversal");const{omit,pick}=require("@web/core/utils/objects");const PowerButtonsPlugin=__exports.PowerButtonsPlugin=class PowerButtonsPlugin extends Plugin{static id="powerButtons";static dependencies=["baseContainer","selection","position","localOverlay","powerbox","userCommand","history",];resources={layout_geometry_change_handlers:this.updatePowerButtons.bind(this),selectionchange_handlers:this.updatePowerButtons.bind(this),post_mount_component_handlers:this.updatePowerButtons.bind(this),};setup(){this.powerButtonsOverlay=this.dependencies.localOverlay.makeLocalOverlay("oe-power-buttons-overlay");this.createPowerButtons();}
createPowerButtons(){const composePowerButton=(item)=>{const command=this.dependencies.userCommand.getCommand(item.commandId);return{...pick(command,"description","icon"),...omit(item,"commandId","commandParams"),run:()=>command.run(item.commandParams),isAvailable:(selection)=>[command.isAvailable,item.isAvailable].filter(Boolean).every((predicate)=>predicate(selection)),};};const renderButton=({description,icon,text,run})=>{const btn=this.document.createElement("button");let className="power_button btn px-2 py-1 cursor-pointer";if(icon){const iconLibrary=icon.includes("fa-")?"fa":"oi";className+=` ${iconLibrary} ${icon}`;}else{const span=this.document.createElement("span");span.textContent=text;span.className="d-flex align-items-center text-nowrap";span.style.height="1em";btn.append(span);}
btn.className=className;btn.title=description;this.addDomListener(btn,"click",()=>this.applyCommand(run));return btn;};const powerButtonsDefinitions=this.getResource("power_buttons");const powerButtons=powerButtonsDefinitions.map(composePowerButton);this.descriptionToElementMap=new Map(powerButtons.map((pb)=>[pb,renderButton(pb)]));this.powerButtonsContainer=this.document.createElement("div");this.powerButtonsContainer.className=`o_we_power_buttons d-flex justify-content-center d-none`;this.powerButtonsContainer.append(...this.descriptionToElementMap.values());this.powerButtonsOverlay.append(this.powerButtonsContainer);}
updatePowerButtons(){this.powerButtonsContainer.classList.add("d-none");const{editableSelection,currentSelectionIsInEditable}=this.dependencies.selection.getSelectionData();if(!currentSelectionIsInEditable){return;}
const block=closestBlock(editableSelection.anchorNode);const element=closestElement(editableSelection.anchorNode);const blockRect=block.getBoundingClientRect();const editableRect=this.editable.getBoundingClientRect();if(editableSelection.isCollapsed&&block?.matches(baseContainerGlobalSelector)&&editableRect.bottom>blockRect.top&&isEmptyBlock(block)&&!descendants(block).some(isEditorTab)&&!this.services.ui.isSmall&&!closestElement(editableSelection.anchorNode,"td, th, li")&&!block.style.textAlign&&this.getResource("power_buttons_visibility_predicates").every((predicate)=>predicate(editableSelection))){this.powerButtonsContainer.classList.remove("d-none");const direction=closestElement(element,"[dir]")?.getAttribute("dir");this.powerButtonsContainer.setAttribute("dir",direction);for(const[{isAvailable},buttonElement]of this.descriptionToElementMap.entries()){const shouldHide=Boolean(!isAvailable(editableSelection));buttonElement.classList.toggle("d-none",shouldHide);}
this.setPowerButtonsPosition(block,blockRect,direction);}}
getPlaceholderWidth(block){let width;this.dependencies.history.ignoreDOMMutations(()=>{const clone=block.cloneNode(true);clone.innerText=clone.getAttribute("o-we-hint-text");clone.style.width="fit-content";clone.style.visibility="hidden";this.editable.appendChild(clone);width=clone.getBoundingClientRect().width;this.editable.removeChild(clone);});return width;}
setPowerButtonsPosition(block,blockRect,direction){const overlayStyles=this.powerButtonsOverlay.style;overlayStyles.top="0px";overlayStyles.left="0px";const buttonsRect=this.powerButtonsContainer.getBoundingClientRect();const placeholderWidth=this.getPlaceholderWidth(block)+20;if(direction==="rtl"){overlayStyles.left=blockRect.right-buttonsRect.width-buttonsRect.x-placeholderWidth+"px";}else{overlayStyles.left=blockRect.left-buttonsRect.x+placeholderWidth+"px";}
overlayStyles.top=blockRect.top-buttonsRect.top+"px";overlayStyles.height=blockRect.height+"px";}
async applyCommand(commandFn){const btns=[...this.powerButtonsContainer.querySelectorAll(".btn")];btns.forEach((btn)=>btn.classList.add("disabled"));await commandFn();btns.forEach((btn)=>btn.classList.remove("disabled"));}}
return __exports;});;

/* /html_editor/static/src/main/powerbox/powerbox.js */
odoo.define('@html_editor/main/powerbox/powerbox',['@odoo/owl'],function(require){'use strict';let __exports={};const{Component,onPatched,useEffect,useExternalListener,useRef}=require("@odoo/owl");const Powerbox=__exports.Powerbox=class Powerbox extends Component{static template="html_editor.Powerbox";static props={document:{validate:(doc)=>doc.constructor.name==="HTMLDocument"},close:Function,state:Object,activateCommand:Function,applyCommand:Function,};setup(){const ref=useRef("root");onPatched(()=>{const activeCommand=ref.el.querySelector(".o-we-command.active");if(activeCommand){activeCommand.scrollIntoView({block:"nearest",inline:"nearest"});}});this.mouseSelectionActive=false;const onMouseMove=()=>(this.mouseSelectionActive=true);useExternalListener(this.props.document,"mousemove",onMouseMove);useEffect((ownDoc,propsDoc)=>{if(ownDoc&&propsDoc&&ownDoc!==propsDoc){ownDoc.addEventListener("mousemove",onMouseMove);return()=>ownDoc.removeEventListener("mousemove",onMouseMove);}},()=>[ref.el?.ownerDocument,this.props.document]);}
get commands(){return this.props.state.commands;}
get currentIndex(){return this.props.state.currentIndex;}
get showCategories(){return this.props.state.showCategories;}
onScroll(){this.mouseSelectionActive=false;}
onMouseEnter(index){if(this.mouseSelectionActive){this.props.activateCommand(index);}}}
return __exports;});;

/* /html_editor/static/src/main/powerbox/powerbox_plugin.js */
odoo.define('@html_editor/main/powerbox/powerbox_plugin',['@html_editor/plugin','@odoo/owl','@web/core/l10n/translation','@web/core/utils/arrays','@html_editor/main/powerbox/powerbox','@html_editor/utils/resource','@web/core/utils/objects','@html_editor/utils/base_container','@html_editor/utils/dom_traversal'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{reactive}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{rotate}=require("@web/core/utils/arrays");const{Powerbox}=require("@html_editor/main/powerbox/powerbox");const{withSequence}=require("@html_editor/utils/resource");const{omit,pick}=require("@web/core/utils/objects");const{baseContainerGlobalSelector}=require("@html_editor/utils/base_container");const{closestElement}=require("@html_editor/utils/dom_traversal");const PowerboxPlugin=__exports.PowerboxPlugin=class PowerboxPlugin extends Plugin{static id="powerbox";static dependencies=["overlay","selection","history","userCommand"];static shared=["closePowerbox","getAvailablePowerboxCommands","openPowerbox","updatePowerbox",];resources={user_commands:{id:"openPowerbox",run:()=>this.openPowerbox({commands:this.getAvailablePowerboxCommands(),categories:this.getResource("powerbox_categories"),}),},powerbox_categories:[withSequence(10,{id:"structure",name:_t("Structure")}),withSequence(60,{id:"widget",name:_t("Widget")}),withSequence(100,{id:"modules",name:_t("Modules")}),],power_buttons:withSequence(100,{commandId:"openPowerbox",description:_t("More options"),icon:"oi-ellipsis-v",}),hints:withSequence(30,{selector:baseContainerGlobalSelector,text:_t('Type "/" for commands'),}),};setup(){this.overlay=this.dependencies.overlay.createOverlay(Powerbox);this.state=reactive({});this.overlayProps={document:this.document,close:()=>this.overlay.close(),state:this.state,activateCommand:(currentIndex)=>{this.state.currentIndex=currentIndex;},applyCommand:this.applyCommand.bind(this),};this.powerboxCommands=this.makePowerboxCommands();this.addDomListener(this.editable.ownerDocument,"keydown",this.onKeyDown);}
getAvailablePowerboxCommands(){const selection=this.dependencies.selection.getEditableSelection();const blacklistSelector=this.getResource("powerbox_blacklist_selectors").join(", ");if(blacklistSelector&&closestElement(selection.anchorNode).matches(blacklistSelector)){return[];}
return this.powerboxCommands.filter((cmd)=>cmd.isAvailable(selection));}
makePowerboxCommands(){const powerboxItems=this.getResource("powerbox_items");const categories=this.getResource("powerbox_categories");const categoryDict=Object.fromEntries(categories.map((category)=>[category.id,category]));return powerboxItems.map((item)=>{const command=this.dependencies.userCommand.getCommand(item.commandId);return{...pick(command,"title","description","icon"),...omit(item,"commandId","commandParams"),categoryName:categoryDict[item.categoryId].name,run:(context)=>command.run(item.commandParams,context),isAvailable:(selection)=>[command.isAvailable,item.isAvailable].filter(Boolean).every((predicate)=>predicate(selection)),};});}
openPowerbox({commands,categories,onApplyCommand=()=>{},onClose=()=>{}}={}){this.closePowerbox();if(!commands.length){return;}
this.onApplyCommand=onApplyCommand;this.onClose=onClose;this.updatePowerbox(commands,categories);}
updatePowerbox(commands,categories){if(categories){const orderCommands=[];for(const category of categories){orderCommands.push(...commands.filter((command)=>command.categoryId===category.id));}
commands=orderCommands;}
Object.assign(this.state,{showCategories:!!categories,commands,currentIndex:0,});this.overlay.open({props:this.overlayProps});}
closePowerbox(){if(!this.overlay.isOpen){return;}
this.onClose();this.overlay.close();}
onKeyDown(ev){if(!this.overlay.isOpen){return;}
const key=ev.key;switch(key){case"Escape":ev.stopImmediatePropagation();this.closePowerbox();break;case"Enter":case"Tab":ev.preventDefault();ev.stopImmediatePropagation();this.applyCommand(this.state.commands[this.state.currentIndex]);break;case"ArrowUp":{ev.preventDefault();this.state.currentIndex=rotate(this.state.currentIndex,this.state.commands,-1);break;}
case"ArrowDown":{ev.preventDefault();this.state.currentIndex=rotate(this.state.currentIndex,this.state.commands,1);break;}
case"ArrowLeft":case"ArrowRight":{this.closePowerbox();break;}}}
applyCommand(command){const context={};this.onApplyCommand(command,context);command.run(context);this.closePowerbox();}}
return __exports;});;

/* /html_editor/static/src/main/powerbox/search_powerbox_plugin.js */
odoo.define('@html_editor/main/powerbox/search_powerbox_plugin',['@web/core/utils/search','@html_editor/plugin'],function(require){'use strict';let __exports={};const{fuzzyLookup}=require("@web/core/utils/search");const{Plugin}=require("@html_editor/plugin");const SearchPowerboxPlugin=__exports.SearchPowerboxPlugin=class SearchPowerboxPlugin extends Plugin{static id="searchPowerbox";static dependencies=["powerbox","selection","history","input"];resources={beforeinput_handlers:this.onBeforeInput.bind(this),input_handlers:this.onInput.bind(this),delete_handlers:this.update.bind(this),post_undo_handlers:this.update.bind(this),post_redo_handlers:this.update.bind(this),};setup(){const categoryIds=new Set();for(const category of this.getResource("powerbox_categories")){if(categoryIds.has(category.id)){throw new Error(`Duplicate category id: ${category.id}`);}
categoryIds.add(category.id);}
this.categories=this.getResource("powerbox_categories");this.shouldUpdate=false;}
onBeforeInput(ev){if(ev.data==="/"){this.historySavePointRestore=this.dependencies.history.makeSavePoint();}}
onInput(ev){this.searchTerm=undefined;if(ev.data==="/"){this.openPowerbox();}else{this.update();}}
update(){if(!this.shouldUpdate){return;}
const selection=this.dependencies.selection.getEditableSelection();this.searchNode=selection.startContainer;if(!this.isSearching(selection)){this.dependencies.powerbox.closePowerbox();return;}
const searchTerm=this.searchNode.nodeValue.slice(this.offset+1,selection.endOffset);if(!searchTerm){this.dependencies.powerbox.updatePowerbox(this.enabledCommands,this.categories);return;}
if(searchTerm.includes(" ")){this.dependencies.powerbox.closePowerbox();return;}
const commands=this.filterCommands(searchTerm);if(!commands.length){this.dependencies.powerbox.closePowerbox();this.shouldUpdate=true;return;}
this.searchTerm=searchTerm;this.dependencies.powerbox.updatePowerbox(commands);}
filterCommands(searchTerm){return fuzzyLookup(searchTerm,this.enabledCommands,(cmd)=>[cmd.title,cmd.categoryName,cmd.description,...(cmd.keywords||[]),]);}
isSearching(selection){return(selection.endContainer===this.searchNode&&this.searchNode.nodeValue&&this.searchNode.nodeValue[this.offset]==="/"&&selection.endOffset>=this.offset);}
openPowerbox(){const selection=this.dependencies.selection.getEditableSelection();this.offset=selection.startOffset-1;this.enabledCommands=this.dependencies.powerbox.getAvailablePowerboxCommands();this.dependencies.powerbox.openPowerbox({commands:this.enabledCommands,categories:this.categories,onApplyCommand:(command,context)=>{context.searchTerm=this.searchTerm;this.historySavePointRestore?.();},onClose:()=>{this.shouldUpdate=false;},});this.shouldUpdate=true;}}
return __exports;});;

/* /html_editor/static/src/main/selection_placeholder_plugin.js */
odoo.define('@html_editor/main/selection_placeholder_plugin',['@html_editor/plugin','@html_editor/utils/blocks','@html_editor/utils/dom','@html_editor/utils/dom_info','@html_editor/utils/dom_traversal','@html_editor/utils/resource'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{closestBlock,isBlock}=require("@html_editor/utils/blocks");const{fillEmpty}=require("@html_editor/utils/dom");const{allowsParagraphRelatedElements,isEmpty,isNotEditableNode,}=require("@html_editor/utils/dom_info");const{closestElement,getAdjacentNextSiblings,getAdjacentPreviousSiblings,}=require("@html_editor/utils/dom_traversal");const{withSequence}=require("@html_editor/utils/resource");const BLINKER_CLASS="o-horizontal-caret";const PLACEHOLDER_ATTRIBUTE="data-selection-placeholder";const PLACEHOLDER_SELECTOR=`[${PLACEHOLDER_ATTRIBUTE}]`;const SelectionPlaceholderPlugin=__exports.SelectionPlaceholderPlugin=class SelectionPlaceholderPlugin extends Plugin{static id="selectionPlaceholder";static dependencies=["baseContainer","history","selection"];resources={external_history_step_handlers:this.updatePlaceholders.bind(this),normalize_handlers:this.updatePlaceholders.bind(this),step_added_handlers:this.updatePlaceholders.bind(this),selectionchange_handlers:(selectionData)=>this.onSelectionChange(selectionData),clean_for_save_handlers:withSequence(0,({root})=>{for(const placeholder of root.querySelectorAll(PLACEHOLDER_SELECTOR)){placeholder.remove();}}),split_element_block_overrides:({blockToSplit})=>{if(blockToSplit.hasAttribute(PLACEHOLDER_ATTRIBUTE)){this.persistPlaceholder(blockToSplit);return true;}},selection_blocker_predicates:(blocker)=>{if((blocker.nodeType===Node.ELEMENT_NODE&&blocker.hasAttribute(PLACEHOLDER_ATTRIBUTE))||!isBlock(blocker)){return false;}else if(isNotEditableNode(blocker)){return true;}},selection_placeholder_container_predicates:(container)=>{if(!container.isContentEditable||!allowsParagraphRelatedElements(container)){return false;}else if(container.getAttribute("contenteditable")==="true"){return true;}},power_buttons_visibility_predicates:({anchorNode})=>!closestElement(anchorNode,PLACEHOLDER_SELECTOR),move_node_blacklist_selectors:PLACEHOLDER_SELECTOR,system_node_selectors:PLACEHOLDER_SELECTOR,system_classes:BLINKER_CLASS,};setup(){this.addDomListener(this.editable,"focusout",()=>this.editable.querySelectorAll(`.${BLINKER_CLASS}`).forEach(this.cleanBlinker),{isGlobal:true});this.addDomListener(this.editable,"focusin",()=>this.resetBlinkerClasses(),{isGlobal:true,});}
updatePlaceholders(){const checkPredicate=(resourceId,node)=>{const results=this.getResource(resourceId).map((p)=>p(node)).filter((result)=>result!==undefined);return!!results.length&&results.every(Boolean);};const isSelectionBlocker=(node)=>checkPredicate("selection_blocker_predicates",node);const placeholderParents=[this.editable,...this.editable.querySelectorAll("*")].filter((container)=>checkPredicate("selection_placeholder_container_predicates",container));for(const placeholder of this.editable.querySelectorAll(PLACEHOLDER_SELECTOR)){const siblings=["before","after"].map((side)=>getNonWhitespaceSibling(side,placeholder));if(!isEmpty(placeholder)||!siblings.filter(Boolean).length){this.persistPlaceholder(placeholder);}else if(!placeholderParents.includes(placeholder.parentElement)||!siblings.every((sibling)=>!sibling||isSelectionBlocker(sibling))){placeholder.remove();}else{this.applyMargin(placeholder,...siblings);}}
const blockers=[...new Set(placeholderParents.flatMap((element)=>[...element.children])),].filter((element)=>isSelectionBlocker(element));for(const blocker of blockers){for(const side of["before","after"]){const sibling=getNonWhitespaceSibling(side,blocker);if(!sibling||isSelectionBlocker(sibling)){const placeholder=this.dependencies.baseContainer.createBaseContainer();fillEmpty(placeholder);placeholder.setAttribute(PLACEHOLDER_ATTRIBUTE,"");const siblings=side==="before"?[sibling,blocker]:[blocker,sibling];this.applyMargin(placeholder,...siblings);blocker[side](placeholder);}}}
this.resetBlinkerClasses();}
applyMargin(placeholder,previous,next){const marginBefore=previous?getMargin(previous,"bottom"):0;const marginAfter=next?getMargin(next,"top"):0;const middleMargin=Math.abs(marginBefore-marginAfter)/2;if(middleMargin){const positiveMargin=Math.abs(middleMargin-(marginAfter>=marginBefore?marginAfter:marginBefore));const negativeMargin=-1-middleMargin;const marginTop=marginAfter>=marginBefore?positiveMargin:negativeMargin;const marginBottom=marginAfter>=marginBefore?negativeMargin:positiveMargin;placeholder.style.margin=`${marginTop}px 0 ${marginBottom}px`;}}
persistPlaceholder(placeholder){placeholder.removeAttribute(PLACEHOLDER_ATTRIBUTE);this.cleanBlinker(placeholder);placeholder.removeAttribute("style");}
cleanBlinker(blinker){if(blinker.className===BLINKER_CLASS){blinker.removeAttribute("class");}else{blinker.classList.remove(BLINKER_CLASS);}}
resetBlinkerClasses(selection=this.dependencies.selection.getEditableSelection()){const anchorPlaceholder=selection.isCollapsed&&closestElement(selection.anchorNode,PLACEHOLDER_SELECTOR);if(anchorPlaceholder&&this.document.activeElement.contains(anchorPlaceholder)){anchorPlaceholder.classList.add(BLINKER_CLASS);}
for(const blinker of this.editable.querySelectorAll(`.${BLINKER_CLASS}`)){if(blinker!==anchorPlaceholder||!this.document.activeElement.contains(blinker)){this.cleanBlinker(blinker);}}}
onSelectionChange(selectionData){const selection=selectionData.editableSelection;this.resetBlinkerClasses(selection);if(selection.isCollapsed){const anchor=closestElement(selection.anchorNode);if(closestBlock(anchor.parentElement)===this.editable&&anchor?.hasAttribute(PLACEHOLDER_ATTRIBUTE)&&!getNonWhitespaceSibling("next",anchor)){this.persistPlaceholder(anchor);this.dependencies.history.addStep();}}}}
const getNonWhitespaceSibling=(side,node)=>{const siblings=side==="before"?getAdjacentPreviousSiblings(node):getAdjacentNextSiblings(node);return siblings.find((sibling)=>!(sibling.nodeType===Node.TEXT_NODE&&!sibling.textContent.trim()));};const getMargin=(element,side)=>+element.ownerDocument.defaultView.getComputedStyle(element)
[side==="top"?"marginTop":"marginBottom"].replace("px","");return __exports;});;

/* /html_editor/static/src/main/separator_plugin.js */
odoo.define('@html_editor/main/separator_plugin',['@web/core/l10n/translation','@html_editor/plugin','@html_editor/utils/blocks','@html_editor/utils/dom_traversal','@html_editor/utils/dom_info','@html_editor/core/selection_plugin','@html_editor/utils/dom','@html_editor/utils/resource'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{Plugin}=require("@html_editor/plugin");const{closestBlock}=require("@html_editor/utils/blocks");const{closestElement,firstLeaf,selectElements}=require("@html_editor/utils/dom_traversal");const{isEmptyBlock,isListItemElement,paragraphRelatedElementsSelector,}=require("@html_editor/utils/dom_info");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const{removeClass}=require("@html_editor/utils/dom");const{withSequence}=require("@html_editor/utils/resource");const{fillEmpty}=require("@html_editor/utils/dom");const SeparatorPlugin=__exports.SeparatorPlugin=class SeparatorPlugin extends Plugin{static id="separator";static dependencies=["selection","history","split","delete","lineBreak","baseContainer"];resources={user_commands:[{id:"insertSeparator",title:_t("Separator"),description:_t("Insert a horizontal rule separator"),icon:"fa-minus",run:this.insertSeparator.bind(this),isAvailable:isHtmlContentSupported,},],powerbox_items:withSequence(1,{categoryId:"structure",commandId:"insertSeparator",}),content_not_editable_providers:(rootEl)=>[...selectElements(rootEl,"hr")],contenteditable_to_remove_selector:"hr[contenteditable]",shorthands:[{pattern:/^---$/,commandId:"insertSeparator",},],selectionchange_handlers:this.handleSelectionInHr.bind(this),deselect_custom_selected_nodes_handlers:this.deselectHR.bind(this),clean_handlers:this.deselectHR.bind(this),clean_for_save_handlers:({root})=>{this.deselectHR(root);},};insertSeparator(){const selection=this.dependencies.selection.getSelectionData().deepEditableSelection;const block=closestBlock(selection.startContainer);const element=closestElement(selection.startContainer,paragraphRelatedElementsSelector)||(block&&!isListItemElement(block)?block:null);if(element&&element!==this.editable){const sep=this.document.createElement("hr");const firstLeafNode=firstLeaf(block);if(isEmptyBlock(element)||(selection.anchorNode===firstLeafNode&&selection.anchorOffset===0)){element.before(sep);}else{element.after(sep);const baseContainer=this.dependencies.baseContainer.createBaseContainer();fillEmpty(baseContainer);sep.after(baseContainer);this.dependencies.selection.setCursorStart(baseContainer);}}
this.dependencies.history.addStep();}
deselectHR(root=this.editable){for(const hr of root.querySelectorAll(".o_selected_hr")){removeClass(hr,"o_selected_hr");}}
handleSelectionInHr(){this.deselectHR();const targetedNodes=this.dependencies.selection.getTargetedNodes();for(const node of targetedNodes){if(node.nodeName==="HR"){node.classList.toggle("o_selected_hr",true);}}}}
return __exports;});;

/* /html_editor/static/src/main/star_plugin.js */
odoo.define('@html_editor/main/star_plugin',['@html_editor/plugin','@html_editor/utils/html','@web/core/l10n/translation','@html_editor/core/selection_plugin'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{parseHTML}=require("@html_editor/utils/html");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const StarPlugin=__exports.StarPlugin=class StarPlugin extends Plugin{static id="star";static dependencies=["dom","history"];resources={user_commands:[{id:"addStars",title:_t("Stars"),description:_t("Insert a rating"),icon:"fa-star",run:this.addStars.bind(this),isAvailable:isHtmlContentSupported,},],powerbox_items:[{title:_t("3 Stars"),description:_t("Insert a rating over 3 stars"),categoryId:"widget",icon:"fa-star-o",commandId:"addStars",commandParams:{length:3},},{title:_t("5 Stars"),description:_t("Insert a rating over 5 stars"),categoryId:"widget",commandId:"addStars",commandParams:{length:5},},],selectors_for_feff_providers:()=>".o_stars",};setup(){this.addDomListener(this.editable,"pointerdown",this.onMouseDown);}
onMouseDown(ev){const node=ev.target;const isStar=(node)=>node.nodeType===Node.ELEMENT_NODE&&(node.classList.contains("fa-star")||node.classList.contains("fa-star-o"));if(isStar(node)&&node.parentElement&&node.parentElement.className.includes("o_stars")){const allStars=Array.from(node.parentElement.childNodes).filter(isStar);const currentStarIndex=allStars.indexOf(node);const previousStars=allStars.slice(0,currentStarIndex);const nextStars=allStars.slice(currentStarIndex+1);if(nextStars.length||previousStars.length){const shouldToggleOff=node.classList.contains("fa-star")&&(!nextStars[0]||!nextStars[0].classList.contains("fa-star"));for(const star of[...previousStars,node]){star.classList.toggle("fa-star-o",shouldToggleOff);star.classList.toggle("fa-star",!shouldToggleOff);}
for(const star of nextStars){star.classList.toggle("fa-star-o",true);star.classList.toggle("fa-star",false);}
this.dependencies.history.addStep();}
ev.stopPropagation();ev.preventDefault();}}
addStars({length}){const stars=Array.from({length},()=>'<i class="fa fa-star-o"></i>').join("");const html=`<span contenteditable="false" class="o_stars">${stars}</span>`;this.dependencies.dom.insert(parseHTML(this.document,html));this.dependencies.history.addStep();}}
return __exports;});;

/* /html_editor/static/src/main/table/table_align_plugin.js */
odoo.define('@html_editor/main/table/table_align_plugin',['@html_editor/plugin','@html_editor/utils/dom_traversal','@web/core/l10n/translation','@odoo/owl','@html_editor/main/table/table_align_selector'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{closestElement}=require("@html_editor/utils/dom_traversal");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{reactive}=require("@odoo/owl");const{TableAlignSelector}=require("@html_editor/main/table/table_align_selector");const verticalAlignmentItems=[{mode:"top",template:"html_editor.VerticalAlignTop",},{mode:"middle",template:"html_editor.VerticalAlignMiddle",},{mode:"bottom",template:"html_editor.VerticalAlignBottom",},];const TableAlignPlugin=__exports.TableAlignPlugin=class TableAlignPlugin extends Plugin{static id="tableAlign";static dependencies=["history","selection"];resources={user_commands:[{id:"alignTop",run:()=>this.setVerticalAlignment("top"),},{id:"alignMiddle",run:()=>this.setVerticalAlignment("middle"),},{id:"alignBottom",run:()=>this.setVerticalAlignment("bottom"),},],toolbar_items:[{id:"table_alignment",groupId:"layout",description:_t("Vertical align table cells content"),isAvailable:()=>this.dependencies.selection.getTargetedNodes().some((node)=>closestElement(node,"td, th")),Component:TableAlignSelector,props:{getItems:()=>verticalAlignmentItems,getDisplay:()=>this.verticalAlignMode,onSelected:(item)=>{this.setVerticalAlignment(item.mode);},},},],selectionchange_handlers:this.updateVerticalAlignParams.bind(this),post_undo_handlers:this.updateVerticalAlignParams.bind(this),post_redo_handlers:this.updateVerticalAlignParams.bind(this),remove_all_formats_handlers:this.setVerticalAlignment.bind(this),has_format_predicates:(node)=>closestElement(node,"td, th")?.style.verticalAlign,};setup(){this.verticalAlignMode=reactive({displayName:""});}
get currentVerticalAlign(){const targetedCells=this.dependencies.selection.getTargetedNodes().map((node)=>closestElement(node,"td, th")).filter(Boolean);if(!targetedCells.length){return"";}
const verticalAlign=targetedCells[0].style.verticalAlign;return verticalAlign&&targetedCells.every((cell)=>cell.style.verticalAlign===verticalAlign)?verticalAlign:"";}
setVerticalAlignment(mode=""){const targetedCells=new Set(this.dependencies.selection.getTargetedNodes().map((node)=>closestElement(node,"td, th")).filter(Boolean));let isAlignmentUpdated=false;for(const cell of targetedCells){if(cell.isContentEditable&&cell.style.verticalAlign!==mode){cell.style.verticalAlign=mode;isAlignmentUpdated=true;}}
if(isAlignmentUpdated){this.dependencies.history.addStep();}
this.updateVerticalAlignParams();}
updateVerticalAlignParams(){this.verticalAlignMode.displayName=this.currentVerticalAlign;}}
return __exports;});;

/* /html_editor/static/src/main/table/table_align_selector.js */
odoo.define('@html_editor/main/table/table_align_selector',['@odoo/owl','@web/core/dropdown/dropdown','@html_editor/main/toolbar/toolbar','@html_editor/dropdown_autovisibility_hook','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Component,useState}=require("@odoo/owl");const{Dropdown}=require("@web/core/dropdown/dropdown");const{toolbarButtonProps}=require("@html_editor/main/toolbar/toolbar");const{useDropdownAutoVisibility}=require("@html_editor/dropdown_autovisibility_hook");const{useChildRef}=require("@web/core/utils/hooks");const TableAlignSelector=__exports.TableAlignSelector=class TableAlignSelector extends Component{static template="html_editor.TableAlignSelector";static props={getItems:Function,getDisplay:Function,onSelected:Function,...toolbarButtonProps,};static components={Dropdown};setup(){this.items=this.props.getItems();this.state=useState(this.props.getDisplay());this.menuRef=useChildRef();useDropdownAutoVisibility(this.env.overlayState,this.menuRef);}
onSelected(item){this.props.onSelected(item);}}
return __exports;});;

/* /html_editor/static/src/main/table/table_menu.js */
odoo.define('@html_editor/main/table/table_menu',['@html_editor/utils/dom_traversal','@odoo/owl','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_item','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{closestElement}=require("@html_editor/utils/dom_traversal");const{Component}=require("@odoo/owl");const{Dropdown}=require("@web/core/dropdown/dropdown");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const TableMenu=__exports.TableMenu=class TableMenu extends Component{static template="html_editor.TableMenu";static props={type:String,moveColumn:Function,addColumn:Function,removeColumn:Function,moveRow:Function,addRow:Function,removeRow:Function,turnIntoHeader:Function,turnIntoRow:Function,resetRowHeight:Function,resetColumnWidth:Function,resetTableSize:Function,clearColumnContent:Function,clearRowContent:Function,overlay:Object,dropdownState:Object,target:{validate:(el)=>el.nodeType===Node.ELEMENT_NODE},direction:{type:String,optional:true},};static defaultProps={direction:"ltr"};static components={Dropdown,DropdownItem};setup(){if(this.props.type==="column"){this.isFirst=this.props.target.cellIndex===0;this.isLast=!this.props.target.nextElementSibling;}else{const tr=this.props.target.parentElement;this.isFirst=!tr.previousElementSibling;this.isLast=!tr.nextElementSibling;this.isTableHeader=[...tr.children][0].nodeName==="TH";}
this.items=this.props.type==="column"?this.colItems():this.rowItems();}
get hasCustomTableSize(){const table=closestElement(this.props.target,"table");if(!table){return false;}
const rows=[...table.rows];const firstRowCells=[...rows[0].cells];const rowHasHeight=rows.some((row)=>row.style.height);const cellHasWidth=firstRowCells.some((cell)=>cell.style.width);return rowHasHeight||cellHasWidth;}
get hasCustomRowHeight(){return!!this.props.target.closest("tr").style.height;}
get hasCustomColumnWidth(){return(!!this.props.target.closest("td")?.style?.width||!!this.props.target.closest("th")?.style?.width);}
onSelected(item){item.action(this.props.target);this.props.overlay.close();}
colItems(){const ltr=this.props.direction==="ltr";return[!this.isFirst&&{name:"move_left",icon:"fa-chevron-left disabled",text:ltr?_t("Move left"):_t("Move right"),action:this.props.moveColumn.bind(this,"left"),},!this.isLast&&{name:"move_right",icon:"fa-chevron-right",text:ltr?_t("Move right"):_t("Move left"),action:this.props.moveColumn.bind(this,"right"),},{name:"insert_left",icon:"fa-plus",text:ltr?_t("Insert left"):_t("Insert right"),action:this.props.addColumn.bind(this,"before"),},{name:"insert_right",icon:"fa-plus",text:ltr?_t("Insert right"):_t("Insert left"),action:this.props.addColumn.bind(this,"after"),},{name:"delete",icon:"fa-trash",text:_t("Delete"),action:this.props.removeColumn.bind(this),},this.hasCustomColumnWidth&&{name:"reset_column_size",icon:"fa-table",text:_t("Reset column size"),action:(target)=>this.props.resetColumnWidth(target.closest("td, th")),},this.hasCustomTableSize&&{name:"reset_table_size",icon:"fa-table",text:_t("Reset table size"),action:(target)=>this.props.resetTableSize(target.closest("table")),},{name:"clear_content",icon:"fa-times-circle",text:_t("Clear content"),action:this.props.clearColumnContent.bind(this),},].filter(Boolean);}
rowItems(){return[this.isFirst&&!this.isTableHeader&&{name:"make_header",icon:"fa-th-large",text:_t("Turn into header"),action:(target)=>this.props.turnIntoHeader(target.parentElement),},this.isFirst&&this.isTableHeader&&{name:"remove_header",icon:"fa-table",text:_t("Turn into row"),action:(target)=>this.props.turnIntoRow(target.parentElement),},!this.isFirst&&{name:"move_up",icon:"fa-chevron-up",text:_t("Move up"),action:(target)=>this.props.moveRow("up",target.parentElement),},!this.isLast&&{name:"move_down",icon:"fa-chevron-down",text:_t("Move down"),action:(target)=>this.props.moveRow("down",target.parentElement),},!this.isTableHeader&&{name:"insert_above",icon:"fa-plus",text:_t("Insert above"),action:(target)=>this.props.addRow("before",target.parentElement),},{name:"insert_below",icon:"fa-plus",text:_t("Insert below"),action:(target)=>this.props.addRow("after",target.parentElement),},{name:"delete",icon:"fa-trash",text:_t("Delete"),action:(target)=>this.props.removeRow(target.parentElement),},this.hasCustomRowHeight&&{name:"reset_row_size",icon:"fa-table",text:_t("Reset row size"),action:(target)=>this.props.resetRowHeight(target.closest("tr")),},this.hasCustomTableSize&&{name:"reset_table_size",icon:"fa-table",text:_t("Reset table size"),action:(target)=>this.props.resetTableSize(target.closest("table")),},{name:"clear_content",icon:"fa-times-circle",text:_t("Clear content"),action:(target)=>this.props.clearRowContent(target.parentElement),},].filter(Boolean);}}
return __exports;});;

/* /html_editor/static/src/main/table/table_picker.js */
odoo.define('@html_editor/main/table/table_picker',['@odoo/owl'],function(require){'use strict';let __exports={};const{Component,useExternalListener,useState}=require("@odoo/owl");const TablePicker=__exports.TablePicker=class TablePicker extends Component{static template="html_editor.TablePicker";static props={insertTable:Function,editable:{validate:(el)=>el.nodeType===Node.ELEMENT_NODE,},overlay:Object,direction:String,};setup(){this.state=useState({cols:3,rows:3,});useExternalListener(this.props.editable.ownerDocument,"keydown",(ev)=>{ev.stopPropagation();const key=ev.key;const isRTL=this.props.direction==="rtl";switch(key){case"Enter":ev.preventDefault();this.insertTable();break;case"ArrowUp":ev.preventDefault();if(this.state.rows>1){this.state.rows-=1;}
break;case"ArrowDown":this.state.rows+=1;ev.preventDefault();break;case"ArrowLeft":ev.preventDefault();if(isRTL){this.state.cols+=1;}else{if(this.state.cols>1){this.state.cols-=1;}}
break;case"ArrowRight":ev.preventDefault();if(isRTL){if(this.state.cols>1){this.state.cols-=1;}}else{this.state.cols+=1;}
break;default:ev.stopImmediatePropagation();this.props.overlay.close();break;}},{capture:true});}
updateSize(cols,rows){this.state.cols=cols;this.state.rows=rows;}
insertTable(){this.props.insertTable({cols:this.state.cols,rows:this.state.rows});this.props.overlay.close();}}
return __exports;});;

/* /html_editor/static/src/main/table/table_plugin.js */
odoo.define('@html_editor/main/table/table_plugin',['@html_editor/plugin','@html_editor/utils/base_container','@html_editor/utils/blocks','@html_editor/utils/dom','@html_editor/utils/dom_info','@html_editor/utils/dom_traversal','@html_editor/utils/html','@html_editor/utils/position','@html_editor/utils/resource','@html_editor/utils/selection','@html_editor/utils/table','@web/core/browser/feature_detection','@web/core/hotkeys/hotkey_service','@html_editor/core/selection_plugin'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{baseContainerGlobalSelector}=require("@html_editor/utils/base_container");const{isBlock}=require("@html_editor/utils/blocks");const{fillEmpty,fillShrunkPhrasingParent,removeClass,splitTextNode,}=require("@html_editor/utils/dom");const{getDeepestPosition,isProtected,isProtecting,isEmptyBlock,isTextNode,nextLeaf,previousLeaf,isTableCell,}=require("@html_editor/utils/dom_info");const{ancestors,closestElement,createDOMPathGenerator,descendants,firstLeaf,lastLeaf,}=require("@html_editor/utils/dom_traversal");const{parseHTML}=require("@html_editor/utils/html");const{DIRECTIONS,leftPos,rightPos,nodeSize}=require("@html_editor/utils/position");const{withSequence}=require("@html_editor/utils/resource");const{findInSelection}=require("@html_editor/utils/selection");const{getColumnIndex,getRowIndex,getTableCells}=require("@html_editor/utils/table");const{isBrowserFirefox}=require("@web/core/browser/feature_detection");const{getActiveHotkey}=require("@web/core/hotkeys/hotkey_service");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const BORDER_SENSITIVITY=__exports.BORDER_SENSITIVITY=5;const tableInnerComponents=new Set(["THEAD","TBODY","TFOOT","TR","TH","TD"]);function isUnremovableTableComponent(node,root){if(!tableInnerComponents.has(node.nodeName)){return false;}
if(!root){return true;}
const closestTable=closestElement(node,"table");return!root.contains(closestTable);}
const TablePlugin=__exports.TablePlugin=class TablePlugin extends Plugin{static id="table";static dependencies=["baseContainer","dom","history","selection","delete","split","color",];static shared=["insertTable","addColumn","addRow","removeColumn","removeRow","moveColumn","turnIntoHeader","turnIntoRow","moveRow","resetRowHeight","resetColumnWidth","resetTableSize","clearColumnContent","clearRowContent",];resources={user_commands:[{id:"insertTable",run:(params)=>{this.insertTable(params);},isAvailable:isHtmlContentSupported,},],toolbar_namespace_providers:[withSequence(90,(targetedNodes,editableSelection)=>closestElement(editableSelection.anchorNode,".o_selected_td")&&"compact"),],selectionchange_handlers:this.updateSelectionTable.bind(this),clipboard_content_processors:this.processContentForClipboard.bind(this),clean_for_save_handlers:({root})=>this.deselectTable(root),before_line_break_handlers:this.resetTableSelection.bind(this),before_split_block_handlers:this.resetTableSelection.bind(this),tab_overrides:withSequence(20,this.handleTab.bind(this)),shift_tab_overrides:withSequence(20,this.handleShiftTab.bind(this)),delete_range_overrides:this.handleDeleteRange.bind(this),color_apply_overrides:this.applyTableColor.bind(this),unremovable_node_predicates:isUnremovableTableComponent,unsplittable_node_predicates:(node)=>node.nodeName==="TABLE"||tableInnerComponents.has(node.nodeName),fully_selected_node_predicates:(node)=>!!closestElement(node,".o_selected_td"),targeted_nodes_processors:this.adjustTargetedNodes.bind(this),move_node_whitelist_selectors:"table",selection_blocker_predicates:(node)=>{if(node.nodeName==="TABLE"){return true;}},selection_placeholder_container_predicates:(container)=>{if(container.nodeName==="TABLE"){return false;}else if(["TD","TH"].includes(container.nodeName)){return true;}},normalize_handlers:this.distributeTableColorsToAllCells.bind(this),};setup(){this.addDomListener(this.editable,"mousedown",this.onMousedown);this.addDomListener(this.editable,"mouseup",this.onMouseup);this.addDomListener(this.editable,"keydown",(ev)=>{this._isKeyDown=true;const arrowHandled=["arrowup","control+arrowup","arrowdown","control+arrowdown"];if(arrowHandled.includes(getActiveHotkey(ev))){this.navigateCell(ev);}
const shiftArrowHandled=["shift+arrowup","shift+arrowright","shift+arrowdown","shift+arrowleft","control+shift+arrowup","control+shift+arrowright","control+shift+arrowdown","control+shift+arrowleft",];if(shiftArrowHandled.includes(getActiveHotkey(ev))){this.isShiftArrowKeyboardSelection=true;this.updateTableKeyboardSelection(ev);}});this.onMousemove=this.onMousemove.bind(this);}
handleTab(){const selection=this.dependencies.selection.getEditableSelection();const inTable=closestElement(selection.anchorNode,"table");if(inTable){const shouldAddNewRow=!this.shiftCursorToTableCell(1);if(shouldAddNewRow){this.addRow("after",findInSelection(selection,"tr"));this.shiftCursorToTableCell(1);this.dependencies.history.addStep();}
return true;}}
handleShiftTab(){const selection=this.dependencies.selection.getEditableSelection();const inTable=closestElement(selection.anchorNode,"table");if(inTable){this.shiftCursorToTableCell(-1);return true;}}
distributeTableColorsToAllCells(root){[...root.querySelectorAll("table")].filter((table)=>table.style["color"]||table.style["backgroundColor"]).forEach((table)=>{const tds=table.querySelectorAll("td");for(const td of tds){td.style["color"]=td.style["color"]||table.style["color"];td.style["backgroundColor"]=td.style["backgroundColor"]||table.style["backgroundColor"];}
table.style["color"]="";table.style["backgroundColor"]="";});}
createTable({rows=2,cols=2}={}){const baseContainer=this.dependencies.baseContainer.createBaseContainer();fillShrunkPhrasingParent(baseContainer);const baseContainerHtml=baseContainer.outerHTML;const tdsHtml=new Array(cols).fill(`<td>${baseContainerHtml}</td>`).join("");const trsHtml=new Array(rows).fill(`<tr>${tdsHtml}</tr>`).join("");const tableHtml=`<table class="table table-bordered o_table"><tbody>${trsHtml}</tbody></table>`;return parseHTML(this.document,tableHtml);}
_insertTable({rows=2,cols=2}={}){const newTable=this.createTable({rows,cols});let sel=this.dependencies.selection.getEditableSelection();if(!sel.isCollapsed){this.dependencies.delete.deleteSelection();}
while(!isBlock(sel.anchorNode)){const anchorNode=sel.anchorNode;const isTextNode=anchorNode.nodeType===Node.TEXT_NODE;const newAnchorNode=isTextNode?splitTextNode(anchorNode,sel.anchorOffset,DIRECTIONS.LEFT)+1&&anchorNode:this.dependencies.split.splitElement(anchorNode,sel.anchorOffset).shift();const newPosition=rightPos(newAnchorNode);sel=this.dependencies.selection.setSelection({anchorNode:newPosition[0],anchorOffset:newPosition[1]},{normalize:false});}
const[table]=this.dependencies.dom.insert(newTable);return table;}
insertTable({rows=2,cols=2}={}){const table=this._insertTable({rows,cols});this.dependencies.selection.setCursorStart(table.querySelector(baseContainerGlobalSelector));this.dependencies.history.addStep();}
addColumn(position,reference){const columnIndex=getColumnIndex(reference);const table=closestElement(reference,"table");const tableWidth=table.style.width&&parseFloat(table.style.width);const referenceColumn=table.querySelectorAll(`tr :is(td, th):nth-of-type(${columnIndex + 1})`);const referenceCellWidth=reference.style.width?parseFloat(reference.style.width):reference.clientWidth;const firstRow=table.querySelector("tr");const firstRowCells=[...firstRow.children].filter((child)=>child.nodeName==="TD"||child.nodeName==="TH");let totalWidth=0;if(tableWidth){for(const cell of firstRowCells){const width=parseFloat(cell.style.width);cell.style.width=width+"px";const newWidth=Math.max(Math.round((width*tableWidth)/(tableWidth+referenceCellWidth-1)),13);cell.style.width=newWidth+"px";totalWidth+=newWidth;}}
referenceColumn.forEach((cell,rowIndex)=>{const newCell=this.document.createElement(cell.tagName);const baseContainer=this.dependencies.baseContainer.createBaseContainer();baseContainer.append(this.document.createElement("br"));newCell.append(baseContainer);cell[position](newCell);if(rowIndex===0&&cell.classList.contains("o_table_header")){newCell.classList.add("o_table_header");}
if(rowIndex===0&&tableWidth){newCell.style.width=cell.style.width;totalWidth+=parseFloat(cell.style.width);}});if(tableWidth){if(totalWidth!==tableWidth-1){firstRowCells[firstRowCells.length-1].style.width=parseFloat(firstRowCells[firstRowCells.length-1].style.width)+
(tableWidth-totalWidth-1)+"px";}
table.style.width=tableWidth+"px";}}
addRow(position,reference){const referenceRowHeight=reference.style.height&&parseFloat(reference.style.height);const newRow=this.document.createElement("tr");if(referenceRowHeight){newRow.style.height=referenceRowHeight+"px";}
const cells=reference.querySelectorAll("td, th");const referenceRowWidths=[...cells].map((cell)=>cell.style.width);newRow.append(...Array.from(cells).map(()=>{const td=this.document.createElement("td");const baseContainer=this.dependencies.baseContainer.createBaseContainer();baseContainer.append(this.document.createElement("br"));td.append(baseContainer);return td;}));reference[position](newRow);if(referenceRowHeight){newRow.style.height=referenceRowHeight+"px";}
if(getRowIndex(newRow)===0){let columnIndex=0;for(const column of newRow.children){column.style.width=referenceRowWidths[columnIndex];cells[columnIndex].style.width="";columnIndex++;}}}
turnIntoHeader(reference){const preserveSelection=this.dependencies.selection.preserveSelection();[...reference.children].forEach((td)=>{if(td.nodeName=="TD"){const th=this.document.createElement("th");if(td.style?.cssText.length){th.style.cssText=td.style?.cssText;}
th.classList.add("o_table_header");th.append(...td.childNodes);td.replaceWith(th);}});preserveSelection.restore();}
turnIntoRow(reference){const preserveSelection=this.dependencies.selection.preserveSelection();[...reference.children].forEach((th)=>{if(th.nodeName=="TH"){const td=this.document.createElement("td");if(th.style?.cssText.length){td.style.cssText=th.style?.cssText;}
td.append(...th.childNodes);th.replaceWith(td);}});preserveSelection.restore();}
removeColumn(cell){const table=closestElement(cell,"table");const cells=[...closestElement(cell,"tr").querySelectorAll("th, td")];const index=cells.findIndex((td)=>td===cell);const siblingCell=cells[index-1]||cells[index+1];table.querySelectorAll(`tr :is(td, th):nth-of-type(${index + 1})`).forEach((td)=>td.remove());siblingCell?this.dependencies.selection.setCursorStart(siblingCell):this.deleteTable(table);}
removeRow(row){const table=closestElement(row,"table");const siblingRow=row.previousElementSibling||row.nextElementSibling;row.remove();siblingRow?this.dependencies.selection.setCursorStart(siblingRow.querySelector("td, th")):this.deleteTable(table);}
moveColumn(position,cell){const columnIndex=getColumnIndex(cell);const nColumns=cell.parentElement.children.length;if(columnIndex<0||(position==="left"&&columnIndex===0)||(position!=="left"&&columnIndex===nColumns-1)){return;}
const trs=cell.parentElement.parentElement.children;const tdsToMove=[...trs].map((tr)=>tr.children[columnIndex]);const selectionToRestore=this.dependencies.selection.getEditableSelection();if(position==="left"){tdsToMove.forEach((td)=>td.previousElementSibling.before(td));}else{tdsToMove.forEach((td)=>td.nextElementSibling.after(td));}
this.dependencies.selection.setSelection(selectionToRestore);}
moveRow(position,row){const selectionToRestore=this.dependencies.selection.getEditableSelection();let adjustedRow;if(position==="up"){const isPreviousRowHeader=[...row.previousElementSibling.children][0].nodeName==="TH";row.previousElementSibling?.before(row);adjustedRow=row;if(isPreviousRowHeader){this.turnIntoHeader(row);this.turnIntoRow(row.nextElementSibling);}}else{const isRowHeader=[...row.children][0].nodeName==="TH";row.nextElementSibling?.after(row);adjustedRow=row.previousElementSibling;if(isRowHeader){this.turnIntoHeader(adjustedRow);this.turnIntoRow(row);}}
if(!adjustedRow.previousElementSibling){adjustedRow.childNodes.forEach((cell,index)=>{cell.style.width=adjustedRow.nextElementSibling.childNodes[index].style.width;});}
this.dependencies.selection.setSelection(selectionToRestore);}
normalizeRowHeight(table){const rows=[...table.rows];const referenceRow=rows.find((row)=>!row.style.height);const referenceRowHeight=parseFloat(getComputedStyle(referenceRow).height);rows.forEach((row)=>{if(row.style.height&&Math.abs(parseFloat(row.style.height)-referenceRowHeight)<=1){row.style.height="";}});}
resetRowHeight(row){const table=closestElement(row,"table");row.style.height="";this.normalizeRowHeight(table);}
normalizeColumnWidth(table){const rows=[...table.rows];const firstRowCells=[...rows[0].cells];const tableWidth=parseFloat(table.style.width);if(tableWidth){const expectedCellWidth=tableWidth/firstRowCells.length;firstRowCells.forEach((cell,i)=>{const cellWidth=parseFloat(cell.style.width);if(cellWidth&&Math.abs(cellWidth-expectedCellWidth)<=1){rows.forEach((row)=>(row.cells[i].style.width=""));}});}}
resetColumnWidth(cell){const currentCellWidth=parseFloat(cell.style.width);if(!currentCellWidth){return;}
const table=closestElement(cell,"table");const tableWidth=parseFloat(table.style.width);const currentRow=cell.parentElement;const currentRowCells=[...currentRow.cells];const rowCellCount=currentRowCells.length;const expectedCellWidth=tableWidth/rowCellCount;const widthDifference=currentCellWidth-expectedCellWidth;const currentColumnIndex=getColumnIndex(cell);let totalWidthLeftOfCell=0,totalWidthRightOfCell=0;currentRowCells.forEach((rowCell,i)=>{const cellWidth=parseFloat(rowCell.style.width)||rowCell.clientWidth;if(i<currentColumnIndex){totalWidthLeftOfCell+=cellWidth;}else if(i>currentColumnIndex){totalWidthRightOfCell+=cellWidth;}});let expectedWidthLeftOfCell=currentColumnIndex*expectedCellWidth;let expectedWidthRightOfCell=(rowCellCount-1-currentColumnIndex)*expectedCellWidth;let cellsToAdjust=[];for(let i=currentColumnIndex-1;i>=0&&Math.abs(expectedWidthLeftOfCell-totalWidthLeftOfCell)>1;i--){cellsToAdjust.push(currentRowCells[i]);totalWidthLeftOfCell-=parseFloat(currentRowCells[i].style.width)||currentRowCells[i].clientWidth;expectedWidthLeftOfCell-=expectedCellWidth;}
for(let j=currentColumnIndex+1;j<rowCellCount&&Math.abs(expectedWidthRightOfCell-totalWidthRightOfCell)>1;j++){cellsToAdjust.push(currentRowCells[j]);totalWidthRightOfCell-=parseFloat(currentRowCells[j].style.width)||currentRowCells[j].clientWidth;expectedWidthRightOfCell-=expectedCellWidth;}
cellsToAdjust=cellsToAdjust.filter((adjCell)=>{const cellWidth=parseFloat(adjCell.style.width)||adjCell.clientWidth;return widthDifference>0?cellWidth<expectedCellWidth:cellWidth>expectedCellWidth;});const totalWidthForAdjustment=cellsToAdjust.reduce((width,adjCell)=>{const cellWidth=parseFloat(adjCell.style.width)||adjCell.clientWidth;return width+Math.abs(expectedCellWidth-cellWidth);},0);cell.style.width=`${expectedCellWidth}px`;cellsToAdjust.forEach((adjCell)=>{const adjCellWidth=parseFloat(adjCell.style.width)||adjCell.clientWidth;const adjustmentWidth=(Math.abs(expectedCellWidth-adjCellWidth)/totalWidthForAdjustment)*Math.abs(widthDifference);adjCell.style.width=`${
                adjCellWidth + (widthDifference > 0 ? adjustmentWidth : -adjustmentWidth)
            }px`;});this.normalizeColumnWidth(table);}
resetTableSize(table){table.removeAttribute("style");const cells=[...table.querySelectorAll("tr, td, th")];cells.forEach((cell)=>{const cStyle=cell.style;if(cell.tagName==="TR"){cStyle.height="";}else{cStyle.width="";}});}
clearColumnContent(cell){const table=closestElement(cell,"table");const cells=[...closestElement(cell,"tr").querySelectorAll("th, td")];const index=cells.findIndex((td)=>td===cell);table.querySelectorAll(`tr :is(td, th):nth-of-type(${index + 1})`).forEach((td)=>{const baseContainer=this.dependencies.baseContainer.createBaseContainer();fillEmpty(baseContainer);td.replaceChildren(baseContainer);});}
clearRowContent(row){row.querySelectorAll("td, th").forEach((td)=>{const baseContainer=this.dependencies.baseContainer.createBaseContainer();fillEmpty(baseContainer);td.replaceChildren(baseContainer);});}
deleteTable(table){table=table||findInSelection(this.dependencies.selection.getEditableSelection(),"table");if(!table){return;}
const baseContainer=this.dependencies.baseContainer.createBaseContainer();baseContainer.appendChild(this.document.createElement("br"));table.before(baseContainer);table.remove();this.dependencies.selection.setCursorStart(baseContainer);}
deleteTableCells(selectedTds){const rows=[...closestElement(selectedTds[0],"tr").parentElement.children].filter((child)=>child.nodeName==="TR");const firstRowCells=[...rows[0].children].filter((child)=>child.nodeName==="TD"||child.nodeName==="TH");const firstCellRowIndex=getRowIndex(selectedTds[0]);const firstCellColumnIndex=getColumnIndex(selectedTds[0]);const lastCellRowIndex=getRowIndex(selectedTds[selectedTds.length-1]);const lastCellColumnIndex=getColumnIndex(selectedTds[selectedTds.length-1]);const areFullColumnsSelected=firstCellRowIndex===0&&lastCellRowIndex===rows.length-1;const areFullRowsSelected=firstCellColumnIndex===0&&lastCellColumnIndex===firstRowCells.length-1;if(areFullColumnsSelected){for(let index=firstCellColumnIndex;index<=lastCellColumnIndex;index++){this.removeColumn(firstRowCells[index]);}
return;}
if(areFullRowsSelected){for(let index=firstCellRowIndex;index<=lastCellRowIndex;index++){this.removeRow(rows[index]);}
return;}
for(const td of selectedTds){const baseContainer=this.dependencies.baseContainer.createBaseContainer();baseContainer.appendChild(this.document.createElement("br"));td.replaceChildren(baseContainer);}
this.dependencies.selection.setCursorStart(selectedTds[0].firstChild);}
deleteRangeWithFullySelectedTables(range,fullySelectedTables){let{startContainer,startOffset,endContainer,endOffset}=range;const firstTable=fullySelectedTables[0];if(firstTable.contains(startContainer)){[startContainer,startOffset]=leftPos(firstTable);}
const lastTable=fullySelectedTables.at(-1);if(lastTable.contains(endContainer)){[endContainer,endOffset]=rightPos(lastTable);}
range={startContainer,startOffset,endContainer,endOffset};range=this.dependencies.delete.deleteRange(range);const[anchorNode,anchorOffset]=getDeepestPosition(range.startContainer,range.startOffset);this.dependencies.selection.setSelection({anchorNode,anchorOffset});}
handleDeleteRange(range){const fullySelectedTables=[...this.editable.querySelectorAll(".o_selected_table")].filter((table)=>[...table.querySelectorAll("td, th")].every((td)=>closestElement(td,"table")!==table||td.classList.contains("o_selected_td")));if(fullySelectedTables.length){this.deleteRangeWithFullySelectedTables(range,fullySelectedTables);return true;}
const selectedTds=this.editable.querySelectorAll(".o_selected_td");if(selectedTds.length){this.deleteTableCells(selectedTds);return true;}
return false;}
shiftCursorToTableCell(shiftIndex){const sel=this.dependencies.selection.getEditableSelection();const currentTd=closestElement(sel.anchorNode,isTableCell);const closestTable=closestElement(currentTd,"table");if(!currentTd||!closestTable){return false;}
const tds=[...closestTable.querySelectorAll("td, th")];const cursorDestination=tds[tds.findIndex((td)=>currentTd===td)+shiftIndex];if(!cursorDestination){return false;}
this.dependencies.selection.setCursorEnd(lastLeaf(cursorDestination));return true;}
hanldeFirefoxSelection(ev=null){const selection=this.document.getSelection();if(isBrowserFirefox()){if(!this.dependencies.selection.isSelectionInEditable(selection)){return false;}
if(selection.rangeCount>1||selection.anchorNode?.tagName==="TR"){let[anchorNode,anchorOffset]=getDeepestPosition(selection.getRangeAt(0).startContainer,selection.getRangeAt(0).startOffset);let[focusNode,focusOffset]=getDeepestPosition(selection.getRangeAt(selection.rangeCount-1).startContainer,selection.getRangeAt(selection.rangeCount-1).startOffset);if(this.selectionDirection==="backward"){[anchorNode,focusNode]=[focusNode,anchorNode];[anchorOffset,focusOffset]=[focusOffset,anchorOffset];}
this.dependencies.selection.setSelection({anchorNode,anchorOffset,focusNode,focusOffset,});return true;}else if(ev&&closestElement(ev.target,"table")===closestElement(selection.anchorNode,"table")&&closestElement(ev.target,isTableCell)!==closestElement(selection.focusNode,isTableCell)){this.dependencies.selection.setSelection({anchorNode:selection.anchorNode,anchorOffset:selection.anchorOffset,focusNode:ev.target,focusOffset:0,});this.selectionDirection=selection.direction;return true;}}
return false;}
updateTableKeyboardSelection(ev){const selection=this.dependencies.selection.getSelectionData().deepEditableSelection;const startTable=closestElement(selection.anchorNode,"table");const endTable=closestElement(selection.focusNode,"table");if(!(startTable||endTable)){return;}
const[startTd,endTd]=[closestElement(selection.anchorNode,isTableCell),closestElement(selection.focusNode,isTableCell),];if(startTable!==endTable){if(endTable){const deselectingBackward=["ArrowLeft","ArrowUp"].includes(ev.key)&&selection.direction===DIRECTIONS.RIGHT;const deselectingForward=["ArrowRight","ArrowDown"].includes(ev.key)&&selection.direction===DIRECTIONS.LEFT;let targetNode;if(deselectingBackward){targetNode=endTable.previousElementSibling;}else if(deselectingForward){targetNode=endTable.nextElementSibling;}
if(targetNode){ev.preventDefault();this.dependencies.selection.setSelection({anchorNode:selection.anchorNode,anchorOffset:selection.anchorOffset,focusNode:targetNode,focusOffset:deselectingBackward?nodeSize(targetNode):0,});}}
return;}
if(startTd===endTd&&!startTd.classList.contains("o_selected_td")){const{focusNode,focusOffset}=selection;if(focusNode.nodeType===Node.TEXT_NODE){const textNodes=descendants(startTd).filter(isTextNode);const lastTextChild=textNodes[textNodes.length-1];const firstTextChild=textNodes[0];const isAtTextBoundary={ArrowRight:nodeSize(focusNode)===focusOffset&&focusNode===lastTextChild,ArrowLeft:focusOffset===0&&focusNode===firstTextChild,ArrowUp:focusNode===firstTextChild,ArrowDown:focusNode===lastTextChild,};if(isAtTextBoundary[ev.key]){ev.preventDefault();this.selectTableCells(this.dependencies.selection.getEditableSelection());}}else{ev.preventDefault();this.selectTableCells(this.dependencies.selection.getEditableSelection());}
return;}
const endCellPosition={x:getRowIndex(endTd),y:getColumnIndex(endTd)};const tds=[...startTable.rows].map((row)=>[...row.cells]);let targetTd,targetNode;switch(ev.key){case"ArrowUp":{if(endCellPosition.x>0){targetTd=tds[endCellPosition.x-1][endCellPosition.y];}else{targetNode=previousLeaf(startTable,this.editable);}
break;}
case"ArrowDown":{if(endCellPosition.x<tds.length-1){targetTd=tds[endCellPosition.x+1][endCellPosition.y];}else{targetNode=nextLeaf(startTable,this.editable);}
break;}
case"ArrowRight":{if(endCellPosition.y<tds[0].length-1){targetTd=tds[endCellPosition.x][endCellPosition.y+1];}
break;}
case"ArrowLeft":{if(endCellPosition.y>0){targetTd=tds[endCellPosition.x][endCellPosition.y-1];}
break;}}
if(targetTd||targetNode){this.dependencies.selection.setSelection({anchorNode:selection.anchorNode,anchorOffset:selection.anchorOffset,focusNode:targetTd||targetNode,focusOffset:0,});}
ev.preventDefault();}
updateSelectionTable(selectionData){if(this.hanldeFirefoxSelection()||this._isFirefoxDoubleMousedown||this._isTripleClickInTable){delete this._isFirefoxDoubleMousedown;delete this._isTripleClickInTable;return;}
if(!selectionData.documentSelectionIsInEditable){return;}
const selection=selectionData.editableSelection;const startTd=closestElement(selection.startContainer,isTableCell);const endTd=closestElement(selection.endContainer,isTableCell);const selectSingleCell=startTd&&startTd===endTd&&startTd.classList.contains("o_selected_td")&&this.isShiftArrowKeyboardSelection;if(!(startTd&&startTd===endTd)||this._isKeyDown){delete this._isKeyDown;this.deselectTable();}
delete this.isShiftArrowKeyboardSelection;const startTable=ancestors(selection.startContainer,this.editable).filter((node)=>node.nodeName==="TABLE").pop();const endTable=ancestors(selection.endContainer,this.editable).filter((node)=>node.nodeName==="TABLE").pop();const targetedNodes=this.dependencies.selection.getTargetedNodes();if((startTd!==endTd||selectSingleCell)&&startTable===endTable){if(!isProtected(startTable)&&!isProtecting(startTable)){this.selectTableCells(selection);}}else if(!targetedNodes.every((node)=>closestElement(node.parentElement,"table"))){const endSelectionTable=closestElement(selection.focusNode,"table");const endSelectionTableTds=endSelectionTable&&getTableCells(endSelectionTable);const targetedTds=new Set(targetedNodes.map((node)=>closestElement(node,isTableCell)));const isTableFullySelected=endSelectionTableTds?.every((td)=>targetedTds.has(td));if(endSelectionTable&&!isTableFullySelected){const targetTd=selection.direction===DIRECTIONS.RIGHT?endSelectionTableTds.pop():endSelectionTableTds.shift();this.dependencies.selection.setSelection({anchorNode:selection.anchorNode,anchorOffset:selection.anchorOffset,focusNode:targetTd,focusOffset:selection.direction===DIRECTIONS.RIGHT?nodeSize(targetTd):0,});}
const targetedTables=new Set(targetedNodes.map((node)=>closestElement(node,"table")).filter((node)=>node&&!isProtected(node)&&!isProtecting(node)));for(const table of targetedTables){if(!ancestors(table,this.editable).some((node)=>targetedTables.has(node))){table.classList.toggle("o_selected_table",true);for(const td of getTableCells(table)){td.classList.toggle("o_selected_td",true);this.dispatchTo("deselect_custom_selected_nodes_handlers",td);}}}}}
onMousedown(ev){this._currentMouseState=ev.type;this._lastMousedownPosition=[ev.x,ev.y];const isPointerInsideCell=this.isPointerInsideCell(ev);const td=closestElement(ev.target,isTableCell);if(isPointerInsideCell){if(!isProtected(td)&&!isProtecting(td)&&((isEmptyBlock(td)&&ev.detail===2)||ev.detail===3)){this.hanldeFirefoxSelection();this.selectTableCells(this.dependencies.selection.getEditableSelection());if(isBrowserFirefox()){this._isFirefoxDoubleMousedown=true;}
if(ev.detail===3){this._isTripleClickInTable=true;}}else{this.editable.addEventListener("mousemove",this.onMousemove);const currentSelection=this.dependencies.selection.getEditableSelection();if(closestElement(ev.target,"td.o_selected_td")){this.dependencies.selection.setCursorStart(currentSelection.anchorNode);}
this.deselectTable();}}}
onMouseup(ev){delete this._mouseMovePositionWhenAllContentsSelected;this._currentMouseState=ev.type;this.editable.removeEventListener("mousemove",this.onMousemove);}
isPointerInsideCell(ev){const td=closestElement(ev.target,isTableCell);if(td){const targetRect=td.getBoundingClientRect();if(ev.clientX>targetRect.x+BORDER_SENSITIVITY&&ev.clientX<targetRect.x+td.clientWidth-BORDER_SENSITIVITY&&ev.clientY>targetRect.y+BORDER_SENSITIVITY&&ev.clientY<targetRect.y+td.clientHeight-BORDER_SENSITIVITY){return true;}}
return false;}
onMousemove(ev){if(this._currentMouseState!=="mousedown"){return;}
if(this.hanldeFirefoxSelection(ev)){return;}
const selection=this.dependencies.selection.getEditableSelection();const startTd=closestElement(selection.startContainer,isTableCell);const endTd=closestElement(selection.endContainer,isTableCell);if(startTd&&startTd===endTd&&!isProtected(startTd)&&!isProtecting(startTd)){const selectedNodes=this.dependencies.selection.getTargetedNodes().filter(this.dependencies.selection.areNodeContentsFullySelected);const cellContents=descendants(startTd);const areCellContentsFullySelected=cellContents.filter((d)=>!isBlock(d)).every((child)=>selectedNodes.includes(child));if(areCellContentsFullySelected){const SENSITIVITY=5;if(!this._mouseMovePositionWhenAllContentsSelected){this._mouseMovePositionWhenAllContentsSelected=[ev.clientX,ev.clientY];}
const isMovingAwayFromSelection=Math.abs(ev.clientX-this._mouseMovePositionWhenAllContentsSelected[0])>=SENSITIVITY;if(isMovingAwayFromSelection){this.selectTableCells(selection);}}else if(cellContents.filter(isBlock).every(isEmptyBlock)&&Math.abs(ev.clientX-
(this._lastMousedownPosition?this._lastMousedownPosition[0]:ev.clientX))>=20){this.selectTableCells(selection);}}}
navigateCell(ev){const selection=this.dependencies.selection.getSelectionData().deepEditableSelection;const anchorNode=selection.anchorNode;const currentCell=closestElement(anchorNode,isTableCell);const currentTable=closestElement(anchorNode,"table");if(!selection.isCollapsed||!currentCell){return;}
const isArrowUp=ev.key==="ArrowUp";const cellPosition={row:getRowIndex(currentCell),col:getColumnIndex(currentCell),};const tableRows=[...currentTable.rows].map((row)=>[...row.cells]);const shouldNavigateCell=(currentNode)=>{const siblingDirection=isArrowUp?"previousElementSibling":"nextElementSibling";const direction=isArrowUp?DIRECTIONS.LEFT:DIRECTIONS.RIGHT;const domPath=createDOMPathGenerator(direction,{stopTraverseFunction:(node)=>node===currentCell,stopFunction:(node)=>node===currentCell,});const domPathNode=domPath(currentNode);let node=domPathNode.next().value;while(node){if((isBlock(node)&&node[siblingDirection])||node.nodeName==="BR"){return false;}
node=domPathNode.next().value;}
return true;};const rowOffset=isArrowUp?-1:1;let targetNode=tableRows[cellPosition.row+rowOffset]?.[cellPosition.col];const siblingElement=isArrowUp?currentTable.previousElementSibling:currentTable.nextElementSibling;if(!targetNode&&siblingElement){targetNode=siblingElement;}
if(shouldNavigateCell(anchorNode)){ev.preventDefault();if(targetNode){targetNode=isArrowUp?lastLeaf(targetNode):firstLeaf(targetNode);const targetOffset=isArrowUp?nodeSize(targetNode):0;this.dependencies.selection.setSelection({anchorNode:targetNode,anchorOffset:targetOffset,});}}}
selectTableCells(selection){const table=closestElement(selection.commonAncestorContainer,"table");if(!table){return;}
table.classList.toggle("o_selected_table",true);const columns=getTableCells(table);const startCol=[selection.startContainer,...ancestors(selection.startContainer,this.editable)].find((node)=>isTableCell(node)&&closestElement(node,"table")===table)||columns[0];const endCol=[selection.endContainer,...ancestors(selection.endContainer,this.editable)].find((node)=>isTableCell(node)&&closestElement(node,"table")===table)||columns[columns.length-1];const[startRow,endRow]=[closestElement(startCol,"tr"),closestElement(endCol,"tr")];const[startColIndex,endColIndex]=[getColumnIndex(startCol),getColumnIndex(endCol)];const[startRowIndex,endRowIndex]=[getRowIndex(startRow),getRowIndex(endRow)];const[minRowIndex,maxRowIndex]=[Math.min(startRowIndex,endRowIndex),Math.max(startRowIndex,endRowIndex),];const[minColIndex,maxColIndex]=[Math.min(startColIndex,endColIndex),Math.max(startColIndex,endColIndex),];const grid=[...table.querySelectorAll("tr")].filter((tr)=>closestElement(tr,"table")===table).map((tr)=>[...tr.children].filter(isTableCell));for(const tds of grid.filter((_,index)=>index>=minRowIndex&&index<=maxRowIndex)){for(const td of tds.filter((_,index)=>index>=minColIndex&&index<=maxColIndex)){td.classList.toggle("o_selected_td",true);this.dispatchTo("deselect_custom_selected_nodes_handlers",td);}}}
deselectTable(root=this.editable){let didDeselectTable=false;for(const table of root.querySelectorAll(".o_selected_table")){removeClass(table,"o_selected_table");for(const td of table.querySelectorAll(".o_selected_td")){removeClass(td,"o_selected_td");}
didDeselectTable=true;}
return didDeselectTable;}
applyTableColor(color,mode,previewMode){const selectedTds=[...this.editable.querySelectorAll(".o_selected_td")].filter((node)=>node.isContentEditable);if(selectedTds.length&&(mode==="backgroundColor"||(mode==="color"&&!color))){selectedTds.forEach((td)=>td.classList.toggle("o_selected_td_bg_color_preview",previewMode));for(const td of selectedTds){this.dependencies.color.colorElement(td,color,mode);if(color){td.style["color"]=getComputedStyle(td).color;}else{td.style["color"]="";}}}}
adjustTargetedNodes(targetedNodes){const modifiedTargetedNodes=[];const visitedTables=new Set();for(const node of targetedNodes){const selectedTable=closestElement(node,".o_selected_table");if(selectedTable){if(visitedTables.has(selectedTable)){continue;}
visitedTables.add(selectedTable);for(const selectedTd of selectedTable.querySelectorAll(".o_selected_td")){modifiedTargetedNodes.push(selectedTd,...descendants(selectedTd));}}else{modifiedTargetedNodes.push(node);}}
return modifiedTargetedNodes;}
resetTableSelection(){const selection=this.dependencies.selection.getEditableSelection({deep:true});const anchorTD=closestElement(selection.anchorNode,".o_selected_td");if(!anchorTD){return;}
this.deselectTable();this.dependencies.selection.setSelection({anchorNode:anchorTD.firstChild,anchorOffset:0,focusNode:anchorTD.lastChild,focusOffset:nodeSize(anchorTD.lastChild),});}
processContentForClipboard(clonedContents,selection){if(clonedContents.firstChild.nodeName==="TR"||isTableCell(clonedContents.firstChild)){const table=closestElement(selection.commonAncestorContainer,"table");const tableClone=table.cloneNode(true);const isTableFullySelected=(table.parentElement&&!!closestElement(table.parentElement,".o_selected_td"))||getTableCells(table).every((td)=>td.classList.contains("o_selected_td"));if(!isTableFullySelected){for(const td of tableClone.querySelectorAll(":is(td, th):not(.o_selected_td)")){if(closestElement(td,"table")===tableClone){td.remove();}}
const trsWithoutTd=Array.from(tableClone.querySelectorAll("tr")).filter((row)=>!row.querySelector("td, th"));for(const tr of trsWithoutTd){if(closestElement(tr,"table")===tableClone){tr.remove();}}}
clonedContents=tableClone;}
const startTable=closestElement(selection.startContainer,"table");if(clonedContents.firstChild.nodeName==="TABLE"&&startTable){clonedContents.firstChild.after(startTable.cloneNode(true));clonedContents.firstChild.remove();}
const endTable=closestElement(selection.endContainer,"table");if(clonedContents.lastChild.nodeName==="TABLE"&&endTable){clonedContents.lastChild.before(endTable.cloneNode(true));clonedContents.lastChild.remove();}
this.deselectTable(clonedContents);return clonedContents;}}
return __exports;});;

/* /html_editor/static/src/main/table/table_resize_plugin.js */
odoo.define('@html_editor/main/table/table_resize_plugin',['@html_editor/plugin','@html_editor/utils/dom_traversal','@html_editor/utils/table','@html_editor/main/table/table_plugin','@html_editor/utils/dom_info'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{closestElement,getAdjacentNextSiblings,getAdjacentPreviousSiblings,}=require("@html_editor/utils/dom_traversal");const{getColumnIndex}=require("@html_editor/utils/table");const{BORDER_SENSITIVITY}=require("@html_editor/main/table/table_plugin");const{isTableCell}=require("@html_editor/utils/dom_info");const TableResizePlugin=__exports.TableResizePlugin=class TableResizePlugin extends Plugin{static id="tableResize";static dependencies=["table","history"];setup(){this.addDomListener(this.editable,"dblclick",this.fitToContent);this.addDomListener(this.editable,"mousedown",this.onMousedown);this.addDomListener(this.editable,"mousemove",this.onMousemove);}
isHoveringTdBorder(ev){const target=(ev.target);if(ev.target&&isTableCell(target)&&target.isContentEditable){const targetRect=target.getBoundingClientRect();if(ev.clientX<=targetRect.x+BORDER_SENSITIVITY){return"left";}else if(ev.clientY<=targetRect.y+BORDER_SENSITIVITY){return"top";}else if(ev.clientX>=targetRect.x+target.clientWidth-BORDER_SENSITIVITY){return"right";}else if(ev.clientY>=targetRect.y+target.clientHeight-BORDER_SENSITIVITY){return"bottom";}}
return false;}
setTableResizeCursor(direction){const classList=this.editable.classList;if(classList.contains("o_col_resize")){classList.remove("o_col_resize");}
if(classList.contains("o_row_resize")){classList.remove("o_row_resize");}
if(direction==="col"){this.editable.classList.add("o_col_resize");}else if(direction==="row"){this.editable.classList.add("o_row_resize");}}
resizeTable(ev,direction,target1,target2){ev.preventDefault();const position=target1?(target2?"middle":"last"):"first";let[item,neighbor]=[target1||target2,target2];const table=closestElement(item,"table");const[sizeProp,positionProp,clientPositionProp]=direction==="col"?["width","x","clientX"]:["height","y","clientY"];const isRTL=this.config.direction==="rtl";if(sizeProp==="width"){const tableRect=table.getBoundingClientRect();table.style[sizeProp]=tableRect[sizeProp]+"px";}
const unsizedItemsSelector=`${
            direction === "col" ? "td" : "tr"
        }:not([style*=${sizeProp}])`;for(const unsizedItem of table.querySelectorAll(unsizedItemsSelector)){unsizedItem.style[sizeProp]=unsizedItem.getBoundingClientRect()[sizeProp]+"px";}
if(direction==="col"){let hostCell=closestElement(table,isTableCell);const hostCells=[];while(hostCell){hostCells.push(hostCell);hostCell=closestElement(hostCell.parentElement,isTableCell);}
const nthColumn=getColumnIndex(item);const firstRow=[...table.querySelector("tr").children];[item,neighbor]=[firstRow[nthColumn],firstRow[nthColumn+1]];for(const td of hostCells){if(td!==item&&td!==neighbor&&closestElement(td,"table")===table&&getColumnIndex(td)!==0){td.style.removeProperty(sizeProp);}}
if(isRTL&&position=="middle"){[item,neighbor]=[neighbor,item];}}
const MIN_SIZE=33;switch(position){case"first":{const marginProp=direction==="col"?(isRTL?"marginRight":"marginLeft"):"marginTop";const itemRect=item.getBoundingClientRect();const tableStyle=getComputedStyle(table);const currentMargin=parseFloat(tableStyle[marginProp]);let sizeDelta=itemRect[positionProp]-ev[clientPositionProp];if(direction==="col"&&isRTL){sizeDelta=ev[clientPositionProp]-itemRect[positionProp]-itemRect[sizeProp];}
const newMargin=currentMargin-sizeDelta;const currentSize=itemRect[sizeProp];const newSize=currentSize+sizeDelta;if(newMargin>=0&&newSize>MIN_SIZE){const tableRect=table.getBoundingClientRect();const hostCell=closestElement(table.parentElement,isTableCell);const childTable=item.querySelector("table");const endProp=isRTL?"left":"right";if(direction==="col"&&((hostCell&&tableRect[endProp]+sizeDelta>hostCell.getBoundingClientRect()[endProp]-5)||(childTable&&childTable.getBoundingClientRect()[endProp]>itemRect[endProp]+sizeDelta-5))){break;}
table.style[marginProp]=newMargin+"px";item.style[sizeProp]=newSize+"px";if(sizeProp==="width"){table.style[sizeProp]=tableRect[sizeProp]+sizeDelta+"px";}}
break;}
case"middle":{const[itemRect,neighborRect]=[item.getBoundingClientRect(),neighbor.getBoundingClientRect(),];const[currentSize,newSize]=[itemRect[sizeProp],ev[clientPositionProp]-itemRect[positionProp],];const editableStyle=getComputedStyle(this.editable);const sizeDelta=newSize-currentSize;const currentNeighborSize=neighborRect[sizeProp];const newNeighborSize=currentNeighborSize-sizeDelta;const enclosingCell=closestElement(table,"td, th");const containerWidth=enclosingCell?.getBoundingClientRect().width||this.editable.clientWidth;const maxWidth=containerWidth-
parseFloat(editableStyle.paddingLeft)-
parseFloat(editableStyle.paddingRight);const tableRect=table.getBoundingClientRect();if(newSize>MIN_SIZE&&(direction==="row"||newNeighborSize>MIN_SIZE||tableRect[sizeProp]+sizeDelta<maxWidth)){const childTable=item.querySelector("table");if(direction==="col"&&childTable&&childTable.getBoundingClientRect().right>itemRect.right+sizeDelta-5){break;}
item.style[sizeProp]=newSize+"px";if(direction==="col"){neighbor.style[sizeProp]=(newNeighborSize>MIN_SIZE?newNeighborSize:currentNeighborSize)+"px";}else if(sizeProp==="width"){table.style[sizeProp]=tableRect[sizeProp]+sizeDelta+"px";}}
break;}
case"last":{const itemRect=item.getBoundingClientRect();let sizeDelta=ev[clientPositionProp]-(itemRect[positionProp]+itemRect[sizeProp]);if(direction==="col"&&isRTL){sizeDelta=itemRect[positionProp]-ev[clientPositionProp];}
const currentSize=itemRect[sizeProp];const newSize=currentSize+sizeDelta;if((newSize>=0||direction==="row")&&newSize>MIN_SIZE){const tableRect=table.getBoundingClientRect();const hostCell=closestElement(table.parentElement,isTableCell);const childTable=item.querySelector("table");const endProp=isRTL?"left":"right";if(direction==="col"&&((hostCell&&tableRect[endProp]+sizeDelta>hostCell.getBoundingClientRect()[endProp]-5)||(childTable&&childTable.getBoundingClientRect()[endProp]>itemRect[endProp]+sizeDelta-5))){break;}
if(sizeProp==="width"){table.style[sizeProp]=tableRect[sizeProp]+sizeDelta+"px";}
item.style[sizeProp]=newSize+"px";}
break;}}}
fitToContent(ev){const isHoveringTdBorder=this.isHoveringTdBorder(ev);if(!isHoveringTdBorder){return;}
const cell=ev.target;if(["left","right"].includes(isHoveringTdBorder)){const table=closestElement(cell,"table");const currentColumnIndex=getColumnIndex(cell);const currentColumnCells=table.querySelectorAll(`tr :is(td, th):nth-of-type(${currentColumnIndex + 1})`);this.dependencies.table.resetColumnWidth(currentColumnCells[0]);const isLeftSideClick=isHoveringTdBorder==="left";if((isLeftSideClick&&currentColumnIndex>0)||(!isLeftSideClick&&currentColumnIndex<table.rows[0].cells.length-1)){const siblingColumnIndex=isLeftSideClick?currentColumnIndex-1:currentColumnIndex+1;const siblingColumnCells=table.querySelectorAll(`tr :is(td, th):nth-of-type(${siblingColumnIndex + 1})`);this.dependencies.table.resetColumnWidth(siblingColumnCells[0]);}}else if(["top","bottom"].includes(isHoveringTdBorder)){const currentRow=cell.parentElement;this.dependencies.table.resetRowHeight(currentRow);const siblingRow=isHoveringTdBorder==="top"?currentRow.previousElementSibling:currentRow.nextElementSibling;if(siblingRow){this.dependencies.table.resetRowHeight(siblingRow);}}}
onMousedown(ev){const isHoveringTdBorder=this.isHoveringTdBorder(ev);const isRTL=this.config.direction==="rtl";if(isHoveringTdBorder){ev.preventDefault();const direction={top:"row",right:"col",bottom:"row",left:"col"}[isHoveringTdBorder]||false;let target1,target2;const column=closestElement(ev.target,"tr");if(isHoveringTdBorder==="top"&&column){target1=getAdjacentPreviousSiblings(column).find((node)=>node.nodeName==="TR");target2=closestElement(ev.target,"tr");}else if(isHoveringTdBorder==="right"){if(isRTL){target1=getAdjacentPreviousSiblings(ev.target).find(isTableCell);target2=ev.target;}else{target1=ev.target;target2=getAdjacentNextSiblings(ev.target).find(isTableCell);}}else if(isHoveringTdBorder==="bottom"&&column){target1=closestElement(ev.target,"tr");target2=getAdjacentNextSiblings(column).find((node)=>node.nodeName==="TR");}else if(isHoveringTdBorder==="left"){if(isRTL){target1=ev.target;target2=getAdjacentNextSiblings(ev.target).find(isTableCell);}else{target1=getAdjacentPreviousSiblings(ev.target).find(isTableCell);target2=ev.target;}}
this.isResizingTable=true;this.setTableResizeCursor(direction);const resizeTable=(ev)=>this.resizeTable(ev,direction,target1,target2);const stopResizing=(ev)=>{ev.preventDefault();this.isResizingTable=false;this.setTableResizeCursor(false);this.dependencies.history.addStep();this.document.removeEventListener("mousemove",resizeTable);this.document.removeEventListener("mouseup",stopResizing);this.document.removeEventListener("mouseleave",stopResizing);};this.document.addEventListener("mousemove",resizeTable);this.document.addEventListener("mouseup",stopResizing);this.document.addEventListener("mouseleave",stopResizing);}}
onMousemove(ev){const direction={top:"row",right:"col",bottom:"row",left:"col"}[this.isHoveringTdBorder(ev)]||false;if(direction||!this.isResizingTable){this.setTableResizeCursor(direction);}}}
return __exports;});;

/* /html_editor/static/src/main/table/table_ui_plugin.js */
odoo.define('@html_editor/main/table/table_ui_plugin',['@html_editor/plugin','@html_editor/utils/dom_traversal','@odoo/owl','@web/core/l10n/translation','@html_editor/main/table/table_menu','@html_editor/main/table/table_picker','@html_editor/core/selection_plugin'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{closestElement}=require("@html_editor/utils/dom_traversal");const{reactive}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{TableMenu}=require("@html_editor/main/table/table_menu");const{TablePicker}=require("@html_editor/main/table/table_picker");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const TableUIPlugin=__exports.TableUIPlugin=class TableUIPlugin extends Plugin{static id="tableUi";static dependencies=["history","overlay","table"];resources={user_commands:[{id:"openTablePicker",title:_t("Table"),description:_t("Insert a table"),icon:"fa-table",run:this.openPickerOrInsertTable.bind(this),isAvailable:isHtmlContentSupported,},],powerbox_items:[{categoryId:"structure",commandId:"openTablePicker",},],};setup(){this.picker=this.dependencies.overlay.createOverlay(TablePicker,{positionOptions:{updatePositionOnResize:false,onPositioned:(picker,position)=>{const popperRect=picker.getBoundingClientRect();const{left}=position;if(this.config.direction==="rtl"){picker.style.right=`${window.innerWidth - left - popperRect.width}px`;picker.style.removeProperty("left");}},},});this.activeTd=null;this.colMenu=this.dependencies.overlay.createOverlay(TableMenu,{positionOptions:{position:"top-fit",flip:false,},});this.rowMenu=this.dependencies.overlay.createOverlay(TableMenu,{positionOptions:{position:"left-fit",},});this.addDomListener(this.document,"pointermove",this.onMouseMove);const closeMenus=()=>{if(this.isMenuOpened){this.isMenuOpened=false;this.colMenu.close();this.rowMenu.close();}};this.addDomListener(this.document,"scroll",closeMenus,true);}
openPicker(){this.picker.open({props:{editable:this.editable,overlay:this.picker,direction:this.config.direction||"ltr",insertTable:(params)=>this.dependencies.table.insertTable(params),},});}
openPickerOrInsertTable(){if(this.services.ui.isSmall){this.dependencies.table.insertTable({cols:3,rows:3});}else{this.openPicker();}}
onMouseMove(ev){const target=ev.target;if(this.isMenuOpened){return;}
if(["TD","TH"].includes(target.tagName)&&target!==this.activeTd&&this.editable.contains(target)){if(ev.target.isContentEditable&&closestElement(target,"table").isContentEditable){this.setActiveTd(target);}}else if(this.activeTd){const isOverlay=target.closest(".o-overlay-container");if(isOverlay){return;}
const parentTd=closestElement(target,"td, th");if(!parentTd){this.setActiveTd(null);}}}
createDropdownState(menuToClose){const dropdownState=reactive({isOpen:false,open:()=>{dropdownState.isOpen=true;menuToClose.close();this.isMenuOpened=true;},close:()=>{dropdownState.isOpen=false;this.isMenuOpened=false;},});return dropdownState;}
setActiveTd(td){this.activeTd=td;this.colMenu.close();this.rowMenu.close();if(!td){return;}
const withAddStep=(fn)=>(...args)=>{fn(...args);this.dependencies.history.addStep();};const tableMethods={moveColumn:withAddStep(this.dependencies.table.moveColumn),addColumn:withAddStep(this.dependencies.table.addColumn),removeColumn:withAddStep(this.dependencies.table.removeColumn),moveRow:withAddStep(this.dependencies.table.moveRow),addRow:withAddStep(this.dependencies.table.addRow),removeRow:withAddStep(this.dependencies.table.removeRow),turnIntoHeader:withAddStep(this.dependencies.table.turnIntoHeader),turnIntoRow:withAddStep(this.dependencies.table.turnIntoRow),resetRowHeight:withAddStep(this.dependencies.table.resetRowHeight),resetColumnWidth:withAddStep(this.dependencies.table.resetColumnWidth),resetTableSize:withAddStep(this.dependencies.table.resetTableSize),clearColumnContent:withAddStep(this.dependencies.table.clearColumnContent),clearRowContent:withAddStep(this.dependencies.table.clearRowContent),};if(td.cellIndex===0){this.rowMenu.open({target:td,props:{type:"row",overlay:this.rowMenu,target:td,dropdownState:this.createDropdownState(this.colMenu),...tableMethods,},});}
if(td.parentElement.rowIndex===0){this.colMenu.open({target:td,props:{type:"column",overlay:this.colMenu,target:td,dropdownState:this.createDropdownState(this.rowMenu),direction:this.config.direction||"ltr",...tableMethods,},});}}}
return __exports;});;

/* /html_editor/static/src/main/tabulation_plugin.js */
odoo.define('@html_editor/main/tabulation_plugin',['@html_editor/plugin','@html_editor/utils/blocks','@html_editor/utils/dom','@html_editor/utils/dom_info','@html_editor/utils/dom_traversal','@html_editor/utils/html','@html_editor/utils/position','@html_editor/core/selection_plugin'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{closestBlock,isBlock}=require("@html_editor/utils/blocks");const{splitTextNode}=require("@html_editor/utils/dom");const{isEditorTab,isParagraphRelatedElement,isTextNode,isZWS,}=require("@html_editor/utils/dom_info");const{descendants,getAdjacentPreviousSiblings,closestElement,firstLeaf,selectElements,}=require("@html_editor/utils/dom_traversal");const{parseHTML}=require("@html_editor/utils/html");const{DIRECTIONS,childNodeIndex}=require("@html_editor/utils/position");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const tabHtml='<span class="oe-tabs" contenteditable="false">\u0009</span>\u200B';const GRID_COLUMN_WIDTH=40;function isIndentationTab(tab){return!getAdjacentPreviousSiblings(tab).some((sibling)=>isTextNode(sibling)&&!/^[\u200B\s]*$/.test(sibling.textContent));}
const TabulationPlugin=__exports.TabulationPlugin=class TabulationPlugin extends Plugin{static id="tabulation";static dependencies=["dom","selection","history","delete"];static shared=["indentBlocks","outdentBlocks"];resources={user_commands:[{id:"tab",run:this.handleTab.bind(this),isAvailable:isHtmlContentSupported,},{id:"shiftTab",run:this.handleShiftTab.bind(this),isAvailable:isHtmlContentSupported,},],shortcuts:[{hotkey:"tab",commandId:"tab"},{hotkey:"shift+tab",commandId:"shiftTab"},],content_not_editable_providers:(rootEl)=>[...selectElements(rootEl,".oe-tabs")],contenteditable_to_remove_selector:"span.oe-tabs",normalize_handlers:this.normalize.bind(this),delete_forward_overrides:this.handleDeleteForward.bind(this),unsplittable_node_predicates:isEditorTab,};handleTab(){if(this.delegateTo("tab_overrides")){return;}
const selection=this.dependencies.selection.getEditableSelection();if(selection.isCollapsed){this.insertTab();}else{const targetedBlocks=this.dependencies.selection.getTargetedBlocks();this.indentBlocks(targetedBlocks);}
this.dependencies.history.addStep();}
handleShiftTab(){if(this.delegateTo("shift_tab_overrides")){return;}
const targetedBlocks=this.dependencies.selection.getTargetedBlocks();this.outdentBlocks(targetedBlocks);this.dependencies.history.addStep();}
insertTab(){const selection=this.dependencies.selection.getEditableSelection();const element=closestElement(selection.anchorNode);const isSelectionAtStart=firstLeaf(element)===selection.anchorNode&&(selection.anchorOffset===0||element.textContent==="\u200B");const tab=parseHTML(this.document,tabHtml);if(isSelectionAtStart&&!isBlock(element)){element.before(tab);}else{this.dependencies.dom.insert(tab);}}
indentBlocks(blocks){const selectionToRestore=this.dependencies.selection.getEditableSelection();const tab=parseHTML(this.document,tabHtml);const indentableBlocks=[...blocks].filter((block)=>block.isContentEditable&&(isParagraphRelatedElement(block)||block.tagName==="BLOCKQUOTE"));for(const block of indentableBlocks){block.prepend(tab.cloneNode(true));}
this.dependencies.selection.setSelection(selectionToRestore,{normalize:false});}
outdentBlocks(blocks){for(const block of blocks){const firstTab=descendants(block).find(isEditorTab);if(firstTab&&isIndentationTab(firstTab)){this.removeTrailingZWS(firstTab);firstTab.remove();}}}
removeTrailingZWS(tab){const selection=this.dependencies.selection.getEditableSelection();const{anchorNode,anchorOffset,focusNode,focusOffset}=selection;const updateAnchor=anchorNode===tab.nextSibling;const updateFocus=focusNode===tab.nextSibling;let zwsRemoved=0;while(tab.nextSibling&&tab.nextSibling.nodeType===Node.TEXT_NODE&&tab.nextSibling.textContent.startsWith("\u200B")){splitTextNode(tab.nextSibling,1,DIRECTIONS.LEFT);tab.nextSibling.remove();zwsRemoved++;}
if(updateAnchor||updateFocus){this.dependencies.selection.setSelection({anchorNode:updateAnchor?tab.nextSibling:anchorNode,anchorOffset:updateAnchor?Math.max(0,anchorOffset-zwsRemoved):anchorOffset,focusNode:updateFocus?tab.nextSibling:focusNode,focusOffset:updateFocus?Math.max(0,focusOffset-zwsRemoved):focusOffset,});}}
adjustTabWidth(tabSpan){let tabPreviousSibling=tabSpan.previousSibling;while(isZWS(tabPreviousSibling)){tabPreviousSibling=tabPreviousSibling.previousSibling;}
if(isEditorTab(tabPreviousSibling)){tabSpan.style.width=`${GRID_COLUMN_WIDTH}px`;return;}
const spanRect=tabSpan.getBoundingClientRect();const referenceRect=this.editable.firstElementChild?.getBoundingClientRect();if(!referenceRect?.width||!spanRect.width){return;}
const relativePosition=spanRect.left-referenceRect.left;const distToNextGridLine=GRID_COLUMN_WIDTH-(relativePosition%GRID_COLUMN_WIDTH);const width=distToNextGridLine.toFixed(1);tabSpan.style.width=`${width}px`;}
alignTabs(root=this.editable){const block=closestBlock(root);if(!block){return;}
for(const tab of block.querySelectorAll("span.oe-tabs")){this.adjustTabWidth(tab);}}
expandRangeToIncludeZWS(tabElement){let previous=tabElement;let node=tabElement.nextSibling;while(node?.nodeType===Node.TEXT_NODE){for(let i=0;i<node.textContent.length;i++){if(node.textContent[i]!=="\u200B"){return[node,i];}}
previous=node;node=node.nextSibling;}
return[previous.parentElement,childNodeIndex(previous)+1];}
handleDeleteForward(range){let{endContainer,endOffset}=range;if(!(endContainer?.nodeType===Node.ELEMENT_NODE)||!endOffset){return;}
const nodeToDelete=endContainer.childNodes[endOffset-1];if(isEditorTab(nodeToDelete)){[endContainer,endOffset]=this.expandRangeToIncludeZWS(nodeToDelete);range=this.dependencies.delete.deleteRange({...range,endContainer,endOffset});this.dependencies.selection.setSelection({anchorNode:range.startContainer,anchorOffset:range.startOffset,});return true;}}
normalize(el){this.alignTabs(el);}}
return __exports;});;

/* /html_editor/static/src/main/text_direction_plugin.js */
odoo.define('@html_editor/main/text_direction_plugin',['@web/core/l10n/translation','@html_editor/plugin','@html_editor/utils/blocks','@html_editor/utils/dom_traversal','@html_editor/utils/dom_info','@html_editor/core/selection_plugin'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{Plugin}=require("@html_editor/plugin");const{closestBlock}=require("@html_editor/utils/blocks");const{closestElement}=require("@html_editor/utils/dom_traversal");const{isContentEditable,isTextNode}=require("@html_editor/utils/dom_info");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const TextDirectionPlugin=__exports.TextDirectionPlugin=class TextDirectionPlugin extends Plugin{static id="textDirection";static dependencies=["selection","history","split","format"];resources={user_commands:[{id:"switchDirection",title:_t("Switch direction"),description:_t("Switch the text's direction"),icon:"fa-exchange",run:this.switchDirection.bind(this),isAvailable:isHtmlContentSupported,},],powerbox_items:[{categoryId:"format",commandId:"switchDirection",},],};setup(){if(this.config.direction){this.editable.setAttribute("dir",this.config.direction);}
this.direction=this.config.direction||"ltr";}
switchDirection(){const selection=this.dependencies.split.splitSelection();const targetedTextNodes=[selection.anchorNode,...this.dependencies.selection.getTargetedNodes(),].filter((n)=>isTextNode(n)&&isContentEditable(n)&&n.nodeValue.trim().length);const blocks=new Set(targetedTextNodes.map((textNode)=>closestElement(textNode,"ul,ol")||closestElement(textNode,"[data-embedded='toggleBlock']")||closestBlock(textNode)));const shouldApplyStyle=!this.dependencies.format.isSelectionFormat("switchDirection");for(const block of blocks){for(const node of block.querySelectorAll("ul,ol")){blocks.add(node);}}
for(const block of blocks){if(!shouldApplyStyle){block.removeAttribute("dir");}else{block.setAttribute("dir",this.direction==="ltr"?"rtl":"ltr");}}
for(const element of blocks){const style=getComputedStyle(element);if(style.direction==="ltr"&&style.textAlign==="right"){element.style.setProperty("text-align","left");}else if(style.direction==="rtl"&&style.textAlign==="left"){element.style.setProperty("text-align","right");}}
this.dependencies.history.addStep();}}
return __exports;});;

/* /html_editor/static/src/main/toolbar/mobile_toolbar.js */
odoo.define('@html_editor/main/toolbar/mobile_toolbar',['@odoo/owl','@html_editor/main/toolbar/toolbar'],function(require){'use strict';let __exports={};const{Component,onMounted,useExternalListener,useRef}=require("@odoo/owl");const{Toolbar}=require("@html_editor/main/toolbar/toolbar");const ToolbarMobile=__exports.ToolbarMobile=class ToolbarMobile extends Component{static template="html_editor.MobileToolbar";static props=["*"];static components={Toolbar,};setup(){this.toolbar=useRef("toolbarWrapper");useExternalListener(window.visualViewport,"resize",this.fixToolbarPosition);useExternalListener(window.visualViewport,"scroll",this.fixToolbarPosition);onMounted(()=>{this.fixToolbarPosition();});}
fixToolbarPosition(){const keyboardHeight=window.innerHeight-(window.visualViewport.height+window.visualViewport.offsetTop);if(keyboardHeight>0){this.toolbar.el.style.bottom=`${keyboardHeight}px`;}else{this.toolbar.el.style.bottom=`0px`;}}}
return __exports;});;

/* /html_editor/static/src/main/toolbar/toolbar.js */
odoo.define('@html_editor/main/toolbar/toolbar',['@odoo/owl','@web/core/utils/objects'],function(require){'use strict';let __exports={};const{Component,useState,validate}=require("@odoo/owl");const{omit,pick}=require("@web/core/utils/objects");const Toolbar=__exports.Toolbar=class Toolbar extends Component{static template="html_editor.Toolbar";static props={class:{type:String,optional:true},getSelection:Function,focusEditable:Function,state:{type:Object,shape:{namespace:{type:String,optional:true},buttonGroups:{type:Array,element:{type:Object,shape:{id:String,buttons:{type:Array,element:{type:Object,validate:(button)=>{const base={id:String,description:String,isDisabled:Boolean,};if(button.Component){validate(button,{...base,Component:Function,props:{type:Object,optional:true},});}else{validate(button,{...base,run:Function,icon:{type:String,optional:true},text:{type:String,optional:true},isActive:Boolean,});}
return true;},},},},},},},},};setup(){this.state=useState(this.props.state);}
onButtonClick(button){button.run();this.props.focusEditable();}}
const toolbarButtonProps=__exports.toolbarButtonProps={title:[String,Function],getSelection:Function,isDisabled:Boolean,};__exports.composeToolbarButton=composeToolbarButton;function composeToolbarButton(userCommand,toolbarItem){const description=toolbarItem.description||userCommand.description;return{...pick(userCommand,"icon"),...omit(toolbarItem,"commandId","commandParams"),run:()=>userCommand.run(toolbarItem.commandParams),isAvailable:(selection)=>[userCommand.isAvailable,toolbarItem.isAvailable].filter(Boolean).every((predicate)=>predicate(selection)),description:description instanceof Function?description:()=>description,};}
return __exports;});;

/* /html_editor/static/src/main/toolbar/toolbar_plugin.js */
odoo.define('@html_editor/main/toolbar/toolbar_plugin',['@html_editor/plugin','@html_editor/utils/dom_info','@odoo/owl','@html_editor/main/toolbar/toolbar','@web/core/browser/feature_detection','@web/core/registry','@html_editor/main/toolbar/mobile_toolbar','@web/core/utils/timing','@web/core/utils/objects','@html_editor/utils/resource','@web/core/l10n/translation','@web/core/utils/functions','@html_editor/utils/dom_traversal'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{isEmptyTextNode,isZWS}=require("@html_editor/utils/dom_info");const{reactive}=require("@odoo/owl");const{composeToolbarButton,Toolbar}=require("@html_editor/main/toolbar/toolbar");const{hasTouch}=require("@web/core/browser/feature_detection");const{registry}=require("@web/core/registry");const{ToolbarMobile}=require("@html_editor/main/toolbar/mobile_toolbar");const{debounce}=require("@web/core/utils/timing");const{omit,pick}=require("@web/core/utils/objects");const{withSequence}=require("@html_editor/utils/resource");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{memoize}=require("@web/core/utils/functions");const{closestElement}=require("@html_editor/utils/dom_traversal");const DELAY_TOOLBAR_OPEN=300;const MIN_SIZE_FOR_COMPACT=7;const DISABLED_NAMESPACE=__exports.DISABLED_NAMESPACE="disabled";const ToolbarPlugin=__exports.ToolbarPlugin=class ToolbarPlugin extends Plugin{static id="toolbar";static dependencies=["overlay","selection","userCommand"];static shared=["getToolbarInfo"];resources={selectionchange_handlers:this.handleSelectionChange.bind(this),selection_leave_handlers:()=>this.closeToolbar(),step_added_handlers:()=>this.updateToolbar(),user_commands:{id:"expandToolbar",run:()=>{this.isToolbarExpanded=true;this.updateToolbar();},},toolbar_groups:[withSequence(100,{id:"expand_toolbar",namespaces:["compact"]}),withSequence(30,{id:"layout"}),],toolbar_items:{id:"expand_toolbar",groupId:"expand_toolbar",commandId:"expandToolbar",description:_t("Expand toolbar"),icon:"oi-ellipsis-v",},toolbar_namespace_providers:[withSequence(100,(targetedNodes,editableSelection)=>this.isToolbarVisible(targetedNodes,editableSelection)?"compact":undefined),],};setup(){const groupIds=new Set();for(const group of this.getResource("toolbar_groups")){if(groupIds.has(group.id)){throw new Error(`Duplicate toolbar group id: ${group.id}`);}
groupIds.add(group.id);}
this.buttonGroups=this.getButtonGroups();this.buttonsByNamespace={DISABLED_NAMESPACE:[]};this.isMobileToolbar=hasTouch()&&window.visualViewport;if(this.isMobileToolbar){this.overlay=new MobileToolbarOverlay(this.editable);}else{this.overlay=this.dependencies.overlay.createOverlay(Toolbar,{positionOptions:{position:"top-start",},closeOnPointerdown:false,});}
this.state=reactive({buttonGroups:[],namespace:undefined});this.onSelectionChangeActive=true;this.debouncedUpdateToolbar=debounce(this._updateToolbar,DELAY_TOOLBAR_OPEN);if(this.isMobileToolbar){this.addDomListener(this.editable,"pointerup",()=>{this.isToolbarExpanded=false;});}else{this.addDomListener(this.editable,"mousedown",(ev)=>{this.closeToolbar(this.dependencies.selection.getSelectionData());this.debouncedUpdateToolbar.cancel();this.onSelectionChangeActive=false;});this.addGlobalDomListener("mouseup",(ev)=>{if(ev.detail>=2){this.onSelectionChangeActive=true;this.debouncedUpdateToolbar();}else{setTimeout(()=>{this.updateToolbar();this.onSelectionChangeActive=true;});}});this.addDomListener(this.editable,"keydown",(ev)=>{if(ev.key?.startsWith("Arrow")){this.closeToolbar(this.dependencies.selection.getSelectionData());this.onSelectionChangeActive=false;}});this.addDomListener(this.editable,"keyup",(ev)=>{if(ev.key?.startsWith("Arrow")){this.onSelectionChangeActive=true;this.debouncedUpdateToolbar();}});}
this.isToolbarExpanded=false;this.toolbarProps={class:"shadow rounded my-2",getSelection:()=>this.dependencies.selection.getSelectionData(),focusEditable:()=>this.dependencies.selection.focusEditable(),state:this.state,};}
destroy(){this.debouncedUpdateToolbar.cancel();this.updateToolbar.cancel();this.overlay.close();super.destroy();}
getButtons(){const toolbarItems=this.getResource("toolbar_items");const commandItemToButton=(item)=>{const command=this.dependencies.userCommand.getCommand(item.commandId);return composeToolbarButton(command,item);};const componentItemToButton=(item)=>({isAvailable:()=>true,...item,description:item.description instanceof Function?item.description:()=>item.description,});return toolbarItems.map((item)=>"Component"in item?componentItemToButton(item):commandItemToButton(item));}
getButtonGroups(){const buttons=this.getButtons();const groups=this.getResource("toolbar_groups");return groups.map((group)=>({...omit(group,"namespaces"),buttons:buttons.filter((button)=>button.groupId===group.id).map((button)=>({...button,namespaces:button.namespaces||group.namespaces||["expanded"],})),}));}
getButtonsForNamespace(namespace){if(this.buttonsByNamespace[namespace]){return this.buttonsByNamespace[namespace];}
const button=this.buttonGroups.flatMap((group)=>group.buttons.filter((btn)=>btn.namespaces.includes(namespace)));this.buttonsByNamespace[namespace]=button;return button;}
getToolbarInfo(){return{buttonGroups:this.buttonGroups,};}
handleSelectionChange(selectionData){if(this.onSelectionChangeActive){this.updateToolbar(selectionData);}}
updateToolbar=debounce(this._updateToolbar,0,{trailing:true});_updateToolbar(selectionData=this.dependencies.selection.getSelectionData()){if(!selectionData.currentSelectionIsInEditable||selectionData.documentSelectionIsProtected||selectionData.documentSelectionIsProtecting){this.closeToolbar();return;}
const targetedNodes=this.dependencies.selection.getTargetedNodes();if(targetedNodes.every((node)=>!this.dependencies.selection.isNodeEditable(node))){this.closeToolbar();return;}
let currentNamespace=null;let filteredtargetedNodes=[];filteredtargetedNodes=this.getFilteredTargetedNodes(targetedNodes);for(const fn of this.getResource("toolbar_namespace_providers")){currentNamespace=fn(filteredtargetedNodes,selectionData.editableSelection);if(currentNamespace){break;}}
if(currentNamespace===DISABLED_NAMESPACE){this.closeToolbar();return;}
if(currentNamespace==="compact"&&this.isToolbarExpanded){currentNamespace="expanded";}
if(currentNamespace){this.state.namespace=currentNamespace;if(!this.overlay.isOpen){this.overlay.open({props:this.toolbarProps});}
this.updateButtonsStates(selectionData.editableSelection,filteredtargetedNodes);}else{this.closeToolbar();}}
getFilteredTargetedNodes(targetedNodes){return targetedNodes.filter((node)=>this.dependencies.selection.isNodeEditable(node)&&(node.nodeType!==Node.TEXT_NODE||(!isEmptyTextNode(node)&&!isZWS(node)))).filter((node)=>{const element=closestElement(node);const style=this.document.defaultView.getComputedStyle(element);return style.display!=="none"&&style.visibility!=="hidden";});}
isToolbarVisible(targetedNodes,editableSelection){if(this.isMobileToolbar){return true;}
const isCollapsed=editableSelection.isCollapsed;if(isCollapsed){return false;}
const selectionText=editableSelection.textContent();const textCleaned=selectionText.replace(/(\r\n|\n|\r|\u200B|\uFEFF)/gm,"");if(textCleaned.length){return true;}
return targetedNodes.some((node)=>node.nodeType===Node.ELEMENT_NODE&&node.tagName==="BR");}
closeToolbar(selectionData=null){if(!this.overlay.isOpen){return;}
const anchor=selectionData?.documentSelectionIsInEditable?selectionData.editableSelection?.anchorNode:document.getSelection()?.anchorNode;const shouldPreventClosing=anchor?.closest?.("[data-prevent-closing-overlay]")?.dataset?.preventClosingOverlay==="true";if(!shouldPreventClosing){this.overlay.close();this.isToolbarExpanded=false;this.state.namespace=null;}}
updateButtonsStates(selection,targetedNodes){const availableButtons=this.getAvailableButtonsSet(selection);this.state.buttonGroups=this.buttonGroups.map((group)=>({id:group.id,buttons:group.buttons.filter((button)=>availableButtons.has(button)).map((button)=>({id:button.id,description:button.description(selection,targetedNodes),isDisabled:!!button.isDisabled?.(selection,targetedNodes),...(button.Component?pick(button,"Component","props"):{...pick(button,"run","icon","text"),isActive:!!button.isActive?.(selection,targetedNodes),}),})),})).filter((group)=>group.buttons.length>0);}
getAvailableButtonsSet(selection){if(this.state.namespace==="compact"){return this.getAvailableButtonsCompact(selection);}
const isAvailable=(button)=>button.isAvailable(selection);return new Set(this.getButtonsForNamespace(this.state.namespace).filter(isAvailable));}
getAvailableButtonsCompact(selection){const isAvailable=memoize((button)=>button.isAvailable(selection));const compact=this.getButtonsForNamespace("compact").filter(isAvailable);const expanded=this.getButtonsForNamespace("expanded").filter(isAvailable);const shouldDisplayCompactToolbar=expanded.length>=MIN_SIZE_FOR_COMPACT&&expanded.length>compact.length;if(shouldDisplayCompactToolbar){return new Set(compact);}
this.state.namespace="expanded";return new Set(expanded);}}
class MobileToolbarOverlay{constructor(editable){this.isOpen=false;this.overlayId=`mobile_toolbar_${Math.random().toString(16).slice(2)}`;this.editable=editable;}
open({props}){props.class="shadow";if(!this.isOpen){const modal=this.editable.closest(".o_modal_full");if(modal){modal.style.paddingBottom="40px";}
registry.category("main_components").add(this.overlayId,{Component:ToolbarMobile,props,});this.isOpen=true;}}
close(){const modal=this.editable.closest(".o_modal_full");if(modal){modal.style.paddingBottom="";}
registry.category("main_components").remove(this.overlayId,"MobileToolbar");this.isOpen=false;}}
return __exports;});;

/* /html_editor/static/src/main/youtube_plugin.js */
odoo.define('@html_editor/main/youtube_plugin',['@web/core/l10n/translation','@web/core/network/rpc','@html_editor/plugin','@html_editor/main/media/media_dialog/video_selector'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{rpc}=require("@web/core/network/rpc");const{Plugin}=require("@html_editor/plugin");const{VideoSelector}=require("@html_editor/main/media/media_dialog/video_selector");const YOUTUBE_URL_GET_VIDEO_ID=__exports.YOUTUBE_URL_GET_VIDEO_ID=/^(?:(?:https?:)?\/\/)?(?:(?:www|m)\.)?(?:youtube\.com|youtu\.be)(?:\/(?:[\w-]+\?v=|embed\/|v\/)?)([^\s?&#]+)(?:\S+)?$/i;const YoutubePlugin=__exports.YoutubePlugin=class YoutubePlugin extends Plugin{static id="youtube";static dependencies=["history","dom"];mediaSpecificClasses=VideoSelector.mediaSpecificClasses;resources={...(this.config.allowVideo&&{paste_media_url_command_providers:this.getCommandForVideoUrlPaste.bind(this),}),};getCommandForVideoUrlPaste(url){const youtubeUrl=YOUTUBE_URL_GET_VIDEO_ID.exec(url);if(youtubeUrl){return{title:_t("Embed Youtube Video"),description:_t("Embed the youtube video in the document."),icon:"fa-youtube-play",run:async()=>{const videoElement=await this.getYoutubeVideoElement(youtubeUrl[0]);this.dependencies.dom.insert(videoElement);this.dependencies.history.addStep();},};}}
async getYoutubeVideoElement(url){if(!URL.canParse(url)){return;}
const parsedUrl=new URL(url);const urlParams=parsedUrl.searchParams;const start_from=urlParams.get("start")||urlParams.get("t");const autoplay=urlParams.get("autoplay")==="1";const loop=urlParams.get("loop")==="1";const hide_controls=urlParams.get("controls")==="0";const hide_fullscreen=urlParams.get("fs")==="0";const videoData=await rpc("/html_editor/video_url/data",{video_url:url,autoplay,loop,hide_controls,hide_fullscreen,start_from,});const savedVideo=this.createVideoElement(videoData);savedVideo.classList.add(...this.mediaSpecificClasses);return savedVideo;}
createVideoElement(videoData){return VideoSelector.createElements([{src:videoData.embed_url}])[0];}}
return __exports;});;

/* /html_editor/static/src/others/collaboration/PeerToPeer.js */
odoo.define('@html_editor/others/collaboration/PeerToPeer',[],function(require){'use strict';let __exports={};const urlParams=new URLSearchParams(window.location.search);const collaborationDebug=urlParams.get("collaborationDebug");const COLLABORATION_LOCALSTORAGE_KEY="odoo_editor_collaboration_debug";if(typeof collaborationDebug==="string"){if(collaborationDebug==="false"){localStorage.removeItem(COLLABORATION_LOCALSTORAGE_KEY,urlParams.get("collaborationDebug"));}else{localStorage.setItem(COLLABORATION_LOCALSTORAGE_KEY,urlParams.get("collaborationDebug"));}}
const debugValue=localStorage.getItem(COLLABORATION_LOCALSTORAGE_KEY);const debugShowLog=["","true","all"].includes(debugValue);const debugShowNotifications=debugValue==="all";const baseNotificationMethods={ptp_request:async function(notification){const{requestId,requestName,requestPayload,requestTransport}=notification.notificationPayload;this._onRequest(notification.fromPeerId,requestId,requestName,requestPayload,requestTransport);},ptp_request_result:function(notification){const{requestId,result}=notification.notificationPayload;if(this._pendingRequestResolver[requestId]){clearTimeout(this._pendingRequestResolver[requestId].rejectTimeout);this._pendingRequestResolver[requestId].resolve(result);delete this._pendingRequestResolver[requestId];}},ptp_join:async function(notification){const peerId=notification.fromPeerId;if(this.peersInfos[peerId]&&this.peersInfos[peerId].peerConnection){return this.peersInfos[peerId];}
this._createPeer(peerId);},rtc_signal_icecandidate:async function(notification){if(debugShowLog){console.log(`%creceive candidate`,"background: darkgreen; color: white;");}
const peerInfos=this.peersInfos[notification.fromPeerId];if(!peerInfos||!peerInfos.peerConnection||peerInfos.peerConnection.connectionState==="closed"){console.groupCollapsed("=== ERROR: Handle Ice Candidate from undefined|closed ===");console.trace(peerInfos);console.groupEnd();return;}
if(!peerInfos.peerConnection.remoteDescription){peerInfos.iceCandidateBuffer.push(notification.notificationPayload);}else{this._addIceCandidate(peerInfos,notification.notificationPayload);}},rtc_signal_description:async function(notification){const description=notification.notificationPayload;if(debugShowLog){console.log(`%cdescription received:`,"background: blueviolet; color: white;",description);}
const peerInfos=this.peersInfos[notification.fromPeerId]||this._createPeer(notification.fromPeerId);const pc=peerInfos.peerConnection;if(!pc||pc.connectionState==="closed"){if(debugShowLog){console.groupCollapsed("=== ERROR: handle offer ===");console.log("An offer has been received for a non-existent peer connection - peer: "+
notification.fromPeerId);console.trace(pc&&pc.connectionState);console.groupEnd();}
return;}
if(pc.signalingState==="have-remote-offer"){return;}
const isPolite=(""+notification.fromPeerId).localeCompare(""+this._currentPeerId)===1;if(debugShowLog){console.log(`%cisPolite: %c${isPolite}`,"background: deepskyblue;",`background:${isPolite ? "green" : "red"}`);}
const isOfferRacing=description.type==="offer"&&(peerInfos.makingOffer||pc.signalingState!=="stable");if(isOfferRacing&&!isPolite){if(debugShowLog){console.log(`%creturn because isOfferRacing && !isPolite. pc.signalingState: ${pc.signalingState}`,"background: red;");}
return;}
if(debugShowLog){console.log(`%cisOfferRacing: ${isOfferRacing}`,"background: red;");console.log(`%c SETREMOTEDESCRIPTION`,"background: navy; color:white;");}
try{await pc.setRemoteDescription(description);}catch(e){if(e instanceof DOMException&&e.name==="InvalidStateError"){console.error(e);return;}else{throw e;}}
if(peerInfos.iceCandidateBuffer.length){for(const candidate of peerInfos.iceCandidateBuffer){await this._addIceCandidate(peerInfos,candidate);}
peerInfos.iceCandidateBuffer.splice(0);}
if(description.type==="offer"){const answerDescription=await pc.createAnswer();try{await pc.setLocalDescription(answerDescription);}catch(e){if(e instanceof DOMException&&e.name==="InvalidStateError"){console.error(e);return;}else{throw e;}}
this.notifyPeer(notification.fromPeerId,"rtc_signal_description",pc.localDescription);}},};const PeerToPeer=__exports.PeerToPeer=class PeerToPeer{constructor(options){this.options=options;this._currentPeerId=this.options.currentPeerId;if(debugShowLog){console.log(`%c currentPeerId:${this._currentPeerId}`,"background: blue; color: white;");}
this.peersInfos={};this._lastRequestId=-1;this._pendingRequestResolver={};this._stopped=false;}
stop(){this.closeAllConnections();this._stopped=true;}
getConnectedPeerIds(){return Object.entries(this.peersInfos).filter(([id,infos])=>infos.peerConnection&&infos.peerConnection.iceConnectionState==="connected"&&infos.dataChannel&&infos.dataChannel.readyState==="open").map(([id])=>id);}
removePeer(peerId){if(debugShowLog){console.log(`%c REMOVE PEER ${peerId}`,"background: chocolate;");}
this.notifySelf("ptp_remove",peerId);const peerInfos=this.peersInfos[peerId];if(!peerInfos){return;}
clearTimeout(peerInfos.fallbackTimeout);clearTimeout(peerInfos.zombieTimeout);peerInfos.dataChannel&&peerInfos.dataChannel.close();peerInfos.peerConnection&&peerInfos.peerConnection.close();delete this.peersInfos[peerId];}
closeAllConnections(){for(const peerId of Object.keys(this.peersInfos)){this.notifyAllPeers("ptp_disconnect");this.removePeer(peerId);}}
async notifyAllPeers(notificationName,notificationPayload,{transport="server"}={}){if(this._stopped){return;}
const transportPayload={fromPeerId:this._currentPeerId,notificationName,notificationPayload,};if(transport==="server"){await this.options.broadcastAll(transportPayload);}else if(transport==="rtc"){for(const cliendId of Object.keys(this.peersInfos)){this._channelNotify(cliendId,transportPayload);}}else{throw new Error(`Transport "${transport}" is not supported. Use "server" or "rtc" transport.`);}}
notifyPeer(peerId,notificationName,notificationPayload,{transport="server"}={}){if(this._stopped){return;}
if(debugShowNotifications){if(notificationName==="ptp_request_result"){console.log(`%c${Date.now()} - REQUEST RESULT SEND: %c${transport}:${
                        notificationPayload.requestId
                    }:${this._currentPeerId.slice("-5")}:${peerId.slice("-5")}`,"color: #aaa;font-weight:bold;","color: #aaa;font-weight:normal");}else if(notificationName==="ptp_request"){console.log(`%c${Date.now()} - REQUEST SEND: %c${transport}:${
                        notificationPayload.requestName
                    }|${notificationPayload.requestId}:${this._currentPeerId.slice(
                        "-5"
                    )}:${peerId.slice("-5")}`,"color: #aaa;font-weight:bold;","color: #aaa;font-weight:normal");}else{console.log(`%c${Date.now()} - NOTIFICATION SEND: %c${transport}:${notificationName}:${this._currentPeerId.slice(
                        "-5"
                    )}:${peerId.slice("-5")}`,"color: #aaa;font-weight:bold;","color: #aaa;font-weight:normal");}}
const transportPayload={fromPeerId:this._currentPeerId,toPeerId:peerId,notificationName,notificationPayload,};if(transport==="server"){this.options.broadcastAll(transportPayload);}else if(transport==="rtc"){this._channelNotify(peerId,transportPayload);}else{throw new Error(`Transport "${transport}" is not supported. Use "server" or "rtc" transport.`);}}
notifySelf(notificationName,notificationPayload){if(this._stopped){return;}
return this.handleNotification({notificationName,notificationPayload});}
handleNotification(notification){if(this._stopped){return;}
const isInternalNotification=typeof notification.fromPeerId==="undefined"&&typeof notification.toPeerId==="undefined";if(isInternalNotification||(notification.fromPeerId!==this._currentPeerId&&!notification.toPeerId)||notification.toPeerId===this._currentPeerId){if(debugShowNotifications){if(notification.notificationName==="ptp_request_result"){console.log(`%c${Date.now()} - REQUEST RESULT RECEIVE: %c${
                            notification.notificationPayload.requestId
                        }:${notification.fromPeerId.slice("-5")}:${notification.toPeerId.slice(
                            "-5"
                        )}`,"color: #aaa;font-weight:bold;","color: #aaa;font-weight:normal");}else if(notification.notificationName==="ptp_request"){console.log(`%c${Date.now()} - REQUEST RECEIVE: %c${
                            notification.notificationPayload.requestName
                        }|${
                            notification.notificationPayload.requestId
                        }:${notification.fromPeerId.slice("-5")}:${notification.toPeerId.slice(
                            "-5"
                        )}`,"color: #aaa;font-weight:bold;","color: #aaa;font-weight:normal");}else{console.log(`%c${Date.now()} - NOTIFICATION RECEIVE: %c${
                            notification.notificationName
                        }:${notification.fromPeerId}:${notification.toPeerId}`,"color: #aaa;font-weight:bold;","color: #aaa;font-weight:normal");}}
try{const baseMethod=baseNotificationMethods[notification.notificationName];if(baseMethod){return baseMethod.call(this,notification);}
if(this.options.onNotification){return this.options.onNotification(notification);}}catch(error){console.groupCollapsed("=== ERROR: On notification in collaboration ===");console.error(error);console.groupEnd();}}}
requestPeer(peerId,requestName,requestPayload,{transport="server"}={}){if(this._stopped){return;}
return new Promise((resolve,reject)=>{const requestId=this._getRequestId();const abort=(reason)=>{clearTimeout(rejectTimeout);delete this._pendingRequestResolver[requestId];reject(new RequestError(reason||"Request was aborted."));};const rejectTimeout=setTimeout(()=>abort("Request took too long (more than 10 seconds)."),10000);this._pendingRequestResolver[requestId]={resolve,rejectTimeout,abort,};this.notifyPeer(peerId,"ptp_request",{requestId,requestName,requestPayload,requestTransport:transport,},{transport});});}
abortCurrentRequests(){for(const{abort}of Object.values(this._pendingRequestResolver)){abort();}}
_createPeer(peerId,{makeOffer=true}={}){if(this._stopped){return;}
if(debugShowLog){console.log("CREATE CONNECTION with peer id:",peerId);}
this.peersInfos[peerId]={makingOffer:false,iceCandidateBuffer:[],backoffFactor:0,};if(!navigator.onLine){return this.peersInfos[peerId];}
const pc=new RTCPeerConnection(this.options.peerConnectionConfig);if(makeOffer){pc.onnegotiationneeded=async()=>{if(debugShowLog){console.log(`%c NEGONATION NEEDED: ${pc.connectionState}`,"background: deeppink;");}
try{this.peersInfos[peerId].makingOffer=true;if(debugShowLog){console.log(`%ccreating and sending an offer`,"background: darkmagenta; color: white;");}
const offer=await pc.createOffer();if(pc.signalingState!=="stable"){return;}
await pc.setLocalDescription(offer);this.notifyPeer(peerId,"rtc_signal_description",pc.localDescription);}catch(err){console.error(err);}finally{this.peersInfos[peerId].makingOffer=false;}};}
pc.onicecandidate=async(event)=>{if(event.candidate){this.notifyPeer(peerId,"rtc_signal_icecandidate",event.candidate);}};pc.oniceconnectionstatechange=async()=>{if(debugShowLog){console.log("ICE STATE UPDATE: "+pc.iceConnectionState);}
switch(pc.iceConnectionState){case"failed":case"closed":this.removePeer(peerId);break;case"disconnected":if(navigator.onLine){await this._recoverConnection(peerId,{delay:3000,reason:"ice connection disconnected",});}
break;case"connected":this.peersInfos[peerId].backoffFactor=0;break;}};pc.onconnectionstatechange=async()=>{if(debugShowLog){console.log("CONNECTION STATE UPDATE:"+pc.connectionState);}
switch(pc.connectionState){case"failed":case"closed":this.removePeer(peerId);break;case"disconnected":if(navigator.onLine){await this._recoverConnection(peerId,{delay:3000,reason:"connection disconnected",});}
break;case"connected":case"completed":this.peersInfos[peerId].backoffFactor=0;break;}};pc.onicecandidateerror=async(error)=>{if(debugShowLog){console.groupCollapsed("=== ERROR: onIceCandidate ===");console.log("connectionState: "+
pc.connectionState+" - iceState: "+
pc.iceConnectionState);console.trace(error);console.groupEnd();}
this._recoverConnection(peerId,{delay:3000,reason:"ice candidate error"});};const dataChannel=pc.createDataChannel("notifications",{negotiated:true,id:1});let message=[];dataChannel.onmessage=(event)=>{if(event.data!=="-"){message.push(event.data);}else{this.handleNotification(JSON.parse(message.join("")));message=[];}};dataChannel.onopen=(event)=>{this.notifySelf("rtc_data_channel_open",{connectionPeerId:peerId,});};this.peersInfos[peerId].peerConnection=pc;this.peersInfos[peerId].dataChannel=dataChannel;return this.peersInfos[peerId];}
async _addIceCandidate(peerInfos,candidate){const rtcIceCandidate=new RTCIceCandidate(candidate);try{await peerInfos.peerConnection.addIceCandidate(rtcIceCandidate);}catch(error){console.groupCollapsed("=== ERROR: ADD ICE CANDIDATE ===");console.trace(error);console.groupEnd();}}
_channelNotify(peerId,transportPayload){if(this._stopped){return;}
const peerInfo=this.peersInfos[peerId];const dataChannel=peerInfo&&peerInfo.dataChannel;if(!dataChannel||dataChannel.readyState!=="open"){if(peerInfo&&!peerInfo.zombieTimeout){if(debugShowLog){console.warn(`Impossible to communicate with peer ${peerId}. The connection will be killed in 10 seconds if the datachannel state has not changed.`);}
this._killPotentialZombie(peerId);}}else{const str=JSON.stringify(transportPayload);const size=str.length;const maxStringLength=5000;let from=0;let to=maxStringLength;while(from<size){dataChannel.send(str.slice(from,to));from=to;to=to+=maxStringLength;}
dataChannel.send("-");}}
_getRequestId(){this._lastRequestId++;return this._lastRequestId;}
async _onRequest(fromPeerId,requestId,requestName,requestPayload,requestTransport){if(this._stopped){return;}
const requestFunction=this.options.onRequest&&this.options.onRequest[requestName];const result=await requestFunction({fromPeerId,requestId,requestName,requestPayload,});this.notifyPeer(fromPeerId,"ptp_request_result",{requestId,result},{transport:requestTransport});}
_recoverConnection(peerId,{delay=0,reason=""}={}){if(this._stopped){this.removePeer(peerId);return;}
const peerInfos=this.peersInfos[peerId];if(!peerInfos||peerInfos.fallbackTimeout){return;}
const backoffFactor=this.peersInfos[peerId].backoffFactor;const backoffDelay=delay*Math.pow(2,backoffFactor);if(backoffFactor>10){if(debugShowLog){console.log(`%c STOP RTC RECOVERY: impossible to connect to peer ${peerId}: ${reason}`,"background: darkred; color: white;");}
return;}
peerInfos.fallbackTimeout=setTimeout(async()=>{peerInfos.fallbackTimeout=undefined;const pc=peerInfos.peerConnection;if(!pc||pc.iceConnectionState==="connected"){return;}
if(["connected","closed"].includes(pc.connectionState)){return;}
if(debugShowLog){console.log(`%c RTC RECOVERY: calling back peer ${peerId} to salvage the connection ${pc.iceConnectionState} after ${backoffDelay}ms, reason: ${reason}`,"background: darkorange; color: white;");}
this.removePeer(peerId);const newPeerInfos=this._createPeer(peerId);newPeerInfos.backoffFactor=backoffFactor+1;},backoffDelay);}
_killPotentialZombie(peerId){if(this._stopped){this.removePeer(peerId);return;}
const peerInfos=this.peersInfos[peerId];if(!peerInfos||peerInfos.zombieTimeout){return;}
peerInfos.zombieTimeout=setTimeout(()=>{if(peerInfos&&peerInfos.dataChannel&&peerInfos.dataChannel.readyState!=="open"){if(debugShowLog){console.log(`%c KILL ZOMBIE ${peerId}`,"background: red;");}
this.removePeer(peerId);}else{if(debugShowLog){console.log(`%c NOT A ZOMBIE ${peerId}`,"background: green;");}}},10000);}}
const RequestError=__exports.RequestError=class RequestError extends Error{constructor(message){super(message);this.name="RequestError";}}
return __exports;});;

/* /html_editor/static/src/others/collaboration/collaboration_odoo_plugin.js */
odoo.define('@html_editor/others/collaboration/collaboration_odoo_plugin',['@html_editor/plugin','@web/core/network/rpc','@web/core/user','@web/core/utils/concurrency','@web/core/utils/timing','@html_editor/others/collaboration/PeerToPeer','@html_editor/utils/dom_traversal','@html_editor/utils/position'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{rpc}=require("@web/core/network/rpc");const{user}=require("@web/core/user");const{Mutex}=require("@web/core/utils/concurrency");const{debounce}=require("@web/core/utils/timing");const{PeerToPeer,RequestError}=require("@html_editor/others/collaboration/PeerToPeer");const{ancestors}=require("@html_editor/utils/dom_traversal");const{childNodeIndex}=require("@html_editor/utils/position");const PTP_MAX_RECOVERY_TIME=500;const REQUEST_ERROR=Symbol("REQUEST_ERROR");let ICE_SERVERS=null;const CollaborationOdooPlugin=__exports.CollaborationOdooPlugin=class CollaborationOdooPlugin extends Plugin{static id="collaborationOdoo";static dependencies=["baseContainer","history","collaboration","selection"];static shared=["getPeerMetadata"];resources={selectionchange_handlers:debounce(()=>{this.ptp?.notifyAllPeers("oe_history_set_selection",this.getCurrentCollaborativeSelection(),{transport:"rtc",});},50),clean_for_save_handlers:({root})=>this.attachHistoryIds(root),history_missing_parent_step_handlers:this.onHistoryMissingParentStep.bind(this),history_reset_handlers:this.onReset.bind(this),step_added_handlers:({step})=>this.ptp?.notifyAllPeers("oe_history_step",step,{transport:"rtc"}),};setup(){this.isDocumentStale=false;this.ptpJoined=false;this.lastCollaborationResetId=0;this.serverLastStepId=this.config.content&&this.getLastHistoryStepId(this.config.content);this.setupCollaboration(this.config.collaboration.collaborationChannel);const collaborativeTrigger=this.config.collaboration.collaborativeTrigger;this.joinPeerToPeer=this.joinPeerToPeer.bind(this);if(collaborativeTrigger==="start"){this.joinPeerToPeer();}else if(collaborativeTrigger==="focus"||typeof collaborativeTrigger==="undefined"){this.editable.addEventListener("focus",this.joinPeerToPeer);}
stripHistoryIds(this.editable);}
destroy(){this.collaborationStopBus&&this.collaborationStopBus();if(this.peerToPeerLoading){this.peerToPeerLoading.then(()=>{this.stopPeerToPeer();});}
super.destroy();}
stopPeerToPeer(){this.joiningPtp=false;this.ptpJoined=false;this.resetCollabRequests();this.ptp&&this.ptp.stop();}
getCurrentCollaborativeSelection(){const selection=this.dependencies.selection.getEditableSelection();return{selection:this.dependencies.history.serializeSelection(selection),peerId:this.config.collaboration.peerId,};}
setupCollaboration(collaborationChannel){const modelName=collaborationChannel.collaborationModelName;const fieldName=collaborationChannel.collaborationFieldName;const resId=collaborationChannel.collaborationResId;const channelName=`editor_collaboration:${modelName}:${fieldName}:${resId}`;if(!(modelName&&fieldName&&resId)){return;}
this.collaborationChannelName=channelName;this.historyStepsBuffer=[];const collaborationBusListener=(payload)=>{if(payload.model_name===modelName&&payload.field_name===fieldName&&payload.res_id===resId){if(payload.notificationName==="html_field_write"){this.onServerLastIdUpdate(payload.notificationPayload.last_step_id);}else if(this.ptpJoined){this.peerToPeerLoading.then(()=>this.ptp.handleNotification(payload));}}};const{busService}=this.config.collaboration;busService.subscribe("editor_collaboration",collaborationBusListener);busService.addChannel(this.collaborationChannelName);this.collaborationStopBus=()=>{busService.unsubscribe("editor_collaboration",collaborationBusListener);busService.deleteChannel(this.collaborationChannelName);};this.startCollaborationTime=new Date().getTime();const loadPeerToPeer=async()=>{if(!ICE_SERVERS){ICE_SERVERS=await rpc("/html_editor/get_ice_servers");}
let iceServers=ICE_SERVERS;if(!iceServers.length){iceServers=[{urls:["stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302"],},];}
this.iceServers=iceServers;this.ptp=this.getNewPtp();};this.peerToPeerLoading=loadPeerToPeer();}
getNewPtp(){const rpcMutex=new Mutex();const{collaborationChannel}=this.config.collaboration;const modelName=collaborationChannel.collaborationModelName;const fieldName=collaborationChannel.collaborationFieldName;const resId=collaborationChannel.collaborationResId;this.historySyncAtLeastOnce=false;return new PeerToPeer({peerConnectionConfig:{iceServers:this.iceServers},currentPeerId:this.config.collaboration.peerId,broadcastAll:(rpcData)=>rpcMutex.exec(async()=>rpc("/html_editor/bus_broadcast",{model_name:modelName,field_name:fieldName,res_id:resId,bus_data:rpcData,})),onRequest:{get_peer_metadata:this.getMetadata.bind(this),get_missing_steps:(params)=>this.dependencies.collaboration.historyGetMissingSteps(params.requestPayload),get_history_from_snapshot:()=>this.getHistorySnapshot(),get_collaborative_selection:()=>this.getCurrentCollaborativeSelection(),recover_document:(params)=>{const{serverDocumentId,fromStepId}=params.requestPayload;if(!this.dependencies.collaboration.getBranchIds().includes(serverDocumentId)){return;}
return{missingSteps:this.dependencies.collaboration.historyGetMissingSteps({fromStepId,}),snapshot:this.getHistorySnapshot(),};},},onNotification:async(notification)=>{this.dispatchTo("collaboration_notification_handlers",notification);let{fromPeerId,notificationName,notificationPayload}=notification;switch(notificationName){case"ptp_remove":break;case"ptp_disconnect":this.ptp.removePeer(fromPeerId);break;case"rtc_data_channel_open":{fromPeerId=notificationPayload.connectionPeerId;const metadata=await this.requestPeer(fromPeerId,"get_peer_metadata",undefined,{transport:"rtc"});if(metadata===REQUEST_ERROR){return;}
this.ptp.peersInfos[fromPeerId].metadata=metadata;if(!this.historySyncAtLeastOnce){const localPeer={id:this.config.collaboration.peerId,startTime:this.startCollaborationTime,};const remotePeer={id:fromPeerId,startTime:metadata.startTime,};if(isPeerFirst(localPeer,remotePeer)){this.historySyncAtLeastOnce=true;this.historySyncFinished=true;}else{this.resetCollabRequests();const response=await this.resetFromPeer(fromPeerId,this.lastCollaborationResetId);if(response===REQUEST_ERROR){return;}}}else{this.ptp.notifyAllPeers("oe_history_step",this.dependencies.history.getHistorySteps().at(-1),{transport:"rtc"});this.resetCollaborativeSelection(fromPeerId);}
break;}
case"oe_history_step":if(this.historySyncFinished){this.dependencies.collaboration.onExternalHistorySteps([notificationPayload,]);}else{this.historyStepsBuffer.push(notificationPayload);}
break;case"oe_history_set_selection":{const peer=this.ptp.peersInfos[fromPeerId];if(!peer){return;}
const selection=notificationPayload;this.onExternalMultiselectionUpdate(selection);break;}}},});}
getPeerMetadata(peerId){return this.ptp.peersInfos[peerId]?.metadata;}
onExternalMultiselectionUpdate(selection){this.dispatchTo("collaborative_selection_update_handlers",selection);}
async requestPeer(peerId,requestName,requestPayload,params){return this.ptp.requestPeer(peerId,requestName,requestPayload,params).catch((e)=>{if(e instanceof RequestError){return REQUEST_ERROR;}else{throw e;}});}
getMetadata(){const metadatas={startTime:this.startCollaborationTime,peerName:user.name,};for(const cb of this.getResource("collaboration_peer_metadata_providers")){Object.assign(metadatas,cb());}
return metadatas;}
onServerLastIdUpdate(last_step_id){this.serverLastStepId=last_step_id;this.isDocumentStale=this.isLastDocumentStale();if(this.isDocumentStale&&this.ptpJoined){return this.recoverFromStaleDocument();}else if(this.isDocumentStale&&this.joiningPtp){this.resetCollabRequests();this.joinPeerToPeer();}}
joinPeerToPeer(){this.editable.removeEventListener("focus",this.joinPeerToPeer);if(this.peerToPeerLoading){return this.peerToPeerLoading.then(async()=>{this.joiningPtp=true;if(this.isDocumentStale){const success=await this.resetFromServerAndResyncWithPeers();if(!success){return;}}
this.ptp.notifyAllPeers("ptp_join");this.joiningPtp=false;this.ptpJoined=true;});}}
isLastDocumentStale(){if(!this.serverLastStepId){return false;}
return!this.dependencies.collaboration.getBranchIds().includes(this.serverLastStepId);}
async recoverFromStaleDocument(){return new Promise((resolve)=>{const resetCollabCount=this.lastCollaborationResetId;const allPeers=this.getPtpPeers().map((peer)=>peer.id);if(allPeers.length===0){if(this.isDocumentStale){this.showConflictDialog();resolve();return this.resetFromServerAndResyncWithPeers();}}
let hasRetrievalBudgetTimeout=false;const snapshots=[];let nbPendingResponses=allPeers.length;const success=()=>{resolve();clearTimeout(timeout);};for(const peerId of allPeers){this.requestPeer(peerId,"recover_document",{serverDocumentId:this.serverLastStepId,fromStepId:this.dependencies.collaboration.getBranchIds().at(-1),},{transport:"rtc"}).then((response)=>{nbPendingResponses--;if(response===REQUEST_ERROR||resetCollabCount!==this.lastCollaborationResetId||hasRetrievalBudgetTimeout||!response||!this.isDocumentStale){if(nbPendingResponses<=0){processSnapshots();}
return;}
this.processMissingSteps(response.missingSteps);this.isDocumentStale=this.isLastDocumentStale();snapshots.push(response.snapshot);if(nbPendingResponses<1){processSnapshots();}});}
const processSnapshots=async()=>{this.isDocumentStale=this.isLastDocumentStale();if(!this.isDocumentStale){return success();}
if(snapshots[0]){this.showConflictDialog();}
for(const snapshot of snapshots){this.applySnapshot(snapshot);this.isDocumentStale=this.isLastDocumentStale();if(!this.isDocumentStale){return success();}}
if(this.isDocumentStale){this.showConflictDialog();await this.resetFromServerAndResyncWithPeers();}
success();};const timeout=setTimeout(()=>{if(resetCollabCount!==this.lastCollaborationResetId){return;}
hasRetrievalBudgetTimeout=true;this.onRecoveryPeerTimeout(processSnapshots);},PTP_MAX_RECOVERY_TIME);});}
getPtpPeers(){const peers=Object.entries(this.ptp.peersInfos).map(([peerId,peerInfo])=>({id:peerId,...peerInfo,}));return peers.sort((a,b)=>(isPeerFirst(a,b)?-1:1));}
getLastHistoryStepId(value){const matchId=value.match(/data-last-history-steps="[0-9,]*?([0-9]+)"/);return matchId&&matchId[1];}
resetCollabRequests(){this.lastCollaborationResetId++;this.ptp&&this.ptp.abortCurrentRequests();}
async resetFromServerAndResyncWithPeers(){let collaborationResetId=this.lastCollaborationResetId;const record=await this.getCurrentRecord();if(collaborationResetId!==this.lastCollaborationResetId){return;}
const content=record[this.config.collaboration.collaborationChannel.collaborationFieldName];const lastHistoryId=content&&this.getLastHistoryStepId(content);if(this.serverLastStepId!==lastHistoryId){throw new Error("Concurency detected while recovering from a stale document. The last history id of the server is different from the history id received by the html_field_write event.");}
this.isDocumentStale=false;if(content){this.editable.innerHTML=content;}else{this.editable.replaceChildren(this.dependencies.baseContainer.createBaseContainer());}
stripHistoryIds(this.editable);this.dispatchTo("normalize_handlers",this.editable);this.dependencies.history.reset(content);this.historySyncAtLeastOnce=false;this.resetCollabRequests();collaborationResetId=this.lastCollaborationResetId;this.startCollaborationTime=new Date().getTime();await Promise.all(this.getPtpPeers().map((peer)=>this.resetFromPeer(peer.id,collaborationResetId)));return true;}
onReset(content){this.historyShareId=Math.floor(Math.random()*Math.pow(2,52)).toString();const lastStepId=content&&content.match(/data-last-history-steps="([\d,]+)"/)?.[1];if(lastStepId){this.dependencies.collaboration.setInitialBranchStepId(lastStepId);}}
async processMissingSteps(missingSteps){if(missingSteps===-1||!missingSteps.length){return false;}
this.dependencies.collaboration.onExternalHistorySteps(missingSteps);return true;}
applySnapshot(snapshot){const{steps,historyIds,historyShareId}=snapshot;const isStaleDocument=this.serverLastStepId&&!historyIds.includes(this.serverLastStepId);if(isStaleDocument){return;}
this.historyShareId=historyShareId;this.historySyncAtLeastOnce=true;this.dependencies.collaboration.resetFromSteps(steps,historyIds);return true;}
async onRecoveryPeerTimeout(processSnapshots){processSnapshots();}
showConflictDialog(){}
getHistorySnapshot(){return Object.assign({},this.dependencies.collaboration.getSnapshotSteps(),{historyShareId:this.historyShareId,});}
async resetFromPeer(fromPeerId,resetCollabCount){this.historySyncFinished=false;this.historyStepsBuffer=[];const snapshot=await this.requestPeer(fromPeerId,"get_history_from_snapshot",undefined,{transport:"rtc"});if(snapshot===REQUEST_ERROR){return REQUEST_ERROR;}
if(resetCollabCount!==this.lastCollaborationResetId){return;}
if(this.historySyncAtLeastOnce){return;}
const selection=this.dependencies.selection.getEditableSelection();let anchorNodeIndexPath=this._getNodeIndexPath(selection.anchorNode);let anchorOffset=selection.anchorOffset;if(selection.anchorNode===this.editable){anchorNodeIndexPath=this._getNodeIndexPath(this.editable.firstChild);anchorOffset=0;}
const applied=this.applySnapshot(snapshot);if(!applied){return;}
const anchorNode=this._getNodeFromIndexPath(anchorNodeIndexPath);if(this.dependencies.selection.isSelectionInEditable({anchorNode,focusNode:anchorNode})){this.dependencies.selection.setSelection({anchorNode,anchorOffset,});}
this.historySyncFinished=true;if(this.historyStepsBuffer.length){this.dependencies.collaboration.onExternalHistorySteps(this.historyStepsBuffer);this.historyStepsBuffer=[];}
this.editable.dispatchEvent(new CustomEvent("onHistoryResetFromPeer"));this.resetCollaborativeSelection(fromPeerId);}
async resetCollaborativeSelection(fromPeerId){const remoteSelection=await this.requestPeer(fromPeerId,"get_collaborative_selection",undefined,{transport:"rtc"});if(remoteSelection===REQUEST_ERROR){return;}
if(remoteSelection){this.onExternalMultiselectionUpdate(remoteSelection);}}
async onHistoryMissingParentStep({step,fromStepId}){if(!this.ptp){return;}
const missingSteps=await this.requestPeer(step.peerId,"get_missing_steps",{fromStepId:fromStepId,toStepId:step.id,},{transport:"rtc"});if(missingSteps===REQUEST_ERROR){return;}
this.processMissingSteps(Array.isArray(missingSteps)?missingSteps.concat(step):missingSteps);}
async getCurrentRecord(){const[record]=await this.config.collaboration.ormService.read(this.config.collaboration.collaborationChannel.collaborationModelName,[this.config.collaboration.collaborationChannel.collaborationResId],[this.config.collaboration.collaborationChannel.collaborationFieldName]);return record;}
attachHistoryIds(editable){const historyIds=this.dependencies.collaboration.getBranchIds().join(",");const firstChild=editable.children[0];if(firstChild){firstChild.setAttribute("data-last-history-steps",historyIds);}}
_getNodeIndexPath(node){return[node,...ancestors(node,this.editable)].map((ancestor)=>childNodeIndex(ancestor));}
_getNodeFromIndexPath(indexPath){return indexPath.reduceRight((node,index)=>node?.childNodes?.[index],this.editable.parentElement);}}
function isPeerFirst(peerA,peerB){if(peerA.startTime===peerB.startTime){return peerA.id.localeCompare(peerB.id)===-1;}
if(peerA.startTime===undefined||peerB.startTime===undefined){return Boolean(peerA.startTime);}else{return peerA.startTime<peerB.startTime;}}
__exports.stripHistoryIds=stripHistoryIds;function stripHistoryIds(element){element.querySelectorAll("[data-last-history-steps]").forEach((el)=>el.removeAttribute("data-last-history-steps"));}
return __exports;});;

/* /html_editor/static/src/others/collaboration/collaboration_plugin.js */
odoo.define('@html_editor/others/collaboration/collaboration_plugin',['@html_editor/plugin'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const HISTORY_SNAPSHOT_INTERVAL=__exports.HISTORY_SNAPSHOT_INTERVAL=1000*60;const HISTORY_SNAPSHOT_BUFFER_TIME=1000*10;const CollaborationPlugin=__exports.CollaborationPlugin=class CollaborationPlugin extends Plugin{static id="collaboration";static dependencies=["history","selection","sanitize"];resources={history_cleaned_handlers:this.onHistoryClean.bind(this),history_reset_handlers:this.onHistoryReset.bind(this),step_added_handlers:({step})=>this.onStepAdded(step),set_attribute_overrides:this.setAttribute.bind(this),history_step_processors:this.processHistoryStep.bind(this),unreversible_step_predicates:this.isUnreversibleStep.bind(this),};static shared=["getBranchIds","getSnapshotSteps","historyGetMissingSteps","onExternalHistorySteps","resetFromSteps","setInitialBranchStepId",];peerId=null;setup(){this.peerId=this.config.collaboration.peerId;if(!this.peerId){throw new Error("The collaboration plugin requires a peerId");}
this._snapshotInterval=setInterval(()=>{this.makeSnapshot();},HISTORY_SNAPSHOT_INTERVAL);}
destroy(){super.destroy();clearInterval(this._snapshotInterval);this._snapshotInterval=false;}
onHistoryClean(){this.branchStepIds=[];}
onHistoryReset(){const firstStep=this.dependencies.history.getHistorySteps()[0];this.snapshots=[{step:firstStep}];}
isUnreversibleStep(step){return step.peerId!==this.peerId;}
setAttribute(node,attributeName,attributeValue){if(attributeValue){this.safeSetAttribute(node,attributeName,attributeValue);return true;}}
getBranchIds(){const steps=this.dependencies.history.getHistorySteps();return(this.initialBranchStepId||"").split(",").concat(this.branchStepIds).concat(steps.map((s)=>s.id));}
safeSetAttribute(node,attributeName,attributeValue){const clone=this.document.createElement(node.tagName);clone.setAttribute(attributeName,attributeValue);this.dependencies.sanitize.sanitize(clone);if(clone.hasAttribute(attributeName)){node.setAttribute(attributeName,clone.getAttribute(attributeName));}else{node.removeAttribute(attributeName);}}
onExternalHistorySteps(newSteps){let stepIndex=0;const selectionData=this.dependencies.selection.getSelectionData();const steps=this.dependencies.history.getHistorySteps();for(const newStep of newSteps){const insertIndex=this.getInsertStepIndex(steps,newStep);if(typeof insertIndex==="undefined"){continue;}
this.dependencies.history.addExternalStep(newStep,insertIndex);stepIndex++;}
if(selectionData.documentSelectionIsInEditable){this.dependencies.selection.rectifySelection(selectionData.editableSelection);}
this.dispatchTo("external_history_step_handlers");if(stepIndex){this.config.onChange?.();}}
getInsertStepIndex(steps,newStep){let index=steps.length-1;while(index>=0&&steps[index].id!==newStep.previousStepId){if(steps[index].id===newStep.id){return;}
index--;}
if(index<0){const historySteps=steps;let index=historySteps.length-1;while(index!==0){if(historySteps[index].peerId===newStep.peerId){break;}
index--;}
const fromStepId=historySteps[index].id;this.dispatchTo("history_missing_parent_step_handlers",{step:newStep,fromStepId:fromStepId,});return;}
let concurentSteps=[];index++;while(index<steps.length){if(steps[index].previousStepId===newStep.previousStepId){if(steps[index].id.localeCompare(newStep.id)===1){break;}else{concurentSteps=[steps[index].id];}}else{if(concurentSteps.includes(steps[index].previousStepId)){concurentSteps.push(steps[index].id);}else{break;}}
index++;}
return index;}
historyGetMissingSteps({fromStepId,toStepId}){const steps=this.dependencies.history.getHistorySteps();const fromIndex=steps.findIndex((x)=>x.id===fromStepId);const toIndex=toStepId?steps.findIndex((x)=>x.id===toStepId):steps.length;if(fromIndex===-1||toIndex===-1){return-1;}
return steps.slice(fromIndex+1,toIndex);}
getSnapshotSteps(){const historySteps=this.dependencies.history.getHistorySteps();if(!this.snapshots[0].time){return{steps:historySteps,historyIds:this.getBranchIds()};}
const snapshotSteps=[];let snapshot;if(this.snapshots[0].time+HISTORY_SNAPSHOT_BUFFER_TIME<Date.now()){snapshot=this.snapshots[0];}else{snapshot=this.snapshots[1];}
let index=historySteps.length-1;while(historySteps[index].id!==snapshot.step.id){snapshotSteps.push(historySteps[index]);index--;}
snapshotSteps.push(snapshot.step);snapshotSteps.reverse();return{steps:snapshotSteps,historyIds:this.getBranchIds()};}
setInitialBranchStepId(stepId){this.initialBranchStepId=stepId;}
resetFromSteps(steps,branchStepIds){this.dependencies.selection.resetSelection();this.dependencies.history.resetFromSteps(steps);this.snapshots=[{step:steps[0]}];this.branchStepIds=branchStepIds;}
makeSnapshot(){const historyLength=this.dependencies.history.getHistorySteps().length;if(!this.lastSnapshotLength||this.lastSnapshotLength<historyLength){this.lastSnapshotLength=historyLength;const step=this.dependencies.history.makeSnapshotStep();const snapshot={time:Date.now(),step:step,};this.snapshots=[snapshot,this.snapshots[0]];}}
onStepAdded(step){step.peerId=this.peerId;this.dispatchTo("collaboration_step_added_handlers",step);}
processHistoryStep(step){step.peerId=this.peerId;return step;}}
return __exports;});;

/* /html_editor/static/src/others/collaboration/collaboration_selection_avatar_plugin.js */
odoo.define('@html_editor/others/collaboration/collaboration_selection_avatar_plugin',['@html_editor/plugin','@html_editor/utils/blocks','@html_editor/utils/dom_traversal','@web/core/browser/browser','@web/core/l10n/translation','@web/core/user'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{closestBlock,isBlock}=require("@html_editor/utils/blocks");const{closestElement}=require("@html_editor/utils/dom_traversal");const{browser}=require("@web/core/browser/browser");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{user}=require("@web/core/user");const AVATAR_SIZE=__exports.AVATAR_SIZE=25;const CollaborationSelectionAvatarPlugin=__exports.CollaborationSelectionAvatarPlugin=class CollaborationSelectionAvatarPlugin extends Plugin{static id="collaborationSelectionAvatar";static dependencies=["history","position","localOverlay","collaborationOdoo"];resources={collaboration_notification_handlers:this.handleCollaborationNotification.bind(this),external_history_step_handlers:this.refreshSelection.bind(this),layout_geometry_change_handlers:this.refreshSelection.bind(this),set_movable_element_handlers:this.disableAvatarForElement.bind(this),unset_movable_element_handlers:this.enableAvatars.bind(this),collaborative_selection_update_handlers:this.updateSelection.bind(this),collaboration_peer_metadata_providers:()=>({avatarUrl:this.avatarUrl}),};selectionInfos=new Map();setup(){this.avatarOverlay=this.dependencies.localOverlay.makeLocalOverlay("oe-avatars-overlay");this.avatarsCountersOverlay=this.dependencies.localOverlay.makeLocalOverlay("oe-avatars-counters-overlay");this.avatarUrl=`${
            browser.location.origin
        }/web/image?model=res.users&field=avatar_128&id=${encodeURIComponent(user.userId)}`;}
handleCollaborationNotification({notificationName,notificationPayload}){switch(notificationName){case"ptp_remove":this.selectionInfos.delete(notificationPayload);this.refreshSelection();}}
updateSelection(selection){const savedSelection=this.selectionInfos.get(selection.peerId)||{};const newSelection=Object.assign(savedSelection,selection);this.selectionInfos.set(selection.peerId,newSelection);this.drawPeerAvatar(newSelection);this.updateAvatarCounters();}
drawPeerAvatar(selectionInfo){const{selection,peerId}=selectionInfo;const peerMetadata=this.dependencies.collaborationOdoo.getPeerMetadata(peerId);if(!peerMetadata){return;}
const{avatarUrl,peerName=_t("Anonymous")}=peerMetadata;const anchorNode=this.dependencies.history.getNodeById(selection.anchorNodeId);const focusNode=this.dependencies.history.getNodeById(selection.focusNodeId);if(!anchorNode||!focusNode||!anchorNode.isConnected||!focusNode.isConnected){return;}
const anchorBlock=closestElement(anchorNode,(el)=>isBlock(el)&&el.parentElement===this.editable)||closestBlock(anchorNode);if(!anchorBlock){return;}
const containerRect=this.avatarOverlay.getBoundingClientRect();let avatarElement=selectionInfo.avatarElement;if(!avatarElement){avatarElement=this.document.createElement("div");avatarElement.className="oe-collaboration-caret-avatar";avatarElement.style.display="none";const image=this.document.createElement("img");avatarElement.append(image);image.onload=()=>avatarElement.style.removeProperty("display");image.setAttribute("src",avatarUrl);image.classList.add("object-fit-cover");}
if(!avatarElement.parentElement){this.avatarOverlay.append(avatarElement);}
selectionInfo.avatarElement=avatarElement;selectionInfo.peerName=peerName;selectionInfo.avatarTargetElement=anchorBlock;this.selectionInfos.set(peerId,selectionInfo);const anchorBlockRect=anchorBlock.getBoundingClientRect();const top=anchorBlockRect.y-containerRect.y;avatarElement.style.top=top+"px";const closestList=closestElement(anchorNode,"ul, ol");const anchorX=closestList?closestList.getBoundingClientRect().x:anchorBlockRect.x;const left=anchorX-containerRect.x-AVATAR_SIZE;avatarElement.style.left=left+"px";selectionInfo.avatarPositionKey=`${left}|${top}`;}
updateAvatarCounters(){const avatarsOverlaps={};for(const info of this.selectionInfos.values()){const key=info.avatarPositionKey;avatarsOverlaps[key]=avatarsOverlaps[key]||new Set();avatarsOverlaps[key].add(info);}
this.avatarsCountersOverlay.replaceChildren();for(const[overlapKey,infos]of Object.entries(avatarsOverlaps)){const size=infos.size;if(size>1){const[left,top]=overlapKey.split("|").map((n)=>parseInt(n,10));const div=document.createElement("div");div.className="oe-overlapping-counter";div.style.left=left+10+"px";div.style.top=top+10+"px";div.innerText=size;this.avatarsCountersOverlay.append(div);}}}
refreshSelection(){if(!this.selectionInfos.size){this.avatarOverlay.replaceChildren();}
this.avatarsCountersOverlay.replaceChildren();for(const selection of this.selectionInfos.values()){this.drawPeerAvatar(selection);}
this.updateAvatarCounters();}
disableAvatarForElement(element){this.enableAvatars();for(const info of this.selectionInfos.values()){if(info.avatarTargetElement===element){if(!info.avatarElement.classList.contains("invisible")){info.avatarElement.classList.add("invisible");}}}}
enableAvatars(){for(const element of this.avatarOverlay.querySelectorAll(".oe-collaboration-caret-avatar.invisible")){element.classList.remove("invisible");}}}
return __exports;});;

/* /html_editor/static/src/others/collaboration/collaboration_selection_plugin.js */
odoo.define('@html_editor/others/collaboration/collaboration_selection_plugin',['@html_editor/plugin','@html_editor/utils/dom_info','@html_editor/utils/dom_traversal','@html_editor/utils/position','@html_editor/utils/selection','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{getDeepestPosition,isProtected,isProtecting,isUnprotecting,}=require("@html_editor/utils/dom_info");const{childNodes}=require("@html_editor/utils/dom_traversal");const{DIRECTIONS}=require("@html_editor/utils/position");const{getCursorDirection}=require("@html_editor/utils/selection");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const CollaborationSelectionPlugin=__exports.CollaborationSelectionPlugin=class CollaborationSelectionPlugin extends Plugin{static id="collaborationSelection";static dependencies=["history","collaborationOdoo","position","localOverlay"];resources={collaboration_notification_handlers:this.handleCollaborationNotification.bind(this),layout_geometry_change_handlers:this.refreshSelection.bind(this),collaborative_selection_update_handlers:this.updateSelection.bind(this),collaboration_peer_metadata_providers:()=>({selectionColor:this.selectionColor}),};selectionInfos=new Map();setup(){this.selectionOverlay=this.dependencies.localOverlay.makeLocalOverlay("oe-selections-container");this.selectionColor=`hsl(${(Math.random() * 360).toFixed(0)}, 75%, 50%)`;}
handleCollaborationNotification({notificationName,notificationPayload}){switch(notificationName){case"ptp_remove":this.multiselectionRemove(notificationPayload);this.selectionInfos.delete(notificationPayload);break;}}
updateSelection(selection){this.selectionInfos.set(selection.peerId,selection);this.drawPeerSelection(selection);}
drawPeerSelection({selection,peerId}){const peerMetadata=this.dependencies.collaborationOdoo.getPeerMetadata(peerId);if(!peerMetadata){return;}
const{selectionColor,peerName=_t("Anonymous")}=peerMetadata;this.multiselectionRemove(peerId);let clientRects;let anchorNode=this.dependencies.history.getNodeById(selection.anchorNodeId);let focusNode=this.dependencies.history.getNodeById(selection.focusNodeId);let anchorOffset=selection.anchorOffset;let focusOffset=selection.focusOffset;if(!anchorNode||!focusNode){anchorNode=this.editable.children[0];focusNode=this.editable.children[0];anchorOffset=0;focusOffset=0;}
const anchorTarget=childNodes(anchorNode).at(anchorOffset);const focusTarget=childNodes(focusNode).at(focusOffset);const protectionCheck=(node)=>isProtecting(node)||(isProtected(node)&&!isUnprotecting(node));if(protectionCheck(anchorTarget)||protectionCheck(focusTarget)){return;}
if(anchorNode.isConnected&&focusNode.isConnected){[anchorNode,anchorOffset]=getDeepestPosition(anchorNode,anchorOffset);[focusNode,focusOffset]=getDeepestPosition(focusNode,focusOffset);}else{anchorNode=this.editable.children[0];focusNode=this.editable.children[0];anchorOffset=0;focusOffset=0;}
const direction=getCursorDirection(anchorNode,anchorOffset,focusNode,focusOffset);const range=new Range();try{if(direction===DIRECTIONS.RIGHT){range.setStart(anchorNode,anchorOffset);range.setEnd(focusNode,focusOffset);}else{range.setStart(focusNode,focusOffset);range.setEnd(anchorNode,anchorOffset);}
clientRects=Array.from(range.getClientRects());}catch{clientRects=[];}
if(!clientRects.length){return;}
const containerRect=this.selectionOverlay.getBoundingClientRect();const indicators=clientRects.map(({x,y,width,height})=>{const rectElement=this.document.createElement("div");rectElement.style=`
                position: absolute;
                top: ${y - containerRect.y}px;
                left: ${x - containerRect.x}px;
                width: ${width}px;
                height: ${height}px;
                background-color: ${selectionColor};
                opacity: 0.25;
                pointer-events: none;
            `;rectElement.setAttribute("data-selection-peer-id",peerId);return rectElement;});const caretElement=this.document.createElement("div");caretElement.style=`border-left: 2px solid ${selectionColor}; position: absolute;`;caretElement.setAttribute("data-selection-peer-id",peerId);caretElement.className="oe-collaboration-caret";const caretTopSquare=this.document.createElement("div");caretTopSquare.className="oe-collaboration-caret-top-square";caretTopSquare.style["background-color"]=selectionColor;caretTopSquare.setAttribute("data-peer-name",peerName);caretElement.append(caretTopSquare);if(direction===DIRECTIONS.LEFT){const rect=clientRects[0];caretElement.style.height=`${rect.height * 1.2}px`;caretElement.style.top=`${rect.y - containerRect.y}px`;caretElement.style.left=`${rect.x - containerRect.x}px`;}else{const rect=clientRects.at(-1);caretElement.style.height=`${rect.height * 1.2}px`;caretElement.style.top=`${rect.y - containerRect.y}px`;caretElement.style.left=`${rect.right - containerRect.x}px`;}
this.selectionOverlay.append(caretElement,...indicators);}
multiselectionRemove(peerId){const elements=this.selectionOverlay.querySelectorAll(`[data-selection-peer-id="${peerId}"]`);for(const element of elements){element.remove();}}
refreshSelection(){this.selectionOverlay.replaceChildren();for(const selection of this.selectionInfos.values()){this.drawPeerSelection(selection);}}}
return __exports;});;

/* /html_editor/static/src/others/embedded_components/backend/caption/caption.js */
odoo.define('@html_editor/others/embedded_components/backend/caption/caption',['@html_editor/others/embedded_component_utils','@odoo/owl'],function(require){'use strict';let __exports={};const{applyObjectPropertyDifference,getEmbeddedProps,StateChangeManager,}=require("@html_editor/others/embedded_component_utils");const{Component,useState,useRef,onMounted,onWillDestroy}=require("@odoo/owl");const EmbeddedCaptionComponent=__exports.EmbeddedCaptionComponent=class EmbeddedCaptionComponent extends Component{static template="html_editor.EmbeddedCaption";static props={image:{type:Element},onUpdateCaption:{type:Function},onEditorHistoryApply:{type:Function},focusInput:{type:Boolean},host:{type:Object},};setup(){super.setup();this.state=useState({caption:"",host:this.props.host,});this.captionInput=useRef("captionInput");if(this.props.focusInput){onMounted(()=>{this.captionInput.el.focus();});}
this.updateCaption();const observer=new MutationObserver((mutations)=>{for(const mutation of mutations){if(mutation.type==="attributes"&&mutation.attributeName==="data-caption"){this.updateCaption();}}});observer.observe(this.props.image,{attributes:true});onWillDestroy(()=>{observer.disconnect();});}
updateCaption(caption=this.props.image.getAttribute("data-caption")){if(caption!==this.state.caption){this.state.caption=caption;this.props.onUpdateCaption(caption);}}
onInputBlur(){setTimeout(()=>{if(this.captionInput.el){this.updateCaption(this.captionInput.el.value||"");}});}
onInputKeyup(ev){if(ev.key==="z"&&ev.ctrlKey&&!this._appliedNativeHistory){this.props.onEditorHistoryApply(ev.shiftKey);}
this._appliedNativeHistory=false;}
onInputBeforeInput(ev){this._appliedNativeHistory=false;if(ev.inputType==="historyUndo"||ev.inputType==="historyRedo"){this._appliedNativeHistory=true;}}}
const captionEmbedding=__exports.captionEmbedding={name:"caption",Component:EmbeddedCaptionComponent,getProps:(host)=>({host,...getEmbeddedProps(host)}),getStateChangeManager:(config)=>new StateChangeManager(Object.assign(config,{propertyUpdater:{caption:(state,previous,next)=>{applyObjectPropertyDifference(state,"caption",previous.caption,next.caption);},},})),};return __exports;});;

/* /html_editor/static/src/others/embedded_components/backend/file/file.js */
odoo.define('@html_editor/others/embedded_components/backend/file/file',['@html_editor/others/embedded_component_utils','@odoo/owl','@html_editor/others/embedded_components/core/file/readonly_file'],function(require){'use strict';let __exports={};const{applyObjectPropertyDifference,getEmbeddedProps,StateChangeManager,useEmbeddedState,}=require("@html_editor/others/embedded_component_utils");const{useEffect,useRef,useState}=require("@odoo/owl");const{ReadonlyEmbeddedFileComponent}=require("@html_editor/others/embedded_components/core/file/readonly_file");const EmbeddedFileComponent=__exports.EmbeddedFileComponent=class EmbeddedFileComponent extends ReadonlyEmbeddedFileComponent{static template="html_editor.EmbeddedFile";setup(){super.setup();this.state=useEmbeddedState(this.props.host);this.fileModel.state=this.state;this.localState=useState({editFileName:false,});this.nameInput=useRef("nameInput");useEffect(()=>{if(this.localState.editFileName){this.nameInput.el.focus();this.nameInput.el.select();}},()=>[this.localState.editFileName]);}
onBlurNameInput(ev){this.localState.editFileName=false;this.renameFile();}
onFocusFileName(ev){this.localState.editFileName=true;}
onKeydownNameInput(ev){if(ev.key!=="Enter"){return;}else{ev.preventDefault();}
if(this.renameFile()){this.localState.editFileName=false;this.env.editorShared?.setSelectionAfter(this.props.host);}}
renameFile(){let newName=this.nameInput.el.value;if(!newName.length){return false;}
if(newName===this.fileModel.filename){return true;}
this.fileModel.filename=newName;if(this.fileModel.extension){const pattern=new RegExp(`\\.${this.fileModel.extension}$`,"i");if(!newName.match(pattern)){newName+=`.${this.fileModel.extension}`;}}
this.fileModel.name=newName;return true;}}
const fileEmbedding=__exports.fileEmbedding={name:"file",Component:EmbeddedFileComponent,getProps:(host)=>({host,...getEmbeddedProps(host)}),getStateChangeManager:(config)=>new StateChangeManager(Object.assign(config,{propertyUpdater:{fileData:(state,previous,next)=>{applyObjectPropertyDifference(state,"fileData",previous.fileData,next.fileData);},},})),};return __exports;});;

/* /html_editor/static/src/others/embedded_components/backend/syntax_highlighting/code_toolbar.js */
odoo.define('@html_editor/others/embedded_components/backend/syntax_highlighting/code_toolbar',['@odoo/owl','@web/core/copy_button/copy_button','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_item'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const{CopyButton}=require("@web/core/copy_button/copy_button");const{Dropdown}=require("@web/core/dropdown/dropdown");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const LANGUAGES=__exports.LANGUAGES={plaintext:"Plain Text",markdown:"Markdown",javascript:"Javascript",typescript:"Typescript",jsdoc:"JSDoc",java:"Java",python:"Python",html:"HTML",xml:"XML",svg:"SVG",json:"JSON",css:"CSS",sass:"SASS",scss:"SCSS",sql:"SQL",diff:"Diff",};const CodeToolbar=__exports.CodeToolbar=class CodeToolbar extends Component{static template="html_editor.CodeToolbar";static props={target:{validate:(el)=>el.nodeType===Node.ELEMENT_NODE},getContent:{type:Function},onLanguageChange:{type:Function},currentLanguage:{type:String},convertToParagraph:{type:Function},};static components={Dropdown,DropdownItem,CopyButton};setup(){super.setup();this.languages=LANGUAGES;}}
return __exports;});;

/* /html_editor/static/src/others/embedded_components/backend/syntax_highlighting/syntax_highlighting.js */
odoo.define('@html_editor/others/embedded_components/backend/syntax_highlighting/syntax_highlighting',['@html_editor/others/embedded_component_utils','@odoo/owl','@web/core/assets','@web/core/browser/cookie','@html_editor/others/embedded_components/core/syntax_highlighting/syntax_highlighting_utils','@html_editor/others/embedded_components/backend/syntax_highlighting/code_toolbar'],function(require){'use strict';let __exports={};const{getEmbeddedProps,StateChangeManager,useEmbeddedState,}=require("@html_editor/others/embedded_component_utils");const{Component,onMounted,onWillStart,useEffect,useRef,useState}=require("@odoo/owl");const{loadBundle}=require("@web/core/assets");const{cookie}=require("@web/core/browser/cookie");const{getPreValue,highlightPre,}=require("@html_editor/others/embedded_components/core/syntax_highlighting/syntax_highlighting_utils");const{CodeToolbar}=require("@html_editor/others/embedded_components/backend/syntax_highlighting/code_toolbar");const EmbeddedSyntaxHighlightingComponent=__exports.EmbeddedSyntaxHighlightingComponent=class EmbeddedSyntaxHighlightingComponent extends Component{static template="html_editor.EmbeddedSyntaxHighlighting";static components={CodeToolbar};static props={value:{type:String},languageId:{type:String},onTextareaFocus:{type:Function},convertToParagraph:{type:Function},host:{type:Object},};setup(){super.setup();this.state=useState({host:this.props.host,highlightedValue:"",});this.embeddedState=useEmbeddedState(this.props.host);this.preRef=useRef("pre");this.textareaRef=useRef("textarea");onWillStart(()=>this.loadPrism());onMounted(()=>{this.pre=this.preRef.el;this.textarea=this.textareaRef.el;this.document=this.textarea.ownerDocument;this.highlight();});useEffect(this.highlight.bind(this),()=>[this.embeddedState.value,this.embeddedState.languageId,]);}
loadPrism(){return loadBundle(`html_editor.assets_prism${cookie.get("color_scheme") === "dark" ? "_dark" : ""}`,{targetDoc:this.props.host.ownerDocument});}
highlight(){const focus=this.document.activeElement===this.textarea;highlightPre(this.pre,this.embeddedState.value,this.embeddedState.languageId);const preValue=getPreValue(this.pre);if(this.textarea.value!==preValue){this.textarea.value=preValue;}
if(focus){this.textarea.focus({preventScroll:true});this.props.onTextareaFocus();}
this.embeddedState.value=this.textarea.value;}
onInput(){this.textarea.focus();this.props.onTextareaFocus();this.embeddedState.value=this.textarea.value;}
onKeydown(ev){if(ev.key==="Tab"){ev.preventDefault();const tabSize=+getComputedStyle(this.textarea).tabSize||4;const tab=" ".repeat(tabSize);const{selectionStart,selectionEnd}=this.textarea;const collapsed=selectionStart===selectionEnd;let start=this.textarea.value.slice(0,selectionStart).lastIndexOf("\n");start=start===-1?0:start;let newValue="";let spacesRemovedAtStart=0;if(ev.shiftKey){let end=this.textarea.value.slice(selectionEnd,this.textarea.value.length).indexOf("\n");end=end===-1?0:end;end=selectionEnd+end;newValue=this.textarea.value.slice(0,start);const regex=new RegExp(`(\n|^)( |\u00A0){1,${tabSize}}`,"g");const startSlice=this.textarea.value.slice(start,selectionStart);const cleanStartSlice=startSlice.replace(regex,"$1");spacesRemovedAtStart=startSlice.length-cleanStartSlice.length;newValue+=cleanStartSlice;newValue+=this.textarea.value.slice(selectionStart,selectionEnd).replace(regex,"$1");newValue+=this.textarea.value.slice(selectionEnd,end).replace(regex,"$1");newValue+=this.textarea.value.slice(end,this.textarea.value.length);}else{if(collapsed&&/\S/.test(this.textarea.value.slice(start,selectionStart))){newValue=this.textarea.value.slice(0,selectionStart)+
tab+
this.textarea.value.slice(selectionStart,this.textarea.value.length);}else{newValue=start?this.textarea.value.slice(0,start):tab;newValue+=this.textarea.value.slice(start,selectionEnd).replaceAll("\n",`\n${tab}`);newValue+=this.textarea.value.slice(selectionEnd,this.textarea.value.length);}}
const insertedChars=newValue.length-this.textarea.value.length;this.textarea.value=newValue;const newStart=selectionStart+(ev.shiftKey?-spacesRemovedAtStart:tabSize);const newEnd=collapsed?newStart:selectionEnd+insertedChars;this.textarea.setSelectionRange(newStart,newEnd,this.textarea.selectionDirection);this.embeddedState.value=this.textarea.value;}else if(ev.key==="Backspace"){if(this.textarea.value===""){ev.preventDefault();this.props.convertToParagraph({target:this.pre});}}}
onScroll(){this.pre.scrollTop=this.textarea.scrollTop;this.pre.scrollLeft=this.textarea.scrollLeft;}
onLanguageChange(languageId){if(languageId&&this.embeddedState.languageId!==languageId){this.textarea.focus();this.props.onTextareaFocus();this.embeddedState.languageId=languageId;}}}
const syntaxHighlightingEmbedding=__exports.syntaxHighlightingEmbedding={name:"syntaxHighlighting",Component:EmbeddedSyntaxHighlightingComponent,getProps:(host)=>({host,...getEmbeddedProps(host)}),getStateChangeManager:(config)=>new StateChangeManager(config),};return __exports;});;

/* /html_editor/static/src/others/embedded_components/backend/video/video.js */
odoo.define('@html_editor/others/embedded_components/backend/video/video',['@html_editor/others/embedded_component_utils','@html_editor/utils/url','@odoo/owl','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_hooks','@web/core/dropdown/dropdown_item','@html_editor/others/embedded_components/core/video/readonly_video'],function(require){'use strict';let __exports={};const{getEmbeddedProps,StateChangeManager,useEmbeddedState,}=require("@html_editor/others/embedded_component_utils");const{getVideoUrl}=require("@html_editor/utils/url");const{Component,onMounted,onWillDestroy,onWillUnmount,useExternalListener,useRef,}=require("@odoo/owl");const{Dropdown}=require("@web/core/dropdown/dropdown");const{useDropdownState}=require("@web/core/dropdown/dropdown_hooks");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{ReadonlyEmbeddedVideoComponent}=require("@html_editor/others/embedded_components/core/video/readonly_video");const EmbeddedVideoComponent=__exports.EmbeddedVideoComponent=class EmbeddedVideoComponent extends ReadonlyEmbeddedVideoComponent{static template="html_editor.EmbeddedVideo";static props={platform:{type:String},videoId:{type:String},params:{type:Object,optional:true},host:{type:HTMLElement},createOverlay:{type:Function,optional:true},focusEditable:{type:Function,optional:true},addStep:{type:Function,optional:true},openVideoSelectorDialog:{type:Function,optional:true},};setup(){super.setup();this.videoBlock=this.props.host;this.state=useEmbeddedState(this.videoBlock);this.dropdown=useDropdownState();this.videoSettingsOverlay=this.props.createOverlay(VideoSettings,{positionOptions:{position:"right-start",},className:"video-overlay",closeOnPointerdown:false,});this.iframeRef=useRef("iframeRef");useExternalListener(this.videoBlock,"pointerenter",()=>{this.videoSettingsOverlay.open({target:this.videoBlock,props:{videoBlock:this.videoBlock,overlay:this.videoSettingsOverlay,replaceVideo:()=>{this.props.openVideoSelectorDialog((media)=>{this.replaceVideo(media);},this.iframeRef.el);},removeVideo:()=>{this.videoBlock.remove();this.props.addStep();},focusEditable:this.props.focusEditable,dropdown:this.dropdown,},});});useExternalListener(this.videoBlock,"pointerleave",(e)=>{if(this.dropdown.isOpen||e.relatedTarget?.closest(".video-overlay")){return;}
this.videoSettingsOverlay.close();});onWillDestroy(()=>{this.videoSettingsOverlay?.close();});}
get url(){return getVideoUrl(this.state.platform,this.state.videoId,this.state.params).toString();}
replaceVideo(media){this.state.videoId=media.videoId;this.state.platform=media.platform;this.state.params=media.params;this.props.focusEditable();}}
const videoEmbedding=__exports.videoEmbedding={name:"video",Component:EmbeddedVideoComponent,getProps:(host)=>({host,...getEmbeddedProps(host)}),getStateChangeManager:(config)=>new StateChangeManager(config),};const VideoSettings=__exports.VideoSettings=class VideoSettings extends Component{static template="html_editor.VideoSettings";static components={Dropdown,DropdownItem};static props={videoBlock:{type:HTMLElement},overlay:{type:Object},replaceVideo:{type:Function},removeVideo:{type:Function},focusEditable:{type:Function},dropdown:{type:Object},};setup(){this.menuRef=useRef("menuRef");onMounted(()=>{this.menuRef.el.addEventListener("pointerleave",()=>{if(!this.props.dropdown.isOpen){this.props.overlay.close();}});});useExternalListener(document,"pointerdown",(ev)=>{if(this.props.dropdown.isOpen){return;}
this.props.overlay.close();});onWillUnmount(()=>{if(!this.props.videoBlock.isConnected){this.props.focusEditable();}});}}
return __exports;});;

/* /html_editor/static/src/others/embedded_components/embedding_sets.js */
odoo.define('@html_editor/others/embedded_components/embedding_sets',['@html_editor/others/embedded_components/backend/file/file','@html_editor/others/embedded_components/backend/caption/caption','@html_editor/others/embedded_components/core/file/readonly_file','@html_editor/others/embedded_components/core/table_of_content/table_of_content','@html_editor/others/embedded_components/core/toggle_block/toggle_block','@html_editor/others/embedded_components/backend/video/video','@html_editor/others/embedded_components/core/video/readonly_video','@html_editor/others/embedded_components/backend/syntax_highlighting/syntax_highlighting','@html_editor/others/embedded_components/core/syntax_highlighting/readonly_syntax_highlighting'],function(require){'use strict';let __exports={};const{fileEmbedding}=require("@html_editor/others/embedded_components/backend/file/file");const{captionEmbedding}=require("@html_editor/others/embedded_components/backend/caption/caption");const{readonlyFileEmbedding}=require("@html_editor/others/embedded_components/core/file/readonly_file");const{readonlyTableOfContentEmbedding,tableOfContentEmbedding,}=require("@html_editor/others/embedded_components/core/table_of_content/table_of_content");const{toggleBlockEmbedding}=require("@html_editor/others/embedded_components/core/toggle_block/toggle_block");const{videoEmbedding}=require("@html_editor/others/embedded_components/backend/video/video");const{readonlyVideoEmbedding}=require("@html_editor/others/embedded_components/core/video/readonly_video");const{syntaxHighlightingEmbedding}=require("@html_editor/others/embedded_components/backend/syntax_highlighting/syntax_highlighting");const{readonlySyntaxHighlightingEmbedding}=require("@html_editor/others/embedded_components/core/syntax_highlighting/readonly_syntax_highlighting");const MAIN_EMBEDDINGS=__exports.MAIN_EMBEDDINGS=[fileEmbedding,tableOfContentEmbedding,toggleBlockEmbedding,videoEmbedding,captionEmbedding,syntaxHighlightingEmbedding,];const READONLY_MAIN_EMBEDDINGS=__exports.READONLY_MAIN_EMBEDDINGS=[readonlyFileEmbedding,readonlyTableOfContentEmbedding,toggleBlockEmbedding,readonlyVideoEmbedding,captionEmbedding,readonlySyntaxHighlightingEmbedding,];return __exports;});;

/* /html_editor/static/src/others/embedded_components/plugins/caption_plugin/caption_plugin.js */
odoo.define('@html_editor/others/embedded_components/plugins/caption_plugin/caption_plugin',['@html_editor/plugin','@web/core/l10n/translation','@html_editor/utils/blocks','@web/core/utils/render','@html_editor/utils/dom','@html_editor/utils/dom_traversal','@html_editor/utils/dom_info','@html_editor/utils/position','@html_editor/utils/selection','@html_editor/core/selection_plugin'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{closestBlock,isBlock}=require("@html_editor/utils/blocks");const{renderToElement}=require("@web/core/utils/render");const{unwrapContents}=require("@html_editor/utils/dom");const{closestElement}=require("@html_editor/utils/dom_traversal");const{EDITABLE_MEDIA_CLASS,isVisible}=require("@html_editor/utils/dom_info");const{boundariesOut,rightPos}=require("@html_editor/utils/position");const{findInSelection}=require("@html_editor/utils/selection");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const CaptionPlugin=__exports.CaptionPlugin=class CaptionPlugin extends Plugin{static id="caption";static dependencies=["image","split","history","embeddedComponents","selection","baseContainer",];resources={user_commands:[{id:"toggleImageCaption",title:_t("Add/remove a caption"),run:this.toggleImageCaption.bind(this),isAvailable:isHtmlContentSupported,},],toolbar_items:[{id:"image_caption",description:_t("Add/remove a caption"),groupId:"image_description",commandId:"toggleImageCaption",text:"Caption",isActive:()=>this.hasImageCaption(this.dependencies.image.getTargetedImage()),},],clean_for_save_handlers:this.cleanForSave.bind(this),mount_component_handlers:this.setupNewCaption.bind(this),delete_handlers:this.afterDelete.bind(this),before_cut_handlers:this.expandSelectionToCaption.bind(this),before_drag_handlers:this.expandSelectionToCaption.bind(this),delete_image_overrides:this.handleDeleteImage.bind(this),after_save_media_dialog_handlers:this.onImageReplaced.bind(this),hints:[{selector:"FIGCAPTION",text:_t("Write a caption...")}],unsplittable_node_predicates:[(node)=>["FIGURE","FIGCAPTION"].includes(node.nodeName),],image_name_predicates:[this.getImageName.bind(this)],link_compatible_selection_predicates:[this.isLinkAllowedOnSelection.bind(this)],empty_node_predicates:(el)=>el.matches?.("figure")&&el.children.length===1&&el.children[0].matches("figcaption"),move_node_whitelist_selectors:"figure",clipboard_content_processors:this.processContentForClipboard.bind(this),};setup(){for(const figure of this.editable.querySelectorAll("figure")){const image=figure.querySelector("img");figure.before(image);const caption=figure.querySelector("figcaption")?.textContent;figure.remove();this.addImageCaption(image,caption,false);}}
cleanForSave({root}){for(const figure of root.querySelectorAll("figure")){figure.removeAttribute("contenteditable");const image=figure.querySelector("img");figure.querySelector("figcaption").remove();const caption=root.ownerDocument.createElement("figcaption");caption.textContent=image.getAttribute("data-caption");image.removeAttribute("data-caption");image.removeAttribute("data-caption-id");image.classList.remove(EDITABLE_MEDIA_CLASS);image.after(caption);}}
hasImageCaption(image){if(!image){return;}
const block=closestBlock(image);return(block.nodeName==="FIGURE"&&!!block.querySelector("[data-embedded='caption'] input"));}
toggleImageCaption(image=this.dependencies.image.getTargetedImage()){if(!image){return;}
if(this.hasImageCaption(image)){this.removeImageCaption(image);}else{this.addImageCaption(image,image.getAttribute("data-caption")||"");}}
getCaptionId(){return""+Math.floor(Math.random()*Date.now());}
addImageCaption(image,captionText="",focusInput=true){this.captionsBeingAdded||=new Set();const figure=this.document.createElement("figure");const link=image.parentElement.nodeName==="A"&&image.parentElement;if(link&&(link.previousSibling||link.nextSibling)){this.dependencies.split.splitAroundUntil(link,closestBlock(link));}else if(!link&&(image.previousSibling||image.nextSibling)&&closestBlock(image)!==this.editable){const block=this.dependencies.split.splitAroundUntil(image,closestBlock(image));if(isBlock(block.previousSibling)&&!isVisible(block.previousSibling)){block.previousSibling.remove();}
if(isBlock(block.nextSibling)&&!isVisible(block.nextSibling)){block.nextSibling.remove();}}
image.before(figure);figure.append(image);if(!link&&figure.parentElement!==this.editable){unwrapContents(figure.parentElement);this.dependencies.selection.setCursorEnd(figure);}
const captionId=this.getCaptionId();this.captionsBeingAdded.add(captionId);image.setAttribute("data-caption-id",captionId);image.setAttribute("data-caption",captionText||"");figure.setAttribute("contenteditable","false");image.classList.add(EDITABLE_MEDIA_CLASS);const caption=renderToElement("html_editor.EmbeddedCaptionBlueprint",{embeddedProps:JSON.stringify({id:captionId,focusInput,}),});figure.append(caption);this.dependencies.history.addStep();this.captionsBeingAdded.delete(captionId);}
removeImageCaption(image){const figure=closestElement(image,"figure");if(figure){figure.querySelector("figcaption").remove();if(closestBlock(figure.parentElement)===this.editable){const baseContainer=this.dependencies.baseContainer.createBaseContainer();if(figure.parentElement.nodeName==="A"){figure.parentElement.before(baseContainer);baseContainer.append(figure.parentElement);}else{figure.before(baseContainer);baseContainer.append(figure);}}
unwrapContents(figure);image.removeAttribute("data-caption-id");image.classList.remove(EDITABLE_MEDIA_CLASS);const[anchorNode,anchorOffset,focusNode,focusOffset]=boundariesOut(image);this.dependencies.selection.setSelection({anchorNode,anchorOffset,focusNode,focusOffset,});this.dependencies.selection.focusEditable();this.dependencies.history.addStep();}}
setupNewCaption({name,props}){if(name==="caption"){const id=props.id;delete props.id;const image=this.editable.querySelector(`img[data-caption-id="${id}"]`);Object.assign(props,{image,onUpdateCaption:(caption="")=>{const figcaption=image.parentElement.querySelector("figcaption");if(figcaption&&figcaption.getAttribute("placeholder")!==caption){figcaption.setAttribute("placeholder",caption);}
if(caption!==image.getAttribute("data-caption")){image.setAttribute("data-caption",caption);}
if(!this.captionsBeingAdded?.has(id)){this.dependencies.history.addStep();}},onEditorHistoryApply:(redo=false)=>{if(redo){this.dependencies.history.redo();}else{this.dependencies.history.undo();}},});}}
getImageName(image){if(closestElement(image,"figure")){return image.getAttribute("data-caption");}}
isLinkAllowedOnSelection(){const figure=findInSelection(this.dependencies.selection.getEditableSelection(),"figure");if(figure&&this.dependencies.selection.getTargetedNodes().every((node)=>closestElement(node,"figure")===figure)){return true;}}
onImageReplaced(media){const figure=closestElement(media,"figure");if(media.nodeName==="IMG"&&figure){const[anchorNode,anchorOffset]=rightPos(figure);const caption=figure.querySelector("[data-embedded='caption'] input")?.value;figure.before(media);figure.remove();this.addImageCaption(media,caption,false);this.dependencies.selection.setSelection({anchorNode,anchorOffset});}}
afterDelete(){const{anchorNode}=this.dependencies.selection.getEditableSelection();const targetedNodes=this.dependencies.selection.getTargetedNodes();for(const figure of this.editable.querySelectorAll("figure:not(:has(img))")){const isSelectionInFigure=targetedNodes.includes(figure)||anchorNode===figure;const sibling=figure.nextSibling||figure.previousSibling;figure.remove();if(isSelectionInFigure){this.dependencies.selection.setSelection({anchorNode:sibling,anchorOffset:0,});}}}
handleDeleteImage(image){const figure=closestElement(image,"figure");if(figure){const sibling=figure.nextSibling||figure.previousSibling;figure.remove();this.dependencies.selection.setSelection({anchorNode:sibling,anchorOffset:0,});this.dependencies.history.addStep();return true;}}
expandSelectionToCaption(selection){const startFigure=closestElement(selection.anchorNode,"figure");const endFigure=closestElement(selection.focusNode,"figure");if(startFigure&&startFigure===endFigure){const[anchorNode,anchorOffset,focusNode,focusOffset]=boundariesOut(startFigure);this.dependencies.selection.setSelection({anchorNode,anchorOffset,focusNode,focusOffset},{normalize:false});}}
processContentForClipboard(clonedContents,selection){if(clonedContents.firstChild.nodeName==="IMG"){clonedContents=selection.commonAncestorContainer.cloneNode(true);}
return clonedContents;}}
return __exports;});;

/* /html_editor/static/src/others/embedded_components/plugins/embedded_file_plugin/embedded_file_documents_selector.js */
odoo.define('@html_editor/others/embedded_components/plugins/embedded_file_plugin/embedded_file_documents_selector',['@html_editor/main/media/media_dialog/document_selector','@web/core/utils/render'],function(require){'use strict';let __exports={};const{DocumentSelector}=require("@html_editor/main/media/media_dialog/document_selector");const{renderToElement}=require("@web/core/utils/render");const EmbeddedFileDocumentsSelector=__exports.EmbeddedFileDocumentsSelector=class EmbeddedFileDocumentsSelector extends DocumentSelector{static mediaSpecificClasses=[];static async renderFileElement(attachment){return renderEmbeddedFileBox(attachment);}}
__exports.renderEmbeddedFileBox=renderEmbeddedFileBox;function renderEmbeddedFileBox(attachment){const dotSplit=attachment.name.split(".");const extension=dotSplit.length>1?dotSplit.pop():undefined;const fileData={access_token:attachment.access_token,checksum:attachment.checksum,extension,filename:attachment.name,id:attachment.id,mimetype:attachment.mimetype,name:attachment.name,type:attachment.type,url:attachment.url||"",};return renderToElement("html_editor.EmbeddedFileBlueprint",{embeddedProps:JSON.stringify({fileData}),});}
return __exports;});;

/* /html_editor/static/src/others/embedded_components/plugins/embedded_file_plugin/embedded_file_plugin.js */
odoo.define('@html_editor/others/embedded_components/plugins/embedded_file_plugin/embedded_file_plugin',['@html_editor/utils/dom_info','@html_editor/utils/blocks','@html_editor/others/embedded_components/plugins/embedded_file_plugin/embedded_file_documents_selector','@html_editor/main/media/file_plugin','@html_editor/utils/dom_traversal'],function(require){'use strict';let __exports={};const{nextLeaf}=require("@html_editor/utils/dom_info");const{isBlock}=require("@html_editor/utils/blocks");const{EmbeddedFileDocumentsSelector,renderEmbeddedFileBox,}=require("@html_editor/others/embedded_components/plugins/embedded_file_plugin/embedded_file_documents_selector");const{FilePlugin}=require("@html_editor/main/media/file_plugin");const{closestElement}=require("@html_editor/utils/dom_traversal");const EmbeddedFilePlugin=__exports.EmbeddedFilePlugin=class EmbeddedFilePlugin extends FilePlugin{static id="embeddedFile";static dependencies=[...super.dependencies,"embeddedComponents","selection"];resources={...this.resources,mount_component_handlers:this.setupNewFile.bind(this),};renderDownloadBox(attachment){return renderEmbeddedFileBox(attachment);}
isUploadCommandAvailable({anchorNode}){return(super.isUploadCommandAvailable()&&!closestElement(anchorNode,"[data-embedded='clipboard']"));}
get componentForMediaDialog(){return EmbeddedFileDocumentsSelector;}
setupNewFile({name,env}){if(name==="file"){Object.assign(env.editorShared,{setSelectionAfter:(host)=>{try{const leaf=nextLeaf(host,this.editable);if(!leaf){return;}
const leafEl=isBlock(leaf)?leaf:leaf.parentElement;if(isBlock(leafEl)&&leafEl.isContentEditable){this.dependencies.selection.setSelection({anchorNode:leafEl,anchorOffset:0,});}}catch{return;}},});}}}
return __exports;});;

/* /html_editor/static/src/others/embedded_components/plugins/syntax_highlighting_plugin/syntax_highlighting_plugin.js */
odoo.define('@html_editor/others/embedded_components/plugins/syntax_highlighting_plugin/syntax_highlighting_plugin',['@html_editor/plugin','@html_editor/utils/resource','@html_editor/others/embedded_component_utils','@html_editor/others/embedded_components/core/syntax_highlighting/syntax_highlighting_utils','@html_editor/utils/dom'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{withSequence}=require("@html_editor/utils/resource");const{getEmbeddedProps}=require("@html_editor/others/embedded_component_utils");const{DEFAULT_LANGUAGE_ID,getPreValue,newlinesToLineBreaks,}=require("@html_editor/others/embedded_components/core/syntax_highlighting/syntax_highlighting_utils");const{removeInvisibleWhitespace}=require("@html_editor/utils/dom");const CODE_BLOCK_CLASS="o_syntax_highlighting";const CODE_BLOCK_SELECTOR=`div.${CODE_BLOCK_CLASS}`;const SyntaxHighlightingPlugin=__exports.SyntaxHighlightingPlugin=class SyntaxHighlightingPlugin extends Plugin{static id="syntaxHighlighting";static dependencies=["baseContainer","overlay","history","selection","protectedNode","embeddedComponents",];resources={is_node_editable_predicates:(node)=>{if(node?.classList?.contains("o_prism_source")){return true;}},system_attributes:"data-syntax-highlighting-autofocus",mount_component_handlers:this.setupNewCodeBlock.bind(this),normalize_handlers:(root)=>this.addCodeBlocks(root,true),post_undo_handlers:()=>this.addCodeBlocks(this.editable,true),post_redo_handlers:()=>this.addCodeBlocks(this.editable,true),clean_for_save_handlers:withSequence(0,({root})=>this.cleanForSave(root)),before_set_tag_handlers:(el,newTagName,cursors)=>{if(newTagName.toLowerCase()==="pre"){removeInvisibleWhitespace(el,cursors);}},clipboard_content_processors:(clonedContent)=>this.cleanForSave(clonedContent),};setup(){this.addCodeBlocks();}
cleanForSave(root){for(const codeBlock of root.querySelectorAll("div.o_syntax_highlighting")){const pre=codeBlock.querySelector("pre");pre.dataset.embedded="readonlySyntaxHighlighting";const embeddedProps=getEmbeddedProps(codeBlock);const value=embeddedProps.value;pre.dataset.languageId=embeddedProps.languageId;codeBlock.before(pre);codeBlock.remove();pre.textContent=value;newlinesToLineBreaks(pre);}}
addCodeBlocks(root=this.editable,preserveFocus=false){const targetedNodes=this.dependencies.selection.getTargetedNodes();const nonEmbeddedPres=[...root.querySelectorAll("pre")].filter((pre)=>!pre.closest(CODE_BLOCK_SELECTOR));for(const pre of nonEmbeddedPres){const isPreInSelection=!targetedNodes.some((node)=>!pre.contains(node));const embeddedProps=JSON.stringify({value:getPreValue(pre),languageId:pre.dataset.languageId||DEFAULT_LANGUAGE_ID,});const codeBlock=this.dependencies.embeddedComponents.renderBlueprintToElement("html_editor.EmbeddedSyntaxHighlightingBlueprint",{embeddedProps},()=>{if(preserveFocus&&isPreInSelection){const textarea=codeBlock.querySelector("textarea");if(textarea!==codeBlock.ownerDocument.activeElement){textarea.focus();this.dependencies.history.stageFocus();}}});pre.before(codeBlock);if(isPreInSelection){this.document.getSelection().removeAllRanges();}
pre.remove();}}
setupNewCodeBlock({name,props}){if(name==="syntaxHighlighting"){Object.assign(props,{onTextareaFocus:()=>this.dependencies.history.stageFocus(),convertToParagraph:({target})=>{this.dependencies.history.stageSelection();const component=target.closest(`[data-embedded='${name}']`);const embeddedProps=getEmbeddedProps(component);const baseContainer=this.dependencies.baseContainer.createBaseContainer();baseContainer.textContent=embeddedProps.value;component.replaceWith(baseContainer);newlinesToLineBreaks(baseContainer);this.dependencies.selection.setCursorStart(baseContainer);this.dependencies.history.addStep();},});props.host.removeAttribute("data-syntax-highlighting-autofocus");}}}
return __exports;});;

/* /html_editor/static/src/others/embedded_components/plugins/table_of_content_plugin/table_of_content_plugin.js */
odoo.define('@html_editor/others/embedded_components/plugins/table_of_content_plugin/table_of_content_plugin',['@html_editor/plugin','@web/core/l10n/translation','@web/core/utils/render','@html_editor/others/embedded_components/core/table_of_content/table_of_content_manager','@html_editor/core/selection_plugin'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{renderToElement}=require("@web/core/utils/render");const{HEADINGS,TableOfContentManager,}=require("@html_editor/others/embedded_components/core/table_of_content/table_of_content_manager");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const TableOfContentPlugin=__exports.TableOfContentPlugin=class TableOfContentPlugin extends Plugin{static id="tableOfContent";static dependencies=["dom","selection","embeddedComponents","link","history"];resources={user_commands:[{id:"insertTableOfContent",title:_t("Table of Contents"),description:_t("Highlight the structure (headings)"),icon:"fa-bookmark",run:this.insertTableOfContent.bind(this),isAvailable:isHtmlContentSupported,},],powerbox_items:[{categoryId:"navigation",commandId:"insertTableOfContent",},],restore_savepoint_handlers:()=>this.delayedUpdateTableOfContents(this.editable),history_reset_handlers:()=>this.delayedUpdateTableOfContents(this.editable),history_reset_from_steps_handlers:()=>this.delayedUpdateTableOfContents(this.editable),step_added_handlers:({stepCommonAncestor})=>this.delayedUpdateTableOfContents(stepCommonAncestor),external_step_added_handlers:this.delayedUpdateTableOfContents.bind(this,this.editable),clean_for_save_handlers:this.cleanForSave.bind(this),mount_component_handlers:this.setupNewToc.bind(this),system_classes:["o_embedded_toc_header_highlight"],};setup(){this.manager=new TableOfContentManager({el:this.editable,});this.alive=true;}
insertTableOfContent(){const tableOfContentBlueprint=renderToElement("html_editor.TableOfContentBlueprint");this.dependencies.dom.insert(tableOfContentBlueprint);this.dependencies.history.addStep();}
cleanForSave({root}){for(const el of root.querySelectorAll(".o_embedded_toc_header_highlight")){el.classList.remove("o_embedded_toc_header_highlight");}}
destroy(){super.destroy();this.alive=false;}
delayedUpdateTableOfContents(element){const selector=HEADINGS.join(",");if(!(!element||element.querySelector(selector)||element.closest(selector))){return;}
if(this.updateTimeout){window.clearTimeout(this.updateTimeout);}
this.updateTimeout=window.setTimeout(()=>{if(!this.alive){return;}
this.manager.updateStructure();},500);}
setupNewToc({name,props}){if(name==="tableOfContent"){Object.assign(props,{manager:this.manager,});}}}
return __exports;});;

/* /html_editor/static/src/others/embedded_components/plugins/toggle_block_plugin/toggle_block_plugin.js */
odoo.define('@html_editor/others/embedded_components/plugins/toggle_block_plugin/toggle_block_plugin',['@html_editor/others/embedded_component_utils','@html_editor/plugin','@html_editor/core/selection_plugin','@html_editor/utils/base_container','@html_editor/utils/blocks','@html_editor/utils/dom_info','@html_editor/utils/dom_traversal','@html_editor/utils/html','@html_editor/utils/position','@html_editor/utils/resource','@web/core/l10n/translation','@web/core/utils/render','@web/core/utils/strings'],function(require){'use strict';let __exports={};const{getEmbeddedProps}=require("@html_editor/others/embedded_component_utils");const{Plugin}=require("@html_editor/plugin");const{isHtmlContentSupported}=require("@html_editor/core/selection_plugin");const{baseContainerGlobalSelector}=require("@html_editor/utils/base_container");const{closestBlock}=require("@html_editor/utils/blocks");const{isEmptyBlock,isParagraphRelatedElement}=require("@html_editor/utils/dom_info");const{childNodes,children,closestElement,firstLeaf,lastLeaf,selectElements,}=require("@html_editor/utils/dom_traversal");const{parseHTML}=require("@html_editor/utils/html");const{childNodeIndex,nodeSize}=require("@html_editor/utils/position");const{withSequence}=require("@html_editor/utils/resource");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"html_editor",...args);const{renderToString}=require("@web/core/utils/render");const{uuid}=require("@web/core/utils/strings");const toggleSelector="[data-embedded='toggleBlock']";const titleSelector="[data-embedded-editable='title']";const contentSelector="[data-embedded-editable='content']";const ToggleBlockPlugin=__exports.ToggleBlockPlugin=class ToggleBlockPlugin extends Plugin{static id="toggleBlock";static dependencies=["baseContainer","delete","dom","embeddedComponents","history","selection","split",];resources={hints:[withSequence(20,{selector:`${toggleSelector} ${titleSelector} > *`,text:_t("Toggle title"),}),withSequence(10,{selector:`${toggleSelector} ${contentSelector}:not(:focus) > ${baseContainerGlobalSelector}:only-child`,text:_t("Add something inside this toggle"),}),],hint_targets_providers:(selectionData,editable)=>[...editable.querySelectorAll(`${toggleSelector} ${contentSelector} > ${baseContainerGlobalSelector}:only-child`),],move_node_blacklist_selectors:`${toggleSelector} ${titleSelector} *`,selection_blocker_predicates:(blocker)=>{if(blocker.nodeType===Node.ELEMENT_NODE&&blocker.dataset.embedded==="toggleBlock"){return false;}},powerbox_items:[{commandId:"insertToggleBlock",categoryId:"structure",},],shortcuts:[{hotkey:"control+enter",commandId:"switchToggleBlockState"}],user_commands:[{id:"insertToggleBlock",title:_t("Toggle list"),description:_t("Hide Text under foldable toggles"),icon:"fa-caret-square-o-right",isAvailable:(selection)=>isHtmlContentSupported(selection)&&!closestElement(selection.anchorNode,`${toggleSelector} ${titleSelector}`),run:()=>{this.insertToggleBlock();},},{id:"switchToggleBlockState",run:this.manageToggleFromTitle.bind(this),},],normalize_handlers:withSequence(Infinity,this.normalize.bind(this)),delete_backward_overrides:this.handleDeleteBackward.bind(this),delete_forward_overrides:this.handleDeleteForward.bind(this),shift_tab_overrides:this.handleShiftTab.bind(this),split_element_block_overrides:withSequence(1,this.handleSplitElementBlock.bind(this)),tab_overrides:this.handleTab.bind(this),power_buttons_visibility_predicates:this.showPowerButtons.bind(this),before_insert_processors:this.handleInsert.bind(this),};setup(){this.preventDeleteBackwardContentEnd=false;this.selectedToggleEmptyContentSet=new Set();}
explodeToggle(toggle){const title=toggle.querySelector(titleSelector);const content=toggle.querySelector(contentSelector);let contentChildren=children(content);if(contentChildren.length===1&&isEmptyBlock(contentChildren[0])){contentChildren=[];}
toggle.replaceWith(...children(title),...contentChildren);}
forceToggle(toggle,{showContent,restoreSelection}={}){toggle.dispatchEvent(new CustomEvent("forceToggle",{detail:{showContent,restoreSelection}}));}
generateUniqueIds(toggles){for(const toggle of toggles){const props=getEmbeddedProps(toggle);props.toggleBlockId=this.getUniqueIdentifier();toggle.dataset.embeddedProps=JSON.stringify(props);}}
getClosestToggleContentInfo(node){const toggle=closestElement(node,toggleSelector);const title=toggle?.querySelector(titleSelector);const content=toggle?.querySelector(contentSelector);return content?.contains(node)?{content,title,toggle}:{};}
getClosestToggleTitleInfo(node){const toggle=closestElement(node,toggleSelector);const title=toggle?.querySelector(titleSelector);const content=toggle?.querySelector(contentSelector);return title?.contains(node)?{content,title,toggle}:{};}
getToggleFromTitleSelection(){const selection=this.dependencies.selection.getEditableSelection();if(!selection.anchorNode){return;}
const{toggle}=this.getClosestToggleTitleInfo(selection.anchorNode);return toggle;}
getUniqueIdentifier(){return uuid();}
handleDeleteBackward(range){for(const handler of[this.handleDeleteBackwardTitleStart,this.handleDeleteBackwardContentEnd,this.handleDeleteBackwardContentStart,this.handleDeleteBackwardAfterToggle,]){if(handler.call(this,range)){return true;}}}
handleDeleteBackwardContentEnd({endContainer,endOffset}){const block=closestBlock(endContainer);const isEmptyContainer=isEmptyBlock(endContainer);const leaf=isEmptyContainer?endContainer:firstLeaf(block);const{toggle,content}=this.getClosestToggleContentInfo(endContainer);if(!content||endOffset!==0||childNodeIndex(block)===0||block.nextElementSibling||leaf!==endContainer||!isParagraphRelatedElement(block)||this.preventDeleteBackwardContentEnd){return;}
toggle.after(block);this.dependencies.selection.setCursorStart(block);return true;}
handleDeleteBackwardContentStart({endContainer,endOffset}){const block=closestBlock(endContainer);const leaf=isEmptyBlock(endContainer)?endContainer:firstLeaf(block);const{title,content}=this.getClosestToggleContentInfo(endContainer);if(!content||endOffset!==0||childNodeIndex(block)!==0||leaf!==endContainer||!isParagraphRelatedElement(block)){return;}
title.append(block);this.dependencies.selection.setCursorStart(block);this.dependencies.delete.deleteBackward(this.dependencies.selection.getEditableSelection(),"character");return true;}
handleDeleteBackwardTitleStart({endContainer,endOffset}){const block=closestBlock(endContainer);const leaf=isEmptyBlock(endContainer)?endContainer:firstLeaf(block);const{toggle,title}=this.getClosestToggleTitleInfo(endContainer);if(!title||endOffset!==0||childNodeIndex(block)!==0||leaf!==endContainer){return;}
const cursors=this.dependencies.selection.preserveSelection();this.explodeToggle(toggle);cursors.restore();return true;}
handleDeleteBackwardAfterToggle({endContainer,endOffset}){const block=closestBlock(endContainer);const leaf=isEmptyBlock(endContainer)?endContainer:firstLeaf(block);const toggle=block?.previousSibling;if(!toggle?.matches?.(toggleSelector)||endOffset!==0||leaf!==endContainer){return;}
let target=toggle.querySelector(contentSelector);if(target.parentElement.matches(".d-none")){if(!isParagraphRelatedElement(block)){return;}
const title=toggle.querySelector(titleSelector);target=title;}
target.append(block);this.dependencies.selection.setCursorStart(block);this.preventDeleteBackwardContentEnd=true;this.dependencies.delete.deleteBackward(this.dependencies.selection.getEditableSelection(),"character");this.preventDeleteBackwardContentEnd=false;return true;}
handleDeleteForward(range){for(const handler of[this.handleDeleteForwardTitleEnd,this.handleDeleteForwardContentEnd,this.handleDeleteForwardBeforeToggle,]){if(handler.call(this,range)){return true;}}}
handleDeleteForwardContentEnd({startContainer,startOffset}){const block=closestBlock(startContainer);const isEmptyContainer=isEmptyBlock(startContainer);const leaf=isEmptyContainer?startContainer:lastLeaf(block);const{toggle,content}=this.getClosestToggleContentInfo(startContainer);if(!content||!((isEmptyContainer&&startOffset===0)||startOffset===nodeSize(startContainer))||block===this.editable||block.nextElementSibling||leaf!==startContainer||!isParagraphRelatedElement(block)){return;}
let nextEl=toggle.nextSibling;if(nextEl?.matches?.(toggleSelector)){this.explodeToggle(nextEl);nextEl=toggle.nextSibling;}
if(!isParagraphRelatedElement(nextEl)){return;}
content.append(nextEl);this.dependencies.selection.setCursorEnd(block);this.dependencies.delete.deleteForward(this.dependencies.selection.getEditableSelection(),"character");return true;}
handleDeleteForwardTitleEnd({startContainer,startOffset}){const block=closestBlock(startContainer);const isEmptyContainer=isEmptyBlock(startContainer);const leaf=isEmptyContainer?startContainer:lastLeaf(block);const{toggle,title,content}=this.getClosestToggleTitleInfo(startContainer);if(!title||!((isEmptyContainer&&startOffset===0)||startOffset===nodeSize(startContainer))||block===this.editable||block.nextElementSibling||leaf!==startContainer){return;}
let nextEl;if(content.parentElement.matches(".d-none")){nextEl=toggle.nextSibling;if(nextEl.matches?.(toggleSelector)){this.explodeToggle(nextEl);nextEl=toggle.nextSibling;}}else{nextEl=content.firstChild;if(nextEl.matches?.(toggleSelector)){this.explodeToggle(nextEl);nextEl=content.firstChild;}}
if(!isParagraphRelatedElement(nextEl)){return;}
title.append(nextEl);this.dependencies.selection.setCursorEnd(block);this.dependencies.delete.deleteForward(this.dependencies.selection.getEditableSelection(),"character");return true;}
handleDeleteForwardBeforeToggle({startContainer,startOffset}){const block=closestBlock(startContainer);const isEmptyContainer=isEmptyBlock(startContainer);const leaf=isEmptyContainer?startContainer:lastLeaf(block);const toggle=block.nextSibling;if(!toggle?.matches?.(toggleSelector)||!((isEmptyContainer&&startOffset===0)||startOffset===nodeSize(startContainer))||leaf!==startContainer){return;}
if(isEmptyBlock(block)){block.remove();const title=toggle.querySelector(titleSelector);this.dependencies.selection.setCursorStart(title.firstElementChild);}else{this.explodeToggle(toggle);this.dependencies.selection.setCursorEnd(block);this.dependencies.delete.deleteForward(this.dependencies.selection.getEditableSelection(),"character");}
return true;}
handleInsert(insertContainer){const insertedToggles=insertContainer.querySelectorAll(toggleSelector);this.generateUniqueIds(insertedToggles);return insertContainer;}
handleShiftTab(){const toggle=this.getToggleFromTitleSelection();if(toggle){const closestToggleAncestor=closestElement(toggle.parentElement,toggleSelector);if(closestToggleAncestor){const cursors=this.dependencies.selection.preserveSelection();const ancestorContent=closestToggleAncestor.querySelector(contentSelector);const containerContent=toggle.querySelector(contentSelector);const siblings=childNodes(ancestorContent).filter((node)=>toggle.compareDocumentPosition(node)&Node.DOCUMENT_POSITION_FOLLOWING);if(isEmptyBlock(containerContent.lastElementChild)){containerContent.lastElementChild.remove();}
containerContent.append(...siblings);closestToggleAncestor.after(toggle);this.forceToggle(toggle,{showContent:true,restoreSelection:cursors.restore});this.dependencies.history.addStep();}
return true;}}
handleSplitElementBlock({targetNode,targetOffset,blockToSplit}){const{toggle,title,content}=this.getClosestToggleTitleInfo(targetNode);if(title){const selection=this.dependencies.selection.getEditableSelection();if(isEmptyBlock(selection.anchorNode)){const contentChildren=children(content);if(contentChildren.length!==1||!isEmptyBlock(contentChildren[0])){toggle.after(...children(content));}
const baseContainer=this.dependencies.baseContainer.createBaseContainer();baseContainer.appendChild(this.document.createElement("br"));toggle.replaceWith(baseContainer);this.dependencies.selection.setCursorStart(baseContainer);return true;}
const insertBefore=targetOffset===0&&blockToSplit.parentElement===title;const[beforeSplit,afterSplit]=this.dependencies.split.splitElementBlock({targetNode,targetOffset,blockToSplit,});if(beforeSplit&&afterSplit){if(content.parentElement.matches(".d-none")||insertBefore){const newToggle=this.renderToggleBlock();const newToggleBlock=newToggle.querySelector(toggleSelector);const newTitleEl=newToggle.querySelector(titleSelector);const dir=toggle.getAttribute("dir");if(dir){newToggleBlock.setAttribute("dir",dir);}
if(insertBefore){toggle.before(newToggle);newTitleEl.replaceChildren(beforeSplit);}else{toggle.after(newToggle);newTitleEl.replaceChildren(afterSplit);}}else{const firstChild=content.firstElementChild;if(isEmptyBlock(firstChild)){firstChild.replaceWith(afterSplit);}else{content.prepend(afterSplit);}}
this.dependencies.selection.setCursorStart(afterSplit);}
return true;}}
handleTab(){const toggle=this.getToggleFromTitleSelection();if(toggle){const previousSibling=toggle.previousSibling;if(previousSibling?.matches?.(toggleSelector)){const cursors=this.dependencies.selection.preserveSelection();const previousSiblingContent=previousSibling.querySelector(contentSelector);if(children(previousSiblingContent).length===1&&isEmptyBlock(previousSiblingContent.firstElementChild)){previousSiblingContent.replaceChildren(toggle);}else{previousSiblingContent.append(toggle);}
const content=toggle.querySelector(contentSelector);if(!content.parentElement.matches(".d-none")){toggle.after(...children(content));}
this.forceToggle(previousSibling,{showContent:true,restoreSelection:cursors.restore,});this.dependencies.history.addStep();}
return true;}}
insertToggleBlock(){const block=this.renderToggleBlock();const target=block.querySelector(`${titleSelector} > ${baseContainerGlobalSelector}`);this.dependencies.dom.insert(block);this.dependencies.selection.setCursorStart(target);this.dependencies.history.addStep();}
manageToggleFromTitle(){const toggle=this.getToggleFromTitleSelection();if(!toggle){return;}
this.forceToggle(toggle);}
normalize(element){const cursors=this.dependencies.selection.preserveSelection();let shouldRestoreCursor=false;for(const titleChild of selectElements(element,`${toggleSelector} ${titleSelector} > *:first-child`)){const title=titleChild.parentElement;const toggle=closestElement(title,toggleSelector);if(titleChild.nextElementSibling){const nodes=children(titleChild.parentElement);title.replaceChildren(nodes.shift());toggle.after(...nodes);shouldRestoreCursor=true;}
if(!isParagraphRelatedElement(titleChild)){toggle.after(titleChild);shouldRestoreCursor=true;}}
if(shouldRestoreCursor){cursors.restore();}
for(const emptyToggleNode of selectElements(element,`${toggleSelector} [data-embedded-editable]:empty`)){const baseContainer=this.dependencies.baseContainer.createBaseContainer();baseContainer.appendChild(this.document.createElement("br"));emptyToggleNode.replaceChildren(baseContainer);}}
renderToggleBlock(){const baseContainer=this.dependencies.baseContainer.createBaseContainer();return parseHTML(this.document,renderToString("html_editor.EmbeddedToggleBlockBlueprint",{baseContainerNodeName:baseContainer.nodeName,baseContainerAttributes:{class:baseContainer.className,},embeddedProps:JSON.stringify({toggleBlockId:this.getUniqueIdentifier()}),}));}
showPowerButtons(selection){return(selection.isCollapsed&&!closestElement(selection.anchorNode,`${toggleSelector} ${titleSelector}`));}}
return __exports;});;

/* /html_editor/static/src/others/embedded_components/plugins/video_plugin/embedded_video_plugin.js */
odoo.define('@html_editor/others/embedded_components/plugins/video_plugin/embedded_video_plugin',['@html_editor/main/media/video_plugin','@html_editor/others/embedded_components/plugins/video_plugin/video_selector_dialog/embedded_video_selector'],function(require){'use strict';let __exports={};const{VideoPlugin}=require("@html_editor/main/media/video_plugin");const{EmbeddedVideoSelector}=require("@html_editor/others/embedded_components/plugins/video_plugin/video_selector_dialog/embedded_video_selector");const EmbeddedVideoPlugin=__exports.EmbeddedVideoPlugin=class EmbeddedVideoPlugin extends VideoPlugin{static id="embeddedVideo";static dependencies=["embeddedComponents","selection","history","overlay","media"];resources={...this.resources,mount_component_handlers:this.extendEmbeddedVideoProps.bind(this),};get componentForMediaDialog(){return EmbeddedVideoSelector;}
extendEmbeddedVideoProps({name,props}){if(name==="video"){Object.assign(props,{createOverlay:(Component,props={},options)=>this.dependencies.overlay.createOverlay(Component,props,options),focusEditable:()=>this.dependencies.selection.focusEditable(),addStep:()=>this.dependencies.history.addStep(),openVideoSelectorDialog:(save,media)=>{this.openVideoSelectorDialog(save,media);},});}}
openVideoSelectorDialog(save,iframe){this.dependencies.media.openMediaDialog({node:iframe,save:(elements,[media])=>{if(media.src){save(media);}},visibleTabs:["VIDEOS"],});}}
return __exports;});;

/* /html_editor/static/src/others/embedded_components/plugins/video_plugin/embedded_youtube_plugin.js */
odoo.define('@html_editor/others/embedded_components/plugins/video_plugin/embedded_youtube_plugin',['@html_editor/main/youtube_plugin','@html_editor/others/embedded_components/plugins/video_plugin/video_selector_dialog/embedded_video_selector'],function(require){'use strict';let __exports={};const{YoutubePlugin}=require("@html_editor/main/youtube_plugin");const{EmbeddedVideoSelector}=require("@html_editor/others/embedded_components/plugins/video_plugin/video_selector_dialog/embedded_video_selector");const EmbeddedYoutubePlugin=__exports.EmbeddedYoutubePlugin=class EmbeddedYoutubePlugin extends YoutubePlugin{static id="embeddedYoutube";static dependencies=[...super.dependencies,"embeddedComponents"];mediaSpecificClasses=EmbeddedVideoSelector.mediaSpecificClasses;createVideoElement(videoData){const{video_id:videoId,platform,params}=videoData;return EmbeddedVideoSelector.createElements([{videoId,platform,params}])[0];}}
return __exports;});;

/* /html_editor/static/src/others/embedded_components/plugins/video_plugin/video_selector_dialog/embedded_video_selector.js */
odoo.define('@html_editor/others/embedded_components/plugins/video_plugin/video_selector_dialog/embedded_video_selector',['@html_editor/main/media/media_dialog/video_selector','@web/core/utils/render'],function(require){'use strict';let __exports={};const{VideoSelector}=require("@html_editor/main/media/media_dialog/video_selector");const{renderToElement}=require("@web/core/utils/render");const EmbeddedVideoSelector=__exports.EmbeddedVideoSelector=class EmbeddedVideoSelector extends VideoSelector{static mediaSpecificClasses=[];static createElements(selectedMedia){return selectedMedia.map((media)=>renderToElement("html_editor.EmbeddedVideoBlueprint",{embeddedProps:JSON.stringify({videoId:media.videoId,platform:media.platform,params:media.params||{},}),}));}}
return __exports;});;

/* /html_editor/static/src/others/embedded_component_plugin.js */
odoo.define('@html_editor/others/embedded_component_plugin',['@html_editor/core/history_plugin','@html_editor/plugin','@html_editor/utils/resource','@web/core/utils/functions','@web/core/utils/render'],function(require){'use strict';let __exports={};const{nodeToTree}=require("@html_editor/core/history_plugin");const{Plugin}=require("@html_editor/plugin");const{withSequence}=require("@html_editor/utils/resource");const{memoize}=require("@web/core/utils/functions");const{renderToElement}=require("@web/core/utils/render");const EmbeddedComponentPlugin=__exports.EmbeddedComponentPlugin=class EmbeddedComponentPlugin extends Plugin{static id="embeddedComponents";static dependencies=["history","protectedNode","selection"];static shared=["renderBlueprintToElement"];resources={normalize_handlers:withSequence(0,this.normalize.bind(this)),clean_for_save_handlers:({root})=>this.cleanForSave(root),attribute_change_handlers:this.onChangeAttribute.bind(this),restore_savepoint_handlers:()=>this.handleComponents(this.editable),history_reset_handlers:()=>this.handleComponents(this.editable),history_reset_from_steps_handlers:()=>this.handleComponents(this.editable),step_added_handlers:({stepCommonAncestor})=>this.handleComponents(stepCommonAncestor),external_step_added_handlers:()=>this.handleComponents(this.editable),serializable_descendants_processors:this.processDescendantsToSerialize.bind(this),attribute_change_processors:this.onChangeAttribute.bind(this),savable_mutation_record_predicates:this.isMutationRecordSavable.bind(this),move_node_whitelist_selectors:"[data-embedded]",};setup(){this.components=new Set();this.nodeMap=new WeakMap();this.app=this.config.embeddedComponentInfo.app;this.env=this.config.embeddedComponentInfo.env??{};this.hostToStateChangeManagerMap=new WeakMap();this.hostToOnComponentInsertedMap=new WeakMap();this.embeddedComponents=memoize((embeddedComponents=[])=>{const result={};for(const embedding of embeddedComponents){result[embedding.name]=embedding;}
return result;});}
isMutationRecordSavable(record){const info=this.nodeMap.get(record.target);if(info&&record.type==="attributes"&&record.attributeName==="data-embedded-props"){return false;}
return true;}
processDescendantsToSerialize(elem,serializableDescendants){const embedding=this.getEmbedding(elem);if(!embedding){return serializableDescendants;}
return Object.values(embedding.getEditableDescendants?.(elem)||{}).map(nodeToTree);}
handleComponents(elem){this.destroyRemovedComponents([...this.components]);this.forEachEmbeddedComponentHost(elem,(host,embedding)=>{const info=this.nodeMap.get(host);if(!info){this.mountComponent(host,embedding);}});}
forEachEmbeddedComponentHost(elem,callback){const selector=`[data-embedded]`;const targets=[...elem.querySelectorAll(selector)];if(elem.matches(selector)){targets.unshift(elem);}
for(const host of targets){const embedding=this.getEmbedding(host);if(!embedding){continue;}
callback(host,embedding);}}
getEmbedding(host){return this.embeddedComponents(this.getResource("embedded_components"))[host.dataset.embedded];}
onChangeAttribute(attributeChange,{forNewStep=false}={}){const attributeValue=attributeChange.value;let newAttributeValue;if(attributeChange.attributeName==="data-embedded-state"){const attrState=attributeChange.reverse?attributeChange.oldValue:attributeChange.value;const stateChangeManager=this.getStateChangeManager(attributeChange.target);if(stateChangeManager){newAttributeValue=stateChangeManager.onStateChanged(attrState,{reverse:attributeChange.reverse,forNewStep,});}}
return newAttributeValue||attributeValue;}
getStateChangeManager(host){const embedding=this.getEmbedding(host);if(!("getStateChangeManager"in embedding)){return null;}
if(!this.hostToStateChangeManagerMap.has(host)){const config={host,commitStateChanges:()=>this.dependencies.history.addStep(),};const stateChangeManager=embedding.getStateChangeManager(config);stateChangeManager.setup();this.hostToStateChangeManagerMap.set(host,stateChangeManager);}
return this.hostToStateChangeManagerMap.get(host);}
mountComponent(host,{Component,getEditableDescendants,getProps,name,getStateChangeManager}){const props=getProps?.(host)||{};const env=Object.create(this.env);env.editorShared={};if(getStateChangeManager){env.getStateChangeManager=this.getStateChangeManager.bind(this);}
if(getEditableDescendants){env.getEditableDescendants=getEditableDescendants;Object.assign(env.editorShared,{selection:{...this.dependencies.selection},});}
this.dispatchTo("mount_component_handlers",{name,env,props});const root=this.app.createRoot(Component,{props,env,});root.mount(host);const fiber=root.node.fiber;const fiberComplete=fiber.complete;fiber.complete=()=>{host.replaceChildren();fiberComplete.call(fiber);this.dispatchTo("post_mount_component_handlers");};const onComponentInserted=this.extractOnComponentInserted(host);if(onComponentInserted){root.node.mounted.push(onComponentInserted);}
const info={root,host,};this.components.add(info);this.nodeMap.set(host,info);}
destroyRemovedComponents(infos){this.dependencies.history.ignoreDOMMutations(()=>{for(const info of infos){if(!this.editable.contains(info.host)){const host=info.host;const display=host.style.display;const parentNode=host.parentNode;const clone=host.cloneNode(false);if(parentNode){parentNode.replaceChild(clone,host);}
host.style.display="none";this.editable.after(host);this.destroyComponent(info);if(parentNode){parentNode.replaceChild(host,clone);}else{host.remove();}
host.style.display=display;if(!host.getAttribute("style")){host.removeAttribute("style");}}}});}
deepDestroyComponent({host}){const removed=[];this.forEachEmbeddedComponentHost(host,(containedHost)=>{const info=this.nodeMap.get(containedHost);if(info){if(this.editable.contains(containedHost)){this.destroyComponent(info);}else{removed.push(info);}}});this.destroyRemovedComponents(removed);}
destroyComponent({root,host}){const{getEditableDescendants}=this.getEmbedding(host);const editableDescendants=getEditableDescendants?.(host)||{};root.destroy();this.components.delete(arguments[0]);this.nodeMap.delete(host);host.append(...Object.values(editableDescendants));}
destroy(){super.destroy();for(const info of[...this.components]){if(this.components.has(info)){this.deepDestroyComponent(info);}}}
renderBlueprintToElement(template,context={},onComponentInserted=undefined){const host=renderToElement(template,context);if(onComponentInserted){this.hostToOnComponentInsertedMap.set(host,onComponentInserted);}
return host;}
extractOnComponentInserted(host){const onComponentInserted=this.hostToOnComponentInsertedMap.get(host);this.hostToOnComponentInsertedMap.delete(host);return onComponentInserted;}
normalize(elem){this.forEachEmbeddedComponentHost(elem,(host,{getEditableDescendants})=>{this.dependencies.protectedNode.setProtectingNode(host,true);const editableDescendants=getEditableDescendants?.(host)||{};for(const editableDescendant of Object.values(editableDescendants)){this.dependencies.protectedNode.setProtectingNode(editableDescendant,false);}});}
cleanForSave(clone){this.forEachEmbeddedComponentHost(clone,(host,{getEditableDescendants})=>{const editableDescendants=getEditableDescendants?.(host)||{};host.replaceChildren();for(const editableDescendant of Object.values(editableDescendants)){delete editableDescendant.dataset.oeProtected;host.append(editableDescendant);}
delete host.dataset.oeProtected;delete host.dataset.embeddedState;});}}
return __exports;});;

/* /html_editor/static/src/others/qweb_picker.js */
odoo.define('@html_editor/others/qweb_picker',['@odoo/owl'],function(require){'use strict';let __exports={};const{Component,useState}=require("@odoo/owl");const QWebPicker=__exports.QWebPicker=class QWebPicker extends Component{static template="html_editor.QWebPicker";static props=["groups","select"];setup(){this.state=useState({groups:this.props.groups});}
onChange(ev){const[groupIndex,elementIndex]=ev.target.value.split(",");this.props.select(this.state.groups[groupIndex][elementIndex].node);}}
return __exports;});;

/* /html_editor/static/src/others/qweb_plugin.js */
odoo.define('@html_editor/others/qweb_plugin',['@html_editor/plugin','@html_editor/utils/dom_traversal','@html_editor/utils/position','@html_editor/others/qweb_picker','@html_editor/utils/dom_info','@html_editor/utils/resource'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{closestElement,selectElements}=require("@html_editor/utils/dom_traversal");const{leftPos,rightPos}=require("@html_editor/utils/position");const{QWebPicker}=require("@html_editor/others/qweb_picker");const{isElement}=require("@html_editor/utils/dom_info");const{withSequence}=require("@html_editor/utils/resource");const isUnsplittableQWebElement=(node)=>isElement(node)&&(node.tagName==="T"||["t-field","t-if","t-elif","t-else","t-foreach","t-value","t-esc","t-out","t-raw",].some((attr)=>node.getAttribute(attr)));const PROTECTED_QWEB_SELECTOR="[t-esc], [t-raw], [t-out], [t-field]";const QWEB_DATA_ATTRIBUTES=["data-oe-t-group","data-oe-t-inline","data-oe-t-selectable","data-oe-t-group-active",];const dataAttributesSelector=QWEB_DATA_ATTRIBUTES.map((attr)=>`[${attr}]`).join(", ");const isUnremovableQWebElement=__exports.isUnremovableQWebElement=(node)=>node.getAttribute?.("t-set")||node.getAttribute?.("t-call");const QWebPlugin=__exports.QWebPlugin=class QWebPlugin extends Plugin{static id="qweb";static dependencies=["overlay","protectedNode","selection"];resources={selectionchange_handlers:withSequence(8,this.onSelectionChange.bind(this)),clean_for_save_handlers:({root})=>{this.clearDataAttributes(root);for(const element of root.querySelectorAll(PROTECTED_QWEB_SELECTOR)){element.removeAttribute("contenteditable");delete element.dataset.oeProtected;}},normalize_handlers:withSequence(0,this.normalize.bind(this)),system_attributes:QWEB_DATA_ATTRIBUTES,unremovable_node_predicates:isUnremovableQWebElement,unsplittable_node_predicates:isUnsplittableQWebElement,clipboard_content_processors:this.clearDataAttributes.bind(this),legit_empty_link_predicates:(linkEl)=>linkEl.getAttributeNames().some((name)=>name.startsWith("t-")),};setup(){this.editable.classList.add("odoo-editor-qweb");this.picker=this.dependencies.overlay.createOverlay(QWebPicker,{positionOptions:{position:"top-start"},});this.addDomListener(this.editable,"click",this.onClick);this.groupIndex=0;}
isValidTargetForDomListener(ev){if(ev.type==="click"&&ev.target&&closestElement(ev.target,PROTECTED_QWEB_SELECTOR)){return true;}
return super.isValidTargetForDomListener(ev);}
onSelectionChange(){if(this.picker.isOpen){this.picker.close();}}
normalize(root){this.normalizeInline(root);for(const element of selectElements(root,PROTECTED_QWEB_SELECTOR)){this.dependencies.protectedNode.setProtectingNode(element,true);}
this.applyGroupQwebBranching(root);}
checkAllInline(el){return[...el.children].every((child)=>{if(child.tagName==="T"){return this.checkAllInline(child);}else{return(child.nodeType!==Node.ELEMENT_NODE||this.window.getComputedStyle(child).display==="inline");}});}
normalizeInline(root){for(const el of selectElements(root,"t")){if(this.checkAllInline(el)){el.setAttribute("data-oe-t-inline","true");}}}
getNodeGroups(node){const branchNode=node.closest("[data-oe-t-group]");if(!branchNode){return[];}
const groupId=branchNode.getAttribute("data-oe-t-group");const group=[];for(const node of branchNode.parentElement.querySelectorAll(`[data-oe-t-group='${groupId}']`)){let label="";if(node.hasAttribute("t-if")){label=`if: ${node.getAttribute("t-if")}`;}else if(node.hasAttribute("t-elif")){label=`elif: ${node.getAttribute("t-elif")}`;}else if(node.hasAttribute("t-else")){label="else";}
group.push({groupId,node,label,isActive:node.getAttribute("data-oe-t-group-active")==="true",});}
return this.getNodeGroups(branchNode.parentElement).concat([group]);}
onClick(ev){if(this.picker.isOpen){this.picker.close();}
if(ev.detail>1){const selectionData=this.dependencies.selection.getSelectionData();const selection=selectionData.documentSelection;const qwebNode=selection&&selection.anchorNode&&closestElement(selection.anchorNode,"[t-field],[t-esc],[t-out]");if(qwebNode&&this.editable.contains(qwebNode)){const[anchorNode,anchorOffset]=leftPos(qwebNode);const[focusNode,focusOffset]=rightPos(qwebNode);this.dependencies.selection.setSelection({anchorNode,anchorOffset,focusNode,focusOffset,});}}
const targetNode=ev.target;if(targetNode.closest("[data-oe-t-group]")){this.selectNode(targetNode);}}
selectNode(node){const editableSelection=this.dependencies.selection.getSelectionData().editableSelection;if(!editableSelection.isCollapsed){return;}
this.selectedNode=node;this.picker.open({target:node,props:{groups:this.getNodeGroups(node),select:this.select.bind(this),},});}
applyGroupQwebBranching(root){const tNodes=selectElements(root,"[t-if], [t-elif], [t-else]");const groupsEncounter=new Set();for(const node of tNodes){const prevNode=node.previousElementSibling;let groupId;if(prevNode&&!node.hasAttribute("t-if")){prevNode.setAttribute("data-oe-t-selectable","true");groupId=parseInt(prevNode.getAttribute("data-oe-t-group"));node.setAttribute("data-oe-t-selectable","true");}else{groupId=this.groupIndex++;}
groupsEncounter.add(groupId);node.setAttribute("data-oe-t-group",groupId);}
for(const groupId of groupsEncounter){const isOneElementActive=root.querySelector(`[data-oe-t-group='${groupId}'][data-oe-t-group-active]`);if(!isOneElementActive){const firstElementToActivate=selectElements(root,`[data-oe-t-group='${groupId}']`).next().value;firstElementToActivate.setAttribute("data-oe-t-group-active","true");}}}
select(node){const groupId=node.getAttribute("data-oe-t-group");const activeElement=node.parentElement.querySelector(`[data-oe-t-group='${groupId}'][data-oe-t-group-active]`);if(activeElement===node){return;}
activeElement.removeAttribute("data-oe-t-group-active");node.setAttribute("data-oe-t-group-active","true");this.selectedNode=node;this.picker.close();this.selectNode(node);}
clearDataAttributes(root){for(const node of root.querySelectorAll(dataAttributesSelector)){QWEB_DATA_ATTRIBUTES.forEach((attr)=>node.removeAttribute(attr));}}}
return __exports;});;

/* /html_editor/static/src/services/upload_local_files_service.js */
odoo.define('@html_editor/services/upload_local_files_service',['@web/core/registry'],function(require){'use strict';let __exports={};const{registry}=require("@web/core/registry");const uploadLocalFileService=__exports.uploadLocalFileService={dependencies:["upload","orm"],start(env,{upload:uploadService,orm}){const input=document.createElement("input");input.type="file";async function selectLocalFiles({multiple,accept}){input.multiple=multiple;input.accept=accept;input.value="";input.click();await new Promise((resolve)=>{const resolveAndClear=()=>{resolve();input.removeEventListener("change",resolveAndClear);input.removeEventListener("cancel",resolveAndClear);};input.addEventListener("change",resolveAndClear);input.addEventListener("cancel",resolveAndClear);});return input.files;}
async function filesToAttachments(files,{resModel,resId}){const attachments=[];await uploadService.uploadFiles(files,{resModel,resId},(attachment)=>{attachments.push(attachment);});return attachments;}
async function upload({resId,resModel},{accept="*/*",multiple=false,accessToken=false}={}){try{const files=await selectLocalFiles({multiple,accept});const attachments=await filesToAttachments(files,{resModel,resId});if(accessToken&&attachments.length&&!attachments[0].public){await addAccessToken(attachments);}
return attachments;}catch{return[];}}
async function addAccessToken(attachments){const accessTokens=await orm.call("ir.attachment","generate_access_token",[attachments.map((a)=>a.id),]);attachments.forEach((attachment,index)=>{attachment.access_token=accessTokens[index];});return attachments;}
function getURL(attachment,{unique,download,accessToken}={}){let url=`/web/content/${attachment.id}`;const queryParams=[];if(unique){queryParams.push(`unique=${encodeURIComponent(attachment.checksum)}`);}
if(download){queryParams.push("download=true");}
if(accessToken&&attachment.access_token){queryParams.push(`access_token=${attachment.access_token}`);}
if(queryParams.length){url+=`?${queryParams.join("&")}`;}
return url;}
return{upload,addAccessToken,getURL};},};registry.category("services").add("uploadLocalFiles",uploadLocalFileService);return __exports;});;

/* /web/static/src/views/view_dialogs/form_view_dialog.js */
odoo.define('@web/views/view_dialogs/form_view_dialog',['@web/core/dialog/dialog','@web/core/utils/hooks','@web/search/action_hook','@web/views/view','@odoo/owl'],function(require){'use strict';let __exports={};const{Dialog}=require("@web/core/dialog/dialog");const{useChildRef,useService}=require("@web/core/utils/hooks");const{CallbackRecorder}=require("@web/search/action_hook");const{View}=require("@web/views/view");const{Component}=require("@odoo/owl");const FormViewDialog=__exports.FormViewDialog=class FormViewDialog extends Component{static template="web.FormViewDialog";static components={Dialog,View};static props={close:Function,resModel:String,context:{type:Object,optional:true},expandedFormRef:{type:String,optional:true},nextRecordsContext:{type:Object,optional:true},readonly:{type:Boolean,optional:true},onRecordSaved:{type:Function,optional:true},onRecordSave:{type:Function,optional:true},onRecordDiscarded:{type:Function,optional:true},removeRecord:{type:Function,optional:true},resId:{type:[Number,Boolean],optional:true},title:{type:String,optional:true},viewId:{type:[Number,Boolean],optional:true},preventCreate:{type:Boolean,optional:true},preventEdit:{type:Boolean,optional:true},canExpand:{type:Boolean,optional:true},isToMany:{type:Boolean,optional:true},size:Dialog.props.size,};static defaultProps={onRecordSaved:()=>{},preventCreate:false,preventEdit:false,canExpand:true,isToMany:false,};setup(){super.setup();this.actionService=useService("action");this.modalRef=useChildRef();this.env.dialogData.dismiss=()=>this.discardRecord();const buttonTemplate=this.props.isToMany?"web.FormViewDialog.ToMany.buttons":"web.FormViewDialog.ToOne.buttons";this.currentResId=this.props.resId;if(this.props.canExpand){this.onExpandCallback=this.onExpand.bind(this);}
this.viewProps={type:"form",buttonTemplate,context:this.props.context||{},display:{controlPanel:false},readonly:this.props.readonly,resId:this.props.resId||false,resModel:this.props.resModel,viewId:this.props.viewId||false,preventCreate:this.props.preventCreate,preventEdit:this.props.preventEdit,discardRecord:this.discardRecord.bind(this),saveRecord:async(record,params)=>{let saved;if(this.props.onRecordSave){saved=await this.props.onRecordSave(record);}else{saved=await record.save({reload:false});if(saved){this.currentResId=record.resId;await this.props.onRecordSaved(record);}}
if(saved){await this.onRecordSaved(record,params);}
return saved;},__beforeLeave__:new CallbackRecorder(),};if(this.props.removeRecord){this.viewProps.removeRecord=async()=>{await this.props.removeRecord();this.props.close();};}}
async onRecordSaved(record,params){if(params?.saveAndNew){this.currentResId=false;const context=this.props.nextRecordsContext||this.props.context||{};await record.model.load({resId:false,context});}else{this.props.close();}}
async discardRecord(){if(this.props.onRecordDiscarded){await this.props.onRecordDiscarded();}
this.props.close();}
async onExpand(){const beforeLeaveCallbacks=this.viewProps.__beforeLeave__.callbacks;const res=await Promise.all(beforeLeaveCallbacks.map((callback)=>callback()));if(!res.includes(false)){this.actionService.doAction({type:"ir.actions.act_window",res_model:this.props.resModel,res_id:this.currentResId,views:[[false,"form"]],context:{...this.props.context,form_view_ref:this.props.expandedFormRef,},});}}}
return __exports;});;

/* /web/static/src/views/view_dialogs/export_data_dialog.js */
odoo.define('@web/views/view_dialogs/export_data_dialog',['@web/core/l10n/translation','@web/core/browser/browser','@web/core/checkbox/checkbox','@web/core/dialog/dialog','@web/core/network/rpc','@web/core/utils/arrays','@web/core/utils/hooks','@web/core/utils/search','@web/core/utils/sortable_owl','@web/core/utils/timing','@odoo/owl'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web",...args);const{browser}=require("@web/core/browser/browser");const{CheckBox}=require("@web/core/checkbox/checkbox");const{Dialog}=require("@web/core/dialog/dialog");const{rpc}=require("@web/core/network/rpc");const{unique}=require("@web/core/utils/arrays");const{useService}=require("@web/core/utils/hooks");const{fuzzyLookup}=require("@web/core/utils/search");const{useSortable}=require("@web/core/utils/sortable_owl");const{useDebounced}=require("@web/core/utils/timing");const{Component,useRef,useState,onMounted,onWillStart,onWillUnmount}=require("@odoo/owl");class DeleteExportListDialog extends Component{static components={Dialog};static template="web.DeleteExportListDialog";static props={text:String,close:Function,delete:Function,};async onDelete(){await this.props.delete();this.props.close();}}
class ExportDataItem extends Component{static template="web.ExportDataItem";static components={ExportDataItem};static props={exportList:{type:Object,optional:true},field:{type:Object,optional:true},filterSubfields:Function,isDebug:Boolean,isExpanded:Boolean,isFieldExpandable:Function,onAdd:Function,loadFields:Function,};setup(){this.state=useState({subfields:[],});onWillStart(()=>{if(this.props.isExpanded){return this.toggleItem(this.props.field.id,false);}});}
async toggleItem(id,isUserToggle){if(this.props.isFieldExpandable(id)){if(this.state.subfields.length){this.state.subfields=[];}else{const subfields=await this.props.loadFields(id,!isUserToggle);if(subfields){this.state.subfields=isUserToggle?subfields:this.props.filterSubfields(subfields);}else{this.state.subfields=[];}}}}
onDoubleClick(id){if(!this.props.isFieldExpandable(id)&&!this.isFieldSelected(id)){this.props.onAdd(id);}}
isFieldSelected(current){return this.props.exportList.find(({id})=>id===current);}}
const ExportDataDialog=__exports.ExportDataDialog=class ExportDataDialog extends Component{static template="web.ExportDataDialog";static components={CheckBox,Dialog,ExportDataItem};static props={close:{type:Function},context:{type:Object,optional:true},defaultExportList:{type:Array},download:{type:Function},getExportedFields:{type:Function},root:{type:Object},};setup(){this.dialog=useService("dialog");this.notification=useService("notification");this.orm=useService("orm");this.draggableRef=useRef("draggable");this.exportListRef=useRef("exportList");this.searchRef=useRef("search");this.knownFields={};this.expandedFields={};this.availableFormats=[];this.templates=[];this.isCompatible=false;this.state=useState({exportList:[],isEditingTemplate:false,search:[],selectedFormat:0,templateId:null,isSmall:this.env.isSmall,disabled:false,});this.newTemplateText=_t("New template");this.removeFieldText=_t("Remove field");this.debouncedOnResize=useDebounced(this.updateSize,300);useSortable({ref:this.draggableRef,elements:".o_export_field",enable:!this.state.isSmall,cursor:"grabbing",onDrop:async({element,previous,next})=>{const indexes=[element,previous,next].map((e)=>e&&Object.values(this.state.exportList).findIndex(({id})=>id===e.dataset.field_id));let target;if(indexes[0]<indexes[1]){target=previous?indexes[1]:0;}else{target=next?indexes[2]:this.state.exportList.length-1;}
this.onDraggingEnd(indexes[0],target);},});onWillStart(async()=>{this.availableFormats=await rpc("/web/export/formats");this.templates=await this.orm.searchRead("ir.exports",[["resource","=",this.props.root.resModel]],[],{context:this.props.context,});await this.fetchFields();});onMounted(()=>{browser.addEventListener("resize",this.debouncedOnResize);this.updateSize();});onWillUnmount(()=>browser.removeEventListener("resize",this.debouncedOnResize));}
get fieldsAvailable(){if(this.searchRef.el&&this.searchRef.el.value){return this.state.search.length&&Object.values(this.state.search);}
return Object.values(this.knownFields);}
get isDebug(){return Boolean(odoo.debug);}
get rootFields(){if(this.searchRef.el&&this.searchRef.el.value){const rootFromSearchResults=this.fieldsAvailable.map((f)=>{if(f.parent){const parentEl=this.knownFields[f.parent.id];return this.knownFields[parentEl.parent?parentEl.parent.id:parentEl.id];}
return this.knownFields[f.id];});return unique(rootFromSearchResults);}
return this.fieldsAvailable.filter(({parent})=>!parent);}
filterSubfields(subfields){let subfieldsFromSearchResults=[];let searchResults;if(this.searchRef.el&&this.searchRef.el.value){searchResults=this.lookup(this.searchRef.el.value);}
const fieldsAvailable=Object.values(searchResults||this.knownFields);if(this.searchRef.el&&this.searchRef.el.value){subfieldsFromSearchResults=fieldsAvailable.filter((f)=>f.parent&&this.knownFields[f.parent.id].parent).map((f)=>f.parent);}
const availableSubFields=unique([...fieldsAvailable,...subfieldsFromSearchResults]);return subfields.filter((a)=>availableSubFields.some((b)=>a.id===b.id));}
updateSize(){this.state.isSmall=this.env.isSmall;}
async fetchFields(){this.knownFields={};this.expandedFields={};await this.loadFields();await this.setDefaultExportList();this.state.search=[];if(this.searchRef.el){this.searchRef.el.value="";}
if(this.state.templateId){this.loadExportList(this.state.templateId);}}
enterTemplateEdition(){if(this.state.templateId&&!this.state.isEditingTemplate){this.state.isEditingTemplate=true;}}
isFieldExpandable(id){return this.knownFields[id].children&&id.split("/").length<3;}
async loadExportList(value){this.state.templateId=value==="new_template"?value:Number(value);this.state.isEditingTemplate=value==="new_template";if(!value||value==="new_template"){return;}
const fields=await rpc("/web/export/namelist",{model:this.props.root.resModel,export_id:Number(value),});this.state.exportList=fields;}
async loadFields(id,preventLoad=false){let parentField,parentParams;if(id){if(this.expandedFields[id]){return this.expandedFields[id].fields;}
parentField=this.knownFields[id];parentParams={...parentField.params,parent_field_type:parentField.field_type,parent_field:parentField,parent_name:parentField.string,exclude:[parentField.relation_field],};}
if(preventLoad){return;}
const fields=await this.props.getExportedFields(this.isCompatible,parentParams);for(const field of fields){field.parent=parentField;if(!this.knownFields[field.id]){this.knownFields[field.id]=field;}}
if(id){this.expandedFields[id]={fields};}
return fields;}
onDraggingEnd(item,target){this.state.exportList.splice(target,0,this.state.exportList.splice(item,1)[0]);}
onAddItemExportList(fieldId){this.state.exportList.push(this.knownFields[fieldId]);this.enterTemplateEdition();}
onRemoveItemExportList(fieldId){const item=this.state.exportList.findIndex(({id})=>id===fieldId);this.state.exportList.splice(item,1);this.enterTemplateEdition();}
async onChangeExportList(ev){this.loadExportList(ev.target.value);}
async onSaveExportTemplate(){const name=this.exportListRef.el.value;if(!name){return this.notification.add(_t("Please enter save field list name"),{type:"danger",});}
const[id]=await this.orm.create("ir.exports",[{name,export_fields:this.state.exportList.map((field)=>[0,0,{name:field.id,},]),resource:this.props.root.resModel,},],{context:this.props.context});this.state.isEditingTemplate=false;this.state.templateId=id;this.templates.push({id,name});}
onCancelExportTemplate(){this.state.isEditingTemplate=false;if(this.state.templateId==="new_template"){this.state.templateId=null;return;}
this.loadExportList(this.state.templateId);}
async onClickExportButton(){if(!this.state.exportList.length){return this.notification.add(_t("Please select fields to save export list..."),{type:"danger",});}
this.state.disabled=true;await this.props.download(this.state.exportList,this.isCompatible,this.availableFormats[this.state.selectedFormat].tag);this.state.disabled=false;}
async onDeleteExportTemplate(){this.dialog.add(DeleteExportListDialog,{text:_t("Do you really want to delete this export template?"),delete:async()=>{const id=Number(this.state.templateId);await this.orm.unlink("ir.exports",[id],{context:this.props.context});this.templates.splice(this.templates.findIndex((i)=>i.id===id),1);this.state.templateId=null;this.setDefaultExportList();},});}
onSearch(ev){this.state.search=this.lookup(ev.target.value);}
lookup(value){let lookupResult=fuzzyLookup(value,Object.values(this.knownFields),(field)=>field.string.split("/").reverse().join("/"));if(this.isDebug){lookupResult=unique([...lookupResult,...Object.values(this.knownFields).filter((f)=>f.id.includes(value)),]);}
return lookupResult;}
onToggleCompatibleExport(value){this.isCompatible=value;this.fetchFields();}
async setDefaultExportList(){const defaultExportList=this.props.defaultExportList.map((defaultField)=>this.knownFields[defaultField.name]).filter((field)=>field);const defaultExportfields=Object.values(this.knownFields).filter((field)=>field.default_export);this.state.exportList=unique([...defaultExportList,...defaultExportfields]);}
setFormat(ev){if(ev.target.checked){this.state.selectedFormat=this.availableFormats.findIndex(({tag})=>tag===ev.target.value);}}}
return __exports;});;

/* /web/static/src/core/debug/debug_context.js */
odoo.define('@web/core/debug/debug_context',['@web/core/user','@web/core/registry','@odoo/owl'],function(require){'use strict';let __exports={};const{user}=require("@web/core/user");const{registry}=require("@web/core/registry");const{useEffect,useEnv,useSubEnv}=require("@odoo/owl");const debugRegistry=registry.category("debug");const getAccessRights=async()=>{const rightsToCheck={"ir.ui.view":"write","ir.rule":"read","ir.model.access":"read",};const proms=Object.entries(rightsToCheck).map(([model,operation])=>{return user.checkAccessRight(model,operation);});const[canEditView,canSeeRecordRules,canSeeModelAccess]=await Promise.all(proms);const accessRights={canEditView,canSeeRecordRules,canSeeModelAccess};return accessRights;};class DebugContext{constructor(defaultCategories){this.categories=new Map(defaultCategories.map((cat)=>[cat,[{}]]));}
activateCategory(category,context){const contexts=this.categories.get(category)||new Set();contexts.add(context);this.categories.set(category,contexts);return()=>{contexts.delete(context);if(contexts.size===0){this.categories.delete(category);}};}
async getItems(env){const accessRights=await getAccessRights();return[...this.categories.entries()].flatMap(([category,contexts])=>{return debugRegistry.category(category).getAll().map((factory)=>factory(Object.assign({env,accessRights},...contexts)));}).filter(Boolean).sort((x,y)=>{const xSeq=x.sequence||1000;const ySeq=y.sequence||1000;return xSeq-ySeq;});}}
const debugContextSymbol=Symbol("debugContext");__exports.createDebugContext=createDebugContext;function createDebugContext({categories=[]}={}){return{[debugContextSymbol]:new DebugContext(categories)};}
__exports.useOwnDebugContext=useOwnDebugContext;function useOwnDebugContext({categories=[]}={}){useSubEnv(createDebugContext({categories}));}
__exports.useEnvDebugContext=useEnvDebugContext;function useEnvDebugContext(){const debugContext=useEnv()[debugContextSymbol];if(!debugContext){throw new Error("There is no debug context available in the current environment.");}
return debugContext;}
__exports.useDebugCategory=useDebugCategory;function useDebugCategory(category,context={}){const env=useEnv();if(env.debug){const debugContext=useEnvDebugContext();useEffect(()=>debugContext.activateCategory(category,context),()=>[]);}}
return __exports;});;

/* /web/static/src/core/debug/debug_menu.js */
odoo.define('@web/core/debug/debug_menu',['@web/core/l10n/translation','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_item','@web/core/debug/debug_menu_basic','@web/core/commands/command_hook','@web/core/utils/hooks','@web/core/debug/debug_context'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web",...args);const{Dropdown}=require("@web/core/dropdown/dropdown");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{DebugMenuBasic}=require("@web/core/debug/debug_menu_basic");const{useCommand}=require("@web/core/commands/command_hook");const{useService}=require("@web/core/utils/hooks");const{useEnvDebugContext}=require("@web/core/debug/debug_context");const DebugMenu=__exports.DebugMenu=class DebugMenu extends DebugMenuBasic{static components={Dropdown,DropdownItem};static props={};setup(){super.setup();const debugContext=useEnvDebugContext();this.command=useService("command");useCommand(_t("Debug tools..."),async()=>{const items=await debugContext.getItems(this.env);let index=0;const defaultCategories=items.filter((item)=>item.type==="separator").map(()=>(index+=1));const provider={async provide(){const categories=[...defaultCategories];let category=categories.shift();const result=[];items.forEach((item)=>{if(item.type==="item"){result.push({name:item.description.toString(),action:item.callback,category,});}else if(item.type==="separator"){category=categories.shift();}});return result;},};const configByNamespace={default:{categories:defaultCategories,emptyMessage:_t("No debug command found"),placeholder:_t("Choose a debug command..."),},};const commandPaletteConfig={configByNamespace,providers:[provider],};return commandPaletteConfig;},{category:"debug",});}}
return __exports;});;

/* /web/static/src/core/debug/debug_menu_basic.js */
odoo.define('@web/core/debug/debug_menu_basic',['@web/core/debug/debug_context','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_item','@web/core/l10n/translation','@web/core/utils/arrays','@odoo/owl','@web/core/registry'],function(require){'use strict';let __exports={};const{useEnvDebugContext}=require("@web/core/debug/debug_context");const{Dropdown}=require("@web/core/dropdown/dropdown");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web",...args);const{groupBy,sortBy}=require("@web/core/utils/arrays");const{Component}=require("@odoo/owl");const{registry}=require("@web/core/registry");const debugSectionRegistry=registry.category("debug_section");debugSectionRegistry.add("record",{label:_t("Record"),sequence:10}).add("records",{label:_t("Records"),sequence:10}).add("ui",{label:_t("User Interface"),sequence:20}).add("security",{label:_t("Security"),sequence:30}).add("testing",{label:_t("Tours & Testing"),sequence:40}).add("tools",{label:_t("Tools"),sequence:50});const DebugMenuBasic=__exports.DebugMenuBasic=class DebugMenuBasic extends Component{static template="web.DebugMenu";static components={Dropdown,DropdownItem,};static props={};setup(){this.debugContext=useEnvDebugContext();}
async loadGroupedItems(){const items=await this.debugContext.getItems(this.env);const sections=groupBy(items,(item)=>item.section||"");this.sectionEntries=sortBy(Object.entries(sections),([section])=>debugSectionRegistry.get(section,{sequence:50}).sequence);}
getSectionLabel(section){return debugSectionRegistry.get(section,{label:section}).label;}}
return __exports;});;

/* /web/static/src/core/debug/debug_menu_items.js */
odoo.define('@web/core/debug/debug_menu_items',['@web/core/l10n/translation','@web/core/browser/browser','@web/core/browser/router','@web/core/registry','@web/core/user'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web",...args);const{browser}=require("@web/core/browser/browser");const{router}=require("@web/core/browser/router");const{registry}=require("@web/core/registry");const{user}=require("@web/core/user");function activateTestsAssetsDebugging({env}){if(String(router.current.debug).includes("tests")){return;}
return{type:"item",description:_t("Activate Test Mode"),callback:()=>{router.pushState({debug:"assets,tests"},{reload:true});},sequence:580,section:"tools",};}
__exports.regenerateAssets=regenerateAssets;function regenerateAssets({env}){return{type:"item",description:_t("Regenerate Assets"),callback:async()=>{await env.services.orm.call("ir.attachment","regenerate_assets_bundles");browser.location.reload();},sequence:550,section:"tools",};}
__exports.becomeSuperuser=becomeSuperuser;function becomeSuperuser({env}){const becomeSuperuserURL=browser.location.origin+"/web/become";if(!user.isAdmin){return false;}
return{type:"item",description:_t("Become Superuser"),href:becomeSuperuserURL,callback:()=>{browser.open(becomeSuperuserURL,"_self");},sequence:560,section:"tools",};}
function leaveDebugMode(){return{type:"item",description:_t("Leave Debug Mode"),callback:()=>{router.pushState({debug:0},{reload:true});},sequence:650,};}
registry.category("debug").category("default").add("regenerateAssets",regenerateAssets).add("becomeSuperuser",becomeSuperuser).add("activateTestsAssetsDebugging",activateTestsAssetsDebugging).add("leaveDebugMode",leaveDebugMode);return __exports;});;

/* /web/static/src/core/debug/debug_providers.js */
odoo.define('@web/core/debug/debug_providers',['@web/core/l10n/translation','@web/core/registry','@web/core/browser/browser','@web/core/browser/router'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web",...args);const{registry}=require("@web/core/registry");const{browser}=require("@web/core/browser/browser");const{router}=require("@web/core/browser/router");const commandProviderRegistry=registry.category("command_provider");commandProviderRegistry.add("debug",{provide:(env,options)=>{const result=[];if(env.debug){if(!env.debug.includes("assets")){result.push({action(){router.pushState({debug:"assets"},{reload:true});},category:"debug",name:_t("Activate debug mode (with assets)"),});}
result.push({action(){router.pushState({debug:0},{reload:true});},category:"debug",name:_t("Deactivate debug mode"),});result.push({action(){browser.open("/web/tests?debug=assets");},category:"debug",name:_t("Run Unit Tests"),});}else{const debugKey="debug";if(options.searchValue.toLowerCase()===debugKey){result.push({action(){router.pushState({debug:"1"},{reload:true});},category:"debug",name:`${_t("Activate debug mode")} (${debugKey})`,});result.push({action(){router.pushState({debug:"assets"},{reload:true});},category:"debug",name:`${_t("Activate debug mode (with assets)")} (${debugKey})`,});}}
return result;},});return __exports;});;

/* /web/static/src/core/debug/debug_utils.js */
odoo.define('@web/core/debug/debug_utils',[],function(require){'use strict';let __exports={};__exports.editModelDebug=editModelDebug;function editModelDebug(env,title,model,id){return env.services.action.doAction({res_model:model,res_id:id,name:title,type:"ir.actions.act_window",views:[[false,"form"]],view_mode:"form",target:"current",});}
return __exports;});;

/* /web/static/src/core/commands/command_hook.js */
odoo.define('@web/core/commands/command_hook',['@web/core/utils/hooks','@odoo/owl'],function(require){'use strict';let __exports={};const{useService}=require("@web/core/utils/hooks");const{useEffect}=require("@odoo/owl");__exports.useCommand=useCommand;function useCommand(name,action,options={}){const commandService=useService("command");useEffect(()=>commandService.add(name,action,options),()=>[]);}
return __exports;});;

/* /web/static/src/model/model.js */
odoo.define('@web/model/model',['@web/core/network/rpc','@web/core/user','@web/core/utils/concurrency','@web/core/utils/hooks','@web/search/action_hook','@web/search/with_search/with_search','@web/model/sample_server','@odoo/owl'],function(require){'use strict';let __exports={};const{RPCError}=require("@web/core/network/rpc");const{user}=require("@web/core/user");const{Deferred,Race}=require("@web/core/utils/concurrency");const{useService}=require("@web/core/utils/hooks");const{useSetupAction}=require("@web/search/action_hook");const{SEARCH_KEYS}=require("@web/search/with_search/with_search");const{buildSampleORM}=require("@web/model/sample_server");const{EventBus,onWillStart,onWillUnmount,onWillUpdateProps,status,useComponent,}=require("@odoo/owl");const Model=__exports.Model=class Model{static services=[];constructor(env,params,services){this.env=env;this.orm=services.orm;this.bus=new EventBus();this.isReady=false;this.whenReady=new Deferred();this.whenReady.then(()=>{this.isReady=true;this.notify();});this.setup(params,services);}
setup(){}
async load(_params){}
hasData(){return true;}
getGroups(){return null;}
notify(){this.bus.trigger("update");}}
function getSearchParams(props){const params={};for(const key of SEARCH_KEYS){params[key]=props[key];}
return params;}
__exports.useModel=useModel;function useModel(ModelClass,params,options={}){const component=useComponent();const services={};for(const key of ModelClass.services){services[key]=useService(key);}
services.orm=services.orm||useService("orm");const model=new ModelClass(component.env,params,services);onWillStart(async()=>{await options.beforeFirstLoad?.();await model.load(getSearchParams(component.props));model.whenReady.resolve();});onWillUpdateProps((nextProps)=>model.load(getSearchParams(nextProps)));return model;}
__exports.useModelWithSampleData=useModelWithSampleData;function useModelWithSampleData(ModelClass,params,options={}){const component=useComponent();if(!(ModelClass.prototype instanceof Model)){throw new Error(`the model class should extend Model`);}
const services={};for(const key of ModelClass.services){services[key]=useService(key);}
services.orm=services.orm||useService("orm");if(!("isAlive"in params)){params.isAlive=()=>status(component)!=="destroyed";}
const model=new ModelClass(component.env,params,services);const onUpdate=()=>component.render(true);model.bus.addEventListener("update",onUpdate);onWillUnmount(()=>model.bus.removeEventListener("update",onUpdate));const globalState=component.props.globalState||{};const localState=component.props.state||{};let useSampleModel=component.props.useSampleModel&&(!("useSampleModel"in globalState)||globalState.useSampleModel);model.useSampleModel=false;const orm=model.orm;let sampleORM=localState.sampleORM;async function _load(props){const searchParams=getSearchParams(props);await model.load(searchParams);if(useSampleModel&&!model.hasData()){sampleORM=sampleORM||buildSampleORM(component.props.resModel,component.props.fields,user);model.orm=sampleORM;await model.load(searchParams);model.orm=orm;model.useSampleModel=true;}else{useSampleModel=false;model.useSampleModel=useSampleModel;}
model.whenReady.resolve();if(status(component)==="mounted"){model.notify();}}
const race=new Race();const load=(props)=>race.add(_load(props));onWillStart(()=>{const prom=load(component.props);if(options.lazy){prom.catch((e)=>{if(e instanceof RPCError){component.env.config.historyBack();}
throw e;});}else{return prom;}});onWillUpdateProps((nextProps)=>{useSampleModel=false;load(nextProps);});useSetupAction({getGlobalState(){if(component.props.useSampleModel){return{useSampleModel};}},getLocalState:()=>({sampleORM}),});return model;}
__exports._makeFieldFromPropertyDefinition=_makeFieldFromPropertyDefinition;function _makeFieldFromPropertyDefinition(name,definition,relatedPropertyField){return{...definition,name,propertyName:definition.name,relation:definition.comodel,relatedPropertyField,};}
__exports.addPropertyFieldDefs=addPropertyFieldDefs;async function addPropertyFieldDefs(orm,resModel,context,fields,groupBy){const proms=[];for(const gb of groupBy){if(gb in fields){continue;}
const[fieldName]=gb.split(".");const field=fields[fieldName];if(field?.type==="properties"){proms.push(orm.call(resModel,"get_property_definition",[gb],{context,}).then((definition)=>{fields[gb]=_makeFieldFromPropertyDefinition(gb,definition,field);}).catch(()=>{fields[gb]=_makeFieldFromPropertyDefinition(gb,{},field);}));}}
return Promise.all(proms);}
return __exports;});;

/* /web/static/src/model/record.js */
odoo.define('@web/model/record',['@web/core/utils/hooks','@web/core/utils/objects','@web/model/relational_model/relational_model','@web/model/relational_model/utils','@odoo/owl'],function(require){'use strict';let __exports={};const{useService}=require("@web/core/utils/hooks");const{isObject,pick}=require("@web/core/utils/objects");const{RelationalModel}=require("@web/model/relational_model/relational_model");const{getFieldsSpec}=require("@web/model/relational_model/utils");const{Component,xml,onWillStart,onWillUpdateProps,useState}=require("@odoo/owl");const defaultActiveField={attrs:{},options:{},domain:"[]",string:""};class StandaloneRelationalModel extends RelationalModel{load(params={}){if(params.values){const data=params.values;const config=this._getNextConfig(this.config,params);this.root=this._createRoot(config,data);this.config=config;this.hooks.onRootLoaded(this.root);return Promise.resolve();}
return super.load(params);}}
class _Record extends Component{static template=xml`<t t-slot="default" record="model.root"/>`;static props=["slots","info","fields","values?"];setup(){this.orm=useService("orm");const resModel=this.props.info.resModel;const activeFields=this.getActiveFields();const modelParams={config:{resModel,fields:this.props.fields,isMonoRecord:true,activeFields,resId:this.props.info.resId,mode:this.props.info.mode,context:this.props.info.context,},hooks:this.props.info.hooks,};const modelServices=Object.fromEntries(StandaloneRelationalModel.services.map((servName)=>[servName,useService(servName)]));modelServices.orm=this.orm;this.model=useState(new StandaloneRelationalModel(this.env,modelParams,modelServices));const prepareLoadWithValues=async(values)=>{values=pick(values,...Object.keys(modelParams.config.activeFields));const proms=[];for(const fieldName in values){if(["one2many","many2many"].includes(this.props.fields[fieldName].type)){if(values[fieldName].length&&typeof values[fieldName][0]==="number"){const resModel=this.props.fields[fieldName].relation;const resIds=values[fieldName];const activeField=modelParams.config.activeFields[fieldName];if(activeField.related){const{activeFields,fields}=activeField.related;const fieldSpec=getFieldsSpec(activeFields,fields,{});const kwargs={context:activeField.context||{},specification:fieldSpec,};proms.push(this.orm.webRead(resModel,resIds,kwargs).then((records)=>{values[fieldName]=records;}));}}}
if(this.props.fields[fieldName].type==="many2one"){const loadDisplayName=async(resId)=>{const resModel=this.props.fields[fieldName].relation;const activeField=modelParams.config.activeFields[fieldName];const kwargs={context:activeField.context||{},specification:{display_name:{}},};const records=await this.orm.webRead(resModel,[resId],kwargs);return records[0].display_name;};if(typeof values[fieldName]==="number"){const prom=loadDisplayName(values[fieldName]);prom.then((displayName)=>{values[fieldName]={id:values[fieldName],display_name:displayName,};});proms.push(prom);}else if(Array.isArray(values[fieldName])){if(values[fieldName][1]===undefined){const prom=loadDisplayName(values[fieldName][0]);prom.then((displayName)=>{values[fieldName]={id:values[fieldName][0],display_name:displayName,};});proms.push(prom);}
values[fieldName]={id:values[fieldName][0],display_name:values[fieldName][1],};}else if(isObject(values[fieldName])){if(values[fieldName].display_name===undefined){const prom=loadDisplayName(values[fieldName].id);prom.then((displayName)=>{values[fieldName]={id:values[fieldName].id,display_name:displayName,};});proms.push(prom);}
values[fieldName]={id:values[fieldName].id,display_name:values[fieldName].display_name,};}}
await Promise.all(proms);}
return values;};onWillStart(async()=>{if(this.props.values){const values=await prepareLoadWithValues(this.props.values);await this.model.load({values});}else{await this.model.load();}
this.model.whenReady.resolve();});onWillUpdateProps(async(nextProps)=>{const params={};if(nextProps.info.resId!==this.model.root.resId){params.resId=nextProps.info.resId;}
if(nextProps.values){params.values=await prepareLoadWithValues(nextProps.values);}
if(Object.keys(params).length){return this.model.load(params);}});}
getActiveFields(){if(this.props.info.activeFields){const activeFields={};for(const[fName,fInfo]of Object.entries(this.props.info.activeFields)){activeFields[fName]={...defaultActiveField,...fInfo};}
return activeFields;}
return Object.fromEntries(this.props.info.fieldNames.map((f)=>[f,{...defaultActiveField}]));}}
const Record=__exports.Record=class Record extends Component{static template=xml`<_Record fields="fields" slots="props.slots" values="props.values" info="props" />`;static components={_Record};static props=["slots","resModel?","fieldNames?","activeFields?","fields?","resId?","mode?","values?","context?","hooks?",];static defaultProps={context:{},};setup(){const{activeFields,fieldNames,fields,resModel}=this.props;if(!activeFields&&!fieldNames){throw Error(`Record props should have either a "activeFields" key or a "fieldNames" key`);}
if(!fields&&(!fieldNames||!resModel)){throw Error(`Record props should have either a "fields" key or a "fieldNames" and a "resModel" key`);}
if(fields){this.fields=fields;}else{const fieldService=useService("field");onWillStart(async()=>{this.fields=await fieldService.loadFields(resModel,{fieldNames});});}}}
return __exports;});;

/* /web/static/src/model/relational_model/datapoint.js */
odoo.define('@web/model/relational_model/datapoint',['@odoo/owl','@web/core/utils/reactive','@web/model/relational_model/utils'],function(require){'use strict';let __exports={};const{markRaw}=require("@odoo/owl");const{Reactive}=require("@web/core/utils/reactive");const{getId}=require("@web/model/relational_model/utils");const DataPoint=__exports.DataPoint=class DataPoint extends Reactive{constructor(model,config,data,options){super(...arguments);this.id=getId("datapoint");this.model=model;markRaw(config.activeFields);markRaw(config.fields);this._config=config;this.setup(config,data,options);}
setup(_config,_data,_options){}
get activeFields(){return this.config.activeFields;}
get fields(){return this.config.fields;}
get fieldNames(){return Object.keys(this.activeFields).filter((fieldName)=>!this.fields[fieldName].relatedPropertyField);}
get resModel(){return this.config.resModel;}
get config(){return this._config;}
get context(){return this.config.context;}}
return __exports;});;

/* /web/static/src/model/relational_model/dynamic_group_list.js */
odoo.define('@web/model/relational_model/dynamic_group_list',['@web/core/domain','@web/model/relational_model/dynamic_list','@web/model/relational_model/utils'],function(require){'use strict';let __exports={};const{Domain}=require("@web/core/domain");const{DynamicList}=require("@web/model/relational_model/dynamic_list");const{getGroupServerValue}=require("@web/model/relational_model/utils");const MOVABLE_RECORD_TYPES=__exports.MOVABLE_RECORD_TYPES=["char","boolean","integer","selection","many2one"];const DynamicGroupList=__exports.DynamicGroupList=class DynamicGroupList extends DynamicList{static type="DynamicGroupList";setup(_config,data){super.setup(...arguments);this.isGrouped=true;this._nbRecordsMatchingDomain=null;this._setData(data);}
_setData(data){this.groups=data.groups.map((g)=>this._createGroupDatapoint(g));this.count=data.length;this._selectDomain(this.isDomainSelected);}
get groupBy(){return this.config.groupBy;}
get groupByField(){return this.fields[this.groupBy[0].split(":")[0]];}
get hasData(){return this.groups.some((group)=>group.hasData);}
get isRecordCountTrustable(){return this.count<=this.limit||this._nbRecordsMatchingDomain!==null;}
get records(){return this.groups.filter((group)=>!group.isFolded).map((group)=>group.records).flat();}
get recordCount(){if(this._nbRecordsMatchingDomain!==null){return this._nbRecordsMatchingDomain;}
return this.groups.reduce((acc,group)=>acc+group.count,0);}
async createGroup(groupName,foldField){if(!this.groupByField||this.groupByField.type!=="many2one"){throw new Error("Cannot create a group on a non many2one group field");}
await this.model.mutex.exec(()=>this._createGroup(groupName,foldField));}
async deleteGroups(groups){await this.model.mutex.exec(()=>this._deleteGroups(groups));}
async moveRecord(dataRecordId,dataGroupId,refId,targetGroupId){const targetGroup=this.groups.find((g)=>g.id===targetGroupId);if(dataGroupId===targetGroupId){await targetGroup.list._resequence(targetGroup.list.records,this.resModel,dataRecordId,refId);return;}
const sourceGroup=this.groups.find((g)=>g.id===dataGroupId);const recordIndex=sourceGroup.list.records.findIndex((r)=>r.id===dataRecordId);const record=sourceGroup.list.records[recordIndex];const refIndex=targetGroup.list.records.findIndex((r)=>r.id===refId);const oldIndex=sourceGroup.list.records.findIndex((r)=>r.id===dataRecordId);const sourceList=sourceGroup.list;const mustReloadSourceList=sourceList.count>sourceList.offset+sourceList.limit;sourceGroup._removeRecords([record.id]);targetGroup._addRecord(record,refIndex+1);let value=targetGroup.value;if(targetGroup.groupByField.type==="many2one"){value=value?{id:value,display_name:targetGroup.displayName}:false;}
const revert=()=>{targetGroup._removeRecords([record.id]);sourceGroup._addRecord(record,oldIndex);};try{const changes={[targetGroup.groupByField.name]:value};const res=await record.update(changes,{save:true});if(!res){return revert();}}catch(e){revert();throw e;}
const proms=[];if(mustReloadSourceList){const{offset,limit,orderBy,domain}=sourceGroup.list;proms.push(sourceGroup.list._load(offset,limit,orderBy,domain));}
if(!targetGroup.isFolded){const targetList=targetGroup.list;const records=targetList.records;proms.push(targetList._resequence(records,this.resModel,dataRecordId,refId));}
return Promise.all(proms);}
async resequence(movedGroupId,targetGroupId){if(!this.groupByField||this.groupByField.type!=="many2one"){throw new Error("Cannot resequence a group on a non many2one group field");}
return this.model.mutex.exec(async()=>{await this._resequence(this.groups,this.groupByField.relation,movedGroupId,targetGroupId);});}
async selectDomain(value){return this.model.mutex.exec(async()=>{await this._ensureCorrectRecordCount();this._selectDomain(value);});}
async sortBy(fieldName){if(!this.groups.length){return;}
if(this.groups.every((group)=>group.isFolded)){if(this.groupByField.name!==fieldName){if(!(fieldName in this.groups[0].aggregates)){return;}}}
return super.sortBy(fieldName);}
async _createGroup(groupName,foldField=false){const[id]=await this.model.orm.call(this.groupByField.relation,"name_create",[groupName],{context:this.context});if(foldField){await this.model.orm.write(this.groupByField.relation,[id],{[foldField]:true},{context:this.context});}
const lastGroup=this.groups.at(-1);const commonConfig={resModel:this.config.resModel,fields:this.config.fields,activeFields:this.config.activeFields,fieldsToAggregate:this.config.fieldsToAggregate,};const context={...this.context,[`default_${this.groupByField.name}`]:id,};const nextConfigGroups={...this.config.groups};const domain=Domain.and([this.domain,[[this.groupByField.name,"=",id]]]).toList();const groupBy=this.groupBy.slice(1);nextConfigGroups[id]={...commonConfig,context,groupByFieldName:this.groupByField.name,isFolded:Boolean(foldField),value:id,extraDomain:false,initialDomain:domain,list:{...commonConfig,context,domain:domain,groupBy,orderBy:this.orderBy,limit:this.model.initialLimit,offset:0,},};this.model._updateConfig(this.config,{groups:nextConfigGroups},{reload:false});const data={aggregates:{},count:0,length:0,__domain:domain,[this.groupByField.name]:[id,groupName],value:id,serverValue:getGroupServerValue(this.groupByField,id),displayName:groupName,rawValue:[id,groupName],};if(groupBy.length){data.groups=[];}else{data.records=[];}
const group=this._createGroupDatapoint(data);if(lastGroup){const groups=[...this.groups,group];await this._resequence(groups,this.groupByField.relation,group.id,lastGroup.id);this.groups=groups;}else{this.groups.push(group);}}
_createGroupDatapoint(data){return new this.model.constructor.Group(this.model,this.config.groups[data.value],data);}
async _deleteGroups(groups){const shouldReload=groups.some((g)=>g.count>0);await this._unlinkGroups(groups);const configGroups={...this.config.groups};for(const group of groups){delete configGroups[group.value];}
if(shouldReload){await this.model._updateConfig(this.config,{groups:configGroups},{commit:this._setData.bind(this)});}else{for(const group of groups){this._removeGroup(group);}
this.model._updateConfig(this.config,{groups:configGroups},{reload:false});}}
async _ensureCorrectRecordCount(){if(!this.isRecordCountTrustable){this._nbRecordsMatchingDomain=await this.model.orm.searchCount(this.resModel,this.domain,{limit:this.model.initialCountLimit});}}
_getDPresId(group){return group.value;}
_getDPFieldValue(group,handleField){return group[handleField];}
async _load(offset,limit,orderBy,domain){await this.model._updateConfig(this.config,{offset,limit,orderBy,domain},{commit:this._setData.bind(this)});if(this.isDomainSelected){await this._ensureCorrectRecordCount();}}
_removeGroup(group){const index=this.groups.findIndex((g)=>g.id===group.id);this.groups.splice(index,1);this.count--;}
_removeRecords(recordIds){const proms=[];for(const group of this.groups){proms.push(group._removeRecords(recordIds));}
return Promise.all(proms);}
_selectDomain(value){for(const group of this.groups){group.list._selectDomain(value);}
super._selectDomain(value);}
async _toggleSelection(){if(!this.records.length){if(!this.isDomainSelected){await this._ensureCorrectRecordCount();this._selectDomain(true);}else{this._selectDomain(false);}}else{super._toggleSelection();}}
_unlinkGroups(groups){const groupResIds=groups.map((g)=>g.value);return this.model.orm.unlink(this.groupByField.relation,groupResIds,{context:this.context,});}}
return __exports;});;

/* /web/static/src/model/relational_model/dynamic_list.js */
odoo.define('@web/model/relational_model/dynamic_list',['@web/core/confirmation_dialog/confirmation_dialog','@web/core/l10n/translation','@web/core/orm_service','@web/core/utils/arrays','@web/model/relational_model/datapoint','@web/model/relational_model/operation','@web/model/relational_model/record','@web/model/relational_model/utils'],function(require){'use strict';let __exports={};const{ConfirmationDialog}=require("@web/core/confirmation_dialog/confirmation_dialog");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web",...args);const{x2ManyCommands}=require("@web/core/orm_service");const{unique}=require("@web/core/utils/arrays");const{DataPoint}=require("@web/model/relational_model/datapoint");const{Operation}=require("@web/model/relational_model/operation");const{Record:RelationalRecord}=require("@web/model/relational_model/record");const{getFieldsSpec,resequence}=require("@web/model/relational_model/utils");const DEFAULT_HANDLE_FIELD="sequence";const DynamicList=__exports.DynamicList=class DynamicList extends DataPoint{setup(){super.setup(...arguments);this.handleField=Object.keys(this.activeFields).find((fieldName)=>this.activeFields[fieldName].isHandle);if(!this.handleField&&DEFAULT_HANDLE_FIELD in this.fields){this.handleField=DEFAULT_HANDLE_FIELD;}
this.isDomainSelected=false;this.evalContext=this.context;}
get groupBy(){return[];}
get orderBy(){return this.config.orderBy;}
get domain(){return this.config.domain;}
get editedRecord(){return this.records.find((record)=>record.isInEdition);}
get isRecordCountTrustable(){return true;}
get limit(){return this.config.limit;}
get offset(){return this.config.offset;}
get selection(){return this.records.filter((record)=>record.selected);}
archive(isSelected){return this.model.mutex.exec(()=>this._toggleArchive(isSelected,true));}
canResequence(){return!!this.handleField;}
deleteRecords(records=[]){return this.model.mutex.exec(()=>this._deleteRecords(records));}
duplicateRecords(records=[]){return this.model.mutex.exec(()=>this._duplicateRecords(records));}
async enterEditMode(record){if(this.editedRecord===record){return true;}
const canProceed=await this.leaveEditMode();if(canProceed){record._checkValidity();this.model._updateConfig(record.config,{mode:"edit"},{reload:false});}
return canProceed;}
async getResIds(isSelected){let resIds;if(isSelected){if(this.isDomainSelected){resIds=await this.model.orm.search(this.resModel,this.domain,{limit:this.model.activeIdsLimit,context:this.context,});}else{resIds=this.selection.map((r)=>r.resId);}}else{resIds=this.records.map((r)=>r.resId);}
return unique(resIds);}
async leaveEditMode({discard}={}){let editedRecord=this.editedRecord;if(editedRecord){let canProceed=true;if(discard){this._recordToDiscard=editedRecord;await editedRecord.discard();this._recordToDiscard=null;editedRecord=this.editedRecord;if(editedRecord&&editedRecord.isNew){this._removeRecords([editedRecord.id]);}}else{let isValid=true;if(!this.model._urgentSave){isValid=await editedRecord.checkValidity();editedRecord=this.editedRecord;if(!editedRecord){return true;}}
if(editedRecord.isNew&&!editedRecord.dirty){this._removeRecords([editedRecord.id]);}else if(isValid||editedRecord.dirty){canProceed=await editedRecord.save();}}
editedRecord=this.editedRecord;if(canProceed&&editedRecord){this.model._updateConfig(editedRecord.config,{mode:"readonly"},{reload:false});}else{return canProceed;}}
return true;}
load(params={}){const limit=params.limit===undefined?this.limit:params.limit;const offset=params.offset===undefined?this.offset:params.offset;const orderBy=params.orderBy===undefined?this.orderBy:params.orderBy;const domain=params.domain===undefined?this.domain:params.domain;return this.model.mutex.exec(()=>this._load(offset,limit,orderBy,domain));}
async multiSave(record,changes){return this.model.mutex.exec(()=>this._multiSave(record,changes));}
selectDomain(value){return this.model.mutex.exec(()=>this._selectDomain(value));}
sortBy(fieldName){return this.model.mutex.exec(()=>{let orderBy=[...this.orderBy];if(orderBy.length&&orderBy[0].name===fieldName){if(orderBy[0].asc){orderBy[0]={name:orderBy[0].name,asc:false};}else{orderBy=[];}}else{orderBy=orderBy.filter((o)=>o.name!==fieldName);orderBy.unshift({name:fieldName,asc:true,});}
return this._load(this.offset,this.limit,orderBy,this.domain);});}
toggleSelection(){return this.model.mutex.exec(()=>this._toggleSelection());}
unarchive(isSelected){return this.model.mutex.exec(()=>this._toggleArchive(isSelected,false));}
toggleArchiveWithConfirmation(archive,dialogProps={}){const isSelected=this.isDomainSelected||this.selection.length>0;if(archive){const defaultProps={body:_t("Are you sure that you want to archive all the selected records?"),cancel:()=>{},confirm:()=>this.archive(isSelected),confirmLabel:_t("Archive"),};this.model.dialog.add(ConfirmationDialog,{...defaultProps,...dialogProps});}else{this.unarchive(isSelected);}}
async _duplicateRecords(records){let resIds;if(records.length){resIds=unique(records.map((r)=>r.resId));}else{resIds=await this.getResIds(true);}
const copy=async(resIds)=>{const copiedRecords=await this.model.orm.call(this.resModel,"copy",[resIds],{context:this.context,});if(resIds.length>copiedRecords.length){this.model.notification.add(_t("Some records could not be duplicated"));}
return this.model.load();};if(resIds.length>1){this.model.dialog.add(ConfirmationDialog,{body:_t("Are you sure that you want to duplicate all the selected records?"),confirm:()=>copy(resIds),cancel:()=>{},confirmLabel:_t("Confirm"),});}else{await copy(resIds);}}
async _deleteRecords(records){let resIds;if(records.length){resIds=unique(records.map((r)=>r.resId));}else{resIds=await this.getResIds(true);records=this.records.filter((r)=>resIds.includes(r.resId));}
const unlinked=await this.model.orm.unlink(this.resModel,resIds,{context:this.context,});if(!unlinked){return false;}
if(this.isDomainSelected&&resIds.length===this.model.activeIdsLimit&&resIds.length<this.count){const msg=_t("Only the first %(count)s records have been deleted (out of %(total)s selected)",{count:resIds.length,total:this.count});this.model.notification.add(msg);}
await this.model.load();return unlinked;}
async _leaveSampleMode(){if(this.model.useSampleModel){await this._load(this.offset,this.limit,this.orderBy,this.domain);this.model.useSampleModel=false;}}
async _multiSave(editedRecord,changes){if(!Object.keys(changes).length||editedRecord===this._recordToDiscard){return;}
let canProceed=await this.model.hooks.onWillSaveMulti(editedRecord,changes);if(canProceed===false){return false;}
const selectedRecords=this.selection;const proms=[];for(const fieldName in changes){if(["one2many","many2many"].includes(this.fields[fieldName].type)){const list=editedRecord.data[fieldName];const commands=list._getCommands();if("display_name"in list.activeFields){for(const command of commands){if(command[0]===x2ManyCommands.LINK){const relRecord=list._cache[command[1]];command[2]={display_name:relRecord.data.display_name};}}}
for(const record of selectedRecords){if(record!==editedRecord){proms.push(record.data[fieldName]._applyCommands(commands));}}}}
await Promise.all(proms);selectedRecords.forEach((record)=>{const _changes=Object.assign({},changes);for(const fieldName in _changes){if(["one2many","many2many"].includes(this.fields[fieldName].type)){_changes[fieldName]=record.data[fieldName];}}
record._applyChanges(_changes);});const validRecords=[];const invalidRecords=[];for(const record of selectedRecords){const isEditedRecord=record===editedRecord;if(Object.keys(changes).every((fieldName)=>!record._isReadonly(fieldName))&&record._checkValidity({silent:!isEditedRecord})){validRecords.push(record);}else{invalidRecords.push(record);}}
const discardInvalidRecords=()=>invalidRecords.forEach((record)=>record._discard());if(validRecords.length===0){editedRecord._displayInvalidFieldNotification();discardInvalidRecords();return false;}
const resIds=unique(validRecords.map((r)=>r.resId));const kwargs={context:this.context,specification:getFieldsSpec(editedRecord.activeFields,editedRecord.fields),};let save;if(Object.values(changes).some((v)=>v instanceof Operation)){const changesById={};for(const record of validRecords){changesById[record.resId]=changesById[record.resId]||record._getChanges();}
const valsList=resIds.map((resId)=>changesById[resId]);save=()=>this.model.orm.webSaveMulti(this.resModel,resIds,valsList,kwargs);}else{const vals=editedRecord._getChanges();save=()=>this.model.orm.webSave(this.resModel,resIds,vals,kwargs);}
const _changes=Object.assign(changes);for(const fieldName in changes){if(this.fields[fieldName].type==="many2many"){const list=changes[fieldName];_changes[fieldName]={add:list._commands.filter((command)=>command[0]===x2ManyCommands.LINK).map((command)=>list._cache[command[1]]),remove:list._commands.filter((command)=>command[0]===x2ManyCommands.UNLINK).map((command)=>list._cache[command[1]]),};}}
discardInvalidRecords();canProceed=await this.model.hooks.onAskMultiSaveConfirmation(_changes,validRecords);if(canProceed===false){selectedRecords.forEach((record)=>record._discard());this.leaveEditMode({discard:true});return false;}
let records=[];try{records=await save();}catch(e){selectedRecords.forEach((record)=>record._discard());this.model._updateConfig(editedRecord.config,{mode:"readonly"},{reload:false});throw e;}
const serverValuesById=Object.fromEntries(records.map((record)=>[record.id,record]));for(const record of validRecords){const serverValues=serverValuesById[record.resId];record._setData(serverValues);this.model._updateSimilarRecords(record,serverValues);}
this.model._updateConfig(editedRecord.config,{mode:"readonly"},{reload:false});this.model.hooks.onSavedMulti(validRecords);return true;}
async _resequence(originalList,resModel,movedId,targetId){if(this.resModel===resModel&&!this.canResequence()){return;}
const handleField=this.resModel===resModel?this.handleField:DEFAULT_HANDLE_FIELD;const order=this.orderBy.find((o)=>o.name===handleField);const getSequence=(dp)=>dp&&this._getDPFieldValue(dp,handleField);const getResId=(dp)=>this._getDPresId(dp);const resequencedRecords=await resequence({records:originalList,resModel,movedId,targetId,fieldName:handleField,asc:order?.asc,context:this.context,orm:this.model.orm,getSequence,getResId,});for(const dpData of resequencedRecords){const dp=originalList.find((d)=>getResId(d)===dpData.id);if(dp instanceof RelationalRecord){dp._applyValues(dpData);}else{dp[handleField]=dpData[handleField];}}}
_selectDomain(value){this.isDomainSelected=value;}
async _toggleArchive(isSelected,state){const method=state?"action_archive":"action_unarchive";const context=this.context;const resIds=await this.getResIds(isSelected);const action=await this.model.orm.call(this.resModel,method,[resIds],{context});if(this.isDomainSelected&&resIds.length===this.model.activeIdsLimit&&resIds.length<this.count){const msg=_t("Of the %(selectedRecord)s selected records, only the first %(firstRecords)s have been archived/unarchived.",{selectedRecords:resIds.length,firstRecords:this.count,});this.model.notification.add(msg);}
const reload=()=>this.model.load();if(action&&Object.keys(action).length){this.model.action.doAction(action,{onClose:reload,});}else{return reload();}}
async _toggleSelection(){if(this.selection.length===this.records.length){this.records.forEach((record)=>{record._toggleSelection(false);});this._selectDomain(false);}else{this.records.forEach((record)=>{record._toggleSelection(true);});}}}
return __exports;});;

/* /web/static/src/model/relational_model/dynamic_record_list.js */
odoo.define('@web/model/relational_model/dynamic_record_list',['@web/model/relational_model/dynamic_list'],function(require){'use strict';let __exports={};const{DynamicList}=require("@web/model/relational_model/dynamic_list");const DynamicRecordList=__exports.DynamicRecordList=class DynamicRecordList extends DynamicList{static type="DynamicRecordList";setup(config,data){super.setup(config);this._setData(data);}
_setData(data){this.records=data.records.map((r)=>this._createRecordDatapoint(r));this._updateCount(data);this._selectDomain(this.isDomainSelected);}
get hasData(){return this.count>0;}
addExistingRecord(resId,atFirstPosition){return this.model.mutex.exec(async()=>{const record=this._createRecordDatapoint({});await record._load({resId});this._addRecord(record,atFirstPosition?0:this.records.length);return record;});}
addNewRecord(atFirstPosition=false){return this.model.mutex.exec(async()=>{await this._leaveSampleMode();return this._addNewRecord(atFirstPosition);});}
async fetchCount(){this.count=await this.model._updateCount(this.config);this.hasLimitedCount=false;return this.count;}
moveRecord(dataRecordId,_dataGroupId,refId,_targetGroupId){return this.resequence(dataRecordId,refId);}
removeRecord(record){if(!record.isNew){throw new Error("removeRecord can't be called on an existing record");}
const index=this.records.findIndex((r)=>r===record);if(index<0){return;}
this.records.splice(index,1);this.count--;return record;}
async resequence(movedRecordId,targetRecordId){return this.model.mutex.exec(async()=>await this._resequence(this.records,this.resModel,movedRecordId,targetRecordId));}
async _addNewRecord(atFirstPosition){const values=await this.model._loadNewRecord({resModel:this.resModel,activeFields:this.activeFields,fields:this.fields,context:this.context,});const record=this._createRecordDatapoint(values,"edit");this._addRecord(record,atFirstPosition?0:this.records.length);return record;}
_addRecord(record,index){this.records.splice(Number.isInteger(index)?index:this.records.length,0,record);this.count++;}
_createRecordDatapoint(data,mode="readonly"){return new this.model.constructor.Record(this.model,{context:this.context,activeFields:this.activeFields,resModel:this.resModel,fields:this.fields,resId:data.id||false,resIds:data.id?[data.id]:[],isMonoRecord:true,mode,},data,{manuallyAdded:!data.id});}
_getDPresId(record){return record.resId;}
_getDPFieldValue(record,handleField){return record.data[handleField];}
async _load(offset,limit,orderBy,domain){await this.model._updateConfig(this.config,{offset,limit,orderBy,domain},{commit:this._setData.bind(this)});}
_removeRecords(recordIds){const keptRecords=this.records.filter((r)=>!recordIds.includes(r.id));this.count-=this.records.length-keptRecords.length;this.records=keptRecords;if(this.offset&&!this.records.length){const offset=Math.max(this.offset-this.limit,0);this.model._updateConfig(this.config,{offset},{reload:false});}}
_selectDomain(value){if(value){this.records.forEach((r)=>(r.selected=true));}
super._selectDomain(value);}
_updateCount(data){const length=data.length;if(length>=this.config.countLimit+1){this.hasLimitedCount=true;this.count=this.config.countLimit;}else{this.hasLimitedCount=false;this.count=length;}}}
return __exports;});;

/* /web/static/src/model/relational_model/errors.js */
odoo.define('@web/model/relational_model/errors',['@web/core/registry','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{registry}=require("@web/core/registry");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web",...args);const FetchRecordError=__exports.FetchRecordError=class FetchRecordError extends Error{constructor(resIds){super(_t("It seems the records with IDs %s cannot be found. They might have been deleted.",resIds));this.resIds=resIds;}}
function fetchRecordErrorHandler(env,error,originalError){if(originalError instanceof FetchRecordError){env.services.notification.add(originalError.message,{sticky:true,type:"danger"});return true;}}
const errorHandlerRegistry=registry.category("error_handlers");errorHandlerRegistry.add("fetchRecordErrorHandler",fetchRecordErrorHandler);return __exports;});;

/* /web/static/src/model/relational_model/group.js */
odoo.define('@web/model/relational_model/group',['@web/core/domain','@web/model/relational_model/datapoint'],function(require){'use strict';let __exports={};const{Domain}=require("@web/core/domain");const{DataPoint}=require("@web/model/relational_model/datapoint");const Group=__exports.Group=class Group extends DataPoint{static type="Group";setup(config,data){super.setup(...arguments);this.groupByField=this.fields[config.groupByFieldName];this.range=data.range;this._rawValue=data.rawValue;this.count=data.count;this.value=data.value;this.serverValue=data.serverValue;this.displayName=data.displayName;this.aggregates=data.aggregates;let List;if(config.list.groupBy.length){List=this.model.constructor.DynamicGroupList;}else{List=this.model.constructor.DynamicRecordList;}
this.list=new List(this.model,config.list,data);this._useGroupCountForList();if(config.record){config.record.context={...config.record.context,...config.context};this.record=new this.model.constructor.Record(this.model,config.record,data.values);}}
get groupDomain(){return this.config.initialDomain;}
get hasData(){return this.count>0;}
get isFolded(){return this.config.isFolded;}
get records(){return this.list.records;}
async addExistingRecord(resId,atFirstPosition=false){const record=await this.list.addExistingRecord(resId,atFirstPosition);this.count++;return record;}
async addNewRecord(_unused,atFirstPosition=false){const canProceed=await this.model.root.leaveEditMode();if(canProceed){const record=await this.list.addNewRecord(atFirstPosition);if(record){this.count++;}}}
async applyFilter(filter){if(filter){await this.list.load({domain:Domain.and([this.groupDomain,filter]).toList(),});}else{await this.list.load({domain:this.groupDomain});this.count=this.list.isGrouped?this.list.recordCount:this.list.count;}
this.model._updateConfig(this.config,{extraDomain:filter},{reload:false});}
deleteRecords(records){return this.model.mutex.exec(()=>this._deleteRecords(records));}
async toggle(){if(this.config.isFolded){await this.list.load();}
this._useGroupCountForList();this.model._updateConfig(this.config,{isFolded:!this.config.isFolded},{reload:false});}
_addRecord(record,index){this.list._addRecord(record,index);this.count++;}
async _deleteRecords(records){await this.list._deleteRecords(records);this.count-=records.length;}
_useGroupCountForList(){if(!this.list.isGrouped&&this.list.count===this.list.config.countLimit){this.list.count=this.count;}}
async _removeRecords(recordIds){const idsToRemove=recordIds.filter((id)=>this.list.records.some((r)=>r.id===id));this.list._removeRecords(idsToRemove);this.count-=idsToRemove.length;}}
return __exports;});;

/* /web/static/src/model/relational_model/operation.js */
odoo.define('@web/model/relational_model/operation',[],function(require){'use strict';let __exports={};const Operation=__exports.Operation=class Operation{constructor(operator,operand){this.operator=operator;this.operand=operand;}
compute(value){switch(this.operator){case"+":return value+this.operand;case"-":return value-this.operand;case"*":return value*this.operand;case"/":return value/this.operand;default:throw new Error(`Unsupported operator: ${this.operator}`);}}}
return __exports;});;

/* /web/static/src/model/relational_model/record.js */
odoo.define('@web/model/relational_model/record',['@odoo/owl','@web/core/l10n/dates','@web/core/l10n/translation','@web/core/orm_service','@web/core/py_js/py','@web/model/relational_model/datapoint','@web/model/relational_model/operation','@web/model/relational_model/errors','@web/model/relational_model/utils'],function(require){'use strict';let __exports={};const{markRaw,markup,toRaw}=require("@odoo/owl");const{serializeDate,serializeDateTime}=require("@web/core/l10n/dates");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web",...args);const{x2ManyCommands}=require("@web/core/orm_service");const{evaluateBooleanExpr}=require("@web/core/py_js/py");const{DataPoint}=require("@web/model/relational_model/datapoint");const{Operation}=require("@web/model/relational_model/operation");const{FetchRecordError}=require("@web/model/relational_model/errors");const{createPropertyActiveField,getBasicEvalContext,getFieldContext,getFieldsSpec,parseServerValue,}=require("@web/model/relational_model/utils");const Record=__exports.Record=class Record extends DataPoint{static type="Record";setup(_config,data,options={}){this._manuallyAdded=options.manuallyAdded===true;this._onUpdate=options.onUpdate||(()=>{});this._parentRecord=options.parentRecord;this.canSaveOnUpdate=!options.parentRecord;this._virtualId=options.virtualId||false;this._isEvalContextReady=false;this.dirty=false;this.selected=false;this._invalidFields=new Set();this._unsetRequiredFields=markRaw(new Set());this._closeInvalidFieldsNotification=()=>{};const parentRecord=this._parentRecord;if(parentRecord){this.evalContext={get parent(){return parentRecord.evalContext;},};this.evalContextWithVirtualIds={get parent(){return parentRecord.evalContextWithVirtualIds;},};}else{this.evalContext={};this.evalContextWithVirtualIds={};}
const missingFields=this.fieldNames.filter((fieldName)=>!(fieldName in data));data={...this._getDefaultValues(missingFields),...data};this._textValues=markRaw({});this._setData(data);}
_setData(data,{orderBys,keepChanges}={}){this._isEvalContextReady=false;if(this.resId){this._values=this._parseServerValues(data,{orderBys});Object.assign(this._textValues,this._getTextValues(data));}else{const allVals={...this._getDefaultValues(),...data};this._values=markRaw(this._parseServerValues(allVals,{orderBys}));Object.assign(this._textValues,this._getTextValues(allVals));}
if(!keepChanges){this._changes=markRaw({});}
this.dirty=false;this.data={...this._values,...this._changes};this._setEvalContext();this._initialTextValues={...this._textValues};this._invalidFields.clear();if(!this.isNew&&this.isInEdition&&!this._parentRecord){this._checkValidity();}
this._savePoint=undefined;}
get canBeAbandoned(){return this.isNew&&!this.dirty&&this._manuallyAdded;}
get hasData(){return true;}
get isActive(){if("active"in this.activeFields){return this.data.active;}else if("x_active"in this.activeFields){return this.data.x_active;}
return true;}
get isInEdition(){if(this.config.mode==="readonly"){return false;}else{return this.config.mode==="edit"||!this.resId;}}
get isNew(){return!this.resId;}
get isValid(){return!this._invalidFields.size;}
get resId(){return this.config.resId;}
get resIds(){return this.config.resIds;}
archive(){return this.model.mutex.exec(()=>this._toggleArchive(true));}
async checkValidity({displayNotification}={}){if(!this._urgentSave){await this.model._askChanges();}
return this._checkValidity({displayNotification});}
delete(){return this.model.mutex.exec(async()=>{const unlinked=await this.model.orm.unlink(this.resModel,[this.resId],{context:this.context,});if(!unlinked){return false;}
const resIds=this.resIds.slice();const index=resIds.indexOf(this.resId);resIds.splice(index,1);const resId=resIds[Math.min(index,resIds.length-1)]||false;if(resId){await this.model.load({resId,resIds});}else{this.model._updateConfig(this.config,{resId:false},{reload:false});this.dirty=false;this._changes=markRaw({});this._values=markRaw(this._parseServerValues(this._getDefaultValues()));this._textValues=markRaw({});this.data={...this._values};this._setEvalContext();}});}
async discard(){if(this.model._closeUrgentSaveNotification){this.model._closeUrgentSaveNotification();}
await this.model._askChanges();return this.model.mutex.exec(()=>this._discard());}
duplicate(){return this.model.mutex.exec(async()=>{const kwargs={context:this.context};const index=this.resIds.indexOf(this.resId);const[resId]=await this.model.orm.call(this.resModel,"copy",[[this.resId]],kwargs);const resIds=this.resIds.slice();resIds.splice(index+1,0,resId);await this.model.load({resId,resIds,mode:"edit"});});}
async getChanges({withReadonly}={}){await this.model._askChanges();return this.model.mutex.exec(()=>this._getChanges(this._changes,{withReadonly}));}
async isDirty(){await this.model._askChanges();return this.dirty;}
isFieldInvalid(fieldName){return this._invalidFields.has(fieldName);}
load(){if(arguments.length>0){throw new Error("Record.load() does not accept arguments");}
return this.model.mutex.exec(()=>this._load());}
async save(options){await this.model._askChanges();return this.model.mutex.exec(()=>this._save(options));}
async setInvalidField(fieldName){this.dirty=true;return this._setInvalidField(fieldName);}
async resetFieldValidity(fieldName){this.dirty=true;return this._resetFieldValidity(fieldName);}
switchMode(mode){return this.model.mutex.exec(()=>this._switchMode(mode));}
toggleSelection(selected){return this.model.mutex.exec(()=>{this._toggleSelection(selected);});}
unarchive(){return this.model.mutex.exec(()=>this._toggleArchive(false));}
update(changes,{save}={}){if(this.model._urgentSave){return this._update(changes);}
return this.model.mutex.exec(async()=>{await this._update(changes,{withoutOnchange:save});if(save&&this.canSaveOnUpdate){return this._save();}});}
async urgentSave(){this.model._urgentSave=true;this.model.bus.trigger("WILL_SAVE_URGENTLY");const succeeded=await this._save({reload:false});this.model._urgentSave=false;return succeeded;}
_addSavePoint(){this._savePoint=markRaw({dirty:this.dirty,textValues:{...this._textValues},changes:{...this._changes},});for(const fieldName in this._changes){if(["one2many","many2many"].includes(this.fields[fieldName].type)){this._changes[fieldName]._addSavePoint();}}}
_applyChanges(changes,serverChanges={}){const initialTextValues={...this._textValues};const initialChanges={...this._changes};const initialData={...toRaw(this.data)};const invalidFields=[...toRaw(this._invalidFields)];const undoChanges=()=>{for(const fieldName of invalidFields){this.setInvalidField(fieldName);}
Object.assign(this.data,initialData);this._changes=markRaw(initialChanges);Object.assign(this._textValues,initialTextValues);this._setEvalContext();};for(const fieldName in changes){let change=changes[fieldName];if(change instanceof Operation){change=change.compute(this.data[fieldName]);}
this._changes[fieldName]=change;this.data[fieldName]=change;if(this.fields[fieldName].type==="html"){this._textValues[fieldName]=change===false?false:change.toString();}else if(["char","text"].includes(this.fields[fieldName].type)){this._textValues[fieldName]=change;}}
const parsedChanges=this._parseServerValues(serverChanges,{currentValues:this.data});for(const fieldName in parsedChanges){this._changes[fieldName]=parsedChanges[fieldName];this.data[fieldName]=parsedChanges[fieldName];}
Object.assign(this._textValues,this._getTextValues(serverChanges));this._setEvalContext();this._removeInvalidFields(...Object.keys(changes),...Object.keys(serverChanges));this._checkValidity({removeInvalidOnly:true});return undoChanges;}
_applyDefaultValues(){const fieldNames=this.fieldNames.filter((fieldName)=>!(fieldName in this.data));const defaultValues=this._getDefaultValues(fieldNames);if(this.isNew){this._applyChanges({},defaultValues);}else{this._applyValues(defaultValues);}}
_applyValues(values){const newValues=this._parseServerValues(values);Object.assign(this._values,newValues);for(const fieldName in newValues){if(fieldName in this._changes){if(["one2many","many2many"].includes(this.fields[fieldName].type)){this._changes[fieldName]=newValues[fieldName];}}}
Object.assign(this.data,this._values,this._changes);const textValues=this._getTextValues(values);Object.assign(this._initialTextValues,textValues);Object.assign(this._textValues,textValues,this._getTextValues(this._changes));this._setEvalContext();}
_checkValidity({silent,displayNotification,removeInvalidOnly}={}){const unsetRequiredFields=new Set();for(const fieldName in this.activeFields){const fieldType=this.fields[fieldName].type;if(this._isInvisible(fieldName)||this.fields[fieldName].relatedPropertyField){continue;}
switch(fieldType){case"boolean":case"float":case"integer":case"monetary":continue;case"html":if(this._isRequired(fieldName)&&this.data[fieldName].length===0){unsetRequiredFields.add(fieldName);}
break;case"one2many":case"many2many":{const list=this.data[fieldName];if((this._isRequired(fieldName)&&!list.count)||!list.records.every((r)=>!r.dirty||r._checkValidity({silent,removeInvalidOnly}))){unsetRequiredFields.add(fieldName);}
break;}
case"properties":{const value=this.data[fieldName];if(value){const ok=value.every((propertyDefinition)=>propertyDefinition.name&&propertyDefinition.name.length&&propertyDefinition.string&&propertyDefinition.string.length);if(!ok){unsetRequiredFields.add(fieldName);}}
break;}
case"json":{if(this._isRequired(fieldName)&&(!this.data[fieldName]||!Object.keys(this.data[fieldName]).length)){unsetRequiredFields.add(fieldName);}
break;}
default:if(!this.data[fieldName]&&this._isRequired(fieldName)){unsetRequiredFields.add(fieldName);}}}
if(silent){return!unsetRequiredFields.size;}
if(removeInvalidOnly){for(const fieldName of Array.from(this._unsetRequiredFields)){if(!unsetRequiredFields.has(fieldName)){this._unsetRequiredFields.delete(fieldName);this._invalidFields.delete(fieldName);}}}else{for(const fieldName of Array.from(this._unsetRequiredFields)){this._invalidFields.delete(fieldName);}
this._unsetRequiredFields.clear();for(const fieldName of unsetRequiredFields){this._unsetRequiredFields.add(fieldName);this._invalidFields.add(fieldName);}}
const isValid=!this._invalidFields.size;if(!isValid&&displayNotification){this._closeInvalidFieldsNotification=this._displayInvalidFieldNotification();}
return isValid;}
async _completeMany2OneValue(value,fieldName,resModel){const resId=value.id;const displayName=value.display_name;if(!resId&&!displayName){return false;}
const context=getFieldContext(this,fieldName);if(!resId&&displayName!==undefined){const pair=await this.model.orm.call(resModel,"name_create",[displayName],{context,});return pair&&{id:pair[0],display_name:pair[1]};}
if(resId&&displayName===undefined){const fieldSpec={display_name:{}};if(this.activeFields[fieldName].related){Object.assign(fieldSpec,getFieldsSpec(this.activeFields[fieldName].related.activeFields,this.activeFields[fieldName].related.fields,getBasicEvalContext(this.config)));}
const kwargs={context,specification:fieldSpec,};const records=await this.model.orm.webRead(resModel,[resId],kwargs);return records[0];}
return value;}
_computeDataContext(){const dataContext={};const x2manyDataContext={withVirtualIds:{},withoutVirtualIds:{},};const data=toRaw(this.data);for(const fieldName in data){const value=data[fieldName];const field=this.fields[fieldName];if(field.relatedPropertyField){continue;}
if(["char","text","html"].includes(field.type)){dataContext[fieldName]=this._textValues[fieldName];}else if(field.type==="one2many"||field.type==="many2many"){x2manyDataContext.withVirtualIds[fieldName]=value.currentIds;x2manyDataContext.withoutVirtualIds[fieldName]=value.currentIds.filter((id)=>typeof id==="number");}else if(value&&field.type==="date"){dataContext[fieldName]=serializeDate(value);}else if(value&&field.type==="datetime"){dataContext[fieldName]=serializeDateTime(value);}else if(value&&field.type==="many2one"){dataContext[fieldName]=value.id;}else if(value&&field.type==="reference"){dataContext[fieldName]=`${value.resModel},${value.resId}`;}else if(field.type==="properties"){dataContext[fieldName]=value.filter((property)=>!property.definition_deleted!==false);}else{dataContext[fieldName]=value;}}
dataContext.id=this.resId||false;return{withVirtualIds:{...dataContext,...x2manyDataContext.withVirtualIds},withoutVirtualIds:{...dataContext,...x2manyDataContext.withoutVirtualIds},};}
_createStaticListDatapoint(data,fieldName,{orderBys}={}){const{related,limit,defaultOrderBy}=this.activeFields[fieldName];const relatedActiveFields=(related&&related.activeFields)||{};const config={resModel:this.fields[fieldName].relation,activeFields:relatedActiveFields,fields:(related&&related.fields)||{},relationField:this.fields[fieldName].relation_field||false,offset:0,resIds:data.map((r)=>r.id),orderBy:orderBys?.[fieldName]||defaultOrderBy||[],limit:limit||(Object.keys(relatedActiveFields).length?Number.MAX_SAFE_INTEGER:1),context:{},};const options={onUpdate:({withoutOnchange}={})=>this._update({[fieldName]:[]},{withoutOnchange}),parent:this,};return new this.model.constructor.StaticList(this.model,config,data,options);}
_discard(){for(const fieldName in this._changes){if(["one2many","many2many"].includes(this.fields[fieldName].type)){this._changes[fieldName]._discard();}}
if(this._savePoint){this.dirty=this._savePoint.dirty;this._changes=markRaw({...this._savePoint.changes});this._textValues=markRaw({...this._savePoint.textValues});}else{this.dirty=false;this._changes=markRaw({});this._textValues=markRaw({...this._initialTextValues});}
this.data={...this._values,...this._changes};this._savePoint=undefined;this._setEvalContext();this._invalidFields.clear();if(!this.isNew){this._checkValidity();}
this._closeInvalidFieldsNotification();this._closeInvalidFieldsNotification=()=>{};this._restoreActiveFields();}
_displayInvalidFieldNotification(){return this.model.notification.add(_t("Missing required fields"),{type:"danger"});}
_formatServerValue(fieldType,value){if(fieldType==="date"){return value?serializeDate(value):false;}else if(fieldType==="datetime"){return value?serializeDateTime(value):false;}else if(fieldType==="char"||fieldType==="text"){return value!==""?value:false;}else if(fieldType==="html"){return value&&value.length?value:false;}else if(fieldType==="many2one"){return value?value.id:false;}else if(fieldType==="many2one_reference"){return value?value.resId:0;}else if(fieldType==="reference"){return value&&value.resModel&&value.resId?`${value.resModel},${value.resId}`:false;}else if(fieldType==="properties"){return value.map((property)=>{property={...property};for(const key of["value","default"]){let value;if(property.type==="many2one"){value=property[key]&&[property[key].id,property[key].display_name];}else if((property.type==="date"||property.type==="datetime")&&typeof property[key]==="string"){value=property[key];}else if(property[key]!==undefined){value=this._formatServerValue(property.type,property[key]);}
property[key]=value;}
return property;});}
return value;}
_getChanges(changes=this._changes,{withReadonly}={}){if(!this.resId){changes={...this._values,...changes};}
const result={};for(const[fieldName,value]of Object.entries(changes)){const field=this.fields[fieldName];if(fieldName==="id"){continue;}
if(!withReadonly&&fieldName in this.activeFields&&this._isReadonly(fieldName)&&!this.activeFields[fieldName].forceSave){continue;}
if(field.relatedPropertyField){continue;}
if(field.type==="one2many"||field.type==="many2many"){const commands=value._getCommands({withReadonly});if(!this.isNew&&!commands.length&&!withReadonly){continue;}
result[fieldName]=commands;}else{result[fieldName]=this._formatServerValue(field.type,value);}}
return result;}
_getDefaultValues(fieldNames=this.fieldNames){const defaultValues={};for(const fieldName of fieldNames){switch(this.fields[fieldName].type){case"integer":case"float":case"monetary":defaultValues[fieldName]=fieldName==="id"?false:0;break;case"one2many":case"many2many":defaultValues[fieldName]=[];break;default:defaultValues[fieldName]=false;}}
return defaultValues;}
_getTextValues(values){const textValues={};for(const fieldName in values){if(!this.activeFields[fieldName]){continue;}
if(["char","text","html"].includes(this.fields[fieldName].type)){textValues[fieldName]=values[fieldName];}}
return textValues;}
_isInvisible(fieldName){const invisible=this.activeFields[fieldName].invisible;return invisible?evaluateBooleanExpr(invisible,this.evalContextWithVirtualIds):false;}
_isReadonly(fieldName){const readonly=this.activeFields[fieldName].readonly;return readonly?evaluateBooleanExpr(readonly,this.evalContextWithVirtualIds):false;}
_isRequired(fieldName){const required=this.activeFields[fieldName].required;return required?evaluateBooleanExpr(required,this.evalContextWithVirtualIds):false;}
async _load(nextConfig={}){if("resId"in nextConfig&&this.resId){throw new Error("Cannot change resId of a record");}
await this.model._updateConfig(this.config,nextConfig,{commit:(values)=>{if(this.resId){this.model._updateSimilarRecords(this,values);}
this._setData(values);},});}
_processProperties(properties,fieldName,parent,currentValues={}){const data={};const hasCurrentValues=Object.keys(currentValues).length>0;for(const property of properties){const propertyFieldName=`${fieldName}.${property.name}`;if(hasCurrentValues||!this.fields[propertyFieldName]){this.fields[propertyFieldName]={...property,name:propertyFieldName,relatedPropertyField:{name:fieldName,},propertyName:property.name,relation:property.comodel,sortable:!["many2one","many2many","tags"].includes(property.type),};}
if(hasCurrentValues||!this.activeFields[propertyFieldName]){this.activeFields[propertyFieldName]=createPropertyActiveField(property);}
if(!this.activeFields[propertyFieldName].relatedPropertyField){this.activeFields[propertyFieldName].relatedPropertyField={name:fieldName,id:parent?.id,displayName:parent?.display_name,};}
if(property.type==="many2many"){let staticList=currentValues[propertyFieldName];if(!staticList){staticList=this._createStaticListDatapoint((property.value||[]).map((record)=>({id:record[0],display_name:record[1],})),propertyFieldName);}
data[propertyFieldName]=staticList;}else if(property.type==="many2one"){data[propertyFieldName]=property.value&&property.value.display_name===null?{id:property.value.id,display_name:_t("No Access")}:property.value;}else{data[propertyFieldName]=property.value??false;}}
return data;}
_parseServerValues(serverValues,{currentValues,orderBys}={}){const parsedValues={};if(!serverValues){return parsedValues;}
for(const fieldName in serverValues){const value=serverValues[fieldName];if(!this.activeFields[fieldName]){continue;}
const field=this.fields[fieldName];if(field.type==="one2many"||field.type==="many2many"){let staticList=currentValues?.[fieldName];let valueIsCommandList=true;valueIsCommandList=value.length>0&&Array.isArray(value[0]);if(!staticList){let data=valueIsCommandList?[]:value;if(data.length>0&&typeof data[0]==="number"){data=data.map((resId)=>({id:resId}));}
staticList=this._createStaticListDatapoint(data,fieldName,{orderBys});if(valueIsCommandList){staticList._applyInitialCommands(value);}}else if(valueIsCommandList){staticList._applyCommands(value);}
parsedValues[fieldName]=staticList;}else{parsedValues[fieldName]=parseServerValue(field,value);if(field.type==="properties"){const parent=serverValues[field.definition_record];Object.assign(parsedValues,this._processProperties(parsedValues[fieldName],fieldName,parent,currentValues));}}}
return parsedValues;}
async _preprocessMany2oneChanges(changes){const proms=Object.entries(changes).filter(([fieldName])=>this.fields[fieldName].type==="many2one").map(async([fieldName,value])=>{if(!value){changes[fieldName]=false;}else if(!this.activeFields[fieldName]){changes[fieldName]=value;}else{const relation=this.fields[fieldName].relation;return this._completeMany2OneValue(value,fieldName,relation).then((v)=>{changes[fieldName]=v;});}});return Promise.all(proms);}
async _preprocessMany2OneReferenceChanges(changes){const proms=Object.entries(changes).filter(([fieldName])=>this.fields[fieldName].type==="many2one_reference").map(async([fieldName,value])=>{if(!value){changes[fieldName]=false;}else if(typeof value==="number"){changes[fieldName]={resId:value};}else{const relation=this.data[this.fields[fieldName].model_field];return this._completeMany2OneValue({id:value.resId,display_name:value.displayName},fieldName,relation).then((v)=>{changes[fieldName]={resId:v.id,displayName:v.display_name};});}});return Promise.all(proms);}
async _preprocessReferenceChanges(changes){const proms=Object.entries(changes).filter(([fieldName])=>this.fields[fieldName].type==="reference").map(async([fieldName,value])=>{if(!value){changes[fieldName]=false;}else{return this._completeMany2OneValue({id:value.resId,display_name:value.displayName},fieldName,value.resModel).then((v)=>{changes[fieldName]={resId:v.id,resModel:value.resModel,displayName:v.display_name,};});}});return Promise.all(proms);}
async _preprocessX2manyChanges(changes){for(const[fieldName,value]of Object.entries(changes)){if(this.fields[fieldName].type!=="one2many"&&this.fields[fieldName].type!=="many2many"){continue;}
const list=this.data[fieldName];for(const command of value){switch(command[0]){case x2ManyCommands.SET:await list._replaceWith(command[2]);break;default:await list._applyCommands([command]);}}
changes[fieldName]=list;}}
_preprocessPropertiesChanges(changes){for(const[fieldName,value]of Object.entries(changes)){const field=this.fields[fieldName];if(field.type==="properties"){const parent=changes[field.definition_record]||this.data[field.definition_record];Object.assign(changes,this._processProperties(value,fieldName,parent,this.data));}else if(field&&field.relatedPropertyField){const[propertyFieldName,propertyName]=field.name.split(".");const propertiesData=this.data[propertyFieldName]||[];if(!propertiesData.find((property)=>property.name===propertyName)){this.model.notification.add(_t("This record belongs to a different parent so you can not change this property."),{type:"warning"});return;}
changes[propertyFieldName]=propertiesData.map((property)=>property.name===propertyName?{...property,value}:property);}}}
_preprocessHtmlChanges(changes){for(const[fieldName,value]of Object.entries(changes)){if(this.fields[fieldName].type==="html"){changes[fieldName]=value===false?false:markup(value);}}}
_removeInvalidFields(...fieldNames){for(const fieldName of fieldNames){this._invalidFields.delete(fieldName);}}
_restoreActiveFields(){if(!this._activeFieldsToRestore){return;}
this.model._updateConfig(this.config,{activeFields:{...this._activeFieldsToRestore},},{reload:false});this._activeFieldsToRestore=undefined;}
async _save({reload=true,onError,nextId}={}){if(this.model._closeUrgentSaveNotification){this.model._closeUrgentSaveNotification();}
const creation=!this.resId;if(nextId){if(creation){throw new Error("Cannot set nextId on a new record");}
reload=true;}
for(const fieldName in this.activeFields){const field=this.fields[fieldName];if(["one2many","many2many"].includes(field.type)&&!field.relatedPropertyField){this.data[fieldName]._abandonRecords();}}
if(!this._checkValidity({displayNotification:true})){return false;}
const changes=this._getChanges();delete changes.id;if(!creation&&!Object.keys(changes).length){if(nextId){return this.model.load({resId:nextId});}
this._changes=markRaw({});this.data={...this._values};this.dirty=false;return true;}
if(this.model._urgentSave&&this.model.useSendBeaconToSaveUrgently&&!this.model.env.inDialog){const route=`/web/dataset/call_kw/${this.resModel}/web_save`;const params={model:this.resModel,method:"web_save",args:[this.resId?[this.resId]:[],changes],kwargs:{context:this.context,specification:{}},};const data={jsonrpc:"2.0",method:"call",params};const blob=new Blob([JSON.stringify(data)],{type:"application/json"});const succeeded=navigator.sendBeacon(route,blob);if(succeeded){this._changes=markRaw({});this.dirty=false;}else{this.model._closeUrgentSaveNotification=this.model.notification.add(_t(`Heads up! Your recent changes are too large to save automatically. Please click the %(upload_icon)s button now to ensure your work is saved before you exit this tab.`,{upload_icon:markup`<i class="fa fa-cloud-upload fa-fw"></i>`}),{sticky:true});}
return succeeded;}
const canProceed=await this.model.hooks.onWillSaveRecord(this,changes);if(canProceed===false){return false;}
const orderBys={};if(!nextId){for(const fieldName of this.fieldNames){if(["one2many","many2many"].includes(this.fields[fieldName].type)){orderBys[fieldName]=this.data[fieldName].orderBy;}}}
let fieldSpec={};if(reload){fieldSpec=getFieldsSpec(this.activeFields,this.fields,getBasicEvalContext(this.config),{orderBys});}
const kwargs={context:this.context,specification:fieldSpec,next_id:nextId,};let records=[];try{records=await this.model.orm.webSave(this.resModel,this.resId?[this.resId]:[],changes,kwargs);}catch(e){if(onError){return onError(e,{discard:()=>this._discard(),retry:()=>this._save(...arguments),});}
if(!this.isInEdition){await this._load({});}
throw e;}
if(reload&&!records.length){throw new FetchRecordError([nextId||this.resId]);}
if(creation){const resId=records[0].id;const resIds=this.resIds.concat([resId]);this.model._updateConfig(this.config,{resId,resIds},{reload:false});}
await this.model.hooks.onRecordSaved(this,changes);if(reload){if(this.resId){this.model._updateSimilarRecords(this,records[0]);}
if(nextId){this.model._updateConfig(this.config,{resId:nextId},{reload:false});}
if(this.config.isRoot){this.model.hooks.onWillLoadRoot(this.config);}
this._setData(records[0],{orderBys});}else{this._values=markRaw({...this._values,...this._changes});if("id"in this.activeFields){this._values.id=records[0].id;}
for(const fieldName in this.activeFields){const field=this.fields[fieldName];if(["one2many","many2many"].includes(field.type)&&!field.relatedPropertyField){this._changes[fieldName]?._clearCommands();}}
this._changes=markRaw({});this.data={...this._values};this.dirty=false;}
return true;}
_setEvalContext(){const evalContext=getBasicEvalContext(this.config);const dataContext=this._computeDataContext();Object.assign(this.evalContext,evalContext,dataContext.withoutVirtualIds);Object.assign(this.evalContextWithVirtualIds,evalContext,dataContext.withVirtualIds);this._isEvalContextReady=true;if(!this._parentRecord||this._parentRecord._isEvalContextReady){for(const[fieldName,value]of Object.entries(toRaw(this.data))){if(["one2many","many2many"].includes(this.fields[fieldName].type)){value._updateContext(getFieldContext(this,fieldName));}}}}
async _setInvalidField(fieldName){const canProceed=this.model.hooks.onWillSetInvalidField(this,fieldName);if(canProceed===false){return;}
if(toRaw(this._invalidFields).has(fieldName)){return;}
this._invalidFields.add(fieldName);if(this.selected&&this.model.multiEdit&&this.model.root._recordToDiscard!==this){this._displayInvalidFieldNotification();await this.discard();this.switchMode("readonly");}}
_resetFieldValidity(fieldName){this._invalidFields.delete(fieldName);}
_switchMode(mode){this.model._updateConfig(this.config,{mode},{reload:false});if(mode==="readonly"){this._noUpdateParent=false;this._invalidFields.clear();}}
async _toggleArchive(state){const method=state?"action_archive":"action_unarchive";const action=await this.model.orm.call(this.resModel,method,[[this.resId]],{context:this.context,});if(action&&Object.keys(action).length){this.model.action.doAction(action,{onClose:()=>this._load()});}else{return this._load();}}
_toggleSelection(selected){if(typeof selected==="boolean"){this.selected=selected;}else{this.selected=!this.selected;}
if(!this.selected&&this.model.root.isDomainSelected){this.model.root._selectDomain(false);}}
async _getOnchangeValues(changes){for(const fieldName in changes){if(changes[fieldName]instanceof Operation){changes[fieldName]=changes[fieldName].compute(this.data[fieldName]);}}
const onChangeFields=Object.keys(changes).filter((fieldName)=>this.activeFields[fieldName]&&this.activeFields[fieldName].onChange);if(!onChangeFields.length){return{};}
const localChanges=this._getChanges({...this._changes,...changes},{withReadonly:true});if(this.config.relationField){const parentRecord=this._parentRecord;localChanges[this.config.relationField]=parentRecord._getChanges(parentRecord._changes,{withReadonly:true});if(!this._parentRecord.isNew){localChanges[this.config.relationField].id=this._parentRecord.resId;}}
return this.model._onchange(this.config,{changes:localChanges,fieldNames:onChangeFields,evalContext:toRaw(this.evalContext),onError:(e)=>{const undoChanges=this._applyChanges(changes);undoChanges();throw e;},});}
async _update(changes,{withoutOnchange,withoutParentUpdate}={}){this.dirty=true;const prom=Promise.all([this._preprocessMany2oneChanges(changes),this._preprocessMany2OneReferenceChanges(changes),this._preprocessReferenceChanges(changes),this._preprocessX2manyChanges(changes),this._preprocessPropertiesChanges(changes),this._preprocessHtmlChanges(changes),]);if(!this.model._urgentSave){await prom;}
if(this.selected&&this.model.multiEdit){return this.model.root._multiSave(this,changes);}
let onchangeServerValues={};if(!this.model._urgentSave&&!withoutOnchange){onchangeServerValues=await this._getOnchangeValues(changes);}
for(const fieldName in changes){if(this.fields[fieldName].type==="many2one"){const curVal=toRaw(this.data[fieldName]);const nextVal=changes[fieldName];if(curVal&&nextVal&&curVal.id===nextVal.id&&curVal.display_name===nextVal.display_name){delete changes[fieldName];}}}
const undoChanges=this._applyChanges(changes,onchangeServerValues);if(Object.keys(changes).length>0||Object.keys(onchangeServerValues).length>0){try{await this._onUpdate({withoutParentUpdate});}catch(e){undoChanges();throw e;}
await this.model.hooks.onRecordChanged(this,this._getChanges());}}}
return __exports;});;

/* /web/static/src/model/relational_model/relational_model.js */
odoo.define('@web/model/relational_model/relational_model',['@odoo/owl','@web/core/context','@web/core/domain','@web/core/errors/error_dialogs','@web/core/network/rpc','@web/core/utils/arrays','@web/core/utils/objects','@web/core/utils/concurrency','@web/search/utils/order_by','@web/model/model','@web/model/relational_model/dynamic_group_list','@web/model/relational_model/dynamic_record_list','@web/model/relational_model/group','@web/model/relational_model/record','@web/model/relational_model/static_list','@web/model/relational_model/utils','@web/model/relational_model/errors'],function(require){'use strict';let __exports={};const{EventBus,markRaw,toRaw}=require("@odoo/owl");const{makeContext}=require("@web/core/context");const{Domain}=require("@web/core/domain");const{WarningDialog}=require("@web/core/errors/error_dialogs");const{rpcBus}=require("@web/core/network/rpc");const{shallowEqual}=require("@web/core/utils/arrays");const{deepCopy,pick}=require("@web/core/utils/objects");const{Deferred,KeepLast,Mutex}=require("@web/core/utils/concurrency");const{orderByToString}=require("@web/search/utils/order_by");const{Model}=require("@web/model/model");const{DynamicGroupList}=require("@web/model/relational_model/dynamic_group_list");const{DynamicRecordList}=require("@web/model/relational_model/dynamic_record_list");const{Group}=require("@web/model/relational_model/group");const{Record:RelationalRecord}=require("@web/model/relational_model/record");const{StaticList}=require("@web/model/relational_model/static_list");const{extractInfoFromGroupData,getAggregateSpecifications,getBasicEvalContext,getFieldsSpec,getGroupServerValue,getId,makeActiveField,}=require("@web/model/relational_model/utils");const{FetchRecordError}=require("@web/model/relational_model/errors");const DEFAULT_HOOKS={onWillLoadRoot:()=>{},onRootLoaded:()=>{},onWillSaveRecord:()=>{},onRecordSaved:()=>{},onWillSaveMulti:()=>{},onSavedMulti:()=>{},onWillSetInvalidField:()=>{},onRecordChanged:()=>{},onWillDisplayOnchangeWarning:()=>{},onAskMultiSaveConfirmation:()=>true,};rpcBus.addEventListener("RPC:RESPONSE",(ev)=>{if(ev.detail.data.params?.method==="unlink"){rpcBus.trigger("CLEAR-CACHES",["web_read","web_search_read","web_read_group"]);}});const RelationalModel=__exports.RelationalModel=class RelationalModel extends Model{static services=["action","dialog","notification","orm"];static Record=RelationalRecord;static Group=Group;static DynamicRecordList=DynamicRecordList;static DynamicGroupList=DynamicGroupList;static StaticList=StaticList;static DEFAULT_LIMIT=80;static DEFAULT_COUNT_LIMIT=10000;static DEFAULT_GROUP_LIMIT=80;static DEFAULT_OPEN_GROUP_LIMIT=10;static withCache=true;setup(params,{action,dialog,notification}){this.action=action;this.dialog=dialog;this.notification=notification;this.bus=new EventBus();this.keepLast=markRaw(new KeepLast());this.mutex=markRaw(new Mutex());this.config={isMonoRecord:false,context:{},fieldsToAggregate:Object.keys(params.config.activeFields),...params.config,isRoot:true,};this.hooks=Object.assign({},DEFAULT_HOOKS,params.hooks);this.initialLimit=params.limit||this.constructor.DEFAULT_LIMIT;this.initialGroupsLimit=params.groupsLimit;this.initialCountLimit=params.countLimit||this.constructor.DEFAULT_COUNT_LIMIT;this.defaultOrderBy=params.defaultOrderBy;this.maxGroupByDepth=params.maxGroupByDepth;this.groupByInfo=params.groupByInfo||{};this.multiEdit=params.multiEdit;this.activeIdsLimit=params.activeIdsLimit||Number.MAX_SAFE_INTEGER;this.specialDataCaches=markRaw(params.state?.specialDataCaches||{});this.useSendBeaconToSaveUrgently=params.useSendBeaconToSaveUrgently||false;this.withCache=this.constructor.withCache&&this.env.config?.cache;this.initialSampleGroups=undefined;this._urgentSave=false;}
exportState(){const config={...toRaw(this.config)};delete config.currentGroups;return{config,specialDataCaches:this.specialDataCaches,};}
hasData(){return this.root.hasData;}
async load(params={}){if(this.orm.isSample&&this.initialSampleGroups?.length){this.orm.setGroups(this.initialSampleGroups);}
const config=this._getNextConfig(this.config,params);if(!this.isReady){this.root=this._createEmptyRoot(config);this.config=config;}
this.hooks.onWillLoadRoot(config);const rootLoadDef=new Deferred();const cache=this._getCacheParams(config,rootLoadDef);const data=await this.keepLast.add(this._loadData(config,cache));this.root=this._createRoot(config,data);rootLoadDef.resolve({root:this.root,loadId:config.loadId});this.config=config;await this.hooks.onRootLoaded(this.root);}
async _getPropertyDefinition(config,propertyFullName){const result=await this.orm.call(config.resModel,"get_property_definition",[propertyFullName],{context:config.context});if(!result){config.groupBy=null;}else{result.propertyName=result.name;result.name=propertyFullName;result.relatedPropertyField={fieldName:propertyFullName.split(".")[0]};result.relation=result.comodel;config.fields[propertyFullName]=result;}}
async _askChanges(){const proms=[];this.bus.trigger("NEED_LOCAL_CHANGES",{proms});await Promise.all([...proms,this.mutex.getUnlockedDef()]);}
_createEmptyRoot(config){if(!config.isMonoRecord){if(config.groupBy.length){return this._createRoot(config,{groups:[],length:0});}
return this._createRoot(config,{records:[],length:0});}}
_createRoot(config,data){if(config.isMonoRecord){return new this.constructor.Record(this,config,data);}
if(config.groupBy.length){return new this.constructor.DynamicGroupList(this,config,data);}
return new this.constructor.DynamicRecordList(this,config,data);}
_getCacheParams(config,rootLoadDef){if(!this.withCache){return;}
if(!this.isReady||(config.isMonoRecord&&(this.root.config.resId!==config.resId||!config.resId))){return{type:"disk",update:"always",callback:async(result,hasChanged)=>{if(!hasChanged){return;}
const{root,loadId}=await rootLoadDef;if(root.id!==this.root.id){if(this.useSampleModel){this.useSampleModel=false;if(this.root.config.groupBy.length){delete this.root.config.currentGroups;result=await this._postprocessReadGroup(this.root.config,result);}
this.root._setData(result);}
return;}
if(loadId!==this.root.config.loadId){return;}
if(root.config.isMonoRecord){if(!root.config.resId){return root._setData(result.value,{keepChanges:true});}
if(!result.length){throw new FetchRecordError([root.config.resId]);}
return root._setData(result[0],{keepChanges:true});}
if(root.config.groupBy.length){delete this.root.config.currentGroups;result=await this._postprocessReadGroup(root.config,result);}
root._setData(result);},};}}
_getNextConfig(currentConfig,params){const currentGroupBy=currentConfig.groupBy;const config=Object.assign({},currentConfig);config.context="context"in params?params.context:config.context;config.context={...config.context};if(currentConfig.isMonoRecord){config.resId="resId"in params?params.resId:config.resId;config.resIds="resIds"in params?params.resIds:config.resIds;if(!config.resIds){config.resIds=config.resId?[config.resId]:[];}
if(!config.resId&&config.mode!=="edit"){config.mode="edit";}}else{config.domain="domain"in params?params.domain:config.domain;config.groupBy="groupBy"in params?params.groupBy:config.groupBy;if(this.maxGroupByDepth){config.groupBy=config.groupBy.slice(0,this.maxGroupByDepth);}
config.groupBy=config.groupBy.map((g)=>{if(g in config.fields&&["date","datetime"].includes(config.fields[g].type)){return`${g}:month`;}
return g;});config.orderBy="orderBy"in params?params.orderBy:config.orderBy;if(!config.orderBy.length){config.orderBy=currentConfig.orderBy||[];}
if(this.defaultOrderBy&&!config.orderBy.length){config.orderBy=this.defaultOrderBy;}
if(!shallowEqual(config.groupBy||[],currentGroupBy||[])){delete config.groups;}
if(!config.groupBy.length){config.orderBy=config.orderBy.filter((order)=>order.name!=="__count");}}
if(!config.isMonoRecord&&params.domain){const resetOffset=(config)=>{config.offset=0;for(const group of Object.values(config.groups||{})){resetOffset(group.list);}};if(this.root){resetOffset(config);}
if(!!config.groupBy.length!==!!currentGroupBy?.length){delete config.limit;}}
return config;}
async _loadData(config,cache){config.loadId=getId("load");if(config.isMonoRecord){const evalContext=getBasicEvalContext(config);if(!config.resId){return this._loadNewRecord(config,{evalContext,cache});}
const records=await this._loadRecords(config,evalContext,cache);return records[0];}
if(config.resIds){const resIds=config.resIds.slice(config.offset,config.offset+config.limit);return this._loadRecords({...config,resIds});}
if(config.groupBy.length){return this._loadGroupedList(config,cache);}
Object.assign(config,{limit:config.limit||this.initialLimit,countLimit:"countLimit"in config?config.countLimit:this.initialCountLimit,offset:config.offset||0,});if(config.countLimit!==Number.MAX_SAFE_INTEGER){config.countLimit=Math.max(config.countLimit,config.offset+config.limit);}
const{records,length}=await this._loadUngroupedList(config,cache);if(config.offset&&!records.length){config.offset=0;return this._loadData(config,cache);}
return{records,length};}
async _loadGroupedList(config,cache){config.offset=config.offset||0;config.limit=config.limit||this.initialGroupsLimit;if(!config.limit){config.limit=config.openGroupsByDefault?this.constructor.DEFAULT_OPEN_GROUP_LIMIT:this.constructor.DEFAULT_GROUP_LIMIT;}
config.groups=config.groups||{};const response=await this._webReadGroup(config,cache);return this._postprocessReadGroup(config,response);}
async _postprocessReadGroup(config,{groups,length}){const commonConfig={resModel:config.resModel,fields:config.fields,activeFields:config.activeFields,fieldsToAggregate:config.fieldsToAggregate,offset:0,};const extractGroups=async(currentConfig,groupsData)=>{const groupByFieldName=currentConfig.groupBy[0].split(":")[0];if(groupByFieldName.includes(".")){if(!config.fields[groupByFieldName]){await this._getPropertyDefinition(config,groupByFieldName);}
const propertiesFieldName=groupByFieldName.split(".")[0];if(!config.activeFields[propertiesFieldName]){config.activeFields[propertiesFieldName]=makeActiveField();}}
const nextLevelGroupBy=currentConfig.groupBy.slice(1);const groups=[];let groupRecordConfig;if(this.groupByInfo[groupByFieldName]){groupRecordConfig={...this.groupByInfo[groupByFieldName],resModel:currentConfig.fields[groupByFieldName].relation,context:{},};}
for(const groupData of groupsData){const group=extractInfoFromGroupData(groupData,currentConfig.groupBy,currentConfig.fields,currentConfig.domain);if(!currentConfig.groups[group.value]){currentConfig.groups[group.value]={...commonConfig,groupByFieldName,extraDomain:false,value:group.value,list:{...commonConfig,groupBy:nextLevelGroupBy,groups:{},limit:nextLevelGroupBy.length===0?this.initialLimit:this.initialGroupsLimit||this.constructor.DEFAULT_GROUP_LIMIT,},};}
const groupConfig=currentConfig.groups[group.value];groupConfig.list.orderBy=currentConfig.orderBy;groupConfig.initialDomain=group.domain;if(groupConfig.extraDomain){groupConfig.list.domain=Domain.and([group.domain,groupConfig.extraDomain,]).toList();}else{groupConfig.list.domain=group.domain;}
const context={...currentConfig.context,[`default_${groupByFieldName}`]:group.serverValue,};groupConfig.list.context=context;groupConfig.context=context;if(nextLevelGroupBy.length){groupConfig.isFolded=!("__groups"in groupData);if(!groupConfig.isFolded){const{groups,length}=groupData.__groups;group.groups=await extractGroups(groupConfig.list,groups);group.length=length;}else{group.groups=[];}}else{groupConfig.isFolded=!("__records"in groupData);if(!groupConfig.isFolded){group.records=groupData.__records;group.length=groupData.__count;}else{group.records=[];}}
if(Object.hasOwn(groupData,"__offset")){groupConfig.list.offset=groupData.__offset;}
if(groupRecordConfig){groupConfig.record={...groupRecordConfig,resId:group.value??false,};}
groups.push(group);}
return groups;};groups=await extractGroups(config,groups);const params=JSON.stringify([config.domain,config.groupBy,config.offset,config.limit,config.orderBy,]);if(config.currentGroups&&config.currentGroups.params===params){const currentGroups=config.currentGroups.groups;currentGroups.forEach((group,index)=>{if(config.groups[group.value]&&!groups.some((g)=>JSON.stringify(g.value)===JSON.stringify(group.value))){const aggregates=Object.assign({},group.aggregates);for(const key in aggregates){aggregates[key]=Array.isArray(aggregates[key])?[]:0;}
groups.splice(index,0,Object.assign({},group,{count:0,length:0,records:[],aggregates}));}});}
config.currentGroups={params,groups};return{groups,length};}
async _loadNewRecord(config,params={}){return this._onchange(config,params);}
async _loadRecords(config,evalContext=config.context,cache){const{resModel,activeFields,fields,context}=config;const resIds=config.resId?[config.resId]:config.resIds;if(!resIds.length){return[];}
const fieldSpec=getFieldsSpec(activeFields,fields,evalContext);if(Object.keys(fieldSpec).length>0){const kwargs={context:{bin_size:true,...context},specification:fieldSpec,};const orm=cache?this.orm.cache(cache):this.orm;const records=await orm.webRead(resModel,resIds,kwargs);if(!records.length){throw new FetchRecordError(resIds);}
return records;}else{return resIds.map((resId)=>({id:resId}));}}
async _loadUngroupedList(config,cache){const orderBy=config.orderBy.filter((o)=>o.name!=="__count");const kwargs={specification:getFieldsSpec(config.activeFields,config.fields,config.context),offset:config.offset,order:orderByToString(orderBy),limit:config.limit,context:{bin_size:true,...config.context},count_limit:config.countLimit!==Number.MAX_SAFE_INTEGER?config.countLimit+1:undefined,};const orm=cache?this.orm.cache(cache):this.orm;return orm.webSearchRead(config.resModel,config.domain,kwargs);}
async _onchange(config,{changes={},fieldNames=[],evalContext=config.context,onError,cache}){const{fields,activeFields,resModel,resId}=config;let context=config.context;if(fieldNames.length===1){const fieldContext=config.activeFields[fieldNames[0]].context;context=makeContext([context,fieldContext],evalContext);}
const spec=getFieldsSpec(activeFields,fields,evalContext,{withInvisible:true});const args=[resId?[resId]:[],changes,fieldNames,spec];let response;try{const orm=cache?this.orm.cache(cache):this.orm;response=await orm.call(resModel,"onchange",args,{context});}catch(e){if(onError){return void onError(e);}
throw e;}
if(response.warning){Promise.resolve(this.hooks.onWillDisplayOnchangeWarning(response.warning)).then(()=>{const{type,title,message,className,sticky}=response.warning;if(type==="dialog"){this.dialog.add(WarningDialog,{title,message});}else{this.notification.add(message,{className,sticky,title,type:"warning",});}});}
return response.value;}
async _updateConfig(config,patch,{reload=true,commit}={}){const tmpConfig={...config,...patch};markRaw(tmpConfig.activeFields);markRaw(tmpConfig.fields);let data;if(reload){if(tmpConfig.isRoot){this.hooks.onWillLoadRoot(tmpConfig);}
data=await this._loadData(tmpConfig);}
Object.assign(config,tmpConfig);if(data&&commit){commit(data);}
if(reload&&config.isRoot){await this.hooks.onRootLoaded(this.root);}}
async _updateCount(config){const count=await this.keepLast.add(this.orm.searchCount(config.resModel,config.domain,{context:config.context}));config.countLimit=Number.MAX_SAFE_INTEGER;return count;}
_updateSimilarRecords(reloadedRecord,serverValues){if(this.config.isMonoRecord||!this.config.groupBy.length){return;}
for(const record of this.root.records){if(record===reloadedRecord){continue;}
if(record.resId===reloadedRecord.resId){record._applyValues(serverValues);}}}
async _webReadGroup(config,cache){function getGroupInfo(groups){return Object.values(groups).map((group)=>{const field=group.fields[group.groupByFieldName];const value=field.type!=="many2many"?getGroupServerValue(field,group.value):group.value;if(group.isFolded){return{value,folded:group.isFolded};}else{return{value,folded:group.isFolded,limit:group.list.limit,offset:group.list.offset,progressbar_domain:group.extraDomain,groups:group.list.groups&&getGroupInfo(group.list.groups),};}});}
const aggregates=getAggregateSpecifications(pick(config.fields,...config.fieldsToAggregate));const currentGroupInfos=getGroupInfo(config.groups);const{activeFields,fields}=config;const evalContext=getBasicEvalContext(config);const unfoldReadSpecification=getFieldsSpec(activeFields,fields,evalContext);const groupByReadSpecification={};for(const groupBy of config.groupBy){const groupInfo=this.groupByInfo[groupBy];if(groupInfo){const{activeFields,fields}=this.groupByInfo[groupBy];groupByReadSpecification[groupBy]=getFieldsSpec(activeFields,fields,evalContext);}}
const params={limit:config.limit!==Number.MAX_SAFE_INTEGER?config.limit:undefined,offset:config.offset,order:orderByToString(config.orderBy),auto_unfold:config.openGroupsByDefault,opening_info:currentGroupInfos,unfold_read_specification:unfoldReadSpecification,unfold_read_default_limit:this.initialLimit,groupby_read_specification:groupByReadSpecification,context:{read_group_expand:true,...config.context},};const orm=cache?this.orm.cache(cache):this.orm;const result=await orm.webReadGroup(config.resModel,config.domain,config.groupBy,aggregates,params);if(!this.initialSampleGroups){this.initialSampleGroups=deepCopy(result.groups);}
return result;}}
return __exports;});;

/* /web/static/src/model/relational_model/static_list.js */
odoo.define('@web/model/relational_model/static_list',['@web/core/orm_service','@web/core/utils/arrays','@web/core/utils/objects','@web/model/relational_model/utils','@web/model/relational_model/datapoint','@odoo/owl'],function(require){'use strict';let __exports={};const{x2ManyCommands}=require("@web/core/orm_service");const{intersection}=require("@web/core/utils/arrays");const{omit,pick}=require("@web/core/utils/objects");const{completeActiveFields}=require("@web/model/relational_model/utils");const{DataPoint}=require("@web/model/relational_model/datapoint");const{fromUnityToServerValues,getBasicEvalContext,getId,patchActiveFields}=require("@web/model/relational_model/utils");const{markRaw}=require("@odoo/owl");function compareFieldValues(v1,v2,fieldType){if(fieldType==="many2one"){v1=v1?v1.display_name:"";v2=v2?v2.display_name:"";}
return v1<v2;}
function compareRecords(r1,r2,orderBy,fields){const{name,asc}=orderBy[0];function getValue(record,fieldName){return fieldName==="id"?record.resId:record.data[fieldName];}
const v1=asc?getValue(r1,name):getValue(r2,name);const v2=asc?getValue(r2,name):getValue(r1,name);if(compareFieldValues(v1,v2,fields[name].type)){return-1;}
if(compareFieldValues(v2,v1,fields[name].type)){return 1;}
if(orderBy.length>1){return compareRecords(r1,r2,orderBy.slice(1),fields);}
return 0;}
function copyRecordData(record,copyFields=[]){const data={};for(const[name,value]of Object.entries(record.data)){if(![...copyFields,"display_name"].includes(name)&&(record._isReadonly(name)||record._isInvisible(name))&&!record._isRequired(name)){continue;}
switch(record.fields[name].type){case"many2many":{const list=record.data[name];data[name]=list.currentIds.map((id)=>{let data;if(list._cache[id]){data=copyRecordData(list._cache[id]);}
return[x2ManyCommands.LINK,id,data];});break;}
case"many2one":case"many2one_reference":case"reference":data[name]=value&&Object.assign({},value);break;case"one2many":break;default:data[name]=value;}}
return data;}
const StaticList=__exports.StaticList=class StaticList extends DataPoint{static type="StaticList";setup(_config,data,options={}){this._parent=options.parent;this._onUpdate=options.onUpdate;this._cache=markRaw({});this._commands=[];this._initialCommands=[];this._savePoint=undefined;this._unknownRecordCommands={};this._currentIds=[...this.resIds];this._initialCurrentIds=[...this.currentIds];this._needsReordering=false;this._tmpIncreaseLimit=0;this._extendedRecords=new Set();this.records=data.slice(this.offset,this.limit).map((r)=>this._createRecordDatapoint(r));this.count=this.resIds.length;this.handleField=Object.keys(this.activeFields).find((fieldName)=>this.activeFields[fieldName].isHandle);}
get currentIds(){return this._currentIds;}
get editedRecord(){return this.records.find((record)=>record.isInEdition);}
get evalContext(){const evalContext=getBasicEvalContext(this.config);evalContext.parent=this._parent.evalContext;return evalContext;}
get limit(){return this.config.limit;}
get offset(){return this.config.offset;}
get orderBy(){return this.config.orderBy;}
get resIds(){return this.config.resIds;}
get selection(){return[];}
addNewRecord(params){return this.model.mutex.exec(async()=>{const{activeFields,context,mode,position,withoutParent}=params;const record=await this._createNewRecordDatapoint({activeFields,context,position,withoutParent,manuallyAdded:true,mode,});await this._addRecord(record,{position});await this._onUpdate({withoutOnchange:!record._checkValidity({silent:true})});return record;});}
addNewRecordAtIndex(index,options={}){return this.model.mutex.exec(async()=>{const newRecord=await this._addNewRecordAtIndex(index,options);await this._onUpdate();return newRecord;});}
applyCommands(commands,options={}){return this.model.mutex.exec(async()=>{await this._applyCommands(commands,omit(options,"sort"));if(options.sort){await this._sort();}
await this._onUpdate();});}
canResequence(){return this.handleField&&this.orderBy.length&&this.orderBy[0].name===this.handleField;}
delete(record){return this.model.mutex.exec(async()=>{await this._applyCommands([[x2ManyCommands.DELETE,record.resId||record._virtualId]]);if(this.count===this.offset){await this._load({offset:Math.max(this.offset-this.limit,0)});}
await this._onUpdate();});}
duplicateRecords(records=[],options={}){return this.model.mutex.exec(async()=>{await this._duplicateRecords(records,options);await this._onUpdate();});}
async enterEditMode(record){const canProceed=await this.leaveEditMode();if(canProceed){await record.switchMode("edit");}
return canProceed;}
extendRecord(params,record){return this.model.mutex.exec(async()=>{completeActiveFields(this.config.activeFields,params.activeFields);Object.assign(this.fields,params.fields);const activeFields={...params.activeFields};for(const fieldName in this.activeFields){if(fieldName in activeFields){patchActiveFields(activeFields[fieldName],this.activeFields[fieldName]);}else{activeFields[fieldName]=this.activeFields[fieldName];}}
if(record){record._noUpdateParent=true;record._activeFieldsToRestore={...this.config.activeFields};const config={...record.config,...params,activeFields,};if(this._extendedRecords.has(record.id)){this.model._updateConfig(record.config,config,{reload:false});record._addSavePoint();return record;}
let data={};if(!record.isNew){const evalContext=Object.assign({},record.evalContext,config.context);const resIds=[record.resId];[data]=await this.model._loadRecords({...config,resIds},evalContext);}
this.model._updateConfig(record.config,config,{reload:false});record._applyDefaultValues();for(const fieldName in record.activeFields){if(["one2many","many2many"].includes(record.fields[fieldName].type)){const list=record.data[fieldName];const patch={activeFields:activeFields[fieldName].related.activeFields,fields:activeFields[fieldName].related.fields,};for(const subRecord of Object.values(list._cache)){this.model._updateConfig(subRecord.config,patch,{reload:false,});}
this.model._updateConfig(list.config,patch,{reload:false});}}
record._applyValues(data);const commands=this._unknownRecordCommands[record.resId];delete this._unknownRecordCommands[record.resId];if(commands){this._applyCommands(commands);}
record._addSavePoint();}else{record=await this._createNewRecordDatapoint({activeFields,context:params.context,withoutParent:params.withoutParent,manuallyAdded:true,});record._activeFieldsToRestore={...this.config.activeFields};record._noUpdateParent=true;}
this._extendedRecords.add(record.id);return record;});}
forget(record){return this.model.mutex.exec(async()=>{await this._applyCommands([[x2ManyCommands.UNLINK,record.resId]]);await this._onUpdate();});}
async leaveEditMode({discard,canAbandon,validate}={}){if(this.editedRecord){await this.model._askChanges(false);}
return this.model.mutex.exec(async()=>{let editedRecord=this.editedRecord;if(editedRecord){const isValid=editedRecord._checkValidity();if(!isValid&&validate){return false;}
if(canAbandon!==false&&!validate){this._abandonRecords([editedRecord],{force:true});}
editedRecord=this.editedRecord;if(editedRecord){if(isValid&&!editedRecord.dirty&&discard){return false;}
if(isValid||(!editedRecord.dirty&&!editedRecord._manuallyAdded)){editedRecord._switchMode("readonly");}}}
return!this.editedRecord;});}
linkTo(resId,serverData){return this.model.mutex.exec(async()=>{await this._applyCommands([[x2ManyCommands.LINK,resId,serverData]]);await this._onUpdate();});}
unlinkFrom(resId,serverData){return this.model.mutex.exec(async()=>{await this._applyCommands([[x2ManyCommands.UNLINK,resId,serverData]]);await this._onUpdate();});}
load({limit,offset,orderBy}={}){return this.model.mutex.exec(async()=>{const editedRecord=this.editedRecord;if(editedRecord&&!(await editedRecord.checkValidity())){return;}
limit=limit!==undefined?limit:this.limit;offset=offset!==undefined?offset:this.offset;orderBy=orderBy!==undefined?orderBy:this.orderBy;return this._load({limit,offset,orderBy});});}
moveRecord(dataRecordId,_dataGroupId,refId,_targetGroupId){return this.resequence(dataRecordId,refId);}
sortBy(fieldName){return this.model.mutex.exec(()=>this._sortBy(fieldName));}
async addAndRemove({add,remove}={}){return this.model.mutex.exec(async()=>{const commands=[...(add||[]).map((id)=>[x2ManyCommands.LINK,id]),...(remove||[]).map((id)=>[x2ManyCommands.UNLINK,id]),];await this._applyCommands(commands,{canAddOverLimit:true});await this._onUpdate();});}
async resequence(movedId,targetId){return this.model.mutex.exec(()=>this._resequence(movedId,targetId));}
validateExtendedRecord(record){return this.model.mutex.exec(async()=>{if(!this._currentIds.includes(record.isNew?record._virtualId:record.resId)){await this._addRecord(record);}else if(!record.dirty){return;}
await this._onUpdate();record._restoreActiveFields();record._savePoint=undefined;});}
_abandonRecords(records=this.records,{force}={}){for(const record of records){if(record.canBeAbandoned&&(force||!record._checkValidity())){const virtualId=record._virtualId;const index=this._currentIds.findIndex((id)=>id===virtualId);this._currentIds.splice(index,1);this.records.splice(this.records.findIndex((r)=>r===record),1);this._commands=this._commands.filter((c)=>c[1]!==virtualId);this.count--;if(this._tmpIncreaseLimit>0){this.model._updateConfig(this.config,{limit:this.limit-1},{reload:false});this._tmpIncreaseLimit--;}}}}
async _addRecord(record,{position,sort=true}={}){const command=[x2ManyCommands.CREATE,record._virtualId];if(position==="top"){this.records.unshift(record);if(this.records.length>this.limit){this.records.pop();}
this._currentIds.splice(this.offset,0,record._virtualId);this._commands.unshift(command);}else if(position==="bottom"){this.records.push(record);this._currentIds.splice(this.offset+this.limit,0,record._virtualId);if(this.records.length>this.limit){this._tmpIncreaseLimit++;const nextLimit=this.limit+1;this.model._updateConfig(this.config,{limit:nextLimit},{reload:false});}
this._commands.push(command);}else{const currentIds=[...this._currentIds,record._virtualId];if(this.orderBy.length&&sort){await this._sort(currentIds);}else{if(this.records.length<this.limit){this.records.push(record);}}
this._currentIds=currentIds;this._commands.push(command);}
this.count++;this._needsReordering=true;}
async _addNewRecordAtIndex(index,options={}){const newRecord=await this._createNewRecordDatapoint({context:options.context,manuallyAdded:true,mode:options.mode||"edit",});if(this.records.length===this.limit){this._tmpIncreaseLimit++;const nextLimit=this.limit+1;this.model._updateConfig(this.config,{limit:nextLimit},{reload:false});}
await this._addRecord(newRecord);await this._resequence(newRecord.id,this.records[index].id);newRecord.dirty=false;return newRecord;}
_addSavePoint(){for(const id in this._cache){this._cache[id]._addSavePoint();}
this._savePoint=markRaw({_commands:[...this._commands],_currentIds:[...this._currentIds],count:this.count,});}
_applyCommands(commands,{canAddOverLimit}={}){const{CREATE,UPDATE,DELETE,UNLINK,LINK,SET}=x2ManyCommands;let lastCommandIndex=-1;const commandsByIds={};function addOwnCommand(command){commandsByIds[command[1]]=commandsByIds[command[1]]||[];commandsByIds[command[1]].push({command,index:++lastCommandIndex});}
function getOwnCommands(id){commandsByIds[id]=commandsByIds[id]||[];return commandsByIds[id];}
for(const command of this._commands){addOwnCommand(command);}
const removedIds={};const recordsToLoad=[];for(const command of commands){switch(command[0]){case CREATE:{const virtualId=getId("virtual");const record=this._createRecordDatapoint(command[2],{virtualId});this.records.push(record);addOwnCommand([CREATE,virtualId]);const index=this.offset+this.limit+this._tmpIncreaseLimit;this._currentIds.splice(index,0,virtualId);this._tmpIncreaseLimit=Math.max(this.records.length-this.limit,0);const nextLimit=this.limit+this._tmpIncreaseLimit;this.model._updateConfig(this.config,{limit:nextLimit},{reload:false});this.count++;break;}
case UPDATE:{const existingCommand=getOwnCommands(command[1]).some((x)=>x.command[0]===CREATE||x.command[0]===UPDATE);if(!existingCommand){addOwnCommand([UPDATE,command[1]]);}
const record=this._cache[command[1]];if(!record){if(!(command[1]in this._unknownRecordCommands)){this._unknownRecordCommands[command[1]]=[];}
this._unknownRecordCommands[command[1]].push(command);}else if(command[1]in this._unknownRecordCommands){this._unknownRecordCommands[command[1]].push(command);}else{const changes={};for(const fieldName in command[2]){if(["one2many","many2many"].includes(this.fields[fieldName].type)){const invisible=record.activeFields[fieldName]?.invisible;if(invisible==="True"||invisible==="1"||!(fieldName in record.activeFields)){if(!(command[1]in this._unknownRecordCommands)){this._unknownRecordCommands[command[1]]=[];}
this._unknownRecordCommands[command[1]].push(command);continue;}}
changes[fieldName]=command[2][fieldName];}
record._applyChanges(record._parseServerValues(changes,{currentValues:record.data}));}
break;}
case DELETE:case UNLINK:{if(command[0]===UNLINK){const firstCommand=this._commands[0];const hasReplaceWithCommand=firstCommand&&firstCommand[0]===SET;if(hasReplaceWithCommand&&firstCommand[2].includes(command[1])){firstCommand[2]=firstCommand[2].filter((id)=>id!==command[1]);break;}}
const ownCommands=getOwnCommands(command[1]);if(command[0]===DELETE){const hasCreateCommand=ownCommands.some((x)=>x.command[0]===CREATE);ownCommands.splice(0);if(!hasCreateCommand){addOwnCommand([DELETE,command[1]]);}}else{const linkToIndex=ownCommands.findIndex((x)=>x.command[0]===LINK);if(linkToIndex>=0){ownCommands.splice(linkToIndex,1);}else{addOwnCommand([UNLINK,command[1]]);}}
removedIds[command[1]]=true;break;}
case LINK:{let record;if(command[1]in this._cache){record=this._cache[command[1]];}else{record=this._createRecordDatapoint({...command[2],id:command[1]});}
if(this._currentIds.includes(record.resId)&&!removedIds[record.resId]){break;}
if(!this.limit||this.records.length<this.limit||canAddOverLimit){if(!command[2]){recordsToLoad.push(record);}
this.records.push(record);if(this.records.length>this.limit){this._tmpIncreaseLimit=this.records.length-this.limit;const nextLimit=this.limit+this._tmpIncreaseLimit;this.model._updateConfig(this.config,{limit:nextLimit},{reload:false});}}
this._currentIds.push(record.resId);addOwnCommand([command[0],command[1]]);this.count++;break;}}}
this._commands=Object.values(commandsByIds).flat().sort((x,y)=>x.index-y.index).map((x)=>x.command);if(Object.keys(removedIds).length){let removeCommandsByIdsCopy=Object.assign({},removedIds);this.records=this.records.filter((r)=>{const id=r.resId||r._virtualId;if(removeCommandsByIdsCopy[id]){delete removeCommandsByIdsCopy[id];return false;}
return true;});const nextCurrentIds=[];removeCommandsByIdsCopy=Object.assign({},removedIds);for(const id of this._currentIds){if(removeCommandsByIdsCopy[id]){delete removeCommandsByIdsCopy[id];}else{nextCurrentIds.push(id);}}
this._currentIds=nextCurrentIds;this.count=this._currentIds.length;}
const nbMissingRecords=this.limit-this.records.length;if(nbMissingRecords>0){const lastRecordIndex=this.limit+this.offset;const firstRecordIndex=lastRecordIndex-nbMissingRecords;const nextRecordIds=this._currentIds.slice(firstRecordIndex,lastRecordIndex);for(const id of this._getResIdsToLoad(nextRecordIds)){const record=this._createRecordDatapoint({id},{dontApplyCommands:true});recordsToLoad.push(record);}
for(const id of nextRecordIds){this.records.push(this._cache[id]);}}
if(recordsToLoad.length){const resIds=recordsToLoad.map((r)=>r.resId);return this.model._loadRecords({...this.config,resIds}).then((recordValues)=>{for(let i=0;i<recordsToLoad.length;i++){const record=recordsToLoad[i];record._applyValues(recordValues[i]);const commands=this._unknownRecordCommands[record.resId];if(commands){delete this._unknownRecordCommands[record.resId];this._applyCommands(commands);}}});}}
_applyInitialCommands(commands){this._applyCommands(commands);this._initialCommands=[...commands];this._initialCurrentIds=[...this._currentIds];}
async _createNewRecordDatapoint(params={}){const changes={};if(!params.withoutParent&&this.config.relationField){changes[this.config.relationField]=this._parent._getChanges();if(!this._parent.isNew){changes[this.config.relationField].id=this._parent.resId;}}
const values=await this.model._loadNewRecord({resModel:this.resModel,activeFields:params.activeFields||this.activeFields,fields:this.fields,context:Object.assign({},this.context,params.context),},{changes,evalContext:this.evalContext});if(this.canResequence()&&this.records.length){const position=params.position||"bottom";const order=this.orderBy[0];const asc=!order||order.asc;let value;if(position==="top"){const isOnFirstPage=this.offset===0;value=this.records[0].data[this.handleField];if(isOnFirstPage){if(asc){value=value>0?value-1:0;}else{value=value+1;}}}else if(position==="bottom"){value=this.records[this.records.length-1].data[this.handleField];const isOnLastPage=this.limit+this.offset>=this.count;if(isOnLastPage){if(asc){value=value+1;}else{value=value>0?value-1:0;}}}
values[this.handleField]=value;}
return this._createRecordDatapoint(values,{mode:params.mode||"edit",virtualId:getId("virtual"),activeFields:params.activeFields,manuallyAdded:params.manuallyAdded,});}
_createRecordDatapoint(data,params={}){const resId=data.id||false;if(!resId&&!params.virtualId){throw new Error("You must provide a virtualId if the record has no id");}
const id=resId||params.virtualId;const config={context:this.context,activeFields:Object.assign({},params.activeFields||this.activeFields),resModel:this.resModel,fields:params.fields||this.fields,relationField:this.config.relationField,resId,resIds:resId?[resId]:[],mode:params.mode||"readonly",isMonoRecord:true,};const{CREATE,UPDATE}=x2ManyCommands;const options={parentRecord:this._parent,onUpdate:async({withoutParentUpdate})=>{const id=record.isNew?record._virtualId:record.resId;if(!this.currentIds.includes(id)){return;}
const hasCommand=this._commands.some((c)=>(c[0]===CREATE||c[0]===UPDATE)&&c[1]===id);if(!hasCommand){this._commands.push([UPDATE,id]);}
if(record._noUpdateParent){return;}
if(!withoutParentUpdate){await this._onUpdate({withoutOnchange:!record._checkValidity({silent:true}),});}},virtualId:params.virtualId,manuallyAdded:params.manuallyAdded,};const record=new this.model.constructor.Record(this.model,config,data,options);this._cache[id]=record;if(!params.dontApplyCommands){const commands=this._unknownRecordCommands[id];if(commands){delete this._unknownRecordCommands[id];this._applyCommands(commands);}}
return record;}
_clearCommands(){this._commands=[];this._unknownRecordCommands={};}
_discard(){for(const id in this._cache){this._cache[id]._discard();}
if(this._savePoint){this._commands=this._savePoint._commands;this._currentIds=this._savePoint._currentIds;this.count=this._savePoint.count;}else{this._commands=[];this._currentIds=[...this.resIds];this.count=this.resIds.length;}
this._unknownRecordCommands={};const limit=this.limit-this._tmpIncreaseLimit;this._tmpIncreaseLimit=0;this.model._updateConfig(this.config,{limit},{reload:false});this.records=this._currentIds.slice(this.offset,this.limit).map((resId)=>this._cache[resId]);if(!this._savePoint){this._applyCommands(this._initialCommands);}
this._savePoint=undefined;}
async _duplicateRecords(records,options){const targetIndex=options.targetIndex??this.records.indexOf(records.at(-1))+1;const copyFields=options.copyFields||[];let sequence=this.records[targetIndex-1].data[this.handleField]+1;const newRecords=await Promise.all(records.map(async()=>this._createNewRecordDatapoint({mode:"readonly",})));await Promise.all(records.map((record,index)=>newRecords[index]._update({...copyRecordData(record,copyFields),[this.handleField]:sequence++,})));const localIncreaseLimit=this.records.length+records.length-this.limit;if(localIncreaseLimit>0){this._tmpIncreaseLimit+=localIncreaseLimit;const nextLimit=this.limit+localIncreaseLimit;this.model._updateConfig(this.config,{limit:nextLimit},{reload:false});}
const commands=[];for(const record of this.records.slice(targetIndex)){commands.push(x2ManyCommands.update(record.resId||record._virtualId,{[this.handleField]:sequence++,}));}
await this._applyCommands(commands);await Promise.all(newRecords.map((record)=>this._addRecord(record,{sort:false})));await this._sort();}
_getCommands({withReadonly}={}){const{CREATE,UPDATE,LINK}=x2ManyCommands;const commands=[];for(const command of this._commands){if(command[0]===UPDATE&&command[1]in this._unknownRecordCommands){const uCommands=this._unknownRecordCommands[command[1]];for(const uCommand of uCommands){const values=fromUnityToServerValues(uCommand[2],this.fields,this.activeFields,{withReadonly,context:this.context});commands.push([uCommand[0],uCommand[1],values]);}}else if(command[0]===CREATE||command[0]===UPDATE){const record=this._cache[command[1]];if(command[0]===CREATE&&record.resId){commands.push([LINK,record.resId]);}else{const values=record._getChanges(record._changes,{withReadonly});if(command[0]===CREATE||Object.keys(values).length){commands.push([command[0],command[1],values]);}}}else{commands.push(command);}}
return commands;}
_getResIdsToLoad(resIds,fieldNames=this.fieldNames){return resIds.filter((resId)=>{if(typeof resId==="string"){return false;}
const record=this._cache[resId];if(!record){return true;}
fieldNames=fieldNames.filter((fieldName)=>fieldName!=="id");return intersection(fieldNames,record.fieldNames).length!==fieldNames.length;});}
async _load({limit=this.limit,offset=this.offset,orderBy=this.orderBy,nextCurrentIds=this._currentIds,}={}){const currentIds=nextCurrentIds.slice(offset,offset+limit);const resIds=this._getResIdsToLoad(currentIds);if(resIds.length){const records=await this.model._loadRecords({...this.config,resIds},this.evalContext);for(const record of records){this._createRecordDatapoint(record);}}
this.records=currentIds.map((id)=>this._cache[id]);this._currentIds=nextCurrentIds;await this.model._updateConfig(this.config,{limit,offset,orderBy},{reload:false});}
async _replaceWith(ids,{reload=false}={}){const resIds=reload?ids:ids.filter((id)=>!this._cache[id]);if(resIds.length){const records=await this.model._loadRecords({...this.config,resIds,context:this.context,});for(const record of records){this._createRecordDatapoint(record);}}
this.records=ids.map((id)=>this._cache[id]);const updateCommandsToKeep=this._commands.filter((c)=>c[0]===x2ManyCommands.UPDATE&&ids.includes(c[1]));this._commands=[x2ManyCommands.set(ids)].concat(updateCommandsToKeep);this._currentIds=[...ids];this.count=this._currentIds.length;if(this._currentIds.length>this.limit){this._tmpIncreaseLimit=this._currentIds.length-this.limit;const nextLimit=this.limit+this._tmpIncreaseLimit;this.model._updateConfig(this.config,{limit:nextLimit},{reload:false});}}
async _resequence(movedId,targetId){const records=[...this.records];const order=this.orderBy.find((o)=>o.name===this.handleField);const asc=!order||order.asc;const fromIndex=records.findIndex((r)=>r.id===movedId);let toIndex=0;if(targetId!==null){const targetIndex=records.findIndex((r)=>r.id===targetId);toIndex=fromIndex>targetIndex?targetIndex+1:targetIndex;}
const getSequence=(rec)=>rec&&rec.data[this.handleField];const firstIndex=Math.min(fromIndex,toIndex);const lastIndex=Math.max(fromIndex,toIndex)+1;let reorderAll=false;let lastSequence=(asc?-1:1)*Infinity;for(let index=0;index<records.length;index++){const sequence=getSequence(records[index]);if((asc&&lastSequence>=sequence)||(!asc&&lastSequence<=sequence)){reorderAll=true;break;}
lastSequence=sequence;}
const[record]=records.splice(fromIndex,1);records.splice(toIndex,0,record);let toReorder=records;if(!reorderAll){toReorder=toReorder.slice(firstIndex,lastIndex).filter((r)=>r.id!==movedId);if(fromIndex<toIndex){toReorder.push(record);}else{toReorder.unshift(record);}}
if(!asc){toReorder.reverse();}
const sequences=toReorder.map(getSequence);const offset=sequences.length&&Math.min(...sequences);const proms=[];for(const[i,record]of Object.entries(toReorder)){proms.push(record._update({[this.handleField]:offset+Number(i)},{withoutParentUpdate:true}));}
await Promise.all(proms);await this._sort();await this._onUpdate();}
async _sort(currentIds=this.currentIds,orderBy=this.orderBy){const fieldNames=orderBy.map((o)=>o.name);const resIds=this._getResIdsToLoad(currentIds,fieldNames);if(resIds.length){const activeFields=pick(this.activeFields,...fieldNames);const config={...this.config,resIds,activeFields};const records=await this.model._loadRecords(config);for(const record of records){this._createRecordDatapoint(record,{activeFields});}}
const allRecords=currentIds.map((id)=>this._cache[id]);const sortedRecords=allRecords.sort((r1,r2)=>compareRecords(r1,r2,orderBy,this.fields));await this._load({orderBy,nextCurrentIds:sortedRecords.map((r)=>r.resId||r._virtualId),});this._needsReordering=false;}
async _sortBy(fieldName){let orderBy=[...this.orderBy];if(fieldName){if(orderBy.length&&orderBy[0].name===fieldName){if(!this._needsReordering){if(orderBy[0].asc){orderBy[0]={name:orderBy[0].name,asc:false};}else{orderBy=[{name:"id",asc:true}];}}}else{orderBy=orderBy.filter((o)=>o.name!==fieldName);orderBy.unshift({name:fieldName,asc:true,});}}
return this._sort(this._currentIds,orderBy);}
_updateContext(context){Object.assign(this.context,context);for(const record of Object.values(this._cache)){record._setEvalContext();}}}
return __exports;});;

/* /web/static/src/model/relational_model/utils.js */
odoo.define('@web/model/relational_model/utils',['@odoo/owl','@web/core/context','@web/core/domain','@web/core/l10n/dates','@web/core/orm_service','@web/core/py_js/py','@web/core/utils/concurrency','@web/core/utils/objects','@web/core/utils/reactive','@web/core/utils/timing','@web/search/utils/order_by','@web/core/l10n/translation','@web/core/user','@web/core/utils/functions','@web/core/utils/arrays'],function(require){'use strict';let __exports={};const{markup,onWillDestroy,onWillStart,onWillUpdateProps,useComponent}=require("@odoo/owl");const{evalPartialContext,makeContext}=require("@web/core/context");const{Domain}=require("@web/core/domain");const{deserializeDate,deserializeDateTime,serializeDate,serializeDateTime,}=require("@web/core/l10n/dates");const{x2ManyCommands}=require("@web/core/orm_service");const{evaluateExpr}=require("@web/core/py_js/py");const{Deferred}=require("@web/core/utils/concurrency");const{omit}=require("@web/core/utils/objects");const{effect}=require("@web/core/utils/reactive");const{batched}=require("@web/core/utils/timing");const{orderByToString}=require("@web/search/utils/order_by");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web",...args);const{user}=require("@web/core/user");const{uniqueId}=require("@web/core/utils/functions");const{unique}=require("@web/core/utils/arrays");const granularityToInterval={hour:{hours:1},day:{days:1},week:{days:7},month:{month:1},quarter:{month:4},year:{year:1},};function convertBoolToPyExpr(value){if(value===true||value===false){return value?"True":"False";}
return value;}
__exports.makeActiveField=makeActiveField;function makeActiveField({context,invisible,readonly,required,onChange,forceSave,isHandle,}={}){return{context:context||"{}",invisible:convertBoolToPyExpr(invisible||false),readonly:convertBoolToPyExpr(readonly||false),required:convertBoolToPyExpr(required||false),onChange:onChange||false,forceSave:forceSave||false,isHandle:isHandle||false,};}
const AGGREGATABLE_FIELD_TYPES=__exports.AGGREGATABLE_FIELD_TYPES=["float","integer","monetary"];__exports.addFieldDependencies=addFieldDependencies;function addFieldDependencies(activeFields,fields,fieldDependencies=[]){for(const field of fieldDependencies){if(!("readonly"in field)){field.readonly=true;}
if(field.name in activeFields){patchActiveFields(activeFields[field.name],makeActiveField(field));}else{activeFields[field.name]=makeActiveField(field);if(["one2many","many2many"].includes(field.type)){activeFields[field.name].related={activeFields:{},fields:{}};}}
if(!fields[field.name]){const newField=omit(field,["context","invisible","required","readonly","onChange",]);fields[field.name]=newField;if(newField.type==="selection"&&!Array.isArray(newField.selection)){newField.selection=[];}}}}
function completeActiveField(activeField,extra){if(extra.related){for(const fieldName in extra.related.activeFields){if(fieldName in activeField.related.activeFields){completeActiveField(activeField.related.activeFields[fieldName],extra.related.activeFields[fieldName]);}else{activeField.related.activeFields[fieldName]={...extra.related.activeFields[fieldName],};}}
Object.assign(activeField.related.fields,extra.related.fields);}}
__exports.completeActiveFields=completeActiveFields;function completeActiveFields(activeFields,extraActiveFields){for(const fieldName in extraActiveFields){const extraActiveField={...extraActiveFields[fieldName],invisible:"True",};if(fieldName in activeFields){completeActiveField(activeFields[fieldName],extraActiveField);}else{activeFields[fieldName]=extraActiveField;}}}
__exports.createPropertyActiveField=createPropertyActiveField;function createPropertyActiveField(property){const{type}=property;const activeField=makeActiveField();if(type==="one2many"||type==="many2many"){activeField.related={fields:{id:{name:"id",type:"integer"},display_name:{name:"display_name",type:"char"},},activeFields:{id:makeActiveField({readonly:true}),display_name:makeActiveField(),},};}
return activeField;}
__exports.combineModifiers=combineModifiers;function combineModifiers(mod1,mod2,operator){if(operator==="AND"){if(!mod1||mod1==="False"||!mod2||mod2==="False"){return"False";}
if(mod1==="True"){return mod2;}
if(mod2==="True"){return mod1;}
return"("+mod1+") and ("+mod2+")";}else if(operator==="OR"){if(mod1==="True"||mod2==="True"){return"True";}
if(!mod1||mod1==="False"){return mod2;}
if(!mod2||mod2==="False"){return mod1;}
return"("+mod1+") or ("+mod2+")";}
throw new Error(`Operator provided to "combineModifiers" must be "AND" or "OR", received ${operator}`);}
__exports.patchActiveFields=patchActiveFields;function patchActiveFields(activeField,patch){activeField.invisible=combineModifiers(activeField.invisible,patch.invisible,"AND");activeField.readonly=combineModifiers(activeField.readonly,patch.readonly,"AND");activeField.required=combineModifiers(activeField.required,patch.required,"OR");activeField.onChange=activeField.onChange||patch.onChange;activeField.forceSave=activeField.forceSave||patch.forceSave;activeField.isHandle=activeField.isHandle||patch.isHandle;if(patch.related){const related=activeField.related;for(const fieldName in patch.related.activeFields){if(fieldName in related.activeFields){patchActiveFields(related.activeFields[fieldName],patch.related.activeFields[fieldName]);}else{related.activeFields[fieldName]={...patch.related.activeFields[fieldName]};}}
Object.assign(related.fields,patch.related.fields);}
if("limit"in patch){activeField.limit=patch.limit;}
if(patch.defaultOrderBy){activeField.defaultOrderBy=patch.defaultOrderBy;}}
__exports.extractFieldsFromArchInfo=extractFieldsFromArchInfo;function extractFieldsFromArchInfo({fieldNodes,widgetNodes},fields){const activeFields={};for(const fieldNode of Object.values(fieldNodes)){const fieldName=fieldNode.name;const activeField=makeActiveField({context:fieldNode.context,invisible:combineModifiers(fieldNode.invisible,fieldNode.column_invisible,"OR"),readonly:fieldNode.readonly,required:fieldNode.required,onChange:fieldNode.onChange,forceSave:fieldNode.forceSave,isHandle:fieldNode.isHandle,});if(["one2many","many2many"].includes(fields[fieldName].type)){activeField.related={activeFields:{},fields:{},};if(fieldNode.views){const viewDescr=fieldNode.views[fieldNode.viewMode];if(viewDescr){activeField.related=extractFieldsFromArchInfo(viewDescr,viewDescr.fields);activeField.limit=viewDescr.limit;activeField.defaultOrderBy=viewDescr.defaultOrder;if(fieldNode.views.form){const formArchInfo=extractFieldsFromArchInfo(fieldNode.views.form,fieldNode.views.form.fields);completeActiveFields(activeField.related.activeFields,formArchInfo.activeFields);Object.assign(activeField.related.fields,formArchInfo.fields);}
if(fieldNode.viewMode!=="default"&&fieldNode.views.default){const defaultArchInfo=extractFieldsFromArchInfo(fieldNode.views.default,fieldNode.views.default.fields);for(const fieldName in defaultArchInfo.activeFields){if(fieldName in activeField.related.activeFields){patchActiveFields(activeField.related.activeFields[fieldName],defaultArchInfo.activeFields[fieldName]);}else{activeField.related.activeFields[fieldName]={...defaultArchInfo.activeFields[fieldName],};}}
activeField.related.fields=Object.assign({},defaultArchInfo.fields,activeField.related.fields);}}}
if(fieldNode.field?.useSubView){activeField.required="False";}}
if(["many2one","many2one_reference"].includes(fields[fieldName].type)&&fieldNode.views){const viewDescr=fieldNode.views.default;activeField.related=extractFieldsFromArchInfo(viewDescr,viewDescr.fields);}
if(fieldName in activeFields){patchActiveFields(activeFields[fieldName],activeField);}else{activeFields[fieldName]=activeField;}
if(fieldNode.field){let fieldDependencies=fieldNode.field.fieldDependencies;if(typeof fieldDependencies==="function"){fieldDependencies=fieldDependencies(fieldNode);}
addFieldDependencies(activeFields,fields,fieldDependencies);}}
for(const widgetInfo of Object.values(widgetNodes||{})){let fieldDependencies=widgetInfo.widget.fieldDependencies;if(typeof fieldDependencies==="function"){fieldDependencies=fieldDependencies(widgetInfo);}
addFieldDependencies(activeFields,fields,fieldDependencies);}
return{activeFields,fields};}
__exports.getFieldContext=getFieldContext;function getFieldContext(record,fieldName,rawContext=record.activeFields[fieldName].context){const context={};for(const key in record.context){if(!key.startsWith("default_")&&!key.startsWith("search_default_")&&!key.endsWith("_view_ref")){context[key]=record.context[key];}}
return{...context,...record.fields[fieldName].context,...makeContext([rawContext],record.evalContext),};}
__exports.getFieldDomain=getFieldDomain;function getFieldDomain(record,fieldName,domain){if(typeof domain==="function"){domain=domain();domain=typeof domain==="function"?domain():domain;}
if(domain){return domain;}
domain=record.fields[fieldName].domain;return typeof domain==="string"?new Domain(evaluateExpr(domain,record.evalContext)).toList():domain||[];}
__exports.getBasicEvalContext=getBasicEvalContext;function getBasicEvalContext(config){const{uid,allowed_company_ids}=config.context;return{context:config.context,uid,allowed_company_ids,current_company_id:user.activeCompany?.id,};}
function getFieldContextForSpec(activeFields,fields,fieldName,evalContext){let context=activeFields[fieldName].context;if(!context||context==="{}"){context=fields[fieldName].context||{};}else{context=evalPartialContext(context,evalContext);}
if(Object.keys(context).length>0){return context;}}
__exports.getFieldsSpec=getFieldsSpec;function getFieldsSpec(activeFields,fields,evalContext,{orderBys,withInvisible}={}){const fieldsSpec={};const properties=[];for(const fieldName in activeFields){if(fields[fieldName].relatedPropertyField){continue;}
const{related,limit,defaultOrderBy,invisible}=activeFields[fieldName];const isAlwaysInvisible=invisible==="True"||invisible==="1";fieldsSpec[fieldName]={};switch(fields[fieldName].type){case"one2many":case"many2many":{if(related&&(withInvisible||!isAlwaysInvisible)){fieldsSpec[fieldName].fields=getFieldsSpec(related.activeFields,related.fields,evalContext,{withInvisible});fieldsSpec[fieldName].context=getFieldContextForSpec(activeFields,fields,fieldName,evalContext);fieldsSpec[fieldName].limit=limit;const orderBy=orderBys?.[fieldName]||defaultOrderBy||[];if(orderBy.length){fieldsSpec[fieldName].order=orderByToString(orderBy);}}
break;}
case"many2one":case"reference":{fieldsSpec[fieldName].fields={};if(!isAlwaysInvisible){if(related){fieldsSpec[fieldName].fields=getFieldsSpec(related.activeFields,related.fields,evalContext);}
fieldsSpec[fieldName].fields.display_name={};fieldsSpec[fieldName].context=getFieldContextForSpec(activeFields,fields,fieldName,evalContext);}
break;}
case"many2one_reference":{if(related&&!isAlwaysInvisible){fieldsSpec[fieldName].fields=getFieldsSpec(related.activeFields,related.fields,evalContext);fieldsSpec[fieldName].context=getFieldContextForSpec(activeFields,fields,fieldName,evalContext);}
break;}
case"properties":{properties.push(fieldName);break;}}}
for(const fieldName of properties){const fieldSpec=fieldsSpec[fields[fieldName].definition_record];if(fieldSpec){if(!fieldSpec.fields){fieldSpec.fields={};}
fieldSpec.fields.display_name={};}}
return fieldsSpec;}
let nextId=0;__exports.getId=getId;function getId(prefix=""){return`${prefix}_${++nextId}`;}
__exports.parseServerValue=parseServerValue;function parseServerValue(field,value){switch(field.type){case"char":case"text":{return value||"";}
case"html":{return markup(value||"");}
case"date":{return value?deserializeDate(value):false;}
case"datetime":{return value?deserializeDateTime(value):false;}
case"selection":{if(value===false){const hasKey0=field.selection.find((option)=>option[0]===0);return hasKey0?0:value;}
return value;}
case"reference":{if(value===false){return false;}
return{resId:value.id.id,resModel:value.id.model,displayName:value.display_name,};}
case"many2one_reference":{if(value===0){return false;}
if(typeof value==="number"){return{resId:value};}
return{resId:value.id,displayName:value.display_name,};}
case"many2one":{if(Array.isArray(value)){value={id:value[0],display_name:value[1]};}
return value;}
case"properties":{return value?value.map((property)=>{if(property.value!==undefined){property.value=parseServerValue(property,property.value??false);}
if(property.default!==undefined){property.default=parseServerValue(property,property.default??false);}
return property;}):[];}}
return value;}
__exports.getAggregateSpecifications=getAggregateSpecifications;function getAggregateSpecifications(fields){const aggregatableFields=Object.values(fields).filter((field)=>field.aggregator&&AGGREGATABLE_FIELD_TYPES.includes(field.type)).map((field)=>`${field.name}:${field.aggregator}`);const currencyFields=unique(Object.values(fields).filter((field)=>field.aggregator&&field.currency_field).map((field)=>[`${field.currency_field}:array_agg_distinct`,`${field.name}:sum_currency`,]).flat());return aggregatableFields.concat(currencyFields);}
__exports.extractInfoFromGroupData=extractInfoFromGroupData;function extractInfoFromGroupData(groupData,groupBy,fields,domain){const info={};const groupByField=fields[groupBy[0].split(":")[0]];info.count=groupData.__count;info.length=info.count;info.domain=Domain.and([domain,groupData.__extra_domain]).toList();info.rawValue=groupData[groupBy[0]];info.value=getValueFromGroupData(groupByField,info.rawValue);if(["date","datetime"].includes(groupByField.type)&&info.value){const granularity=groupBy[0].split(":")[1];info.range={from:info.value,to:info.value.plus(granularityToInterval[granularity]),};}
info.displayName=getDisplayNameFromGroupData(groupByField,info.rawValue);info.serverValue=getGroupServerValue(groupByField,info.value);info.aggregates=getAggregatesFromGroupData(groupData,fields);info.values=groupData.__values;return info;}
function getAggregatesFromGroupData(groupData,fields){const aggregates={};for(const keyAggregate of getAggregateSpecifications(fields)){if(keyAggregate in groupData){const[fieldName,aggregate]=keyAggregate.split(":");if(aggregate==="sum_currency"){const currencies=groupData[fields[fieldName].currency_field+":array_agg_distinct"];if(currencies.length===1){continue;}}
aggregates[fieldName]=groupData[keyAggregate];}}
return aggregates;}
function getDisplayNameFromGroupData(field,rawValue){switch(field.type){case"selection":{return Object.fromEntries(field.selection)[rawValue];}
case"boolean":{return rawValue?_t("Yes"):_t("No");}
case"integer":{return rawValue?String(rawValue):"0";}
case"many2one":case"many2many":case"date":case"datetime":case"tags":{return(rawValue&&rawValue[1])||field.falsy_value_label||_t("None");}}
return rawValue?String(rawValue):field.falsy_value_label||_t("None");}
__exports.getGroupServerValue=getGroupServerValue;function getGroupServerValue(field,value){switch(field.type){case"many2many":{return value?[value]:false;}
case"datetime":{return value?serializeDateTime(value):false;}
case"date":{return value?serializeDate(value):false;}
default:{return value||false;}}}
function getValueFromGroupData(field,rawValue){if(["date","datetime"].includes(field.type)){if(!rawValue){return false;}
return parseServerValue(field,rawValue[0]);}
const value=parseServerValue(field,rawValue);if(field.type==="many2one"){return value&&value.id;}
if(field.type==="many2many"){return value?value[0]:false;}
if(field.type==="tags"){return value?value[0]:false;}
return value;}
__exports.fromUnityToServerValues=fromUnityToServerValues;function fromUnityToServerValues(values,fields,activeFields,{withReadonly,context}={}){const{CREATE,UPDATE}=x2ManyCommands;const serverValues={};for(const fieldName in values){let value=values[fieldName];const field=fields[fieldName];const activeField=activeFields[fieldName];if(!withReadonly){if(field.readonly){continue;}
try{if(evaluateExpr(activeField.readonly,context)){continue;}}catch{}}
switch(fields[fieldName].type){case"one2many":case"many2many":value=value.map((c)=>{if(c[0]===CREATE||c[0]===UPDATE){const _fields=activeField.related.fields;const _activeFields=activeField.related.activeFields;return[c[0],c[1],fromUnityToServerValues(c[2],_fields,_activeFields,{withReadonly}),];}
return[c[0],c[1]];});break;case"many2one":value=value?value.id:false;break;}
serverValues[fieldName]=value;}
return serverValues;}
__exports.isRelational=isRelational;function isRelational(field){return field&&["one2many","many2many","many2one"].includes(field.type);}
__exports.useRecordObserver=useRecordObserver;function useRecordObserver(callback){const component=useComponent();let currentId;const observeRecord=(props)=>{currentId=uniqueId();if(!props.record){return;}
const def=new Deferred();const effectId=currentId;let firstCall=true;effect((record)=>{if(firstCall){firstCall=false;return Promise.resolve(callback(record,props)).then(def.resolve).catch(def.reject);}else{return batched((record)=>{if(effectId!==currentId){return;}
return Promise.resolve(callback(record,props)).then(def.resolve).catch(def.reject);},()=>new Promise((resolve)=>window.requestAnimationFrame(resolve)))(record);}},[props.record]);return def;};onWillDestroy(()=>{currentId=uniqueId();});onWillStart(()=>observeRecord(component.props));onWillUpdateProps((nextProps)=>{if(nextProps.record!==component.props.record){return observeRecord(nextProps);}});}
__exports.resequence=resequence;async function resequence({records,resModel,orm,fieldName,movedId,targetId,asc=true,getSequence=(record)=>record[fieldName],getResId=(record)=>record.id,context,}){const fromIndex=records.findIndex((d)=>d.id===movedId);let toIndex=0;if(targetId!==null){const targetIndex=records.findIndex((d)=>d.id===targetId);toIndex=fromIndex>targetIndex?targetIndex+1:targetIndex;}
const firstIndex=Math.min(fromIndex,toIndex);const lastIndex=Math.max(fromIndex,toIndex)+1;let reorderAll=records.some((record)=>getSequence(record)===undefined);if(!reorderAll){let lastSequence=(asc?-1:1)*Infinity;for(let index=0;index<records.length;index++){const sequence=getSequence(records[index]);if((asc&&lastSequence>=sequence)||(!asc&&lastSequence<=sequence)){reorderAll=true;break;}
lastSequence=sequence;}}
const originalOrder=[...records];const record=records[fromIndex];if(fromIndex!==toIndex){records.splice(fromIndex,1);records.splice(toIndex,0,record);}
let toReorder=records;if(!reorderAll){toReorder=toReorder.slice(firstIndex,lastIndex).filter((r)=>r.id!==movedId);if(fromIndex<toIndex){toReorder.push(record);}else{toReorder.unshift(record);}}
if(!asc){toReorder.reverse();}
const resIds=toReorder.map((d)=>getResId(d)).filter((id)=>id&&!isNaN(id));const sequences=toReorder.map(getSequence);const offset=Math.min(...sequences)||0;try{return await orm.webResequence(resModel,resIds,{field_name:fieldName,offset,context,specification:{[fieldName]:{}},});}catch(error){records.splice(0,records.length,...originalOrder);throw error;}}
return __exports;});;

/* /web/static/src/model/sample_server.js */
odoo.define('@web/model/sample_server',['@web/core/l10n/dates','@web/core/orm_service','@web/core/registry','@web/core/utils/arrays','@web/model/relational_model/utils'],function(require){'use strict';let __exports={};const{deserializeDate,deserializeDateTime,serializeDate,serializeDateTime,}=require("@web/core/l10n/dates");const{ORM}=require("@web/core/orm_service");const{registry}=require("@web/core/registry");const{cartesian,sortBy:arraySortBy,unique}=require("@web/core/utils/arrays");const{parseServerValue}=require("@web/model/relational_model/utils");class UnimplementedRouteError extends Error{}
function getSampleFromId(id,sampleTexts){return sampleTexts[(id-1)%sampleTexts.length];}
function serializeGroupDateValue(range,field){if(!range){return false;}
const dateValue=parseServerValue(field,range[0]);return field.type==="date"?serializeDate(dateValue):serializeDateTime(dateValue);}
function fieldNameRegex(...terms){return new RegExp(`\\b((\\w+)?_)?(${terms.join("|")})(_(\\w+)?)?\\b`);}
const MEASURE_SPEC_REGEX=/(?<fieldName>\w+):(?<func>\w+)/;const DESCRIPTION_REGEX=fieldNameRegex("description","label","title","subject","message");const EMAIL_REGEX=fieldNameRegex("email");const PHONE_REGEX=fieldNameRegex("phone");const URL_REGEX=fieldNameRegex("url");const MAX_NUMBER_OPENED_GROUPS=10;const SampleServer=__exports.SampleServer=class SampleServer{constructor(modelName,fields){this.mainModel=modelName;this.data={};this.data[modelName]={fields,records:[],};for(const fieldName in fields){const field=fields[fieldName];if(["many2one","one2many","many2many"].includes(field.type)){this.data[field.relation]=this.data[field.relation]||{fields:{display_name:{type:"char"},id:{type:"integer"},color:{type:"integer"},},records:[],};}}
this.existingGroups=null;this.populated=false;this.existingGroupsPopulated=false;}
mockRpc(params){if(!(params.model in this.data)){throw new Error(`SampleServer: unknown model ${params.model}`);}
this._populateModels();switch(params.method||params.route){case"web_search_read":return this._mockWebSearchReadUnity(params);case"web_read_group":return this._mockWebReadGroup(params);case"formatted_read_group":return this._mockFormattedReadGroup(params);case"formatted_read_grouping_sets":return this._mockFormattedReadGroupingSets(params);case"read_progress_bar":return this._mockReadProgressBar(params);case"read":return this._mockRead(params);}
const method=params.method||params.route;const mockFunction=registry.category("sample_server").get(`${params.model}/${method}`,null)||registry.category("sample_server").get(method,null);if(mockFunction){return mockFunction.call(this,params);}
console.log(`SampleServer: unimplemented route "${params.method || params.route}"`);throw new SampleServer.UnimplementedRouteError();}
setExistingGroups(groups){this.existingGroups=groups;}
_aggregateFields(measures,records){const group={};for(const{fieldName,func,name}of measures){if(["sum","sum_currency","avg","max","min"].includes(func)){if(!records.length){group[name]=false;}else{group[name]=0;for(const record of records){group[name]+=record[fieldName];}}
group[name]=this._sanitizeNumber(group[name]);}else if(func==="array_agg"){group[name]=records.map((r)=>r[fieldName]);}else if(func==="__count"){group[name]=records.length;}else if(func==="count_distinct"){group[name]=unique(records.map((r)=>r[fieldName])).filter(Boolean).length;}else if(func==="bool_or"){group[name]=records.some((r)=>Boolean(r[fieldName]));}else if(func==="bool_and"){group[name]=records.every((r)=>Boolean(r[fieldName]));}else if(func==="array_agg_distinct"){group[name]=unique(records.map((r)=>r[fieldName]));}else{throw new Error(`Aggregate "${func}" not implemented in SampleServer`);}}
return group;}
_formatValue(value,options){if(!value){return false;}
const{type,interval,relation}=options;if(["date","datetime"].includes(type)&&value){const deserialize=type==="date"?deserializeDate:deserializeDateTime;const serialize=type==="date"?serializeDate:serializeDateTime;const from=deserialize(value).startOf(interval);const fmt=SampleServer.FORMATS[interval];return[serialize(from),from.toFormat(fmt)];}else if(["many2one","many2many"].includes(type)){const rec=this.data[relation].records.find(({id})=>id===value);return[value,rec.display_name];}else{return value;}}
_generateFieldValue(modelName,fieldName,id){const field=this.data[modelName].fields[fieldName];switch(field.type){case"boolean":return fieldName==="active"?true:this._getRandomBool();case"char":case"text":if(["display_name","name"].includes(fieldName)){if(SampleServer.PEOPLE_MODELS.includes(modelName)){return getSampleFromId(id,SampleServer.SAMPLE_PEOPLE);}else if(modelName==="res.country"){return getSampleFromId(id,SampleServer.SAMPLE_COUNTRIES);}}
if(fieldName==="display_name"){return getSampleFromId(id,SampleServer.SAMPLE_TEXTS);}else if(["name","reference"].includes(fieldName)){return`REF${String(id).padStart(4, "0")}`;}else if(DESCRIPTION_REGEX.test(fieldName)){return getSampleFromId(id,SampleServer.SAMPLE_TEXTS);}else if(EMAIL_REGEX.test(fieldName)){const emailName=getSampleFromId(id,SampleServer.SAMPLE_PEOPLE).replace(/ /,".").toLowerCase();return`${emailName}@sample.demo`;}else if(PHONE_REGEX.test(fieldName)){return`+1 555 754 ${String(id).padStart(4, "0")}`;}else if(URL_REGEX.test(fieldName)){return`http://sample${id}.com`;}
return false;case"date":case"datetime":{const datetime=this._getRandomDate();return field.type==="date"?serializeDate(datetime):serializeDateTime(datetime);}
case"float":return this._getRandomFloat(SampleServer.MAX_FLOAT);case"integer":{let max=SampleServer.MAX_INTEGER;if(fieldName.includes("color")){max=this._getRandomBool()?SampleServer.MAX_COLOR_INT:0;}
return this._getRandomInt(max);}
case"monetary":return this._getRandomInt(SampleServer.MAX_MONETARY);case"many2one":if(field.relation==="res.currency"){return 1;}
if(field.relation==="ir.attachment"){return false;}
return this._getRandomSubRecordId();case"one2many":case"many2many":{const ids=[this._getRandomSubRecordId(),this._getRandomSubRecordId()];return[...new Set(ids)];}
case"selection":{return this._getRandomSelectionValue(modelName,field);}
default:return false;}}
_getRandomArrayEl(array){return array[Math.floor(Math.random()*array.length)];}
_getRandomBool(){return Math.random()<0.5;}
_getRandomDate(){const delta=Math.floor((Math.random()-Math.random())*SampleServer.DATE_DELTA);return luxon.DateTime.local().plus({hours:delta});}
_getRandomFloat(max){return this._sanitizeNumber(Math.random()*max);}
_getRandomInt(max){return Math.floor(Math.random()*max);}
_getRandomSelectionValue(modelName,field){if(field.selection.length>0){return this._getRandomArrayEl(field.selection)[0];}
return false;}
_getRandomSubRecordId(){return Math.floor(Math.random()*SampleServer.SUB_RECORDSET_SIZE)+1;}
_mockRead(params){const model=this.data[params.model];const ids=params.args[0];const fieldNames=params.args[1];const records=[];for(const r of model.records){if(!ids.includes(r.id)){continue;}
const record={id:r.id};for(const fieldName of fieldNames){const field=model.fields[fieldName];if(!field){record[fieldName]=false;}else if(field.type==="many2one"){const relModel=this.data[field.relation];const relRecord=relModel.records.find((relR)=>r[fieldName]===relR.id);record[fieldName]=relRecord?[relRecord.id,relRecord.display_name]:false;}else{record[fieldName]=r[fieldName];}}
records.push(record);}
return records;}
_mockFormattedReadGroup(params){const model=params.model;const groupBy=params.groupBy;const fields=this.data[model].fields;const records=this.data[model].records;const normalizedGroupBys=[];for(const groupBySpec of groupBy){const[fieldName,interval]=groupBySpec.split(":");const{type,relation}=fields[fieldName];if(type){const gb={fieldName,type,interval,relation,alias:groupBySpec};normalizedGroupBys.push(gb);}}
const groupsFromRecord=(record)=>{const values=[];for(const gb of normalizedGroupBys){const{fieldName,type,alias}=gb;let fieldVals;if(["date","datetime"].includes(type)){fieldVals=[this._formatValue(record[fieldName],gb)];}else if(type==="many2many"){fieldVals=record[fieldName].length?record[fieldName]:[false];}else{fieldVals=[record[fieldName]];}
values.push(fieldVals.map((val)=>({[alias]:val})));}
const cart=cartesian(...values);return cart.map((tuple)=>{if(!Array.isArray(tuple)){tuple=[tuple];}
return Object.assign({},...tuple);});};const groups={};for(const record of records){const recordGroups=groupsFromRecord(record);for(const group of recordGroups){const groupId=JSON.stringify(group);if(!(groupId in groups)){groups[groupId]=[];}
groups[groupId].push(record);}}
const aggregates=params.aggregates||[];const measures=[];for(const measureSpec of aggregates){if(measureSpec==="__count"){measures.push({fieldName:"__count",func:"__count",name:measureSpec});continue;}
const matches=measureSpec.match(MEASURE_SPEC_REGEX);if(!matches){throw new Error(`Invalidate Aggregate "${measureSpec}" in SampleServer`);}
const{fieldName,func}=matches.groups;measures.push({fieldName,func,name:measureSpec});}
let result=[];for(const id in groups){const records=groups[id];const group={__extra_domain:[]};const firstElem=records[0];const parsedId=JSON.parse(id);for(const gb of normalizedGroupBys){const{alias,fieldName,type}=gb;if(type==="many2many"){group[alias]=this._formatValue(parsedId[fieldName],gb);}else{group[alias]=this._formatValue(firstElem[fieldName],gb);}}
Object.assign(group,this._aggregateFields(measures,records));result.push(group);}
if(normalizedGroupBys.length>0){const{alias,type}=normalizedGroupBys[0];result=arraySortBy(result,(group)=>{const val=group[alias];if(type==="datetime"){return deserializeDateTime(val);}else if(type==="date"){return deserializeDate(val);}
return val;});}
return result;}
_mockFormattedReadGroupingSets(params){const res=[];for(const groupBy of params.grouping_sets){res.push(this._mockFormattedReadGroup({...params,groupBy}));}
return res;}
_mockReadProgressBar(params){const groupBy=params.group_by;const progressBar=params.progress_bar;const groups=this._mockFormattedReadGroup({model:params.model,domain:params.domain,groupBy:[groupBy,progressBar.field],aggregates:["__count"],});const data={};for(const group of groups){let groupByValue=group[groupBy];if(Array.isArray(groupByValue)){groupByValue=groupByValue[0];}
if(!(groupByValue in data)){if(groupByValue===true){groupByValue="True";}else if(groupByValue===false){groupByValue="False";}}
if(!(groupByValue in data)){data[groupByValue]={};for(const key in progressBar.colors){data[groupByValue][key]=0;}}
data[groupByValue][group[progressBar.field]]+=group.__count;}
return data;}
_mockWebSearchReadUnity(params){const fields=Object.keys(params.specification);const model=this.data[params.model];let rawRecords=model.records;if("recordIds"in params){rawRecords=model.records.filter((record)=>params.recordIds.includes(record.id));}else{rawRecords=rawRecords.slice(0,SampleServer.SEARCH_READ_LIMIT);}
const records=this._mockRead({model:params.model,args:[rawRecords.map((r)=>r.id),fields],});const result={records,length:records.length};for(const fieldName in params.specification){const field=this.data[params.model].fields[fieldName];if(field.type==="many2one"){for(const record of result.records){record[fieldName]=record[fieldName]?{id:record[fieldName][0],display_name:record[fieldName][1],}:false;}}
if(field.type==="one2many"||field.type==="many2many"){const relFields=Object.keys(params.specification[fieldName].fields||{});if(relFields.length){const relIds=result.records.map((r)=>r[fieldName]).flat();const relRecords={};const _relRecords=this._mockRead({model:field.relation,args:[relIds,relFields],});for(const relRecord of _relRecords){relRecords[relRecord.id]=relRecord;}
for(const record of result.records){record[fieldName]=record[fieldName].map((resId)=>relRecords[resId]);}}}}
return result;}
_mockWebReadGroup(params){const aggregates=[...params.aggregates,"__count"];if(params.unfold_read_specification){aggregates.push("id:array_agg");}
let groups;if(this.existingGroups){this._tweakExistingGroups({...params,aggregates});groups=this.existingGroups;}else{groups=this._mockFormattedReadGroup({...params,aggregates});}
const openAllGroups=params.auto_unfold&&!this.existingGroups;let nbOpenedGroup=0;if(params.unfold_read_specification){for(const group of groups){if(openAllGroups||"__records"in group){if(nbOpenedGroup<MAX_NUMBER_OPENED_GROUPS){nbOpenedGroup++;group.__records=this._mockWebSearchReadUnity({model:params.model,specification:params.unfold_read_specification,recordIds:group["id:array_agg"],}).records;}}
delete group["id:array_agg"];}}
return{groups,length:groups.length,};}
_populateExistingGroups(params){const groups=this.existingGroups;const groupBy=params.groupBy[0].split(":")[0];const groupByField=this.data[params.model].fields[groupBy];const groupedByM2O=groupByField.type==="many2one";if(groupedByM2O){this.data[groupByField.relation].records=groups.map((g)=>({id:g[groupBy][0],display_name:g[groupBy][1],}));}
for(const r of this.data[params.model].records){const group=getSampleFromId(r.id,groups);if(["date","datetime"].includes(groupByField.type)){r[groupBy]=serializeGroupDateValue(group[params.groupBy[0]],groupByField);}else if(groupByField.type==="many2one"){r[groupBy]=group[params.groupBy[0]]?group[params.groupBy[0]][0]:false;}else{r[groupBy]=group[params.groupBy[0]];}}}
_populateModels(){if(!this.populated){for(const modelName in this.data){const model=this.data[modelName];const fieldNames=Object.keys(model.fields).filter((f)=>f!=="id");const size=modelName===this.mainModel?SampleServer.MAIN_RECORDSET_SIZE:SampleServer.SUB_RECORDSET_SIZE;for(let id=1;id<=size;id++){const record={id};for(const fieldName of fieldNames){record[fieldName]=this._generateFieldValue(modelName,fieldName,id);}
model.records.push(record);}}
this.populated=true;}}
_sanitizeNumber(value){return parseFloat(value.toFixed(SampleServer.FLOAT_PRECISION));}
_tweakExistingGroups(params){const groups=this.existingGroups;this._populateExistingGroups(params);const fullGroupBy=params.groupBy[0];const groupBy=fullGroupBy.split(":")[0];const groupByField=this.data[params.model].fields[groupBy];const records=this.data[params.model].records;for(const g of groups){const recordsInGroup=records.filter((r)=>{if(["date","datetime"].includes(groupByField.type)){return r[groupBy]===serializeGroupDateValue(g[fullGroupBy],groupByField);}else if(groupByField.type==="many2one"){return(!r[groupBy]&&!g[fullGroupBy])||r[groupBy]===g[fullGroupBy][0];}
return r[groupBy]===g[fullGroupBy];});for(const aggregateSpec of params.aggregates||[]){if(aggregateSpec==="__count"){g.__count=recordsInGroup.length;continue;}
const[fieldName,func]=aggregateSpec.split(":");if(func==="array_agg"){g[aggregateSpec]=recordsInGroup.map((r)=>r[fieldName]);}else if(["integer, float","monetary"].includes(this.data[params.model].fields[fieldName].type)){g[aggregateSpec]=recordsInGroup.reduce((acc,r)=>acc+r[fieldName],0);}}}}}
SampleServer.FORMATS={day:"yyyy-MM-dd",week:"'W'WW kkkk",month:"MMMM yyyy",quarter:"'Q'q yyyy",year:"y",};SampleServer.INTERVALS={day:(dt)=>dt.plus({days:1}),week:(dt)=>dt.plus({weeks:1}),month:(dt)=>dt.plus({months:1}),quarter:(dt)=>dt.plus({months:3}),year:(dt)=>dt.plus({years:1}),};SampleServer.DISPLAY_FORMATS=Object.assign({},SampleServer.FORMATS,{day:"dd MMM yyyy"});SampleServer.MAIN_RECORDSET_SIZE=16;SampleServer.SUB_RECORDSET_SIZE=5;SampleServer.SEARCH_READ_LIMIT=10;SampleServer.MAX_FLOAT=100;SampleServer.MAX_INTEGER=50;SampleServer.MAX_COLOR_INT=7;SampleServer.MAX_MONETARY=100000;SampleServer.DATE_DELTA=24*60;SampleServer.FLOAT_PRECISION=2;SampleServer.SAMPLE_COUNTRIES=["Belgium","France","Portugal","Singapore","Australia"];SampleServer.SAMPLE_PEOPLE=["John Miller","Henry Campbell","Carrie Helle","Wendi Baltz","Thomas Passot",];SampleServer.SAMPLE_TEXTS=["Laoreet id","Volutpat blandit","Integer vitae","Viverra nam","In massa",];SampleServer.PEOPLE_MODELS=["res.users","res.partner","hr.employee","mail.followers","mailing.contact",];SampleServer.UnimplementedRouteError=UnimplementedRouteError;__exports.buildSampleORM=buildSampleORM;function buildSampleORM(resModel,fields,user){const sampleServer=new SampleServer(resModel,fields);const fakeRPC=async(_,params)=>{const{args,kwargs,method,model}=params;const{groupby:groupBy}=kwargs;return sampleServer.mockRpc({method,model,args,...kwargs,groupBy});};const sampleORM=new ORM(user);sampleORM.rpc=fakeRPC;sampleORM.isSample=true;sampleORM.cache=()=>sampleORM;sampleORM.setGroups=(groups)=>sampleServer.setExistingGroups(groups);return sampleORM;}
return __exports;});;

/* /web/static/src/search/action_hook.js */
odoo.define('@web/search/action_hook',['@odoo/owl'],function(require){'use strict';let __exports={};const{onMounted,useComponent,useEffect,useExternalListener}=require("@odoo/owl");const scrollSymbol=__exports.scrollSymbol=Symbol("scroll");const CallbackRecorder=__exports.CallbackRecorder=class CallbackRecorder{constructor(){this.setup();}
setup(){this._callbacks=[];}
get callbacks(){return this._callbacks.map(({callback})=>callback);}
add(owner,callback){if(!callback){throw new Error("Missing callback");}
this._callbacks.push({owner,callback});}
remove(owner){this._callbacks=this._callbacks.filter((s)=>s.owner!==owner);}}
__exports.useCallbackRecorder=useCallbackRecorder;function useCallbackRecorder(callbackRecorder,callback){const component=useComponent();useEffect(()=>{callbackRecorder.add(component,callback);return()=>callbackRecorder.remove(component);},()=>[]);}
__exports.useSetupAction=useSetupAction;function useSetupAction(params={}){const component=useComponent();const{__beforeLeave__,__getGlobalState__,__getLocalState__,__getContext__,__getOrderBy__,}=component.env;const{beforeVisibilityChange,beforeUnload,beforeLeave,getGlobalState,getLocalState,rootRef,}=params;if(beforeVisibilityChange){useExternalListener(document,"visibilitychange",beforeVisibilityChange);}
if(beforeUnload){useExternalListener(window,"beforeunload",beforeUnload);}
if(__beforeLeave__&&beforeLeave){useCallbackRecorder(__beforeLeave__,beforeLeave);}
if(__getGlobalState__&&(getGlobalState||rootRef)){useCallbackRecorder(__getGlobalState__,()=>{const state={};if(getGlobalState){Object.assign(state,getGlobalState());}
return state;});}
function setScrollFromState(){const{state}=component.props;const scrolling=state&&state[scrollSymbol];if(scrolling){if(component.env.isSmall){rootRef.el.scrollTop=(scrolling.root&&scrolling.root.top)||0;rootRef.el.scrollLeft=(scrolling.root&&scrolling.root.left)||0;}else if(scrolling.content){const contentEl=rootRef.el.querySelector(".o_component_with_search_panel > .o_renderer_with_searchpanel,"+".o_component_with_search_panel > .o_renderer")||rootRef.el.querySelector(".o_content");if(contentEl){contentEl.scrollTop=scrolling.content.top||0;contentEl.scrollLeft=scrolling.content.left||0;}}}}
if(__getLocalState__&&(getLocalState||rootRef)){useCallbackRecorder(__getLocalState__,()=>{const state={};if(getLocalState){Object.assign(state,getLocalState());}
if(rootRef){if(component.env.isSmall){state[scrollSymbol]={root:{left:rootRef.el.scrollLeft,top:rootRef.el.scrollTop},};}else{const contentEl=rootRef.el.querySelector(".o_component_with_search_panel > .o_renderer_with_searchpanel,"+".o_component_with_search_panel > .o_renderer")||rootRef.el.querySelector(".o_content");if(contentEl){state[scrollSymbol]={content:{left:contentEl.scrollLeft,top:contentEl.scrollTop},};}}}
return state;});if(rootRef){onMounted(()=>setScrollFromState());}}
if(__getContext__&&params.getContext){useCallbackRecorder(__getContext__,params.getContext);}
if(__getOrderBy__&&params.getOrderBy){useCallbackRecorder(__getOrderBy__,params.getOrderBy);}
return{setScrollFromState,};}
return __exports;});;

/* /web/static/src/search/action_menus/action_menus.js */
odoo.define('@web/search/action_menus/action_menus',['@web/core/browser/browser','@web/core/context','@web/session','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_item','@web/core/l10n/translation','@web/core/utils/hooks','@odoo/owl'],function(require){'use strict';let __exports={};const{browser}=require("@web/core/browser/browser");const{makeContext}=require("@web/core/context");const{session}=require("@web/session");const{Dropdown}=require("@web/core/dropdown/dropdown");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web",...args);const{useService}=require("@web/core/utils/hooks");const{Component,onWillStart,onWillUpdateProps,useState}=require("@odoo/owl");const STATIC_ACTIONS_GROUP_NUMBER=__exports.STATIC_ACTIONS_GROUP_NUMBER=1;const ACTIONS_GROUP_NUMBER=__exports.ACTIONS_GROUP_NUMBER=100;const ActionMenus=__exports.ActionMenus=class ActionMenus extends Component{static template="web.ActionMenus";static components={Dropdown,DropdownItem,};static props={getActiveIds:Function,context:Object,resModel:String,printDropdownTitle:{type:String,optional:true},domain:{type:Array,optional:true},isDomainSelected:{type:Boolean,optional:true},items:{type:Object,shape:{action:{type:Array,optional:true},print:{type:Array,optional:true},},},onActionExecuted:{type:Function,optional:true},shouldExecuteAction:{type:Function,optional:true},loadExtraPrintItems:{type:Function,optional:true},};static defaultProps={printDropdownTitle:_t("Print"),onActionExecuted:()=>{},shouldExecuteAction:()=>true,loadExtraPrintItems:()=>[],};setup(){this.orm=useService("orm");this.actionService=useService("action");this.state=useState({printItems:[]})
onWillStart(async()=>{this.actionItems=await this.getActionItems(this.props);});onWillUpdateProps(async(nextProps)=>{this.actionItems=await this.getActionItems(nextProps);});}
async getActionItems(props){return(props.items.action||[]).map((action)=>{if(action.callback){return Object.assign({key:`action-${action.description}`,groupNumber:ACTIONS_GROUP_NUMBER},action);}else{return{action,description:action.name,key:action.id,groupNumber:action.groupNumber||ACTIONS_GROUP_NUMBER,};}});}
async executeAction(action){let activeIds=this.props.getActiveIds();if(this.props.isDomainSelected){activeIds=await this.orm.search(this.props.resModel,this.props.domain,{limit:session.active_ids_limit,context:this.props.context,});}
const activeIdsContext={active_id:activeIds[0],active_ids:activeIds,active_model:this.props.resModel,};if(this.props.domain){activeIdsContext.active_domain=this.props.domain;}
const context=makeContext([this.props.context,activeIdsContext]);return this.actionService.doAction(action.id,{additionalContext:context,onClose:this.props.onActionExecuted,});}
async onItemSelected(item){if(!(await this.props.shouldExecuteAction(item))){return;}
if(item.callback){item.callback([item]);}else if(item.action){this.executeAction(item.action);}else if(item.url){browser.location=item.url;}}
async loadAvailablePrintItems(){const printActions=this.props.items.print||[];const actionWithDomainIds=[];const validActionIds=[];for(const action of printActions){"domain"in action?actionWithDomainIds.push(action.id):validActionIds.push(action.id);}
if(actionWithDomainIds.length){const validActionsWithDomainIds=await this.orm.call("ir.actions.report","get_valid_action_reports",[actionWithDomainIds,this.props.resModel,this.props.getActiveIds()]);validActionIds.push(...validActionsWithDomainIds);}
return printActions.filter((action)=>validActionIds.includes(action.id)).map((action)=>({action,class:"o_menu_item",description:action.name,key:action.id,}));}
async loadPrintItems(){if(!this.props.items.print?.length){return;}
const[items,extraItems]=await Promise.all([this.loadAvailablePrintItems(),this.props.loadExtraPrintItems(),]);const allItems=[...extraItems,...items];if(!allItems.length){allItems.push({description:_t("No report available."),class:"o_menu_item disabled",key:"nothing_to_display",});}
this.state.printItems=allItems;}}
return __exports;});;

/* /web/static/src/search/breadcrumbs/breadcrumbs.js */
odoo.define('@web/search/breadcrumbs/breadcrumbs',['@odoo/owl','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_item','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const{Dropdown}=require("@web/core/dropdown/dropdown");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web",...args);const Breadcrumbs=__exports.Breadcrumbs=class Breadcrumbs extends Component{static template="web.Breadcrumbs";static components={Dropdown,DropdownItem};static props={breadcrumbs:Array,slots:{type:Object,optional:true},};getBreadcrumbTooltip({isFormView,name}){if(isFormView){return _t("Back to %s form",name);}
return _t("Back to %s",name);}}
return __exports;});;

/* /web/static/src/search/cog_menu/cog_menu.js */
odoo.define('@web/search/cog_menu/cog_menu',['@web/core/registry','@web/core/dropdown/dropdown','@web/search/action_menus/action_menus','@web/core/l10n/translation','@odoo/owl'],function(require){'use strict';let __exports={};const{registry}=require("@web/core/registry");const{Dropdown}=require("@web/core/dropdown/dropdown");const{ActionMenus}=require("@web/search/action_menus/action_menus");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web",...args);const{onWillStart,onWillUpdateProps}=require("@odoo/owl");const cogMenuRegistry=registry.category("cogMenu");const CogMenu=__exports.CogMenu=class CogMenu extends ActionMenus{static template="web.CogMenu";static components={...ActionMenus.components,Dropdown,};static props={...ActionMenus.props,getActiveIds:{type:ActionMenus.props.getActiveIds,optional:true},context:{type:ActionMenus.props.context,optional:true},resModel:{type:ActionMenus.props.resModel,optional:true},items:{...ActionMenus.props.items,optional:true},slots:{type:Object,optional:true},};static defaultProps={...ActionMenus.defaultProps,items:{},};setup(){super.setup();onWillStart(async()=>{this.registryItems=await this._registryItems();});onWillUpdateProps(async()=>{this.registryItems=await this._registryItems();});}
get hasItems(){return this.cogItems.length||this.props.items.print?.length;}
async _registryItems(){const registryItems=cogMenuRegistry.getAll();const areDisplayed=await Promise.all(registryItems.map((item)=>("isDisplayed"in item?item.isDisplayed(this.env):true)));const items=[];for(let i=0;i<registryItems.length;i++){if(areDisplayed[i]){const item=registryItems[i];items.push({Component:item.Component,groupNumber:item.groupNumber,key:item.Component.name,});}}
return items;}
get cogItems(){return[...this.registryItems,...this.actionItems].sort((item1,item2)=>(item1.groupNumber||0)-(item2.groupNumber||0));}
getPrintItemAriaLabel(item){return _t("Print report: %s",item.description);}}
return __exports;});;

/* /web/static/src/search/control_panel/control_panel.js */
odoo.define('@web/search/control_panel/control_panel',['@web/core/l10n/translation','@web/core/browser/browser','@web/core/hotkeys/hotkey_service','@web/core/pager/pager','@web/core/utils/hooks','@web/core/dropdown/dropdown','@web/core/commands/command_hook','@web/core/dropdown/dropdown_item','@web/core/hotkeys/hotkey_hook','@web/core/utils/sortable_owl','@web/core/user','@web/core/dropdown/accordion_item','@web/core/checkbox/checkbox','@web/core/context','@web/core/confirmation_dialog/confirmation_dialog','@web/core/transition','@web/search/breadcrumbs/breadcrumbs','@web/search/search_bar/search_bar','@odoo/owl'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web",...args);const{browser}=require("@web/core/browser/browser");const{getActiveHotkey}=require("@web/core/hotkeys/hotkey_service");const{Pager}=require("@web/core/pager/pager");const{useService}=require("@web/core/utils/hooks");const{Dropdown}=require("@web/core/dropdown/dropdown");const{useCommand}=require("@web/core/commands/command_hook");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{useHotkey}=require("@web/core/hotkeys/hotkey_hook");const{useSortable}=require("@web/core/utils/sortable_owl");const{user}=require("@web/core/user");const{AccordionItem}=require("@web/core/dropdown/accordion_item");const{CheckBox}=require("@web/core/checkbox/checkbox");const{makeContext}=require("@web/core/context");const{ConfirmationDialog}=require("@web/core/confirmation_dialog/confirmation_dialog");const{Transition}=require("@web/core/transition");const{Breadcrumbs}=require("@web/search/breadcrumbs/breadcrumbs");const{SearchBar}=require("@web/search/search_bar/search_bar");const{Component,useState,onMounted,useRef,useEffect}=require("@odoo/owl");const STICKY_CLASS="o_mobile_sticky";class EmbeddedActionsConfigHandler{constructor(parentActionId,currentActiveId,parentResModel,ormService){this.parentActionId=parentActionId;this.currentActiveId=currentActiveId;this.parentResModel=parentResModel;this.embeddedActionsKey=`${this.parentActionId}+${this.currentActiveId || ""}`;this.embeddedActionsConfig=user.settings.embedded_actions_config_ids||{};this.orm=ormService;}
setEmbeddedActionsConfig(config){if(this.embeddedActionsKey in this.embeddedActionsConfig){Object.assign(this.embeddedActionsConfig[this.embeddedActionsKey],config);}else{this.embeddedActionsConfig[this.embeddedActionsKey]=config;}
this.orm.call("res.users.settings","set_embedded_actions_setting",[user.settings.id,this.parentActionId,this.currentActiveId,config,]);}
getEmbeddedActionsConfig(key){return this.embeddedActionsConfig[this.embeddedActionsKey]?.[key];}
hasEmbeddedActionsConfig(){return this.embeddedActionsKey in this.embeddedActionsConfig;}
async fetchEmbeddedActionsConfig(){return await this.orm.call("res.users.settings","get_embedded_actions_settings",[user.settings.id],{context:{res_model:this.parentResModel,res_id:this.currentActiveId}});}
updateEmbeddedActionsConfig(newSettings){for(const key in newSettings){this.embeddedActionsConfig[key]=newSettings[key];}}}
const ControlPanel=__exports.ControlPanel=class ControlPanel extends Component{static template="web.ControlPanel";static components={Pager,SearchBar,Dropdown,DropdownItem,Breadcrumbs,AccordionItem,CheckBox,Transition,};static props={display:{type:Object,optional:true},slots:{type:Object,optional:true},};setup(){this.actionService=useService("action");this.pagerProps=this.env.config.pagerProps?useState(this.env.config.pagerProps):undefined;this.notificationService=useService("notification");this.breadcrumbs=useState(this.env.config.breadcrumbs);this.orm=useService("orm");this.dialogService=useService("dialog");this.root=useRef("root");this.newActionNameRef=useRef("newActionNameRef");this.defaultEmbeddedActions=this.env.config.embeddedActions;if(this.env.config.embeddedActions?.length>0&&!this.env.config.parentActionId){const{parent_res_model,parent_action_id}=this.env.config.embeddedActions[0];this.defaultEmbeddedActions=[{id:false,name:this.env.config?.actionName,parent_action_id,parent_res_model,action_id:parent_action_id,user_id:false,context:{},},...this.env.config.embeddedActions,];this.env.config.setEmbeddedActions(this.defaultEmbeddedActions);}
const parentActionId=this.env.config.parentActionId||this.env.config.embeddedActions?.[0]?.parent_action_id[0]||this.env.config.embeddedActions?.[0]?.parent_action_id||"";const currentActiveId=this.env.searchModel?.globalContext.active_id||false;this.embeddedActionsConfigHandler=new EmbeddedActionsConfigHandler(parentActionId,currentActiveId,this.currentEmbeddedAction?.parent_res_model,this.orm);this.state=useState({embeddedInfos:{showEmbedded:!!this.embeddedActionsConfigHandler.getEmbeddedActionsConfig("embedded_visibility"),embeddedActions:this.defaultEmbeddedActions||[],newActionIsShared:false,newActionName:this.newActionNameGetter,visibleEmbeddedActions:this.embeddedActionsConfigHandler.getEmbeddedActionsConfig("embedded_actions_visibility")||[],currentEmbeddedAction:this.currentEmbeddedAction,},});this.onScrollThrottledBound=this.onScrollThrottled.bind(this);const{viewSwitcherEntries,viewType}=this.env.config;for(const view of viewSwitcherEntries||[]){useCommand(_t("Show %s view",view.name),()=>this.switchView(view.type),{category:"view_switcher",isAvailable:()=>view.type!==viewType,});}
if(viewSwitcherEntries?.length>1){useHotkey("alt+shift+v",()=>{this.cycleThroughViews();},{bypassEditableProtection:true,withOverlay:()=>this.root.el.querySelector("nav.o_cp_switch_buttons"),});}
useEffect(()=>{if(!this.env.isSmall||("adaptToScroll"in this.display&&!this.display.adaptToScroll)){return;}
const scrollingEl=this.getScrollingElement();this.scrollingElementResizeObserver.observe(scrollingEl);scrollingEl.addEventListener("scroll",this.onScrollThrottledBound);this.root.el.style.top="0px";this.scrollingElementHeight=scrollingEl.scrollHeight;return()=>{this.scrollingElementResizeObserver.unobserve(scrollingEl);scrollingEl.removeEventListener("scroll",this.onScrollThrottledBound);};});useEffect((el,showEmbedded)=>{const timer=setTimeout(()=>{if(showEmbedded&&this.state.embeddedInfos.visibleEmbeddedActions.length===1){el.querySelector(".btn[name='openEmbeddedActions']")?.click();}},100);return()=>clearTimeout(timer);},()=>[this.root.el,this.state.embeddedInfos.showEmbedded]);onMounted(()=>{if(this.state.embeddedInfos.embeddedActions?.length>0){const embeddedOrder=this.embeddedActionsConfigHandler.getEmbeddedActionsConfig("embedded_actions_order");if(embeddedOrder){this._sortEmbeddedActions(embeddedOrder);}}
if(!this.env.isSmall||("adaptToScroll"in this.display&&!this.display.adaptToScroll)){return;}
this.oldScrollTop=0;this.lastScrollTop=0;this.initialScrollTop=this.getScrollingElement().scrollTop;});useSortable({enable:true,ref:this.root,elements:".o_draggable",cursor:"move",delay:200,tolerance:10,onWillStartDrag:(params)=>this._sortEmbeddedActionStart(params),onDrop:(params)=>this._sortEmbeddedActionDrop(params),});}
scrollingElementResizeObserver=new ResizeObserver((entries)=>{for(const entry of entries){if(this.scrollingElementHeight!==entry.target.scrollingElementHeight){this.oldScrollTop+=entry.target.scrollingElementHeight-this.scrollingElementHeight;this.scrollingElementHeight=entry.target.scrollingElementHeight;}}});getDropdownClass(action){return(!this.env.isSmall&&this._isEmbeddedActionVisible(action))||(this.env.isSmall&&this.state.embeddedInfos.currentEmbeddedAction?.id===action.id)?"selected":"";}
getScrollingElement(){return this.root.el.parentElement;}
get currentEmbeddedAction(){if(!this.env.config){return{};}
const{currentEmbeddedActionId}=this.env.config;return(this.defaultEmbeddedActions?.find(({id})=>id===currentEmbeddedActionId)||this.defaultEmbeddedActions?.[0]);}
get newActionNameGetter(){if(this.currentEmbeddedAction?.name){return _t("Custom %s",this.currentEmbeddedAction.name);}else{return _t("Custom Embedded Action");}}
get display(){return{layoutActions:true,...this.props.display,};}
async onClickShowEmbedded(){if(!this.state.embeddedInfos.showEmbedded&&!this.embeddedActionsConfigHandler.hasEmbeddedActionsConfig()){const embeddedSettings=await this.embeddedActionsConfigHandler.fetchEmbeddedActionsConfig();if(this.embeddedActionsConfigHandler.embeddedActionsKey in embeddedSettings){this.embeddedActionsConfigHandler.updateEmbeddedActionsConfig(embeddedSettings);this.state.embeddedInfos.visibleEmbeddedActions=this.embeddedActionsConfigHandler.getEmbeddedActionsConfig("embedded_actions_visibility")||[];const embeddedOrder=this.embeddedActionsConfigHandler.getEmbeddedActionsConfig("embedded_actions_order");if(embeddedOrder){this._sortEmbeddedActions(embeddedOrder);}
this.embeddedActionsConfigHandler.setEmbeddedActionsConfig({embedded_visibility:true,});}else{const config={res_model:this.state.embeddedInfos.currentEmbeddedAction.parent_res_model,embedded_actions_visibility:[],embedded_visibility:true,embedded_actions_order:[],};if(this.state.embeddedInfos.embeddedActions?.length>0){const embeddedActionKey=this.state.embeddedInfos.currentEmbeddedAction?.id||false;if(!this.state.embeddedInfos.visibleEmbeddedActions.includes(embeddedActionKey)){this.state.embeddedInfos.visibleEmbeddedActions.push(embeddedActionKey);config.embedded_actions_visibility=this.state.embeddedInfos.visibleEmbeddedActions;}}
this.embeddedActionsConfigHandler.setEmbeddedActionsConfig(config);}}else{this.embeddedActionsConfigHandler.setEmbeddedActionsConfig({embedded_visibility:!this.state.embeddedInfos.showEmbedded,});}
this.state.embeddedInfos.showEmbedded=!this.state.embeddedInfos.showEmbedded;}
onScrollThrottled(){if(this.isScrolling){return;}
this.isScrolling=true;browser.requestAnimationFrame(()=>(this.isScrolling=false));const scrollTop=this.getScrollingElement().scrollTop;const delta=Math.round(scrollTop-this.oldScrollTop);if(scrollTop>this.initialScrollTop){this.root.el.classList.add(STICKY_CLASS);if(delta<=0){this.lastScrollTop=Math.min(0,this.lastScrollTop-delta);}else{this.lastScrollTop=Math.max(-this.root.el.offsetHeight,-this.root.el.offsetTop-delta);}
this.root.el.style.top=`${this.lastScrollTop}px`;}else{this.root.el.classList.remove(STICKY_CLASS);this.lastScrollTop=0;}
this.oldScrollTop=scrollTop;}
switchView(viewType,newWindow){this.actionService.switchView(viewType,{},{newWindow});}
cycleThroughViews(){const currentViewType=this.env.config.viewType;const viewSwitcherEntries=this.env.config.viewSwitcherEntries;const currentIndex=viewSwitcherEntries.findIndex((entry)=>entry.type===currentViewType);const nextIndex=(currentIndex+1)%viewSwitcherEntries.length;this.switchView(viewSwitcherEntries[nextIndex].type);}
onMainButtonsKeydown(ev){const hotkey=getActiveHotkey(ev);if(hotkey==="arrowdown"){this.env.searchModel.trigger("focus-view");ev.preventDefault();ev.stopPropagation();}}
_isEmbeddedActionVisible(action){return this.state.embeddedInfos.visibleEmbeddedActions.includes(action.id);}
_setVisibility(actionId){if(this.state.embeddedInfos.visibleEmbeddedActions.includes(actionId)){const embeddedActionIndex=this.state.embeddedInfos.visibleEmbeddedActions.indexOf(actionId);if(embeddedActionIndex!==-1){this.state.embeddedInfos.visibleEmbeddedActions.splice(embeddedActionIndex,1);}}else{this.state.embeddedInfos.visibleEmbeddedActions.push(actionId);}
this.embeddedActionsConfigHandler.setEmbeddedActionsConfig({embedded_actions_visibility:this.state.embeddedInfos.visibleEmbeddedActions,});}
_onShareCheckboxChange(){this.state.embeddedInfos.newActionIsShared=!this.state.embeddedInfos.newActionIsShared;}
async _saveNewAction(ev){const{newActionName,newActionIsShared,embeddedActions,currentEmbeddedAction,visibleEmbeddedActions,}=this.state.embeddedInfos;if(!newActionName){this.notificationService.add(_t("A name for your new action is required."),{type:"danger",});ev.stopPropagation();return this.newActionNameRef.el.focus();}
const duplicateName=embeddedActions.some(({name})=>name===newActionName);if(duplicateName){this.notificationService.add(_t("An action with the same name already exists."),{type:"danger",});ev.stopPropagation();return this.newActionNameRef.el.focus();}
const userId=newActionIsShared?false:user.userId;const{parent_action_id,action_id,parent_res_model,python_method,domain,context,groups_ids,}=currentEmbeddedAction;const values={parent_action_id:parent_action_id[0],parent_res_model,parent_res_id:this.env.searchModel.globalContext.active_id,user_id:userId,is_deletable:true,default_view_mode:this.env.config.viewType,domain,context,groups_ids,name:newActionName,};if(python_method){values.python_method=python_method;}else{values.action_id=action_id[0]||this.env.config.actionId;}
const embeddedActionId=await this.orm.create("ir.embedded.actions",[values]);const description=`${newActionName}`;this.env.searchModel.createNewFavorite({description,isDefault:true,isShared:newActionIsShared,embeddedActionId:embeddedActionId[0],});Object.assign(this.state.embeddedInfos,{newActionName:"",newActionIsShared:false,});const enrichedNewEmbeddedAction={...values,parent_action_id,action_id,id:embeddedActionId[0],};this.state.embeddedInfos.embeddedActions.push(enrichedNewEmbeddedAction);const embeddedActionResId=embeddedActionId[0];visibleEmbeddedActions.push(embeddedActionResId);const order=this.state.embeddedInfos.embeddedActions.map((el)=>el.id);this.embeddedActionsConfigHandler.setEmbeddedActionsConfig({embedded_actions_visibility:visibleEmbeddedActions,embedded_actions_order:order,});this.env.config.setCurrentEmbeddedAction(embeddedActionId);this.state.embeddedInfos.currentEmbeddedAction=enrichedNewEmbeddedAction;this.state.embeddedInfos.newActionName=`${newActionName} Custom`;}
openConfirmationDialog(action){const dialogProps={title:_t("Warning"),body:action.user_id?_t("Are you sure that you want to remove this embedded action?"):_t("This embedded action is global and will be removed for everyone."),confirmLabel:_t("Delete"),confirm:async()=>await this._deleteEmbeddedAction(action),cancel:()=>{},};this.dialogService.add(ConfirmationDialog,dialogProps);}
async _deleteEmbeddedAction(action){const{visibleEmbeddedActions,embeddedActions,currentEmbeddedAction}=this.state.embeddedInfos;const embeddedActionIndex=visibleEmbeddedActions.indexOf(action.id);if(embeddedActionIndex!==-1){visibleEmbeddedActions.splice(embeddedActionIndex,1);}
this.state.embeddedInfos.embeddedActions=embeddedActions.filter(({id})=>id!==action.id);const order=this.state.embeddedInfos.embeddedActions.map((el)=>el.id);this.embeddedActionsConfigHandler.setEmbeddedActionsConfig({embedded_actions_visibility:visibleEmbeddedActions,embedded_actions_order:order,});await this.orm.unlink("ir.embedded.actions",[action.id]);if(action.id===currentEmbeddedAction?.id){const{active_id,active_model}=this.env.searchModel.globalContext;const actionContext=action.context?makeContext([action.context]):{};const additionalContext={...actionContext,active_id,active_model,};this.actionService.doAction(action.parent_action_id[0]||action.parent_action_id,{additionalContext,stackPosition:"replaceCurrentAction",});}}
async onEmbeddedActionClick(action){this.env.config.setEmbeddedActions(this.state.embeddedInfos.embeddedActions);const{active_id,active_model}=this.env.searchModel.globalContext;const actionContext=action.context?makeContext([action.context]):{};const context={...actionContext,active_id,active_model,current_embedded_action_id:action.id,parent_action_embedded_actions:this.state.embeddedInfos.embeddedActions,parent_action_id:action.parent_action_id[0]||action.parent_action_id,};this.actionService.doActionButton({type:action.python_method?"object":"action",resId:this.env.searchModel?.globalContext.active_id,name:action.python_method||action.action_id[0]||action.action_id,resModel:action.parent_res_model,context,stackPosition:"replaceCurrentAction",viewType:action.default_view_mode,},{isEmbeddedAction:true});}
_sortEmbeddedActions(order){this.state.embeddedInfos.embeddedActions=this.state.embeddedInfos.embeddedActions.sort((a,b)=>{const indexA=order.indexOf(a.id);if(!indexA){return-1;}
const indexB=order.indexOf(b.id);if(!indexB){return 1;}
return indexA-indexB;});}
_sortEmbeddedActionStart({element,addClass}){addClass(element,"o_dragged_embedded_action");}
_sortEmbeddedActionDrop({element,previous}){const order=this.state.embeddedInfos.embeddedActions.map((el)=>el.id);const elementId=Number(element.dataset.id)||false;const elementIndex=order.indexOf(elementId);order.splice(elementIndex,1);if(previous){const prevIndex=order.indexOf(Number(previous.dataset.id)||false);order.splice(prevIndex+1,0,elementId);}else{order.splice(0,0,elementId);}
this._sortEmbeddedActions(order);this.embeddedActionsConfigHandler.setEmbeddedActionsConfig({embedded_actions_order:order,});}
dropdownifyButtons(){const adaptiveMenu=document.querySelector(".o-control-panel-adaptive-dropdown.dropdown-menu");const meaningfulElements=this.getBoxedElements(adaptiveMenu.children);for(const el of meaningfulElements){el.classList.add("dropdown-item");el.classList.remove("btn");}}
getBoxedElements(elements){const boxed=[];for(const el of[...elements]){const elStyles=el.ownerDocument.defaultView.getComputedStyle(el);if(elStyles.getPropertyValue("display")==="contents"){boxed.push(...this.getBoxedElements(el.children));}else if(elStyles.getPropertyValue("display")==="none"){continue;}else{boxed.push(el);}}
return boxed;}}
return __exports;});;

/* /web/static/src/search/custom_favorite_item/custom_favorite_item.js */
odoo.define('@web/search/custom_favorite_item/custom_favorite_item',['@web/core/l10n/translation','@web/core/dropdown/accordion_item','@web/core/checkbox/checkbox','@web/core/registry','@web/core/utils/hooks','@odoo/owl'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web",...args);const{AccordionItem}=require("@web/core/dropdown/accordion_item");const{CheckBox}=require("@web/core/checkbox/checkbox");const{registry}=require("@web/core/registry");const{useService}=require("@web/core/utils/hooks");const{Component,useRef,useState}=require("@odoo/owl");const favoriteMenuRegistry=registry.category("favoriteMenu");const CustomFavoriteItem=__exports.CustomFavoriteItem=class CustomFavoriteItem extends Component{static template="web.CustomFavoriteItem";static components={CheckBox,AccordionItem};static props={};setup(){this.actionService=useService("action");this.notificationService=useService("notification");this.descriptionRef=useRef("description");this.state=useState({description:this.env.config.getDisplayName(),isDefault:false,});}
async saveFavorite(ev,isShared=false){if(!this.state.description){this.notificationService.add(_t("A name for your favorite filter is required."),{type:"danger",});ev.stopPropagation();this.descriptionRef.el.focus();return false;}
const{description,isDefault}=this.state;const embeddedActionId=this.env.config.currentEmbeddedActionId||false;const serverSideId=await this.env.searchModel.createNewFavorite({description,isDefault,isShared,embeddedActionId,});Object.assign(this.state,{description:this.env.config.getDisplayName(),isDefault:false,});return serverSideId;}
async editFavorite(ev){const serverSideId=await this.saveFavorite(ev);if(!serverSideId){return;}
this.actionService.doAction({type:"ir.actions.act_window",res_model:"ir.filters",views:[[false,"form"]],context:{form_view_ref:"base.ir_filters_view_edit_form",},res_id:serverSideId,});}
onInputKeydown(ev){switch(ev.key){case"Enter":ev.preventDefault();this.saveFavorite(ev);break;case"Escape":ev.preventDefault();ev.target.blur();break;}}}
favoriteMenuRegistry.add("custom-favorite-item",{Component:CustomFavoriteItem,groupNumber:3},{sequence:0});return __exports;});;

/* /web/static/src/search/custom_group_by_item/custom_group_by_item.js */
odoo.define('@web/search/custom_group_by_item/custom_group_by_item',['@odoo/owl'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const CustomGroupByItem=__exports.CustomGroupByItem=class CustomGroupByItem extends Component{static template="web.CustomGroupByItem";static props={fields:Array,onAddCustomGroup:Function,};get choices(){return this.props.fields.map((f)=>({label:f.string,value:f.name}));}
onSelected(ev){if(ev.target.value){this.props.onAddCustomGroup(ev.target.value);ev.target.value="";}}}
return __exports;});;

/* /web/static/src/search/layout.js */
odoo.define('@web/search/layout',['@odoo/owl','@web/search/control_panel/control_panel','@web/search/search_panel/search_panel'],function(require){'use strict';let __exports={};const{Component,useRef}=require("@odoo/owl");const{ControlPanel}=require("@web/search/control_panel/control_panel");const{SearchPanel}=require("@web/search/search_panel/search_panel");__exports.extractLayoutComponents=extractLayoutComponents;function extractLayoutComponents(params){const layoutComponents={ControlPanel:params.ControlPanel||ControlPanel,SearchPanel:params.SearchPanel||SearchPanel,};return layoutComponents;}
const Layout=__exports.Layout=class Layout extends Component{static template="web.Layout";static props={className:{type:String,optional:true},display:{type:Object,optional:true},slots:{type:Object,optional:true},};static defaultProps={display:{},};setup(){this.components=extractLayoutComponents(this.env.config);this.contentRef=useRef("content");}
get controlPanelSlots(){const slots={...this.props.slots};if(this.env.inDialog){delete slots["layout-buttons"];}
delete slots.default;return slots;}}
return __exports;});;

/* /web/static/src/search/pager_hook.js */
odoo.define('@web/search/pager_hook',['@odoo/owl'],function(require){'use strict';let __exports={};const{useEnv,useSubEnv,useState,onWillRender}=require("@odoo/owl");__exports.usePager=usePager;function usePager(getProps){const env=useEnv();const pagerState=useState({});useSubEnv({config:{...env.config,pagerProps:pagerState,},});onWillRender(()=>{Object.assign(pagerState,getProps()||{total:0});});}
return __exports;});;

/* /web/static/src/search/properties_group_by_item/properties_group_by_item.js */
odoo.define('@web/search/properties_group_by_item/properties_group_by_item',['@web/core/dropdown/accordion_item','@web/core/dropdown/checkbox_item','@web/core/dropdown/dropdown_item','@odoo/owl'],function(require){'use strict';let __exports={};const{AccordionItem,ACCORDION}=require("@web/core/dropdown/accordion_item");const{CheckboxItem}=require("@web/core/dropdown/checkbox_item");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{Component,useState,useChildSubEnv}=require("@odoo/owl");const PropertiesGroupByItem=__exports.PropertiesGroupByItem=class PropertiesGroupByItem extends Component{static template="web.PropertiesGroupByItem";static components={AccordionItem,CheckboxItem,DropdownItem};static props={item:Object,onGroup:Function,};setup(){this.state=useState({groupByItems:[]});useChildSubEnv({[ACCORDION]:{accordionStateChanged:this.beforeOpen.bind(this),},});}
get isActive(){return this.state.groupByItems.some((item)=>item.isActive);}
get isSingleParent(){const uniqueNames=new Set(this.state.groupByItems.map((item)=>item.definitionRecordId));return uniqueNames.size<2;}
async beforeOpen(){if(this.definitionLoaded){return;}
this.definitionLoaded=true;await this.env.searchModel.fillSearchViewItemsProperty();this._updateGroupByItems();}
onGroup(ids){this.props.onGroup(ids);this._updateGroupByItems();}
_updateGroupByItems(){this.state.groupByItems=this.env.searchModel.getSearchItems((searchItem)=>["groupBy","dateGroupBy"].includes(searchItem.type)&&searchItem.isProperty&&searchItem.propertyFieldName===this.props.item.fieldName);}}
return __exports;});;

/* /web/static/src/search/search_arch_parser.js */
odoo.define('@web/search/search_arch_parser',['@web/core/context','@web/core/l10n/translation','@web/core/py_js/py','@web/core/utils/numbers','@web/core/utils/xml','@web/search/utils/dates'],function(require){'use strict';let __exports={};const{makeContext}=require("@web/core/context");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web",...args);const{evaluateBooleanExpr,evaluateExpr}=require("@web/core/py_js/py");const{clamp}=require("@web/core/utils/numbers");const{visitXML}=require("@web/core/utils/xml");const{DEFAULT_INTERVAL,toGeneratorId}=require("@web/search/utils/dates");const ALL=_t("All");const DEFAULT_LIMIT=200;const DEFAULT_VIEWS_WITH_SEARCH_PANEL=["kanban","list"];function getContextGroupBy(context){try{return makeContext([context]).group_by?.split(":")||[];}catch{return[];}}
function reduceType(type){if(type==="dateFilter"){return"filter";}
if(type==="dateGroupBy"){return"groupBy";}
return type;}
const SearchArchParser=__exports.SearchArchParser=class SearchArchParser{constructor(searchViewDescription,fields,searchDefaults={},searchPanelDefaults={}){const{irFilters,arch}=searchViewDescription;this.fields=fields||{};this.irFilters=irFilters||[];this.arch=arch||"<search/>";this.labels=[];this.preSearchItems=[];this.searchPanelInfo={className:"",viewTypes:DEFAULT_VIEWS_WITH_SEARCH_PANEL,};this.sections=[];this.searchDefaults=searchDefaults;this.searchPanelDefaults=searchPanelDefaults;this.currentGroup=[];this.currentTag=null;this.groupNumber=0;this.pregroupOfGroupBys=[];this.optionsParams=null;}
parse(){visitXML(this.arch,(node,visitChildren)=>{switch(node.tagName){case"search":this.visitSearch(node,visitChildren);break;case"searchpanel":return this.visitSearchPanel(node);case"group":this.visitGroup(node,visitChildren);break;case"separator":this.visitSeparator();break;case"field":this.visitField(node);break;case"filter":if(this.optionsParams){this.visitDateOption(node);}else{this.visitFilter(node,visitChildren);}
break;}});return{labels:this.labels,preSearchItems:this.preSearchItems,searchPanelInfo:this.searchPanelInfo,sections:this.sections,};}
pushGroup(tag=null){if(this.currentGroup.length){if(this.currentTag==="groupBy"){this.pregroupOfGroupBys.push(...this.currentGroup);}else{this.preSearchItems.push(this.currentGroup);}}
this.currentTag=tag;this.currentGroup=[];this.groupNumber++;}
visitField(node){this.pushGroup("field");const preField={type:"field"};if(node.hasAttribute("invisible")){preField.invisible=node.getAttribute("invisible");}
if(node.hasAttribute("domain")){preField.domain=node.getAttribute("domain");}
if(node.hasAttribute("filter_domain")){preField.filterDomain=node.getAttribute("filter_domain");}else if(node.hasAttribute("operator")){preField.operator=node.getAttribute("operator");}
if(node.hasAttribute("context")){preField.context=node.getAttribute("context");}
if(node.hasAttribute("name")){const name=node.getAttribute("name");if(!this.fields[name]){throw Error(`Unknown field ${name}`);}
const fieldType=this.fields[name].type;preField.fieldName=name;preField.fieldType=fieldType;if(fieldType!=="properties"&&name in this.searchDefaults){preField.isDefault=true;const val=this.searchDefaults[name];const value=Array.isArray(val)?val[0]:val;let operator=preField.operator;if(!operator){let type=fieldType;if(node.hasAttribute("widget")){type=node.getAttribute("widget");}
if(["char","html","many2many","one2many","text"].includes(type)){operator="ilike";}else{operator="=";}}
preField.defaultRank=-10;const{selection,context,relation}=this.fields[name];preField.defaultAutocompleteValue={label:`${value}`,operator,value};if(fieldType==="selection"){const option=selection.find((sel)=>sel[0]===value);if(!option){throw Error();}
preField.defaultAutocompleteValue.label=option[1];}else if(fieldType==="many2one"){this.labels.push((orm)=>orm.call(relation,"read",[value,["display_name"]],{context}).then((results)=>{preField.defaultAutocompleteValue.label=results[0]["display_name"];}));}else if(["many2many","one2many"].includes(fieldType)&&Array.isArray(val)&&val.every((v)=>Number.isInteger(v)&&v>0)){preField.defaultAutocompleteValue.operator="in";preField.defaultAutocompleteValue.value=val;this.labels.push((orm)=>orm.call(relation,"read",[val,["display_name"]],{context}).then((results)=>{preField.defaultAutocompleteValue.label=`${results
                                    .map((r) => r["display_name"])
                                    .join(" or ")}`;}));}}}else{throw Error();}
if(node.hasAttribute("string")){preField.description=node.getAttribute("string");}else if(preField.fieldName){preField.description=this.fields[preField.fieldName].string;}else{preField.description="";}
this.currentGroup.push(preField);}
visitFilter(node,visitChildren){const preSearchItem={type:"filter"};if(node.hasAttribute("context")){const context=node.getAttribute("context");const[fieldName,defaultInterval]=getContextGroupBy(context);const groupByField=this.fields[fieldName];if(groupByField){preSearchItem.type="groupBy";preSearchItem.fieldName=fieldName;preSearchItem.fieldType=groupByField.type;if(["date","datetime"].includes(groupByField.type)){preSearchItem.type="dateGroupBy";preSearchItem.defaultIntervalId=defaultInterval||DEFAULT_INTERVAL;}}else{preSearchItem.context=context;}}
if(reduceType(preSearchItem.type)!==this.currentTag){this.pushGroup(reduceType(preSearchItem.type));}
if(preSearchItem.type==="filter"){if(node.hasAttribute("date")){const fieldName=node.getAttribute("date");preSearchItem.type="dateFilter";preSearchItem.fieldName=fieldName;preSearchItem.fieldType=this.fields[fieldName].type;const optionsParams={startYear:Number(node.getAttribute("start_year")||-2),endYear:Number(node.getAttribute("end_year")||0),startMonth:Number(node.getAttribute("start_month")||-2),endMonth:Number(node.getAttribute("end_month")||0),customOptions:[],};const defaultOffset=clamp(optionsParams.startMonth,optionsParams.endMonth,0);preSearchItem.defaultGeneratorIds=[toGeneratorId("month",defaultOffset)];if(node.hasAttribute("default_period")){preSearchItem.defaultGeneratorIds=node.getAttribute("default_period").split(",");}
this.optionsParams=optionsParams;visitChildren();preSearchItem.optionsParams=optionsParams;this.optionsParams=null;}
preSearchItem.domain=node.getAttribute("domain")||"[]";}
if(node.hasAttribute("invisible")){preSearchItem.invisible=node.getAttribute("invisible");const fieldName=preSearchItem.fieldName;if(fieldName&&!this.fields[fieldName]){return;}}
preSearchItem.groupNumber=this.groupNumber;if(node.hasAttribute("name")){const name=node.getAttribute("name");preSearchItem.name=name;if(name in this.searchDefaults){preSearchItem.isDefault=true;const value=this.searchDefaults[name];if(["groupBy","dateGroupBy"].includes(preSearchItem.type)){preSearchItem.defaultRank=typeof value==="number"?value:100;}else{preSearchItem.defaultRank=-5;}
if(preSearchItem.type==="dateFilter"&&typeof value==="string"&&!/^(true|1)$/i.test(value)){preSearchItem.defaultGeneratorIds=value.split(",");}}}
if(node.hasAttribute("string")){preSearchItem.description=node.getAttribute("string");}else if(preSearchItem.fieldName){preSearchItem.description=this.fields[preSearchItem.fieldName].string;}else if(node.hasAttribute("help")){preSearchItem.description=node.getAttribute("help");}else if(node.hasAttribute("name")){preSearchItem.description=node.getAttribute("name");}else{preSearchItem.description="";}
this.currentGroup.push(preSearchItem);}
visitDateOption(node){const preDateOption={type:"dateOption"};for(const attribute of["name","string","domain"]){if(!node.getAttribute(attribute)){throw new Error(`Attribute "${attribute}" is missing.`);}}
preDateOption.id=`custom_${node.getAttribute("name")}`;preDateOption.description=node.getAttribute("string");preDateOption.domain=node.getAttribute("domain");this.optionsParams.customOptions.push(preDateOption);}
visitGroup(node,visitChildren){this.pushGroup();visitChildren();this.pushGroup();}
visitSearch(node,visitChildren){visitChildren();this.pushGroup();if(this.pregroupOfGroupBys.length){this.preSearchItems.push(this.pregroupOfGroupBys);}}
visitSearchPanel(searchPanelNode){let hasCategoryWithCounters=false;let hasFilterWithDomain=false;let nextSectionId=1;if(searchPanelNode.hasAttribute("class")){this.searchPanelInfo.className=searchPanelNode.getAttribute("class");}
if(searchPanelNode.hasAttribute("view_types")){this.searchPanelInfo.viewTypes=searchPanelNode.getAttribute("view_types").split(",");}
for(const node of searchPanelNode.children){if(node.nodeType!==1||node.tagName!=="field"){continue;}
if(node.getAttribute("invisible")==="True"||node.getAttribute("invisible")==="1"){continue;}
const attrs={};for(const attrName of node.getAttributeNames()){attrs[attrName]=node.getAttribute(attrName);}
const type=attrs.select==="multi"?"filter":"category";const section={color:attrs.color||null,description:attrs.string||this.fields[attrs.name].string,enableCounters:evaluateBooleanExpr(attrs.enable_counters),expand:evaluateBooleanExpr(attrs.expand),fieldName:attrs.name,icon:attrs.icon||null,id:nextSectionId++,limit:evaluateExpr(attrs.limit||String(DEFAULT_LIMIT)),type,values:new Map(),};if(type==="category"){section.activeValueId=this.searchPanelDefaults[attrs.name];section.icon=section.icon||"fa-folder";section.hierarchize=evaluateBooleanExpr(attrs.hierarchize||"1");section.depth=attrs.depth?parseInt(attrs.depth):0;section.values.set(false,{childrenIds:[],display_name:ALL.toString(),id:false,bold:true,parentId:false,});hasCategoryWithCounters=hasCategoryWithCounters||section.enableCounters;}else{section.domain=attrs.domain||"[]";section.groupBy=attrs.groupby||null;section.icon=section.icon||"fa-filter";hasFilterWithDomain=hasFilterWithDomain||section.domain!=="[]";}
this.sections.push([section.id,section]);}
if(hasCategoryWithCounters&&hasFilterWithDomain){for(const section of this.sections){if(section.type==="category"){section.enableCounters=false;}}
console.warn("Warning: categories with counters are incompatible with filters having a domain attribute.","All category counters have been disabled to avoid inconsistencies.");}
return false;}
visitSeparator(){this.pushGroup();}}
return __exports;});;

/* /web/static/src/search/search_bar/search_bar.js */
odoo.define('@web/search/search_bar/search_bar',['@web/core/domain','@web/core/l10n/dates','@web/core/registry','@web/core/utils/concurrency','@web/core/utils/hooks','@web/core/domain_selector_dialog/domain_selector_dialog','@web/core/utils/search','@web/core/l10n/translation','@web/search/search_bar_menu/search_bar_menu','@odoo/owl','@web/core/dropdown/dropdown_hooks','@web/core/browser/feature_detection','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_item','@web/core/navigation/navigation'],function(require){'use strict';let __exports={};const{Domain}=require("@web/core/domain");const{serializeDate,serializeDateTime}=require("@web/core/l10n/dates");const{registry}=require("@web/core/registry");const{KeepLast}=require("@web/core/utils/concurrency");const{useAutofocus,useBus,useChildRef,useService}=require("@web/core/utils/hooks");const{DomainSelectorDialog}=require("@web/core/domain_selector_dialog/domain_selector_dialog");const{fuzzyTest}=require("@web/core/utils/search");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web",...args);const{SearchBarMenu}=require("@web/search/search_bar_menu/search_bar_menu");const{Component,status,useRef,useState}=require("@odoo/owl");const{useDropdownState}=require("@web/core/dropdown/dropdown_hooks");const{hasTouch}=require("@web/core/browser/feature_detection");const{Dropdown}=require("@web/core/dropdown/dropdown");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{useNavigation}=require("@web/core/navigation/navigation");const parsers=registry.category("parsers");const parseValue=(value,fieldType)=>{const parser=parsers.contains(fieldType)?parsers.get(fieldType):(str)=>str;switch(fieldType){case"date":{return serializeDate(parser(value));}
case"datetime":{return serializeDateTime(parser(value));}
case"many2one":{return value;}
default:{return parser(value);}}};const CHAR_FIELDS=["char","html","many2many","many2one","one2many","text","properties"];const FOLDABLE_TYPES=["properties","many2one","many2many"];let nextItemId=1;const SUB_ITEMS_DEFAULT_LIMIT=8;const SearchBar=__exports.SearchBar=class SearchBar extends Component{static template="web.SearchBar";static components={SearchBarMenu,Dropdown,DropdownItem,};static props={autofocus:{type:Boolean,optional:true},slots:{type:Object,optional:true,shape:{default:{optional:true},"search-bar-additional-menu":{optional:true},},},toggler:{type:Object,optional:true,},};static defaultProps={autofocus:true,};setup(){this.dialogService=useService("dialog");this.fields=this.env.searchModel.searchViewFields;this.searchItemsFields=this.env.searchModel.getSearchItems((f)=>f.type==="field");this.root=useRef("root");this.ui=useService("ui");this.visibilityState=useState(this.props.toggler?.state||{showSearchBar:true});this.state=useState({expanded:[],query:"",subItemsLimits:{},});this.items=useState([]);this.subItems={};this.facetContainerRef=useRef("facetContainerRef");this.menuRef=useChildRef();this.setupFacetNavigation();this.inputDropdownState=useDropdownState();this.inputDropdownNavOptions=this.getDropdownNavigation();this.searchBarDropdownState=useDropdownState();this.orm=useService("orm");this.keepLast=new KeepLast();this.inputRef=this.env.config.disableSearchBarAutofocus||!this.props.autofocus?useRef("autofocus"):useAutofocus({mobile:this.ui.isSmall});useBus(this.env.searchModel,"focus-search",()=>{this.inputRef.el.focus();});useBus(this.env.searchModel,"update",this.render);}
getSearchItem(id){return this.env.searchModel.searchItems[id];}
async computeState(options={}){const query="query"in options?options.query:this.state.query;const expanded="expanded"in options?options.expanded:this.state.expanded;const subItems="subItems"in options?options.subItems:this.subItems;const tasks=[];for(const id of expanded){const searchItem=this.getSearchItem(id);if(searchItem.type==="field"&&searchItem.fieldType==="properties"){tasks.push({id,prom:this.getSearchItemsProperties(searchItem)});}else if(!subItems[id]){if(!this.state.subItemsLimits[id]){this.state.subItemsLimits[id]=SUB_ITEMS_DEFAULT_LIMIT;}
tasks.push({id,prom:this.computeSubItems(searchItem,query)});}}
const prom=this.keepLast.add(Promise.all(tasks.map((task)=>task.prom)));if(tasks.length){const taskResults=await prom;tasks.forEach((task,index)=>{subItems[task.id]=taskResults[index];});}
this.state.expanded=expanded;this.state.query=query;this.subItems=subItems;this.inputRef.el.value=query;const trimmedQuery=this.state.query.trim();this.items.length=0;if(!trimmedQuery){return;}
for(const searchItem of this.searchItemsFields){this.items.push(...this.getItems(searchItem,trimmedQuery));}
this.items.push({title:_t("Add a custom filter"),isAddCustomFilterButton:true,});}
getItems(searchItem,trimmedQuery){const items=[];const isFieldProperty=searchItem.type==="field_property";const fieldType=this.getFieldType(searchItem);let preposition=this.getPreposition(searchItem);if((isFieldProperty&&FOLDABLE_TYPES.includes(fieldType))||fieldType==="properties"){preposition=null;}
if(["boolean","tags"].includes(fieldType)||(isFieldProperty&&fieldType==="selection")){const booleanOptions=[[true,_t("Yes")],[false,_t("No")],];let options;if(isFieldProperty){const{selection,tags}=searchItem.propertyFieldDefinition||{};options=selection||tags||booleanOptions;}else{options=booleanOptions;}
for(const[value,label]of options){if(fuzzyTest(trimmedQuery.toLowerCase(),label.toLowerCase())){items.push({id:nextItemId++,fieldType,searchItemDescription:searchItem.description,preposition,searchItemId:searchItem.id,label,operator:searchItem.operator||"=",value,isFieldProperty,});}}
return items;}
let value;try{value=parseValue(trimmedQuery,fieldType);}catch{return[];}
const item={id:nextItemId++,fieldType,searchItemDescription:searchItem.description,preposition,searchItemId:searchItem.id,label:this.state.query,operator:searchItem.operator||(CHAR_FIELDS.includes(fieldType)?"ilike":"="),value,isFieldProperty,};if(isFieldProperty){item.isParent=FOLDABLE_TYPES.includes(fieldType);item.unselectable=FOLDABLE_TYPES.includes(fieldType);item.propertyItemId=searchItem.propertyItemId;}else if(fieldType==="properties"){item.isParent=true;item.unselectable=true;}else if(fieldType==="many2one"||fieldType==="selection"){item.isParent=true;}
if(item.isParent){item.isExpanded=this.state.expanded.includes(item.searchItemId);}
items.push(item);if(item.isExpanded){if(searchItem.type==="field"&&searchItem.fieldType==="properties"){for(const subItem of this.subItems[searchItem.id]){items.push(...this.getItems(subItem,trimmedQuery));}}else{items.push(...this.subItems[searchItem.id]);}}
return items;}
getPreposition(searchItem){const fieldType=this.getFieldType(searchItem);return["date","datetime"].includes(fieldType)?_t("at"):_t("for");}
getFieldType(searchItem){const{type}=searchItem.type==="field_property"?searchItem.propertyFieldDefinition:this.fields[searchItem.fieldName];const fieldType=type==="reference"?"char":type;return fieldType;}
getSearchItemsProperties(searchItem){return this.env.searchModel.getSearchItemsProperties(searchItem);}
async computeSubItems(searchItem,query){const field=this.fields[searchItem.fieldName];let options=[];let showLoadMore=false;if(searchItem.fieldType==="selection"){options=field.selection.filter(([_,label])=>fuzzyTest(query.toLowerCase(),label.toLowerCase()));}else{let domain=[];if(searchItem.domain){const domainEvalContext={...this.env.searchModel.domainEvalContext,...field.context,};domain=new Domain(searchItem.domain).toList(domainEvalContext);}
const relation=searchItem.type==="field_property"?searchItem.propertyFieldDefinition.comodel:field.relation;const limitToFetch=this.state.subItemsLimits[searchItem.id]+1;options=await this.orm.call(relation,"name_search",[],{domain:domain,context:{...this.env.searchModel.globalContext,...field.context},limit:limitToFetch,name:query.trim(),});if(options.length===limitToFetch){options.pop();showLoadMore=true;}}
const subItems=[];if(options.length){const operator=searchItem.operator||"=";for(const[value,label]of options){subItems.push({id:nextItemId++,isChild:true,searchItemId:searchItem.id,value,label,operator,});}
if(showLoadMore){subItems.push({id:nextItemId++,isChild:true,searchItemId:searchItem.id,label:_t("Load more"),unselectable:true,loadMore:()=>{this.state.subItemsLimits[searchItem.id]+=SUB_ITEMS_DEFAULT_LIMIT;const newSubItems=[...this.subItems];newSubItems[searchItem.id]=undefined;this.computeState({subItems:newSubItems});},});}}else{subItems.push({id:nextItemId++,isChild:true,searchItemId:searchItem.id,label:_t("(no result)"),unselectable:true,});}
return subItems;}
focusFacet(index){const facets=this.root.el.getElementsByClassName("o_searchview_facet");if(facets.length){if(index===undefined){facets[facets.length-1].focus();}else{facets[index].focus();}}}
removeFacet(facet){this.env.searchModel.deactivateGroup(facet.groupId);this.inputRef.el.focus();}
resetState(options={focus:true}){this.state.subItemsLimits={};this.computeState({expanded:[],query:"",subItems:[]});if(options.focus){this.inputRef.el.focus();}}
selectItem(item){if(item.isAddCustomFilterButton){return this.env.searchModel.spawnCustomFilterDialog();}
const searchItem=this.getSearchItem(item.searchItemId);if((searchItem.fieldType==="selection"&&!item.isChild)||(searchItem.type==="field"&&searchItem.fieldType==="properties")||(searchItem.type==="field_property"&&item.unselectable)){this.toggleItem(item,!item.isExpanded);return;}
if(!item.unselectable){const{searchItemId,fieldType,operator}=item;let{label,value}=item;if(!["selection","boolean","tags"].includes(fieldType)&&this.state.query!==label&&!item.isChild){label=this.state.query;value=parseValue(this.state.query.trim(),fieldType);}
this.env.searchModel.addAutoCompletionValues(searchItemId,{label,operator,value});}
if(item.loadMore){item.loadMore();}else{this.inputDropdownState.close();this.resetState();}}
toggleItem(item,shouldExpand){const id=item.searchItemId;const expanded=[...this.state.expanded];const index=expanded.findIndex((id0)=>id0===id);if(shouldExpand===true){if(index<0){expanded.push(id);}}else{if(index>=0){expanded.splice(index,1);}}
this.computeState({expanded});}
setupFacetNavigation(){const isFacet=(target)=>target&&target.classList.contains("o_searchview_facet");useNavigation(this.facetContainerRef,{shouldFocusChildInput:false,getItems:()=>{if(this.root.el&&this.inputRef.el){return[...this.root.el.querySelectorAll(":scope .o_searchview_facet"),this.inputRef.el,];}
return[];},hotkeys:{enter:{isAvailable:()=>!this.inputDropdownState.isOpen,callback:()=>this.env.searchModel.search(),},arrowdown:{callback:()=>this.env.searchModel.trigger("focus-view"),},backspace:{bypassEditableProtection:true,allowRepeat:false,isAvailable:({target})=>isFacet(target)||(target.selectionStart===0&&target.selectionEnd===0),callback:(navigator)=>{const facets=this.env.searchModel.facets;if(isFacet(navigator.activeItem.el)){this.removeFacet(facets[navigator.activeItemIndex]);}else if(facets.length>0){this.removeFacet(facets[facets.length-1]);}},},arrowright:{bypassEditableProtection:true,allowRepeat:false,isAvailable:({target})=>isFacet(target)||target.selectionStart===this.state.query.length,callback:(navigator)=>{navigator.next();if(navigator.activeItem.el===this.inputRef.el){this.inputRef.el.setSelectionRange(0,0);}},},arrowleft:{bypassEditableProtection:true,isAvailable:({target})=>isFacet(target)||target.selectionStart===0,callback:(navigator)=>{navigator.previous();if(navigator.activeItem.el===this.inputRef.el){const inputLength=this.inputRef.el.value.length;this.inputRef.el.setSelectionRange(inputLength,inputLength);}},},},});}
getDropdownNavigation(){const isExpansible=(index)=>{const item=this.items[index];return item&&item.isParent;};const isCollapsible=(index)=>{const item=this.items[index];return(item&&((item.isParent&&item.isExpanded)||item.isChild||item.isFieldProperty));};return{virtualFocus:true,getItems:()=>this.menuRef.el?.querySelectorAll(":scope .o-dropdown-item")??[],isNavigationAvailable:({navigator,target})=>this.inputDropdownState.isOpen&&(this.facetContainerRef.el?.contains(target)||navigator.contains(target)),onUpdated:(navigator)=>(this.navigator=navigator),onItemActivated:(itemEl)=>(this.lastActiveItemId=parseInt(itemEl.id,10)),hotkeys:{escape:{callback:()=>{this.inputDropdownState.close();this.resetState();},},arrowright:{bypassEditableProtection:true,allowRepeat:false,isAvailable:({navigator})=>isExpansible(navigator.activeItemIndex),callback:(navigator)=>{const item=this.items[navigator.activeItemIndex];if(item.isParent){if(item.isExpanded){navigator.next();}else{this.toggleItem(item,true);}}},},arrowleft:{bypassEditableProtection:true,isAvailable:({navigator})=>isCollapsible(navigator.activeItemIndex),callback:(navigator)=>{const item=this.items[navigator.activeItemIndex];const findIndex=(id)=>this.items.findIndex((item)=>item.isParent&&item.searchItemId===id);if(item&&item.isParent&&item.isExpanded){this.toggleItem(item,false);}else if(item&&item.isChild){navigator.items[findIndex(item.searchItemId)]?.setActive();}else if(item&&item.isFieldProperty){navigator.items[findIndex(item.propertyItemId)]?.setActive();}else if(this.inputRef.el.selectionStart===0){navigator.items[this.env.searchModel.facets.length-1]?.setActive();}},},},};}
onFacetLabelClick(target,facet){const{domain,groupId}=facet;if(this.env.searchModel.canOrderByCount&&facet.type==="groupBy"){this.env.searchModel.switchGroupBySort();return;}else if(!domain){return;}
const{resModel}=this.env.searchModel;this.dialogService.add(DomainSelectorDialog,{resModel,domain,context:this.env.searchModel.domainEvalContext,onConfirm:(nextDomain)=>{if(nextDomain!==domain){this.env.searchModel.splitAndAddDomain(nextDomain,groupId);}},disableConfirmButton:(domain)=>domain===`[]`,title:_t("Custom Filter"),confirmButtonText:_t("Search"),discardButtonText:_t("Discard"),isDebugMode:this.env.searchModel.isDebugMode,});}
onFacetRemove(facet){this.removeFacet(facet);}
onSearchClick(){if(!hasTouch()){if(!this.inputRef.el.value.length){this.searchBarDropdownState.open();}else{this.inputDropdownState.open();}}}
onSearchInput(ev){if(!hasTouch()){this.searchBarDropdownState.close();}
const query=ev.target.value;if(query.trim()){if(!ev.isComposing){this.inputDropdownState.open();}
this.computeState({query,expanded:[],subItems:[]});}else if(this.items.length){this.inputDropdownState.close();this.resetState();}}
onCompositionEnd(ev){const query=ev.target.value;if(query.trim()){this.inputDropdownState.open();}}
onClickSearchIcon(){if(!this.state.query.length){this.env.searchModel.search();}else{const item=this.items.find((item)=>item.id===this.lastActiveItemId);if(item){this.selectItem(item);}}}
onToggleSearchBar(){this.state.showSearchBar=!this.state.showSearchBar;}
onInputDropdownChanged(isOpen){if(!isOpen&&status(this)==="mounted"){this.resetState({focus:false});}else if(this.navigator){this.navigator.items[0]?.setActive();}}}
return __exports;});;

/* /web/static/src/search/search_bar/search_bar_toggler.js */
odoo.define('@web/search/search_bar/search_bar_toggler',['@odoo/owl','@web/core/browser/browser','@web/core/utils/hooks','@web/core/utils/timing'],function(require){'use strict';let __exports={};const{Component,useEffect,useState}=require("@odoo/owl");const{browser}=require("@web/core/browser/browser");const{useService}=require("@web/core/utils/hooks");const{useDebounced}=require("@web/core/utils/timing");const SearchBarToggler=__exports.SearchBarToggler=class SearchBarToggler extends Component{static template="web.SearchBar.Toggler";static props={isSmall:Boolean,showSearchBar:Boolean,toggleSearchBar:Function,};}
__exports.useSearchBarToggler=useSearchBarToggler;function useSearchBarToggler(){const ui=useService("ui");let isToggled=false;const state=useState({isSmall:ui.isSmall,showSearchBar:false,});const updateState=()=>{state.isSmall=ui.isSmall;state.showSearchBar=!ui.isSmall||isToggled;};updateState();function toggleSearchBar(){isToggled=!isToggled;updateState();}
const onResize=useDebounced(updateState,200);useEffect(()=>{browser.addEventListener("resize",onResize);return()=>browser.removeEventListener("resize",onResize);},()=>[]);return{state,component:SearchBarToggler,get props(){return{isSmall:state.isSmall,showSearchBar:state.showSearchBar,toggleSearchBar,};},};}
return __exports;});;

/* /web/static/src/search/search_bar_menu/search_bar_menu.js */
odoo.define('@web/search/search_bar_menu/search_bar_menu',['@odoo/owl','@web/core/dropdown/dropdown','@web/search/properties_group_by_item/properties_group_by_item','@web/core/dropdown/dropdown_item','@web/core/registry','@web/core/utils/arrays','@web/core/utils/hooks','@web/core/dropdown/accordion_item','@web/search/custom_group_by_item/custom_group_by_item','@web/core/dropdown/checkbox_item','@web/search/utils/misc'],function(require){'use strict';let __exports={};const{Component,useState}=require("@odoo/owl");const{Dropdown}=require("@web/core/dropdown/dropdown");const{PropertiesGroupByItem}=require("@web/search/properties_group_by_item/properties_group_by_item");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{registry}=require("@web/core/registry");const{sortBy}=require("@web/core/utils/arrays");const{useBus,useService}=require("@web/core/utils/hooks");const{AccordionItem}=require("@web/core/dropdown/accordion_item");const{CustomGroupByItem}=require("@web/search/custom_group_by_item/custom_group_by_item");const{CheckboxItem}=require("@web/core/dropdown/checkbox_item");const{FACET_ICONS,GROUPABLE_TYPES}=require("@web/search/utils/misc");const favoriteMenuRegistry=registry.category("favoriteMenu");const SearchBarMenu=__exports.SearchBarMenu=class SearchBarMenu extends Component{static template="web.SearchBarMenu";static components={Dropdown,DropdownItem,CheckboxItem,CustomGroupByItem,AccordionItem,PropertiesGroupByItem,};static props={slots:{type:Object,optional:true,shape:{default:{optional:true},},},dropdownState:{...Dropdown.props.state},};setup(){this.facet_icons=FACET_ICONS;this.actionService=useService("action");const fields=[];for(const[fieldName,field]of Object.entries(this.env.searchModel.searchViewFields)){if(this.validateField(fieldName,field)){fields.push(Object.assign({name:fieldName},field));}}
this.fields=sortBy(fields,"string");this.state=useState({sharedFavoritesExpanded:false});useBus(this.env.searchModel,"update",this.render);}
get filterItems(){return this.env.searchModel.getSearchItems((searchItem)=>["filter","dateFilter"].includes(searchItem.type));}
async onAddCustomFilterClick(){this.env.searchModel.spawnCustomFilterDialog();}
onFilterSelected({itemId,optionId}){if(optionId){this.env.searchModel.toggleDateFilter(itemId,optionId);}else{this.env.searchModel.toggleSearchItem(itemId);}}
get hideCustomGroupBy(){return this.env.searchModel.hideCustomGroupBy||false;}
get groupByItems(){return this.env.searchModel.getSearchItems((searchItem)=>["groupBy","dateGroupBy"].includes(searchItem.type)&&!searchItem.isProperty);}
validateField(fieldName,field){const{groupable,type}=field;return groupable&&fieldName!=="id"&&GROUPABLE_TYPES.includes(type);}
onGroupBySelected({itemId,optionId}){if(optionId){this.env.searchModel.toggleDateGroupBy(itemId,optionId);}else{this.env.searchModel.toggleSearchItem(itemId);}}
onAddCustomGroup(fieldName){this.env.searchModel.createNewGroupBy(fieldName);}
get favorites(){return this.env.searchModel.getSearchItems((searchItem)=>searchItem.type==="favorite"&&searchItem.userIds.length===1);}
get sharedFavorites(){const sharedFavorites=this.env.searchModel.getSearchItems((searchItem)=>searchItem.type==="favorite"&&searchItem.userIds.length!==1);if(sharedFavorites.length<=4||this.state.sharedFavoritesExpanded){this.state.sharedFavoritesExpanded=true;}else{sharedFavorites.length=3;}
return sharedFavorites;}
get otherItems(){const registryMenus=[];for(const item of favoriteMenuRegistry.getAll()){if("isDisplayed"in item?item.isDisplayed(this.env):true){registryMenus.push({Component:item.Component,groupNumber:item.groupNumber,key:item.Component.name,});}}
return registryMenus;}
onFavoriteSelected(itemId){this.env.searchModel.toggleSearchItem(itemId);}
editFavorite(itemId){this.actionService.doAction({type:"ir.actions.act_window",res_model:"ir.filters",views:[[false,"form"]],context:{form_view_ref:"base.ir_filters_view_edit_form",},res_id:this.env.searchModel.searchItems[itemId].serverSideId,});}}
return __exports;});;

/* /web/static/src/search/search_model.js */
odoo.define('@web/search/search_model',['@odoo/owl','@web/core/context','@web/core/domain','@web/core/domain_selector/utils','@web/core/domain_selector_dialog/domain_selector_dialog','@web/core/l10n/translation','@web/core/network/rpc','@web/core/py_js/py','@web/core/tree_editor/domain_from_tree','@web/core/user','@web/core/utils/arrays','@web/core/utils/objects','@web/search/search_arch_parser','@web/search/utils/dates','@web/search/utils/misc'],function(require){'use strict';let __exports={};const{EventBus,toRaw}=require("@odoo/owl");const{makeContext}=require("@web/core/context");const{Domain}=require("@web/core/domain");const{getDefaultDomain}=require("@web/core/domain_selector/utils");const{DomainSelectorDialog}=require("@web/core/domain_selector_dialog/domain_selector_dialog");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web",...args);const{rpcBus}=require("@web/core/network/rpc");const{evaluateExpr}=require("@web/core/py_js/py");const{domainFromTree}=require("@web/core/tree_editor/domain_from_tree");const{user}=require("@web/core/user");const{groupBy,sortBy}=require("@web/core/utils/arrays");const{deepCopy}=require("@web/core/utils/objects");const{SearchArchParser}=require("@web/search/search_arch_parser");const{constructDateDomain,DEFAULT_INTERVAL,getIntervalOptions,getPeriodOptions,INTERVAL_OPTIONS,rankInterval,yearSelected,}=require("@web/search/utils/dates");const{FACET_COLORS,FACET_ICONS}=require("@web/search/utils/misc");const{DateTime}=luxon;const SPECIAL=Symbol("special");function hasValues(section){const{errorMsg,type,values}=section;if(errorMsg){return true;}
switch(type){case"category":{return values&&values.size>1;}
case"filter":{return values&&values.size>0;}}}
function mapToArray(map){const result=[];for(const[key,val]of map){const valCopy=Object.assign({},val);result.push([key,valCopy]);}
return result;}
function arraytoMap(array){return new Map(array);}
function execute(op,source,target){const{query,nextId,nextGroupId,nextGroupNumber,searchItems,searchPanelInfo,sections}=source;target.nextGroupId=nextGroupId;target.nextGroupNumber=nextGroupNumber;target.nextId=nextId;target.query=query;target.searchItems=searchItems;target.searchPanelInfo=searchPanelInfo;target.sections=op(sections);for(const[,section]of target.sections){section.values=op(section.values);if(section.groups){section.groups=op(section.groups);for(const[,group]of section.groups){group.values=op(group.values);}}}}
const FAVORITE_PRIVATE_GROUP=1;const FAVORITE_SHARED_GROUP=2;const SearchModel=__exports.SearchModel=class SearchModel extends EventBus{constructor(env,services,args){super();this.env=env;this.setup(services,args);}
setup(services){const{field:fieldService,orm,view,dialog,treeProcessor}=services;this.orm=orm;this.fieldService=fieldService;this.viewService=view;this.treeProcessor=treeProcessor;this.dialog=dialog;this.orderByCount=false;this.referenceMoment=DateTime.local();this.intervalOptions=getIntervalOptions();this.categoriesLoadId=0;this.filtersLoadId=0;}
async load(config){const{resModel}=config;if(!resModel){throw Error(`SearchModel config should have a "resModel" key`);}
this.resModel=resModel;this._reset();const{context,domain,groupBy,hideCustomGroupBy,orderBy}=config;this.globalContext=toRaw(Object.assign({},context));this.globalDomain=domain||[];this.globalGroupBy=groupBy||[];this.globalOrderBy=orderBy||[];this.hideCustomGroupBy=hideCustomGroupBy;this.searchMenuTypes=new Set(config.searchMenuTypes||["filter","groupBy","favorite"]);this.canOrderByCount=config.canOrderByCount;this.defaultGroupBy=config.defaultGroupBy;let{irFilters,loadIrFilters,searchViewArch,searchViewFields,searchViewId}=config;const loadSearchView=searchViewId!==undefined&&(!searchViewArch||!searchViewFields||(!irFilters&&loadIrFilters));const searchViewDescription={};if(loadSearchView){const result=await this.viewService.loadViews({context:this.globalContext,resModel,views:[[searchViewId,"search"]],},{actionId:this.env.config.actionId,embeddedActionId:this.env.config.currentEmbeddedActionId,loadIrFilters:loadIrFilters||false,});Object.assign(searchViewDescription,result.views.search);searchViewFields=searchViewFields||result.fields;}
if(searchViewArch){searchViewDescription.arch=searchViewArch;}
if(irFilters){searchViewDescription.irFilters=irFilters;}
if(searchViewId!==undefined){searchViewDescription.viewId=searchViewId;}
this.searchViewArch=searchViewDescription.arch||"<search/>";this.searchViewFields=searchViewFields||{};if(searchViewDescription.irFilters){this.irFilters=searchViewDescription.irFilters;}
if(searchViewDescription.viewId!==undefined){this.searchViewId=searchViewDescription.viewId;}
const{searchDefaults,searchPanelDefaults}=this._extractSearchDefaultsFromGlobalContext();if(config.state){this._importState(config.state);this.__legacyParseSearchPanelArchAnyway(searchViewDescription,searchViewFields);this.display=this._getDisplay(config.display);this._reconciliateFavorites();if(!this.searchPanelInfo.loaded){return this._reloadSections();}
return;}
this.blockNotification=true;this.searchItems={};this.query=[];this.nextId=1;this.nextGroupId=1;this.nextGroupNumber=1;const parser=new SearchArchParser(searchViewDescription,searchViewFields,searchDefaults,searchPanelDefaults);const{labels,preSearchItems,searchPanelInfo,sections}=parser.parse();this.searchPanelInfo={...searchPanelInfo,loaded:false,shouldReload:false};await Promise.all(labels.map((cb)=>cb(this.orm)));for(const preGroup of preSearchItems||[]){this._createGroupOfSearchItems(preGroup);}
this.nextGroupNumber=1+Math.max(...Object.values(this.searchItems).map((i)=>i.groupNumber||0),0);const{dynamicFilters}=config;if(dynamicFilters){this._createGroupOfDynamicFilters(dynamicFilters);}
const defaultFavoriteId=this._createGroupOfFavorites(this.irFilters||[]);const activateFavorite="activateFavorite"in config?config.activateFavorite:true;this._activateDefaultSearchItems(activateFavorite?defaultFavoriteId:null);this.sections=new Map(sections||[]);this.display=this._getDisplay(config.display);if(this.display.searchPanel){this.searchDomain=this._getDomain({withSearchPanel:false});this.sectionsPromise=this._fetchSections(this.categories,this.filters).then(()=>{for(const{fieldName,values}of this.filters){const filterDefaults=searchPanelDefaults[fieldName]||[];for(const valueId of filterDefaults){const value=values.get(valueId);if(value){value.checked=true;}}}});if(Object.keys(searchPanelDefaults).length||this._shouldWaitForData(false)){await this.sectionsPromise;}}
this.blockNotification=false;}
async reload(config={}){this._reset();const{context,domain,groupBy,orderBy}=config;this.globalContext=Object.assign({},context);this.globalDomain=domain||[];this.globalGroupBy=groupBy||[];this.globalOrderBy=orderBy||[];this._extractSearchDefaultsFromGlobalContext();await this._reloadSections();}
get categories(){return[...this.sections.values()].filter((s)=>s.type==="category");}
get context(){if(!this._context){this._context=makeContext([this.globalContext,this._getContext()]);}
return deepCopy(this._context);}
get domain(){if(!this._domain){this._domain=this._getDomain();}
return deepCopy(this._domain);}
get domainString(){return this._getDomain({raw:true}).toString();}
get domainEvalContext(){return Object.assign({},this.globalContext,user.context);}
get facets(){const facets=[];for(const facet of this._getFacets()){if(facet.type==="groupBy"&&!this.searchMenuTypes.has(facet.type)){continue;}
facets.push(facet);}
return facets;}
get filters(){return[...this.sections.values()].filter((s)=>s.type==="filter");}
get groupBy(){if(!this.searchMenuTypes.has("groupBy")){return[];}
if(!this._groupBy){this._groupBy=this._getGroupBy();}
return deepCopy(this._groupBy);}
get orderBy(){if(!this._orderBy){this._orderBy=this._getOrderBy();}
return deepCopy(this._orderBy);}
get isDebugMode(){return!!this.env.debug;}
addAutoCompletionValues(searchItemId,autocompleteValue){const searchItem=this.searchItems[searchItemId];if(!["field","field_property"].includes(searchItem.type)){return;}
const{label,value,operator}=autocompleteValue;const queryElem=this.query.find((queryElem)=>queryElem.searchItemId===searchItemId&&"autocompleteValue"in queryElem&&queryElem.autocompleteValue.value===value&&queryElem.autocompleteValue.operator===operator);if(!queryElem){this.query.push({searchItemId,autocompleteValue});}else{queryElem.autocompleteValue.label=label;}
this._notify();}
clearQuery(){this.query=[];this.orderByCount=false;this._notify();}
clearFilters(){this.blockNotification=true;this.facets.forEach((facet)=>{if(facet.type!=="groupBy"){this.deactivateGroup(facet.groupId);}});this.blockNotification=false;this._notify();}
async createNewFavorite(params){const{preFavorite,irFilter}=this._getIrFilterDescription(params);const serverSideId=await this._createIrFilters(irFilter);this.blockNotification=true;this.clearQuery();const favorite={...preFavorite,type:"favorite",id:this.nextId,groupId:this.nextGroupId,groupNumber:preFavorite.userIds.length===1?FAVORITE_PRIVATE_GROUP:FAVORITE_SHARED_GROUP,removable:true,serverSideId,};this.searchItems[this.nextId]=favorite;this.query.push({searchItemId:this.nextId});this.nextGroupId++;this.nextId++;this.blockNotification=false;this._notify();return serverSideId;}
async _createIrFilters(irFilter){const serverSideIds=await this.orm.call("ir.filters","create_filter",[irFilter]);rpcBus.trigger("CLEAR-CACHES","get_views");return serverSideIds[0];}
createNewFilters(prefilters){if(!prefilters.length){return[];}
prefilters.forEach((preFilter)=>{const filter=Object.assign(preFilter,{groupId:this.nextGroupId,groupNumber:this.nextGroupNumber,id:this.nextId,type:"filter",});this.searchItems[this.nextId]=filter;this.query.push({searchItemId:this.nextId});this.nextId++;});this.nextGroupId++;this.nextGroupNumber++;this._notify();}
createNewGroupBy(fieldName,{interval,invisible}={}){const field=this.searchViewFields[fieldName];const{string,type:fieldType}=field;const firstGroupBy=Object.values(this.searchItems).find((f)=>f.type==="groupBy");const preSearchItem={description:string||fieldName,fieldName,fieldType,groupId:firstGroupBy?firstGroupBy.groupId:this.nextGroupId++,groupNumber:this.nextGroupNumber,id:this.nextId,custom:true,};if(invisible){preSearchItem.invisible="True";}
if(["date","datetime"].includes(fieldType)){this.searchItems[this.nextId]=Object.assign({type:"dateGroupBy",defaultIntervalId:interval||DEFAULT_INTERVAL},preSearchItem);this.toggleDateGroupBy(this.nextId);}else{this.searchItems[this.nextId]=Object.assign({type:"groupBy"},preSearchItem);this.toggleSearchItem(this.nextId);}
this.nextGroupNumber++;this.nextId++;this._notify();}
deactivateGroup(groupId){if(groupId===SPECIAL){delete this.defaultGroupBy;this._notify();return;}
this.query=this.query.filter((queryElem)=>{const searchItem=this.searchItems[queryElem.searchItemId];return searchItem.groupId!==groupId;});this._checkOrderByCountStatus();this._notify();}
exportState(){const state={};execute(mapToArray,this,state);return state;}
getIrFilterValues(params){const{irFilter}=this._getIrFilterDescription(params);return irFilter;}
getPreFavoriteValues(params){const{preFavorite}=this._getIrFilterDescription(params);return preFavorite;}
getSearchItems(predicate){const searchItems=[];for(const searchItem of Object.values(this.searchItems)){const enrichedSearchitem=this._enrichItem(searchItem);if(enrichedSearchitem){const isInvisible="invisible"in searchItem&&evaluateExpr(searchItem.invisible,this.domainEvalContext);if(!isInvisible&&(!predicate||predicate(enrichedSearchitem))){searchItems.push(enrichedSearchitem);}}}
if(searchItems.some((f)=>f.type==="favorite")){searchItems.sort((f1,f2)=>f1.groupNumber-f2.groupNumber);}
return searchItems;}
getSections(predicate){let sections=[...this.sections.values()].map((section)=>Object.assign({},section,{empty:!hasValues(section)}));if(predicate){sections=sections.filter(predicate);}
return sections.sort((s1,s2)=>s1.index-s2.index);}
search(){this.trigger("update");}
async splitAndAddDomain(domain,groupId){const group=groupId?this._getGroups().find((g)=>g.id===groupId):null;let context;if(group){const contexts=[];for(const activeItem of group.activeItems){const context=this._getSearchItemContext(activeItem);if(context){contexts.push(context);}}
context=makeContext(contexts);}
const tree=await this.treeProcessor.treeFromDomain(this.resModel,domain,!this.isDebugMode);const trees=!tree.negate&&tree.type==="connector"&&tree.value==="&"&&tree.children.length>0?tree.children:[tree];const promises=trees.map(async(tree)=>{const[description,tooltip]=await Promise.all([this.treeProcessor.getDomainTreeDescription(this.resModel,tree),this.treeProcessor.getDomainTreeTooltip(this.resModel,tree),]);const preFilter={description,tooltip,domain:domainFromTree(tree),invisible:"True",type:"filter",};if(context){preFilter.context=context;}
return preFilter;});const preFilters=await Promise.all(promises);this.blockNotification=true;let queryItemIndex;if(group){const firstActiveItem=group.activeItems[0];const firstSearchItem=this.searchItems[firstActiveItem.searchItemId];queryItemIndex=this.query.findIndex((queryElem)=>queryElem.searchItemId===firstActiveItem.searchItemId);const{type}=firstSearchItem;if(type==="favorite"){const activeItemGroupBys=this._getSearchItemGroupBys(firstActiveItem);let createNewGroupBys=Boolean(activeItemGroupBys.length);if(createNewGroupBys&&this.defaultGroupBy&&this.env.config.viewType==="kanban"){const currentGroupBy=this._getGroupBy({fallbackOnDefault:false});if(JSON.stringify(currentGroupBy)===JSON.stringify(this.defaultGroupBy)){createNewGroupBys=false;}}
if(createNewGroupBys){for(const activeItemGroupBy of activeItemGroupBys){const[fieldName,interval]=activeItemGroupBy.split(":");this.createNewGroupBy(fieldName,{interval,invisible:true});}
const index=this.query.length-activeItemGroupBys.length;this.query=[...this.query.slice(index),...this.query.slice(0,index)];}}
this.deactivateGroup(groupId);}
const queryLength=this.query.length;for(const preFilter of preFilters){this.createNewFilters([preFilter]);}
const queryElems=this.query.slice(queryLength);if(queryItemIndex!==undefined){this.query=[...this.query.slice(0,queryItemIndex),...queryElems,...this.query.slice(queryItemIndex,queryLength),];}
this.blockNotification=false;this._notify();}
toggleCategoryValue(sectionId,valueId){const category=this.sections.get(sectionId);category.activeValueId=valueId;this._notify();}
toggleFilterValues(sectionId,valueIds,forceTo=null){const filter=this.sections.get(sectionId);for(const valueId of valueIds){const value=filter.values.get(valueId);value.checked=forceTo===null?!value.checked:forceTo;}
this._notify();}
clearSections(sectionIds){for(const sectionId of sectionIds){const section=this.sections.get(sectionId);if(section.type==="category"){section.activeValueId=false;}else{for(const[,value]of section.values){value.checked=false;}}}
this._notify();}
toggleSearchItem(searchItemId){const searchItem=this.searchItems[searchItemId];switch(searchItem.type){case"dateFilter":case"dateGroupBy":case"field_property":case"field":{return;}}
const index=this.query.findIndex((queryElem)=>queryElem.searchItemId===searchItemId);if(index>=0){this.query.splice(index,1);this._checkOrderByCountStatus();}else{if(searchItem.type==="favorite"){this.query=[];}
this.query.push({searchItemId});}
this._notify();}
toggleDateFilter(searchItemId,generatorId){const searchItem=this.searchItems[searchItemId];if(searchItem.type!=="dateFilter"){return;}
const generatorIds=generatorId?[generatorId]:searchItem.defaultGeneratorIds;for(const generatorId of generatorIds){const index=this.query.findIndex((queryElem)=>queryElem.searchItemId===searchItemId&&"generatorId"in queryElem&&queryElem.generatorId===generatorId);if(index>=0){this.query.splice(index,1);if(!yearSelected(this._getSelectedGeneratorIds(searchItemId))){this.query=this.query.filter((queryElem)=>queryElem.searchItemId!==searchItemId);}}else{if(generatorId.startsWith("custom")){this.query=this.query.filter((queryElem)=>searchItemId!==queryElem.searchItemId);this.query.push({searchItemId,generatorId});continue;}
this.query=this.query.filter((queryElem)=>queryElem.searchItemId!==searchItemId||!queryElem.generatorId.startsWith("custom"));this.query.push({searchItemId,generatorId});if(!yearSelected(this._getSelectedGeneratorIds(searchItemId))){const{defaultYearId}=getPeriodOptions(this.referenceMoment,searchItem.optionsParams).find((o)=>o.id===generatorId);this.query.push({searchItemId,generatorId:defaultYearId});}}}
this._notify();}
toggleDateGroupBy(searchItemId,intervalId){const searchItem=this.searchItems[searchItemId];if(searchItem.type!=="dateGroupBy"){return;}
intervalId=intervalId||searchItem.defaultIntervalId;const index=this.query.findIndex((queryElem)=>queryElem.searchItemId===searchItemId&&"intervalId"in queryElem&&queryElem.intervalId===intervalId);if(index>=0){this.query.splice(index,1);this._checkOrderByCountStatus();}else{this.query.push({searchItemId,intervalId});}
this._notify();}
async spawnCustomFilterDialog(){const domain=getDefaultDomain(this.searchViewFields);this.dialog.add(DomainSelectorDialog,{resModel:this.resModel,defaultConnector:"|",domain,context:this.globalContext,onConfirm:(domain)=>this.splitAndAddDomain(domain),disableConfirmButton:(domain)=>domain===`[]`,title:_t("Custom Filter"),confirmButtonText:_t("Search"),discardButtonText:_t("Discard"),isDebugMode:this.isDebugMode,});}
switchGroupBySort(){if(this.orderByCount==="Desc"){this.orderByCount="Asc";}else{this.orderByCount="Desc";}
this._notify();}
async getSearchItemsProperties(searchItem){if(searchItem.type!=="field"||searchItem.fieldType!=="properties"){return[];}
const field=this.searchViewFields[searchItem.fieldName];const definitionRecord=field.definition_record;const result=await this._fetchPropertiesDefinition(this.resModel,searchItem.fieldName);const searchItemIds=new Set();const existingFieldProperties={};for(const item of Object.values(this.searchItems)){if(item.type==="field_property"&&item.propertyItemId===searchItem.id){existingFieldProperties[item.propertyFieldDefinition.name]=item;}}
for(const{definitionRecordId,definitionRecordName,definitions}of result){for(const definition of definitions){if(definition.type==="separator"){continue;}
const existingSearchItem=existingFieldProperties[definition.name];if(existingSearchItem){existingSearchItem.description=`${definition.string} (${definitionRecordName})`;searchItemIds.add(existingSearchItem.id);continue;}
const id=this.nextId++;const newSearchItem={id,type:"field_property",fieldName:searchItem.fieldName,propertyDomain:[definitionRecord,"=",definitionRecordId],propertyFieldDefinition:definition,propertyItemId:searchItem.id,description:definitionRecordName?`${definition.string} (${definitionRecordName})`:definition.string,groupId:this.nextGroupId++,};if(["many2many","tags"].includes(definition.type)){newSearchItem.operator="in";}
this.searchItems[id]=newSearchItem;searchItemIds.add(id);}}
return this.getSearchItems((searchItem)=>searchItemIds.has(searchItem.id));}
async fillSearchViewItemsProperty(){if(!this.searchViewFields){return;}
const fields=Object.values(this.searchViewFields);for(const field of fields){if(field.type!=="properties"){continue;}
const result=await this._fetchPropertiesDefinition(this.resModel,field.name);const searchItemsNames=Object.values(this.searchItems).filter((item)=>item.isProperty&&["groupBy","dateGroupBy"].includes(item.type)).map((item)=>item.fieldName);for(const{definitionRecordId,definitionRecordName,definitions}of result){const groupNames=definitions.map((definition)=>`group_by_${field.name}.${definition.name}`);Object.values(this.searchItems).forEach((searchItem)=>{if(searchItem.isProperty&&searchItem.definitionRecordId===definitionRecordId&&["groupBy","dateGroupBy"].includes(searchItem.type)&&!groupNames.includes(searchItem.name)){searchItem.type="group_by_property_deleted";}});for(const definition of definitions){const fullName=`${field.name}.${definition.name}`;this.searchViewFields[fullName]={name:fullName,readonly:false,relation:definition.comodel,required:false,searchable:false,selection:definition.selection,sortable:true,store:true,string:definition.string,type:definition.type,relatedPropertyField:field,};if(!searchItemsNames.includes(fullName)&&!["html","separator"].includes(definition.type)){const groupByItem={description:definition.string,definitionRecordId,definitionRecordName,fieldName:fullName,fieldType:definition.type,isProperty:true,name:`group_by_${field.name}.${definition.name}`,propertyFieldName:field.name,type:["datetime","date"].includes(definition.type)?"dateGroupBy":"groupBy",};this._createGroupOfSearchItems([groupByItem]);}}}}}
async _fetchPropertiesDefinition(resModel,fieldName){const domain=[];if(this.context.active_id){domain.push(["id","=",this.context.active_id]);}
const definitions=await this.fieldService.loadPropertyDefinitions(resModel,fieldName,domain);const result=groupBy(Object.values(definitions),(definition)=>definition.record_id);return Object.entries(result).map(([recordId,definitions])=>({definitionRecordId:parseInt(recordId),definitionRecordName:definitions[0]?.record_name,definitions,}));}
_activateDefaultSearchItems(defaultFavoriteId){if(defaultFavoriteId){this.toggleSearchItem(defaultFavoriteId);}else{Object.values(this.searchItems).filter((f)=>f.isDefault&&f.type!=="favorite").sort((f1,f2)=>(f1.defaultRank||100)-(f2.defaultRank||100)).forEach((f)=>{if(f.type==="dateFilter"){this.toggleDateFilter(f.id);}else if(f.type==="dateGroupBy"){this.toggleDateGroupBy(f.id);}else if(f.type==="field"){this.addAutoCompletionValues(f.id,f.defaultAutocompleteValue);}else{this.toggleSearchItem(f.id);}});}}
_checkOrderByCountStatus(){if(this.orderByCount&&!this.query.some((item)=>["dateGroupBy","groupBy"].includes(this.searchItems[item.searchItemId].type))){this.orderByCount=false;}}
_createCategoryTree(sectionId,result){const category=this.sections.get(sectionId);let{error_msg,parent_field:parentField,values}=result;if(error_msg){category.errorMsg=error_msg;values=[];}
if(category.hierarchize){category.parentField=parentField;}
for(const value of values){category.values.set(value.id,Object.assign({},value,{childrenIds:[],parentId:value[parentField]||false,}));}
for(const value of values){const{parentId}=category.values.get(value.id);if(parentId&&category.values.has(parentId)){category.values.get(parentId).childrenIds.push(value.id);}}
category.rootIds=[false];for(const value of values){const{parentId}=category.values.get(value.id);if(!parentId){category.rootIds.push(value.id);}}
const valueIds=[false,...values.map((val)=>val.id)];this._ensureCategoryValue(category,valueIds);}
_createFilterTree(sectionId,result){const filter=this.sections.get(sectionId);let{error_msg,values}=result;if(error_msg){filter.errorMsg=error_msg;values=[];}
values.forEach((value)=>{const oldValue=filter.values.get(value.id);value.checked=oldValue?oldValue.checked:false;});filter.values=new Map();const groupIds=[];if(filter.groupBy){const groups=new Map();for(const value of values){const groupId=value.group_id;if(!groups.has(groupId)){if(groupId){groupIds.push(groupId);}
groups.set(groupId,{id:groupId,name:value.group_name,values:new Map(),tooltip:value.group_tooltip,sequence:value.group_sequence,color_index:value.color_index,});const oldGroup=filter.groups&&filter.groups.get(groupId);groups.get(groupId).state=(oldGroup&&oldGroup.state)||false;}
groups.get(groupId).values.set(value.id,value);}
filter.groups=groups;filter.sortedGroupIds=sortBy(groupIds,(id)=>groups.get(id).sequence||groups.get(id).name);for(const group of filter.groups.values()){for(const[valueId,value]of group.values){filter.values.set(valueId,value);}}}else{for(const value of values){filter.values.set(value.id,value);}}}
_createGroupOfDynamicFilters(dynamicFilters){const pregroup=dynamicFilters.map((filter)=>({groupNumber:this.nextGroupNumber,description:filter.description,domain:filter.domain,isDefault:"is_default"in filter?filter.is_default:true,type:"filter",}));this.nextGroupNumber++;this._createGroupOfSearchItems(pregroup);}
_createGroupOfFavorites(irFilters){let defaultFavoriteId=null;irFilters.forEach((irFilter)=>{const favorite=this._irFilterToFavorite(irFilter);this._createGroupOfSearchItems([favorite]);if(favorite.isDefault){defaultFavoriteId=favorite.id;}});return defaultFavoriteId;}
_createGroupOfSearchItems(pregroup){pregroup.forEach((preSearchItem)=>{const searchItem=Object.assign(preSearchItem,{groupId:this.nextGroupId,id:this.nextId,});this.searchItems[this.nextId]=searchItem;this.nextId++;});this.nextGroupId++;}
_enrichItem(searchItem){if(searchItem.type==="field"&&searchItem.fieldType==="properties"){return{...searchItem};}
const queryElements=this.query.filter((queryElem)=>queryElem.searchItemId===searchItem.id);const isActive=Boolean(queryElements.length);const enrichSearchItem=Object.assign({isActive},searchItem);function _enrichOptions(options,selectedIds){return options.map((o)=>{const{description,id,groupNumber}=o;const isActive=selectedIds.some((optionId)=>optionId===id);return{description,id,groupNumber,isActive};});}
switch(searchItem.type){case"dateFilter":enrichSearchItem.options=_enrichOptions(getPeriodOptions(this.referenceMoment,searchItem.optionsParams),queryElements.map((queryElem)=>queryElem.generatorId));break;case"dateGroupBy":enrichSearchItem.options=_enrichOptions(this.intervalOptions,queryElements.map((queryElem)=>queryElem.intervalId));break;case"field":case"field_property":enrichSearchItem.autocompleteValues=queryElements.map((queryElem)=>queryElem.autocompleteValue);break;}
return enrichSearchItem;}
_ensureCategoryValue(category,valueIds){if(!valueIds.includes(category.activeValueId)){category.activeValueId=valueIds[0];}}
_extractSearchDefaultsFromGlobalContext(){const searchDefaults={};const searchPanelDefaults={};for(const key in this.globalContext){const defaultValue=this.globalContext[key];const searchDefaultMatch=/^search_default_(.*)$/.exec(key);if(searchDefaultMatch){if(defaultValue){searchDefaults[searchDefaultMatch[1]]=defaultValue;}
delete this.globalContext[key];continue;}
const searchPanelDefaultMatch=/^searchpanel_default_(.*)$/.exec(key);if(searchPanelDefaultMatch){searchPanelDefaults[searchPanelDefaultMatch[1]]=defaultValue;delete this.globalContext[key];}}
return{searchDefaults,searchPanelDefaults};}
async _fetchCategories(categories){const filterDomain=this._getFilterDomain();const searchDomain=this.searchDomain;const categoriesLoadId=++this.categoriesLoadId;await Promise.all(categories.map(async(category)=>{const result=await this.orm.cache({type:"disk",update:"always",callback:(result,hasChanged)=>{if(!hasChanged||categoriesLoadId!==this.categoriesLoadId){return;}
this._createCategoryTree(category.id,result);this._reset();this.trigger("update");},}).call(this.resModel,"search_panel_select_range",[category.fieldName],{category_domain:this._getCategoryDomain(category.id),context:this.globalContext,enable_counters:category.enableCounters,expand:category.expand,filter_domain:filterDomain,hierarchize:category.hierarchize,limit:category.limit,search_domain:searchDomain,});this._createCategoryTree(category.id,result);}));}
async _fetchFilters(filters){const evalContext={};for(const category of this.categories){evalContext[category.fieldName]=category.activeValueId;}
const categoryDomain=this._getCategoryDomain();const searchDomain=this.searchDomain;const filtersLoadId=++this.filtersLoadId;await Promise.all(filters.map(async(filter)=>{const result=await this.orm.cache({type:"disk",update:"always",callback:(result,hasChanged)=>{if(!hasChanged||filtersLoadId!==this.filtersLoadId){return;}
this._createFilterTree(filter.id,result);this._reset();this.trigger("update");},}).call(this.resModel,"search_panel_select_multi_range",[filter.fieldName],{category_domain:categoryDomain,comodel_domain:new Domain(filter.domain).toList(evalContext),context:this.globalContext,enable_counters:filter.enableCounters,filter_domain:this._getFilterDomain(filter.id),expand:filter.expand,group_by:filter.groupBy||false,group_domain:this._getGroupDomain(filter),limit:filter.limit,search_domain:searchDomain,});this._createFilterTree(filter.id,result);}));}
async _fetchSections(categoriesToLoad,filtersToLoad){await this._fetchCategories(categoriesToLoad);await this._fetchFilters(filtersToLoad);this.searchPanelInfo.loaded=true;}
_getCategoryDomain(excludedCategoryId){const domain=[];for(const category of this.categories){if(category.id===excludedCategoryId||!category.activeValueId){continue;}
const field=this.searchViewFields[category.fieldName];const operator=field.type==="many2one"&&category.parentField?"child_of":"=";domain.push([category.fieldName,operator,category.activeValueId]);}
return domain;}
_getContext(){const groups=this._getGroups();const contexts=[user.context];for(const group of groups){for(const activeItem of group.activeItems){const context=this._getSearchItemContext(activeItem);if(context){contexts.push(context);}}}
return makeContext(contexts);}
_getDateFilterDomain(dateFilter,generatorIds,key="domain"){const dateFilterRange=constructDateDomain(this.referenceMoment,dateFilter,generatorIds);return dateFilterRange[key];}
_getDisplay(display={}){const{viewTypes}=this.searchPanelInfo;const{viewType}=this.env.config;return{controlPanel:"controlPanel"in display?display.controlPanel:{},searchPanel:this.sections.size&&(!viewType||viewTypes.includes(viewType))&&("searchPanel"in display?display.searchPanel:true),};}
_getDomain(params={}){const withSearchPanel="withSearchPanel"in params?params.withSearchPanel:true;const withGlobal="withGlobal"in params?params.withGlobal:true;const groups=this._getGroups();const domains=[];if(withGlobal){domains.push(this.globalDomain);}
for(const group of groups){const groupActiveItemDomains=[];for(const activeItem of group.activeItems){const domain=this._getSearchItemDomain(activeItem);if(domain){groupActiveItemDomains.push(domain);}}
const groupDomain=Domain.or(groupActiveItemDomains);domains.push(groupDomain);}
if(this.display.searchPanel&&withSearchPanel){domains.push(this._getSearchPanelDomain());}
const domain=Domain.and(domains);return params.raw?domain:domain.toList(this.domainEvalContext);}
_getFacets(){const facets=[];const groups=this._getGroups();for(const group of groups){const groupActiveItemDomains=[];const values=[];let title;let type;let tooltip;for(const activeItem of group.activeItems){const domain=this._getSearchItemDomain(activeItem);if(domain){groupActiveItemDomains.push(domain);}
const searchItem=this.searchItems[activeItem.searchItemId];tooltip=searchItem.tooltip;switch(searchItem.type){case"field_property":case"field":{type="field";title=searchItem.description;for(const autocompleteValue of activeItem.autocompleteValues){values.push(autocompleteValue.label);}
break;}
case"groupBy":{type="groupBy";values.push(searchItem.description);break;}
case"dateGroupBy":{type="groupBy";for(const intervalId of activeItem.intervalIds){const{description}=INTERVAL_OPTIONS[intervalId];values.push(`${searchItem.description}: ${description}`);}
break;}
case"dateFilter":{type="filter";const periodDescription=this._getDateFilterDomain(searchItem,activeItem.generatorIds,"description");values.push(`${searchItem.description}: ${periodDescription}`);break;}
default:{type=searchItem.type;values.push(searchItem.description);}}}
const facet={groupId:group.id,type,values,separator:type==="groupBy"?">":_t("or"),};if(type==="field"){facet.title=title;}else{if(type==="groupBy"&&this.orderByCount){facet.icon=FACET_ICONS[this.orderByCount==="Asc"?"groupByAsc":"groupByDesc"];}else{facet.icon=FACET_ICONS[type];}
facet.color=FACET_COLORS[type];}
if(tooltip){facet.tooltip=tooltip;}
if(groupActiveItemDomains.length){facet.domain=Domain.or(groupActiveItemDomains).toString();}
facets.push(facet);}
const hasAGroupByFacet=facets.some((f)=>f.type==="groupBy");if(!hasAGroupByFacet&&!this.globalGroupBy.length&&this.defaultGroupBy&&this.env.config.viewType!=="kanban"){facets.unshift({groupId:SPECIAL,type:"groupBy",values:this.defaultGroupBy.map((gb)=>{const[fieldName,interval]=gb.split(":");const{string}=this.searchViewFields[fieldName];if(interval){const{description}=INTERVAL_OPTIONS[interval];return`${string}:${description}`;}
return string;}),separator:">",icon:FACET_ICONS.groupBy,color:FACET_COLORS.groupBy,});}
return facets;}
_getFieldDomain(field,autocompleteValues){const domains=autocompleteValues.map(({label,value,operator})=>{let domain;if(field.filterDomain){domain=new Domain(field.filterDomain).toList({self:label.trim(),raw_value:value,});}else if(field.type==="field"){domain=[[field.fieldName,operator,value]];}else if(field.type==="field_property"){domain=[field.propertyDomain,[`${field.fieldName}.${field.propertyFieldDefinition.name}`,operator,value],];}
return new Domain(domain);});return Domain.or(domains);}
_getFilterDomain(excludedFilterId){const domain=[];function addCondition(fieldName,valueMap){const ids=[];for(const[valueId,value]of valueMap){if(value.checked){ids.push(valueId);}}
if(ids.length){domain.push([fieldName,"in",ids]);}}
for(const filter of this.filters){if(filter.id===excludedFilterId){continue;}
const{fieldName,groups,values}=filter;if(groups){for(const group of groups.values()){addCondition(fieldName,group.values);}}else{addCondition(fieldName,values);}}
return domain;}
_getGroupBy(options={}){const fallbackOnDefault="fallbackOnDefault"in options?options.fallbackOnDefault:true;const groups=this._getGroups();const groupBys=[];for(const group of groups){for(const activeItem of group.activeItems){const activeItemGroupBys=this._getSearchItemGroupBys(activeItem);if(activeItemGroupBys){groupBys.push(...activeItemGroupBys);}}}
const groupBy=groupBys.length?groupBys:this.globalGroupBy.length?this.globalGroupBy.slice():(fallbackOnDefault&&this.defaultGroupBy?.slice())||[];return typeof groupBy==="string"?[groupBy]:groupBy;}
_getGroupDomain(filter){const{fieldName,groups,enableCounters}=filter;const{type:fieldType}=this.searchViewFields[fieldName];if(!enableCounters||!groups){return{many2one:[],many2many:{},}[fieldType];}
let groupDomain=null;if(fieldType==="many2one"){for(const group of groups.values()){const valueIds=[];let active=false;for(const[valueId,value]of group.values){const{checked}=value;valueIds.push(valueId);if(checked){active=true;}}
if(active){if(groupDomain){groupDomain=[[0,"=",1]];break;}else{groupDomain=[[fieldName,"in",valueIds]];}}}}else if(fieldType==="many2many"){const checkedValueIds=new Map();groups.forEach(({values},groupId)=>{values.forEach(({checked},valueId)=>{if(checked){if(!checkedValueIds.has(groupId)){checkedValueIds.set(groupId,[]);}
checkedValueIds.get(groupId).push(valueId);}});});groupDomain={};for(const[gId,ids]of checkedValueIds.entries()){for(const groupId of groups.keys()){if(gId!==groupId){const key=JSON.stringify(groupId);if(!groupDomain[key]){groupDomain[key]=[];}
groupDomain[key].push([fieldName,"in",ids]);}}}}
return groupDomain;}
_getGroups(){const preGroups=[];for(const queryElem of this.query){const{searchItemId}=queryElem;const{groupId}=this.searchItems[searchItemId];let preGroup=preGroups.find((group)=>group.id===groupId);if(!preGroup){preGroup={id:groupId,queryElements:[]};preGroups.push(preGroup);}
preGroup.queryElements.push(queryElem);}
const groups=[];for(const preGroup of preGroups){const{queryElements,id}=preGroup;const activeItems=[];for(const queryElem of queryElements){const{searchItemId}=queryElem;let activeItem=activeItems.find(({searchItemId:id})=>id===searchItemId);if("generatorId"in queryElem){if(!activeItem){activeItem={searchItemId,generatorIds:[]};activeItems.push(activeItem);}
activeItem.generatorIds.push(queryElem.generatorId);}else if("intervalId"in queryElem){if(!activeItem){activeItem={searchItemId,intervalIds:[]};activeItems.push(activeItem);}
activeItem.intervalIds.push(queryElem.intervalId);}else if("autocompleteValue"in queryElem){if(!activeItem){activeItem={searchItemId,autocompleteValues:[]};activeItems.push(activeItem);}
activeItem.autocompleteValues.push(queryElem.autocompleteValue);}else{if(!activeItem){activeItem={searchItemId};activeItems.push(activeItem);}}}
for(const activeItem of activeItems){if("intervalIds"in activeItem){activeItem.intervalIds.sort((g1,g2)=>rankInterval(g1)-rankInterval(g2));}}
groups.push({id,activeItems});}
return groups;}
_getIrFilterDescription(params={}){const{description,isDefault,isShared,embeddedActionId}=params;const fns=this.env.__getContext__.callbacks;const localContext=Object.assign({},...fns.map((fn)=>fn()));const gs=this.env.__getOrderBy__.callbacks;let localOrderBy;if(gs.length){localOrderBy=gs.flatMap((g)=>g());}
const context=makeContext([this._getContext(),localContext]);const userContext=user.context;for(const key in context){if(key in userContext||/^search(panel)?_default_/.test(key)){delete context[key];}}
const domain=this._getDomain({raw:true,withGlobal:false}).toString();const groupBys=this._getGroupBy();const orderBy=localOrderBy||this._getOrderBy();const userIds=isShared?[]:[user.userId];const preFavorite={description,isDefault,domain,context,groupBys,orderBy,userIds,};const irFilter={name:description,action_id:this.env.config.actionId,model_id:this.resModel,domain,embedded_action_id:embeddedActionId,embedded_parent_res_id:this.globalContext.active_id||false,is_default:isDefault,sort:JSON.stringify(orderBy.map((o)=>`${o.name}${o.asc === false ? " desc" : ""}`)),user_ids:userIds,context:{group_by:groupBys,...context},};return{preFavorite,irFilter};}
_getOrderBy(){const groups=this._getGroups();const orderBy=[];if(this.groupBy.length&&this.orderByCount){orderBy.push({name:"__count",asc:this.orderByCount==="Asc"});}
for(const group of groups){for(const activeItem of group.activeItems){const{searchItemId}=activeItem;const searchItem=this.searchItems[searchItemId];if(searchItem.type==="favorite"){orderBy.push(...searchItem.orderBy);}}}
return orderBy.length?orderBy:this.globalOrderBy;}
_getSearchItemContext(activeItem){const{searchItemId}=activeItem;const searchItem=this.searchItems[searchItemId];switch(searchItem.type){case"field":{let context={};if(searchItem.context){const self=activeItem.autocompleteValues.map((autocompleValue)=>autocompleValue.value);context=evaluateExpr(searchItem.context,{self});if(typeof context!=="object"){throw new Error(_t("Failed to evaluate the context: %(context)s.",{context:searchItem.context,}));}}
if(searchItem.isDefault&&searchItem.fieldType==="many2one"){context[`default_${searchItem.fieldName}`]=searchItem.defaultAutocompleteValue.value;}
return context;}
case"favorite":case"filter":{return makeContext([searchItem.context&&deepCopy(searchItem.context)]);}
default:{return null;}}}
_getSearchItemDomain(activeItem){const{searchItemId}=activeItem;const searchItem=this.searchItems[searchItemId];switch(searchItem.type){case"field_property":case"field":{return this._getFieldDomain(searchItem,activeItem.autocompleteValues);}
case"dateFilter":{return this._getDateFilterDomain(searchItem,activeItem.generatorIds);}
case"filter":case"favorite":{return searchItem.domain;}
default:{return null;}}}
_getSearchItemGroupBys(activeItem){const{searchItemId}=activeItem;const searchItem=this.searchItems[searchItemId];switch(searchItem.type){case"dateGroupBy":{const{fieldName}=searchItem;return activeItem.intervalIds.map((intervalId)=>`${fieldName}:${intervalId}`);}
case"groupBy":{return[searchItem.fieldName];}
case"favorite":{return searchItem.groupBys;}
default:{return null;}}}
_getSelectedGeneratorIds(dateFilterId){const selectedOptionIds=[];for(const queryElem of this.query){if(queryElem.searchItemId===dateFilterId&&"generatorId"in queryElem){selectedOptionIds.push(queryElem.generatorId);}}
return selectedOptionIds;}
_getSearchPanelDomain(){return Domain.and([this._getCategoryDomain(),this._getFilterDomain()]);}
_importState(state){execute(arraytoMap,state,this);}
_irFilterToFavorite(irFilter){const userIds=irFilter.user_ids;const groupNumber=userIds.length===1?FAVORITE_PRIVATE_GROUP:FAVORITE_SHARED_GROUP;const context=evaluateExpr(irFilter.context,user.context);let groupBys=[];if(context.group_by){groupBys=context.group_by;delete context.group_by;}
let sort;try{sort=JSON.parse(irFilter.sort);}catch(err){if(err instanceof SyntaxError){sort=[];}else{throw err;}}
const orderBy=sort.map((order)=>{let fieldName;let asc;const sqlNotation=order.split(" ");if(sqlNotation.length>1){fieldName=sqlNotation[0];asc=sqlNotation[1]==="asc";}else{fieldName=order[0]==="-"?order.slice(1):order;asc=order[0]==="-"?false:true;}
return{asc:asc,name:fieldName,};});const favorite={context,description:irFilter.name,domain:irFilter.domain,groupBys,groupNumber,orderBy,removable:true,serverSideId:irFilter.id,type:"favorite",userIds,};if(irFilter.is_default){favorite.isDefault=irFilter.is_default;}
return favorite;}
async _notify(){if(this.blockNotification){return;}
this._reset();await this._reloadSections();this.trigger("update");}
_reconciliateFavorites(){const irFilters=this.irFilters||[];const mapping=Object.fromEntries(irFilters.map((i)=>[i.id,i]));for(const item of Object.values(this.searchItems)){if(item.type!=="favorite"){continue;}
const irFilter=mapping[item.serverSideId];if(irFilter){Object.assign(item,this._irFilterToFavorite(irFilter));delete mapping[item.serverSideId];}else{const queryIndex=this.query.findIndex((q)=>q.searchItemId===item.id);if(queryIndex!==-1){this.query.splice(queryIndex,1);}
delete this.searchItems[item.id];}}
this._createGroupOfFavorites(Object.values(mapping));}
async _reloadSections(){this.blockNotification=true;const searchDomain=this._getDomain({withSearchPanel:false});const searchDomainChanged=this.searchPanelInfo.shouldReload||JSON.stringify(this.searchDomain)!==JSON.stringify(searchDomain);this.searchDomain=searchDomain;const toFetch=(section)=>section.enableCounters||(searchDomainChanged&&!section.expand);const categoriesToFetch=this.categories.filter(toFetch);const filtersToFetch=this.filters.filter(toFetch);if(searchDomainChanged||Boolean(categoriesToFetch.length+filtersToFetch.length)){if(this.display.searchPanel){this.sectionsPromise=this._fetchSections(categoriesToFetch,filtersToFetch);if(this._shouldWaitForData(searchDomainChanged)){await this.sectionsPromise;}}
this.searchPanelInfo.shouldReload=!this.display.searchPanel;}
this.blockNotification=false;}
_reset(){this._context=null;this._domain=null;this._groupBy=null;this._orderBy=null;}
_shouldWaitForData(searchDomainChanged){if(this.categories.length&&this.filters.some((filter)=>filter.domain!=="[]")){return true;}
if(!this.searchDomain.length){return false;}
return[...this.sections.values()].some((section)=>!section.expand&&searchDomainChanged);}
__legacyParseSearchPanelArchAnyway(searchViewDescription,searchViewFields){if(this.searchPanelInfo){return;}
const parser=new SearchArchParser(searchViewDescription,searchViewFields);const{searchPanelInfo}=parser.parse();this.searchPanelInfo={...searchPanelInfo,loaded:false,shouldReload:false};}}
return __exports;});;

/* /web/static/src/search/search_panel/search_panel.js */
odoo.define('@web/search/search_panel/search_panel',['@web/core/dropdown/dropdown','@web/core/utils/hooks','@odoo/owl','@web/core/browser/browser','@web/core/utils/strings','@web/search/action_hook'],function(require){'use strict';let __exports={};const{Dropdown}=require("@web/core/dropdown/dropdown");const{useBus}=require("@web/core/utils/hooks");const{Component,onMounted,onWillStart,onWillUpdateProps,reactive,useEffect,useRef,useState,}=require("@odoo/owl");const{browser}=require("@web/core/browser/browser");const{exprToBoolean}=require("@web/core/utils/strings");const{useSetupAction}=require("@web/search/action_hook");const isFilter=(s)=>s.type==="filter";const isActiveCategory=(s)=>s.type==="category"&&s.activeValueId;const nameOfCheckedValues=(values)=>{const names=[];for(const[,value]of values){if(value.checked){names.push(value.display_name);}}
return names;};const SearchPanel=__exports.SearchPanel=class SearchPanel extends Component{static template="web.SearchPanel";static props={};static components={Dropdown,};static subTemplates={section:"web.SearchPanel.Section",category:"web.SearchPanel.Category",filtersGroup:"web.SearchPanel.FiltersGroup",};setup(){this.keyExpandSidebar=`search_panel_expanded,${this.env.config.viewId},${this.env.config.actionId}`;this.state=useState({active:{},expanded:{},sidebarExpanded:true,});this.hasImportedState=false;this.root=useRef("root");this.scrollTop=0;this.dropdownStates={};this.width="10px";this.importState(this.env.searchPanelState);const sidebarExpandedPreference=browser.localStorage.getItem(this.keyExpandSidebar);if(sidebarExpandedPreference!==null){this.state.sidebarExpanded=exprToBoolean(sidebarExpandedPreference);}
useBus(this.env.searchModel,"update",async()=>{await this.env.searchModel.sectionsPromise;this.updateActiveValues();this.render();});useEffect((el)=>{if(el&&this.hasImportedState){el.style["min-width"]=this.width;el.scroll({top:this.scrollTop});}},()=>[this.root.el]);useSetupAction({getGlobalState:()=>({searchPanel:this.exportState(),}),});onWillStart(async()=>{await this.env.searchModel.sectionsPromise;this.expandDefaultValue();this.expandValues();this.updateActiveValues();});onWillUpdateProps(async()=>{await this.env.searchModel.sectionsPromise;this.updateActiveValues();});onMounted(()=>{this.updateGroupHeadersChecked();});}
get sections(){return this.env.searchModel.getSections((s)=>!s.empty);}
exportState(){const exported={expanded:this.state.expanded,scrollTop:this.root.el?.scrollTop||0,sidebarExpanded:this.state.sidebarExpanded,width:this.width,};return JSON.stringify(exported);}
importState(state){this.hasImportedState=Boolean(state);if(this.hasImportedState){this.state.expanded=state.expanded;this.scrollTop=state.scrollTop;this.state.sidebarExpanded=state.sidebarExpanded;this.width=state.width;}}
getDropdownState(sectionId){if(!this.dropdownStates[sectionId]){const state=reactive({isOpen:false,open:()=>(state.isOpen=true),close:()=>(state.isOpen=false),});this.dropdownStates[sectionId]=reactive(state);}
return this.dropdownStates[sectionId];}
expandDefaultValue(){if(this.hasImportedState){return;}
const categories=this.env.searchModel.getSections((s)=>s.type==="category");for(const category of categories){this.state.expanded[category.id]={};if(category.activeValueId){const ancestorIds=this.getAncestorValueIds(category,category.activeValueId);for(const ancestorId of ancestorIds){this.state.expanded[category.id][ancestorId]=true;}}}}
expandValues(){if(this.hasImportedState){return;}
const categories=this.env.searchModel.getSections((s)=>s.type==="category");for(const category of categories){if(category.depth===0){continue;}
this.state.expanded[category.id]||={};const expand=(id,level)=>{if(!level){return;}
this.state.expanded[category.id][id]=true;const{childrenIds}=category.values.get(id);level-=1;for(const childId of childrenIds){expand(childId,level);}};for(const rootId of category.rootIds){expand(rootId,category.depth);}}}
getAncestorValueIds(category,categoryValueId){const{parentId}=category.values.get(categoryValueId);return parentId?[...this.getAncestorValueIds(category,parentId),parentId]:[];}
getCategorySelection(){const activeCategories=this.env.searchModel.getSections(isActiveCategory);const selection=[];for(const category of activeCategories){const parentIds=this.getAncestorValueIds(category,category.activeValueId);const orderedCategoryNames=[...parentIds,category.activeValueId].map((valueId)=>category.values.get(valueId).display_name);selection.push({values:orderedCategoryNames,icon:category.icon,color:category.color,});}
return selection;}
getFilterSelection(){const filters=this.env.searchModel.getSections(isFilter);const selection=[];for(const{groups,values,icon,color}of filters){let filterValues;if(groups){filterValues=Object.keys(groups).map((groupId)=>nameOfCheckedValues(groups[groupId].values)).flat();}else if(values){filterValues=nameOfCheckedValues(values);}
if(filterValues.length){selection.push({values:filterValues,icon,color});}}
return selection;}
hasSelection(sectionId=0){if(sectionId){const sectionState=this.state.active[sectionId];if(sectionState instanceof Object){return Object.values(sectionState).some((val)=>val);}
return Boolean(sectionState);}
return Object.keys(this.state.active).some((key)=>this.hasSelection(key));}
clearSelection(sectionId=0){const sectionIds=sectionId?[sectionId]:Object.keys(this.state.active).map(Number);this.env.searchModel.clearSections(sectionIds);}
async toggleCategory(category,value){if(value.childrenIds.length){const categoryState=this.state.expanded[category.id];if(categoryState[value.id]&&category.activeValueId===value.id){delete categoryState[value.id];}else{categoryState[value.id]=true;}}else{this.getDropdownState(category.id).close();}
if(category.activeValueId!==value.id){this.env.searchModel.toggleCategoryValue(category.id,value.id);}}
toggleSidebar(){this.state.sidebarExpanded=!this.state.sidebarExpanded;browser.localStorage.setItem(this.keyExpandSidebar,this.state.sidebarExpanded);}
toggleFilterGroup(filterId,{values}){const valueIds=[];const checked=[...values.values()].every((value)=>this.state.active[filterId][value.id]);values.forEach(({id})=>{valueIds.push(id);this.state.active[filterId][id]=!checked;});this.env.searchModel.toggleFilterValues(filterId,valueIds,!checked);}
toggleFilterValue(filterId,valueId,{currentTarget}){this.state.active[filterId][valueId]=currentTarget.checked;this.updateGroupHeadersChecked();this.env.searchModel.toggleFilterValues(filterId,[valueId]);}
updateActiveValues(){if(this.sections.length===0){this.state.sidebarExpanded=false;}
for(const section of this.sections){if(section.type==="category"){this.state.active[section.id]=section.activeValueId;}else{this.state.active[section.id]={};if(section.groups){for(const group of section.groups.values()){for(const value of group.values.values()){this.state.active[section.id][value.id]=value.checked;}}}
if(section&&section.values){for(const value of section.values.values()){this.state.active[section.id][value.id]=value.checked;}}}}}
updateGroupHeadersChecked(){const groups=document.querySelectorAll(".o_search_panel_filter_group");for(const group of groups){const header=group.querySelector(":scope .o_search_panel_group_header input");const vals=[...group.querySelectorAll(":scope .o_search_panel_filter_value input")];header.checked=false;header.indeterminate=false;if(vals.every((v)=>v.checked)){header.checked=true;}else if(vals.some((v)=>v.checked)){header.indeterminate=true;}}}
_onStartResize(ev){if(ev.button!==0){return;}
const initialX=ev.pageX;const initialWidth=this.root.el.offsetWidth;const resizeStoppingEvents=["keydown","pointerdown","pointerup"];const resizePanel=(ev)=>{ev.preventDefault();ev.stopPropagation();const maxWidth=Math.max(0.5*window.innerWidth,initialWidth);const delta=ev.pageX-initialX;const newWidth=Math.min(maxWidth,Math.max(10,initialWidth+delta));this.width=`${newWidth}px`;this.root.el.style["min-width"]=this.width;};document.addEventListener("pointermove",resizePanel,true);const stopResize=(ev)=>{if(ev.type==="pointerdown"&&ev.button===0){return;}
ev.preventDefault();ev.stopPropagation();document.removeEventListener("pointermove",resizePanel,true);resizeStoppingEvents.forEach((stoppingEvent)=>{document.removeEventListener(stoppingEvent,stopResize,true);});document.activeElement.blur();};resizeStoppingEvents.forEach((stoppingEvent)=>{document.addEventListener(stoppingEvent,stopResize,true);});}}
return __exports;});;

/* /web/static/src/search/utils/dates.js */
odoo.define('@web/search/utils/dates',['@web/core/l10n/translation','@web/core/domain','@web/core/l10n/dates','@web/core/l10n/localization','@web/core/utils/numbers','@web/core/utils/objects'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web",...args);const{Domain}=require("@web/core/domain");const{serializeDate,serializeDateTime}=require("@web/core/l10n/dates");const{localization}=require("@web/core/l10n/localization");const{clamp}=require("@web/core/utils/numbers");const{pick}=require("@web/core/utils/objects");const QUARTERS=__exports.QUARTERS={1:{description:_t("Q1"),coveredMonths:[1,2,3]},2:{description:_t("Q2"),coveredMonths:[4,5,6]},3:{description:_t("Q3"),coveredMonths:[7,8,9]},4:{description:_t("Q4"),coveredMonths:[10,11,12]},};const QUARTER_OPTIONS=__exports.QUARTER_OPTIONS={fourth_quarter:{id:"fourth_quarter",groupNumber:1,description:QUARTERS[4].description,setParam:{quarter:4},granularity:"quarter",},third_quarter:{id:"third_quarter",groupNumber:1,description:QUARTERS[3].description,setParam:{quarter:3},granularity:"quarter",},second_quarter:{id:"second_quarter",groupNumber:1,description:QUARTERS[2].description,setParam:{quarter:2},granularity:"quarter",},first_quarter:{id:"first_quarter",groupNumber:1,description:QUARTERS[1].description,setParam:{quarter:1},granularity:"quarter",},};const DEFAULT_INTERVAL=__exports.DEFAULT_INTERVAL="month";const INTERVAL_OPTIONS=__exports.INTERVAL_OPTIONS={year:{description:_t("Year"),id:"year",groupNumber:1},quarter:{description:_t("Quarter"),id:"quarter",groupNumber:1},month:{description:_t("Month"),id:"month",groupNumber:1},week:{description:_t("Week"),id:"week",groupNumber:1},day:{description:_t("Day"),id:"day",groupNumber:1},};const BACKEND_INTERVAL_OPTIONS=__exports.BACKEND_INTERVAL_OPTIONS={...INTERVAL_OPTIONS,hour:{description:_t("Hour"),id:"hour"},};__exports.constructDateDomain=constructDateDomain;function constructDateDomain(referenceMoment,searchItem,selectedOptionIds){let plusParam;const selectedOptions=getSelectedOptions(referenceMoment,searchItem,selectedOptionIds);if("withDomain"in selectedOptions){return{description:selectedOptions.withDomain[0].description,domain:Domain.and([selectedOptions.withDomain[0].domain,searchItem.domain]),};}
const yearOptions=selectedOptions.year;const otherOptions=[...(selectedOptions.quarter||[]),...(selectedOptions.month||[])];sortPeriodOptions(yearOptions);sortPeriodOptions(otherOptions);const ranges=[];const{fieldName,fieldType}=searchItem;for(const yearOption of yearOptions){const constructRangeParams={referenceMoment,fieldName,fieldType,plusParam,};if(otherOptions.length){for(const option of otherOptions){const setParam=Object.assign({},yearOption.setParam,option?option.setParam:{});const{granularity}=option;const range=constructDateRange(Object.assign({granularity,setParam},constructRangeParams));ranges.push(range);}}else{const{granularity,setParam}=yearOption;const range=constructDateRange(Object.assign({granularity,setParam},constructRangeParams));ranges.push(range);}}
let domain=Domain.combine(ranges.map((range)=>range.domain),"OR");domain=Domain.and([domain,searchItem.domain]);const description=ranges.map((range)=>range.description).join("/");return{domain,description};}
__exports.constructDateRange=constructDateRange;function constructDateRange(params){const{referenceMoment,fieldName,fieldType,granularity,setParam,plusParam}=params;if("quarter"in setParam){setParam.month=QUARTERS[setParam.quarter].coveredMonths[0];delete setParam.quarter;}
const date=referenceMoment.set(setParam).plus(plusParam||{});const leftDate=date.startOf(granularity);const rightDate=date.endOf(granularity);let leftBound;let rightBound;if(fieldType==="date"){leftBound=serializeDate(leftDate);rightBound=serializeDate(rightDate);}else{leftBound=serializeDateTime(leftDate);rightBound=serializeDateTime(rightDate);}
const domain=new Domain(["&",[fieldName,">=",leftBound],[fieldName,"<=",rightBound]]);const descriptions=[date.toFormat("yyyy")];const method=localization.direction==="rtl"?"push":"unshift";if(granularity==="month"){descriptions[method](date.toFormat("MMMM"));}else if(granularity==="quarter"){const quarter=date.quarter;descriptions[method](QUARTERS[quarter].description.toString());}
const description=descriptions.join(" ");return{domain,description};}
__exports.getIntervalOptions=getIntervalOptions;function getIntervalOptions(){return getOptionsWithDescriptions(INTERVAL_OPTIONS);}
__exports.getOptionsWithDescriptions=getOptionsWithDescriptions;function getOptionsWithDescriptions(OPTIONS){const options=[];for(const option of Object.values(OPTIONS)){options.push(Object.assign({},option,{description:option.description.toString()}));}
return options;}
__exports.getPeriodOptions=getPeriodOptions;function getPeriodOptions(referenceMoment,optionsParams){return[...getMonthPeriodOptions(referenceMoment,optionsParams),...getQuarterPeriodOptions(optionsParams),...getYearPeriodOptions(referenceMoment,optionsParams),...getCustomPeriodOptions(optionsParams),];}
__exports.toGeneratorId=toGeneratorId;function toGeneratorId(unit,offset){if(!offset){return unit;}
const sep=offset>0?"+":"-";const val=Math.abs(offset);return`${unit}${sep}${val}`;}
function getMonthPeriodOptions(referenceMoment,optionsParams){const{startYear,endYear,startMonth,endMonth}=optionsParams;return[...Array(endMonth-startMonth+1).keys()].map((i)=>{const monthOffset=startMonth+i;const date=referenceMoment.plus({months:monthOffset,years:clamp(0,startYear,endYear),});const yearOffset=date.year-referenceMoment.year;return{id:toGeneratorId("month",monthOffset),defaultYearId:toGeneratorId("year",clamp(yearOffset,startYear,endYear)),description:date.toFormat("MMMM"),granularity:"month",groupNumber:1,plusParam:{months:monthOffset},};}).reverse();}
function getQuarterPeriodOptions(optionsParams){const{startYear,endYear}=optionsParams;const defaultYearId=toGeneratorId("year",clamp(0,startYear,endYear));return Object.values(QUARTER_OPTIONS).map((quarter)=>({...quarter,defaultYearId,}));}
function getYearPeriodOptions(referenceMoment,optionsParams){const{startYear,endYear}=optionsParams;return[...Array(endYear-startYear+1).keys()].map((i)=>{const offset=startYear+i;const date=referenceMoment.plus({years:offset});return{id:toGeneratorId("year",offset),description:date.toFormat("yyyy"),granularity:"year",groupNumber:2,plusParam:{years:offset},};}).reverse();}
function getCustomPeriodOptions(optionsParams){const{customOptions}=optionsParams;return customOptions.map((option)=>({id:option.id,description:option.description,granularity:"withDomain",groupNumber:3,domain:option.domain,}));}
__exports.getSelectedOptions=getSelectedOptions;function getSelectedOptions(referenceMoment,searchItem,selectedOptionIds){const selectedOptions={year:[]};const periodOptions=getPeriodOptions(referenceMoment,searchItem.optionsParams);for(const optionId of selectedOptionIds){const option=periodOptions.find((option)=>option.id===optionId);const granularity=option.granularity;if(!selectedOptions[granularity]){selectedOptions[granularity]=[];}
if(option.domain){selectedOptions[granularity].push(pick(option,"domain","description"));}else{const setParam=getSetParam(option,referenceMoment);selectedOptions[granularity].push({granularity,setParam});}}
return selectedOptions;}
__exports.getSetParam=getSetParam;function getSetParam(periodOption,referenceMoment){if(periodOption.granularity==="quarter"){return periodOption.setParam;}
const date=referenceMoment.plus(periodOption.plusParam);const granularity=periodOption.granularity;const setParam={[granularity]:date[granularity]};return setParam;}
__exports.rankInterval=rankInterval;function rankInterval(intervalOptionId){return Object.keys(INTERVAL_OPTIONS).indexOf(intervalOptionId);}
__exports.sortPeriodOptions=sortPeriodOptions;function sortPeriodOptions(options){options.sort((o1,o2)=>{var _a,_b;const granularity1=o1.granularity;const granularity2=o2.granularity;if(granularity1===granularity2){return(((_a=o1.setParam[granularity1])!==null&&_a!==void 0?_a:0)-
((_b=o2.setParam[granularity1])!==null&&_b!==void 0?_b:0));}
return granularity1<granularity2?-1:1;});}
__exports.yearSelected=yearSelected;function yearSelected(selectedOptionIds){return selectedOptionIds.some((optionId)=>optionId.startsWith("year"));}
return __exports;});;

/* /web/static/src/search/utils/group_by.js */
odoo.define('@web/search/utils/group_by',['@web/search/utils/dates'],function(require){'use strict';let __exports={};const{DEFAULT_INTERVAL,BACKEND_INTERVAL_OPTIONS}=require("@web/search/utils/dates");function errorMsg(descr){return`Invalid groupBy description: ${descr}`;}
__exports.getGroupBy=getGroupBy;function getGroupBy(descr,fields){let fieldName;let interval;let spec;[fieldName,interval]=descr.split(":");if(!fieldName){throw Error();}
if(fields){if(!fields[fieldName]&&!fieldName.includes(".")){throw Error(errorMsg(descr));}
const fieldType=fields[fieldName]?.type;if(["date","datetime"].includes(fieldType)){if(!interval){interval=DEFAULT_INTERVAL;}else if(!Object.keys(BACKEND_INTERVAL_OPTIONS).includes(interval)){throw Error(errorMsg(descr));}
spec=`${fieldName}:${interval}`;}else if(interval){throw Error(errorMsg(descr));}else{spec=fieldName;interval=null;}}else{if(interval){if(!Object.keys(BACKEND_INTERVAL_OPTIONS).includes(interval)){throw Error(errorMsg(descr));}
spec=`${fieldName}:${interval}`;}else{spec=fieldName;interval=null;}}
return{fieldName,interval,spec,toJSON(){return spec;},};}
return __exports;});;

/* /web/static/src/search/utils/misc.js */
odoo.define('@web/search/utils/misc',[],function(require){'use strict';let __exports={};const FACET_ICONS=__exports.FACET_ICONS={filter:"fa fa-filter",groupBy:"oi oi-group",groupByAsc:"fa fa-sort-numeric-asc",groupByDesc:"fa fa-sort-numeric-desc",favorite:"fa fa-star",};const FACET_COLORS=__exports.FACET_COLORS={filter:"primary",groupBy:"action",favorite:"warning",};const GROUPABLE_TYPES=__exports.GROUPABLE_TYPES=["boolean","char","date","datetime","integer","many2one","many2many","selection","tags",];return __exports;});;

/* /web/static/src/search/utils/order_by.js */
odoo.define('@web/search/utils/order_by',[],function(require){'use strict';let __exports={};__exports.orderByToString=orderByToString;function orderByToString(orderBy){return orderBy.map((o)=>`${o.name} ${o.asc ? "ASC" : "DESC"}`).join(", ");}
__exports.stringToOrderBy=stringToOrderBy;function stringToOrderBy(string){if(!string){return[];}
return string.split(",").map((order)=>{const splitOrder=order.trim().split(" ");if(splitOrder.length===2){return{name:splitOrder[0],asc:splitOrder[1].toLowerCase()==="asc",};}else{return{name:splitOrder[0],asc:true,};}});}
return __exports;});;

/* /web/static/src/search/with_search/with_search.js */
odoo.define('@web/search/with_search/with_search',['@odoo/owl','@web/search/action_hook','@web/search/search_model','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Component,onWillStart,onWillUpdateProps,toRaw,useSubEnv}=require("@odoo/owl");const{CallbackRecorder,useSetupAction}=require("@web/search/action_hook");const{SearchModel}=require("@web/search/search_model");const{useBus,useService}=require("@web/core/utils/hooks");const SEARCH_KEYS=__exports.SEARCH_KEYS=["context","domain","groupBy","orderBy"];const WithSearch=__exports.WithSearch=class WithSearch extends Component{static template="web.WithSearch";static props={slots:Object,SearchModel:{type:Function,optional:true},resModel:String,globalState:{type:Object,optional:true},searchModelArgs:{type:Object,optional:true},display:{type:Object,optional:true},context:{type:Object,optional:true},domain:{type:Array,element:[String,Array],optional:true},groupBy:{type:Array,element:String,optional:true},orderBy:{type:Array,element:Object,optional:true},searchViewArch:{type:String,optional:true},searchViewFields:{type:Object,optional:true},searchViewId:{type:[Number,Boolean],optional:true},irFilters:{type:Array,element:Object,optional:true},loadIrFilters:{type:Boolean,optional:true},activateFavorite:{type:Boolean,optional:true},dynamicFilters:{type:Array,element:Object,optional:true},hideCustomGroupBy:{type:Boolean,optional:true},searchMenuTypes:{type:Array,element:String,optional:true},canOrderByCount:{type:Boolean,optional:true},defaultGroupBy:{type:Array,element:String,optional:true},};setup(){if(!this.env.__getContext__){useSubEnv({__getContext__:new CallbackRecorder()});}
if(!this.env.__getOrderBy__){useSubEnv({__getOrderBy__:new CallbackRecorder()});}
const SearchModelClass=this.props.SearchModel||SearchModel;this.searchModel=new SearchModelClass(this.env,{orm:useService("orm"),view:useService("view"),field:useService("field"),name:useService("name"),dialog:useService("dialog"),treeProcessor:useService("tree_processor"),},this.props.searchModelArgs);const searchPanelState=this.props.globalState?.searchPanel?JSON.parse(this.props.globalState?.searchPanel):null;useSubEnv({searchModel:this.searchModel,searchPanelState});useBus(this.searchModel,"update",this.render);useSetupAction({getGlobalState:()=>({searchModel:JSON.stringify(this.searchModel.exportState()),}),});onWillStart(async()=>{const config={...toRaw(this.props)};if(config.globalState&&config.globalState.searchModel){config.state=JSON.parse(config.globalState.searchModel);delete config.globalState;}
await this.searchModel.load(config);});onWillUpdateProps(async(nextProps)=>{const config={};for(const key of SEARCH_KEYS){if(nextProps[key]!==undefined){config[key]=nextProps[key];}}
await this.searchModel.reload(config);});}}
return __exports;});;

/* /web/static/src/views/view.js */
odoo.define('@web/views/view',['@web/core/debug/debug_context','@web/core/py_js/py','@web/core/registry','@web/core/utils/concurrency','@web/core/utils/hooks','@web/core/utils/objects','@web/core/utils/strings','@web/core/utils/xml','@web/search/layout','@web/search/with_search/with_search','@web/views/view_hook','@web/views/utils','@web/core/assets','@web/core/browser/cookie','@odoo/owl','@web/session'],function(require){'use strict';let __exports={};const{useDebugCategory}=require("@web/core/debug/debug_context");const{evaluateBooleanExpr}=require("@web/core/py_js/py");const{registry}=require("@web/core/registry");const{KeepLast}=require("@web/core/utils/concurrency");const{useService}=require("@web/core/utils/hooks");const{deepCopy,pick}=require("@web/core/utils/objects");const{nbsp}=require("@web/core/utils/strings");const{parseXML}=require("@web/core/utils/xml");const{extractLayoutComponents}=require("@web/search/layout");const{WithSearch}=require("@web/search/with_search/with_search");const{useActionLinks}=require("@web/views/view_hook");const{computeViewClassName}=require("@web/views/utils");const{loadBundle}=require("@web/core/assets");const{cookie}=require("@web/core/browser/cookie");const{Component,markRaw,onWillUpdateProps,onWillStart,toRaw,useSubEnv,reactive,}=require("@odoo/owl");const{session}=require("@web/session");const viewRegistry=registry.category("views");viewRegistry.addValidation({type:{validate:(t)=>t in session.view_info},Controller:{validate:(c)=>c.prototype instanceof Component},"*":true,});__exports.getDefaultConfig=getDefaultConfig;function getDefaultConfig(){let displayName;const config={actionId:false,actionType:false,cache:true,actionXmlId:false,embeddedActions:[],currentEmbeddedActionId:false,parentActionId:false,breadcrumbs:reactive([{get name(){return displayName;},},]),disableSearchBarAutofocus:false,getDisplayName:()=>displayName,historyBack:()=>{},pagerProps:{},setDisplayName:(newDisplayName)=>{displayName=newDisplayName;config.breadcrumbs.push(undefined);config.breadcrumbs.pop();},viewSwitcherEntries:[],views:[],};return config;}
const ViewNotFoundError=__exports.ViewNotFoundError=class ViewNotFoundError extends Error{}
const CALLBACK_RECORDER_NAMES=["__beforeLeave__","__getGlobalState__","__getLocalState__","__getContext__","__getOrderBy__",];const STANDARD_PROPS=["resModel","type","jsClass","arch","fields","relatedModels","viewId","views","actionMenus","loadActionMenus","searchViewArch","searchViewFields","searchViewId","irFilters","loadIrFilters","context","domain","groupBy","orderBy","useSampleModel","noContentHelp","className","display","globalState","activateFavorite","dynamicFilters","hideCustomGroupBy","searchMenuTypes",...CALLBACK_RECORDER_NAMES,"searchPanel","searchModel",];const ACTIONS=["create","delete","edit","group_create","group_delete","group_edit"];const View=__exports.View=class View extends Component{static _download=async function(){};static template="web.View";static components={WithSearch};static searchMenuTypes=["filter","groupBy","favorite"];static canOrderByCount=false;static defaultProps={display:{},context:{},loadActionMenus:false,loadIrFilters:false,className:"",};static props={"*":true,};setup(){const{arch,fields,resModel,searchViewArch,searchViewFields,type}=this.props;if(!resModel){throw Error(`View props should have a "resModel" key`);}
if(!type){throw Error(`View props should have a "type" key`);}
if((arch&&!fields)||(!arch&&fields)){throw new Error(`"arch" and "fields" props must be given together`);}
if((searchViewArch&&!searchViewFields)||(!searchViewArch&&searchViewFields)){throw new Error(`"searchViewArch" and "searchViewFields" props must be given together`);}
this.viewService=useService("view");this.withSearchProps=null;useSubEnv({keepLast:new KeepLast(),config:{...getDefaultConfig(),...this.env.config,},...Object.fromEntries(CALLBACK_RECORDER_NAMES.map((name)=>[name,this.props[name]||null])),});this.handleActionLinks=useActionLinks({resModel});onWillStart(()=>this.loadView(this.props));onWillUpdateProps((nextProps)=>this.onWillUpdateProps(nextProps));useDebugCategory("view",{component:this});}
async loadView(props){const type=props.type;if(!session.view_info[type]){throw new Error(`Invalid view type: ${type}`);}
let{viewId,searchViewId}=props;const views=deepCopy(props.views||this.env.config.views);const view=views.find((v)=>v[1]===type)||[];if(view.length){view[0]=viewId!==undefined?viewId:view[0];viewId=view[0];}else{view.push(viewId||false,type);views.push(view);}
const searchView=views.find((v)=>v[1]==="search");if(searchView){searchView[0]=searchViewId!==undefined?searchViewId:searchView[0];searchViewId=searchView[0];}else if(searchViewId!==undefined){views.push([searchViewId,"search"]);}
const{context,resModel,loadActionMenus,loadIrFilters}=props;let{arch,fields,relatedModels,searchViewArch,searchViewFields,irFilters,actionMenus,}=props;const loadView=!arch||(!actionMenus&&loadActionMenus);const loadSearchView=(searchViewId!==undefined&&!searchViewArch)||(!irFilters&&loadIrFilters);let viewDescription={viewId,resModel,type};let searchViewDescription;if(loadView||loadSearchView){const options={actionId:this.env.config.actionId,loadActionMenus,loadIrFilters,};if(this.env.config.currentEmbeddedActionId){options.embeddedActionId=this.env.config.currentEmbeddedActionId;options.embeddedParentResId=context.active_id;}
const result=await this.viewService.loadViews({context,resModel,views},options);viewDescription=result.views[type];searchViewDescription=result.views.search;if(loadSearchView){searchViewId=searchViewId||searchViewDescription.id;if(!searchViewArch){searchViewArch=searchViewDescription.arch;searchViewFields=result.fields;}
if(!irFilters){irFilters=searchViewDescription.irFilters;}}
this.env.config.views=views;fields=fields||markRaw(result.fields);relatedModels=relatedModels||markRaw(result.relatedModels);}
if(!arch){arch=viewDescription.arch;}
if(!actionMenus){actionMenus=viewDescription.actionMenus;}
const archXmlDoc=parseXML(arch.replace(/&amp;nbsp;/g,nbsp));for(const action of ACTIONS){if(action in this.props.context&&!this.props.context[action]){archXmlDoc.setAttribute(action,"0");}}
const jsClass=archXmlDoc.hasAttribute("js_class")?archXmlDoc.getAttribute("js_class"):props.jsClass||type;if(!viewRegistry.contains(jsClass)){await loadBundle(cookie.get("color_scheme")==="dark"?"web.assets_backend_lazy_dark":"web.assets_backend_lazy");}
const descr=viewRegistry.get(jsClass);const sample=archXmlDoc.getAttribute("sample");const className=computeViewClassName(type,archXmlDoc,["o_view_controller",...(props.className||"").split(" "),]);Object.assign(this.env.config,{rawArch:arch,viewArch:archXmlDoc,viewId:viewDescription.id,viewType:type,viewSubType:jsClass,noBreadcrumbs:props.noBreadcrumbs,...extractLayoutComponents(descr),});const info={actionMenus,mode:props.display.mode,irFilters,searchViewArch,searchViewFields,searchViewId,};const viewProps={info,arch:archXmlDoc,fields,relatedModels,resModel,useSampleModel:false,className,};if(viewDescription.custom_view_id){viewProps.info.customViewId=viewDescription.custom_view_id;}
if(props.globalState){viewProps.globalState=props.globalState;}
if("useSampleModel"in props){viewProps.useSampleModel=props.useSampleModel;}else if(sample){viewProps.useSampleModel=evaluateBooleanExpr(sample);}
for(const key in props){if(!STANDARD_PROPS.includes(key)){viewProps[key]=props[key];}}
const{noContentHelp}=props;if(noContentHelp){viewProps.info.noContentHelp=noContentHelp;}
const searchMenuTypes=props.searchMenuTypes||descr.searchMenuTypes||this.constructor.searchMenuTypes;const defaultGroupBy=archXmlDoc.hasAttribute("default_group_by")?archXmlDoc.getAttribute("default_group_by").split(","):null;viewProps.searchMenuTypes=searchMenuTypes;const canOrderByCount=descr.canOrderByCount||this.constructor.canOrderByCount;const finalProps=descr.props?descr.props(viewProps,descr,this.env.config):viewProps;this.Controller=descr.Controller;this.componentProps=finalProps;this.withSearchProps={...toRaw(props),hideCustomGroupBy:props.hideCustomGroupBy||descr.hideCustomGroupBy,searchMenuTypes,canOrderByCount,SearchModel:descr.SearchModel,};if(searchViewId!==undefined){this.withSearchProps.searchViewId=searchViewId;}
if(searchViewArch){this.withSearchProps.searchViewArch=searchViewArch;this.withSearchProps.searchViewFields=searchViewFields;}
if(irFilters){this.withSearchProps.irFilters=irFilters;}
if(descr.display){const viewDisplay=deepCopy(descr.display);const display={...this.withSearchProps.display};for(const key in viewDisplay){if(typeof display[key]==="object"){Object.assign(display[key],viewDisplay[key]);}else if(!(key in display)||display[key]){display[key]=viewDisplay[key];}}
this.withSearchProps.display=display;}
if(defaultGroupBy&&defaultGroupBy.length){this.withSearchProps.defaultGroupBy=defaultGroupBy;}
for(const key in this.withSearchProps){if(!(key in WithSearch.props)){delete this.withSearchProps[key];}}}
onWillUpdateProps(nextProps){const oldProps=pick(this.props,"arch","type","resModel");const newProps=pick(nextProps,"arch","type","resModel");if(JSON.stringify(oldProps)!==JSON.stringify(newProps)){return this.loadView(nextProps);}
const{context,domain,groupBy,orderBy}=nextProps;Object.assign(this.withSearchProps,{context,domain,groupBy,orderBy});}}
return __exports;});;

/* /web/static/src/views/view_hook.js */
odoo.define('@web/views/view_hook',['@web/core/l10n/translation','@web/core/utils/hooks','@web/core/browser/browser','@web/core/py_js/py','@web/core/network/download','@web/core/network/rpc','@web/views/view_dialogs/export_data_dialog','@web/core/confirmation_dialog/confirmation_dialog','@odoo/owl','@web/model/relational_model/dynamic_list'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web",...args);const{useBus,useService}=require("@web/core/utils/hooks");const{browser}=require("@web/core/browser/browser");const{evaluateExpr}=require("@web/core/py_js/py");const{download}=require("@web/core/network/download");const{rpc}=require("@web/core/network/rpc");const{ExportDataDialog}=require("@web/views/view_dialogs/export_data_dialog");const{deleteConfirmationMessage,ConfirmationDialog,}=require("@web/core/confirmation_dialog/confirmation_dialog");const{useComponent,useEffect}=require("@odoo/owl");const{DynamicList}=require("@web/model/relational_model/dynamic_list");__exports.useActionLinks=useActionLinks;function useActionLinks({resModel,reload}){const component=useComponent();const keepLast=component.env.keepLast;const orm=useService("orm");const{doAction}=useService("action");async function handler(ev){ev.preventDefault();ev.stopPropagation();let target=ev.target;if(target.tagName!=="A"){target=target.closest("a");}
const data=target.dataset;if(data.method!==undefined&&data.model!==undefined){const options={};if(data.reloadOnClose){options.onClose=reload||(()=>component.render());}
const action=await keepLast.add(orm.call(data.model,data.method));if(action!==undefined){keepLast.add(Promise.resolve(doAction(action,options)));}}else if(target.getAttribute("name")){const options={};if(data.context){options.additionalContext=evaluateExpr(data.context);}
keepLast.add(doAction(target.getAttribute("name"),options));}else{let views;const resId=data.resid?parseInt(data.resid,10):null;if(data.views){views=evaluateExpr(data.views);}else{views=resId?[[false,"form"]]:[[false,"list"],[false,"form"],];}
const action={name:target.getAttribute("title")||target.textContent.trim(),type:"ir.actions.act_window",res_model:data.model||resModel,target:"current",views,domain:data.domain?evaluateExpr(data.domain):[],};if(resId){action.res_id=resId;}
const options={};if(data.context){options.additionalContext=evaluateExpr(data.context);}
keepLast.add(doAction(action,options));}}
return(ev)=>{const a=ev.target.closest(`a[type="action"]`);if(a&&ev.currentTarget.contains(a)){handler(ev);}};}
__exports.useBounceButton=useBounceButton;function useBounceButton(containerRef,shouldBounce){let timeout;const ui=useService("ui");useEffect((containerEl)=>{if(!containerEl){return;}
const handler=(ev)=>{const button=ui.activeElement.querySelector("[data-bounce-button]");if(button&&shouldBounce(ev.target)){button.classList.add("o_catch_attention");browser.clearTimeout(timeout);timeout=browser.setTimeout(()=>{button.classList.remove("o_catch_attention");},400);}};containerEl.addEventListener("click",handler);return()=>containerEl.removeEventListener("click",handler);},()=>[containerRef.el]);}
__exports.useExportRecords=useExportRecords;function useExportRecords(env,context,getDefaultExportList){const{model,searchModel}=env;useBus(searchModel,"direct-export-data",async()=>{_downloadExport(getDefaultExportList(),false,"xlsx");});const _getExportedFields=async(isCompatible,parentParams)=>{const root=model.root;let domain=parentParams?[]:root.domain;if(!root.isDomainSelected&&root.selection.length>0){const ids=root.selection.map((e)=>e.resId);domain=[["id","in",ids]];}
return await rpc("/web/export/get_fields",{model:root.resModel,domain,import_compat:isCompatible,...parentParams,});};const _downloadExport=async(fields,import_compat,format)=>{const root=model.root;const exportedFields=fields.map((field)=>({name:field.name||field.id,label:field.label||field.string,store:field.store,type:field.field_type||field.type,}));if(import_compat){exportedFields.unshift({name:"id",label:_t("External ID"),});}
await download({data:{data:JSON.stringify({import_compat,context:root.context,domain:root.domain,fields:exportedFields,groupby:root.groupBy,ids:!root.isDomainSelected&&root.selection.length>0?root.selection.map((e)=>e.resId):false,model:root.resModel,}),},url:`/web/export/${format}`,});};return()=>{const root=model.root;model.dialog.add(ExportDataDialog,{context:root.context,defaultExportList:getDefaultExportList(),download:_downloadExport,getExportedFields:_getExportedFields,root,});};}
__exports.useDeleteRecords=useDeleteRecords;function useDeleteRecords(model){function getDefaultDialogProps(records){const isDynamicList=model.root instanceof DynamicList;let body=deleteConfirmationMessage;if(records?.length>1||(isDynamicList&&(model.root.isDomainSelected||model.root.selection.length>1))){body=_t("Are you sure you want to delete these records?");}
let confirm=()=>records.forEach((r)=>r.delete());if(isDynamicList){confirm=()=>model.root.deleteRecords(records);}
return{body,cancel:()=>{},cancelLabel:_t("No, keep it"),confirm,confirmLabel:_t("Delete"),title:_t("Bye-bye, record!"),};}
return(dialogProps,records)=>{const defaultProps=getDefaultDialogProps(records);model.dialog.add(ConfirmationDialog,{...defaultProps,...dialogProps});};}
return __exports;});;

/* /web/static/src/webclient/actions/action_dialog.js */
odoo.define('@web/webclient/actions/action_dialog',['@web/core/dialog/dialog','@web/core/debug/debug_menu','@web/core/debug/debug_context'],function(require){'use strict';let __exports={};const{Dialog}=require("@web/core/dialog/dialog");const{DebugMenu}=require("@web/core/debug/debug_menu");const{useOwnDebugContext}=require("@web/core/debug/debug_context");const ActionDialog=__exports.ActionDialog=class ActionDialog extends Dialog{static components={...Dialog.components,DebugMenu};static template="web.ActionDialog";static props={...Dialog.props,close:Function,slots:{optional:true},ActionComponent:{optional:true},actionProps:{optional:true},actionType:{optional:true},title:{optional:true},};static defaultProps={...Dialog.defaultProps,withBodyPadding:false,};setup(){super.setup();useOwnDebugContext();}}
return __exports;});;

/* /web/static/src/webclient/actions/reports/utils.js */
odoo.define('@web/webclient/actions/reports/utils',['@web/core/l10n/translation','@web/core/network/download'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web",...args);const{download}=require("@web/core/network/download");__exports.getReportUrl=getReportUrl;function getReportUrl(action,type,userContext){let url=`/report/${type}/${action.report_name}`;const actionContext=action.context||{};if(action.data&&JSON.stringify(action.data)!=="{}"){const options=encodeURIComponent(JSON.stringify(action.data));const context=encodeURIComponent(JSON.stringify(actionContext));url+=`?options=${options}&context=${context}`;}else{if(actionContext.active_ids){url+=`/${actionContext.active_ids.join(",")}`;}
if(type==="html"){const context=encodeURIComponent(JSON.stringify(userContext));url+=`?context=${context}`;}}
return url;}
function getWKHTMLTOPDF_MESSAGES(status){const link='<br><br><a href="http://wkhtmltopdf.org/" target="_blank">wkhtmltopdf.org</a>';const _status={broken:_t("Your installation of Wkhtmltopdf seems to be broken. The report will be shown in html.%(link)s",{link}),install:_t("Unable to find Wkhtmltopdf on this system. The report will be shown in html.%(link)s",{link}),upgrade:_t("You should upgrade your version of Wkhtmltopdf to at least 0.12.0 in order to get a correct display of headers and footers as well as support for table-breaking between pages.%(link)s",{link}),workers:_t("You need to start Odoo with at least two workers to print a pdf version of the reports."),};return _status[status];}
__exports.downloadReport=downloadReport;async function downloadReport(rpc,action,type,userContext){let message;if(type==="pdf"){downloadReport.wkhtmltopdfStatusProm||=rpc("/report/check_wkhtmltopdf");const status=await downloadReport.wkhtmltopdfStatusProm;message=getWKHTMLTOPDF_MESSAGES(status);if(!["upgrade","ok"].includes(status)){return{success:false,message};}}
const url=getReportUrl(action,type);await download({url:"/report/download",data:{data:JSON.stringify([url,action.report_type]),context:JSON.stringify(userContext),},});return{success:true,message};}
return __exports;});;

/* /web/static/src/webclient/actions/reports/report_action.js */
odoo.define('@web/webclient/actions/reports/report_action',['@web/core/utils/hooks','@web/search/action_hook','@web/search/layout','@web/views/view','@web/webclient/actions/reports/report_hook','@odoo/owl'],function(require){'use strict';let __exports={};const{useService}=require("@web/core/utils/hooks");const{useSetupAction}=require("@web/search/action_hook");const{Layout}=require("@web/search/layout");const{getDefaultConfig}=require("@web/views/view");const{useEnrichWithActionLinks}=require("@web/webclient/actions/reports/report_hook");const{Component,useRef,useSubEnv}=require("@odoo/owl");const ReportAction=__exports.ReportAction=class ReportAction extends Component{static components={Layout};static template="web.ReportAction";static props=["*"];setup(){useSubEnv({config:{...getDefaultConfig(),...this.env.config,},});useSetupAction();this.action=useService("action");this.title=this.props.display_name||this.props.name;this.reportUrl=this.props.report_url;this.iframe=useRef("iframe");useEnrichWithActionLinks(this.iframe);}
onIframeLoaded(ev){const iframeDocument=ev.target.contentWindow.document;iframeDocument.body.classList.add("o_in_iframe","container-fluid");iframeDocument.body.classList.remove("container");}
print(){this.action.doAction({type:"ir.actions.report",report_type:"qweb-pdf",report_name:this.props.report_name,report_file:this.props.report_file,data:this.props.data||{},context:this.props.context||{},display_name:this.title,});}}
return __exports;});;

/* /web/static/src/webclient/actions/reports/report_hook.js */
odoo.define('@web/webclient/actions/reports/report_hook',['@odoo/owl'],function(require){'use strict';let __exports={};const{useComponent,useEffect}=require("@odoo/owl");__exports.useEnrichWithActionLinks=useEnrichWithActionLinks;function useEnrichWithActionLinks(ref,selector=null){const comp=useComponent();useEffect((element)=>{if(element.matches("iframe")){element.onload=()=>enrich(comp,element,selector,true);}else{enrich(comp,element,selector);}},()=>[ref.el]);}
function enrich(component,targetElement,selector,isIFrame=false){let doc=window.document;if(isIFrame){targetElement=targetElement.contentDocument;doc=targetElement;}
const targets=[];if(selector){targets.push(...targetElement.querySelectorAll(selector));}else{targets.push(targetElement);}
for(const currentTarget of targets){const elementsToWrap=currentTarget.querySelectorAll("[res-id][res-model][view-type]");for(const element of elementsToWrap.values()){const wrapper=doc.createElement("a");wrapper.setAttribute("href","#");wrapper.addEventListener("click",(ev)=>{ev.preventDefault();component.env.services.action.doAction({type:"ir.actions.act_window",view_mode:element.getAttribute("view-type"),res_id:Number(element.getAttribute("res-id")),res_model:element.getAttribute("res-model"),views:[[element.getAttribute("view-id"),element.getAttribute("view-type")]],});});element.parentNode.insertBefore(wrapper,element);wrapper.appendChild(element);}}}
return __exports;});;

/* /web/static/src/views/utils.js */
odoo.define('@web/views/utils',['@web/core/l10n/translation','@web/core/registry','@web/core/utils/arrays','@web/core/utils/strings','@web/model/relational_model/utils'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web",...args);const{registry}=require("@web/core/registry");const{unique}=require("@web/core/utils/arrays");const{exprToBoolean}=require("@web/core/utils/strings");const{combineModifiers}=require("@web/model/relational_model/utils");const X2M_TYPES=__exports.X2M_TYPES=["one2many","many2many"];const NUMERIC_TYPES=["integer","float","monetary"];const BUTTON_CLICK_PARAMS=__exports.BUTTON_CLICK_PARAMS=["name","type","args","block-ui","context","close","cancel-label","confirm","confirm-title","confirm-label","special","effect","help","debounce","noSaveDialog",];function getViewClass(type){const isValidType=Boolean(type)&&registry.category("views").contains(type);return isValidType&&`o_${type}_view`;}
__exports.computeViewClassName=computeViewClassName;function computeViewClassName(viewType,rootNode,additionalClassList=[]){const subType=rootNode?.getAttribute("js_class");const classList=rootNode?.getAttribute("class")?.split(" ")||[];const uniqueClasses=new Set([getViewClass(viewType),getViewClass(subType),...classList,...additionalClassList,]);return Array.from(uniqueClasses).filter((c)=>c).join(" ");}
const computeReportMeasures=__exports.computeReportMeasures=(fields,fieldAttrs,activeMeasures,{sumAggregatorOnly=false}={})=>{const measures={__count:{name:"__count",string:_t("Count"),type:"integer"},};for(const[fieldName,field]of Object.entries(fields)){if(fieldName==="id"){continue;}
const{isInvisible}=fieldAttrs[fieldName]||{};if(isInvisible){continue;}
if(["integer","float","monetary"].includes(field.type)&&((sumAggregatorOnly&&field.aggregator==="sum")||(!sumAggregatorOnly&&field.aggregator))){measures[fieldName]=field;}}
for(const measure of activeMeasures){if(!measures[measure]){measures[measure]=fields[measure];}}
for(const fieldName in fieldAttrs){if(fieldAttrs[fieldName].string&&fieldName in measures){measures[fieldName].string=fieldAttrs[fieldName].string;}}
const sortedMeasures=Object.entries(measures).sort(([m1,f1],[m2,f2])=>{if(m1==="__count"||m2==="__count"){return m1==="__count"?1:-1;}
return f1.string.toLowerCase().localeCompare(f2.string.toLowerCase());});return Object.fromEntries(sortedMeasures);};__exports.getFormattedValue=getFormattedValue;function getFormattedValue(record,fieldName,fieldInfo=null){const field=record.fields[fieldName];const formatter=registry.category("formatters").get(field.type,(val)=>val);const formatOptions={};if(fieldInfo&&formatter.extractOptions){Object.assign(formatOptions,formatter.extractOptions(fieldInfo));}
formatOptions.data=record.data;formatOptions.field=field;return record.data[fieldName]!==undefined?formatter(record.data[fieldName],formatOptions):"";}
__exports.getActiveActions=getActiveActions;function getActiveActions(rootNode){const activeActions={type:"view",edit:exprToBoolean(rootNode.getAttribute("edit"),true),create:exprToBoolean(rootNode.getAttribute("create"),true),delete:exprToBoolean(rootNode.getAttribute("delete"),true),};activeActions.duplicate=activeActions.create&&exprToBoolean(rootNode.getAttribute("duplicate"),true);return activeActions;}
__exports.getClassNameFromDecoration=getClassNameFromDecoration;function getClassNameFromDecoration(decoration){if(decoration==="bf"){return"fw-bold";}else if(decoration==="it"){return"fst-italic";}
return`text-${decoration}`;}
__exports.getDecoration=getDecoration;function getDecoration(rootNode){const decorations=[];for(const name of rootNode.getAttributeNames()){if(name.startsWith("decoration-")){decorations.push({class:getClassNameFromDecoration(name.replace("decoration-","")),condition:rootNode.getAttribute(name),});}}
return decorations;}
__exports.isX2Many=isX2Many;function isX2Many(field){return field&&X2M_TYPES.includes(field.type);}
__exports.isNumeric=isNumeric;function isNumeric(field){return NUMERIC_TYPES.includes(field.type);}
__exports.isNull=isNull;function isNull(value){return[null,undefined].includes(value);}
__exports.processButton=processButton;function processButton(node){const withDefault={close:(val)=>exprToBoolean(val,false),context:(val)=>val||"{}",};const clickParams={};const attrs={};for(const{name,value}of node.attributes){if(BUTTON_CLICK_PARAMS.includes(name)){clickParams[name]=withDefault[name]?withDefault[name](value):value;}else{attrs[name]=value;}}
return{className:node.getAttribute("class")||"",disabled:!!node.getAttribute("disabled")||false,icon:node.getAttribute("icon")||false,title:node.getAttribute("title")||undefined,string:node.getAttribute("string")||undefined,options:JSON.parse(node.getAttribute("options")||"{}"),display:node.getAttribute("display")||"selection",clickParams,column_invisible:node.getAttribute("column_invisible"),invisible:combineModifiers(node.getAttribute("column_invisible"),node.getAttribute("invisible"),"OR"),readonly:node.getAttribute("readonly"),required:node.getAttribute("required"),attrs,};}
__exports.processMeasure=processMeasure;function processMeasure(measure){if(Array.isArray(measure)){return measure.map(processMeasure);}
return measure==="__count__"?"__count":measure;}
__exports.toStringExpression=toStringExpression;function toStringExpression(str){return`\`${str.replaceAll("`", "\\`")}\``;}
__exports.computeAggregatedValue=computeAggregatedValue;function computeAggregatedValue(values,aggregator){if(aggregator==="sum"){return values.reduce((acc,v)=>v+acc,0);}else if(aggregator==="avg"){return values.reduce((acc,v)=>v+acc,0)/values.length;}else if(aggregator==="min"){return Math.min(Infinity,...values);}else if(aggregator==="max"){return Math.max(-Infinity,...values);}else if(aggregator==="count"){return values.length;}else if(aggregator==="count_distinct"){return unique(values).length;}
throw new Error(`Invalid aggregator '${aggregator}'`);}
return __exports;});;

/* /web/static/src/views/fields/formatters.js */
odoo.define('@web/views/fields/formatters',['@web/core/l10n/dates','@web/core/l10n/localization','@web/core/l10n/translation','@web/core/registry','@web/core/utils/binary','@web/core/utils/numbers','@web/core/utils/strings','@odoo/owl','@web/core/currency'],function(require){'use strict';let __exports={};const{formatDate:_formatDate,formatDateTime:_formatDateTime,toLocaleDateString,toLocaleDateTimeString,}=require("@web/core/l10n/dates");const{localization:l10n}=require("@web/core/l10n/localization");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web",...args);const{registry}=require("@web/core/registry");const{isBinarySize}=require("@web/core/utils/binary");const{formatFloat:formatFloatNumber,humanNumber,insertThousandsSep,}=require("@web/core/utils/numbers");const{exprToBoolean}=require("@web/core/utils/strings");const{markup}=require("@odoo/owl");const{formatCurrency}=require("@web/core/currency");function humanSize(value){if(!value){return"";}
const suffix=value<1024?" "+_t("Bytes"):"b";return(humanNumber(value,{decimals:2,})+suffix);}
__exports.formatBinary=formatBinary;function formatBinary(value){if(!isBinarySize(value)){return humanSize(value.length/1.37);}
return value;}
__exports.formatBoolean=formatBoolean;function formatBoolean(value){return markup`
        <div class="o-checkbox d-inline-block me-2">
            <input id="boolean_checkbox" type="checkbox" class="form-check-input" disabled ${
                value ? "checked" : ""
            }/>
            <label for="boolean_checkbox" class="form-check-label"/>
        </div>`;}
__exports.formatChar=formatChar;function formatChar(value,options){if(options&&options.isPassword){return"*".repeat(value?value.length:0);}
return value||"";}
formatChar.extractOptions=({attrs})=>({isPassword:exprToBoolean(attrs.password),});__exports.formatDate=formatDate;function formatDate(value,options={}){if(options.numeric){return _formatDate(value,options);}else{return toLocaleDateString(value);}}
formatDate.extractOptions=({options})=>({numeric:exprToBoolean(options.numeric??false),});__exports.formatDateTime=formatDateTime;function formatDateTime(value,options={}){if(options.numeric){if(options.showTime===false){return _formatDate(value,options);}
return _formatDateTime(value,options);}else{return toLocaleDateTimeString(value,options);}}
formatDateTime.extractOptions=({attrs,options})=>({...formatDate.extractOptions({attrs,options}),showSeconds:exprToBoolean(options.show_seconds??false),showTime:exprToBoolean(options.show_time??true),showDate:exprToBoolean(options.show_date??true),});__exports.formatFloat=formatFloat;function formatFloat(value,options={}){if(value===false){return"";}
if(!options.digits&&options.field){options.digits=options.field.digits;}
return formatFloatNumber(value,options);}
formatFloat.extractOptions=({attrs,options})=>{let digits;if(attrs.digits){digits=JSON.parse(attrs.digits);}else if(options.digits){digits=options.digits;}
const humanReadable=!!options.human_readable;const decimals=options.decimals||0;const trailingZeros=!options.hide_trailing_zeros;return{decimals,digits,humanReadable,trailingZeros};};__exports.formatFloatFactor=formatFloatFactor;function formatFloatFactor(value,options={}){if(value===false){return"";}
const factor=options.factor||1;if(!options.digits&&options.field){options.digits=options.field.digits;}
return formatFloatNumber(value*factor,options);}
formatFloatFactor.extractOptions=({attrs,options})=>({...formatFloat.extractOptions({attrs,options}),factor:options.factor,});__exports.formatFloatTime=formatFloatTime;function formatFloatTime(value,options={}){if(value===false){return"";}
const isNegative=value<0;value=Math.abs(value);let hour=Math.floor(value);const milliSecLeft=Math.round(value*3600000)-hour*3600000;let min=milliSecLeft/60000;if(options.displaySeconds){min=Math.floor(min);}else{min=Math.round(min);}
if(min===60){min=0;hour=hour+1;}
min=String(min).padStart(2,"0");if(!options.noLeadingZeroHour){hour=String(hour).padStart(2,"0");}
let sec="";if(options.displaySeconds){sec=":"+String(Math.floor((milliSecLeft%60000)/1000)).padStart(2,"0");}
return`${isNegative ? "-" : ""}${hour}:${min}${sec}`;}
formatFloatTime.extractOptions=({options})=>({displaySeconds:options.displaySeconds,});__exports.formatInteger=formatInteger;function formatInteger(value,options={}){if(value===false||value===null){return"";}
if(options.isPassword){return"*".repeat(value.length);}
if(options.humanReadable){return humanNumber(value,options);}
const grouping=options.grouping||l10n.grouping;const thousandsSep="thousandsSep"in options?options.thousandsSep:l10n.thousandsSep;return insertThousandsSep(value.toFixed(0),thousandsSep,grouping);}
formatInteger.extractOptions=({attrs,options})=>({decimals:options.decimals||0,humanReadable:!!options.human_readable,isPassword:exprToBoolean(attrs.password),});__exports.formatMany2one=formatMany2one;function formatMany2one(value,options){if(!value){value="";}else if("display_name"in value?value.display_name:value[1]){value="display_name"in value?value.display_name:value[1];}else{value=_t("Unnamed");}
if(options&&options.escape){value=encodeURIComponent(value);}
return value;}
__exports.formatX2many=formatX2many;function formatX2many(value){const count=value.currentIds.length;if(count===0){return _t("No records");}else if(count===1){return _t("1 record");}else{return _t("%s records",count);}}
__exports.formatMonetary=formatMonetary;function formatMonetary(value,options={}){if(value===false){return"";}
let currencyId=options.currencyId;if(!currencyId&&options.data){const currencyField=options.currencyField||(options.field&&options.field.currency_field)||"currency_id";const dataValue=options.data[currencyField];currencyId=dataValue?.id??dataValue;}
return formatCurrency(value,currencyId,options);}
formatMonetary.extractOptions=({options})=>({noSymbol:options.no_symbol,currencyField:options.currency_field,trailingZeros:!options.hide_trailing_zeros,});__exports.formatPercentage=formatPercentage;function formatPercentage(value,options={}){value=value||0;options=Object.assign({trailingZeros:false,thousandsSep:""},options);if(!options.digits&&options.field){options.digits=options.field.digits;}
const formatted=formatFloatNumber(value*100,options);return`${formatted}${options.noSymbol ? "" : "%"}`;}
formatPercentage.extractOptions=formatFloat.extractOptions;function formatProperties(value,field){if(!value||!value.length){return"";}
return value.map((property)=>property["string"]).join(", ");}
__exports.formatReference=formatReference;function formatReference(value,options){return formatMany2one(value?{id:value.resId,display_name:value.displayName}:false,options);}
__exports.formatMany2oneReference=formatMany2oneReference;function formatMany2oneReference(value){return value?formatMany2one({id:value.resId,display_name:value.displayName}):"";}
__exports.formatSelection=formatSelection;function formatSelection(value,options={}){const selection=options.selection||(options.field&&options.field.selection)||[];const option=selection.find((option)=>option[0]===value);return option?option[1]:"";}
__exports.formatText=formatText;function formatText(value){return value?value.toString():"";}
__exports.formatHtml=formatHtml;function formatHtml(value){return value||"";}
__exports.formatJson=formatJson;function formatJson(value){return(value&&JSON.stringify(value))||"";}
registry.category("formatters").add("binary",formatBinary).add("boolean",formatBoolean).add("char",formatChar).add("date",formatDate).add("datetime",formatDateTime).add("float",formatFloat).add("float_factor",formatFloatFactor).add("float_time",formatFloatTime).add("html",formatHtml).add("integer",formatInteger).add("json",formatJson).add("many2one",formatMany2one).add("many2one_reference",formatMany2oneReference).add("one2many",formatX2many).add("many2many",formatX2many).add("monetary",formatMonetary).add("percentage",formatPercentage).add("properties",formatProperties).add("properties_definition",formatProperties).add("reference",formatReference).add("selection",formatSelection).add("text",formatText);return __exports;});;

/* /web/static/src/views/fields/file_handler.js */
odoo.define('@web/views/fields/file_handler',['@web/core/l10n/translation','@web/core/utils/hooks','@web/core/utils/urls','@web/core/utils/files','@odoo/owl'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"web",...args);const{useService}=require("@web/core/utils/hooks");const{getDataURLFromFile}=require("@web/core/utils/urls");const{checkFileSize}=require("@web/core/utils/files");const{Component,useRef,useState}=require("@odoo/owl");const FileUploader=__exports.FileUploader=class FileUploader extends Component{static template="web.FileUploader";static props={onClick:{type:Function,optional:true},onUploaded:Function,onUploadComplete:{type:Function,optional:true},multiUpload:{type:Boolean,optional:true},checkSize:{type:Boolean,optional:true},inputName:{type:String,optional:true},fileUploadClass:{type:String,optional:true},acceptedFileExtensions:{type:String,optional:true},slots:{type:Object,optional:true},showUploadingText:{type:Boolean,optional:true},allowedMIMETypes:{type:String,optional:true},};static defaultProps={checkSize:true,showUploadingText:true,};setup(){this.notification=useService("notification");this.fileInputRef=useRef("fileInput");this.state=useState({isUploading:false,});}
async onFileChange(ev){const files=[...ev.target.files].filter(file=>this.validFileType(file));if(!files.length){return;}
const{target}=ev;for(const file of files){if(this.props.checkSize&&!checkFileSize(file.size,this.notification)){return null;}
this.state.isUploading=true;const data=await getDataURLFromFile(file);if(!file.size){console.warn(`Error while uploading file : ${file.name}`);this.notification.add(_t("There was a problem while uploading your file."),{type:"danger",});}
try{await this.props.onUploaded({name:file.name,size:file.size,type:file.type,data:data.split(",")[1],objectUrl:file.type==="application/pdf"?URL.createObjectURL(file):null,});}finally{this.state.isUploading=false;}}
target.value=null;if(this.props.multiUpload&&this.props.onUploadComplete){this.props.onUploadComplete({});}}
validFileType(file){if(this.props.allowedMIMETypes&&!this.props.allowedMIMETypes.includes(file.type)){this.notification.add(_t(`Oops! '%(fileName)s' didnt upload since its format isnt allowed.`,{fileName:file.name,}),{type:"danger",});return false;}
return true;}
async onSelectFileButtonClick(ev){if(this.props.onClick){const ok=await this.props.onClick(ev);if(ok!==undefined&&!ok){return;}}
this.fileInputRef.el.click();}}
return __exports;});;

/* /mail/static/src/model/export.js */
odoo.define('@mail/model/export',['@mail/model/store','@mail/model/record','@mail/model/make_store','@mail/model/misc'],function(require){'use strict';let __exports={};Object.assign(__exports,require("@mail/model/store"));Object.assign(__exports,require("@mail/model/record"));Object.assign(__exports,require("@mail/model/make_store"));{const{AND,OR,fields}=require("@mail/model/misc");Object.assign(__exports,{AND,OR,fields})};return __exports;});;

/* /mail/static/src/model/make_store.js */
odoo.define('@mail/model/make_store',['@odoo/owl','@mail/model/store','@mail/model/misc','@mail/model/record','@mail/model/store_internal','@mail/model/model_internal','@mail/model/record_internal'],function(require){'use strict';let __exports={};const{markRaw,reactive,toRaw}=require("@odoo/owl");const{Store}=require("@mail/model/store");const{STORE_SYM,isFieldDefinition,isMany,isRelation,modelRegistry}=require("@mail/model/misc");const{Record}=require("@mail/model/record");const{StoreInternal}=require("@mail/model/store_internal");const{ModelInternal}=require("@mail/model/model_internal");const{RecordInternal}=require("@mail/model/record_internal");__exports.makeStore=makeStore;function makeStore(env,{localRegistry}={}){const recordByLocalId=reactive(new Map());let store=new Store();store.env=env;store.Model=Store;store._=markRaw(new StoreInternal());store._raw=store;store._proxyInternal=store;store._proxy=store;store.recordByLocalId=recordByLocalId;Record.store=store;const Models={};const chosenModelRegistry=localRegistry??modelRegistry;for(const[,_OgClass]of chosenModelRegistry.getEntries()){const OgClass=_OgClass;if(store[OgClass.getName()]){throw new Error(`There must be no duplicated Model Names (duplicate found: ${OgClass.getName()})`);}
const Model=Object.create(OgClass);const Class={[OgClass.getName()]:class extends OgClass{constructor(){super();this.setup();const record=this;record._raw=record;record.Model=Model;record._=markRaw(record[STORE_SYM]?new StoreInternal():new RecordInternal());const recordProxyInternal=new Proxy(record,{get(record,name,recordFullProxy){recordFullProxy=record._.downgradeProxy(record,recordFullProxy);if(record._.gettingField||!Model._.fields.get(name)){let res=Reflect.get(...arguments);if(typeof res==="function"){res=res.bind(recordFullProxy);}
return res;}
if(Model._.fieldsCompute.get(name)&&!Model._.fieldsEager.get(name)){record._.fieldsComputeInNeed.set(name,true);if(record._.fieldsComputeOnNeed.get(name)){record._.compute(record,name);}}
if(Model._.fieldsSort.get(name)&&!Model._.fieldsEager.get(name)){record._.fieldsSortInNeed.set(name,true);if(record._.fieldsSortOnNeed.get(name)){record._.sort(record,name);}}
record._.gettingField=true;const val=recordFullProxy[name];record._.gettingField=false;if(isRelation(Model,name)){const recordListFullProxy=val._proxy;if(isMany(Model,name)){return recordListFullProxy;}
return recordListFullProxy[0];}
return Reflect.get(record,name,recordFullProxy);},deleteProperty(record,name){return store.MAKE_UPDATE(function recordDeleteProperty(){if(isRelation(Model,name)){const recordList=record[name];recordList.clear();return true;}
return Reflect.deleteProperty(record,name);});},set(record,name,val,receiver){if(record._.updatingAttrs.has(name)){record[name]=val;return true;}
return store.MAKE_UPDATE(function recordSet(){const reactiveSet=receiver!==record._proxyInternal;if(reactiveSet){record._.proxyUsed.set(name,true);}
store._.updateFields(record,{[name]:val});if(reactiveSet){record._.proxyUsed.delete(name);}
return true;});},});record._proxyInternal=recordProxyInternal;const recordProxy=reactive(recordProxyInternal);record._proxy=recordProxy;if(record?.[STORE_SYM]){record.recordByLocalId=store.recordByLocalId;record._=markRaw(toRaw(store._));store=record;Record.store=store;}
for(const name of Model._.fields.keys()){record._.prepareField(record,name,recordProxy);}
return recordProxy;}},}[OgClass.getName()];Model._=markRaw(new ModelInternal());Object.assign(Model,{Class,records:reactive({}),});Models[Model.getName()]=Model;store[Model.getName()]=Model;const obj=new OgClass();obj.setup();for(const[name,val]of Object.entries(obj)){if(isFieldDefinition(val)){Model._.prepareField(name,val);}}}
for(const Model of Object.values(Models)){for(const name of Model._.fields.keys()){if(!isRelation(Model,name)){continue;}
const targetModel=Model._.fieldsTargetModel.get(name);const inverse=Model._.fieldsInverse.get(name);if(targetModel&&!Models[targetModel]){throw new Error(`No target model ${targetModel} exists`);}
if(inverse){const OtherModel=Models[targetModel];const rel2TargetModel=OtherModel._.fieldsTargetModel.get(inverse);const rel2Inverse=OtherModel._.fieldsInverse.get(inverse);if(rel2TargetModel&&rel2TargetModel!==Model.getName()){throw new Error(`Fields ${Models[
                            targetModel
                        ].getName()}.${inverse} has wrong targetModel. Expected: "${Model.getName()}" Actual: "${rel2TargetModel}"`);}
if(rel2Inverse&&rel2Inverse!==name){throw new Error(`Fields ${Models[
                            targetModel
                        ].getName()}.${inverse} has wrong inverse. Expected: "${name}" Actual: "${rel2Inverse}"`);}
OtherModel._.fieldsTargetModel.set(inverse,Model.getName());OtherModel._.fieldsInverse.set(inverse,name);Model._.fieldsEager.set(name,true);OtherModel._.fieldsEager.set(inverse,true);}}}
Object.assign(store.Store,{store,_rawStore:store});store=toRaw(store.Store.insert())._raw;for(const Model of Object.values(Models)){Model._rawStore=store;Model.store=store._proxy;store._proxy[Model.getName()]=Model;}
Object.assign(store,{Models,storeReady:true});return store._proxy;}
return __exports;});;

/* /mail/static/src/model/misc.js */
odoo.define('@mail/model/misc',['@web/core/registry'],function(require){'use strict';let __exports={};const{registry}=require("@web/core/registry");const modelRegistry=__exports.modelRegistry=registry.category("discuss.model");const FIELD_DEFINITION_SYM=__exports.FIELD_DEFINITION_SYM=Symbol("field_definition");const ATTR_SYM=__exports.ATTR_SYM=Symbol("attr");const MANY_SYM=__exports.MANY_SYM=Symbol("many");const ONE_SYM=__exports.ONE_SYM=Symbol("one");const OR_SYM=__exports.OR_SYM=Symbol("or");const AND_SYM=Symbol("and");const IS_RECORD_SYM=__exports.IS_RECORD_SYM=Symbol("isRecord");const IS_FIELD_SYM=__exports.IS_FIELD_SYM=Symbol("isField");const IS_DELETING_SYM=__exports.IS_DELETING_SYM=Symbol("isDeleting");const IS_DELETED_SYM=__exports.IS_DELETED_SYM=Symbol("isDeleted");const STORE_SYM=__exports.STORE_SYM=Symbol("store");__exports.AND=AND;function AND(...args){return[AND_SYM,...args];}
__exports.OR=OR;function OR(...args){return[OR_SYM,...args];}
__exports.isCommand=isCommand;function isCommand(data){return["ADD","DELETE","ADD.noinv","DELETE.noinv"].includes(data?.[0]?.[0]);}
__exports.isOne=isOne;function isOne(Model,fieldName){return Model._.fieldsOne.get(fieldName);}
__exports.isMany=isMany;function isMany(Model,fieldName){return Model._.fieldsMany.get(fieldName);}
__exports.isRecord=isRecord;function isRecord(record){return Boolean(record?._?.[IS_RECORD_SYM]);}
__exports.isRelation=isRelation;function isRelation(Model,fieldName){return isMany(Model,fieldName)||isOne(Model,fieldName);}
__exports.isFieldDefinition=isFieldDefinition;function isFieldDefinition(val){return val?.[FIELD_DEFINITION_SYM];}
const fields=__exports.fields={One(targetModel,param1){return{...param1,targetModel,[FIELD_DEFINITION_SYM]:true,[ONE_SYM]:true};},Many(targetModel,param1){return{...param1,targetModel,[FIELD_DEFINITION_SYM]:true,[MANY_SYM]:true};},Attr(def,param1){return{...param1,[FIELD_DEFINITION_SYM]:true,[ATTR_SYM]:true,default:def};},Html(def,param1){const definition={...param1,[FIELD_DEFINITION_SYM]:true,[ATTR_SYM]:true,default:def,};definition.html=true;return definition;},Date(param0){return{...param0,[FIELD_DEFINITION_SYM]:true,[ATTR_SYM]:true,type:"date",};},Datetime(param0){return{...param0,[FIELD_DEFINITION_SYM]:true,[ATTR_SYM]:true,type:"datetime",};},};return __exports;});;

/* /mail/static/src/model/model_internal.js */
odoo.define('@mail/model/model_internal',['@mail/model/misc'],function(require){'use strict';let __exports={};const{ATTR_SYM,MANY_SYM,ONE_SYM}=require("@mail/model/misc");const ModelInternal=__exports.ModelInternal=class ModelInternal{fields=new Map();fieldsAttr=new Map();fieldsOne=new Map();fieldsMany=new Map();fieldsHtml=new Map();fieldsTargetModel=new Map();fieldsCompute=new Map();fieldsEager=new Map();fieldsInverse=new Map();fieldsOnAdd=new Map();fieldsOnDelete=new Map();fieldsOnUpdate=new Map();fieldsSort=new Map();fieldsType=new Map();prepareField(fieldName,data){this.fields.set(fieldName,true);if(data[ATTR_SYM]){this.fieldsAttr.set(fieldName,true);}
if(data[ONE_SYM]){this.fieldsOne.set(fieldName,true);}
if(data[MANY_SYM]){this.fieldsMany.set(fieldName,true);}
for(const key in data){const value=data[key];switch(key){case"html":{if(!value){break;}
this.fieldsHtml.set(fieldName,value);break;}
case"targetModel":{this.fieldsTargetModel.set(fieldName,value);break;}
case"compute":{this.fieldsCompute.set(fieldName,value);break;}
case"eager":{if(!value){break;}
this.fieldsEager.set(fieldName,value);break;}
case"sort":{this.fieldsSort.set(fieldName,value);break;}
case"inverse":{this.fieldsInverse.set(fieldName,value);break;}
case"onAdd":{this.fieldsOnAdd.set(fieldName,value);break;}
case"onDelete":{this.fieldsOnDelete.set(fieldName,value);break;}
case"onUpdate":{this.fieldsOnUpdate.set(fieldName,value);break;}
case"type":{this.fieldsType.set(fieldName,value);break;}}}}}
return __exports;});;

/* /mail/static/src/model/record.js */
odoo.define('@mail/model/record',['@odoo/owl','@mail/model/misc','@web/core/l10n/dates'],function(require){'use strict';let __exports={};const{markup,toRaw}=require("@odoo/owl");const{IS_DELETED_SYM,OR_SYM,isCommand,isMany,isOne,isRecord,isRelation,modelRegistry,}=require("@mail/model/misc");const{serializeDate,serializeDateTime}=require("@web/core/l10n/dates");const Markup=markup().constructor;const Record=__exports.Record=class Record{static _;_;static id;static env;env;static records;static store;static MAKE_UPDATE(fn){return this.store.MAKE_UPDATE(...arguments);}
static onChange(record,name,cb){return this.store.onChange(...arguments);}
static get(data){const Model=toRaw(this);return this.records[Model.localId(data)];}
static getName(){return this._name||this.name;}
static register(localRegistry){if(localRegistry){localRegistry.add(this.getName(),this);}else{modelRegistry.add(this.getName(),this);}}
static localId(data){const Model=toRaw(this);let idStr;if(typeof data==="object"&&data!==null){idStr=Model._localId(Model.id,data);}else{idStr=data;}
return`${Model.getName()},${idStr}`;}
get localId(){return toRaw(this)._.localId;}
static _localId(expr,data,{brackets=false}={}){const Model=toRaw(this);if(!Array.isArray(expr)){if(Model._.fields.get(expr)){if(Model._.fieldsMany.get(expr)){throw new Error("Using a fields.Many() as id is not (yet) supported");}
if(!isRelation(Model,expr)){return data[expr];}
if(isCommand(data[expr])){const[cmd,data2]=data[expr].at(-1);if(cmd==="DELETE"){return undefined;}else{return`(${data2?.localId})`;}}
if(isRecord(data[expr])){return`(${data[expr]?.localId})`;}
const TargetModelName=Model._.fieldsTargetModel.get(expr);return`(${Model.store[TargetModelName].get(data[expr])?.localId})`;}
return data[expr];}
const vals=[];for(let i=1;i<expr.length;i++){vals.push(Model._localId(expr[i],data,{brackets:true}));}
let res=vals.join(expr[0]===OR_SYM?" OR ":" AND ");if(brackets){res=`(${res})`;}
return res;}
static _retrieveIdFromData(data){const Model=toRaw(this);const res={};function _deepRetrieve(expr2){if(typeof expr2==="string"){if(isCommand(data[expr2])){const[cmd,data2]=data[expr2].at(-1);return Object.assign(res,{[expr2]:cmd==="DELETE"?undefined:cmd==="DELETE.noinv"?[["DELETE.noinv",data2]]:cmd==="ADD.noinv"?[["ADD.noinv",data2]]:data2,});}
return Object.assign(res,{[expr2]:data[expr2]});}
if(expr2 instanceof Array){for(const expr of this.id){if(typeof expr==="symbol"){continue;}
_deepRetrieve(expr);}}}
if(Model.id===undefined){return res;}
if(typeof Model.id==="string"){if(typeof data!=="object"||data===null){return{[Model.id]:data};}
if(isCommand(data[Model.id])){const[cmd,data2]=data[Model.id].at(-1);return Object.assign(res,{[Model.id]:cmd==="DELETE"?undefined:cmd==="DELETE.noinv"?[["DELETE.noinv",data2]]:cmd==="ADD.noinv"?[["ADD.noinv",data2]]:data2,});}
return{[Model.id]:data[Model.id]};}
for(const expr of Model.id){if(typeof expr==="symbol"){continue;}
_deepRetrieve(expr);}
return res;}
static Class;static new(data,ids){const Model=toRaw(this);const store=Model._rawStore;return store.MAKE_UPDATE(function RecordNew(){const recordProxy=new Model.Class();const record=toRaw(recordProxy)._raw;Object.assign(record._,{localId:Model.localId(ids)});Object.assign(recordProxy,{...ids});Model.records[record.localId]=recordProxy;if(record.Model.getName()==="Store"){Object.assign(record,{env:Model._rawStore.env,recordByLocalId:Model._rawStore.recordByLocalId,});}
Model._rawStore.recordByLocalId.set(record.localId,recordProxy);for(const fieldName of record.Model._.fields.keys()){record._.requestCompute?.(record,fieldName);record._.requestSort?.(record,fieldName);}
return recordProxy;});}
static insert(data,options={}){const ModelFullProxy=this;const Model=toRaw(ModelFullProxy);const store=Model._rawStore;return store.MAKE_UPDATE(function RecordInsert(){const isMulti=Array.isArray(data);if(!isMulti){data=[data];}
const res=data.map(function RecordInsertMap(d){return Model._insert.call(ModelFullProxy,d,options);});if(!isMulti){return res[0];}
return res;});}
static _insert(data){const ModelFullProxy=this;const Model=toRaw(ModelFullProxy);const recordFullProxy=Model.preinsert.call(ModelFullProxy,data);const record=toRaw(recordFullProxy)._raw;record.update.call(record._proxy,data);return recordFullProxy;}
static preinsert(data){const ModelFullProxy=this;const Model=toRaw(ModelFullProxy);const ids=Model._retrieveIdFromData(data);for(const name in ids){if(ids[name]&&!isRecord(ids[name])&&!isCommand(ids[name])&&isRelation(Model,name)){ids[name]=Model._rawStore[Model._.fieldsTargetModel.get(name)].preinsert(ids[name]);}}
return Model.get.call(ModelFullProxy,data)??Model.new(data,ids);}
get store(){return toRaw(this)._raw.Model._rawStore._proxy;}
get _rawStore(){return toRaw(this)._raw.Model._rawStore;}
Model;_raw;_proxyInternal;_proxy;setup(){}
update(data){const record=toRaw(this)._raw;const store=record._rawStore;return store.MAKE_UPDATE(function recordUpdate(){if(typeof data==="object"&&data!==null){store._.updateFields(record,data);}else{if(Array.isArray(record.Model.id)){throw new Error(`Cannot insert "${data}" on model "${record.Model.getName()}": this model doesn't support single-id data!`);}
store._.updateFields(record,{[record.Model.id]:data});}});}
delete(){const record=toRaw(this)._raw;const store=record._rawStore;return store.MAKE_UPDATE(function recordDelete(){store._.ADD_QUEUE("delete",record);});}
exists(){return!this[IS_DELETED_SYM];}
eq(record){return toRaw(this)._raw===toRaw(record)?._raw;}
notEq(record){return!this.eq(record);}
in(collection){if(!collection){return false;}
return collection.some((record)=>toRaw(record)._raw.eq(this));}
notIn(collection){return!this.in(collection);}
toData(options={depth:false}){const prefix=this._getActualModelName();const ongoing={seenRecords:new Set(),storeData:{},depth:options.depth,fields:undefined,};if(Array.isArray(options)){ongoing.fields=options.map((field)=>`${prefix}.${field}`);}
this._toData(ongoing,prefix);return ongoing.storeData;}
_cleanupData(data){const fieldsToDelete=["_","_fieldsValue","_proxy","_proxyInternal","_raw","env","Model",];fieldsToDelete.forEach((field)=>delete data[field]);}
_getActualModelName(){return this.Model.getName();}
_toData(ongoing,prefix=undefined){if(ongoing.depth&&ongoing.seenRecords.has(this.localId)){return;}
ongoing.seenRecords.add(this.localId);const recordProxy=this;const record=toRaw(recordProxy)._raw;const Model=record.Model;const data={...recordProxy};for(const name of Model._.fields.keys()){const fullFieldName=prefix?`${prefix}.${name}`:name;if(isMany(Model,name)){data[name]=record._proxyInternal[name].map((recordProxy)=>{const record=toRaw(recordProxy)._raw;return record._toDataRelationalRecord.call(record._proxyInternal,ongoing,fullFieldName);});}else if(isOne(Model,name)){const otherRecord=toRaw(record._proxyInternal[name])?._raw;data[name]=otherRecord?._toDataRelationalRecord.call(otherRecord._proxyInternal,ongoing,fullFieldName);}else{const value=recordProxy[name];if(Model._.fieldsType.get(name)==="datetime"&&value){data[name]=serializeDateTime(value);}else if(Model._.fieldsType.get(name)==="date"&&value){data[name]=serializeDate(value);}else if(Model._.fieldsHtml.get(name)&&value instanceof Markup){data[name]=["markup",value.toString()];}else{data[name]=value;}}}
this._cleanupData(data);const pyModelName=record._getActualModelName();ongoing.storeData[pyModelName]||=[];ongoing.storeData[pyModelName].push(data);}
_toDataRelationalRecord(ongoing,prefix=undefined){const data=this.Model._retrieveIdFromData(this);if(ongoing.depth||ongoing.fields?.some((field)=>field.startsWith(prefix))){this._toData(ongoing,prefix);}
for(const[name,val]of Object.entries(data)){if(isRecord(val)){data[name]=val._toDataRelationalRecord(ongoing,prefix);}}
return data;}}
Record.register();return __exports;});;

/* /mail/static/src/model/record_internal.js */
odoo.define('@mail/model/record_internal',['@mail/utils/common/misc','@mail/model/misc','@mail/model/record_list','@odoo/owl','@mail/model/record_uses'],function(require){'use strict';let __exports={};const{onChange}=require("@mail/utils/common/misc");const{IS_DELETED_SYM,IS_RECORD_SYM,isRelation}=require("@mail/model/misc");const{RecordList}=require("@mail/model/record_list");const{reactive,toRaw}=require("@odoo/owl");const{RecordUses}=require("@mail/model/record_uses");const RecordInternal=__exports.RecordInternal=class RecordInternal{[IS_RECORD_SYM]=true;fieldsComputing=new Map();fieldsSortOnNeed=new Map();fieldsSortInNeed=new Map();fieldsSorting=new Map();fieldsComputeInNeed=new Map();fieldsComputeOnNeed=new Map();fieldsOnUpdateObserves=new Map();fieldsSortProxy2=new Map();fieldsComputeProxy2=new Map();uses=new RecordUses();updatingAttrs=new Map();proxyUsed=new Map();localId;gettingField=false;prepareField(record,fieldName,recordProxy){const self=this;const Model=toRaw(record).Model;if(isRelation(Model,fieldName)){const recordList=new RecordList();Object.assign(recordList._,{name:fieldName,owner:record,});Object.assign(recordList,{_raw:recordList,_store:record.store,});record[fieldName]=recordList;}else{record[fieldName]=record[fieldName].default;}
if(Model._.fieldsCompute.get(fieldName)){if(!Model._.fieldsEager.get(fieldName)){onChange(recordProxy,fieldName,()=>{if(this.fieldsComputing.get(fieldName)){this.fieldsComputeInNeed.delete(fieldName);}});this.fieldsComputeInNeed.delete(fieldName);this.fieldsSortInNeed.delete(fieldName);}
const cb=function computeObserver(){self.requestCompute(record,fieldName);};const computeProxy2=reactive(recordProxy,cb);this.fieldsComputeProxy2.set(fieldName,computeProxy2);}
if(Model._.fieldsSort.get(fieldName)){if(!Model._.fieldsEager.get(fieldName)){onChange(recordProxy,fieldName,()=>{if(this.fieldsSorting.get(fieldName)){this.fieldsSortInNeed.delete(fieldName);}});this.fieldsComputeInNeed.delete(fieldName);this.fieldsSortInNeed.delete(fieldName);}
const sortProxy2=reactive(recordProxy,function sortObserver(){self.requestSort(record,fieldName);});this.fieldsSortProxy2.set(fieldName,sortProxy2);}
if(Model._.fieldsOnUpdate.get(fieldName)){const store=Model.store;store._onChange(recordProxy,fieldName,(obs)=>{this.fieldsOnUpdateObserves.set(fieldName,obs);if(store._.UPDATE!==0){store._.ADD_QUEUE("onUpdate",record,fieldName);}else{this.onUpdate(record,fieldName);}});}}
requestCompute(record,fieldName,{force=false}={}){if(record[IS_DELETED_SYM]){return;}
const Model=record.Model;if(!Model._.fieldsCompute.get(fieldName)){return;}
const store=record._rawStore;if(store._.UPDATE!==0&&!force){store._.ADD_QUEUE("compute",record,fieldName);}else{if(Model._.fieldsEager.get(fieldName)||this.fieldsComputeInNeed.get(fieldName)){this.compute(record,fieldName);}else{this.fieldsComputeOnNeed.set(fieldName,true);}}}
requestSort(record,fieldName,{force}={}){if(record[IS_DELETED_SYM]){return;}
const Model=record.Model;if(!Model._.fieldsSort.get(fieldName)){return;}
const store=record._rawStore;if(store._.UPDATE!==0&&!force){store._.ADD_QUEUE("sort",record,fieldName);}else{if(Model._.fieldsEager.get(fieldName)||this.fieldsSortInNeed.get(fieldName)){this.sort(record,fieldName);}else{this.fieldsSortOnNeed.set(fieldName,true);}}}
compute(record,fieldName){const Model=record.Model;const store=record._rawStore;this.fieldsComputing.set(fieldName,true);this.fieldsComputeOnNeed.delete(fieldName);let computedValue;try{computedValue=Model._.fieldsCompute.get(fieldName).call(this.fieldsComputeProxy2.get(fieldName));}catch(err){store.handleError(err);}
store._.updateFields(record,{[fieldName]:computedValue,});this.fieldsComputing.delete(fieldName);}
sort(record,fieldName){const Model=record.Model;if(!Model._.fieldsSort.get(fieldName)){return;}
const store=record._rawStore;this.fieldsSortOnNeed.delete(fieldName);this.fieldsSorting.set(fieldName,true);const proxy2Sort=this.fieldsSortProxy2.get(fieldName);const func=Model._.fieldsSort.get(fieldName).bind(proxy2Sort);if(isRelation(Model,fieldName)){try{store._.sortRecordList(proxy2Sort[fieldName]._proxy,func);}catch(err){store.handleError(err);}}else{const copy=[...proxy2Sort[fieldName]];copy.sort(func);const hasChanged=copy.some((item,index)=>item!==record[fieldName][index]);if(hasChanged){proxy2Sort[fieldName]=copy;}}
this.fieldsSorting.delete(fieldName);}
onUpdate(record,fieldName){const store=record._rawStore;const Model=record.Model;if(!Model._.fieldsOnUpdate.get(fieldName)){return;}
try{Model._.fieldsOnUpdate.get(fieldName).call(record._proxyInternal);}catch(err){store.handleError(err);}
this.fieldsOnUpdateObserves.get(fieldName)?.();}
downgradeProxy(record,fullProxy){return record._proxy===fullProxy?record._proxyInternal:fullProxy;}}
return __exports;});;

/* /mail/static/src/model/record_list.js */
odoo.define('@mail/model/record_list',['@odoo/owl','@mail/model/misc'],function(require){'use strict';let __exports={};const{markRaw,reactive,toRaw}=require("@odoo/owl");const{isRecord}=require("@mail/model/misc");function getInverse(reclist){return reclist._.owner.Model._.fieldsInverse.get(reclist._.name);}
function getTargetModel(reclist){return reclist._.owner.Model._.fieldsTargetModel.get(reclist._.name);}
function isComputeField(reclist){return reclist._.owner.Model._.fieldsCompute.get(reclist._.name);}
function isSortField(reclist){return reclist._.owner.Model._.fieldsSort.get(reclist._.name);}
function isEager(reclist){return reclist._.owner.Model._.fieldsEager.get(reclist._.name);}
function setComputeInNeed(reclist){reclist._.owner._.fieldsComputeInNeed.set(reclist._.name,true);}
function setSortInNeed(reclist){reclist._.owner._.fieldsSortInNeed.set(reclist._.name,true);}
function isComputeOnNeed(reclist){return reclist._.owner._.fieldsComputeOnNeed.get(reclist._.name);}
function isSortOnNeed(reclist){return reclist._.owner._.fieldsSortOnNeed.get(reclist._.name);}
function computeField(reclist){reclist._.owner._.compute(reclist._.owner,reclist._.name);}
function sortField(reclist){reclist._.owner._.sort(reclist._.owner,reclist._.name);}
function isOne(reclist){return reclist._.owner.Model._.fieldsOne.get(reclist._.name);}
const RecordListInternal=__exports.RecordListInternal=class RecordListInternal{name;owner;addNoinv(recordList,...records){const self=this;const store=recordList._store;if(isOne(recordList)){const last=records.at(-1);if(isRecord(last)&&last.in(recordList)){return;}
const record=self.insert(recordList,last,function recordList_AddNoInvOneInsert(record){if(record.localId!==recordList.data[0]){const old=recordList._proxy.at(-1);recordList._proxy.data.pop();old?._.uses.delete(recordList);recordList._proxy.data.push(record.localId);self.syncLength(recordList);record._.uses.add(recordList);}},{inv:false});store._.ADD_QUEUE("onAdd",self.owner,self.name,record);return;}
for(const val of records){if(isRecord(val)&&val.in(recordList)){continue;}
const record=self.insert(recordList,val,function recordList_AddNoInvManyInsert(record){if(recordList.data.indexOf(record.localId)===-1){recordList._proxy.data.push(record.localId);self.syncLength(recordList);record._.uses.add(recordList);}},{inv:false});store._.ADD_QUEUE("onAdd",self.owner,self.name,record);}}
assign(recordList,data){const self=this;const store=recordList._store;return store.MAKE_UPDATE(function recordListAssign(){const collection=isRecord(data)?[data]:data;const vals=[...collection];const oldRecords=recordList._proxyInternal.slice.call(recordList._proxy).map((recordProxy)=>toRaw(recordProxy)._raw);const newRecords=vals.map((val)=>self.insert(recordList,val,function recordListAssignInsert(record){if(record.notIn(oldRecords)){record._.uses.add(recordList);store._.ADD_QUEUE("onAdd",self.owner,self.name,record);}}));const inverse=getInverse(recordList);for(const oldRecord of oldRecords){if(oldRecord.notIn(newRecords)){oldRecord._.uses.delete(recordList);store._.ADD_QUEUE("onDelete",self.owner,self.name,oldRecord);if(inverse){oldRecord[inverse].delete(self.owner);}}}
recordList._proxy.data=newRecords.map((newRecord)=>newRecord.localId);recordList._.syncLength(recordList);});}
deleteNoinv(recordList,...records){const self=this;const store=recordList._store;for(const val of records){const record=this.insert(recordList,val,function recordList_DeleteNoInv_Insert(record){const index=recordList.data.indexOf(record.localId);if(index!==-1){const old=recordList._proxy.at(-1);recordList.splice.call(recordList._proxy,index,1);self.syncLength(recordList);old._.uses.delete(recordList);}},{inv:false});store._.ADD_QUEUE("onDelete",self.owner,self.name,record);}}
downgradeProxy(recordList,fullProxy){return recordList._proxy===fullProxy?recordList._proxyInternal:fullProxy;}
insert(recordList,val,fn,{inv=true,mode="ADD"}={}){const inverse=getInverse(recordList);const targetModel=getTargetModel(recordList);if(typeof val!=="object"){if(Array.isArray(recordList._store[targetModel].id)){throw new Error(`Cannot insert "${val}" on relational field "${recordList._.owner.Model.getName()}/${
                        recordList._.name
                    }": target model "${targetModel}" doesn't support single-id data!`);}
val={[recordList._store[targetModel].id]:val};}
if(inverse&&inv){const target=isRecord(val)&&val._raw===val?val._proxy:val;target[inverse]=[[mode==="ADD"?"ADD.noinv":"DELETE.noinv",recordList._.owner]];}
let newRecordProxy;if(!isRecord(val)){newRecordProxy=recordList._store[targetModel].preinsert(val);}else{newRecordProxy=val;}
const newRecord=toRaw(newRecordProxy)._raw;fn?.(newRecord);if(!isRecord(val)){recordList._store[targetModel].insert(val);}
return newRecord;}
syncLength(reclist){reclist.length=reclist.data.length;}}
const RecordList=__exports.RecordList=class RecordList extends Array{_store;data=[];_raw;_proxyInternal;_proxy;_=markRaw(new RecordListInternal());constructor(){super();const recordList=this;recordList._raw=recordList;const recordListProxyInternal=new Proxy(recordList,{get(recordList,name,recordListFullProxy){recordListFullProxy=recordList._.downgradeProxy(recordList,recordListFullProxy);if(typeof name==="symbol"||Object.keys(recordList).includes(name)||Object.prototype.hasOwnProperty.call(recordList.constructor.prototype,name)){let res=Reflect.get(...arguments);if(typeof res==="function"){res=res.bind(recordListFullProxy);}
return res;}
if(isComputeField(recordList)&&!isEager(recordList)){setComputeInNeed(recordList);if(isComputeOnNeed(recordList)){computeField(recordList);}}
if(name==="length"){return recordListFullProxy.data.length;}
if(isSortField(recordList)&&!isEager(recordList)){setSortInNeed(recordList);if(isSortOnNeed(recordList)){sortField(recordList);}}
if(typeof name!=="symbol"&&!window.isNaN(parseInt(name))){const index=parseInt(name);return recordListFullProxy._store.recordByLocalId.get(recordListFullProxy.data[index]);}
const array=[...recordList[Symbol.iterator].call(recordListFullProxy)];return array[name]?.bind(array);},set(recordList,name,val,recordListProxy){const store=recordList._store;return store.MAKE_UPDATE(function recordListSet(){if(typeof name!=="symbol"&&!window.isNaN(parseInt(name))){const index=parseInt(name);recordList._.insert(recordList,val,function recordListSet_Insert(newRecord){const oldRecord=toRaw(toRaw(recordList._store.recordByLocalId).get(recordList.data[index]))._raw;recordListProxy.data[index]=newRecord?.localId;if(oldRecord&&oldRecord.notEq(newRecord)){oldRecord._.uses.delete(recordList);}
store._.ADD_QUEUE("onDelete",recordList._.owner,recordList._.name,oldRecord);const inverse=getInverse(recordList);if(inverse){oldRecord[inverse].delete(recordList._.owner);}
if(newRecord){newRecord._.uses.add(recordList);store._.ADD_QUEUE("onAdd",recordList._.owner,recordList._.name,newRecord);if(inverse){newRecord[inverse].add?.(recordList._.owner);}}});}else if(name==="length"){const newLength=parseInt(val);if(newLength!==recordList.data.length){if(newLength<recordList.data.length){recordList.splice.call(recordListProxy,newLength,recordList.length-newLength);}
recordListProxy.data.length=newLength;recordList._.syncLength(recordList);}}else{return Reflect.set(recordList,name,val,recordListProxy);}
return true;});},});recordList._proxyInternal=recordListProxyInternal;recordList._proxy=reactive(recordListProxyInternal);return recordList;}
push(...records){const recordList=toRaw(this)._raw;const recordListFullProxy=recordList._.downgradeProxy(recordList,this);const store=recordList._store;return store.MAKE_UPDATE(function recordListPush(){for(const val of records){const record=recordList._.insert(recordList,val,function recordListPushInsert(record){recordList._proxy.data.push(record.localId);recordList._.syncLength(recordList);record._.uses.add(recordList);});store._.ADD_QUEUE("onAdd",recordList._.owner,recordList._.name,record);const inverse=getInverse(recordList);if(inverse){record[inverse].add(recordList._.owner);}}
return recordListFullProxy.data.length;});}
pop(){const recordList=toRaw(this)._raw;const recordListFullProxy=recordList._.downgradeProxy(recordList,this);const store=recordList._store;return store.MAKE_UPDATE(function recordListPop(){const oldRecordProxy=recordListFullProxy.at(-1);if(oldRecordProxy){recordList.splice.call(recordListFullProxy,recordListFullProxy.length-1,1);}
return oldRecordProxy;});}
shift(){const recordList=toRaw(this)._raw;const recordListFullProxy=recordList._.downgradeProxy(recordList,this);const store=recordList._store;return store.MAKE_UPDATE(function recordListShift(){const recordProxy=recordListFullProxy._store.recordByLocalId.get(recordListFullProxy.data.shift());recordList._.syncLength(recordList);if(!recordProxy){return;}
const record=toRaw(recordProxy)._raw;record._.uses.delete(recordList);store._.ADD_QUEUE("onDelete",recordList._.owner,recordList._.name,record);const inverse=getInverse(recordList);if(inverse){record[inverse].delete(recordList._.owner);}
return recordProxy;});}
unshift(...records){const recordList=toRaw(this)._raw;const recordListFullProxy=recordList._.downgradeProxy(recordList,this);const store=recordList._store;return store.MAKE_UPDATE(function recordListUnshift(){for(let i=records.length-1;i>=0;i--){const record=recordList._.insert(recordList,records[i],(record)=>{recordList._proxy.data.unshift(record.localId);recordList._.syncLength(recordList);record._.uses.add(recordList);});store._.ADD_QUEUE("onAdd",recordList._.owner,recordList._.name,record);const inverse=getInverse(recordList);if(inverse){record[inverse].add(recordList._.owner);}}
return recordListFullProxy.data.length;});}
indexOf(recordProxy){const recordList=toRaw(this)._raw;const recordListFullProxy=recordList._.downgradeProxy(recordList,this);return recordListFullProxy.data.indexOf(toRaw(recordProxy)?._raw.localId);}
splice(start,deleteCount,...newRecordsProxy){const recordList=toRaw(this)._raw;const recordListFullProxy=recordList._.downgradeProxy(recordList,this);const store=recordList._store;return store.MAKE_UPDATE(function recordListSplice(){const oldRecordsProxy=recordList._proxyInternal.slice.call(recordListFullProxy,start,start+deleteCount);const list=recordListFullProxy.data.slice();list.splice(start,deleteCount,...newRecordsProxy.map((newRecordProxy)=>toRaw(newRecordProxy)._raw.localId));if(isOne(recordList)&&start===0&&deleteCount===1){if(list.length===0){recordList._proxy.data.pop();}else{recordList._proxy.data[0]=list[0];}}else{recordList._proxy.data=list;}
recordList._.syncLength(recordList);for(const oldRecordProxy of oldRecordsProxy){const oldRecord=toRaw(oldRecordProxy)._raw;oldRecord._.uses.delete(recordList);store._.ADD_QUEUE("onDelete",recordList._.owner,recordList._.name,oldRecord);const inverse=getInverse(recordList);if(inverse){oldRecord[inverse].delete(recordList._.owner);}}
for(const newRecordProxy of newRecordsProxy){const newRecord=toRaw(newRecordProxy)._raw;newRecord._.uses.add(recordList);store._.ADD_QUEUE("onAdd",recordList._.owner,recordList._.name,newRecord);const inverse=getInverse(recordList);if(inverse){newRecord[inverse].add(recordList._.owner);}}});}
sort(func){const recordList=toRaw(this)._raw;const recordListFullProxy=recordList._.downgradeProxy(recordList,this);const store=recordList._store;return store.MAKE_UPDATE(function recordListSort(){recordList._store._.sortRecordList(recordListFullProxy,func);return recordListFullProxy;});}
concat(...collections){const recordList=toRaw(this)._raw;const recordListFullProxy=recordList._.downgradeProxy(recordList,this);return recordListFullProxy.data.map((localId)=>recordListFullProxy._store.recordByLocalId.get(localId)).concat(...collections.map((c)=>[...c]));}
add(...records){const recordList=toRaw(this)._raw;const store=recordList._store;return store.MAKE_UPDATE(function recordListAdd(){if(isOne(recordList)){const last=records.at(-1);if(isRecord(last)&&recordList.data.includes(toRaw(last)._raw.localId)){return last;}
return recordList._.insert(recordList,last,function recordListAddInsertOne(record){if(record.localId!==recordList.data[0]){recordList.splice.call(recordList._proxy,0,1,record);}});}
const res=[];for(const val of records){if(isRecord(val)&&recordList.data.includes(val.localId)){continue;}
const rec=recordList._.insert(recordList,val,function recordListAddInsertMany(record){if(recordList.data.indexOf(record.localId)===-1){recordList.push.call(recordList._proxy,record);}});res.push(rec);}
return res.length===1?res[0]:res;});}
delete(...records){const recordList=toRaw(this)._raw;const store=recordList._store;return store.MAKE_UPDATE(function recordListDelete(){for(const val of records){recordList._.insert(recordList,val,function recordListDelete_Insert(record){const index=recordList.data.indexOf(record.localId);if(index!==-1){recordList.splice.call(recordList._proxy,index,1);}},{mode:"DELETE"});}});}
clear(){const recordList=toRaw(this)._raw;const store=recordList._store;return store.MAKE_UPDATE(function recordListClear(){while(recordList.data.length>0){recordList.pop.call(recordList._proxy);}});}*[Symbol.iterator](){const recordList=toRaw(this)._raw;const recordListFullProxy=recordList._.downgradeProxy(recordList,this);for(const localId of recordListFullProxy.data){yield recordListFullProxy._store.recordByLocalId.get(localId);}}
at(index){const recordList=toRaw(this)._raw;const recordListFullProxy=recordList._.downgradeProxy(recordList,this);return recordListFullProxy._store.recordByLocalId.get(recordListFullProxy.data.at(index));}}
return __exports;});;

/* /mail/static/src/model/record_uses.js */
odoo.define('@mail/model/record_uses',[],function(require){'use strict';let __exports={};const RecordUses=__exports.RecordUses=class RecordUses{data=new Map();add(list){const record=list._.owner;if(!this.data.has(record.localId)){this.data.set(record.localId,new Map());}
const use=this.data.get(record.localId);if(!use.get(list._.name)){use.set(list._.name,0);}
use.set(list._.name,use.get(list._.name)+1);}
delete(list){const record=list._.owner;if(!this.data.has(record.localId)){return;}
const use=this.data.get(record.localId);if(!use.get(list._.name)){return;}
use.set(list._.name,use.get(list._.name)-1);if(use.get(list._.name)===0){use.delete(list._.name);}}}
return __exports;});;

/* /mail/static/src/model/store.js */
odoo.define('@mail/model/store',['@mail/model/record','@mail/model/misc','@odoo/owl'],function(require){'use strict';let __exports={};const{Record}=require("@mail/model/record");const{STORE_SYM,modelRegistry}=require("@mail/model/misc");const{reactive,toRaw}=require("@odoo/owl");const storeInsertFns=__exports.storeInsertFns={makeContext(store){},getActualModelName(store,ctx,pyOrJsModelName){return pyOrJsModelName;},getExtraFieldsFromModel(store){},};const Store=__exports.Store=class Store extends Record{_;[STORE_SYM]=true;recordByLocalId;storeReady=false;get(localId){return this.recordByLocalId.get(localId);}
handleError(err){this._.ERRORS.push(err);}
warnErrors=true;MAKE_UPDATE(fn){this._.UPDATE++;let res;try{res=fn();}catch(err){this.handleError(err);}
this._.UPDATE--;const deletingRecordsByLocalId=new Map();if(this._.UPDATE===0){this._.UPDATE++;while(this._.FC_QUEUE.size>0||this._.FS_QUEUE.size>0||this._.FA_QUEUE.size>0||this._.FD_QUEUE.size>0||this._.FU_QUEUE.size>0||this._.RO_QUEUE.size>0||this._.RD_QUEUE.size>0||this._.RHD_QUEUE.size>0){const FC_QUEUE=new Map(this._.FC_QUEUE);const FS_QUEUE=new Map(this._.FS_QUEUE);const FA_QUEUE=new Map(this._.FA_QUEUE);const FD_QUEUE=new Map(this._.FD_QUEUE);const FU_QUEUE=new Map(this._.FU_QUEUE);const RO_QUEUE=new Map(this._.RO_QUEUE);const RD_QUEUE=new Map(this._.RD_QUEUE);const RHD_QUEUE=new Map(this._.RHD_QUEUE);this._.FC_QUEUE.clear();this._.FS_QUEUE.clear();this._.FA_QUEUE.clear();this._.FD_QUEUE.clear();this._.FU_QUEUE.clear();this._.RO_QUEUE.clear();this._.RD_QUEUE.clear();this._.RHD_QUEUE.clear();while(FC_QUEUE.size>0){const[record,recMap]=FC_QUEUE.entries().next().value;FC_QUEUE.delete(record);for(const fieldName of recMap.keys()){record._.requestCompute(record,fieldName,{force:true});}}
while(FS_QUEUE.size>0){const[record,recMap]=FS_QUEUE.entries().next().value;FS_QUEUE.delete(record);for(const fieldName of recMap.keys()){record._.requestSort(record,fieldName,{force:true});}}
while(FA_QUEUE.size>0){const[record,recMap]=FA_QUEUE.entries().next().value;FA_QUEUE.delete(record);while(recMap.size>0){const[fieldName,fieldMap]=recMap.entries().next().value;recMap.delete(fieldName);const onAdd=record.Model._.fieldsOnAdd.get(fieldName);for(const addedRec of fieldMap.keys()){try{onAdd?.call(record._proxy,addedRec._proxy);}catch(err){this.handleError(err);}}}}
while(FD_QUEUE.size>0){const[record,recMap]=FD_QUEUE.entries().next().value;FD_QUEUE.delete(record);while(recMap.size>0){const[fieldName,fieldMap]=recMap.entries().next().value;recMap.delete(fieldName);const onDelete=record.Model._.fieldsOnDelete.get(fieldName);for(const removedRec of fieldMap.keys()){try{onDelete?.call(record._proxy,removedRec._proxy);}catch(err){this.handleError(err);}}}}
while(FU_QUEUE.size>0){const[record,map]=FU_QUEUE.entries().next().value;FU_QUEUE.delete(record);for(const fieldName of map.keys()){record._.onUpdate(record,fieldName);}}
while(RO_QUEUE.size>0){const cb=RO_QUEUE.keys().next().value;RO_QUEUE.delete(cb);try{cb();}catch(err){this.handleError(err);}}
while(RD_QUEUE.size>0){const record=RD_QUEUE.keys().next().value;RD_QUEUE.delete(record);for(const[localId,names]of record._.uses.data.entries()){for(const[name2,count]of names.entries()){const existingRecordProxyInternal=toRaw(this.recordByLocalId).get(localId);const usingRecord=(existingRecordProxyInternal&&toRaw(existingRecordProxyInternal)?._raw)||deletingRecordsByLocalId.get(localId);if(!usingRecord){record._.uses.data.delete(localId);continue;}
for(let c=0;c<count;c++){usingRecord[name2].delete(record);}}}
deletingRecordsByLocalId.set(record.localId,record);this.recordByLocalId.delete(record.localId);this._.ADD_QUEUE("hard_delete",toRaw(record));}
while(RHD_QUEUE.size>0){const record=RHD_QUEUE.keys().next().value;RHD_QUEUE.delete(record);deletingRecordsByLocalId.delete(record.localId);}}
this._.UPDATE--;if(this._.ERRORS.length){if(this.warnErrors){console.warn("Store data insert aborted due to following errors:");for(const err of this._.ERRORS){console.warn(err);}}
const[error1]=this._.ERRORS;this._.ERRORS=[];throw error1;}}
return res;}
insert(dataByModelName={},options={}){const store=this;const ctx=storeInsertFns.makeContext(store);Record.MAKE_UPDATE(function storeInsert(){const recordsDataToDelete=[];for(const[pyOrJsModelName,data]of Object.entries(dataByModelName)){const modelName=storeInsertFns.getActualModelName(store,ctx,pyOrJsModelName);if(!store[modelName]){console.warn(`store.insert() received data for unknown model ${modelName}.`);continue;}
const insertData=[];for(const vals of Array.isArray(data)?data:[data]){const extraFields=storeInsertFns.getExtraFieldsFromModel(store,pyOrJsModelName);if(extraFields){Object.assign(vals,extraFields);}
if(vals._DELETE){delete vals._DELETE;recordsDataToDelete.push([modelName,vals]);}else{insertData.push(vals);}}
store[modelName].insert(insertData,options);}
for(const[modelName,vals]of recordsDataToDelete){store[modelName].get(vals)?.delete();}});}
onChange(record,name,cb){return this._onChange(record,name,(observe)=>{const fn=()=>{observe();try{cb();}catch(err){this.handleError(err);}};if(this._.UPDATE!==0){if(!this._.RO_QUEUE.has(fn)){this._.RO_QUEUE.set(fn,true);}}else{fn();}});}
_onChange(record,key,callback){let proxy;function _observe(){const val=proxy[key];if(typeof val==="object"&&val!==null){void Object.keys(val);}
if(Array.isArray(val)){void val.length;void toRaw(val).forEach.call(val,(i)=>i);}}
if(Array.isArray(key)){for(const k of key){this._onChange(record,k,callback);}
return;}
let ready=true;proxy=reactive(record,()=>{if(ready){callback(_observe);}});_observe();return()=>{ready=false;};}
_cleanupData(data){super._cleanupData(data);if(this._getActualModelName()==="Store"){delete data.Models;for(const[name]of modelRegistry.getEntries()){delete data[name];}}}}
return __exports;});;

/* /mail/static/src/model/store_internal.js */
odoo.define('@mail/model/store_internal',['@odoo/owl','@mail/model/record_internal','@web/core/l10n/dates','@mail/model/misc'],function(require){'use strict';let __exports={};const{htmlEscape,markup,toRaw}=require("@odoo/owl");const{RecordInternal}=require("@mail/model/record_internal");const{deserializeDate,deserializeDateTime}=require("@web/core/l10n/dates");const{IS_DELETED_SYM,IS_DELETING_SYM,isCommand,isMany}=require("@mail/model/misc");const Markup=markup().constructor;const StoreInternal=__exports.StoreInternal=class StoreInternal extends RecordInternal{FC_QUEUE=new Map();FS_QUEUE=new Map();FA_QUEUE=new Map();FD_QUEUE=new Map();FU_QUEUE=new Map();RO_QUEUE=new Map();RD_QUEUE=new Map();RHD_QUEUE=new Map();ERRORS=[];UPDATE=0;ADD_QUEUE(type,...params){switch(type){case"delete":{const[record]=params;if(!this.RD_QUEUE.has(record)){this.RD_QUEUE.set(record,true);}
break;}
case"compute":{const[record,fieldName]=params;let recMap=this.FC_QUEUE.get(record);if(!recMap){recMap=new Map();this.FC_QUEUE.set(record,recMap);}
recMap.set(fieldName,true);break;}
case"sort":{const[record,fieldName]=params;let recMap=this.FS_QUEUE.get(record);if(!recMap){recMap=new Map();this.FS_QUEUE.set(record,recMap);}
recMap.set(fieldName,true);break;}
case"onAdd":{const[record,fieldName,addedRec]=params;const Model=record.Model;if(Model._.fieldsSort.get(fieldName)){this.ADD_QUEUE("sort",record,fieldName);}
if(!Model._.fieldsOnAdd.get(fieldName)){return;}
let recMap=this.FA_QUEUE.get(record);if(!recMap){recMap=new Map();this.FA_QUEUE.set(record,recMap);}
let fieldMap=recMap.get(fieldName);if(!fieldMap){fieldMap=new Map();recMap.set(fieldName,fieldMap);}
fieldMap.set(addedRec,true);break;}
case"onDelete":{const[record,fieldName,removedRec]=params;const Model=record.Model;if(!Model._.fieldsOnDelete.get(fieldName)){return;}
let recMap=this.FD_QUEUE.get(record);if(!recMap){recMap=new Map();this.FD_QUEUE.set(record,recMap);}
let fieldMap=recMap.get(fieldName);if(!fieldMap){fieldMap=new Map();recMap.set(fieldName,fieldMap);}
fieldMap.set(removedRec,true);break;}
case"onUpdate":{const[record,fieldName]=params;let recMap=this.FU_QUEUE.get(record);if(!recMap){recMap=new Map();this.FU_QUEUE.set(record,recMap);}
recMap.set(fieldName,true);break;}
case"hard_delete":{const[record]=params;record._[IS_DELETING_SYM]=true;record._proxy[IS_DELETED_SYM]=true;delete record.Model.records[record.localId];if(!this.RHD_QUEUE.has(record)){this.RHD_QUEUE.set(record,true);}
break;}}}
sortRecordList(recordListFullProxy,func){const recordList=toRaw(recordListFullProxy)._raw;const recordsFullProxy=recordListFullProxy.data.map((localId)=>recordListFullProxy._store.recordByLocalId.get(localId));recordsFullProxy.sort(func);const data=recordsFullProxy.map((recordFullProxy)=>toRaw(recordFullProxy)._raw.localId);const hasChanged=recordList.data.some((localId,i)=>localId!==data[i]);if(hasChanged){recordListFullProxy.data=data;}}
updateAttr(record,fieldName,value){const Model=record.Model;const fieldType=Model._.fieldsType.get(fieldName);const fieldHtml=Model._.fieldsHtml.get(fieldName);const targetRecord=record._.proxyUsed.has(fieldName)?record:record._proxy;let shouldChange=record[fieldName]!==value;if(fieldType==="datetime"&&value){if(!(value instanceof luxon.DateTime)){value=deserializeDateTime(value);}
shouldChange=!record[fieldName]||!value.equals(record[fieldName]);}
if(fieldType==="date"&&value){if(!(value instanceof luxon.DateTime)){value=deserializeDate(value);}
shouldChange=!record[fieldName]||!value.equals(record[fieldName]);}
let newValue=value;if(fieldHtml){newValue=Array.isArray(value)&&value[0]==="markup"?value[1]?markup(value[1]):"":value?htmlEscape(value):"";shouldChange=record[fieldName]?.toString()!==newValue?.toString()||record[fieldName]instanceof Markup!=newValue instanceof Markup;}
if(shouldChange){record._.updatingAttrs.set(fieldName,true);targetRecord[fieldName]=newValue;record._.updatingAttrs.delete(fieldName);}}
updateFields(record,vals){const fieldEntries=Object.entries(vals).concat(Object.getOwnPropertySymbols(vals).map((sym)=>[sym,vals[sym]]));for(const[fieldName,value]of fieldEntries){if(!record.Model._.fields.get(fieldName)||record.Model._.fieldsAttr.get(fieldName)){this.updateAttr(record,fieldName,value);}else{this.updateRelation(record,fieldName,value);}}}
updateRelation(record,fieldName,value){const recordList=record[fieldName];if(isMany(record.Model,fieldName)){this.updateRelationMany(recordList,value);}else{this.updateRelationOne(recordList,value);}}
updateRelationMany(recordList,value){if(isCommand(value)){for(const[cmd,cmdData]of value){if(Array.isArray(cmdData)){for(const item of cmdData){if(cmd==="ADD"){recordList.add(item);}else if(cmd==="ADD.noinv"){recordList._.addNoinv(recordList,item);}else if(cmd==="DELETE.noinv"){recordList._.deleteNoinv(recordList,item);}else{recordList.delete(item);}}}else{if(cmd==="ADD"){recordList.add(cmdData);}else if(cmd==="ADD.noinv"){recordList._.addNoinv(recordList,cmdData);}else if(cmd==="DELETE.noinv"){recordList._.deleteNoinv(recordList,cmdData);}else{recordList.delete(cmdData);}}}}else if([null,false,undefined].includes(value)){recordList.clear();}else if(!Array.isArray(value)){recordList._.assign(recordList,[value]);}else{recordList._.assign(recordList,value);}}
updateRelationOne(recordList,value){if(isCommand(value)){const[cmd,cmdData]=value.at(-1);if(cmd==="ADD"){recordList.add(cmdData);}else if(cmd==="ADD.noinv"){recordList._.addNoinv(recordList,cmdData);}else if(cmd==="DELETE.noinv"){recordList._.deleteNoinv(recordList,cmdData);}else{recordList.delete(cmdData);}}else if([null,false,undefined].includes(value)){recordList.clear();}else{recordList.add(value);}}}
return __exports;});;

/* /mail/static/src/core/common/action.js */
odoo.define('@mail/core/common/action',['@mail/model/misc','@odoo/owl','@web/core/dropdown/dropdown_hooks','@web/core/utils/hooks','@web/core/utils/reactive'],function(require){'use strict';let __exports={};const{isRecord,STORE_SYM}=require("@mail/model/misc");const{Component,toRaw}=require("@odoo/owl");const{DropdownState}=require("@web/core/dropdown/dropdown_hooks");const{useService}=require("@web/core/utils/hooks");const{Reactive}=require("@web/core/utils/reactive");const ACTION_TAGS=__exports.ACTION_TAGS=Object.freeze({DANGER:"DANGER",SUCCESS:"SUCCESS",IMPORTANT_BADGE:"IMPORTANT_BADGE",WARNING_BADGE:"WARNING_BADGE",CALL_LAYOUT:"CALL_LAYOUT",JOIN_LEAVE_CALL:"JOIN_LEAVE_CALL",});const Action=__exports.Action=class Action{definition;owner;id;store;constructor({owner,id,definition,store}){this.definition=definition;this.id=id;this.owner=owner;const rawOwner=toRaw(owner);this.store=store??(rawOwner[STORE_SYM]?owner:isRecord(owner)?owner.store:useService("mail.store"));}
get params(){return{action:this,store:this.store,owner:this.owner};}
_badge(action){}
get badge(){return(this._badge(this.params)??(typeof this.definition.badge==="function"?this.definition.badge.call(this,this.params):this.definition.badge));}
_badgeIcon(action){}
get badgeIcon(){return(this._badgeIcon(this.params)??(typeof this.definition.badgeIcon==="function"?this.definition.badgeIcon.call(this,this.params):this.definition.badgeIcon));}
_badgeText(action){}
get badgeText(){return(this._badgeText(this.params)??(typeof this.definition.badgeText==="function"?this.definition.badgeText.call(this,this.params):this.definition.badgeText));}
_btnAttrs(action){}
get btnAttrs(){return(this._btnAttrs(this.params)??(typeof this.definition.btnAttrs==="function"?this.definition.btnAttrs.call(this,this.params):this.definition.btnAttrs));}
_btnClass(action){}
get btnClass(){return(this._btnClass(this.params)??(typeof this.definition.btnClass==="function"?this.definition.btnClass.call(this,this.params):this.definition.btnClass));}
_component(action){}
get component(){return this._component(this.params)??this.definition.component;}
_componentCondition(action){}
get componentCondition(){return(this._componentCondition(this.params)??(typeof this.definition.componentCondition==="function"?this.definition.componentCondition.call(this,this.params):this.definition.componentCondition??true));}
_componentProps(action){}
get componentProps(){return(this._componentProps(this.params)??this.definition.componentProps?.call(this,this.params));}
_condition(action){}
get condition(){return(this._condition(this.params)??(typeof this.definition.condition==="function"?this.definition.condition.call(this,this.params):this.definition.condition??true));}
_disabledCondition(action){}
get disabledCondition(){return Boolean(this._disabledCondition(this.params)??this.definition.disabledCondition?.call(this,this.params));}
_dropdown(action){}
get dropdown(){return this._dropdown(this.params)??this.definition.dropdown;}
_dropdownComponent(action){}
get dropdownComponent(){return(this._dropdownComponent(this.params)??(typeof this.definition.dropdownComponent==="function"&&Object.getPrototypeOf(this.definition.dropdownComponent)!==Component?this.definition.dropdownComponent.call(this,this.params):this.definition.dropdownComponent));}
_dropdownComponentProps(action){}
get dropdownComponentProps(){return(this._dropdownComponentProps(this.params)??(typeof this.definition.dropdownComponentProps==="function"?this.definition.dropdownComponentProps.call(this,this.params):this.definition.dropdownComponentProps));}
_dropdownMenuClass(action){}
get dropdownMenuClass(){return(this._dropdownMenuClass(this.params)??(typeof this.definition.dropdownMenuClass==="function"?this.definition.dropdownMenuClass.call(this,this.params):this.definition.dropdownMenuClass));}
_dropdownPosition(action){}
get dropdownPosition(){return(this._dropdownPosition(this.params)??(typeof this.definition.dropdownPosition==="function"?this.definition.dropdownPosition.call(this,this.params):this.definition.dropdownPosition));}
_dropdownState(action){}
get dropdownState(){return(this._dropdownState(this.params)??(typeof this.definition.dropdownState==="function"?this.definition.dropdownState.call(this,this.params):this.definition.dropdownState));}
_dropdownTemplate(action){}
get dropdownTemplate(){return(this._dropdownTemplate(this.params)??(typeof this.definition.dropdownTemplate==="function"?this.definition.dropdownTemplate.call(this,this.params):this.definition.dropdownTemplate));}
_dropdownTemplateParams(action){}
get dropdownTemplateParams(){return(this._dropdownTemplateParams(this.params)??(typeof this.definition.dropdownTemplateParams==="function"?this.definition.dropdownTemplateParams.call(this,this.params):this.definition.dropdownTemplateParams));}
_hotkey(action){}
get hotkey(){return(this._hotkey(this.params)??(typeof this.definition.hotkey==="function"?this.definition.hotkey.call(this,this.params):this.definition.hotkey));}
_icon(action){}
get icon(){return(this._icon(this.params)??(typeof this.definition.icon==="function"?this.definition.icon.call(this,this.params):this.definition.icon));}
_inlineName(action){}
get inlineName(){return(this._inlineName(this.params)??(typeof this.definition.inlineName==="function"?this.definition.inlineName.call(this,this.params):this.definition.inlineName)??false);}
_isActive(action){}
get isActive(){return(this._isActive(this.params)??(typeof this.definition.isActive==="function"?this.definition.isActive.call(this,this.params):this.definition.isActive));}
_name(action){}
get name(){return(this._name(this.params)??(typeof this.definition.name==="function"?this.definition.name.call(this,this.params):this.definition.name));}
_onSelected(action,ev){}
onSelected(ev){return(this._onSelected(this.params,ev)??this.definition.onSelected?.call(this,this.params,ev));}
_sequence(action){}
get sequence(){return(this._sequence(this.params)??(typeof this.definition.sequence==="function"?this.definition.sequence.call(this,this.params):this.definition.sequence));}
_sequenceGroup(action){}
get sequenceGroup(){return(this._sequenceGroup(this.params)??(typeof this.definition.sequenceGroup==="function"?this.definition.sequenceGroup.call(this,this.params):this.definition.sequenceGroup));}
_sequenceQuick(action){}
get sequenceQuick(){return(this._sequenceQuick(this.params)??(typeof this.definition.sequenceQuick==="function"?this.definition.sequenceQuick.call(this,this.params):this.definition.sequenceQuick));}
_setup(action){}
setup(){return this._setup(this.params)??this.definition.setup?.call(this,this.params);}
_tags(action){}
get tags(){const res=this._tags(this.params)??(typeof this.definition.tags==="function"?this.definition.tags.call(this,this.params):this.definition.tags);return Array.isArray(res)?res:[res];}
get tagClassNames(){return this.tags.map((tag)=>`o-tag-${tag}`).join(" ");}}
const UseActions=__exports.UseActions=class UseActions extends Reactive{ActionClass=Action;component;moreActions=new Map();transformedActions;store;constructor(component,transformedActions,store){super();this.component=component;this.transformedActions=transformedActions;this.store=store;}
more(data={},id){let moreAction=toRaw(this).moreActions.get(id);if(moreAction){moreAction=this.moreActions.get(id);moreAction.definition.actions=data.actions;}else{moreAction=new this.ActionClass({owner:this.component,id:`more-action:${id}`,definition:{...data,dropdown:true,dropdownState:new DropdownState(),icon:data?.icon??"oi oi-ellipsis-v",isActive:({action})=>action.dropdownState.isOpen,isMoreAction:true,sequence:data.sequence??1000,},store:this.store,});toRaw(this).moreActions.set(data.id,moreAction);}
return moreAction;}
get actions(){const actions=this.transformedActions.filter((action)=>action.condition).sort((a1,a2)=>a1.sequence-a2.sequence);return actions;}
get partition(){const actions=this.transformedActions.filter((action)=>action.condition);const quick=actions.filter((a)=>a.sequenceQuick).sort((a1,a2)=>a1.sequenceQuick-a2.sequenceQuick);const grouped=actions.filter((a)=>a.sequenceGroup);const groups={};for(const a of grouped){if(!(a.sequenceGroup in groups)){groups[a.sequenceGroup]=[];}
groups[a.sequenceGroup].push(a);}
const sortedGroups=Object.entries(groups).sort(([groupId1],[groupId2])=>groupId1-groupId2);for(const[,actions]of sortedGroups){actions.sort((a1,a2)=>a1.sequence-a2.sequence);}
const group=sortedGroups.map(([groupId,actions])=>actions);const other=actions.filter((a)=>!a.sequenceQuick&&!a.sequenceGroup).sort((a1,a2)=>a1.sequence-a2.sequence);return{quick,group,other};}}
return __exports;});;

/* /mail/static/src/core/common/action_list.js */
odoo.define('@mail/core/common/action_list',['@mail/discuss/call/common/call_dropdown','@mail/utils/common/format','@odoo/owl','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_item','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{CallDropdown}=require("@mail/discuss/call/common/call_dropdown");const{attClassObjectToString}=require("@mail/utils/common/format");const{Component,onWillUnmount}=require("@odoo/owl");const{Dropdown}=require("@web/core/dropdown/dropdown");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{useService}=require("@web/core/utils/hooks");const actionListProps=["inline?","dropdown?","fw?","hasBtnBg?","odooControlPanelSwitchStyle?","thread?",];class Action extends Component{static props=["action","group?","isFirstInGroup?","isLastInGroup?","style?",...actionListProps,];static defaultProps={fw:true};static components={Action,DropdownItem};static template="mail.Action";get ActionList(){return ActionList;}
get Dropdown(){if(this.env.inDiscussCallView?.isPip){return CallDropdown;}
return Dropdown;}
setup(){super.setup();this.store=useService("mail.store");this.ui=useService("ui");this.attClassObjectToString=attClassObjectToString;if(this.props.action.definition?.isMoreAction){onWillUnmount(()=>{this.props.action.dropdownState.close();});}}
get action(){return this.props.action;}
get hasBtnBg(){return this.props.odooControlPanelSwitchStyle||this.props.hasBtnBg;}
onSelected(action,ev){action.onSelected?.(ev);this.env.inCallDropdown?.close();}}
const ActionList=__exports.ActionList=class ActionList extends Component{static components={Action};static props=["actions","groupClass?",...actionListProps];static template="mail.ActionList";getActionProps(action,group,{index,isFirstInGroup,isLastInGroup}={}){return{action,group,isFirstInGroup,isLastInGroup,...Object.fromEntries(actionListProps.map((propName)=>{const actualPropName=propName.endsWith("?")?propName.substring(0,propName.length-1):propName;return[actualPropName,this.props[actualPropName]];})),style:`z-index: ${group.length - index}`,};}
setup(){super.setup();this.store=useService("mail.store");this.ui=useService("ui");this.actionListProps=actionListProps;}
get groups(){let groups;if(this.props.actions.find((i)=>Array.isArray(i))){groups=this.props.actions;}else{groups=[this.props.actions];}
return groups.filter((group)=>group.length);}
get hasBtnBg(){return this.props.odooControlPanelSwitchStyle||this.props.hasBtnBg;}}
return __exports;});;

/* /mail/static/src/core/common/activity_model.js */
odoo.define('@mail/core/common/activity_model',['@mail/core/common/record','@mail/utils/common/misc'],function(require){'use strict';let __exports={};const{fields,Record}=require("@mail/core/common/record");const{assignDefined}=require("@mail/utils/common/misc");const Activity=__exports.Activity=class Activity extends Record{static _name="mail.activity";static id="id";static _insert(data,{broadcast=true}={}){const activity=this.preinsert(data);assignDefined(activity,data);if(broadcast){this.store.activityBroadcastChannel?.postMessage({type:"INSERT",payload:activity.serialize(),});}
return activity;}
id;active;activity_category;activity_type_id=fields.One("mail.activity.type");activity_decoration;attachment_ids;can_write;chaining_type;create_date=fields.Datetime();create_uid=fields.One("res.users");date_deadline=fields.Date();date_done=fields.Date();display_name;has_recommended_activities;feedback;icon="fa-tasks";mail_template_ids=fields.Many("mail.template");note=fields.Html("");res_model;res_model_id;res_id;res_name;state;summary;user_id=fields.One("res.users");write_date;write_uid;serialize(){return JSON.parse(JSON.stringify(this.toData(["user_id"])));}}
Activity.register();return __exports;});;

/* /mail/static/src/core/common/attachment_list.js */
odoo.define('@mail/core/common/attachment_list',['@mail/core/common/gif','@odoo/owl','@web/core/browser/feature_detection','@web/core/confirmation_dialog/confirmation_dialog','@web/core/network/download','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_hooks','@web/core/dropdown/dropdown_item','@web/core/file_viewer/file_viewer_hook','@web/core/l10n/translation','@web/core/utils/hooks','@web/core/utils/urls'],function(require){'use strict';let __exports={};const{Gif}=require("@mail/core/common/gif");const{Component}=require("@odoo/owl");const{isMobileOS}=require("@web/core/browser/feature_detection");const{ConfirmationDialog}=require("@web/core/confirmation_dialog/confirmation_dialog");const{download}=require("@web/core/network/download");const{Dropdown}=require("@web/core/dropdown/dropdown");const{useDropdownState}=require("@web/core/dropdown/dropdown_hooks");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{useFileViewer}=require("@web/core/file_viewer/file_viewer_hook");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{useService}=require("@web/core/utils/hooks");const{url}=require("@web/core/utils/urls");class Actions extends Component{static components={Dropdown,DropdownItem};static props=["actions"];static template="mail.Actions";setup(){super.setup();this.actionsMenuState=useDropdownState();}}
const AttachmentList=__exports.AttachmentList=class AttachmentList extends Component{static components={Actions,Gif};static props=["attachments","unlinkAttachment","messageSearch?"];static template="mail.AttachmentList";setup(){super.setup();this.ui=useService("ui");this.dialog=useService("dialog");this.fileViewer=useFileViewer();this.actionsMenuState=useDropdownState();this.isMobileOS=isMobileOS();}
getImageUrl(attachment){if(attachment.uploading&&attachment.tmpUrl){return attachment.tmpUrl;}
return url(attachment.urlRoute,{...attachment.urlQueryParams,});}
canDownload(attachment){return!attachment.uploading&&!this.env.inComposer;}
onClickDownload(attachment){download({data:{},url:attachment.downloadUrl,});}
onClickUnlink(attachment){if(this.env.inComposer){return this.props.unlinkAttachment(attachment);}
this.dialog.add(ConfirmationDialog,{body:_t('Do you really want to delete "%s"?',attachment.name),cancel:()=>{},confirm:()=>this.onConfirmUnlink(attachment),});}
onClickAttachment(attachment){this.fileViewer.open(attachment,this.props.attachments);}
onConfirmUnlink(attachment){this.props.unlinkAttachment(attachment);}
onImageLoaded(){this.env.onImageLoaded?.();}
get isInChatWindowAndIsAlignedRight(){return this.env.inChatWindow&&this.env.alignedRight;}
get isInChatWindowAndIsAlignedLeft(){return this.env.inChatWindow&&!this.env.alignedRight;}
getActions(attachment){const res=[];if(this.showDelete){res.push({label:_t("Remove"),icon:"fa fa-trash",onSelect:()=>this.onClickUnlink(attachment),});}
if(this.canDownload(attachment)){res.push({label:_t("Download"),icon:"fa fa-download",onSelect:()=>this.onClickDownload(attachment),});}
return res;}
get showDelete(){if(this.env.inComposer){return true;}
if(!this.attachment.isDeletable){return false;}
return(!this.env.message||this.env.message.hasTextContent||(this.env.message&&this.props.attachments.length>1));}
showUploaded(attachment){return!attachment.isImage&&!attachment.uploading&&this.env.inComposer;}}
return __exports;});;

/* /mail/static/src/core/common/attachment_model.js */
odoo.define('@mail/core/common/attachment_model',['@mail/core/common/record','@mail/utils/common/misc','@mail/utils/common/pdf_thumbnail','@web/core/file_viewer/file_model','@web/core/l10n/translation','@web/core/network/rpc','@web/core/utils/urls'],function(require){'use strict';let __exports={};const{fields,Record}=require("@mail/core/common/record");const{assignDefined}=require("@mail/utils/common/misc");const{generatePdfThumbnail}=require("@mail/utils/common/pdf_thumbnail");const{FileModelMixin}=require("@web/core/file_viewer/file_model");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{rpc}=require("@web/core/network/rpc");const{imageUrl,url}=require("@web/core/utils/urls");const Attachment=__exports.Attachment=class Attachment extends FileModelMixin(Record){static _name="ir.attachment";static id="id";static new(){const attachment=super.new(...arguments);Record.onChange(attachment,["extension","name"],()=>{if(!attachment.extension&&attachment.name){attachment.extension=attachment.name.split(".").pop();}});return attachment;}
composer=fields.One("Composer",{inverse:"attachments"});thread=fields.One("Thread",{inverse:"attachments"});raw_access_token;res_name;thumbnail_access_token;message=fields.One("mail.message",{inverse:"attachment_ids"});ownership_token;create_date=fields.Datetime();has_thumbnail=fields.Attr(undefined,{onUpdate(){if(this.isPdf&&!this.has_thumbnail&&(this.store.self.main_user_id?.share===false||this.ownership_token)){this.setPdfThumbnail();}},});get thumbnailUrl(){return imageUrl("ir.attachment",this.id,"thumbnail",assignDefined({},{access_token:this.thumbnail_access_token,crop:"top",height:110,unique:this.checksum,width:180,}));}
get gifPaused(){return this.thread?!this.thread.isFocused:!this.composer?.isFocused;}
get isDeletable(){if(this.message&&this.store.self.main_user_id?.share!==false){return this.message.editable;}
return true;}
get monthYear(){if(!this.create_date){return undefined;}
return`${this.create_date.monthLong}, ${this.create_date.year}`;}
get uploading(){return this.id<0;}
delete(){if(this.tmpUrl){URL.revokeObjectURL(this.tmpUrl);}
super.delete();}
async remove(){if(this.id>0){await rpc("/mail/attachment/delete",assignDefined({attachment_id:this.id},{access_token:this.ownership_token}));}
this.delete();}
get previewName(){return this.voice?_t("Voice Message"):this.name||"";}
async setPdfThumbnail(){const{isPdfValid,thumbnail}=await generatePdfThumbnail(url(`/mail/attachment/pdf_first_page/${this.id}`,assignDefined({},{access_token:this.ownership_token})));if(isPdfValid){rpc(`/mail/attachment/update_thumbnail`,assignDefined({attachment_id:this.id,thumbnail},{access_token:this.ownership_token}));}}}
Attachment.register();return __exports;});;

/* /mail/static/src/core/common/attachment_upload_service.js */
odoo.define('@mail/core/common/attachment_upload_service',['@odoo/owl','@web/core/l10n/translation','@web/core/registry','@web/core/utils/concurrency'],function(require){'use strict';let __exports={};const{EventBus}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{registry}=require("@web/core/registry");const{Deferred}=require("@web/core/utils/concurrency");const AttachmentUploadService=__exports.AttachmentUploadService=class AttachmentUploadService{constructor(env,services){this.setup(env,services);}
setup(env,services){this.env=env;this.fileUploadService=services["file_upload"];this.store=services["mail.store"];this.notificationService=services["notification"];this.nextId=-1;this.abortByAttachmentId=new Map();this.deferredByAttachmentId=new Map();this.uploadingAttachmentIds=new Set();this._fileUploadBus=new EventBus();this.targetsByTmpId=new Map();this.fileUploadService.bus.addEventListener("FILE_UPLOAD_ADDED",({detail:{upload}})=>{const tmpId=parseInt(upload.data.get("temporary_id"));if(!this.uploadingAttachmentIds.has(tmpId)){return;}
const{thread,composer}=this.targetsByTmpId.get(tmpId);const tmpUrl=upload.data.get("tmp_url");this.abortByAttachmentId.set(tmpId,upload.xhr.abort.bind(upload.xhr));const attachment=this.store["ir.attachment"].insert(this._makeAttachmentData(upload,tmpId,composer?undefined:thread,tmpUrl));composer?.attachments.push(attachment);});this.fileUploadService.bus.addEventListener("FILE_UPLOAD_LOADED",({detail:{upload}})=>{const tmpId=parseInt(upload.data.get("temporary_id"));if(!this.uploadingAttachmentIds.has(tmpId)){return;}
const def=this.deferredByAttachmentId.get(tmpId);if(upload.xhr.status===413){this.notificationService.add(_t("File too large"),{type:"danger"});def.resolve();this._cleanupUploading(tmpId);return;}
if(upload.xhr.status!==200){this.notificationService.add(_t("Server error"),{type:"danger"});def.resolve();this._cleanupUploading(tmpId);return;}
const response=JSON.parse(upload.xhr.response);if(response.error){this.notificationService.add(response.error,{type:"danger"});def.resolve();this._cleanupUploading(tmpId);return;}
const{thread,composer}=this.targetsByTmpId.get(tmpId);this._processLoaded(thread,composer,response,tmpId,def);});this.fileUploadService.bus.addEventListener("FILE_UPLOAD_ERROR",({detail:{upload}})=>{const tmpId=parseInt(upload.data.get("temporary_id"));if(!this.uploadingAttachmentIds.has(tmpId)){return;}
this.deferredByAttachmentId.get(tmpId).resolve();this._cleanupUploading(tmpId);});}
_processLoaded(thread,composer,{data},tmpId,def){const{store_data,attachment_id}=data;this.store.insert(store_data);const attachment=this.store["ir.attachment"].get(attachment_id);if(composer){const index=composer.attachments.findIndex(({id})=>id===tmpId);if(index>=0){composer.attachments[index]=attachment;}else{composer.attachments.push(attachment);}}
def.resolve(attachment);this._fileUploadBus.trigger("UPLOAD",thread);this._cleanupUploading(tmpId);}
_cleanupUploading(tmpId){this.abortByAttachmentId.delete(tmpId);this.deferredByAttachmentId.delete(tmpId);this.uploadingAttachmentIds.delete(tmpId);this.targetsByTmpId.delete(tmpId);this.store["ir.attachment"].get(tmpId)?.remove();}
getUploadURL(thread){return"/mail/attachment/upload";}
async unlink(attachment){if(this.uploadingAttachmentIds.has(attachment.id)){const deferred=this.deferredByAttachmentId.get(attachment.id);const abort=this.abortByAttachmentId.get(attachment.id);this._cleanupUploading(attachment.id);deferred.resolve();abort();return;}
await attachment.remove();}
async upload(thread,composer,file,options){const tmpId=this.nextId--;const tmpURL=URL.createObjectURL(file);return this._upload(thread,composer,file,options,tmpId,tmpURL);}
async _upload(thread,composer,file,options,tmpId,tmpURL){this.targetsByTmpId.set(tmpId,{composer,thread});this.uploadingAttachmentIds.add(tmpId);await this.fileUploadService.upload(this.getUploadURL(thread),[file],{buildFormData:(formData)=>{this._buildFormData(formData,tmpURL,thread,composer,tmpId,options);},}).catch((e)=>{if(e.name!=="AbortError"){throw e;}});const uploadDoneDeferred=new Deferred();this.deferredByAttachmentId.set(tmpId,uploadDoneDeferred);return uploadDoneDeferred;}
onFileUploaded(thread,onFileUploaded){this._fileUploadBus.addEventListener("UPLOAD",({detail})=>{if(thread.eq(detail)){onFileUploaded();}});}
_buildFormData(formData,tmpURL,thread,composer,tmpId,options){formData.append("thread_id",thread.id);formData.append("tmp_url",tmpURL);formData.append("thread_model",thread.model);formData.append("is_pending",Boolean(composer));formData.append("temporary_id",tmpId);if(options?.activity){formData.append("activity_id",options.activity.id);}
return formData;}
_makeAttachmentData(upload,tmpId,thread,tmpUrl){const attachmentData={id:tmpId,mimetype:upload.type,name:upload.title,thread,extension:upload.title.split(".").pop(),uploading:true,tmpUrl,};return attachmentData;}}
const attachmentUploadService=__exports.attachmentUploadService={dependencies:["file_upload","mail.store","notification"],start(env,services){return new AttachmentUploadService(env,services);},};registry.category("services").add("mail.attachment_upload",attachmentUploadService);return __exports;});;

/* /mail/static/src/core/common/attachment_uploader_hook.js */
odoo.define('@mail/core/common/attachment_uploader_hook',['@odoo/owl','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{useState}=require("@odoo/owl");const{useService}=require("@web/core/utils/hooks");__exports.dataUrlToBlob=dataUrlToBlob;function dataUrlToBlob(data,type){const binData=window.atob(data);const uiArr=new Uint8Array(binData.length);uiArr.forEach((_,index)=>(uiArr[index]=binData.charCodeAt(index)));return new Blob([uiArr],{type});}
const AttachmentUploader=__exports.AttachmentUploader=class AttachmentUploader{constructor(thread,{composer}={}){this.attachmentUploadService=useService("mail.attachment_upload");Object.assign(this,{thread,composer});}
uploadData({data,name,type},options){const file=new File([dataUrlToBlob(data,type)],name,{type});return this.uploadFile(file,options);}
async uploadFile(file,options){return this.attachmentUploadService.upload(this.thread,this.composer,file,options);}
async unlink(attachment){await this.attachmentUploadService.unlink(attachment);}}
__exports.useAttachmentUploader=useAttachmentUploader;function useAttachmentUploader(thread,{composer,onFileUploaded}={}){return useState(new AttachmentUploader(...arguments));}
return __exports;});;

/* /mail/static/src/core/common/attachment_view.js */
odoo.define('@mail/core/common/attachment_view',['@odoo/owl','@web/core/utils/hooks','@web/core/utils/objects','@web/core/utils/pdfjs'],function(require){'use strict';let __exports={};const{Component,onMounted,onWillUnmount,onWillUpdateProps,useComponent,useEffect,useRef,useState,}=require("@odoo/owl");const{useService}=require("@web/core/utils/hooks");const{deepEqual}=require("@web/core/utils/objects");const{hidePDFJSButtons}=require("@web/core/utils/pdfjs");class AbstractAttachmentView extends Component{static template="mail.AttachmentView";static components={};static props=["threadId","threadModel"];setup(){super.setup();this.store=useService("mail.store");this.uiService=useService("ui");this.iframeViewerPdfRef=useRef("iframeViewerPdf");this.state=useState({thread:undefined,});useEffect((el)=>{if(el){hidePDFJSButtons(this.iframeViewerPdfRef.el);}},()=>[this.iframeViewerPdfRef.el]);this.updateFromProps(this.props);onWillUpdateProps((props)=>this.updateFromProps(props));}
onClickNext(){const index=this.state.thread.attachmentsInWebClientView.findIndex((attachment)=>attachment.eq(this.state.thread.message_main_attachment_id));this.state.thread.setMainAttachmentFromIndex(index>=this.state.thread.attachmentsInWebClientView.length-1?0:index+1);}
onClickPrevious(){const index=this.state.thread.attachmentsInWebClientView.findIndex((attachment)=>attachment.eq(this.state.thread.message_main_attachment_id));this.state.thread.setMainAttachmentFromIndex(index<=0?this.state.thread.attachmentsInWebClientView.length-1:index-1);}
updateFromProps(props){this.state.thread=this.store.Thread.insert({id:props.threadId,model:props.threadModel,});}
get displayName(){return this.state.thread.message_main_attachment_id.name;}
onClickPopout(){}}
const PopoutAttachmentView=__exports.PopoutAttachmentView=class PopoutAttachmentView extends AbstractAttachmentView{static template="mail.PopoutAttachmentView";}
__exports.usePopoutAttachment=usePopoutAttachment;function usePopoutAttachment(){const component=useComponent();const uiService=useService("ui");const mailPopoutService=useService("mail.popout");function attachmentViewParentElementClassList(){const attachmentViewEl=document.querySelector(".o-mail-Attachment");let parentElementClassList;if((parentElementClassList=attachmentViewEl?.parentElement?.classList)){return parentElementClassList;}
return null;}
function showAttachmentView(){const parentElementClassList=attachmentViewParentElementClassList();const hiddenClass="d-none";if(parentElementClassList?.contains(hiddenClass)){parentElementClassList.remove(hiddenClass);}}
function hideAttachmentView(){const parentElementClassList=attachmentViewParentElementClassList();const hiddenClass="d-none";if(!parentElementClassList?.contains(hiddenClass)){parentElementClassList?.add(hiddenClass);}}
function extractPopoutProps(props){return{threadId:props.threadId,threadModel:props.threadModel,};}
function popout(){mailPopoutService.addHooks(()=>{hideAttachmentView();uiService.bus.trigger("resize");},()=>{showAttachmentView();uiService.bus.trigger("resize");});mailPopoutService.popout(PopoutAttachmentView,extractPopoutProps(component.props));}
function updatePopout(newProps=component.props){if(mailPopoutService.externalWindow){hideAttachmentView();mailPopoutService.popout(PopoutAttachmentView,extractPopoutProps(newProps));}}
function resetPopout(){mailPopoutService.reset();}
onMounted(updatePopout);onWillUpdateProps((props)=>{const oldProps=extractPopoutProps(component.props);const newProps=extractPopoutProps(props);if(!deepEqual(oldProps,newProps)){updatePopout(newProps);}});onWillUnmount(resetPopout);return{popout,updatePopout,resetPopout,};}
const AttachmentView=__exports.AttachmentView=class AttachmentView extends AbstractAttachmentView{setup(){super.setup();this.attachmentPopout=usePopoutAttachment();}
onClickPopout(){this.attachmentPopout.popout();}}
return __exports;});;

/* /mail/static/src/core/common/autoresize_input.js */
odoo.define('@mail/core/common/autoresize_input',['@odoo/owl','@web/core/utils/autoresize'],function(require){'use strict';let __exports={};const{Component,useRef,useState,onWillUpdateProps,onMounted}=require("@odoo/owl");const{useAutoresize}=require("@web/core/utils/autoresize");const AutoresizeInput=__exports.AutoresizeInput=class AutoresizeInput extends Component{static template="mail.AutoresizeInput";static props={autofocus:{type:Boolean,optional:true},className:{type:String,optional:true},enabled:{optional:true},onValidate:{type:Function,optional:true},placeholder:{type:String,optional:true},value:{type:String,optional:true},};static defaultProps={autofocus:false,className:"",enabled:true,onValidate:()=>{},placeholder:"",};setup(){super.setup();this.state=useState({value:this.props.value,isFocused:false,});this.inputRef=useRef("input");onWillUpdateProps((nextProps)=>{if(this.props.value!==nextProps.value){this.state.value=nextProps.value;}});useAutoresize(this.inputRef);onMounted(()=>{if(this.props.autofocus){this.inputRef.el.focus();this.inputRef.el.setSelectionRange(-1,-1);}});}
onKeydownInput(ev){switch(ev.key){case"Enter":this.inputRef.el.blur();break;case"Escape":ev.stopPropagation();this.state.value=this.props.value;this.inputRef.el.blur();break;}}
onBlurInput(){this.state.isFocused=false;this.props.onValidate(this.state.value);}}
return __exports;});;

/* /mail/static/src/core/common/canned_response_model.js */
odoo.define('@mail/core/common/canned_response_model',['@mail/core/common/record'],function(require){'use strict';let __exports={};const{Record}=require("@mail/core/common/record");const CannedResponse=__exports.CannedResponse=class CannedResponse extends Record{static _name="mail.canned.response";static id="id";id;source;substitution;}
CannedResponse.register();return __exports;});;

/* /mail/static/src/core/common/chat_bubble.js */
odoo.define('@mail/core/common/chat_bubble',['@mail/core/common/im_status','@odoo/owl','@web/core/utils/hooks','@mail/utils/common/hooks','@web/core/popover/popover_hook','@mail/core/common/country_flag','@web/core/browser/feature_detection'],function(require){'use strict';let __exports={};const{ImStatus}=require("@mail/core/common/im_status");const{Component,useEffect,useRef,useState,useSubEnv}=require("@odoo/owl");const{useChildRef,useService}=require("@web/core/utils/hooks");const{useHover}=require("@mail/utils/common/hooks");const{usePopover}=require("@web/core/popover/popover_hook");const{CountryFlag}=require("@mail/core/common/country_flag");const{isMobileOS}=require("@web/core/browser/feature_detection");class ChatBubblePreview extends Component{static props=["chatWindow","close"];static template="mail.ChatBubblePreview";get thread(){return this.props.chatWindow.thread;}
get previewText(){const lastMessage=this.thread?.newestPersistentOfAllMessage;if(!lastMessage){return false;}
return lastMessage.previewText;}}
const ChatBubble=__exports.ChatBubble=class ChatBubble extends Component{static components={CountryFlag,ImStatus};static props=["chatWindow"];static template="mail.ChatBubble";setup(){super.setup();this.store=useService("mail.store");const popoverRef=useChildRef();this.isMobileOS=isMobileOS();this.popover=usePopover(ChatBubblePreview,{animation:false,position:"left-middle",popoverClass:"dropdown-menu bg-view border-0 p-0 overflow-visible o-rounded-bubble mx-1",ref:popoverRef,});this.env.bus.addEventListener("ChatBubble:preview-will-open",({detail})=>{if(detail===this){return;}
this.popover.close();});this.hover=useHover(["root",popoverRef],{onHover:()=>{this.env.bus.trigger("ChatBubble:preview-will-open",this);this.popover.open(this.rootRef.el,{chatWindow:this.props.chatWindow});},onAway:()=>this.popover.close(),});this.rootRef=useRef("root");this.state=useState({bouncing:false});useEffect((importantCounter)=>{this.state.bouncing=Boolean(importantCounter);},()=>[this.thread?.importantCounter]);useSubEnv({inChatBubble:true});}
get thread(){return this.props.chatWindow.thread;}
get showImStatus(){return(this.thread?.correspondent?.im_status&&this.thread.correspondent.im_status!=="offline");}}
return __exports;});;

/* /mail/static/src/core/common/chat_hub.js */
odoo.define('@mail/core/common/chat_hub',['@mail/core/common/chat_window','@mail/core/common/action_list','@mail/utils/common/hooks','@odoo/owl','@web/core/browser/browser','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_hooks','@web/core/registry','@web/core/utils/hooks','@mail/core/common/chat_bubble','@web/core/browser/feature_detection','@web/core/l10n/translation','@mail/core/common/action'],function(require){'use strict';let __exports={};const{ChatWindow}=require("@mail/core/common/chat_window");const{ActionList}=require("@mail/core/common/action_list");const{useHover,useMovable}=require("@mail/utils/common/hooks");const{Component,useEffect,useExternalListener,useRef,useState}=require("@odoo/owl");const{browser}=require("@web/core/browser/browser");const{Dropdown}=require("@web/core/dropdown/dropdown");const{useDropdownState}=require("@web/core/dropdown/dropdown_hooks");const{registry}=require("@web/core/registry");const{useService}=require("@web/core/utils/hooks");const{ChatBubble}=require("@mail/core/common/chat_bubble");const{isMobileOS}=require("@web/core/browser/feature_detection");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{Action}=require("@mail/core/common/action");const ChatHub=__exports.ChatHub=class ChatHub extends Component{static components={ActionList,ChatBubble,ChatWindow,Dropdown};static props=[];static template="mail.ChatHub";get chatHub(){return this.store.chatHub;}
setup(){super.setup();this.store=useService("mail.store");this.ui=useService("ui");this.busMonitoring=useService("bus.monitoring_service");this.bubblesHover=useHover("bubbles");this.moreHover=useHover(["more-button","more-menu"],{onHover:()=>(this.more.isOpen=true),onAway:()=>(this.more.isOpen=false),});this.options=useDropdownState();this.more=useDropdownState();this.ref=useRef("bubbles");this.position=useState({dragged:false,isDragging:false,top:"unset",left:"unset",bottom:`${this.chatHub.BUBBLE_OUTER}px;`,right:`${this.chatHub.BUBBLE_OUTER + this.chatHub.BUBBLE_START}px;`,});this.onResize();useExternalListener(browser,"resize",this.onResize);useEffect(()=>{if(this.chatHub.folded.length&&this.store.channels?.status==="not_fetched"){this.store.channels.fetch();}});useMovable({enable:()=>this.chatHub.compact||!this.chatHub.opened.length,cursor:"grabbing",ref:this.ref,elements:".o-mail-ChatHub-bubbles",onDragStart:()=>{this.more.close();this.options.close();this.position.isDragging=true;this.position.dragged=true;},onDragEnd:()=>(this.position.isDragging=false),onDrop:this.onDrop.bind(this),});this.env.bus.addEventListener("ChatWindow:will-open",()=>{this.resetPosition();});}
get optionActions(){const actions=[];if(this.chatHub.showConversations&&!this.chatHub.compact){actions.push(new Action({owner:this,id:"hide-all",definition:{name:_t("Hide all conversations"),icon:"fa fa-eye-slash",onSelected:()=>this.chatHub.hideAll(),},store:this.store,}),new Action({owner:this,id:"close-all",definition:{name:_t("Close all conversations"),icon:"oi oi-close",onSelected:()=>this.chatHub.closeAll(),},store:this.store,}));}
if(this.position.dragged){actions.push(new Action({owner:this,id:"reset-position",definition:{name:_t("Reset initial position"),icon:"fa fa-undo",onSelected:()=>this.resetPosition(),},store:this.store,}));}
return actions;}
get isMobileOS(){return isMobileOS();}
onDrop({top,left}){this.position.bottom="unset";this.position.right="unset";this.position.top=`${top}px`;this.position.left=`${left}px`;}
onResize(){this.chatHub.onRecompute();}
resetPosition(){this.position.top="unset";this.position.left="unset";this.position.bottom=`${this.chatHub.BUBBLE_OUTER}px;`;this.position.right=`${this.chatHub.BUBBLE_OUTER + this.chatHub.BUBBLE_START}px;`;this.position.dragged=false;this.options.close();}
get compactCounter(){let counter=0;const cws=this.chatHub.opened.concat(this.chatHub.folded);for(const chatWindow of cws){counter+=chatWindow.thread.importantCounter>0?1:0;}
return counter;}
get hiddenCounter(){let counter=0;for(const chatWindow of this.chatHub.folded.slice(this.chatHub.maxFolded)){counter+=chatWindow.thread.importantCounter>0?1:0;}
return counter;}
get displayConversations(){return this.chatHub.showConversations&&!this.chatHub.compact;}
get isShown(){return true;}
shouldDisplayChatWindow(cw){return cw.canShow;}
expand(){this.chatHub.compact=false;this.more.isOpen=this.chatHub.folded.length>this.chatHub.maxFolded;if(this.chatHub.opened.length>0){this.resetPosition();}}}
const chatHubService=__exports.chatHubService={dependencies:["bus.monitoring_service","mail.store","ui"],start(){registry.category("main_components").add("mail.ChatHub",{Component:ChatHub});},};registry.category("services").add("mail.chat_hub",chatHubService);return __exports;});;

/* /mail/static/src/core/common/chat_hub_model.js */
odoo.define('@mail/core/common/chat_hub_model',['@web/core/browser/browser','@mail/core/common/record','@web/core/utils/concurrency'],function(require){'use strict';let __exports={};const{browser}=require("@web/core/browser/browser");const{fields,Record}=require("@mail/core/common/record");const{Deferred,Mutex}=require("@web/core/utils/concurrency");const CHAT_HUB_KEY=__exports.CHAT_HUB_KEY="mail.ChatHub";const CHAT_HUB_COMPACT_LS="mail.user_setting.chathub_compact";const ChatHub=__exports.ChatHub=class ChatHub extends Record{BUBBLE=56;BUBBLE_START=15;BUBBLE_LIMIT=7;BUBBLE_OUTER=10;WINDOW_GAP=10;WINDOW_INBETWEEN=5;WINDOW=380;static new(){const chatHub=super.new(...arguments);browser.addEventListener("storage",(ev)=>{if(ev.key===CHAT_HUB_KEY){chatHub.load(ev.newValue||undefined);}else if(ev.key===null){chatHub.load();}
if(ev.key===CHAT_HUB_COMPACT_LS){chatHub.compact=ev.newValue==="true";}});chatHub.load(browser.localStorage.getItem(CHAT_HUB_KEY)??undefined).then(()=>chatHub.initPromise.resolve());return chatHub;}
compact=fields.Attr(false,{compute(){return browser.localStorage.getItem(CHAT_HUB_COMPACT_LS)==="true";},onUpdate(){if(this.compact){browser.localStorage.setItem(CHAT_HUB_COMPACT_LS,this.compact.toString());}else{browser.localStorage.removeItem(CHAT_HUB_COMPACT_LS);}},});canShowOpened=fields.Many("ChatWindow");canShowFolded=fields.Many("ChatWindow");opened=fields.Many("ChatWindow",{inverse:"hubAsOpened",onAdd(r){this.onRecompute();},});folded=fields.Many("ChatWindow",{inverse:"hubAsFolded"});initPromise=new Deferred();preFirstFetchPromise=new Deferred();loadMutex=new Mutex();async closeAll(){await this.initPromise;const promises=[];for(const cw of[...this.opened,...this.folded]){promises.push(cw.close({notifyState:false}));}
await Promise.all(promises);this.save();}
hideAll(){for(const cw of this.opened){cw.bypassCompact=false;}
this.compact=true;}
onRecompute(){while(this.opened.length>this.maxOpened){const cw=this.opened.pop();this.folded.unshift(cw);}}
async load(str="{}"){await this.loadMutex.exec(()=>this._load(str));}
async _load(str){const{opened=[],folded=[]}=JSON.parse(str);const hasInvalidData=opened.some((data)=>!data.id||!data.model)||folded.some((data)=>!data.id||!data.model);if(hasInvalidData){opened.length=0;folded.length=0;browser.localStorage.removeItem(CHAT_HUB_KEY);}
const getThread=(data)=>this.store.Thread.getOrFetch(data,["display_name"]);const openPromises=opened.map(getThread);const foldPromises=folded.map(getThread);this.preFirstFetchPromise.resolve();const foldThreads=await Promise.all(foldPromises);const openThreads=await Promise.all(openPromises);const insertChatWindows=(threads)=>threads.filter((thread)=>thread?.model==="discuss.channel").map((thread)=>this.store.ChatWindow.insert({thread}));const toFold=insertChatWindows(foldThreads);const toOpen=insertChatWindows(openThreads);for(const chatWindow of[...this.opened,...this.folded]){if(chatWindow.notIn(toOpen)&&chatWindow.notIn(toFold)){chatWindow.close({force:true,notifyState:false});}}
this.folded=toFold;this.opened=toOpen;}
get maxOpened(){const chatBubblesWidth=this.BUBBLE_START+this.BUBBLE+this.BUBBLE_OUTER*2;const startGap=this.store.env.services.ui.isSmall?0:this.WINDOW_GAP;const endGap=this.store.env.services.ui.isSmall?0:this.WINDOW_GAP;const available=browser.innerWidth-startGap-endGap-chatBubblesWidth;const maxAmountWithoutHidden=Math.max(1,Math.floor(available/(this.WINDOW+this.WINDOW_INBETWEEN)));return maxAmountWithoutHidden;}
get maxFolded(){const chatBubbleSpace=this.BUBBLE_START+this.BUBBLE+this.BUBBLE_OUTER*2;return Math.min(this.BUBBLE_LIMIT,Math.floor(browser.innerHeight/chatBubbleSpace));}
save(){browser.localStorage.setItem(CHAT_HUB_KEY,JSON.stringify({opened:this.opened.map((cw)=>({id:cw.thread.id,model:cw.thread.model})),folded:this.folded.map((cw)=>({id:cw.thread.id,model:cw.thread.model})),}));}
showConversations=fields.Attr(false,{compute(){return this.canShowOpened.length+this.canShowFolded.length>0;},});}
ChatHub.register();return __exports;});;

/* /mail/static/src/core/common/chat_window.js */
odoo.define('@mail/core/common/chat_window',['@mail/core/common/action_list','@mail/core/common/composer','@mail/core/common/im_status','@mail/core/common/thread','@mail/core/common/autoresize_input','@mail/core/common/country_flag','@mail/core/common/thread_actions','@mail/core/common/thread_icon','@mail/utils/common/hooks','@web/core/utils/misc','@odoo/owl','@web/core/dropdown/dropdown','@web/core/l10n/localization','@web/core/l10n/translation','@web/core/utils/hooks','@mail/discuss/typing/common/typing','@web/core/hotkeys/hotkey_service','@web/core/browser/feature_detection'],function(require){'use strict';let __exports={};const{ActionList}=require("@mail/core/common/action_list");const{Composer}=require("@mail/core/common/composer");const{ImStatus}=require("@mail/core/common/im_status");const{Thread}=require("@mail/core/common/thread");const{AutoresizeInput}=require("@mail/core/common/autoresize_input");const{CountryFlag}=require("@mail/core/common/country_flag");const{useThreadActions}=require("@mail/core/common/thread_actions");const{ThreadIcon}=require("@mail/core/common/thread_icon");const{useHover,useMessageScrolling}=require("@mail/utils/common/hooks");const{isEventHandled}=require("@web/core/utils/misc");const{Component,toRaw,useChildSubEnv,useRef,useState,useSubEnv}=require("@odoo/owl");const{Dropdown}=require("@web/core/dropdown/dropdown");const{localization}=require("@web/core/l10n/localization");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{useService}=require("@web/core/utils/hooks");const{Typing}=require("@mail/discuss/typing/common/typing");const{getActiveHotkey}=require("@web/core/hotkeys/hotkey_service");const{isMobileOS}=require("@web/core/browser/feature_detection");const ChatWindow=__exports.ChatWindow=class ChatWindow extends Component{static components={ActionList,CountryFlag,Dropdown,Thread,Composer,ThreadIcon,ImStatus,AutoresizeInput,Typing,};static props=["chatWindow","right?"];static template="mail.ChatWindow";setup(){super.setup();useSubEnv({inChatWindow:true});this.store=useService("mail.store");this.messageHighlight=useMessageScrolling();this.state=useState({actionsMenuOpened:false,jumpThreadPresent:0,editingGuestName:false,editingName:false,});this.ui=useService("ui");this.contentRef=useRef("content");this.threadActions=useThreadActions({thread:()=>this.thread});this.actionsMenuButtonHover=useHover("actionsMenuButton");this.parentChannelHover=useHover("parentChannel");this.isMobileOS=isMobileOS();useChildSubEnv({closeActionPanel:()=>this.threadActions.activeAction?.close(),messageHighlight:this.messageHighlight,});}
get composerType(){if(this.thread.model!=="discuss.channel"){return"note";}
return undefined;}
get hasActionsMenu(){return(this.partitionedActions.group.length>0||this.partitionedActions.other.length>0||(this.ui.isSmall&&this.partitionedActions.quick.length>2)||(!this.ui.isSmall&&this.partitionedActions.quick.length>3));}
get thread(){return this.props.chatWindow.thread;}
get showImStatus(){return this.thread?.channel_type==="chat"&&this.thread.correspondent;}
get attClass(){return{"w-100 h-100 o-mobile":this.ui.isSmall,"o-rounded-bubble border border-dark mb-2":!this.ui.isSmall,};}
get style(){const textDirection=localization.direction;const offsetFrom=textDirection==="rtl"?"left":"right";const visibleOffset=this.ui.isSmall?0:this.props.right;const oppositeFrom=offsetFrom==="right"?"left":"right";return`${offsetFrom}: ${visibleOffset}px; ${oppositeFrom}: auto;`;}
onKeydown(ev){const chatWindow=toRaw(this.props.chatWindow);if(ev.key==="Escape"&&this.threadActions.activeAction){this.threadActions.activeAction.close();ev.stopPropagation();return;}
if(ev.target.closest(".o-dropdown")||ev.target.closest(".o-dropdown--menu")){return;}
ev.stopPropagation();switch(getActiveHotkey(ev)){case"escape":if(isEventHandled(ev,"NavigableList.close")||isEventHandled(ev,"Composer.discard")){return;}
if(this.state.editingName){this.state.editingName=false;return;}
this.close({escape:true});break;case"tab":{const index=this.store.chatHub.opened.findIndex((cw)=>cw.eq(chatWindow));if(index===this.store.chatHub.opened.length-1){this.store.chatHub.opened[0].focus({jumpToNewMessage:true});}else{this.store.chatHub.opened[index+1].focus({jumpToNewMessage:true});}
break;}
case"control+k":this.store.env.services.command.openMainPalette({searchValue:"@"});ev.preventDefault();break;}}
onClickHeader(ev){if(this.ui.isSmall||this.state.editingName||this.props.chatWindow.actionsDisabled||isEventHandled(ev,"ThreadAction.onSelected")){return;}
this.toggleFold();}
toggleFold(){const chatWindow=toRaw(this.props.chatWindow);if(this.state.actionsMenuOpened){return;}
chatWindow.fold();}
close(options){const chatWindow=toRaw(this.props.chatWindow);chatWindow.close(options);}
get actionsMenuTitleText(){return _t("Open Actions Menu");}
async renameThread(name){const thread=toRaw(this.thread);await thread.rename(name);this.state.editingName=false;}
async renameGuest(name){const newName=name.trim();if(this.store.self.name!==newName){await this.store.self.updateGuestName(newName);}
this.state.editingGuestName=false;}
async onActionsMenuStateChanged(isOpen){this.state.actionsMenuOpened=isOpen;}}
return __exports;});;

/* /mail/static/src/core/common/chat_window_model.js */
odoo.define('@mail/core/common/chat_window_model',['@mail/core/common/record'],function(require){'use strict';let __exports={};const{fields,Record}=require("@mail/core/common/record");const ChatWindow=__exports.ChatWindow=class ChatWindow extends Record{static id="thread";actionsDisabled=false;bypassCompact=false;thread=fields.One("Thread",{inverse:"chat_window"});autofocus=0;jumpToNewMessage=0;hidden=false;fromMessagingMenu=false;hubAsOpened=fields.One("ChatHub",{inverse:"opened"});hubAsFolded=fields.One("ChatHub",{inverse:"folded"});hubAsCanShowOpened=fields.One("ChatHub",{inverse:"canShowOpened",compute(){if(this.canShow&&this.hubAsOpened){return this.store.chatHub;}},});hubAsCanShowFolded=fields.One("ChatHub",{inverse:"canShowFolded",compute(){if(this.canShow&&this.hubAsFolded){return this.store.chatHub;}},});get displayName(){return this.thread?.displayName;}
get isOpen(){return Boolean(this.hubAsOpened);}
canShow=fields.Attr(true,{compute(){return this.computeCanShow();},});computeCanShow(){if(this.store.env.services.ui.isSmall){return!this.hubAsFolded||!this.store.discuss?.isActive;}
return!this.store.discuss?.isActive;}
async close(options={}){await this.store.chatHub.initPromise;const{escape=false}=options;options.notifyState??=true;const chatHub=this.store.chatHub;const indexAsOpened=chatHub.opened.findIndex((w)=>w.eq(this));this.store.chatHub.opened.delete(this);this.store.chatHub.folded.delete(this);if(options.notifyState){this.store.chatHub.save();}
if(escape&&indexAsOpened!==-1&&chatHub.opened.length>0){chatHub.opened[indexAsOpened===0?0:indexAsOpened-1].focus();}
this._onClose(options);this.delete();}
focus({jumpToNewMessage=false}={}){this.autofocus++;if(jumpToNewMessage){this.jumpToNewMessage++;}}
async fold(){await this.store.chatHub.initPromise;this.store.chatHub.opened.delete(this);this.store.chatHub.folded.delete(this);this.store.chatHub.folded.unshift(this);this.store.chatHub.save();this.bypassCompact=false;}
async open({focus=false,notifyState=true,jumpToNewMessage=false,swapOpened=true,}={}){await this.store.chatHub.initPromise;this.store.env.bus.trigger("ChatWindow:will-open");this.store.chatHub.folded.delete(this);if(swapOpened||!this.store.chatHub.opened.includes(this)){this.store.chatHub.opened.delete(this);this.store.chatHub.opened.unshift(this);}
if(notifyState){this.store.chatHub.save();}
if(focus){this.focus({jumpToNewMessage});}}
_onClose(){}}
ChatWindow.register();return __exports;});;

/* /mail/static/src/core/common/composer.js */
odoo.define('@mail/core/common/composer',['@mail/core/common/attachment_list','@mail/core/common/attachment_uploader_hook','@web/core/dropzone/dropzone_hook','@mail/core/common/mail_attachment_dropzone','@mail/core/common/message_confirm_dialog','@mail/core/common/navigable_list','@mail/core/common/plugin/plugin_sets','@mail/core/common/suggestion_hook','@mail/utils/common/hooks','@mail/utils/common/misc','@html_editor/wysiwyg','@web/core/network/rpc','@web/core/utils/misc','@web/core/browser/browser','@web/core/utils/timing','@odoo/owl','@web/core/l10n/translation','@web/core/utils/hooks','@web/core/utils/html','@web/views/fields/file_handler','@web/core/utils/strings','@web/core/browser/feature_detection','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_item','@mail/core/common/composer_actions','@mail/core/common/action_list','@html_editor/utils/dom_traversal'],function(require){'use strict';let __exports={};const{AttachmentList}=require("@mail/core/common/attachment_list");const{useAttachmentUploader}=require("@mail/core/common/attachment_uploader_hook");const{useCustomDropzone}=require("@web/core/dropzone/dropzone_hook");const{MailAttachmentDropzone}=require("@mail/core/common/mail_attachment_dropzone");const{MessageConfirmDialog}=require("@mail/core/common/message_confirm_dialog");const{NavigableList}=require("@mail/core/common/navigable_list");const{MAIL_PLUGINS,MAIL_SMALL_UI_PLUGINS}=require("@mail/core/common/plugin/plugin_sets");const{useSuggestion}=require("@mail/core/common/suggestion_hook");const{useSelection}=require("@mail/utils/common/hooks");const{isDragSourceExternalFile}=require("@mail/utils/common/misc");const{Wysiwyg}=require("@html_editor/wysiwyg");const{rpc}=require("@web/core/network/rpc");const{isEventHandled,markEventHandled}=require("@web/core/utils/misc");const{browser}=require("@web/core/browser/browser");const{useDebounced}=require("@web/core/utils/timing");const{Component,markup,onMounted,onWillUnmount,useChildSubEnv,useEffect,useRef,useState,useExternalListener,toRaw,EventBus,reactive,}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{useService}=require("@web/core/utils/hooks");const{createElementWithContent,htmlJoin,isHtmlEmpty,isMarkup,setElementContent,}=require("@web/core/utils/html");const{FileUploader}=require("@web/views/fields/file_handler");const{isEmail}=require("@web/core/utils/strings");const{isDisplayStandalone,isIOS,isMobileOS}=require("@web/core/browser/feature_detection");const{Dropdown}=require("@web/core/dropdown/dropdown");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{useComposerActions}=require("@mail/core/common/composer_actions");const{ActionList}=require("@mail/core/common/action_list");const{lastLeaf}=require("@html_editor/utils/dom_traversal");const EDIT_CLICK_TYPE={CANCEL:"cancel",SAVE:"save",};const Composer=__exports.Composer=class Composer extends Component{static components={ActionList,AttachmentList,Dropdown,DropdownItem,FileUploader,NavigableList,Wysiwyg,};static defaultProps={mode:"normal",className:"",sidebar:true,showFullComposer:true,allowUpload:true,};static props=["composer","autofocus?","onCloseFullComposerCallback?","onDiscardCallback?","onPostCallback?","mode?","placeholder?","dropzoneRef?","className?","sidebar?","type?","showFullComposer?","allowUpload?",];static template="mail.Composer";setup(){super.setup();this.editor=undefined;this.isMobileOS=isMobileOS();this.isIosPwa=isIOS()&&isDisplayStandalone();this.store=useService("mail.store");this.composerActions=useComposerActions({composer:()=>this.props.composer});this.EDIT_CLICK_TYPE=EDIT_CLICK_TYPE;this.OR_PRESS_SEND_KEYBIND=_t("or press %(send_keybind)s",{send_keybind:htmlJoin(this.sendKeybinds.map((key)=>markup`<samp>${key}</samp>`)," + "),});this.attachmentUploader=useAttachmentUploader(this.thread??this.props.composer.message.thread,{composer:this.props.composer});this.ui=useService("ui");this.composerService=useService("mail.composer");this.ref=useRef("textarea");this.fakeTextarea=useRef("fakeTextarea");this.inputContainerRef=useRef("input-container");this.pickerContainerRef=useRef("picker-container");this.state=useState({active:true,isFullComposerOpen:false,});this.root=useRef("root");this.fullComposerBus=new EventBus();this.selection=useSelection({refName:"textarea",model:this.props.composer.selection,preserveOnClickAwayPredicate:async(ev)=>{await new Promise(setTimeout);return(!this.isEventTrusted(ev)||isEventHandled(ev,"sidebar.openThread")||isEventHandled(ev,"emoji.selectEmoji")||isEventHandled(ev,"Composer.onClickAddEmoji")||isEventHandled(ev,"composer.clickOnAddAttachment")||isEventHandled(ev,"composer.selectSuggestion")||isEventHandled(ev,"composer.clickInsertCannedResponse"));},});this.suggestion=useSuggestion();this.markEventHandled=markEventHandled;this.onDropFile=this.onDropFile.bind(this);this.saveContentDebounced=useDebounced(this.saveContent,5000,{execBeforeUnmount:true,});this.updateFromEditor=false;useExternalListener(window,"beforeunload",this.saveContent.bind(this));useExternalListener(window,"click",(ev)=>{if(this.ui.isSmall&&this.composerActions.activePicker&&this.pickerContainerRef.el&&ev.target!==this.pickerContainerRef.el&&!this.pickerContainerRef.el.contains(ev.target)){this.composerActions.activePicker.close?.();}},{capture:true});if(this.props.dropzoneRef){useCustomDropzone(this.props.dropzoneRef,MailAttachmentDropzone,{extraClass:"o-mail-Composer-dropzone",onDrop:this.onDropFile,},()=>this.props.allowUpload&&(!this.store.rtc.state.isFullscreen||this.env.inMeetingView));}
useChildSubEnv({inComposer:true});useEffect((focus)=>{if(focus&&this.ref.el){this.selection.restore();this.ref.el.focus();}
if(focus&&this.editor){this.editor.shared.selection.focusEditable();}},()=>[this.props.autofocus+this.props.composer.autofocus,this.props.placeholder]);useEffect(()=>{if(this.props.composer.replyToMessage){this.props.composer.autofocus++;}},()=>[this.props.composer.replyToMessage]);useEffect(()=>{if(this.fakeTextarea.el?.scrollHeight){let wasEmpty=false;if(!this.fakeTextarea.el.value){wasEmpty=true;this.fakeTextarea.el.value="0";}
this.ref.el.style.height=this.fakeTextarea.el.scrollHeight+"px";if(wasEmpty){this.fakeTextarea.el.value="";}}
this.saveContentDebounced();},()=>[this.props.composer.composerText,this.ref.el]);useEffect(()=>{if(!this.props.composer.forceCursorMove){return;}
this.selection.restore();this.props.composer.forceCursorMove=false;},()=>[this.props.composer.forceCursorMove]);onMounted(()=>{this.ref.el?.scrollTo({top:0,behavior:"instant"});if(!this.props.composer.composerText){this.restoreContent();}});onWillUnmount(()=>{this.props.composer.isFocused=false;});const composerProxy=reactive(this.props.composer,()=>{if(this.status===2){return;}
const composerHtml=composerProxy.composerHtml;if(this.updateFromEditor){return;}
if(!this.editor?.editable){return;}
setElementContent(this.editor.editable,composerHtml);this.editor.shared.selection.setCursorEnd(lastLeaf(this.editor.editable));this.editor.shared.history.addStep();});void composerProxy.composerHtml;}
get areAllActionsDisabled(){return false;}
get isMultiUpload(){return true;}
get placeholder(){if(this.props.placeholder){return this.props.placeholder;}
if(this.thread){if(this.thread.channel_type==="channel"){const threadName=this.thread.displayName;if(this.thread.parent_channel_id){return _t('Message "%(subChannelName)s"',{subChannelName:threadName,});}
return _t("Message #%(threadName)s",{threadName});}
return _t("Message %(thread name)s",{"thread name":this.thread.displayName});}
return"";}
get wysiwygConfig(){return{content:this.props.composer.composerHtml,placeholder:this.placeholder,Plugins:this.ui.isSmall?MAIL_SMALL_UI_PLUGINS:MAIL_PLUGINS,composerPluginDependencies:{onBeforePaste:(selection,ev)=>this.onPaste(ev),onFocusin:this.onFocusin.bind(this),onFocusout:this.onFocusout.bind(this),onInput:this.onInput.bind(this),onKeydown:this.onKeydown.bind(this),},classList:["o-mail-Composer-html"],onChange:()=>this.onChangeWysiwygContent(),onEditorReady:()=>{this.editor.shared.selection.setCursorEnd(lastLeaf(this.editor.editable));this.editor.shared.history.addStep();},};}
onClickCancelOrSaveEditText(ev){const composer=toRaw(this.props.composer);if(composer.message&&ev.target.dataset?.type===EDIT_CLICK_TYPE.CANCEL){this.props.onDiscardCallback(ev);}
if(composer.message&&ev.target.dataset?.type===EDIT_CLICK_TYPE.SAVE){this.editMessage(ev);}}
get CANCEL_OR_SAVE_EDIT_TEXT(){const tags={open_samp:markup`<samp>`,close_samp:markup`</samp>`,open_em:markup`<em>`,close_em:markup`</em>`,open_cancel:markup`<button class="btn btn-link fst-italic p-0 align-baseline" data-type="${EDIT_CLICK_TYPE.CANCEL}">`,close_cancel:markup`</button>`,open_save:markup`<button class="btn btn-link fst-italic p-0 align-baseline" data-type="${EDIT_CLICK_TYPE.SAVE}">`,close_save:markup`</button>`,};return this.env.inChatter?_t("%(open_samp)sEscape%(close_samp)s %(open_em)sto %(open_cancel)scancel%(close_cancel)s%(close_em)s, %(open_samp)sCTRL-Enter%(close_samp)s %(open_em)sto %(open_save)ssave%(close_save)s%(close_em)s",tags):_t("%(open_samp)sEscape%(close_samp)s %(open_em)sto %(open_cancel)scancel%(close_cancel)s%(close_em)s, %(open_samp)sEnter%(close_samp)s %(open_em)sto %(open_save)ssave%(close_save)s%(close_em)s",tags);}
get SEND_TEXT(){if(this.props.composer.message){return _t("Save editing");}
return this.props.type==="note"?_t("Log"):_t("Send");}
get sendKeybinds(){return this.env.inChatter?[_t("CTRL"),_t("Enter")]:[_t("Enter")];}
get showComposerAvatar(){return!this.compact&&this.props.sidebar;}
get thread(){return this.props.composer.targetThread;}
get allowUpload(){return this.props.allowUpload;}
get message(){return this.props.composer.message??null;}
get extraData(){return this.thread.rpcParams;}
get isSendButtonDisabled(){const attachments=this.props.composer.attachments;return(!this.state.active||(isHtmlEmpty(this.props.composer.composerHtml)&&attachments.length===0)||attachments.some(({uploading})=>Boolean(uploading)));}
get hasSuggestions(){return Boolean(this.suggestion?.state.items);}
get navigableListProps(){const props={anchorRef:this.inputContainerRef.el,position:this.env.inChatter?"bottom-fit":"top-fit",onSelect:(ev,option)=>{this.suggestion.insert(option);markEventHandled(ev,"composer.selectSuggestion");},isLoading:!!this.suggestion.search.term&&this.suggestion.state.isFetching,options:[],};if(!this.hasSuggestions){return props;}
const suggestions=this.suggestion.state.items.suggestions;switch(this.suggestion.state.items.type){case"Partner":return{...props,optionTemplate:"mail.Composer.suggestionPartner",options:suggestions.map((suggestion)=>{if(suggestion.isSpecial){return{...suggestion,group:1,optionTemplate:"mail.Composer.suggestionSpecial",classList:"o-mail-Composer-suggestion",};}else if(suggestion.Model.getName()==="res.role"){return{label:suggestion.name,role:suggestion,thread:this.thread,optionTemplate:"mail.Composer.suggestionRole",classList:"o-mail-Composer-suggestion",};}else{return{label:this.thread?.getPersonaName(suggestion)??suggestion.name,thread:this.thread,partner:suggestion,classList:"o-mail-Composer-suggestion",};}}),};case"Thread":return{...props,optionTemplate:"mail.Composer.suggestionThread",options:suggestions.map((suggestion)=>({label:suggestion.fullNameWithParent,thread:suggestion,classList:"o-mail-Composer-suggestion",})),};case"ChannelCommand":return{...props,optionTemplate:"mail.Composer.suggestionChannelCommand",options:suggestions.map((suggestion)=>({label:suggestion.name,help:suggestion.help,classList:"o-mail-Composer-suggestion",})),};case"mail.canned.response":return{...props,optionTemplate:"mail.Composer.suggestionCannedResponse",options:suggestions.map((suggestion)=>({cannedResponse:suggestion,source:suggestion.source,label:suggestion.substitution,classList:"o-mail-Composer-suggestion",})),};case"emoji":return{...props,optionTemplate:"mail.Composer.suggestionEmoji",options:suggestions.map((suggestion)=>({emoji:suggestion,label:suggestion.codepoints,})),};default:return props;}}
onDropFile(ev){if(isDragSourceExternalFile(ev.dataTransfer)){for(const file of ev.dataTransfer.files){this.attachmentUploader.uploadFile(file);}}}
onCloseFullComposerCallback(isDiscard){if(this.props.onCloseFullComposerCallback){this.props.onCloseFullComposerCallback(isDiscard);}else{this.thread?.fetchNewMessages();}}
onInput(ev){if(!this.props.composer.isDirty){this.props.composer.isDirty=true;}}
onPaste(ev){if(!this.allowUpload){return;}
if(!ev.clipboardData?.items){return;}
if(ev.clipboardData.files.length===0){return;}
ev.preventDefault();for(const file of ev.clipboardData.files){this.attachmentUploader.uploadFile(file);}}
onKeydown(ev){const composer=toRaw(this.props.composer);switch(ev.key){case"ArrowUp":if(!this.env.inChatter&&composer.composerText===""&&composer.thread){const messageToEdit=composer.thread.lastEditableMessageOfSelf;if(messageToEdit){messageToEdit.enterEditMode(this.props.composer.thread);}}
break;case"Enter":{if(isEventHandled(ev,"NavigableList.select")||!this.state.active){ev.preventDefault();return;}
if(this.isMobileOS||ev.isComposing){return;}
const shouldPost=this.env.inChatter?ev.ctrlKey:!ev.shiftKey;if(!shouldPost){return;}
ev.preventDefault();if(composer.message){this.editMessage();}else{this.sendMessage();}
break;}
case"Escape":if(isEventHandled(ev,"NavigableList.close")){return;}
if(this.props.onDiscardCallback){this.props.onDiscardCallback();markEventHandled(ev,"Composer.discard");}
break;}}
get fullComposerAdditionalContext(){return{};}
async onClickFullComposer(ev){const allRecipients=[...this.thread.suggestedRecipients];if(this.props.type!=="note"){allRecipients.push(...this.thread.additionalRecipients);const newPartners=allRecipients.filter((recipient)=>!recipient.partner_id);if(newPartners.length!==0){const recipientEmails=[];newPartners.forEach((recipient)=>{recipientEmails.push(recipient.email);});const partners=await rpc("/mail/partner/from_email",{thread_model:this.thread.model,thread_id:this.thread.id,emails:recipientEmails,});for(const index in partners){const partnerData=partners[index];const partner=this.store["res.partner"].insert(partnerData);const email=recipientEmails[index];const recipient=allRecipients.find((recipient)=>recipient.email===email);recipient.partner_id=partner.id;}}}
const attachmentIds=this.props.composer.attachments.map((attachment)=>attachment.id);let default_body=this.props.composer.composerHtml;if(isHtmlEmpty(default_body)){const composer=toRaw(this.props.composer);composer.emailAddSignature=true;}
let signature=this.thread.effectiveSelf.main_user_id?.signature;if(signature){const divElement=document.createElement("div");divElement.setAttribute("data-o-mail-quote","1");divElement.append(document.createElement("br"),document.createTextNode("-- "),document.createElement("br"),...createElementWithContent("div",signature).childNodes);signature=markup(divElement.outerHTML);}
default_body=this.formatDefaultBodyForFullComposer(default_body,this.props.composer.emailAddSignature?signature:"");const context={default_attachment_ids:attachmentIds,default_body,default_email_add_signature:false,default_model:this.thread.model,default_partner_ids:this.props.type==="note"?[]:allRecipients.map((recipient)=>recipient.partner_id),default_res_ids:[this.thread.id],default_subtype_xmlid:this.props.type==="note"?"mail.mt_note":"mail.mt_comment",clicked_on_full_composer:true,...this.fullComposerAdditionalContext,};const action={name:this.props.type==="note"?_t("Log note"):_t("Compose Email"),type:"ir.actions.act_window",res_model:"mail.compose.message",view_mode:"form",views:[[false,"form"]],target:"new",context:context,};const options={onClose:(args)=>{const accidentalDiscard=args?.dismiss;const isDiscard=accidentalDiscard||args?.special;if(!isDiscard&&this.props.composer.thread.model==="mail.box"){this.notifySendFromMailbox();}
if(accidentalDiscard){this.fullComposerBus.trigger("ACCIDENTAL_DISCARD",{onAccidentalDiscard:(isEmpty)=>{if(!isEmpty){this.saveContent();this.restoreContent();}},});}else{this.clear();}
this.props.composer.replyToMessage=undefined;this.onCloseFullComposerCallback(isDiscard);this.state.isFullComposerOpen=false;this.fullComposerBus=new EventBus();},props:{fullComposerBus:this.fullComposerBus,},};await this.env.services.action.doAction(action,options);this.state.isFullComposerOpen=true;}
formatDefaultBodyForFullComposer(defaultBody,signature=""){if(signature){defaultBody=markup`${defaultBody}<br>${signature}`;}
return markup`<div>${defaultBody}</div>`;}
clear(){this.props.composer.clear();browser.localStorage.removeItem(this.props.composer.localId);}
notifySendFromMailbox(){this.env.services.notification.add(_t('Message posted on "%s"',this.thread.displayName),{type:"info",});}
isEventTrusted(ev){return ev.isTrusted;}
async processMessage(cb){if(this.props.composer.attachments.some(({uploading})=>uploading)){this.env.services.notification.add(_t("Please wait while the file is uploading."),{type:"warning",});}else if(this.canProcessMessage){if(!this.state.active){return;}
this.state.active=false;await cb(this.props.composer.composerHtml);if(this.props.onPostCallback){this.props.onPostCallback();}
this.clear();this.state.active=true;this.ref.el?.focus();}}
get canProcessMessage(){return(!isHtmlEmpty(this.props.composer.composerHtml)||this.props.composer.attachments.length>0||(this.message&&this.message.attachment_ids.length>0));}
async sendMessage(){const composer=toRaw(this.props.composer);this.composerActions.activePicker?.close?.();if(composer.message){this.editMessage();return;}
if(this.props.type!=="note"){const allRecipients=[...composer.thread.suggestedRecipients,...composer.thread.additionalRecipients,];if(allRecipients.some((recipient)=>!recipient.email||!isEmail(recipient.email))){return;}}
await this.processMessage(async(value)=>{await this._sendMessage(value,this.postData,this.extraData);});}
get postData(){const composer=toRaw(this.props.composer);return{attachments:composer.attachments||[],emailAddSignature:composer.emailAddSignature,isNote:this.props.type==="note",mentionedChannels:composer.mentionedChannels||[],mentionedPartners:composer.mentionedPartners||[],mentionedRoles:composer.mentionedRoles||[],cannedResponseIds:composer.cannedResponses.map((c)=>c.id),parentId:this.props.composer.replyToMessage?.id,};}
async _sendMessage(value,postData,extraData){const thread=toRaw(this.props.composer.thread);const postThread=toRaw(this.thread);const post=postThread.post.bind(postThread,value,postData,extraData);let message;if(postThread.model==="discuss.channel"){post();}else{message=await post();}
if(thread.model==="mail.box"){this.notifySendFromMailbox();}
this.suggestion?.clearRawMentions();this.suggestion?.clearCannedResponses();this.props.composer.replyToMessage=undefined;this.props.composer.emailAddSignature=true;this.props.composer.thread.additionalRecipients=[];return message;}
async editMessage(){const composer=toRaw(this.props.composer);if(!this.askDeleteFromEdit){await this.processMessage(async(value)=>composer.message.edit(value,composer.attachments,{mentionedChannels:composer.mentionedChannels,mentionedPartners:composer.mentionedPartners,mentionedRoles:composer.mentionedRoles,}));}else{this.env.services.dialog.add(MessageConfirmDialog,{message:composer.message,onConfirm:()=>this.message.remove({removeFromThread:this.shouldHideFromMessageListOnDelete,}),prompt:_t("Are you sure you want to bid farewell to this message forever?"),},{context:this});}
this.suggestion?.clearRawMentions();}
get askDeleteFromEdit(){const composer=toRaw(this.props.composer);return!composer.composerText&&composer.message.attachment_ids.length===0;}
onClickInsertCannedResponse(ev){markEventHandled(ev,"composer.clickInsertCannedResponse");const composer=toRaw(this.props.composer);if(this.editor){if(!isHtmlEmpty(this.props.composer.composerHtml)){this.editor.shared.dom.insert(" ");}
this.editor.shared.dom.insert("::");this.editor.shared.history.addStep();}else{const composerText=composer.composerText;const firstPart=composerText.slice(0,composer.selection.start);const secondPart=composerText.slice(composer.selection.end,composerText.length);const toInsertPart=firstPart.length===0||firstPart.at(-1)===" "?"::":" ::";composer.composerText=firstPart+toInsertPart+secondPart;this.selection.moveCursor((firstPart+toInsertPart).length);}
if(!this.ui.isSmall||!this.env.inChatter){composer.autofocus++;}}
onChangeWysiwygContent(){this.updateFromEditor=true;this.props.composer.composerHtml=markup(this.editor.getContent());if(!this.props.composer.isDirty){this.props.composer.isDirty=true;}
this.updateFromEditor=false;}
onLoadWysiwyg(editor){this.editor=editor;}
addEmoji(str){const composer=toRaw(this.props.composer);if(this.editor){this.editor.shared.dom.insert(str);this.editor.shared.history.addStep();}else{const composerText=composer.composerText;const firstPart=composerText.slice(0,composer.selection.start);const secondPart=composerText.slice(composer.selection.end,composerText.length);composer.composerText=firstPart+str+secondPart;this.selection.moveCursor((firstPart+str).length);}
if(this.ui.isSmall&&!this.env.inChatter){return false;}else{composer.autofocus++;}}
onFocusin(){const composer=toRaw(this.props.composer);composer.isFocused=true;if(composer.thread?.scrollTop==="bottom"&&!composer.thread.scrollUnread&&!composer.thread.markedAsUnread){composer.thread?.markAsRead();}}
onFocusout(ev){if([EDIT_CLICK_TYPE.CANCEL,EDIT_CLICK_TYPE.SAVE].includes(ev.relatedTarget?.dataset?.type)){return;}
this.props.composer.isFocused=false;}
saveContent(){const composer=toRaw(this.props.composer);const saveContentToLocalStorage=({composerHtml,emailAddSignature,replyToMessageId,})=>{browser.localStorage.setItem(composer.localId,JSON.stringify({emailAddSignature,replyToMessageId,composerHtml:isMarkup(composerHtml)?["markup",composerHtml]:composerHtml,}));};if(this.state.isFullComposerOpen){this.fullComposerBus.trigger("SAVE_CONTENT",{onSaveContent:saveContentToLocalStorage,});}else{saveContentToLocalStorage({composerHtml:composer.composerHtml,emailAddSignature:true,replyToMessageId:composer.replyToMessage?.id,});}}
restoreContent(){const composer=toRaw(this.props.composer);let config;try{config=JSON.parse(browser.localStorage.getItem(composer.localId));}catch{browser.localStorage.removeItem(composer.localId);}
if(!config){return;}
if(!isHtmlEmpty(config.composerHtml)){composer.emailAddSignature=config.emailAddSignature;composer.composerHtml=config.composerHtml;}
if(Number.isInteger(config.replyToMessageId)){composer.replyToMessage=this.store["mail.message"].insert(config.replyToMessageId);}}
get shouldHideFromMessageListOnDelete(){return false;}}
return __exports;});;

/* /mail/static/src/core/common/composer_actions.js */
odoo.define('@mail/core/common/composer_actions',['@odoo/owl','@web/core/emoji_picker/emoji_picker','@web/core/l10n/translation','@web/core/registry','@web/core/utils/misc','@mail/core/common/action','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{toRaw,useComponent,useEffect,useRef,useState}=require("@odoo/owl");const{useEmojiPicker}=require("@web/core/emoji_picker/emoji_picker");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{registry}=require("@web/core/registry");const{markEventHandled}=require("@web/core/utils/misc");const{Action,UseActions}=require("@mail/core/common/action");const{useService}=require("@web/core/utils/hooks");const composerActionsRegistry=__exports.composerActionsRegistry=registry.category("mail.composer/actions");__exports.registerComposerAction=registerComposerAction;function registerComposerAction(id,definition){composerActionsRegistry.add(id,definition);}
__exports.pickerOnClick=pickerOnClick;function pickerOnClick(component,action,ev){let anchorEl;if(component.ui.isSmall){anchorEl=component.pickerTargetRef.el;}else if(!anchorEl){if(action.sequenceQuick){anchorEl=component.quickActionsRef.el;}else{anchorEl=component.moreActionsRef.el??component.extraActionsRef.el;}}
const previousPicker=component.getActivePicker();previousPicker?.close();if(toRaw(previousPicker)===toRaw(action.picker)){component.setActivePicker(null);}else{component.setActivePicker(action.picker);component.getActivePicker().open({el:anchorEl});}}
__exports.pickerSetup=pickerSetup;function pickerSetup(action,func){const component=useComponent();component.pickerTargetRef=useRef("picker-target");component.quickActionsRef=useRef("quick-actions");component.moreActionsRef=useRef("more-actions");component.extraActionsRef=useRef("extra-actions");action.ref=useRef(action.id);action.picker=func();}
registerComposerAction("send-message",{btnClass:({action})=>(action.isActive?"o-sendMessageActive o-text-white shadow-sm":""),condition:({composer,owner,store})=>(store.env.isSmall&&composer.message)||(!owner.env.inChatter&&!composer.message),disabledCondition:({owner})=>owner.isSendButtonDisabled,icon:"fa fa-paper-plane-o",isActive:({owner})=>owner.sendMessageState.active,name:({composer,owner})=>composer.message?_t("Save editing"):composer.targetThread?.model==="discuss.channel"?_t("Send"):owner.props.type==="note"?_t("Log"):_t("Send"),onSelected:({owner})=>owner.sendMessage(),setup:({owner})=>{owner.sendMessageState=useState({active:false});useEffect(()=>{owner.sendMessageState.active=!owner.isSendButtonDisabled;},()=>[owner.isSendButtonDisabled]);},sequenceQuick:30,});registerComposerAction("add-emoji",{icon:"fa fa-smile-o",isPicker:true,pickerName:_t("Emoji"),name:_t("Add Emojis"),onSelected({owner},ev){pickerOnClick(owner,this,ev);markEventHandled(ev,"Composer.onClickAddEmoji");},setup({owner}){pickerSetup(this,()=>useEmojiPicker(undefined,{onSelect:(emoji)=>owner.addEmoji(emoji),onClose:()=>owner.setActivePicker(null),},{arrow:false}));},sequenceQuick:20,});registerComposerAction("upload-files",{condition:({owner})=>owner.allowUpload,icon:"fa fa-paperclip",name:_t("Attach Files"),onSelected:({composer:comp,owner},ev)=>{owner.fileUploaderRef.el?.click();const composer=toRaw(comp);markEventHandled(ev,"composer.clickOnAddAttachment");composer.autofocus++;},setup:({owner})=>(owner.fileUploaderRef=useRef("file-uploader")),sequence:20,});registerComposerAction("open-full-composer",{condition:({composer,owner})=>!composer.message&&owner.props.showFullComposer&&composer.targetThread&&composer.targetThread.model!=="discuss.channel"&&!owner.env.inFrontendPortalChatter,hotkey:"shift+c",icon:"fa fa-expand",name:_t("Open Full Composer"),onSelected:({owner})=>owner.onClickFullComposer(),sequence:30,});registerComposerAction("add-canned-response",{condition:({composer,store})=>store.hasCannedResponses&&composer.targetThread&&store.env.services["mail.suggestion"].getSupportedDelimiters(composer.targetThread).find(([delimiter])=>delimiter==="::"),icon:"fa fa-file-text-o",name:_t("Insert a Canned response"),onSelected:({owner},ev)=>owner.onClickInsertCannedResponse(ev),sequence:5,});const ComposerAction=__exports.ComposerAction=class ComposerAction extends Action{composerFn;constructor({composer}){super(...arguments);this.composerFn=typeof composer==="function"?composer:()=>composer;}
get params(){return Object.assign(super.params,{composer:this.composerFn()});}
get isPicker(){return this.definition.isPicker;}
get pickerName(){return typeof this.definition.pickerName==="function"?this.definition.pickerName(this._component):this.definition.pickerName;}}
class UseComposerActions extends UseActions{get partition(){const res=super.partition;const actions=this.transformedActions.filter((action)=>action.condition);const groupedPickers=Object.groupBy(actions.filter((a)=>a.isPicker),(a)=>(a.sequenceQuick?"quick":"other"));groupedPickers.quick?.sort((a1,a2)=>a1.sequenceQuick-a2.sequenceQuick);groupedPickers.other?.sort((a1,a2)=>a1.sequence-a2.sequence);const pickers=(groupedPickers.other??[]).concat(groupedPickers.quick??[]);return Object.assign(res,{pickers});}}
__exports.useComposerActions=useComposerActions;function useComposerActions({composer}={}){const component=useComponent();const transformedActions=composerActionsRegistry.getEntries().map(([id,definition])=>new ComposerAction({owner:component,id,definition,composer}));for(const action of transformedActions){action.setup();}
const state=useState(new UseComposerActions(component,transformedActions,useService("mail.store")));component.getActivePicker=()=>state.activePicker;component.setActivePicker=(newActivePicker)=>(state.activePicker=newActivePicker);return state;}
return __exports;});;

/* /mail/static/src/core/common/composer_model.js */
odoo.define('@mail/core/common/composer_model',['@mail/core/common/record','@mail/utils/common/format','@odoo/owl','@web/core/utils/html'],function(require){'use strict';let __exports={};const{fields,OR,Record}=require("@mail/core/common/record");const{convertBrToLineBreak,getNonEditableMentions,prettifyMessageText,}=require("@mail/utils/common/format");const{markup}=require("@odoo/owl");const{isHtmlEmpty}=require("@web/core/utils/html");const Composer=__exports.Composer=class Composer extends Record{static id=OR("thread","message");clear(){this.attachments.length=0;this.replyToMessage=undefined;this.composerHtml=markup("<div class='o-paragraph'><br></div>");Object.assign(this.selection,{start:0,end:0,direction:"none",});}
insertText(text,position,{moveCursorToEnd=false}={}){const before=this.composerText.substring(0,position);const after=this.composerText.substring(position);this.composerText=before+text+after;this.selection.start=before.length+text.length;if(moveCursorToEnd){this.selection.start=this.composerText.length;}
this.selection.end=this.selection.start;this.forceCursorMove=true;}
attachments=fields.Many("ir.attachment");emailAddSignature=true;message=fields.One("mail.message");mentionedPartners=fields.Many("res.partner");mentionedRoles=fields.Many("res.role");mentionedChannels=fields.Many("Thread");cannedResponses=fields.Many("mail.canned.response");isDirty=false;composerText=fields.Attr("",{onUpdate(){if(this.updateFrom==="html"){this.updateFrom=undefined;return;}
const validMentions=this.store.getMentionsFromText(this.composerText,{mentionedChannels:this.mentionedChannels,mentionedPartners:this.mentionedPartners,mentionedRoles:this.mentionedRoles,thread:this.targetThread,});const prettifiedHtml=prettifyMessageText(this.composerText,{validMentions,thread:this.targetThread,});if(this.composerHtml.toString()!==prettifiedHtml.toString()){this.updateFrom="text";this.composerHtml=prettifiedHtml;}},});composerHtml=fields.Html(markup("<div class='o-paragraph'><br></div>"),{compute(){if(this.syncHtmlWithMessage){return(getNonEditableMentions(this.message.body)||markup("<div class='o-paragraph'><br></div>"));}
return this.composerHtml;},onUpdate(){if(this.updateFrom==="text"){this.updateFrom=undefined;return;}
const prettifiedText=isHtmlEmpty(this.composerHtml)?"":convertBrToLineBreak(this.composerHtml);if(this.composerText!==prettifiedText){this.updateFrom="html";this.composerText=prettifiedText;}},});thread=fields.One("Thread");selection={start:0,end:0,direction:"none",};forceCursorMove;isFocused=fields.Attr(false,{onUpdate(){if(this.thread){if(this.isFocused){this.thread.isFocusedCounter++;}else{this.thread.isFocusedCounter--;}}},});autofocus=0;replyToMessage=fields.One("mail.message",{inverse:"composerAsReplyToMessage"});updateFrom=undefined;get syncHtmlWithMessage(){return this.message&&!this.isDirty;}
get targetThread(){return this.replyToMessage?.thread??this.thread??this.message?.thread??null;}}
Composer.register();return __exports;});;

/* /mail/static/src/core/common/composer_service.js */
odoo.define('@mail/core/common/composer_service',['@odoo/owl','@web/core/registry'],function(require){'use strict';let __exports={};const{reactive}=require("@odoo/owl");const{registry}=require("@web/core/registry");const composerService=__exports.composerService={dependencies:["mail.store","legacy_multi_tab"],start(env,{legacy_multi_tab}){const state=reactive({htmlEnabled:legacy_multi_tab.getSharedValue("mail.html_composer.enabled",false),setHtmlComposer(){if(state.htmlEnabled){return;}
state.htmlEnabled=true;legacy_multi_tab.setSharedValue("mail.html_composer.enabled",true);},setTextComposer(){if(!state.htmlEnabled){return;}
state.htmlEnabled=false;legacy_multi_tab.setSharedValue("mail.html_composer.enabled",false);},});legacy_multi_tab.bus.addEventListener("shared_value_updated",({detail})=>{if(detail.key==="mail.html_composer.enabled"){state.htmlEnabled=JSON.parse(detail.newValue);}});return state;},};registry.category("services").add("mail.composer",composerService);return __exports;});;

/* /mail/static/src/core/common/country_flag.js */
odoo.define('@mail/core/common/country_flag',['@odoo/owl'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const CountryFlag=__exports.CountryFlag=class CountryFlag extends Component{static props=["country","class?"];static template="mail.CountryFlag";}
return __exports;});;

/* /mail/static/src/core/common/country_model.js */
odoo.define('@mail/core/common/country_model',['@mail/core/common/record'],function(require){'use strict';let __exports={};const{Record}=require("@mail/core/common/record");const Country=__exports.Country=class Country extends Record{static id="id";static _name="res.country";code;id;name;get flagUrl(){if(!this.code){return false;}
return`/base/static/img/country_flags/${encodeURIComponent(this.code.toLowerCase())}.png`;}}
Country.register();return __exports;});;

/* /mail/static/src/core/common/data_response_model.js */
odoo.define('@mail/core/common/data_response_model',['@mail/core/common/record','@web/core/utils/concurrency'],function(require){'use strict';let __exports={};const{fields,Record}=require("@mail/core/common/record");const{Deferred}=require("@web/core/utils/concurrency");const DataResponse=__exports.DataResponse=class DataResponse extends Record{static id="id";static _lastId=0;static createRequest(){return this.insert({id:++this._lastId});}
id;_autoResolve=false;_resultDef=new Deferred();_resolve=fields.Attr(undefined,{onUpdate(){if(this._resolve){this._resultDef.resolve({...this});this.delete();}},});attachments=fields.Many("ir.attachment");channel=fields.One("Thread");channels=fields.Many("Thread");count;message=fields.One("mail.message");partners=fields.Many("res.partner");}
DataResponse.register();return __exports;});;

/* /mail/static/src/core/common/date_section.js */
odoo.define('@mail/core/common/date_section',['@odoo/owl','@web/core/browser/feature_detection'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const{isMobileOS}=require("@web/core/browser/feature_detection");const DateSection=__exports.DateSection=class DateSection extends Component{static template="mail.DateSection";static props=["date","className?"];get isMobileOS(){return isMobileOS();}}
return __exports;});;

/* /mail/static/src/core/common/discuss_call_history_model.js */
odoo.define('@mail/core/common/discuss_call_history_model',['@mail/core/common/record'],function(require){'use strict';let __exports={};const{fields,Record}=require("@mail/core/common/record");const DiscussCallHistory=__exports.DiscussCallHistory=class DiscussCallHistory extends Record{static id="id";static _name="discuss.call.history";id;end_dt=fields.Datetime();duration_hour;}
DiscussCallHistory.register();return __exports;});;

/* /mail/static/src/core/common/discuss_component_registry.js */
odoo.define('@mail/core/common/discuss_component_registry',['@web/core/registry'],function(require){'use strict';let __exports={};const{registry}=require("@web/core/registry");const discussComponentRegistry=__exports.discussComponentRegistry=registry.category("discuss.component");return __exports;});;

/* /mail/static/src/core/common/failure_model.js */
odoo.define('@mail/core/common/failure_model',['@mail/core/common/record','@odoo/owl','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{fields,Record}=require("@mail/core/common/record");const{markRaw}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const Failure=__exports.Failure=class Failure extends Record{static nextId=markRaw({value:1});static id="id";notifications=fields.Many("mail.notification",{onUpdate(){if(this.notifications.length===0){this.delete();}else{this.store.failures.add(this);}},});get modelName(){return this.notifications?.[0]?.mail_message_id?.thread?.modelName;}
get resModel(){return this.notifications?.[0]?.mail_message_id?.thread?.model;}
get resIds(){return new Set([...this.notifications.map((notif)=>notif.mail_message_id?.thread?.id).filter((id)=>!!id),]);}
lastMessage=fields.One("mail.message",{compute(){let lastMsg=this.notifications[0]?.mail_message_id;for(const notification of this.notifications){if(lastMsg?.id<notification.mail_message_id?.id){lastMsg=notification.mail_message_id;}}
return lastMsg;},});get type(){return this.notifications?.[0]?.notification_type;}
get status(){return this.notifications?.[0]?.notification_status;}
get iconSrc(){return"/mail/static/src/img/smiley/mailfailure.svg";}
get body(){if(this.notifications.length===1&&this.lastMessage?.thread){return _t("An error occurred when sending an email on %(record_name)s",{record_name:this.lastMessage.thread.display_name,});}
return _t("An error occurred when sending an email");}
get datetime(){return this.lastMessage?.datetime;}}
Failure.register();return __exports;});;

/* /mail/static/src/core/common/follower_model.js */
odoo.define('@mail/core/common/follower_model',['@mail/core/common/record','@web/core/network/rpc','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{fields,Record}=require("@mail/core/common/record");const{rpc}=require("@web/core/network/rpc");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const Follower=__exports.Follower=class Follower extends Record{static _name="mail.followers";static id="id";thread=fields.One("Thread");id;is_active;partner_id=fields.One("res.partner");subtype_ids=fields.Many("mail.message.subtype");get displayName(){return this.partner_id.name||this.display_name||_t("Unnamed");}
get isEditable(){const hasWriteAccess=this.thread?this.thread.hasWriteAccess:false;return this.partner_id.eq(this.store.self_partner)?this.thread.hasReadAccess:hasWriteAccess;}
async remove(){const data=await rpc("/mail/thread/unsubscribe",{res_model:this.thread.model,res_id:this.thread.id,partner_ids:[this.partner_id.id],});this.store.insert(data);}
removeRecipient(){this.thread.recipients.delete(this);}}
Follower.register();return __exports;});;

/* /mail/static/src/core/common/gif.js */
odoo.define('@mail/core/common/gif',['@odoo/owl','@web/core/utils/concurrency','@web/core/utils/functions'],function(require){'use strict';let __exports={};const{Component,useState}=require("@odoo/owl");const{Deferred,KeepLast}=require("@web/core/utils/concurrency");const{memoize}=require("@web/core/utils/functions");const Gif=__exports.Gif=class Gif extends Component{static template="mail.Gif";static props={src:String,alt:{type:String,optional:true},class:{type:String,optional:true},loading:{type:String,optional:true},onLoad:{type:Function,optional:true},onClick:{type:Function,optional:true},paused:{type:Boolean,optional:true},style:{type:String,optional:true},};static components={};generateGifSnapshot=memoize(async(src)=>{const deferred=new Deferred();const image=document.createElement("img");if(new URL(src).origin!==location.origin){image.crossOrigin="anonymous";}
image.src=src;image.onload=()=>{const canvas=document.createElement("canvas");canvas.width=image.width;canvas.height=image.height;canvas.getContext("2d").drawImage(image,0,0,image.width,image.height);deferred.resolve(canvas.toDataURL("image/gif"));};return deferred;});setup(){this.state=useState({snapshot:null});this.keepLast=new KeepLast();}
onLoad(){this.props.onLoad?.(...arguments);this.keepLast.add(this.generateGifSnapshot(this.props.src)).then((snapshot)=>(this.state.snapshot=snapshot));}}
return __exports;});;

/* /mail/static/src/core/common/im_status.js */
odoo.define('@mail/core/common/im_status',['@odoo/owl','@mail/discuss/typing/common/typing'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const{Typing}=require("@mail/discuss/typing/common/typing");const ImStatus=__exports.ImStatus=class ImStatus extends Component{static props=["persona?","className?","style?","member?","slots?","size?"];static template="mail.ImStatus";static defaultProps={className:"",style:"",size:"lg"};static components={Typing};get persona(){return this.props.persona??this.props.member?.persona;}}
return __exports;});;

/* /mail/static/src/core/common/im_status_dropdown.js */
odoo.define('@mail/core/common/im_status_dropdown',['@odoo/owl','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_item','@mail/core/common/im_status','@web/core/l10n/translation','@web/core/registry','@web/core/utils/hooks','@web/core/network/rpc'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const{Dropdown}=require("@web/core/dropdown/dropdown");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{ImStatus}=require("@mail/core/common/im_status");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{registry}=require("@web/core/registry");const{useService}=require("@web/core/utils/hooks");const{rpc}=require("@web/core/network/rpc");const ImStatusDropdown=__exports.ImStatusDropdown=class ImStatusDropdown extends Component{static components={Dropdown,DropdownItem,ImStatus};static props=[];static template="mail.ImStatusDropdown";setup(){this.store=useService("mail.store");this.readableImStatusByCode={online:_t("Online"),away:_t("Away"),busy:_t("Do Not Disturb"),offline:_t("Offline"),};}
setManualImStatus(status){rpc("/mail/set_manual_im_status",{status});}
get readableImStatus(){const imStatus=this.store.self.im_status||"offline";for(const status in this.readableImStatusByCode){if(imStatus.includes(status)){return this.readableImStatusByCode[status];}}
return _t("Unknown Status");}}
__exports.imStatusItem=imStatusItem;function imStatusItem(env){return{type:"component",contentComponent:ImStatusDropdown,sequence:45,};}
registry.category("user_menuitems").add("im_status",imStatusItem);return __exports;});;

/* /mail/static/src/core/common/im_status_service.js */
odoo.define('@mail/core/common/im_status_service',['@web/core/browser/browser','@web/core/registry'],function(require){'use strict';let __exports={};const{browser}=require("@web/core/browser/browser");const{registry}=require("@web/core/registry");const AWAY_DELAY=__exports.AWAY_DELAY=30*60*1000;const imStatusService=__exports.imStatusService={dependencies:["bus_service","presence"],start(env,{bus_service,presence}){let lastSentInactivity;let becomeAwayTimeout;const updateBusPresence=()=>{lastSentInactivity=presence.getInactivityPeriod();startAwayTimeout();bus_service.send("update_presence",{inactivity_period:lastSentInactivity});};const startAwayTimeout=()=>{clearTimeout(becomeAwayTimeout);const awayTime=AWAY_DELAY-presence.getInactivityPeriod();if(awayTime>0){becomeAwayTimeout=browser.setTimeout(()=>updateBusPresence(),awayTime);}};bus_service.addEventListener("BUS:CONNECT",()=>updateBusPresence(),{once:true});bus_service.subscribe("bus.bus/im_status_updated",async({presence_status,im_status,partner_id,guest_id,debounce=true})=>{const store=env.services["mail.store"];const partner=store["res.partner"].get(partner_id);const guest=store["mail.guest"].get(guest_id);if(!partner&&!guest){return;}
if(debounce){partner?.debouncedSetImStatus(im_status);guest?.debouncedSetImStatus(im_status);}else{partner?.updateImStatus(im_status);guest?.updateImStatus(im_status);}
if(partner?.eq(store.self_partner)||guest?.eq(store.self_guest)){const isOnline=presence.getInactivityPeriod()<AWAY_DELAY;if((presence_status==="away"&&isOnline)||presence_status==="offline"){updateBusPresence();}}});presence.bus.addEventListener("presence",()=>{if(!lastSentInactivity||lastSentInactivity>=AWAY_DELAY){updateBusPresence();}
startAwayTimeout();});return{updateBusPresence};},};registry.category("services").add("im_status",imStatusService);return __exports;});;

/* /mail/static/src/core/common/link_preview.js */
odoo.define('@mail/core/common/link_preview',['@mail/core/common/gif','@mail/core/common/link_preview_confirm_delete','@odoo/owl','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Gif}=require("@mail/core/common/gif");const{LinkPreviewConfirmDelete}=require("@mail/core/common/link_preview_confirm_delete");const{Component,useEffect,useRef,useState}=require("@odoo/owl");const{useService}=require("@web/core/utils/hooks");const LinkPreview=__exports.LinkPreview=class LinkPreview extends Component{static template="mail.LinkPreview";static props=["linkPreview","delete?","deleteAll?","gifPaused?","message?"];static components={Gif};setup(){super.setup();this.dialogService=useService("dialog");this.state=useState({startVideo:false,videoLoaded:false});this.videoRef=useRef("video");useEffect((el)=>{if(el){el.onload=()=>(this.state.videoLoaded=true);}},()=>[this.videoRef.el]);}
onClick(){this.dialogService.add(LinkPreviewConfirmDelete,{linkPreview:this.props.linkPreview,delete:this.props.delete,deleteAll:this.props.deleteAll,LinkPreview,});}
onImageLoaded(){this.env.onImageLoaded?.();}}
return __exports;});;

/* /mail/static/src/core/common/link_preview_confirm_delete.js */
odoo.define('@mail/core/common/link_preview_confirm_delete',['@odoo/owl','@web/core/dialog/dialog','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const{Dialog}=require("@web/core/dialog/dialog");const{useService}=require("@web/core/utils/hooks");const LinkPreviewConfirmDelete=__exports.LinkPreviewConfirmDelete=class LinkPreviewConfirmDelete extends Component{static components={Dialog};static props=["linkPreview","delete","deleteAll?","close","LinkPreview"];static template="mail.LinkPreviewConfirmDelete";setup(){super.setup();this.store=useService("mail.store");}
get message(){return this.props.linkPreview.message_id;}
onClickOk(){this.props.delete();this.props.close();}
onClickDeleteAll(){this.props.deleteAll?.();this.props.close();}
onClickCancel(){this.props.close();}}
return __exports;});;

/* /mail/static/src/core/common/link_preview_model.js */
odoo.define('@mail/core/common/link_preview_model',['@mail/core/common/record','@mail/utils/common/misc'],function(require){'use strict';let __exports={};const{fields,Record}=require("@mail/core/common/record");const{convertToEmbedURL}=require("@mail/utils/common/misc");const VIDEO_EXTENSIONS=new Set(["mp4","mov","avi","mkv","webm","mpeg","mpg","ogv","3gp"]);const LinkPreview=__exports.LinkPreview=class LinkPreview extends Record{static _name="mail.link.preview";static id="id";id;message_link_preview_ids=fields.Many("mail.message.link.preview",{inverse:"link_preview_id",});image_mimetype;og_description;og_image;og_mimetype;og_title;og_type;og_site_name;source_url;get isGif(){return[this.og_mimetype,this.image_mimetype].includes("image/gif");}
get imageUrl(){return this.og_image?this.og_image:this.source_url;}
get isImage(){return Boolean(this.image_mimetype||this.og_mimetype==="image/gif");}
get isVideo(){let fileExt;if(this.og_title){fileExt=this.og_title.split(".").pop();}
return(VIDEO_EXTENSIONS.has(fileExt)||Boolean(!this.isImage&&this.og_type&&this.og_type.startsWith("video")));}
get isCard(){return!this.isImage&&!this.isVideo;}
get videoURL(){const{url}=convertToEmbedURL(this.source_url);return url;}
get videoProvider(){const{provider}=convertToEmbedURL(this.source_url);return provider;}}
LinkPreview.register();return __exports;});;

/* /mail/static/src/core/common/mail_activity_type_model.js */
odoo.define('@mail/core/common/mail_activity_type_model',['@mail/core/common/record'],function(require){'use strict';let __exports={};const{Record}=require("@mail/core/common/record");const MailActivityType=__exports.MailActivityType=class MailActivityType extends Record{static _name="mail.activity.type";static id="id";id;name;}
MailActivityType.register();return __exports;});;

/* /mail/static/src/core/common/mail_attachment_dropzone.js */
odoo.define('@mail/core/common/mail_attachment_dropzone',['@odoo/owl','@web/core/dropzone/dropzone'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const{Dropzone}=require("@web/core/dropzone/dropzone");const MailAttachmentDropzone=__exports.MailAttachmentDropzone=class MailAttachmentDropzone extends Component{static template="mail.MailAttachmentDropzone";static components={Dropzone};static props=Dropzone.props;}
return __exports;});;

/* /mail/static/src/core/common/mail_core_common_service.js */
odoo.define('@mail/core/common/mail_core_common_service',['@odoo/owl','@web/core/registry'],function(require){'use strict';let __exports={};const{reactive}=require("@odoo/owl");const{registry}=require("@web/core/registry");const MailCoreCommon=__exports.MailCoreCommon=class MailCoreCommon{constructor(env,services){this.env=env;this.busService=services.bus_service;this.store=services["mail.store"];}
setup(){this.busService.subscribe("ir.attachment/delete",(payload)=>{const{id:attachmentId,message:messageData}=payload;if(messageData){this.store["mail.message"].insert(messageData);}
const attachment=this.store["ir.attachment"].get(attachmentId);attachment?.delete();});this.busService.subscribe("mail.message/delete",(payload,{id:notifId})=>{for(const messageId of payload.message_ids){const message=this.store["mail.message"].get(messageId);if(!message){continue;}
this.env.bus.trigger("mail.message/delete",{message,notifId});message.delete();}});this.busService.subscribe("mail.message/toggle_star",(payload,metadata)=>this._handleNotificationToggleStar(payload,metadata));this.busService.subscribe("res.users.settings",(payload)=>{if(payload){this.store.settings.update(payload);}});this.busService.subscribe("mail.record/insert",(payload)=>{this.store.insert(payload);});}
_handleNotificationToggleStar(payload,metadata){const{message_ids:messageIds,starred}=payload;this.store["mail.message"].insert(messageIds.map((id)=>({id,starred})));}}
const mailCoreCommon=__exports.mailCoreCommon={dependencies:["bus_service","mail.store"],start(env,services){const mailCoreCommon=reactive(new MailCoreCommon(env,services));mailCoreCommon.setup();return mailCoreCommon;},};registry.category("services").add("mail.core.common",mailCoreCommon);return __exports;});;

/* /mail/static/src/core/common/mail_fullscreen.js */
odoo.define('@mail/core/common/mail_fullscreen',['@odoo/owl','@web/core/utils/hooks','@web/core/registry'],function(require){'use strict';let __exports={};const{Component,reactive}=require("@odoo/owl");const{useService}=require("@web/core/utils/hooks");const{registry}=require("@web/core/registry");const DEFAULT_ID=Symbol("default");const MailFullscreen=__exports.MailFullscreen=class MailFullscreen extends Component{static props=["component","props?"];static template="mail.Fullscreen";setup(){super.setup();this.fullscreen=useService("mail.fullscreen");}}
const fullscreenService=__exports.fullscreenService={start(env){const state=reactive({enter,exit,id:undefined,closeOverlay:undefined});async function exit(id=state.id){if(!id||id!==state.id){return;}
state.closeOverlay?.();state.id=undefined;state.closeOverlay=undefined;const fullscreenElement=document.webkitFullscreenElement||document.fullscreenElement;if(fullscreenElement){if(document.exitFullscreen){await document.exitFullscreen();}else if(document.mozCancelFullScreen){await document.mozCancelFullScreen();}else if(document.webkitCancelFullScreen){await document.webkitCancelFullScreen();}}}
async function enter(component,{keepBrowserHeader=false,props,rootId,id=DEFAULT_ID}={}){state.closeOverlay?.();state.id=id;state.closeOverlay=env.services.overlay.add(MailFullscreen,{component,props},{rootId});const el=document.body;if(keepBrowserHeader){return;}
try{if(el.requestFullscreen){await el.requestFullscreen();}else if(el.mozRequestFullScreen){await el.mozRequestFullScreen();}else if(el.webkitRequestFullscreen){await el.webkitRequestFullscreen();}}catch{}}
window.addEventListener("fullscreenchange",()=>{const isFullscreen=Boolean(document.webkitFullscreenElement||document.fullscreenElement);if(!isFullscreen){state.exit();}});return state;},};registry.category("services").add("mail.fullscreen",fullscreenService);return __exports;});;

/* /mail/static/src/core/common/mail_guest_model.js */
odoo.define('@mail/core/common/mail_guest_model',['@mail/core/common/record','@web/core/utils/urls','@web/core/network/rpc','@web/core/utils/timing','@mail/core/common/store_service'],function(require){'use strict';let __exports={};const{fields,Record}=require("@mail/core/common/record");const{imageUrl}=require("@web/core/utils/urls");const{rpc}=require("@web/core/network/rpc");const{debounce}=require("@web/core/utils/timing");const{Store}=require("@mail/core/common/store_service");const TRANSPARENT_AVATAR="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAQAAABpN6lAAAAAqElEQVR42u3QMQEAAAwCoNm/9GJ4CBHIjYsAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBDQ9+KgAIHd5IbMAAAAAElFTkSuQmCC";const{DateTime}=luxon;const MailGuest=__exports.MailGuest=class MailGuest extends Record{static id="id";static _name="mail.guest";static new(){const record=super.new(...arguments);record.debouncedSetImStatus=debounce((newStatus)=>record.updateImStatus(newStatus),Store.IM_STATUS_DEBOUNCE_DELAY);return record;}
avatar_128_access_token;id;debouncedSetImStatus;monitorPresence=fields.Attr(false,{compute(){return this.store.env.services.bus_service.isActive&&this.id>0;},});_triggerPresenceSubscription=fields.Attr(null,{compute(){return this.monitorPresence&&this.presenceChannel;},onUpdate(){if(this.previousPresencechannel){this.store.env.services.bus_service.deleteChannel(this.previousPresencechannel);}
if(this._triggerPresenceSubscription){this.store.env.services.bus_service.addChannel(this.presenceChannel);}
this.previousPresencechannel=this.presenceChannel;},eager:true,});name;country_id=fields.One("res.country");email;im_status=fields.Attr(null,{onUpdate(){if(this.eq(this.store.self_guest)&&this.im_status==="offline"&&this.id<0){this.store.env.services.im_status.updateBusPresence();}},});im_status_access_token;offline_since=fields.Datetime();previousPresencechannel;presenceChannel=fields.Attr(null,{compute(){const channel=`odoo-presence-mail.guest_${this.id}`;if(this.im_status_access_token){return`${channel}-${this.im_status_access_token}`;}
return channel;},});write_date=fields.Datetime();get avatarUrl(){const accessTokenParam={};if(this.store.self.main_user_id?.share!==false){accessTokenParam.access_token=this.avatar_128_access_token;}
if(this.id===-1){return TRANSPARENT_AVATAR;}
return imageUrl("mail.guest",this.id,"avatar_128",{...accessTokenParam,unique:this.write_date,});}
async updateGuestName(name){await rpc("/mail/guest/update_name",{guest_id:this.id,name,});}
updateImStatus(newStatus){if(newStatus==="offline"){this.offline_since=DateTime.now();}
this.im_status=newStatus;}}
MailGuest.register();return __exports;});;

/* /mail/static/src/core/common/mail_message_subtype_model.js */
odoo.define('@mail/core/common/mail_message_subtype_model',['@mail/model/record'],function(require){'use strict';let __exports={};const{Record}=require("@mail/model/record");const MailMessageSubtype=__exports.MailMessageSubtype=class MailMessageSubtype extends Record{static id="id";static _name="mail.message.subtype";description;id;name;}
MailMessageSubtype.register();return __exports;});;

/* /mail/static/src/core/common/mail_popout_service.js */
odoo.define('@mail/core/common/mail_popout_service',['@odoo/owl','@web/core/browser/browser','@web/core/l10n/translation','@web/core/registry','@web/core/templates'],function(require){'use strict';let __exports={};const{App}=require("@odoo/owl");const{browser}=require("@web/core/browser/browser");const{appTranslateFn}=require("@web/core/l10n/translation");const{registry}=require("@web/core/registry");const{getTemplate}=require("@web/core/templates");const DEFAULT_ID=Symbol("default");const mailPopoutService=__exports.mailPopoutService={async addAssets(window){},start(env){const popouts=new Map();async function reset(id,{useAlternativeAssets}={}){const popout=popouts.get(id);if(!popout){return;}
const doc=popout.externalWindow?.document;if(doc){doc.head.textContent="";if(useAlternativeAssets){await mailPopoutService.addAssets(popout.externalWindow);}else{doc.write(window.document.head.outerHTML);}
doc.body=doc.createElement("body");}
if(popout.app){popout.app.destroy();popout.app=null;}}
async function pollClosedWindow(id){while(popouts.get(id)?.externalWindow){const popout=popouts.get(id);await new Promise((r)=>setTimeout(r,1000));if(popout.externalWindow?.closed){const hooks=popout.hooks;hooks?.afterPopoutClosed?.();popout.externalWindow=null;}}}
async function pip(id,component,{props,options:{width,height,aspectRatio=16/9,useAlternativeAssets=false}={},}={}){const popout=popouts.get(id);let externalWindow=popout.externalWindow;if(!externalWindow||externalWindow.closed){const hooks=popout.hooks;hooks?.beforePopout?.();height=height||(width?width/aspectRatio:Math.min(240,window.innerHeight));width=width||height*aspectRatio;if(window.documentPictureInPicture){externalWindow=await window.documentPictureInPicture.requestWindow({width,height,});}else{externalWindow=browser.open("about:blank","_blank",`popup=yes,width=${width},height=${height}`);}
popout.externalWindow=externalWindow;pollClosedWindow(id);}
await reset(id,{useAlternativeAssets});popout.app=new App(component,{name:"Popout",env:Object.assign({},env,{pipWindow:externalWindow,}),props,getTemplate,translatableAttributes:["data-tooltip"],translateFn:appTranslateFn,});popout.app.mount(externalWindow.document.body);return externalWindow;}
function popout(id,component,props){const popout=popouts.get(id);let externalWindow=popout.externalWindow;if(!externalWindow||externalWindow.closed){const hooks=popout.hooks;hooks?.beforePopout?.();externalWindow=browser.open("about:blank","_blank","popup=yes");window.addEventListener("beforeunload",()=>{if(externalWindow&&!externalWindow.closed){externalWindow.close();}});popout.externalWindow=externalWindow;pollClosedWindow(id);}
reset(id);popout.app=new App(component,{name:"Popout",env,props,getTemplate,translatableAttributes:["data-tooltip"],translateFn:appTranslateFn,});popout.app.mount(externalWindow.document.body);return externalWindow;}
function getExternalWindow(id){const externalWindow=popouts.get(id)?.externalWindow;return externalWindow&&!externalWindow.closed?externalWindow:null;}
function addHooks(id,hooks){const popout=popouts.get(id);popout.hooks=hooks;}
function createManager(id=DEFAULT_ID){popouts.set(id,{externalWindow:null,hooks:{},});return{addHooks(beforePopout=()=>{},afterPopoutClosed=()=>{}){addHooks(id,{beforePopout,afterPopoutClosed});},async pip(component,props){return pip(id,component,props);},popout(component,props){return popout(id,component,props);},reset(){reset(id);},get externalWindow(){return getExternalWindow(id);},get id(){return id;},};}
return Object.assign(createManager(),{createManager});},};registry.category("services").add("mail.popout",mailPopoutService);return __exports;});;

/* /mail/static/src/core/common/mail_template_model.js */
odoo.define('@mail/core/common/mail_template_model',['@mail/model/record'],function(require){'use strict';let __exports={};const{Record}=require("@mail/model/record");const MailTemplate=__exports.MailTemplate=class MailTemplate extends Record{static id="id";static _name="mail.template";id;name;}
MailTemplate.register();return __exports;});;

/* /mail/static/src/core/common/message.js */
odoo.define('@mail/core/common/message',['@mail/core/common/attachment_list','@mail/core/common/composer','@mail/core/common/im_status','@mail/core/common/message_in_reply','@mail/core/common/message_link_preview_list','@mail/core/common/message_notification_popover','@mail/core/common/message_reaction_menu','@mail/core/common/message_reactions','@mail/core/common/relative_time','@mail/utils/common/format','@web/core/utils/misc','@web/core/utils/render','@odoo/owl','@web/core/action_swiper/action_swiper','@web/core/browser/feature_detection','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_hooks','@web/core/l10n/translation','@web/core/popover/popover_hook','@web/core/utils/hooks','@web/core/utils/html','@web/core/utils/urls','@mail/core/common/message_actions','@mail/core/common/discuss_component_registry','@mail/core/common/notification_message','@mail/utils/common/hooks','@mail/core/common/action_list','@mail/utils/common/misc'],function(require){'use strict';let __exports={};const{AttachmentList}=require("@mail/core/common/attachment_list");const{Composer}=require("@mail/core/common/composer");const{ImStatus}=require("@mail/core/common/im_status");const{MessageInReply}=require("@mail/core/common/message_in_reply");const{MessageLinkPreviewList}=require("@mail/core/common/message_link_preview_list");const{MessageNotificationPopover}=require("@mail/core/common/message_notification_popover");const{MessageReactionMenu}=require("@mail/core/common/message_reaction_menu");const{MessageReactions}=require("@mail/core/common/message_reactions");const{RelativeTime}=require("@mail/core/common/relative_time");const{htmlToTextContentInline}=require("@mail/utils/common/format");const{isEventHandled,markEventHandled}=require("@web/core/utils/misc");const{renderToElement}=require("@web/core/utils/render");const{Component,onMounted,onPatched,onWillDestroy,onWillUpdateProps,toRaw,useChildSubEnv,useEffect,useRef,useState,useSubEnv,}=require("@odoo/owl");const{ActionSwiper}=require("@web/core/action_swiper/action_swiper");const{hasTouch,isMobileOS}=require("@web/core/browser/feature_detection");const{Dropdown}=require("@web/core/dropdown/dropdown");const{useDropdownState}=require("@web/core/dropdown/dropdown_hooks");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{usePopover}=require("@web/core/popover/popover_hook");const{useService}=require("@web/core/utils/hooks");const{createElementWithContent}=require("@web/core/utils/html");const{getOrigin,url}=require("@web/core/utils/urls");const{useMessageActions}=require("@mail/core/common/message_actions");const{discussComponentRegistry}=require("@mail/core/common/discuss_component_registry");const{NotificationMessage}=require("@mail/core/common/notification_message");const{useLongPress}=require("@mail/utils/common/hooks");const{ActionList}=require("@mail/core/common/action_list");const{loadCssFromBundle}=require("@mail/utils/common/misc");const Message=__exports.Message=class Message extends Component{static SHADOW_LINK_COLOR="#66598f";static SHADOW_HIGHLIGHT_COLOR="#e99d00bf";static SHADOW_LINK_HOVER_COLOR="#564b79";static components={ActionList,ActionSwiper,AttachmentList,Composer,Dropdown,ImStatus,MessageInReply,MessageLinkPreviewList,MessageReactions,Popover:MessageNotificationPopover,RelativeTime,NotificationMessage,};static defaultProps={hasActions:true,isInChatWindow:false,showDates:true,};static props=["asCard?","registerMessageRef?","hasActions?","isInChatWindow?","onParentMessageClick?","message","previousMessage?","squashed?","thread?","messageSearch?","className?","showDates?","isFirstMessage?","isReadOnly?",];static template="mail.Message";setup(){super.setup();this.store=useService("mail.store");this.popover=usePopover(this.constructor.components.Popover,{position:"top"});this.state=useState({isHovered:false,isClicked:false,expandOptions:false,emailHeaderOpen:false,});this.shadowRoot;this.root=useRef("root");if(isMobileOS()){useLongPress("root",{action:()=>this.openMobileActions(),predicate:()=>!this.isEditing,});}
onWillUpdateProps((nextProps)=>{this.props.registerMessageRef?.(this.props.message,null);});onMounted(()=>this.props.registerMessageRef?.(this.props.message,this.root));onPatched(()=>this.props.registerMessageRef?.(this.props.message,this.root));onWillDestroy(()=>this.props.registerMessageRef?.(this.props.message,null));this.hasTouch=hasTouch;this.messageBody=useRef("body");this.messageActions=useMessageActions({message:()=>this.message,thread:()=>this.props.thread,});this.shadowBody=useRef("shadowBody");this.dialog=useService("dialog");this.ui=useService("ui");this.openReactionMenu=this.openReactionMenu.bind(this);this.optionsDropdown=useDropdownState();useSubEnv({inMessage:true});useChildSubEnv({message:this.props.message,alignedRight:this.isAlignedRight,});onMounted(()=>{if(this.shadowBody.el){this.shadowRoot=this.shadowBody.el.attachShadow({mode:"open"});const color=this.store.isOdooWhiteTheme?"dark":"white";loadCssFromBundle(this.shadowRoot,"mail.assets_message_email");const shadowStyle=document.createElement("style");shadowStyle.textContent=`
                    * {
                        background-color: transparent !important;
                        color: ${color} !important;
                    }
                    a, a * {
                        color: ${this.constructor.SHADOW_LINK_COLOR} !important;
                    }
                    a:hover, a *:hover {
                        color: ${this.constructor.SHADOW_LINK_HOVER_COLOR} !important;
                    }
                    .o-mail-Message-searchHighlight {
                        background: ${this.constructor.SHADOW_HIGHLIGHT_COLOR} !important;
                    }
                `;if(!this.store.isOdooWhiteTheme){this.shadowRoot.appendChild(shadowStyle);}
const ellipsisStyle=document.createElement("style");ellipsisStyle.textContent=`
                    .o-mail-ellipsis {
                        min-width: 2.7ch;
                        background-color: ButtonFace;
                        border-radius: 50rem;
                        border: 0;
                        display: block
                        font: -moz-button;
                        font-size: .75rem;
                        font-weight: 500;
                        line-height: 1.1;
                        cursor: pointer;
                        padding: 0 4px;
                        vertical-align: top;
                        color #ffffff;
                        text-decoration: none;
                        text-align: center;
                        &:hover {
                            background-color: -moz-buttonhoverface;
                        }
                    }
                `;this.shadowRoot.appendChild(ellipsisStyle);}});useEffect(()=>{if(this.shadowBody.el){const bodyEl=createElementWithContent("span",this.message.showTranslation?this.message.richTranslationValue:this.props.messageSearch?.highlight(this.message.richBody)??this.message.richBody);this.prepareMessageBody(bodyEl);this.shadowRoot.appendChild(bodyEl);return()=>{this.shadowRoot.removeChild(bodyEl);};}},()=>[this.message.showTranslation,this.message.richTranslationValue,this.props.messageSearch?.searchTerm,this.message.richBody,this.isEditing,]);useEffect(()=>{if(!this.isEditing){this.prepareMessageBody(this.messageBody.el);}},()=>[this.isEditing,this.message.richBody]);}
computeActions(){const allActions=this.messageActions.actions;const quickActions=allActions.slice(0,allActions.length>this.quickActionCount?this.quickActionCount-1:this.quickActionCount);const moreActions=allActions.length>this.quickActionCount?allActions.slice(this.quickActionCount-1):false;const moreAction=moreActions?.length?this.messageActions.more({actions:moreActions,dropdownMenuClass:"o-mail-Message-moreMenu",dropdownPosition:this.isAlignedRight?this.message.threadAsNewest?"left-end":"left-start":this.message.threadAsNewest?"right-end":"right-start",name:this.expandText,}):undefined;const actions=moreAction?[...quickActions,moreAction]:quickActions;if(this.isAlignedRight){actions.reverse();}
this.state.moreAction=moreAction;this.quickActions=quickActions;this.actions=actions;}
get attClass(){return{"user-select-none o-isMobileOS":isMobileOS(),[this.props.className]:true,"o-card p-2 ps-1 mx-1 mt-1 mb-1 border border-dark rounded-2":this.props.asCard,"pt-1":!this.props.asCard&&!this.props.squashed,"o-pt-0_5":!this.props.asCard&&this.props.squashed,"o-selfAuthored":this.message.isSelfAuthored&&!this.env.messageCard,"o-selected":this.props.message.composerAsReplyToMessage?.thread.eq(this.props.thread),"o-squashed":this.props.squashed,"mt-1":!this.props.squashed&&this.props.thread&&!this.env.messageCard&&!this.props.asCard,"px-1":this.props.isInChatWindow,"o-actionMenuMobileOpen":this.ui.isSmall&&this.optionsDropdown.isOpen,"o-editing":this.isEditing,};}
get authorAvatarAttClass(){return{"object-fit-contain":this.props.message.author_id?.is_company,"object-fit-cover":!this.props.message.author_id?.is_company,};}
get authorAvatarUrl(){if(this.message.message_type&&this.message.message_type.includes("email")&&!this.message.author_id&&!this.message.author_guest_id){return url("/mail/static/src/img/email_icon.png");}
if(this.message.author){return this.message.author.avatarUrl;}
return this.store.DEFAULT_AVATAR;}
get expandText(){return _t("Expand");}
get isEditing(){return!this.props.isReadOnly&&this.props.message.composer;}
get message(){return this.props.message;}
get quickActionCount(){if(isMobileOS()){return 1;}
return this.env.inChatWindow||this.env.inMeetingChat?2:4;}
get showSubtypeDescription(){return(this.message.subtype_id?.description&&this.message.subtype_id.description.toLowerCase()!==htmlToTextContentInline(this.message.body||"").toLowerCase());}
get messageTypeText(){if(this.props.message.message_type==="notification"){return _t("System notification");}
if(this.props.message.message_type==="auto_comment"){return _t("Automated message");}
if(this.props.message.message_type==="out_of_office"){return _t("Out-of-office message");}
if(!this.props.message.isDiscussion&&this.props.message.message_type!=="user_notification"){return _t("Note");}
return _t("Message");}
get isActive(){return(this.state.isHovered||this.state.isClicked||this.emojiPicker?.isOpen||Boolean(this.state.moreAction?.isActive));}
get isAlignedRight(){return Boolean(this.env.inChatWindow&&this.props.message.isSelfAuthored);}
get isMobileOS(){return isMobileOS();}
get isPersistentMessageFromAnotherThread(){return(!this.message.is_transient&&!this.message.isPending&&this.message.thread&&this.message.thread.notEq(this.props.thread));}
get translatedFromText(){return _t("(Translated from: %(language)s)",{language:this.message.translationSource});}
get translationFailureText(){return _t("(Translation Failure: %(error)s)",{error:this.message.translationErrors});}
onMouseenter(){this.state.isHovered=true;}
onMouseleave(){this.state.isHovered=false;this.state.isClicked=null;}
get shouldDisplayAuthorName(){if(!this.env.inChatWindow){return true;}
if(this.message.isSelfAuthored){return false;}
if(this.props.thread.channel_type==="chat"){return false;}
return true;}
async onClickAttachmentUnlink(attachment){await toRaw(attachment).remove();}
async onClick(ev){if(this.store.handleClickOnLink(ev,this.props.thread)){return;}
if(!isEventHandled(ev,"Message.ClickAuthor")&&!isEventHandled(ev,"Message.ClickFailure")){if(this.state.isClicked){this.state.isClicked=false;}else{this.state.isClicked=true;document.body.addEventListener("click",()=>{this.state.isClicked=false;},{capture:true,once:true});}}}
prepareMessageBody(bodyEl){if(!bodyEl){return;}
const editedEl=bodyEl.querySelector(".o-mail-Message-edited");editedEl?.replaceChildren(renderToElement("mail.Message.edited"));const channelLinks=bodyEl.querySelectorAll("a.o_channel_redirect");this.store.handleValidChannelMention(Array.from(channelLinks));for(const el of bodyEl.querySelectorAll(".o_message_redirect")){if(el.getAttribute("href")?.startsWith(getOrigin())){const message=this.store["mail.message"].get(el.dataset.oeId);if(message?.thread?.displayName){el.classList.add("o_message_redirect_transformed");el.replaceChildren(renderToElement("mail.Message.messageLink",{message}));}}}}
getAuthorAttClass(){return{"opacity-50":this.message.isPending};}
getAvatarContainerAttClass(){return{"opacity-50":this.message.isPending,"o-inChatWindow":this.env.inChatWindow,};}
exitEditMode(){this.message.exitEditMode(this.props.thread);}
onClickNotification(ev){const message=toRaw(this.message);if(message.failureNotifications.length>0){markEventHandled(ev,"Message.ClickFailure");}
this.popover.open(ev.target,{message});}
openMobileActions(ev){if(!isMobileOS()){return;}
ev?.stopPropagation();this.optionsDropdown.open();}
openReactionMenu(reaction){const message=toRaw(this.props.message);this.dialog.add(MessageReactionMenu,{message,initialReaction:reaction},{context:this});}
async onClickToggleTranslation(){toRaw(this.props.message).onClickToggleTranslation();}
get shouldHideFromMessageListOnDelete(){return false;}}
discussComponentRegistry.add("Message",Message);return __exports;});;

/* /mail/static/src/core/common/message_actions.js */
odoo.define('@mail/core/common/message_actions',['@odoo/owl','@web/core/l10n/translation','@web/core/network/download','@web/core/registry','@mail/core/common/discuss_component_registry','@web/core/utils/concurrency','@mail/core/common/action','@web/core/emoji_picker/emoji_picker','@mail/core/common/quick_reaction_menu','@web/core/browser/feature_detection','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{toRaw,useComponent,useState}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{download}=require("@web/core/network/download");const{registry}=require("@web/core/registry");const{discussComponentRegistry}=require("@mail/core/common/discuss_component_registry");const{Deferred}=require("@web/core/utils/concurrency");const{Action,ACTION_TAGS,UseActions}=require("@mail/core/common/action");const{useEmojiPicker}=require("@web/core/emoji_picker/emoji_picker");const{QuickReactionMenu}=require("@mail/core/common/quick_reaction_menu");const{isMobileOS}=require("@web/core/browser/feature_detection");const{useService}=require("@web/core/utils/hooks");const{DateTime}=luxon;const messageActionsRegistry=__exports.messageActionsRegistry=registry.category("mail.message/actions");__exports.registerMessageAction=registerMessageAction;function registerMessageAction(id,definition){messageActionsRegistry.add(id,definition);}
registerMessageAction("reaction",{component:QuickReactionMenu,componentProps:({message,owner})=>({message,action:messageActionsRegistry.get("reaction"),messageActive:owner.isActive,}),componentCondition:()=>!isMobileOS(),condition:({message,thread})=>message.canAddReaction(thread),icon:"oi oi-smile-add",name:_t("Add a Reaction"),onSelected({owner}){return owner.reactionPicker.open({el:owner.root?.el?.querySelector(`[name="${this.id}"]`),});},setup:({message,owner,thread})=>(owner.reactionPicker=useEmojiPicker(undefined,{onSelect:(emoji)=>{const reaction=message.reactions.find(({content,personas})=>content===emoji&&thread.effectiveSelf.in(personas));if(!reaction){message.react(emoji);}},})),sequence:10,});registerMessageAction("reply-to",{condition:({message:msg,thread:thr})=>{const message=toRaw(msg);const thread=toRaw(thr);return(message.canReplyTo(thread)||(!["discuss.channel","mail.box"].includes(thread?.model)&&message.isNote&&!message.isSelfAuthored));},icon:"fa fa-reply",name:_t("Reply"),onSelected:({message:msg,owner,thread:thr})=>{const message=toRaw(msg);const thread=toRaw(thr);const composer=thread.composer;if(message.eq(composer.replyToMessage)){composer.replyToMessage=undefined;return;}
if(["discuss.channel","mail.box"].includes(thread.model)){composer.replyToMessage=message;}
if(thread.model==="discuss.channel"){return;}
if(!message.isSelfAuthored&&message.model!=="discuss.channel"){const mentionText=`@${message.authorName} `;if(!composer.composerText.includes(mentionText)){composer.mentionedPartners.add(message.author);composer.insertText(mentionText,0,{moveCursorToEnd:true});}}
owner.env.inChatter?.toggleComposer("note",{force:true});if(!composer.isFocused){composer.autofocus++;}},sequence:({message,store,thread})=>thread?.eq(store.inbox)||message.isSelfAuthored?55:20,});registerMessageAction("toggle-star",{condition:({message})=>message.canToggleStar,icon:({message})=>(message.starred?"fa fa-star o-mail-Message-starred":"fa fa-star-o"),name:({message})=>(message.starred?_t("Remove Star"):_t("Add Star")),onSelected:({message})=>message.toggleStar(),sequence:30,});registerMessageAction("mark-as-read",{condition:({store,thread})=>thread?.eq(store.inbox),icon:"fa fa-check",name:_t("Mark as Read"),onSelected:({message})=>message.setDone(),sequence:40,});registerMessageAction("reactions",{condition:({message})=>message.reactions.length,icon:"fa fa-smile-o",name:_t("View Reactions"),onSelected:({owner})=>owner.openReactionMenu(),sequence:50,});registerMessageAction("unfollow",{condition:({message,thread})=>message.canUnfollow(thread),icon:"fa fa-user-times",name:_t("Unfollow"),onSelected:({message})=>message.unfollow(),sequence:60,});registerMessageAction("edit",{condition:({message})=>message.editable,icon:"fa fa-pencil",name:_t("Edit"),onSelected:({message,owner,thread})=>{message.enterEditMode(thread);owner.optionsDropdown?.close();},sequence:({message})=>(message.isSelfAuthored?20:55),});registerMessageAction("delete",{condition:({message})=>message.editable,icon:"fa fa-trash",name:_t("Delete"),onSelected:async({message:msg,owner,store})=>{const message=toRaw(msg);const def=new Deferred();store.env.services.dialog.add(discussComponentRegistry.get("MessageConfirmDialog"),{message,prompt:_t("Are you sure you want to bid farewell to this message forever?"),onConfirm:()=>{def.resolve(true);message.remove({removeFromThread:owner.shouldHideFromMessageListOnDelete,});},},{context:owner,onClose:()=>def.resolve(false)});return def;},sequence:120,tags:ACTION_TAGS.DANGER,});registerMessageAction("download_files",{condition:({message,store})=>message.attachment_ids.length>1&&store.self.main_user_id?.share===false,icon:"fa fa-download",name:_t("Download Files"),onSelected:({message})=>download({data:{file_ids:message.attachment_ids.map((rec)=>rec.id),zip_name:`attachments_${DateTime.local().toFormat("HHmmddMMyyyy")}.zip`,},url:"/mail/attachment/zip",}),sequence:55,});registerMessageAction("toggle-translation",{condition:({message})=>message.isTranslatable(message.thread),icon:({message})=>`fa fa-language ${message.showTranslation ? "o-mail-Message-translated" : ""}`,name:({message})=>(message.showTranslation?_t("Revert"):_t("Translate")),onSelected:({message})=>message.onClickToggleTranslation(),sequence:100,});registerMessageAction("copy-message",{condition:({message})=>isMobileOS()&&!message.isBodyEmpty,onSelected:({message})=>message.copyMessageText(),name:_t("Copy to Clipboard"),icon:"fa fa-copy",sequence:30,});registerMessageAction("copy-link",{condition:({message,thread})=>message.message_type&&message.message_type!=="user_notification"&&thread&&(!thread.access_token||thread.hasReadAccess),icon:"fa fa-link",name:_t("Copy Link"),onSelected:({message})=>message.copyLink(),sequence:110,});const MessageAction=__exports.MessageAction=class MessageAction extends Action{messageFn;threadFn;constructor({message,thread}){super(...arguments);this.messageFn=typeof message==="function"?message:()=>message;this.threadFn=typeof thread==="function"?thread:()=>thread;}
get params(){return Object.assign(super.params,{message:this.messageFn(),thread:this.threadFn()});}}
class UseMessageActions extends UseActions{ActionClass=MessageAction;}
__exports.useMessageActions=useMessageActions;function useMessageActions({message,thread}={}){const component=useComponent();const transformedActions=messageActionsRegistry.getEntries().map(([id,definition])=>new MessageAction({owner:component,id,definition,message,thread}));for(const action of transformedActions){action.setup();}
const state=useState(new UseMessageActions(component,transformedActions,useService("mail.store")));return state;}
return __exports;});;

/* /mail/static/src/core/common/message_card_list.js */
odoo.define('@mail/core/common/message_card_list',['@mail/core/common/message','@mail/utils/common/hooks','@odoo/owl','@web/core/l10n/translation','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Message}=require("@mail/core/common/message");const{useVisible}=require("@mail/utils/common/hooks");const{Component,useSubEnv}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{useService}=require("@web/core/utils/hooks");const MessageCardList=__exports.MessageCardList=class MessageCardList extends Component{static components={Message};static props=["emptyText?","messages","messageSearch?","loadMore?","mode","onClickJump?","onLoadMoreVisible?","showEmpty?","thread",];static template="mail.MessageCardList";setup(){super.setup();this.ui=useService("ui");this.store=useService("mail.store");useSubEnv({messageCard:true});useVisible("load-more",(isVisible)=>{if(isVisible){this.props.onLoadMoreVisible?.();}});}
async onClickJump(message){this.props.onClickJump?.();if(this.ui.isSmall||this.env.inChatWindow||this.env.inMeetingView){this.env.pinMenu?.close();this.env.searchMenu?.close();this.env.inMeetingView?.openChat();}
await new Promise((resolve)=>setTimeout(()=>requestAnimationFrame(resolve)));await this.env.messageHighlight?.highlightMessage(message,this.props.thread);}
get emptyText(){return this.props.emptyText??_t("No messages found");}}
return __exports;});;

/* /mail/static/src/core/common/message_confirm_dialog.js */
odoo.define('@mail/core/common/message_confirm_dialog',['@odoo/owl','@web/core/dialog/dialog','@web/core/l10n/translation','@mail/core/common/discuss_component_registry'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const{Dialog}=require("@web/core/dialog/dialog");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{discussComponentRegistry}=require("@mail/core/common/discuss_component_registry");const MessageConfirmDialog=__exports.MessageConfirmDialog=class MessageConfirmDialog extends Component{static components={Dialog};static props=["close","confirmColor?","confirmText?","message","prompt","size?","title?","onConfirm",];static defaultProps={confirmColor:"btn-primary",confirmText:_t("Delete"),size:"xl",title:_t("Send this message to the great trash can in the sky?"),};static template="mail.MessageConfirmDialog";get messageComponent(){return discussComponentRegistry.get("Message");}
onClickConfirm(){this.props.onConfirm();this.props.close();}}
discussComponentRegistry.add("MessageConfirmDialog",MessageConfirmDialog);return __exports;});;

/* /mail/static/src/core/common/message_in_reply.js */
odoo.define('@mail/core/common/message_in_reply',['@odoo/owl','@web/core/utils/hooks','@web/core/utils/urls'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const{useService}=require("@web/core/utils/hooks");const{url}=require("@web/core/utils/urls");const MessageInReply=__exports.MessageInReply=class MessageInReply extends Component{static props=["class?","message","onClick?"];static defaultProps={class:""};static template="mail.MessageInReply";setup(){super.setup();this.store=useService("mail.store");}
get authorAvatarUrl(){if(this.props.message.message_type&&this.props.message.message_type.includes("email")&&!this.props.message.author_id&&!this.props.message.author_guest_id){return url("/mail/static/src/img/email_icon.png");}
if(this.props.message.parent_id.author){return this.props.message.parent_id.author.avatarUrl;}
return this.store.DEFAULT_AVATAR;}}
return __exports;});;

/* /mail/static/src/core/common/message_link_preview_list.js */
odoo.define('@mail/core/common/message_link_preview_list',['@mail/core/common/link_preview','@odoo/owl'],function(require){'use strict';let __exports={};const{LinkPreview}=require("@mail/core/common/link_preview");const{Component}=require("@odoo/owl");const MessageLinkPreviewList=__exports.MessageLinkPreviewList=class MessageLinkPreviewList extends Component{static template="mail.MessageLinkPreviewList";static props=["messageLinkPreviews"];static components={LinkPreview};}
return __exports;});;

/* /mail/static/src/core/common/message_link_preview_model.js */
odoo.define('@mail/core/common/message_link_preview_model',['@mail/core/common/record','@web/core/network/rpc'],function(require){'use strict';let __exports={};const{fields,Record}=require("@mail/core/common/record");const{rpc}=require("@web/core/network/rpc");const MessageLinkPreview=__exports.MessageLinkPreview=class MessageLinkPreview extends Record{static _name="mail.message.link.preview";static id="id";message_id=fields.One("mail.message",{inverse:"message_link_preview_ids"});link_preview_id=fields.One("mail.link.preview",{inverse:"message_link_preview_ids"});get gifPaused(){return!this.message_id.thread?.isFocused;}
hide(){rpc("/mail/link_preview/hide",{message_link_preview_ids:[this.id]});}}
MessageLinkPreview.register();return __exports;});;

/* /mail/static/src/core/common/message_model.js */
odoo.define('@mail/core/common/message_model',['@html_editor/utils/dom_info','@mail/core/common/record','@mail/utils/common/format','@web/core/browser/browser','@web/core/browser/router','@web/core/emoji_picker/emoji_picker','@web/core/l10n/translation','@web/core/network/rpc','@web/core/user','@web/core/utils/html','@web/core/utils/urls','@odoo/owl'],function(require){'use strict';let __exports={};const{isEmptyBlock}=require("@html_editor/utils/dom_info");const{fields,Record}=require("@mail/core/common/record");const{EMOJI_REGEX,convertBrToLineBreak,decorateEmojis,generateEmojisOnHtml,getNonEditableMentions,htmlToTextContentInline,}=require("@mail/utils/common/format");const{browser}=require("@web/core/browser/browser");const{router}=require("@web/core/browser/router");const{loadEmoji}=require("@web/core/emoji_picker/emoji_picker");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{rpc}=require("@web/core/network/rpc");const{user}=require("@web/core/user");const{createDocumentFragmentFromContent,createElementWithContent}=require("@web/core/utils/html");const{url}=require("@web/core/utils/urls");const{markup}=require("@odoo/owl");const{DateTime}=luxon;const Message=__exports.Message=class Message extends Record{static _name="mail.message";static id="id";update(data){super.update(data);if(this.isNotification&&!this.notificationType){const htmlBody=createDocumentFragmentFromContent(this.body);this.notificationType=htmlBody.querySelector(".o_mail_notification")?.dataset.oeType;}}
attachment_ids=fields.Many("ir.attachment",{inverse:"message"});author_id=fields.One("res.partner");author_guest_id=fields.One("mail.guest");get author(){return this.author_id||this.author_guest_id;}
body=fields.Html("");call_history_ids=fields.Many("discuss.call.history");richBody=fields.Html("",{compute(){if(!this.store.emojiLoader.loaded){loadEmoji();}
return decorateEmojis(this.body)??"";},});richTranslationValue=fields.Html("",{compute(){if(!this.store.emojiLoader.loaded){loadEmoji();}
return decorateEmojis(this.translationValue)??"";},});composer=fields.One("Composer",{inverse:"message",onDelete:(r)=>r.delete()});composerAsReplyToMessage=fields.One("Composer",{inverse:"replyToMessage"});date=fields.Datetime();default_subject;edited=fields.Attr(false,{compute(){return Boolean(createDocumentFragmentFromContent(this.body).querySelector(".o-mail-Message-edited"));},});hasLink=fields.Attr(false,{compute(){if(this.isBodyEmpty){return false;}
const div=createElementWithContent("div",this.body);return Boolean(div.querySelector("a:not([data-oe-model])"));},});hasMailNotificationSummary=fields.Attr(false,{compute(){return Boolean(createDocumentFragmentFromContent(this.body).querySelector('[summary="o_mail_notification"]'));},});id;incoming_email_cc;incoming_email_to;get isDiscussion(){return this.store.mt_comment?.eq(this.subtype_id);}
get isNote(){return this.store.mt_note?.eq(this.subtype_id);}
is_transient;message_link_preview_ids=fields.Many("mail.message.link.preview",{inverse:"message_id"});parent_id=fields.One("mail.message");postFailRedo=undefined;reactions=fields.Many("MessageReactions",{inverse:"message",sort:(r1,r2)=>r1.sequence-r2.sequence,});notification_ids=fields.Many("mail.notification",{inverse:"mail_message_id"});partner_ids=fields.Many("res.partner");subtype_id=fields.One("mail.message.subtype");thread=fields.One("Thread");threadAsNeedaction=fields.One("Thread",{compute(){if(this.needaction){return this.thread;}},});threadAsNewest=fields.One("Thread");threadAsInEdition=fields.One("Thread",{compute(){if(this.composer){return this.thread;}},});scheduledDatetime=fields.Datetime();onlyEmojis=fields.Attr(false,{compute(){const bodyWithoutTags=createElementWithContent("div",this.body).textContent;const withoutEmojis=bodyWithoutTags.replace(EMOJI_REGEX,"");return(bodyWithoutTags.length>0&&bodyWithoutTags.match(EMOJI_REGEX)&&withoutEmojis.trim().length===0);},});subject;trackingValues=[];translationValue;translationSource;translationErrors;message_type;notificationType;create_date=fields.Datetime();write_date=fields.Datetime();needaction;starred=false;showTranslation=false;get allowsEdition(){return this.store.self.main_user_id?.is_admin||this.isSelfAuthored;}
get bubbleColor(){if(this.message_type==="notification"){return undefined;}
if(!this.isSelfAuthored&&!this.isNote&&!this.isHighlightedFromMention){return"blue";}
if(this.isSelfAuthored&&!this.isNote&&!this.isHighlightedFromMention){return"green";}
if(this.isHighlightedFromMention){return"orange";}
return undefined;}
get editable(){if(this.isEmpty||!this.allowsEdition){return false;}
return this.message_type==="comment";}
get dateDay(){let dateDay=this.datetime.toLocaleString(DateTime.DATE_MED);if(dateDay===DateTime.now().toLocaleString(DateTime.DATE_MED)){dateDay=_t("Today");}
return dateDay;}
get dateSimple(){return this.datetime.toLocaleString(DateTime.TIME_SIMPLE,{locale:user.lang,}).replace(""," ");}
get dateSimpleWithDay(){const userLocale={locale:user.lang};if(this.datetime.hasSame(DateTime.now(),"day")){return this.datetime.toLocaleString(DateTime.TIME_SIMPLE,userLocale);}
if(this.datetime.hasSame(DateTime.now().minus({day:1}),"day")){return _t("Yesterday at %(time)s",{time:this.datetime.toLocaleString(DateTime.TIME_SIMPLE,userLocale),});}
if(this.datetime?.year===DateTime.now().year){return this.datetime.toLocaleString({...DateTime.DATETIME_MED,year:undefined},userLocale);}
return this.datetime.toLocaleString({...DateTime.DATETIME_MED},userLocale);}
get datetime(){return this.date||DateTime.now();}
get effectiveSelf(){return this.thread?.effectiveSelf??this.store.self;}
get datetimeShort(){return this.datetime.toLocaleString(DateTime.DATETIME_SHORT_WITH_SECONDS);}
get isSelfMentioned(){return this.effectiveSelf.in(this.partner_ids);}
get isHighlightedFromMention(){return this.isSelfMentioned&&this.thread?.model==="discuss.channel";}
isSelfAuthored=fields.Attr(false,{compute(){return Boolean(this.author?.eq(this.effectiveSelf));},});isPending=false;get hasActions(){return!this.is_transient;}
get isNotification(){return this.message_type==="notification"&&this.thread?.model==="discuss.channel";}
get isSubjectSimilarToThreadName(){if(!this.subject||!this.thread||!this.thread.display_name){return false;}
const regexPrefix=/^((re|fw|fwd)\s*:\s*)*/i;const cleanedThreadName=this.thread.display_name.replace(regexPrefix,"");const cleanedSubject=this.subject.replace(regexPrefix,"");return cleanedSubject===cleanedThreadName;}
get isSubjectDefault(){const name=this.thread?.display_name;const threadName=name?name.trim().toLowerCase():"";const defaultSubject=this.default_subject?this.default_subject.toLowerCase():"";const candidates=new Set([defaultSubject,threadName]);return candidates.has(this.subject?.toLowerCase());}
get persistent(){return Number.isInteger(this.id);}
get resUrl(){return url(router.stateToUrl({model:this.thread.model,resId:this.thread.id}));}
isTranslatable(thread){return(!this.isEmpty&&!this.isBodyEmpty&&!this.hasMailNotificationSummary&&this.store.hasMessageTranslationFeature&&!["discuss.channel","mail.box"].includes(thread?.model));}
get hasTextContent(){return!this.isBodyEmpty||this.edited;}
isEmpty=fields.Attr(false,{compute(){return this.computeIsEmpty();},});isBodyEmpty=fields.Attr(undefined,{compute(){return!this.body||isEmptyBlock(createElementWithContent("div",this.body));},});computeIsEmpty(){return(this.isBodyEmpty&&this.attachment_ids.length===0&&this.trackingValues.length===0&&!this.subtype_id?.description);}
get linkPreviewSquash(){return(this.store.hasLinkPreviewFeature&&this.body&&this.body.startsWith("<a")&&this.body.endsWith("/a>")&&this.body.match(/<\/a>/im)?.length===1&&this.message_link_preview_ids.length===1&&this.message_link_preview_ids[0].link_preview_id.isImage);}
get authorName(){if(this.author){return this.getPersonaName(this.author);}
return this.email_from;}
get notificationHidden(){return false;}
inlineBody=fields.Html("",{compute(){if(this.notificationType==="call"){return _t("%(caller)s started a call",{caller:this.authorName});}
if(this.notificationType==="thread_deletion"){return _t('%(user)s deleted the thread "%(thread_name)s"',{user:this.authorName,thread_name:decorateEmojis(htmlToTextContentInline(this.body)),});}
if(this.notificationType==="channel_rename"){const name=htmlToTextContentInline(this.body);const params={user:this.authorName,name:markup`<b>${name}</b>`};return this.thread?.parent_channel_id?_t("%(user)s changed the thread name to %(name)s",params):_t("%(user)s changed the channel name to %(name)s",params);}
if(this.isEmpty){return _t("This message has been removed");}
if(!this.body){return"";}
return decorateEmojis(htmlToTextContentInline(this.body));},});get notificationIcon(){switch(this.notificationType){case"pin":return"fa fa-thumb-tack";case"call":return"fa fa-phone";}
return null;}
get failureNotifications(){return this.notification_ids.filter((notification)=>notification.isFailure);}
get scheduledDateSimple(){return this.scheduledDatetime.toLocaleString(DateTime.TIME_SIMPLE,{locale:user.lang,});}
get canToggleStar(){return Boolean(!this.is_transient&&!this.isPending&&this.thread&&this.store.self_partner?.main_user_id?.share===false&&this.persistent);}
get hasOnlyAttachments(){return this.isBodyEmpty&&this.attachment_ids.length>0;}
previewText=fields.Html("",{compute(){if(!this.hasOnlyAttachments){return this.inlineBody||this.subtype_id?.description;}
const{attachment_ids:attachments}=this;if(!attachments||attachments.length===0){return"";}
switch(attachments.length){case 1:return attachments[0].previewName;case 2:return _t("%(file1)s and %(file2)s",{file1:attachments[0].previewName,file2:attachments[1].previewName,count:attachments.length-1,});default:return _t("%(file1)s and %(count)s other attachments",{file1:attachments[0].previewName,count:attachments.length-1,});}},});get previewIcon(){const{attachment_ids:attachments}=this;if(!attachments||attachments.length===0){return"";}
const firstAttachment=attachments[0];switch(true){case firstAttachment.isImage:return"fa-picture-o";case firstAttachment.mimetype==="audio/mpeg":return firstAttachment.voice?"fa-microphone":"fa-headphones";case firstAttachment.isVideo:return"fa-video-camera";default:return"fa-file";}}
canAddReaction(thread){return Boolean(!this.is_transient&&!this.isPending&&this.thread?.can_react&&!this.thread.isTransient);}
canReplyTo(thread){return(["discuss.channel","mail.box"].includes(thread?.model)&&this.message_type!=="user_notification");}
canUnfollow(thread){return Boolean(this.thread?.selfFollower&&thread?.model==="mail.box");}
async copyLink(){let notification=_t("Message Link Copied!");let type="info";try{await browser.navigator.clipboard.writeText(url(`/mail/message/${this.id}`));}catch{notification=_t("Message Link Copy Failed (Permission denied?)!");type="danger";}
this.store.env.services.notification.add(notification,{type});}
async copyMessageText(){const messageBody=convertBrToLineBreak(this.body);try{await browser.navigator.clipboard.writeText(messageBody);}catch{this.store.env.services.notification.add(_t("Message Copy Failed (Permission denied?)!"),{type:"danger"});}
this.store.env.services.notification.add(_t("Message Copied!"),{type:"info"});}
async edit(body,attachments=[],{mentionedChannels=[],mentionedPartners=[],mentionedRoles=[]}={}){const bodyEl=createElementWithContent("div",this.body);bodyEl.querySelector("span.o-mail-Message-edited")?.remove();if(createElementWithContent("div",body).innerHTML===bodyEl.innerHTML&&attachments.length===0){return;}
const validMentions=this.store.getMentionsFromText(body,{mentionedChannels,mentionedPartners,mentionedRoles,thread:this.thread,});const hadLink=this.hasLink;const updateData={attachment_ids:attachments.concat(this.attachment_ids).map((attachment)=>attachment.id),attachment_tokens:attachments.concat(this.attachment_ids).map((attachment)=>attachment.ownership_token),body:await generateEmojisOnHtml(body),partner_ids:validMentions?.partners?.map((partner)=>partner.id),role_ids:validMentions?.roles?.map((role)=>role.id),};this.store.fillPartnersMentionToken(updateData);const data=await rpc("/mail/message/update_content",{message_id:this.id,update_data:updateData,...this.thread.rpcParams,});this.store.insert(data);if((hadLink||this.hasLink)&&this.store.hasLinkPreviewFeature){rpc("/mail/link_preview",{message_id:this.id},{silent:true});}
return data;}
async enterEditMode(thread){const doc=createDocumentFragmentFromContent(this.body);const validChannels=(await Promise.all(Array.from(doc.querySelectorAll(".o_channel_redirect[data-oe-model='discuss.channel']")).map(async(el)=>this.store.Thread.getOrFetch({id:el.dataset.oeId,model:"discuss.channel"})))).filter((channel)=>channel?.exists());const text=convertBrToLineBreak(this.body);if(thread?.messageInEdition){thread.messageInEdition.composer=undefined;}
this.composer={composerHtml:getNonEditableMentions(this.body),mentionedChannels:validChannels,mentionedPartners:this.partner_ids,selection:{start:text.length,end:text.length,direction:"none",},};}
exitEditMode(thread){const threadAsInEdition=this.threadAsInEdition;this.composer=undefined;if(threadAsInEdition&&threadAsInEdition.eq(thread)){threadAsInEdition.composer.autofocus++;}}
getPersonaName(persona){return(this.thread?.getPersonaName(persona)||persona?.displayName||persona?.name||_t("Unnamed"));}
async onClickToggleTranslation(){if(!this.translationValue){const{error,lang_name,body}=await rpc("/mail/message/translate",{message_id:this.id,});this.translationValue=body&&markup(body);this.translationSource=lang_name;this.translationErrors=error;}
this.showTranslation=!this.showTranslation&&Boolean(this.translationValue);}
async react(content){this.store.insert(await rpc("/mail/message/reaction",{action:"add",content,message_id:this.id,...this.thread.rpcParams,},{silent:true}));}
async remove({removeFromThread=false}={}){const data=await rpc("/mail/message/update_content",{message_id:this.id,update_data:this.removeParams,...this.thread.rpcParams,});this.store.insert(data);if(this.thread&&removeFromThread){this.thread.messages=this.thread.messages.filter((message)=>message.notEq(this));}
this.composer=undefined;return data;}
get removeParams(){return{attachment_ids:[],attachment_tokens:[],body:"",partner_ids:[],};}
async setDone(){await this.store.env.services.orm.silent.call("mail.message","set_message_done",[[this.id],]);}
async toggleStar(){this.store.insert(await this.store.env.services.orm.silent.call("mail.message","toggle_message_starred",[[this.id]]));}
async unfollow(){if(this.needaction){await this.setDone();}
const thread=this.thread;await thread.selfFollower.remove();this.store.env.services.notification.add(_t('You are no longer following "%(thread_name)s".',{thread_name:thread.display_name,}),{type:"success"});}
hideAllLinkPreviews(){rpc("/mail/link_preview/hide",{message_link_preview_ids:this.message_link_preview_ids.map((lpm)=>lpm.id),});}}
Message.register();return __exports;});;

/* /mail/static/src/core/common/message_notification_popover.js */
odoo.define('@mail/core/common/message_notification_popover',['@odoo/owl'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const MessageNotificationPopover=__exports.MessageNotificationPopover=class MessageNotificationPopover extends Component{static template="mail.MessageNotificationPopover";static props=["message","close?"];}
return __exports;});;

/* /mail/static/src/core/common/message_reaction_list.js */
odoo.define('@mail/core/common/message_reaction_list',['@mail/utils/common/hooks','@odoo/owl','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_hooks','@web/core/emoji_picker/emoji_picker','@web/core/l10n/translation','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{useHover}=require("@mail/utils/common/hooks");const{Component}=require("@odoo/owl");const{Dropdown}=require("@web/core/dropdown/dropdown");const{useDropdownState}=require("@web/core/dropdown/dropdown_hooks");const{loadEmoji}=require("@web/core/emoji_picker/emoji_picker");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{useService}=require("@web/core/utils/hooks");const MessageReactionList=__exports.MessageReactionList=class MessageReactionList extends Component{static template="mail.MessageReactionList";static components={Dropdown};static props=["message","openReactionMenu","reaction"];setup(){super.setup();this.loadEmoji=loadEmoji;this.store=useService("mail.store");this.ui=useService("ui");this.preview=useDropdownState();this.hover=useHover(["reactionButton","reactionList"],{onHover:()=>(this.preview.isOpen=true),onAway:()=>(this.preview.isOpen=false),stateObserver:()=>[this.preview?.isOpen],});}
previewText(reaction){const{count,content:emoji}=reaction;const personNames=reaction.personas.slice(0,3).map((persona)=>this.props.message.getPersonaName(persona));const shortcode=this.store.emojiLoader.loaded?.emojiValueToShortcodes?.[emoji]?.[0]??"?";switch(count){case 1:return _t("%(emoji)s reacted by %(person)s",{emoji:shortcode,person:personNames[0],});case 2:return _t("%(emoji)s reacted by %(person1)s and %(person2)s",{emoji:shortcode,person1:personNames[0],person2:personNames[1],});case 3:return _t("%(emoji)s reacted by %(person1)s, %(person2)s, and %(person3)s",{emoji:shortcode,person1:personNames[0],person2:personNames[1],person3:personNames[2],});case 4:return _t("%(emoji)s reacted by %(person1)s, %(person2)s, %(person3)s, and 1 other",{emoji:shortcode,person1:personNames[0],person2:personNames[1],person3:personNames[2],});default:return _t("%(emoji)s reacted by %(person1)s, %(person2)s, %(person3)s, and %(count)s others",{count:count-3,emoji:shortcode,person1:personNames[0],person2:personNames[1],person3:personNames[2],});}}
hasSelfReacted(reaction){return this.props.message.effectiveSelf.in(reaction.personas);}
onClickReaction(reaction){if(!this.props.message.canAddReaction()){return;}
if(this.hasSelfReacted(reaction)){reaction.remove();}else{this.props.message.react(reaction.content);}}
onContextMenu(ev){if(this.ui.isSmall){ev.preventDefault();this.props.openReactionMenu();}}
onClickReactionList(reaction){this.preview.isOpen=false;this.props.openReactionMenu(reaction);}}
return __exports;});;

/* /mail/static/src/core/common/message_reaction_menu.js */
odoo.define('@mail/core/common/message_reaction_menu',['@web/core/emoji_picker/emoji_picker','@mail/utils/common/hooks','@odoo/owl','@web/core/dialog/dialog','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{loadEmoji}=require("@web/core/emoji_picker/emoji_picker");const{onExternalClick}=require("@mail/utils/common/hooks");const{Component,onMounted,useEffect,useExternalListener,useRef,useState}=require("@odoo/owl");const{Dialog}=require("@web/core/dialog/dialog");const{useService}=require("@web/core/utils/hooks");const MessageReactionMenu=__exports.MessageReactionMenu=class MessageReactionMenu extends Component{static props=["close","message","initialReaction?"];static components={Dialog};static template="mail.MessageReactionMenu";setup(){super.setup();this.root=useRef("root");this.store=useService("mail.store");this.ui=useService("ui");this.state=useState({reaction:this.props.initialReaction?this.props.initialReaction:this.props.message.reactions[0],});useExternalListener(document,"keydown",this.onKeydown);onExternalClick("root",()=>this.props.close());useEffect(()=>{const activeReaction=this.props.message.reactions.find(({content})=>content===this.state.reaction.content);if(this.props.message.reactions.length===0){this.props.close();}else if(!activeReaction){this.state.reaction=this.props.message.reactions[0];}},()=>[this.props.message.reactions.length]);onMounted(()=>{if(!this.store.emojiLoader.loaded){loadEmoji();}});}
onKeydown(ev){switch(ev.key){case"Escape":this.props.close();break;case"q":this.props.close();break;default:return;}}
getEmojiShortcode(reaction){return this.store.emojiLoader.loaded?.emojiValueToShortcodes?.[reaction.content]?.[0]??"?";}
get contentClass(){const attClass={"o-mail-MessageReactionMenu h-50 d-flex":true,"position-absolute bottom-0":this.store.useMobileView,};return Object.entries(attClass).filter(([classNames,value])=>value).map(([classNames])=>classNames).join(" ");}}
return __exports;});;

/* /mail/static/src/core/common/message_reactions.js */
odoo.define('@mail/core/common/message_reactions',['@odoo/owl','@mail/core/common/message_actions','@mail/core/common/message_reaction_list','@mail/core/common/quick_reaction_menu','@web/core/utils/hooks','@web/core/emoji_picker/emoji_picker','@web/core/browser/feature_detection'],function(require){'use strict';let __exports={};const{Component,useRef}=require("@odoo/owl");const{useMessageActions}=require("@mail/core/common/message_actions");const{MessageReactionList}=require("@mail/core/common/message_reaction_list");const{QuickReactionMenu}=require("@mail/core/common/quick_reaction_menu");const{useService}=require("@web/core/utils/hooks");const{useEmojiPicker}=require("@web/core/emoji_picker/emoji_picker");const{isMobileOS}=require("@web/core/browser/feature_detection");const MessageReactions=__exports.MessageReactions=class MessageReactions extends Component{static props=["message","openReactionMenu"];static template="mail.MessageReactions";static components={MessageReactionList,QuickReactionMenu};setup(){super.setup();this.store=useService("mail.store");this.ui=useService("ui");this.addRef=useRef("add");this.isMobileOS=isMobileOS();this.messageActions=useMessageActions({message:()=>this.props.message});this.emojiPicker=useEmojiPicker(this.addRef,{onSelect:(emoji)=>{const reaction=this.props.message.reactions.find(({content,personas})=>content===emoji&&this.props.message.effectiveSelf.in(personas));if(!reaction){this.props.message.react(emoji);}},});}}
return __exports;});;

/* /mail/static/src/core/common/message_reactions_model.js */
odoo.define('@mail/core/common/message_reactions_model',['@mail/core/common/record','@web/core/network/rpc'],function(require){'use strict';let __exports={};const{AND,fields,Record}=require("@mail/core/common/record");const{rpc}=require("@web/core/network/rpc");const MessageReactions=__exports.MessageReactions=class MessageReactions extends Record{static id=AND("message","content");content;count;guests=fields.Many("mail.guest");message=fields.One("mail.message");partners=fields.Many("res.partner");personas=fields.Attr([],{compute(){return[...this.partners,...this.guests];},});sequence;async remove(){this.store.insert(await rpc("/mail/message/reaction",{action:"remove",content:this.content,message_id:this.message.id,...this.message.thread.rpcParams,},{silent:true}));}}
MessageReactions.register();return __exports;});;

/* /mail/static/src/core/common/message_search_hook.js */
odoo.define('@mail/core/common/message_search_hook',['@mail/utils/common/hooks','@odoo/owl','@web/core/utils/hooks','@web/core/utils/html','@web/core/utils/strings'],function(require){'use strict';let __exports={};const{useSequential}=require("@mail/utils/common/hooks");const{useState,onWillUnmount,markup}=require("@odoo/owl");const{useService}=require("@web/core/utils/hooks");const{createDocumentFragmentFromContent}=require("@web/core/utils/html");const{escapeRegExp}=require("@web/core/utils/strings");const HIGHLIGHT_CLASS=__exports.HIGHLIGHT_CLASS="o-mail-Message-searchHighlight";__exports.searchHighlight=searchHighlight;function searchHighlight(searchTerm,target){if(!searchTerm){return target;}
const htmlDoc=createDocumentFragmentFromContent(target);for(const term of searchTerm.split(" ")){const regexp=new RegExp(`(${escapeRegExp(term)})`,"gi");const split=term.toLowerCase().split("'");let lowercase=split.map((s)=>`'${s}'`).join(', "\'", ');let uppercase=lowercase.toUpperCase();if(split.length>1){lowercase=`concat(${lowercase})`;uppercase=`concat(${uppercase})`;}
const matchs=htmlDoc.evaluate(`//*[text()[contains(translate(., ${uppercase}, ${lowercase}), ${lowercase})]]`,htmlDoc,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE);for(let i=0;i<matchs.snapshotLength;i++){const element=matchs.snapshotItem(i);const newNode=[];for(const node of element.childNodes){const match=node.textContent.match(regexp);if(node.nodeType===Node.TEXT_NODE&&match?.length>0){let curIndex=0;for(const match of node.textContent.matchAll(regexp)){const start=htmlDoc.createTextNode(node.textContent.slice(curIndex,match.index));newNode.push(start);const span=htmlDoc.createElement("span");span.setAttribute("class",HIGHLIGHT_CLASS);span.textContent=match[0];newNode.push(span);curIndex=match.index+match[0].length;}
const end=htmlDoc.createTextNode(node.textContent.slice(curIndex));newNode.push(end);}else{newNode.push(node);}}
element.replaceChildren(...newNode);}}
return markup(htmlDoc.body.innerHTML);}
__exports.useMessageSearch=useMessageSearch;function useMessageSearch(thread){const store=useService("mail.store");const sequential=useSequential();const state=useState({thread,async search(before=false){if(this.searchTerm){this.searching=true;const data=await sequential(()=>store.searchMessagesInThread(this.searchTerm,this.thread,before,this.is_notification));if(!data){return;}
const{count,loadMore,messages}=data;this.searched=true;this.searching=false;this.count=count;this.loadMore=loadMore;if(before){this.messages.push(...messages);}else{this.messages=messages;}}else{this.clear();}},count:0,clear(){this.messages=[];this.searched=false;this.searching=false;this.searchTerm=undefined;},is_notification:undefined,loadMore:false,messages:[],searchTerm:undefined,searched:false,searching:false,highlight:(target)=>searchHighlight(state.searchTerm,target),});onWillUnmount(()=>{state.clear();});return state;}
return __exports;});;

/* /mail/static/src/core/common/navigable_list.js */
odoo.define('@mail/core/common/navigable_list',['@mail/core/common/im_status','@mail/utils/common/hooks','@web/core/utils/misc','@odoo/owl','@web/core/hotkeys/hotkey_service','@web/core/position/position_hook','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{ImStatus}=require("@mail/core/common/im_status");const{onExternalClick}=require("@mail/utils/common/hooks");const{markEventHandled,isEventHandled}=require("@web/core/utils/misc");const{Component,useEffect,useExternalListener,useRef,useState}=require("@odoo/owl");const{getActiveHotkey}=require("@web/core/hotkeys/hotkey_service");const{usePosition}=require("@web/core/position/position_hook");const{useService}=require("@web/core/utils/hooks");const NavigableList=__exports.NavigableList=class NavigableList extends Component{static components={ImStatus};static template="mail.NavigableList";static props={anchorRef:{optional:true},class:{type:String,optional:true},onSelect:{type:Function},options:{type:Array},optionTemplate:{type:String,optional:true},position:{type:String,optional:true},closeOnSelect:{type:Boolean,optional:true},isLoading:{type:Boolean,optional:true},};static defaultProps={position:"bottom",closeOnSelect:true,isLoading:false,};setup(){super.setup();this.rootRef=useRef("root");this.state=useState({activeIndex:null,open:false,showLoading:false,});this.hotkey=useService("hotkey");this.hotkeysToRemove=[];useExternalListener(window,"keydown",this.onKeydown,true);onExternalClick("root",async(ev)=>{await new Promise(setTimeout);if(isEventHandled(ev,"composer.onClickTextarea")){return;}
this.close();});usePosition("root",()=>this.props.anchorRef,{position:this.props.position});useEffect(()=>{this.open();},()=>[this.props]);useEffect(()=>{if(!this.props.isLoading){clearTimeout(this.loadingTimeoutId);this.state.showLoading=false;}else if(!this.loadingTimeoutId){this.loadingTimeoutId=setTimeout(()=>(this.state.showLoading=true),2000);}},()=>[this.props.isLoading]);}
get show(){return Boolean(this.state.open&&(this.props.isLoading||this.props.options.length));}
get sortedOptions(){return this.props.options.sort((o1,o2)=>(o1.group??0)-(o2.group??0));}
open(){this.state.open=true;this.state.activeIndex=null;this.navigate("first");}
close(){if(this.props.closeOnSelect){this.state.open=false;this.state.activeIndex=null;}}
selectOption(ev,index,params={}){const option=this.props.options[index];if(!option){return;}
if(option.unselectable){this.close();return;}
this.props.onSelect(ev,option,{...params,});this.close();}
navigate(direction){if(this.props.options.length===0){return;}
const activeOptionId=this.state.activeIndex!==null?this.state.activeIndex:0;let targetId=undefined;switch(direction){case"first":targetId=0;break;case"last":targetId=this.props.options.length-1;break;case"previous":targetId=activeOptionId-1;if(targetId<0){this.navigate("last");return;}
break;case"next":targetId=activeOptionId+1;if(targetId>this.props.options.length-1){this.navigate("first");return;}
break;default:return;}
this.state.activeIndex=targetId;}
onKeydown(ev){if(!this.show){return;}
const hotkey=getActiveHotkey(ev);switch(hotkey){case"enter":markEventHandled(ev,"NavigableList.select");if(this.state.activeIndex===null){this.close();return;}
this.selectOption(ev,this.state.activeIndex);break;case"escape":markEventHandled(ev,"NavigableList.close");this.close();break;case"tab":this.navigate(this.state.activeIndex===null?"first":"next");break;case"arrowup":this.navigate(this.state.activeIndex===null?"first":"previous");break;case"arrowdown":this.navigate(this.state.activeIndex===null?"first":"next");break;default:return;}
if(this.props.options.length!==0){ev.stopPropagation();}
ev.preventDefault();}
onOptionMouseEnter(index){}}
return __exports;});;

/* /mail/static/src/core/common/notification_message.js */
odoo.define('@mail/core/common/notification_message',['@odoo/owl','@web/core/l10n/translation','@web/core/utils/hooks','@web/core/utils/strings'],function(require){'use strict';let __exports={};const{Component,onMounted,onPatched,onWillDestroy,onWillUpdateProps,useRef,}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{useService}=require("@web/core/utils/hooks");const{escape}=require("@web/core/utils/strings");const NotificationMessage=__exports.NotificationMessage=class NotificationMessage extends Component{static template="mail.NotificationMessage";static props=["message","thread","registerMessageRef?"];setup(){super.setup();this.root=useRef("root");onWillUpdateProps((nextProps)=>{this.props.registerMessageRef?.(this.props.message,null);});onMounted(()=>this.props.registerMessageRef?.(this.props.message,this.root));onPatched(()=>this.props.registerMessageRef?.(this.props.message,this.root));onWillDestroy(()=>this.props.registerMessageRef?.(this.props.message,null));this.escape=escape;this.store=useService("mail.store");}
async onClickNotificationMessage(ev){this.store.handleClickOnLink(ev,this.props.thread);const{oeType,oeId}=ev.target.dataset;if(oeType==="highlight"){await this.env.messageHighlight?.highlightMessage(this.store["mail.message"].insert({id:Number(oeId),res_id:this.props.thread.id,model:this.props.thread.model,thread:this.props.thread,}),this.props.thread);}}
get message(){return this.props.message;}
get callInformation(){const history=this.message.call_history_ids[0];if(history?.duration_hour===undefined||!history?.end_dt){return _t("%(author)s started a call.",{author:this.message.authorName});}
let duration=luxon.Duration.fromObject({seconds:Math.max(1,Math.round(history.duration_hour*3600)),}).shiftTo("hours","minutes","seconds");if(duration.hours||duration.minutes){duration=duration.set({seconds:0});}
const units=Object.entries(duration.toObject()).filter(([unit,amount])=>amount!=0).map(([unit,amount])=>unit);return _t("Call lasted %(duration)s.",{duration:duration.shiftTo(...units).toHuman({unitDisplay:"short"}),});}}
return __exports;});;

/* /mail/static/src/core/common/notification_model.js */
odoo.define('@mail/core/common/notification_model',['@mail/core/common/record','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{fields,Record}=require("@mail/core/common/record");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const Notification=__exports.Notification=class Notification extends Record{static _name="mail.notification";static id="id";id;mail_message_id=fields.One("mail.message",{onDelete(){this.delete();},});notification_status;notification_type;mail_email_address;failure=fields.One("Failure",{inverse:"notifications",compute(){const thread=this.mail_message_id?.thread;if(!this.mail_message_id?.isSelfAuthored){return;}
const failure=Object.values(this.store.Failure.records).find((f)=>f.resModel===thread?.model&&f.type===this.notification_type&&(f.resModel!=="discuss.channel"||f.resIds.has(thread?.id)));return this.isFailure?{id:failure?failure.id:this.store.Failure.nextId.value++,}:false;},eager:true,});failure_type;get failureMessage(){switch(this.failure_type){case"mail_smtp":return _t("Connection failed");case"mail_bounce":return _t("Bounce");case"mail_email_invalid":return _t("Invalid email address");case"mail_email_missing":return _t("Missing email address");case"mail_from_invalid":return _t("Invalid from address");case"mail_from_missing":return _t("Missing from address");case"mail_spam":return _t("Detected As Spam");default:return _t("Exception");}}
res_partner_id=fields.One("res.partner");get autoCanceledFailureType(){switch(this.failure_type){case"mail_bl":return _t("Blacklisted Address");case"mail_dup":return _t("Duplicated Email");case"mail_optout":return _t("Opted Out");}
return"";}
get isFailure(){return["exception","bounce"].includes(this.notification_status);}
get icon(){if(this.isFailure){return"fa fa-envelope";}
return"fa fa-envelope-o";}
get label(){return"";}
get isFollowerNotification(){return this.mail_message_id.thread.followers.some((follower)=>follower.partner_id.id===this.res_partner_id.id);}
get statusIcon(){switch(this.notification_status){case"process":return"fa fa-hourglass-half";case"pending":return"fa fa-paper-plane-o";case"sent":return"fa fa-check";case"bounce":return"fa fa-exclamation";case"exception":return"fa fa-times text-danger";case"ready":return"fa fa-send-o";case"canceled":if(this.autoCanceledFailureType){return"fa fa-remove";}
return"fa fa-trash-o";}
return"";}
get statusTitle(){switch(this.notification_status){case"process":return _t("Processing");case"pending":return _t("Sent");case"sent":return _t("Delivered");case"bounce":return _t("Bounced");case"exception":return _t("Error");case"ready":return _t("Queued");case"canceled":return this.autoCanceledFailureType||_t("Cancelled");}
return"";}}
Notification.register();return __exports;});;

/* /mail/static/src/core/common/notification_permission_service.js */
odoo.define('@mail/core/common/notification_permission_service',['@odoo/owl','@web/core/browser/browser','@web/core/browser/feature_detection','@web/core/l10n/translation','@web/core/registry'],function(require){'use strict';let __exports={};const{reactive}=require("@odoo/owl");const{browser}=require("@web/core/browser/browser");const{isAndroidApp,isDisplayStandalone,isIOS,isIosApp,}=require("@web/core/browser/feature_detection");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{registry}=require("@web/core/registry");async function getIosPwaPermission(){if(browser.location.protocol!=="https:"){return"denied";}
const registration=await browser.navigator.serviceWorker?.getRegistration();return(await registration?.pushManager.permissionState())??"prompt";}
const notificationPermissionService=__exports.notificationPermissionService={dependencies:["notification"],_normalizePermission(permission){switch(permission){case"default":return"prompt";case undefined:return"denied";default:return permission;}},async start(env,services){const notification=services.notification;let permission;try{if(isIOS()&&isDisplayStandalone()){permission={state:await getIosPwaPermission()};}else if(isIOS()){permission={state:"denied"};}else{permission=await browser.navigator?.permissions?.query({name:"notifications",});}}catch{}
const state=reactive({permission:isIosApp()||isAndroidApp()?"denied":this._normalizePermission(permission?.state??browser.Notification?.permission),requestPermission:async()=>{if(browser.Notification&&state.permission==="prompt"){state.permission=this._normalizePermission(await browser.Notification.requestPermission());if(state.permission==="denied"){notification.add(_t("Odoo will not send notifications on this device."),{type:"warning",title:_t("Notifications blocked"),});}else if(state.permission==="granted"){notification.add(_t("Odoo will send notifications on this device!"),{type:"success",title:_t("Notifications allowed"),});}}},});if(permission&&!isIOS()){permission.addEventListener("change",()=>(state.permission=permission.state));}
return state;},};registry.category("services").add("mail.notification.permission",notificationPermissionService);return __exports;});;

/* /mail/static/src/core/common/out_of_focus_service.js */
odoo.define('@mail/core/common/out_of_focus_service',['@web/core/browser/browser','@web/core/l10n/translation','@web/core/registry'],function(require){'use strict';let __exports={};const{browser}=require("@web/core/browser/browser");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{registry}=require("@web/core/registry");const PREVIEW_MSG_MAX_SIZE=350;const OutOfFocusService=__exports.OutOfFocusService=class OutOfFocusService{constructor(env,services){this.setup(env,services);}
setup(env,services){this.env=env;this.audio=undefined;this.multiTab=services.multi_tab;this.notificationService=services.notification;this.soundEffectService=services["mail.sound_effects"];this.store=services["mail.store"];this.closeFuncs=[];}
async notify(message,thread){const modelsHandleByPush=["mail.thread","discuss.channel"];if(modelsHandleByPush.includes(message.thread?.model)&&(await this.hasServiceWorkInstalledAndPushSubscriptionActive())){return;}
const author=message.author;let notificationTitle;let icon="/mail/static/src/img/odoobot_transparent.png";if(!author){notificationTitle=_t("New message");}else{icon=author.avatarUrl;if(message.thread?.channel_type==="channel"){notificationTitle=_t("%(author name)s from %(channel name)s",{"author name":message.authorName,"channel name":message.thread.displayName,});}else{notificationTitle=message.authorName;}}
const notificationContent=message.previewText.toString().substring(0,PREVIEW_MSG_MAX_SIZE);await this.sendNotification({message:notificationContent,sound:message.thread?.model==="discuss.channel",title:notificationTitle,type:"info",icon,});}
async hasServiceWorkInstalledAndPushSubscriptionActive(){const registration=await browser.navigator.serviceWorker?.getRegistration();if(registration){const pushManager=await registration.pushManager;if(pushManager){const subscription=await pushManager.getSubscription();return!!subscription;}}
return false;}
async sendNotification({message,sound=true,title,type,icon}){if(!this.canSendNativeNotification||!(await this.multiTab.isOnMainTab())){if(sound){this._playSound();}
return;}
try{this.sendNativeNotification(title,message,icon,{sound});}catch(error){if(error.message.includes("ServiceWorkerRegistration")){this.sendOdooNotification(message,{sound,title,type});}else{throw error;}}}
async sendOdooNotification(message,options){const{sound}=options;delete options.sound;this.closeFuncs.push(this.notificationService.add(message,options));if(this.closeFuncs.length>3){this.closeFuncs.shift()();}
if(sound){this._playSound();}}
sendNativeNotification(title,message,icon,{sound=true}={}){const notification=new Notification(title,{body:message,icon,});notification.addEventListener("click",({target:notification})=>{window.focus();notification.close();});if(sound){this._playSound();}}
async _playSound(){if(this.canPlayAudio&&this.store.settings.messageSound&&(await this.multiTab.isOnMainTab())){this.soundEffectService.play("new-message");}}
get canPlayAudio(){return typeof Audio!=="undefined";}
get canSendNativeNotification(){return Boolean(window.Notification&&window.Notification.permission==="granted");}}
const outOfFocusService=__exports.outOfFocusService={dependencies:["multi_tab","notification","mail.sound_effects","mail.store"],start(env,services){const service=new OutOfFocusService(env,services);return service;},};registry.category("services").add("mail.out_of_focus",outOfFocusService);return __exports;});;

/* /mail/static/src/core/common/partner_compare.js */
odoo.define('@mail/core/common/partner_compare',['@mail/utils/common/format','@web/core/registry'],function(require){'use strict';let __exports={};const{cleanTerm}=require("@mail/utils/common/format");const{registry}=require("@web/core/registry");const partnerCompareRegistry=__exports.partnerCompareRegistry=registry.category("mail.partner_compare");partnerCompareRegistry.add("mail.archived-last-except-odoobot",(p1,p2)=>{const p1active=p1.active||p1.eq(p1.store.odoobot);const p2active=p2.active||p2.eq(p2.store.odoobot);if(!p1active&&p2active){return 1;}
if(!p2active&&p1active){return-1;}},{sequence:5});partnerCompareRegistry.add("mail.internal-users",(p1,p2)=>{const isAInternalUser=p1.main_user_id?.share===false;const isBInternalUser=p2.main_user_id?.share===false;if(isAInternalUser&&!isBInternalUser){return-1;}
if(!isAInternalUser&&isBInternalUser){return 1;}},{sequence:35});partnerCompareRegistry.add("mail.followers",(p1,p2,{thread})=>{if(thread){const followerList=[...thread.followers];if(thread.selfFollower){followerList.push(thread.selfFollower);}
const isFollower1=followerList.some((follower)=>p1.eq(follower.partner_id));const isFollower2=followerList.some((follower)=>p2.eq(follower.partner_id));if(isFollower1&&!isFollower2){return-1;}
if(!isFollower1&&isFollower2){return 1;}}},{sequence:45});partnerCompareRegistry.add("mail.name",(p1,p2,{searchTerm})=>{const cleanedName1=cleanTerm(p1.name);const cleanedName2=cleanTerm(p2.name);if(cleanedName1.startsWith(searchTerm)&&!cleanedName2.startsWith(searchTerm)){return-1;}
if(!cleanedName1.startsWith(searchTerm)&&cleanedName2.startsWith(searchTerm)){return 1;}
if(cleanedName1<cleanedName2){return-1;}
if(cleanedName1>cleanedName2){return 1;}},{sequence:50});partnerCompareRegistry.add("mail.email",(p1,p2,{searchTerm})=>{const cleanedEmail1=cleanTerm(p1.email);const cleanedEmail2=cleanTerm(p2.email);if(cleanedEmail1.startsWith(searchTerm)&&!cleanedEmail1.startsWith(searchTerm)){return-1;}
if(!cleanedEmail2.startsWith(searchTerm)&&cleanedEmail2.startsWith(searchTerm)){return 1;}
if(cleanedEmail1<cleanedEmail2){return-1;}
if(cleanedEmail1>cleanedEmail2){return 1;}},{sequence:55});partnerCompareRegistry.add("mail.id",(p1,p2)=>p1.id-p2.id,{sequence:75});return __exports;});;

/* /mail/static/src/core/common/plugin/mail_composer_plugin.js */
odoo.define('@mail/core/common/plugin/mail_composer_plugin',['@html_editor/plugin','@html_editor/utils/base_container','@html_editor/utils/dom_info','@html_editor/utils/dom_traversal','@html_editor/utils/resource'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{baseContainerGlobalSelector}=require("@html_editor/utils/base_container");const{isEmptyBlock}=require("@html_editor/utils/dom_info");const{childNodes}=require("@html_editor/utils/dom_traversal");const{withSequence}=require("@html_editor/utils/resource");const MailComposerPlugin=__exports.MailComposerPlugin=class MailComposerPlugin extends Plugin{static id="mail_composer";static dependencies=["clipboard","hint","input","selection"];resources={before_paste_handlers:this.config.composerPluginDependencies.onBeforePaste.bind(this),bypass_paste_image_files:()=>true,create_link_handlers:(linkEl)=>(linkEl.target="_blank"),hints:[withSequence(1,{selector:`.odoo-editor-editable > ${baseContainerGlobalSelector}:only-child`,text:this.config.placeholder,}),],hint_targets_providers:(selectionData,editable)=>{const el=editable.firstChild;if(!selectionData.documentSelectionIsInEditable&&childNodes(editable).length===1&&isEmptyBlock(el)&&el.matches(baseContainerGlobalSelector)){return[el];}else{return[];}},input_handlers:this.config.composerPluginDependencies.onInput.bind(this),};setup(){this.addDomListener(this.editable,"keydown",this.config.composerPluginDependencies.onKeydown);this.addDomListener(this.editable,"focusin",this.config.composerPluginDependencies.onFocusin);this.addDomListener(this.editable,"focusout",this.config.composerPluginDependencies.onFocusout);}}
return __exports;});;

/* /mail/static/src/core/common/plugin/mention_plugin.js */
odoo.define('@mail/core/common/plugin/mention_plugin',['@html_editor/plugin','@html_editor/utils/dom_traversal','@mail/utils/common/format'],function(require){'use strict';let __exports={};const{Plugin}=require("@html_editor/plugin");const{closestElement}=require("@html_editor/utils/dom_traversal");const{generateThreadMentionElement}=require("@mail/utils/common/format");const MentionPlugin=__exports.MentionPlugin=class MentionPlugin extends Plugin{static id="mention";static dependencies=["baseContainer","selection","history","protectedNode"];resources={selectionchange_handlers:this.detectMentions.bind(this),is_node_editable_predicates:(node)=>{for(const{selector}of this.MENTION_SELECTORS){if(closestElement(node,selector)){return true;}}},select_all_overrides:this.selectAll.bind(this),};setup(){super.setup();this.store=this.services["mail.store"];}
selectAll({anchorNode,anchorOffset,focusNode,focusOffset}){const SELECTOR=this.MENTION_SELECTORS.map(({selector})=>selector).join(", ");if(closestElement(anchorNode,SELECTOR)){const startMention=closestElement(anchorNode,SELECTOR);anchorNode=startMention.parentNode;anchorOffset=Array.prototype.indexOf.call(anchorNode.childNodes,startMention);}
if(closestElement(focusNode,SELECTOR)){const endMention=closestElement(focusNode,SELECTOR);focusNode=endMention.parentNode;focusOffset=Array.prototype.indexOf.call(focusNode.childNodes,endMention)+1;}
this.dependencies.selection.setSelection({anchorNode,anchorOffset,focusNode,focusOffset,});}
get MENTION_SELECTORS(){return[{selector:"a.o_channel_redirect",checker:(el)=>this.isValidChannelMentionElement(el),validMentionsHandler:(channelLinks)=>{this.store.handleValidChannelMention(channelLinks);this.dependencies.history.addStep();},},{selector:"a.o_mail_redirect",checker:(el)=>true,},{selector:"a.o-discuss-mention",checker:(el)=>true,},{selector:"a.o_mail_redirect",checker:()=>true,},{selector:"a.o-discuss-mention",checker:()=>true,},];}
async detectMentions(ev){for(const{selector,checker,validMentionsHandler}of this.MENTION_SELECTORS){const mentionLinks=Array.from(this.editable.querySelectorAll(selector))||[];const validMentionLinks=(await Promise.all(mentionLinks.map(async(el)=>({el,isValid:await checker(el),})))).filter(({isValid})=>isValid).map(({el})=>el);this.prepareValidMentionLinks(validMentionLinks);validMentionsHandler?.(validMentionLinks);}}
prepareValidMentionLinks(validMentionLinks){for(const el of validMentionLinks){this.dependencies.protectedNode.setProtectingNode(el,true);if(el.parentElement===this.editable){const baseContainer=this.dependencies.baseContainer.createBaseContainer();baseContainer.appendChild(el.cloneNode(true));this.editable.replaceChild(baseContainer,el);this.dependencies.history.addStep();}}}
async isValidChannelMentionElement(el){if(el.dataset.oeModel!=="discuss.channel"){return false;}
const channel=await this.store.Thread.getOrFetch({model:"discuss.channel",id:Number(el.dataset.oeId),});if(!channel){return false;}
const validChannelMention=generateThreadMentionElement(channel);return(validChannelMention.getAttribute("href")===el.getAttribute("href")&&[...validChannelMention.classList].every((cls)=>el.classList.contains(cls)));}}
return __exports;});;

/* /mail/static/src/core/common/plugin/plugin_sets.js */
odoo.define('@mail/core/common/plugin/plugin_sets',['@html_editor/main/chatgpt/chatgpt_translate_plugin','@html_editor/main/font/color_plugin','@html_editor/plugin_sets','@html_editor/main/feff_plugin','@html_editor/main/hint_plugin','@html_editor/main/inline_code','@html_editor/main/link/link_paste_plugin','@html_editor/main/link/link_plugin','@html_editor/core/shortcut_plugin','@html_editor/main/tabulation_plugin','@html_editor/main/toolbar/toolbar_plugin','@mail/core/common/plugin/mail_composer_plugin','@mail/core/common/plugin/mention_plugin','@html_editor/core/protected_node_plugin'],function(require){'use strict';let __exports={};const{ChatGPTTranslatePlugin}=require("@html_editor/main/chatgpt/chatgpt_translate_plugin");const{ColorPlugin}=require("@html_editor/main/font/color_plugin");const{CORE_PLUGINS}=require("@html_editor/plugin_sets");const{FeffPlugin}=require("@html_editor/main/feff_plugin");const{HintPlugin}=require("@html_editor/main/hint_plugin");const{InlineCodePlugin}=require("@html_editor/main/inline_code");const{LinkPastePlugin}=require("@html_editor/main/link/link_paste_plugin");const{LinkPlugin}=require("@html_editor/main/link/link_plugin");const{ShortCutPlugin}=require("@html_editor/core/shortcut_plugin");const{TabulationPlugin}=require("@html_editor/main/tabulation_plugin");const{ToolbarPlugin}=require("@html_editor/main/toolbar/toolbar_plugin");const{MailComposerPlugin}=require("@mail/core/common/plugin/mail_composer_plugin");const{MentionPlugin}=require("@mail/core/common/plugin/mention_plugin");const{ProtectedNodePlugin}=require("@html_editor/core/protected_node_plugin");const MAIL_CORE_PLUGINS=__exports.MAIL_CORE_PLUGINS=[...CORE_PLUGINS,ChatGPTTranslatePlugin,ColorPlugin,FeffPlugin,HintPlugin,InlineCodePlugin,LinkPastePlugin,LinkPlugin,MailComposerPlugin,MentionPlugin,ProtectedNodePlugin,ShortCutPlugin,TabulationPlugin,];const MAIL_PLUGINS=__exports.MAIL_PLUGINS=[...MAIL_CORE_PLUGINS,ToolbarPlugin];const MAIL_SMALL_UI_PLUGINS=__exports.MAIL_SMALL_UI_PLUGINS=MAIL_CORE_PLUGINS;return __exports;});;

/* /mail/static/src/core/common/quick_reaction_menu.js */
odoo.define('@mail/core/common/quick_reaction_menu',['@odoo/owl','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_hooks','@web/core/emoji_picker/emoji_picker','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Component,useExternalListener,useRef,useState}=require("@odoo/owl");const{Dropdown}=require("@web/core/dropdown/dropdown");const{useDropdownState}=require("@web/core/dropdown/dropdown_hooks");const{loadEmoji,useEmojiPicker}=require("@web/core/emoji_picker/emoji_picker");const{useService}=require("@web/core/utils/hooks");const QuickReactionMenu=__exports.QuickReactionMenu=class QuickReactionMenu extends Component{static template="mail.QuickReactionMenu";static props={action:Object,classNames:{type:Object,optional:true},message:Object,messageActive:{type:Boolean,optional:true},};static components={Dropdown};static DEFAULT_EMOJIS=["","","","","",""];setup(){this.toggle=useRef("toggle");this.store=useService("mail.store");this.ui=useService("ui");this.picker=useEmojiPicker(null,{onSelect:this.toggleReaction.bind(this),class:"overflow-hidden rounded-2"},{position:"bottom-middle",popoverClass:"o-mail-QuickReactionMenu-pickerPopover",});this.dropdown=useState(useDropdownState({onClose:()=>{const currentThread=this.env.getCurrentThread?.();if(!currentThread||currentThread.notEq(this.props.message.thread)){return;}
if(currentThread.messageInEdition){currentThread.messageInEdition.composer.autofocus++;}else{currentThread.composer.autofocus++;}},}));this.frequentEmojiService=useService("web.frequent.emoji");useExternalListener(window,"keydown",async(ev)=>{if(!this.dropdown.isOpen||this.picker.isOpen||!this.toggle.el?.contains(ev.target)||["Shift","Control","Meta","Alt"].includes(ev.key)){return;}
this.togglePicker(ev.key);});}
togglePicker(initialSearchTerm){if(this.picker.isOpen){this.picker.close();}else{this.picker.open(this.toggle,{initialSearchTerm});}}
getEmojiShortcode(emoji){return this.store.emojiLoader.loaded?.emojiValueToShortcodes?.[emoji]?.[0]??"?";}
onClick(){if(!this.store.emojiLoader.isLoaded){loadEmoji();}
if(this.ui.isSmall){this.props.action.onSelected();}else{this.picker.close();if(this.dropdown.isOpen){this.dropdown.close();}else{this.dropdown.open();}}}
toggleReaction(emoji){const reaction=this.props.message.reactions.find((r)=>r.content===emoji&&this.props.message.effectiveSelf.in(r.personas));if(reaction){reaction.remove();}else{this.props.message.react(emoji);this.frequentEmojiService.incrementEmojiUsage(emoji);}
this.dropdown.close();this.picker.close();}
get attClass(){const invisible=typeof this.props.messageActive==="boolean"&&!this.props.messageActive&&!this.dropdown.isOpen&&!this.picker.isOpen;return{...this.props.classNames,"o-open":this.dropdown.isOpen,invisible,visible:!invisible,};}
reactedBySelf(emoji){return this.props.message.reactions.some((r)=>r.content===emoji&&this.props.message.effectiveSelf.in(r.personas));}
get mostFrequentEmojis(){const numberOfEmojis=6;const mostFrequent=this.frequentEmojiService.getMostFrequent(numberOfEmojis);return mostFrequent.concat(QuickReactionMenu.DEFAULT_EMOJIS.filter((emoji)=>!mostFrequent.includes(emoji)).slice(0,Math.max(0,numberOfEmojis-mostFrequent.length)));}
get navigationOptions(){return{onUpdated:(navigator)=>{if(!navigator.activeItem){navigator.items[0]?.setActive();}},hotkeys:{arrowright:(navigator)=>navigator.next(),arrowleft:(navigator)=>navigator.previous(),arrowdown:null,arrowup:null,},};}}
return __exports;});;

/* /mail/static/src/core/common/record.js */
odoo.define('@mail/core/common/record',['@mail/model/export'],function(require){'use strict';let __exports={};Object.assign(__exports,require("@mail/model/export"));return __exports;});;

/* /mail/static/src/core/common/relative_time.js */
odoo.define('@mail/core/common/relative_time',['@odoo/owl','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{Component,onWillDestroy,onWillUpdateProps,xml}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const MINUTE=60*1000;const HOUR=60*MINUTE;const RelativeTime=__exports.RelativeTime=class RelativeTime extends Component{static props=["datetime"];static template=xml`<t t-esc="relativeTime"/>`;setup(){super.setup();this.timeout=null;this.computeRelativeTime(this.props.datetime);onWillDestroy(()=>clearTimeout(this.timeout));onWillUpdateProps((nextProps)=>{clearTimeout(this.timeout);this.computeRelativeTime(nextProps.datetime);});}
computeRelativeTime(datetime){if(!datetime){this.relativeTime="";return;}
const delta=Date.now()-datetime.ts;const absDelta=Math.abs(delta);if(absDelta<45*1000){this.relativeTime=delta<0?_t("in a few seconds"):_t("now");}else{this.relativeTime=datetime.toRelative();}
const updateDelay=absDelta<MINUTE?absDelta:absDelta<HOUR?MINUTE:HOUR;this.timeout=setTimeout(()=>{this.computeRelativeTime(this.props.datetime);this.render();},updateDelay);}}
return __exports;});;

/* /mail/static/src/core/common/res_company_model.js */
odoo.define('@mail/core/common/res_company_model',['@mail/core/common/record'],function(require){'use strict';let __exports={};const{Record}=require("@mail/core/common/record");const ResCompany=__exports.ResCompany=class ResCompany extends Record{static _name="res.company";static id="id";id;name;}
ResCompany.register();return __exports;});;

/* /mail/static/src/core/common/res_groups_model.js */
odoo.define('@mail/core/common/res_groups_model',['@mail/core/common/record'],function(require){'use strict';let __exports={};const{fields,Record}=require("@mail/core/common/record");const ResGroups=__exports.ResGroups=class ResGroups extends Record{static _name="res.groups";static id="id";full_name;partners=fields.Many("res.partner",{inverse:"group_ids"});privilege_id=fields.One("res.groups.privilege");}
ResGroups.register();return __exports;});;

/* /mail/static/src/core/common/res_groups_privilege_model.js */
odoo.define('@mail/core/common/res_groups_privilege_model',['@mail/core/common/record'],function(require){'use strict';let __exports={};const{Record}=require("@mail/core/common/record");const ResGroupsPrivilege=__exports.ResGroupsPrivilege=class ResGroupsPrivilege extends Record{static _name="res.groups.privilege";}
ResGroupsPrivilege.register();return __exports;});;

/* /mail/static/src/core/common/res_lang_model.js */
odoo.define('@mail/core/common/res_lang_model',['@mail/core/common/record'],function(require){'use strict';let __exports={};const{Record}=require("@mail/core/common/record");const ResLang=__exports.ResLang=class ResLang extends Record{static id="id";static _name="res.lang";id;name;}
ResLang.register();return __exports;});;

/* /mail/static/src/core/common/res_partner_model.js */
odoo.define('@mail/core/common/res_partner_model',['@mail/core/common/store_service','@mail/core/common/record','@web/core/utils/urls','@web/core/utils/timing'],function(require){'use strict';let __exports={};const{Store}=require("@mail/core/common/store_service");const{fields,Record}=require("@mail/core/common/record");const{imageUrl}=require("@web/core/utils/urls");const{debounce}=require("@web/core/utils/timing");const{DateTime}=luxon;const ResPartner=__exports.ResPartner=class ResPartner extends Record{static id="id";static _name="res.partner";static new(){const record=super.new(...arguments);record.debouncedSetImStatus=debounce((newStatus)=>record.updateImStatus(newStatus),Store.IM_STATUS_DEBOUNCE_DELAY);return record;}
_triggerPresenceSubscription=fields.Attr(null,{compute(){return this.monitorPresence&&this.presenceChannel;},onUpdate(){if(this.previousPresencechannel){this.store.env.services.bus_service.deleteChannel(this.previousPresencechannel);}
if(this._triggerPresenceSubscription){this.store.env.services.bus_service.addChannel(this.presenceChannel);}
this.previousPresencechannel=this.presenceChannel;},eager:true,});avatar_128_access_token;commercial_company_name;country_id=fields.One("res.country");debouncedSetImStatus;email;function;group_ids=fields.Many("res.groups",{inverse:"partners"});id;im_status=fields.Attr(null,{onUpdate(){if(this.eq(this.store.self_partner)&&this.im_status==="offline"){this.store.env.services.im_status.updateBusPresence();}},});im_status_access_token;is_company;is_public;main_user_id=fields.One("res.users");monitorPresence=fields.Attr(false,{compute(){if(!this.store.env.services.bus_service.isActive||this.id<=0){return false;}
return this.im_status!=="im_partner"&&!this.is_public;},});name;display_name;phone;offline_since=fields.Datetime();presenceChannel=fields.Attr(null,{compute(){const channel=`odoo-presence-res.partner_${this.id}`;if(this.im_status_access_token){return channel+`-${this.im_status_access_token}`;}
return channel;},});previousPresencechannel;write_date=fields.Datetime();_computeDisplayName(){return this.name||this.display_name;}
get avatarUrl(){const accessTokenParam={};if(this.store.self.main_user_id?.share!==false){accessTokenParam.access_token=this.avatar_128_access_token;}
return imageUrl("res.partner",this.id,"avatar_128",{...accessTokenParam,unique:this.write_date,});}
get displayName(){return this._computeDisplayName();}
searchChat(){return Object.values(this.store.Thread.records).find((thread)=>thread.channel_type==="chat"&&thread.correspondent?.persona.eq(this));}
updateImStatus(newStatus){if(newStatus==="offline"){this.offline_since=DateTime.now();}
this.im_status=newStatus;}}
ResPartner.register();return __exports;});;

/* /mail/static/src/core/common/res_role_model.js */
odoo.define('@mail/core/common/res_role_model',['@mail/core/common/record'],function(require){'use strict';let __exports={};const{Record}=require("@mail/core/common/record");const ResRole=__exports.ResRole=class ResRole extends Record{static id="id";static _name="res.role";id;name;}
ResRole.register();return __exports;});;

/* /mail/static/src/core/common/res_users_model.js */
odoo.define('@mail/core/common/res_users_model',['@mail/core/common/record'],function(require){'use strict';let __exports={};const{fields,Record}=require("@mail/core/common/record");const ResUsers=__exports.ResUsers=class ResUsers extends Record{static _name="res.users";static id="id";id;company_id=fields.One("res.company");get email(){return this.partner_id?.email;}
im_status;is_admin;get name(){return this.partner_id?.name;}
notification_type;partner_id=fields.One("res.partner");get phone(){return this.partner_id?.phone;}
share;signature=fields.Html(undefined);}
ResUsers.register();return __exports;});;

/* /mail/static/src/core/common/search_message_input.js */
odoo.define('@mail/core/common/search_message_input',['@odoo/owl','@web/core/browser/browser','@web/core/utils/hooks','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_item','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{Component,useExternalListener,useState}=require("@odoo/owl");const{browser}=require("@web/core/browser/browser");const{useAutofocus}=require("@web/core/utils/hooks");const{Dropdown}=require("@web/core/dropdown/dropdown");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const SearchMessageInput=__exports.SearchMessageInput=class SearchMessageInput extends Component{static template="mail.SearchMessageInput";static props=["closeSearch?","messageSearch","thread"];static components={Dropdown,DropdownItem};setup(){super.setup();this.state=useState({searchTerm:"",searchedTerm:""});useAutofocus();useExternalListener(browser,"keydown",(ev)=>{if(ev.key==="Escape"){this.props.closeSearch?.();}},{capture:true});}
search(){this.props.messageSearch.searchTerm=this.state.searchTerm;this.props.messageSearch.search();this.state.searchedTerm=this.state.searchTerm;}
clear(){this.state.searchTerm="";this.state.searchedTerm=this.state.searchTerm;this.props.messageSearch.clear();this.props.closeSearch?.();}
onKeydownSearch(ev){if(ev.key!=="Enter"){return;}
if(!this.state.searchTerm){this.clear();}else{this.search();}}
onChangeSearchFilter(searchFilter){if(searchFilter.is_notification!==this.props.messageSearch.is_notification){this.props.messageSearch.is_notification=searchFilter.is_notification;if(this.state.searchTerm){this.search();}}}
get searchFilters(){return[{label:"all",name:_t("All"),is_notification:undefined,},{label:"conversations",name:_t("Conversations"),is_notification:false,},{label:"tracked_changes",name:_t("Tracked Changes"),is_notification:true,},];}}
return __exports;});;

/* /mail/static/src/core/common/search_message_result.js */
odoo.define('@mail/core/common/search_message_result',['@odoo/owl','@mail/core/common/message_card_list','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const{MessageCardList}=require("@mail/core/common/message_card_list");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const SearchMessageResult=__exports.SearchMessageResult=class SearchMessageResult extends Component{static template="mail.SearchMessageResult";static components={MessageCardList};static props=["thread","messageSearch","onClickJump?"];get MESSAGE_FOUND(){if(this.props.messageSearch.messages.length===0){return false;}
return _t("%s messages found",this.props.messageSearch.count);}
onLoadMoreVisible(){const before=this.props.messageSearch?.messages?Math.min(...this.props.messageSearch.messages.map((message)=>message.id)):false;this.props.messageSearch.search(before);}}
return __exports;});;

/* /mail/static/src/core/common/search_messages_panel.js */
odoo.define('@mail/core/common/search_messages_panel',['@odoo/owl','@mail/discuss/core/common/action_panel','@web/core/l10n/translation','@web/core/utils/hooks','@mail/core/common/search_message_input','@mail/core/common/search_message_result','@mail/core/common/message_search_hook'],function(require){'use strict';let __exports={};const{Component,onWillUpdateProps}=require("@odoo/owl");const{ActionPanel}=require("@mail/discuss/core/common/action_panel");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{useService}=require("@web/core/utils/hooks");const{SearchMessageInput}=require("@mail/core/common/search_message_input");const{SearchMessageResult}=require("@mail/core/common/search_message_result");const{useMessageSearch}=require("@mail/core/common/message_search_hook");const SearchMessagesPanel=__exports.SearchMessagesPanel=class SearchMessagesPanel extends Component{static template="mail.SearchMessagesPanel";static components={ActionPanel,SearchMessageInput,SearchMessageResult};static props=["thread"];setup(){super.setup();this.store=useService("mail.store");this.messageSearch=this.env.messageSearch??useMessageSearch(this.props.thread);onWillUpdateProps((nextProps)=>{if(this.props.thread.notEq(nextProps.thread)){this.env.searchMenu?.close();}});}
get title(){return _t("Search Message");}}
return __exports;});;

/* /mail/static/src/core/common/settings_model.js */
odoo.define('@mail/core/common/settings_model',['@mail/utils/common/misc','@web/core/l10n/translation','@web/core/browser/browser','@mail/core/common/record','@web/core/utils/timing','@web/core/network/rpc'],function(require){'use strict';let __exports={};const{hasHardwareAcceleration}=require("@mail/utils/common/misc");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{browser}=require("@web/core/browser/browser");const{fields,Record}=require("@mail/core/common/record");const{debounce}=require("@web/core/utils/timing");const{rpc}=require("@web/core/network/rpc");const MESSAGE_SOUND="mail.user_setting.message_sound";const Settings=__exports.Settings=class Settings extends Record{id;static new(){const record=super.new(...arguments);record.onStorage=record.onStorage.bind(record);browser.addEventListener("storage",record.onStorage);return record;}
setup(){super.setup();this.saveVoiceThresholdDebounce=debounce(()=>{browser.localStorage.setItem("mail_user_setting_voice_threshold",this.voiceActivationThreshold.toString());},2000);this.hasCanvasFilterSupport=typeof document.createElement("canvas").getContext("2d").filter!=="undefined";this._loadLocalSettings();}
delete(){browser.removeEventListener("storage",this.onStorage);super.delete(...arguments);}
channel_notifications=fields.Attr("mentions",{compute(){return this.channel_notifications===false?"mentions":this.channel_notifications;},});messageSound=fields.Attr(true,{compute(){return browser.localStorage.getItem(MESSAGE_SOUND)!=="false";},onUpdate(){if(this.messageSound){browser.localStorage.removeItem(MESSAGE_SOUND);}else{browser.localStorage.setItem(MESSAGE_SOUND,"false");}},});useCallAutoFocus=fields.Attr(true,{compute(){return!browser.localStorage.getItem("mail_user_setting_disable_call_auto_focus");},onUpdate(){if(this.useCallAutoFocus){browser.localStorage.removeItem("mail_user_setting_disable_call_auto_focus");return;}
browser.localStorage.setItem("mail_user_setting_disable_call_auto_focus","true");},});audioInputDeviceId="";audioOutputDeviceId="";cameraInputDeviceId="";use_push_to_talk=false;voice_active_duration=200;volumes=fields.Many("Volume");volumeSettingsTimeouts=new Map();voiceActivationThreshold=0.05;isRegisteringKey=false;push_to_talk_key;backgroundBlurAmount=10;edgeBlurAmount=10;showOnlyVideo=false;useBlur=fields.Attr(false,{compute(){return browser.localStorage.getItem("mail_user_setting_use_blur")==="true";},onUpdate(){if(this.useBlur){browser.localStorage.setItem("mail_user_setting_use_blur","true");}else{browser.localStorage.removeItem("mail_user_setting_use_blur");}},});blurPerformanceWarning=fields.Attr(false,{compute(){const rtc=this.store.rtc;if(!rtc||!this.useBlur){return false;}
return this.useBlur&&rtc.state?.cameraTrack&&!hasHardwareAcceleration();},});cameraFacingMode=undefined;logRtc=false;get audioConstraints(){const constraints={echoCancellation:true,noiseSuppression:true,};if(this.audioInputDeviceId){constraints.deviceId=this.audioInputDeviceId;}
return constraints;}
get cameraConstraints(){const constraints={width:1280,};if(this.cameraFacingMode){constraints.facingMode=this.cameraFacingMode;}else if(this.cameraInputDeviceId){constraints.deviceId=this.cameraInputDeviceId;}
return constraints;}
get NOTIFICATIONS(){return[{label:"all",name:_t("All Messages"),},{label:"mentions",name:_t("Mentions Only"),},{label:"no_notif",name:_t("Nothing"),},];}
get MUTES(){return[{label:"15_mins",value:15,name:_t("For 15 minutes"),},{label:"1_hour",value:60,name:_t("For 1 hour"),},{label:"3_hours",value:180,name:_t("For 3 hours"),},{label:"8_hours",value:480,name:_t("For 8 hours"),},{label:"24_hours",value:1440,name:_t("For 24 hours"),},{label:"forever",value:-1,name:_t("Until I turn it back on"),},];}
getMuteUntilText(dt){if(dt){return dt.year<=luxon.DateTime.now().year+2?_t(`Until %s`,dt.toLocaleString(luxon.DateTime.DATETIME_MED)):_t("Until I turn it back on");}
return undefined;}
async setCustomNotifications(custom_notifications,thread=undefined){return rpc("/discuss/settings/custom_notifications",{custom_notifications:!thread&&custom_notifications==="mentions"?false:custom_notifications,channel_id:thread?.id,});}
async setMuteDuration(minutes,thread=undefined){return rpc("/discuss/settings/mute",{minutes,channel_id:thread?.id,});}
async setAudioInputDevice(audioInputDeviceId){this.audioInputDeviceId=audioInputDeviceId;browser.localStorage.setItem("mail_user_setting_audio_input_device_id",audioInputDeviceId);}
async setAudioOutputDevice(audioOutputDeviceId){this.audioOutputDeviceId=audioOutputDeviceId;browser.localStorage.setItem("mail_user_setting_audio_output_device_id",audioOutputDeviceId);}
async setCameraInputDevice(cameraInputDeviceId){this.cameraFacingMode=undefined;this.cameraInputDeviceId=cameraInputDeviceId;browser.localStorage.setItem("mail_user_setting_camera_input_device_id",cameraInputDeviceId);}
setDelayValue(value){this.voice_active_duration=parseInt(value,10);this._saveSettings();}
async setPushToTalkKey(ev){const nonElligibleKeys=new Set(["Shift","Control","Alt","Meta"]);let pushToTalkKey=`${ev.shiftKey || ""}.${ev.ctrlKey || ev.metaKey || ""}.${
            ev.altKey || ""
        }`;if(!nonElligibleKeys.has(ev.key)){pushToTalkKey+=`.${ev.key === " " ? "Space" : ev.key}`;}
this.push_to_talk_key=pushToTalkKey;this._saveSettings();}
async saveVolumeSetting({partnerId,guestId,volume}){if(!this.store.self_partner){return;}
const key=`${partnerId}_${guestId}`;if(this.volumeSettingsTimeouts.get(key)){browser.clearTimeout(this.volumeSettingsTimeouts.get(key));}
this.volumeSettingsTimeouts.set(key,browser.setTimeout(this._onSaveVolumeSettingTimeout.bind(this,{key,partnerId,guestId,volume}),5000));}
setThresholdValue(voiceActivationThreshold){this.voiceActivationThreshold=voiceActivationThreshold;this.saveVoiceThresholdDebounce();}
buildKeySet({shiftKey,ctrlKey,altKey,key}){const keys=new Set();if(key){keys.add(key==="Meta"?"Alt":key);}
if(shiftKey){keys.add("Shift");}
if(ctrlKey){keys.add("Control");}
if(altKey){keys.add("Alt");}
return keys;}
isPushToTalkKey(ev){if(!this.use_push_to_talk||!this.push_to_talk_key){return false;}
const[shiftKey,ctrlKey,altKey,key]=this.push_to_talk_key.split(".");const settingsKeySet=this.buildKeySet({shiftKey,ctrlKey,altKey,key});const eventKeySet=this.buildKeySet({shiftKey:ev.shiftKey,ctrlKey:ev.ctrlKey,altKey:ev.altKey,key:ev.key,});if(ev.type==="keydown"){return[...settingsKeySet].every((key)=>eventKeySet.has(key));}
return settingsKeySet.has(ev.key==="Meta"?"Alt":ev.key);}
pushToTalkKeyFormat(){if(!this.push_to_talk_key){return;}
const[shiftKey,ctrlKey,altKey,key]=this.push_to_talk_key.split(".");return{shiftKey:!!shiftKey,ctrlKey:!!ctrlKey,altKey:!!altKey,key:key||false,};}
setPushToTalk(value){this.use_push_to_talk=value;this._saveSettings();}
_loadLocalSettings(){const voiceActivationThresholdString=browser.localStorage.getItem("mail_user_setting_voice_threshold");this.voiceActivationThreshold=voiceActivationThresholdString?parseFloat(voiceActivationThresholdString):this.voiceActivationThreshold;this.audioInputDeviceId=browser.localStorage.getItem("mail_user_setting_audio_input_device_id");this.audioOutputDeviceId=browser.localStorage.getItem("mail_user_setting_audio_output_device_id");this.cameraInputDeviceId=browser.localStorage.getItem("mail_user_setting_camera_input_device_id");this.showOnlyVideo=browser.localStorage.getItem("mail_user_setting_show_only_video")==="true";const backgroundBlurAmount=browser.localStorage.getItem("mail_user_setting_background_blur_amount");this.backgroundBlurAmount=backgroundBlurAmount?parseInt(backgroundBlurAmount):10;const edgeBlurAmount=browser.localStorage.getItem("mail_user_setting_edge_blur_amount");this.edgeBlurAmount=edgeBlurAmount?parseInt(edgeBlurAmount):10;this.useCallAutoFocus=!browser.localStorage.getItem("mail_user_setting_disable_call_auto_focus");}
async _onSaveGlobalSettingsTimeout(){this.globalSettingsTimeout=undefined;await this.store.env.services.orm.call("res.users.settings","set_res_users_settings",[[this.id]],{new_settings:{push_to_talk_key:this.push_to_talk_key,use_push_to_talk:this.use_push_to_talk,voice_active_duration:this.voice_active_duration,},});}
async _onSaveVolumeSettingTimeout({key,partnerId,guestId,volume}){this.volumeSettingsTimeouts.delete(key);await this.store.env.services.orm.call("res.users.settings","set_volume_setting",[[this.id],partnerId,volume],{guest_id:guestId});}
onStorage(ev){if(ev.key===MESSAGE_SOUND){this.messageSound=ev.newValue!=="false";}
if(ev.key==="mail_user_setting_use_blur"){this.useBlur=ev.newValue==="true";}}
async _saveSettings(){if(!this.store.self_partner){return;}
browser.clearTimeout(this.globalSettingsTimeout);this.globalSettingsTimeout=browser.setTimeout(()=>this._onSaveGlobalSettingsTimeout(),2000);}}
Settings.register();return __exports;});;

/* /mail/static/src/core/common/sound_effects_service.js */
odoo.define('@mail/core/common/sound_effects_service',['@web/core/browser/browser','@web/core/registry','@web/core/utils/urls'],function(require){'use strict';let __exports={};const{browser}=require("@web/core/browser/browser");const{registry}=require("@web/core/registry");const{url}=require("@web/core/utils/urls");const SoundEffects=__exports.SoundEffects=class SoundEffects{constructor(env){this.soundEffects={"call-join":{defaultVolume:0.75,path:"/mail/static/src/audio/call-join"},"call-leave":{defaultVolume:0.75,path:"/mail/static/src/audio/call-leave"},"earphone-off":{defaultVolume:0.15,path:"/mail/static/src/audio/earphone-off"},"earphone-on":{defaultVolume:0.15,path:"/mail/static/src/audio/earphone-on"},"mic-off":{defaultVolume:0.2,path:"/mail/static/src/audio/mic-off"},"mic-on":{defaultVolume:0.2,path:"/mail/static/src/audio/mic-on"},"ptt-press":{defaultVolume:0.1,path:"/mail/static/src/audio/ptt-press"},"ptt-release":{defaultVolume:0.1,path:"/mail/static/src/audio/ptt-release"},"call-invitation":{defaultVolume:0.5,path:"/mail/static/src/audio/call-invitation",},"new-message":{defaultVolume:1,path:"/mail/static/src/audio/new-message"},"screen-sharing":{defaultVolume:0.75,path:"/mail/static/src/audio/screen-sharing",},"member-leave":{defaultVolume:0.5,path:"/mail/static/src/audio/channel_01_out"},};}
play(soundEffectName,{loop=false,volume}={}){if(typeof browser.Audio==="undefined"){return;}
const soundEffect=this.soundEffects[soundEffectName];if(!soundEffect){return;}
if(!soundEffect.audio){const audio=new browser.Audio();const ext=audio.canPlayType("audio/ogg; codecs=vorbis")?".ogg":".mp3";audio.src=url(soundEffect.path+ext);soundEffect.audio=audio;}
if(!soundEffect.audio.paused){soundEffect.audio.pause();}
soundEffect.audio.currentTime=0;soundEffect.audio.loop=loop;soundEffect.audio.volume=volume??soundEffect.defaultVolume??1;Promise.resolve(soundEffect.audio.play()).catch(()=>{});}
stop(soundEffectName){const soundEffect=this.soundEffects[soundEffectName];if(soundEffect){if(soundEffect.audio){soundEffect.audio.pause();soundEffect.audio.currentTime=0;}}else{for(const soundEffect of Object.values(this.soundEffects)){if(soundEffect.audio){soundEffect.audio.pause();soundEffect.audio.currentTime=0;}}}}}
const soundEffects=__exports.soundEffects={start(env){return new SoundEffects(env);},};registry.category("services").add("mail.sound_effects",soundEffects);return __exports;});;

/* /mail/static/src/core/common/store_service.js */
odoo.define('@mail/core/common/store_service',['@mail/core/common/record','@mail/core/common/thread_compare','@mail/utils/common/format','@mail/utils/common/misc','@odoo/owl','@web/core/l10n/translation','@web/core/network/rpc','@web/core/registry','@web/core/user','@web/core/utils/concurrency','@web/core/utils/render','@web/core/utils/timing','@web/session','@web/core/browser/browser','@web/core/emoji_picker/emoji_picker','@web/core/utils/patch','@web/core/browser/feature_detection','@web/core/utils/urls','@web/core/browser/cookie'],function(require){'use strict';let __exports={};const{Store:BaseStore,fields,makeStore,storeInsertFns}=require("@mail/core/common/record");const{threadCompareRegistry}=require("@mail/core/common/thread_compare");const{cleanTerm,generateEmojisOnHtml,prettifyMessageText}=require("@mail/utils/common/format");const{compareDatetime}=require("@mail/utils/common/misc");const{reactive}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{rpc}=require("@web/core/network/rpc");const{registry}=require("@web/core/registry");const{user}=require("@web/core/user");const{Deferred,Mutex}=require("@web/core/utils/concurrency");const{renderToElement}=require("@web/core/utils/render");const{debounce}=require("@web/core/utils/timing");const{session}=require("@web/session");const{browser}=require("@web/core/browser/browser");const{loader}=require("@web/core/emoji_picker/emoji_picker");const{patch}=require("@web/core/utils/patch");const{isMobileOS}=require("@web/core/browser/feature_detection");const{getOrigin}=require("@web/core/utils/urls");const{cookie}=require("@web/core/browser/cookie");let prevLastMessageId=null;let temporaryIdOffset=0.01;const pyToJsModels=__exports.pyToJsModels={"discuss.channel":"Thread","mail.thread":"Thread",};const addFieldsByPyModel=__exports.addFieldsByPyModel={"discuss.channel":{model:"discuss.channel"},};patch(storeInsertFns,{makeContext(store){if(!(store instanceof Store)){return super.makeContext(...arguments);}
return{pyModels:Object.values(pyToJsModels)};},getActualModelName(store,ctx,pyOrJsModelName){if(!(store instanceof Store)){return super.getActualModelName(...arguments);}
if(ctx.pyModels.includes(pyOrJsModelName)){console.warn(`store.insert() should receive the python model name instead of ${pyOrJsModelName}.`);}
return pyToJsModels[pyOrJsModelName]||pyOrJsModelName;},getExtraFieldsFromModel(store,pyOrJsModelName){if(!(store instanceof Store)){return super.getExtraFieldsFromModel(...arguments);}
return addFieldsByPyModel[pyOrJsModelName];},});const Store=__exports.Store=class Store extends BaseStore{static FETCH_DATA_DEBOUNCE_DELAY=1;static OTHER_LONG_TYPING=60000;static IM_STATUS_DEBOUNCE_DELAY=1000;FETCH_LIMIT=30;DEFAULT_AVATAR="/mail/static/src/img/smiley/avatar.jpg";isReady=new Deferred();self_partner=fields.One("res.partner");self_guest=fields.One("mail.guest");get self(){return this.self_partner||this.self_guest;}
allChannels=fields.Many("Thread",{inverse:"storeAsAllChannels",onUpdate(){const busService=this.store.env.services.bus_service;if(!busService.isActive&&this.allChannels.some((t)=>!t.isTransient)){busService.start();}},});inPublicPage=false;odoobot=fields.One("res.partner");useMobileView=fields.Attr(undefined,{compute(){return this.store.env.services.ui.isSmall||isMobileOS();},});users={};internalUserGroupId;mt_comment=fields.One("mail.message.subtype");mt_note=fields.One("mail.message.subtype");hasMessageTranslationFeature;hasLinkPreviewFeature=true;menu={counter:0};chatHub=fields.One("ChatHub",{compute:()=>({})});failures=fields.Many("Failure",{sort:(f1,f2)=>f2.lastMessage?.id-f1.lastMessage?.id,});settings=fields.One("Settings");emojiLoader=loader;fetchParams=[];fetchReadonly=true;fetchSilent=true;cannedReponses=this.makeCachedFetchData("mail.canned.response");specialMentions=[{isSpecial:true,label:"everyone",channel_types:["channel","group"],displayName:"Everyone",description:_t("Notify everyone"),},];isNotificationPermissionDismissed=fields.Attr(false,{compute(){return(browser.localStorage.getItem("mail.user_setting.push_notification_dismissed")==="true");},onUpdate(){if(this.isNotificationPermissionDismissed){browser.localStorage.setItem("mail.user_setting.push_notification_dismissed","true");}else{browser.localStorage.removeItem("mail.user_setting.push_notification_dismissed");}},});messagePostMutex=new Mutex();menuThreads=fields.Many("Thread",{compute(){const searchTerm=cleanTerm(this.discuss.searchTerm);let threads=Object.values(this.Thread.records).filter((thread)=>(thread.displayToSelf||(thread.needactionMessages.length>0&&thread.model!=="mail.box"))&&cleanTerm(thread.displayName).includes(searchTerm));const tab=this.discuss.activeTab;if(tab==="inbox"){threads=threads.filter(({channel_type})=>this.tabToThreadType("mailbox").includes(channel_type));}else if(tab==="starred"){threads=[this.starred];}else if(tab!=="notification"){threads=threads.filter(({channel_type})=>this.tabToThreadType(tab).includes(channel_type));}
return threads;},sort(thread1,thread2){const compareFunctions=threadCompareRegistry.getAll();for(const fn of compareFunctions){const result=fn(thread1,thread2);if(result!==undefined){return result;}}
return thread2.localId>thread1.localId?1:-1;},});shouldSimulateDarkTheme(ctx){return((ctx?.env?.inDiscussCallView||ctx?.env?.inCallInvitation||ctx?.env.isDiscussPipBanner||ctx?.env?.inWelcomePage)&&this.isOdooWhiteTheme&&!ctx?.env.inMeetingSideActions&&!ctx?.env.inDiscussActionPanel);}
discussDropdownMenuClass(ctx){const res=["o-discuss-dropdownMenu","d-flex","flex-column","border-secondary"];if(this.shouldSimulateDarkTheme(ctx)){res.push("o-simulateDarkTheme");}
return res.join(" ");}
standaloneInboxMessages=fields.Many("mail.message",{compute(){const messages=(this.store.inbox?.messages??[]).filter((m)=>!m.thread);return messages.sort((m1,m2)=>compareDatetime(m2.datetime,m1.datetime)||m2.id-m1.id);},});async doMessagePost(params,tmpMessage){return this.messagePostMutex.exec(async()=>{let res;try{res=await rpc("/mail/message/post",params,{silent:true});}catch(err){if(!tmpMessage){throw err;}
tmpMessage.postFailRedo=()=>{tmpMessage.postFailRedo=undefined;tmpMessage.thread.messages.delete(tmpMessage);tmpMessage.thread.messages.add(tmpMessage);this.doMessagePost(params,tmpMessage);};}
return res;});}
async fetchStoreData(name,params,{requestData=false,readonly=true,silent=true}={}){const dataRequest=this.DataResponse.createRequest();dataRequest._autoResolve=!requestData;this.fetchParams.push([name,params,dataRequest]);this.fetchReadonly=this.fetchReadonly&&readonly;this.fetchSilent=this.fetchSilent&&silent;this._fetchStoreDataDebounced();return dataRequest._resultDef;}
async initialize(){await this.fetchStoreData("init_messaging");this.isReady.resolve();}
makeCachedFetchData(name,params){let def=null;const r=reactive({status:"not_fetched",fetch:()=>{if(["fetching","fetched"].includes(r.status)){return def;}
r.status="fetching";def=new Deferred();this.fetchStoreData(name,params).then((result)=>{r.status="fetched";def.resolve(result);},(error)=>{r.status="not_fetched";def.reject(error);});return def;},});return r;}
_fetchStoreDataDebounced(){const fetchParams=this.fetchParams;this._fetchStoreDataRpc(fetchParams.map(([name,params,dataRequest])=>{if(dataRequest._autoResolve){if(params!==undefined){return[name,params];}else{return name;}}else{return[name,params,dataRequest.id];}})).then((data)=>{this.insert(data);for(const[,,dataRequest]of fetchParams){if(dataRequest._autoResolve){dataRequest._resolve=true;}}},(error)=>{for(const[,,dataRequest]of fetchParams){dataRequest._resultDef.reject(error);}});this.fetchParams=[];this.fetchReadonly=true;this.fetchSilent=true;}
_fetchStoreDataRpc(fetchParams){return rpc(this.fetchReadonly?"/mail/data":"/mail/action",{fetch_params:fetchParams,context:user.context},{silent:this.fetchSilent});}
async startMeeting(){const thread=await this.createGroupChat({default_display_mode:"video_full_screen",partners_to:[this.self.id],});await this.store.chatHub.initPromise;this.ChatWindow.get(thread)?.update({autofocus:0});await this.env.services["discuss.rtc"].toggleCall(thread,{camera:true});if(this.rtc.selfSession){this.rtc.enterFullscreen({autoOpenAction:"invite-people"});}}
tabToThreadType(tab){return tab==="chat"?["chat","group"]:[tab];}
handleClickOnLink(ev,thread){const link=ev.target.closest("a");if(!link){return;}
const model=link.dataset.oeModel;const id=Number(link.dataset.oeId);if(link.classList.contains("o_channel_redirect")&&model&&id){ev.preventDefault();this.Thread.getOrFetch({model,id}).then((thread)=>{if(thread){thread.open({focus:true});}else{this.env.services.notification.add(_t("This thread is no longer available."),{type:"danger",});}});return true;}else if(link.classList.contains("o_mail_redirect")&&id){ev.preventDefault();this.onClickPartnerMention(ev,id);return true;}else if(link.classList.contains("o_message_redirect")){const message=this["mail.message"].get(id);const targetThread=message?.thread;const showAccessError=()=>this.env.services.notification.add(_t("This conversation isnt available."),{type:"danger",});if(targetThread){targetThread.checkReadAccess().then((hasAccess)=>{if(hasAccess){targetThread.highlightMessage=message;let isOpen=targetThread.eq(thread);if(!isOpen){isOpen=targetThread.open({focus:true,swapOpened:false});}
if(!isOpen){window.open(link.href);}}else{if(this.self_partner){showAccessError();}else{window.open(link.href);}}});ev.preventDefault();return true;}else if(link.getAttribute("href")?.startsWith(getOrigin())){showAccessError();ev.preventDefault();return true;}}
return false;}
setup(){super.setup();this._fetchStoreDataDebounced=debounce(this._fetchStoreDataDebounced,Store.FETCH_DATA_DEBOUNCE_DELAY);}
onStarted(){this.isOdooWhiteTheme=cookie.get("color_scheme")!=="dark"||this.inPublicPage;navigator.serviceWorker?.addEventListener("message",({data={}})=>{const{type,payload}=data;if(type==="notification-display-request"){const{correlationId,model,res_id}=payload;const thread=this.Thread.get({model,id:res_id});let isTabFocused;try{isTabFocused=parent.document.hasFocus();}catch{}
const isInbox=this.store.self.main_user_id?.notification_type==="inbox"&&model!=="discuss.channel";if((isTabFocused&&thread?.isDisplayed)||isInbox){navigator.serviceWorker.controller?.postMessage({type:"notification-display-response",payload:{correlationId},});}}
if(type==="notification-displayed"){this.onPushNotificationDisplayed(payload);}});}
onPushNotificationDisplayed(payload){if(["mail.thread","discuss.channel"].includes(payload.model)){this.env.services["mail.out_of_focus"]._playSound();}}
async getChat({userId,partnerId}){const partner=await this.getPartner({userId,partnerId});if(!partner){return;}
let chat=partner.searchChat();if(!chat?.self_member_id?.is_pinned){chat=await this.joinChat(partner.id);}
if(!chat){this.env.services.notification.add(_t("An unexpected error occurred during the creation of the chat."),{type:"warning"});return;}
return chat;}
fillPartnersMentionToken(postData){postData.partner_ids_mention_token||={};for(const pid of postData.partner_ids){const partner=this["res.partner"].get(pid);if(partner?.mention_token){postData.partner_ids_mention_token[pid]=partner.mention_token;}}}
getLastMessageId(){return Object.values(this["mail.message"].records).reduce((lastMessageId,message)=>Math.max(lastMessageId,message.id),0);}
handleValidChannelMention(channelLinks){for(const linkEl of channelLinks.filter((el)=>!el.querySelector(".fa-comments-o, .fa-hashtag"))){const text=linkEl.textContent.substring(1);const icon=linkEl.classList.contains("o_channel_redirect_asThread")?"fa fa-comments-o":"fa fa-hashtag";const iconEl=renderToElement("mail.Message.mentionedChannelIcon",{icon});linkEl.replaceChildren(iconEl);linkEl.insertAdjacentText("beforeend",` ${text}`);}}
getMentionsFromText(body,{mentionedChannels=[],mentionedPartners=[],mentionedRoles=[],thread}={}){const validMentions={};validMentions.threads=mentionedChannels.filter((thread)=>{if(thread.parent_channel_id){return body.includes(`#${thread.parent_channel_id.displayName} > ${thread.displayName}`);}
return body.includes(`#${thread.displayName}`);});validMentions.partners=mentionedPartners.filter((partner)=>body.includes(`@${thread?.getPersonaName(partner) ?? partner.name}`));validMentions.roles=mentionedRoles.filter((role)=>body.includes(`@${role.name}`));validMentions.specialMentions=this.specialMentions.filter((special)=>body.includes(`@${special.label}`)).map((special)=>special.label);return validMentions;}
async getMessagePostParams({body,postData,thread}){const{attachments,cannedResponseIds,emailAddSignature,isNote,mentionedChannels,mentionedPartners,mentionedRoles,}=postData;const subtype=isNote?"mail.mt_note":"mail.mt_comment";const validMentions=this.getMentionsFromText(body,{mentionedChannels,mentionedPartners,mentionedRoles,thread,});const partner_ids=validMentions?.partners.map((partner)=>partner.id)??[];const role_ids=validMentions?.roles.map((role)=>role.id)??[];const recipientEmails=[];if(!isNote){const allRecipients=[...thread.suggestedRecipients,...thread.additionalRecipients];const recipientIds=allRecipients.filter((recipient)=>recipient.persona).map((recipient)=>recipient.persona.id);allRecipients.filter((recipient)=>!recipient.persona).forEach((recipient)=>{recipientEmails.push(recipient.email);});partner_ids.push(...recipientIds);}
postData={body:await generateEmojisOnHtml(body),email_add_signature:emailAddSignature,message_type:"comment",subtype_xmlid:subtype,};if(attachments.length){postData.attachment_ids=attachments.map(({id})=>id);}
if(partner_ids.length){Object.assign(postData,{partner_ids});this.fillPartnersMentionToken(postData);}
if(role_ids.length){Object.assign(postData,{role_ids});}
if(thread.model==="discuss.channel"&&validMentions?.specialMentions.length){postData.special_mentions=validMentions.specialMentions;}
if(attachments.length){postData.attachment_tokens=attachments.map((attachment)=>attachment.ownership_token);}
if(recipientEmails.length){postData.partner_emails=recipientEmails;}
const params={post_data:postData,thread_id:thread.id,thread_model:thread.model,};if(cannedResponseIds?.length){params.canned_response_ids=cannedResponseIds;}
return params;}
getNextTemporaryId(){const lastMessageId=this.getLastMessageId();if(prevLastMessageId===lastMessageId){temporaryIdOffset+=0.01;}else{prevLastMessageId=lastMessageId;temporaryIdOffset=0.01;}
return lastMessageId+temporaryIdOffset;}
async getPartner({userId,partnerId}){if(userId){let user=this.users[userId];if(!user){this.users[userId]={id:userId};user=this.users[userId];}
if(!user.partner_id){const[userData]=await this.env.services.orm.silent.read("res.users",[user.id],["partner_id"],{context:{active_test:false}});if(userData){user.partner_id=userData.partner_id[0];}}
if(!user.partner_id){this.env.services.notification.add(_t("You can only chat with existing users."),{type:"warning",});return;}
partnerId=user.partner_id;}
if(partnerId){const partner=this["res.partner"].insert({id:partnerId});if(!partner.main_user_id){const[userId]=await this.env.services.orm.silent.search("res.users",[["partner_id","=",partnerId]],{context:{active_test:false}});if(!userId){this.env.services.notification.add(_t("You can only chat with partners that have a dedicated user."),{type:"info"});return;}
if(!partner.main_user_id){partner.main_user_id=userId;}}
return partner;}}
async joinChat(id,forceOpen=false){const{channel}=await this.fetchStoreData("/discuss/get_or_create_chat",{partners_to:[id]},{readonly:false,requestData:true});if(forceOpen){await channel.open({focus:true});}
return channel;}
async openChat(person){const chat=await this.getChat(person);chat?.open({focus:true});}
openDocument({id,model}){this.env.services.action.doAction({type:"ir.actions.act_window",res_model:model,views:[[false,"form"]],res_id:id,});}
onClickPartnerMention(ev,id){this.openChat({partnerId:id});}
async searchMessagesInThread(searchTerm,thread,before,is_notification){const{count,data,messages}=await rpc(thread.getFetchRoute(),{...thread.getFetchParams(),fetch_params:{is_notification,search_term:await prettifyMessageText(searchTerm),before,},});this.insert(data);return{count,loadMore:messages.length===this.FETCH_LIMIT,messages:this["mail.message"].insert(messages),};}}
Store.register();const storeService=__exports.storeService={dependencies:["bus_service","im_status","ui","popover"],start(env,services){const store=makeStore(env);store.insert(session.storeData);store.self_guest??={id:-1};store.settings??={};store.initialize();store.onStarted();return store;},};registry.category("services").add("mail.store",storeService);return __exports;});;

/* /mail/static/src/core/common/suggestion_hook.js */
odoo.define('@mail/core/common/suggestion_hook',['@html_editor/utils/dom_info','@html_editor/utils/position','@mail/utils/common/format','@odoo/owl','@web/core/network/rpc','@web/core/utils/hooks','@web/core/utils/timing','@web/core/utils/xml'],function(require){'use strict';let __exports={};const{isContentEditable,isTextNode}=require("@html_editor/utils/dom_info");const{rightPos}=require("@html_editor/utils/position");const{generatePartnerMentionElement,generateRoleMentionElement,generateSpecialMentionElement,generateThreadMentionElement,}=require("@mail/utils/common/format");const{status,useComponent,useEffect,useState}=require("@odoo/owl");const{ConnectionAbortedError}=require("@web/core/network/rpc");const{useService}=require("@web/core/utils/hooks");const{useDebounced}=require("@web/core/utils/timing");const{createTextNode}=require("@web/core/utils/xml");const DELAY_FETCH=__exports.DELAY_FETCH=250;const UseSuggestion=__exports.UseSuggestion=class UseSuggestion{constructor(comp){this.comp=comp;this.fetchSuggestions=useDebounced(this.fetchSuggestions.bind(this),DELAY_FETCH);useEffect(()=>{this.update();if(this.search.position===undefined||!this.search.delimiter){return;}
if(!this.composer.store.self_partner){return;}
if(this.lastFetchedSearch?.count===0&&(!this.search.delimiter||this.isSearchMoreSpecificThanLastFetch)){return;}
this.fetchSuggestions();},()=>[this.search.delimiter,this.search.position,this.search.term]);useEffect(()=>{this.detect();},()=>[this.composer.selection.start,this.composer.selection.end,this.composer.composerText,this.composer.composerHtml,]);}
comp;get composer(){return this.comp.props.composer;}
suggestionService=useService("mail.suggestion");state=useState({count:0,items:undefined,isFetching:false,});search={delimiter:undefined,position:undefined,term:"",};lastFetchedSearch;get isSearchMoreSpecificThanLastFetch(){return(this.lastFetchedSearch.delimiter===this.search.delimiter&&this.search.term.startsWith(this.lastFetchedSearch.term)&&this.lastFetchedSearch.position>=this.search.position);}
clearRawMentions(){this.composer.mentionedChannels.length=0;this.composer.mentionedPartners.length=0;this.composer.mentionedRoles.length=0;}
clearCannedResponses(){this.composer.cannedResponses=[];}
clearSearch(){Object.assign(this.search,{delimiter:undefined,position:undefined,term:"",});this.state.items=undefined;}
detect(){let start=0;let end=0;let text="";if(this.comp.composerService.htmlEnabled){const selection=this.comp.editor.shared.selection.getEditableSelection();if(!isTextNode(selection.startContainer)||!isContentEditable(selection.startContainer)||!selection.isCollapsed){this.clearSearch();return;}
start=selection.startOffset;end=selection.endOffset;text=selection.anchorNode.textContent;}else{start=this.composer.selection.start;end=this.composer.selection.end;text=this.composer.composerText;}
if(start!==end){this.clearSearch();return;}
const candidatePositions=[];let numberOfSpaces=0;for(let index=start-1;index>=0;--index){if(/\s/.test(text[index])){numberOfSpaces++;if(numberOfSpaces===2){break;}}
candidatePositions.push(index);}
if(this.search.position!==undefined&&this.search.position<start){candidatePositions.push(this.search.position);}
const supportedDelimiters=this.suggestionService.getSupportedDelimiters(this.thread,this.comp.env);for(const candidatePosition of candidatePositions){if(candidatePosition<0||candidatePosition>=text.length){continue;}
const findAppropriateDelimiter=()=>{let goodCandidate;for(const[delimiter,allowedPosition,minCharCountAfter]of supportedDelimiters){if(text.substring(candidatePosition).startsWith(delimiter)&&(allowedPosition===undefined||allowedPosition===candidatePosition)&&(minCharCountAfter===undefined||start-candidatePosition-delimiter.length+1>minCharCountAfter)&&(!goodCandidate||delimiter.length>goodCandidate)){goodCandidate=delimiter;}}
return goodCandidate;};const candidateDelimiter=findAppropriateDelimiter();if(!candidateDelimiter){continue;}
const charBeforeCandidate=text[candidatePosition-1];if(charBeforeCandidate&&!/\s/.test(charBeforeCandidate)){continue;}
Object.assign(this.search,{delimiter:candidateDelimiter,position:candidatePosition,term:text.substring(candidatePosition+candidateDelimiter.length,start),});this.state.count++;return;}
this.clearSearch();}
get thread(){return this.composer.thread||this.composer.message?.thread;}
insert(option){let position=this.search.position+1;if([":","::"].includes(this.search.delimiter)||(this.comp.composerService.htmlEnabled&&this.search.delimiter!=="/")){position=this.search.position;}
if(this.comp.composerService.htmlEnabled){const{startContainer,endContainer,endOffset}=this.comp.editor.shared.selection.getEditableSelection();this.comp.editor.shared.selection.setSelection({anchorNode:startContainer,anchorOffset:position,focusNode:endContainer,focusOffset:endOffset,});}
if(option.partner){this.composer.mentionedPartners.add({id:option.partner.id});}else if(option.role){this.composer.mentionedRoles.add(option.role);}else if(option.thread){this.composer.mentionedChannels.add({model:"discuss.channel",id:option.thread.id});}else if(option.cannedResponse){this.composer.cannedResponses.push(option.cannedResponse);}
if(this.comp.composerService.htmlEnabled){let inlineElement;if(option.partner){inlineElement=generatePartnerMentionElement(option.partner,this.thread);}else if(option.isSpecial){inlineElement=generateSpecialMentionElement(option.label);}else if(option.role){inlineElement=generateRoleMentionElement(option.role);}else if(option.thread){inlineElement=generateThreadMentionElement(option.thread);}else{inlineElement=createTextNode(option.label);}
this.comp.editor.shared.dom.insert(inlineElement);const[anchorNode,anchorOffset]=rightPos(inlineElement);this.comp.editor.shared.selection.setSelection({anchorNode,anchorOffset});this.comp.editor.shared.dom.insert("\u00A0");this.comp.editor.shared.history.addStep();}else{this.composer.composerText=this.composer.composerText.substring(0,position)+
this.composer.composerText.substring(this.composer.selection.end);this.clearSearch();this.composer.insertText(`${option.label} `,position);}}
update(){if(!this.search.delimiter){return;}
const{type,suggestions}=this.suggestionService.searchSuggestions(this.search,{thread:this.thread,});if(!suggestions.length){this.state.items=undefined;return;}
const limit=8;suggestions.length=Math.min(suggestions.length,limit);this.state.items={type,suggestions};}
async fetchSuggestions(){if(!this.thread||status(this.comp)==="destroyed"){return;}
let resetFetchingState=true;try{this.abortController?.abort();this.abortController=new AbortController();this.state.isFetching=true;await this.suggestionService.fetchSuggestions(this.search,{thread:this.thread,abortSignal:this.abortController.signal,});}catch(e){this.lastFetchedSearch=null;if(e instanceof ConnectionAbortedError){resetFetchingState=false;return;}
throw e;}finally{if(resetFetchingState){this.state.isFetching=false;}}
if(!this.thread||status(this.comp)==="destroyed"){return;}
this.update();this.lastFetchedSearch={...this.search,count:this.state.items?.suggestions.length??0,};if(!this.state.items?.suggestions.length){this.clearSearch();}}}
__exports.useSuggestion=useSuggestion;function useSuggestion(){return new UseSuggestion(useComponent());}
return __exports;});;

/* /mail/static/src/core/common/suggestion_service.js */
odoo.define('@mail/core/common/suggestion_service',['@mail/core/common/partner_compare','@mail/utils/common/format','@odoo/owl','@web/core/emoji_picker/emoji_picker','@web/core/registry','@web/core/utils/search'],function(require){'use strict';let __exports={};const{partnerCompareRegistry}=require("@mail/core/common/partner_compare");const{cleanTerm}=require("@mail/utils/common/format");const{toRaw}=require("@odoo/owl");const{loadEmoji}=require("@web/core/emoji_picker/emoji_picker");const{registry}=require("@web/core/registry");const{fuzzyLookup}=require("@web/core/utils/search");const SuggestionService=__exports.SuggestionService=class SuggestionService{constructor(env,services){this.env=env;this.orm=services.orm;this.store=services["mail.store"];this.composer=services["mail.composer"];this.emojis;}
getSupportedDelimiters(thread,env){return[["@"],["#"],["::"],[":",undefined,2]];}
async fetchSuggestions({delimiter,term},{thread,abortSignal}={}){const cleanedSearchTerm=cleanTerm(term);switch(delimiter){case"@":await this.fetchPartnersRoles(cleanedSearchTerm,thread,{abortSignal});break;case"#":await this.fetchThreads(cleanedSearchTerm,{abortSignal});break;case"::":await this.store.cannedReponses.fetch();break;case":":{const{emojis}=await loadEmoji();this.emojis=emojis;break;}}}
makeOrmCall(model,method,args,kwargs,{abortSignal}={}){return new Promise((res,rej)=>{const req=this.orm.silent.call(model,method,args,kwargs);const onAbort=()=>{try{req.abort();}catch(e){rej(e);}};abortSignal?.addEventListener("abort",onAbort);req.then(res).catch(rej).finally(()=>abortSignal?.removeEventListener("abort",onAbort));});}
async fetchPartnersRoles(term,thread,{abortSignal}={}){const kwargs={search:term};if(thread?.model==="discuss.channel"){kwargs.channel_id=thread.id;}
const data=await this.makeOrmCall("res.partner",thread?.model==="discuss.channel"?"get_mention_suggestions_from_channel":"get_mention_suggestions",[],kwargs,{abortSignal});this.store.insert(data);}
async fetchThreads(term,{abortSignal}={}){const data=await this.makeOrmCall("discuss.channel","get_mention_suggestions",[],{search:term},{abortSignal});this.store.insert(data);}
searchCannedResponseSuggestions(cleanedSearchTerm){const cannedResponses=Object.values(this.store["mail.canned.response"].records).filter((cannedResponse)=>cleanTerm(cannedResponse.source).includes(cleanedSearchTerm));const sortFunc=(c1,c2)=>{const cleanedName1=cleanTerm(c1.source);const cleanedName2=cleanTerm(c2.source);if(cleanedName1.startsWith(cleanedSearchTerm)&&!cleanedName2.startsWith(cleanedSearchTerm)){return-1;}
if(!cleanedName1.startsWith(cleanedSearchTerm)&&cleanedName2.startsWith(cleanedSearchTerm)){return 1;}
if(cleanedName1<cleanedName2){return-1;}
if(cleanedName1>cleanedName2){return 1;}
return c1.id-c2.id;};return{type:"mail.canned.response",suggestions:cannedResponses.sort(sortFunc),};}
searchEmojisSuggestions(cleanedSearchTerm){let emojis=[];if(this.emojis&&cleanedSearchTerm){emojis=fuzzyLookup(cleanedSearchTerm,this.emojis,(emoji)=>emoji.shortcodes);}
return{type:"emoji",suggestions:emojis,};}
searchSuggestions({delimiter,term},{thread}={}){thread=toRaw(thread);const cleanedSearchTerm=cleanTerm(term);switch(delimiter){case"@":{const partners=this.searchPartnerSuggestions(cleanedSearchTerm,thread);const roles=this.searchRoleSuggestions(cleanedSearchTerm);return{type:"Partner",suggestions:[...partners.suggestions,...roles.suggestions],};}
case"#":return this.searchChannelSuggestions(cleanedSearchTerm);case"::":return this.searchCannedResponseSuggestions(cleanedSearchTerm);case":":return this.searchEmojisSuggestions(cleanedSearchTerm);}
return{type:undefined,suggestions:[],};}
searchRoleSuggestions(cleanedSearchTerm){const roles=Object.values(this.store["res.role"].records).filter((role)=>cleanTerm(role.name).includes(cleanedSearchTerm));const sortFunc=(r1,r2)=>{const cleanedName1=cleanTerm(r1.name);const cleanedName2=cleanTerm(r2.name);if(cleanedName1.startsWith(cleanedSearchTerm)&&!cleanedName2.startsWith(cleanedSearchTerm)){return-1;}
if(!cleanedName1.startsWith(cleanedSearchTerm)&&cleanedName2.startsWith(cleanedSearchTerm)){return 1;}
if(cleanedName1<cleanedName2){return-1;}
if(cleanedName1>cleanedName2){return 1;}
return r1.id-r2.id;};return{suggestions:roles.sort(sortFunc),};}
isSuggestionValid(partner,thread){return((this.store.self_partner?.main_user_id?.share===false||partner.mention_token)&&partner.notEq(this.store.odoobot));}
getPartnerSuggestions(thread){return Object.values(this.store["res.partner"].records).filter((partner)=>this.isSuggestionValid(partner,thread));}
searchPartnerSuggestions(cleanedSearchTerm,thread){const partners=this.getPartnerSuggestions(thread);const suggestions=[];for(const partner of partners){if(!partner.name){continue;}
if(cleanTerm(partner.name).includes(cleanedSearchTerm)||(partner.email&&cleanTerm(partner.email).includes(cleanedSearchTerm))){suggestions.push(partner);}}
suggestions.push(...this.store.specialMentions.filter((special)=>thread&&special.channel_types.includes(thread.channel_type)&&cleanedSearchTerm.length>=Math.min(4,special.label.length)&&(special.label.startsWith(cleanedSearchTerm)||cleanTerm(special.description.toString()).includes(cleanedSearchTerm))));return{type:"Partner",suggestions:[...this.sortPartnerSuggestions(suggestions,cleanedSearchTerm,thread)],};}
sortPartnerSuggestions(partners,searchTerm="",thread=undefined){const cleanedSearchTerm=cleanTerm(searchTerm);const compareFunctions=partnerCompareRegistry.getAll();const context=this.sortPartnerSuggestionsContext(thread);return partners.sort((p1,p2)=>{p1=toRaw(p1);p2=toRaw(p2);if(p1.isSpecial||p2.isSpecial){return 0;}
for(const fn of compareFunctions){const result=fn(p1,p2,{env:this.env,searchTerm:cleanedSearchTerm,thread,context,});if(result!==undefined){return result;}}});}
sortPartnerSuggestionsContext(){return{};}
searchChannelSuggestions(cleanedSearchTerm){const suggestionList=Object.values(this.store.Thread.records).filter((thread)=>thread.channel_type==="channel"&&thread.displayName&&cleanTerm(thread.displayName).includes(cleanedSearchTerm));const sortFunc=(c1,c2)=>{const isPublicChannel1=c1.channel_type==="channel"&&!c2.group_public_id;const isPublicChannel2=c2.channel_type==="channel"&&!c2.group_public_id;if(isPublicChannel1&&!isPublicChannel2){return-1;}
if(!isPublicChannel1&&isPublicChannel2){return 1;}
if(c1.hasSelfAsMember&&!c2.hasSelfAsMember){return-1;}
if(!c1.hasSelfAsMember&&c2.hasSelfAsMember){return 1;}
const cleanedDisplayName1=cleanTerm(c1.displayName);const cleanedDisplayName2=cleanTerm(c2.displayName);if(cleanedDisplayName1.startsWith(cleanedSearchTerm)&&!cleanedDisplayName2.startsWith(cleanedSearchTerm)){return-1;}
if(!cleanedDisplayName1.startsWith(cleanedSearchTerm)&&cleanedDisplayName2.startsWith(cleanedSearchTerm)){return 1;}
if(cleanedDisplayName1<cleanedDisplayName2){return-1;}
if(cleanedDisplayName1>cleanedDisplayName2){return 1;}
return c1.id-c2.id;};return{type:"Thread",suggestions:suggestionList.sort(sortFunc),};}}
const suggestionService=__exports.suggestionService={dependencies:["orm","mail.store","mail.composer"],start(env,services){return new SuggestionService(env,services);},};registry.category("services").add("mail.suggestion",suggestionService);return __exports;});;

/* /mail/static/src/core/common/thread.js */
odoo.define('@mail/core/common/thread',['@mail/core/common/date_section','@mail/core/common/message','@mail/core/common/notification_message','@mail/core/common/record','@mail/utils/common/hooks','@odoo/owl','@web/core/browser/browser','@web/core/l10n/translation','@web/core/transition','@web/core/utils/concurrency','@web/core/utils/hooks','@web/core/utils/strings'],function(require){'use strict';let __exports={};const{DateSection}=require("@mail/core/common/date_section");const{Message}=require("@mail/core/common/message");const{NotificationMessage}=require("@mail/core/common/notification_message");const{Record}=require("@mail/core/common/record");const{useVisible}=require("@mail/utils/common/hooks");const{Component,markRaw,onMounted,onWillDestroy,onWillPatch,onWillUnmount,onWillUpdateProps,reactive,toRaw,useChildSubEnv,useEffect,useRef,useState,}=require("@odoo/owl");const{browser}=require("@web/core/browser/browser");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{Transition}=require("@web/core/transition");const{Deferred}=require("@web/core/utils/concurrency");const{useBus,useRefListener,useService}=require("@web/core/utils/hooks");const{escape}=require("@web/core/utils/strings");const PRESENT_VIEWPORT_THRESHOLD=__exports.PRESENT_VIEWPORT_THRESHOLD=1;const Thread=__exports.Thread=class Thread extends Component{static components={Message,NotificationMessage,Transition,DateSection};static props=["autofocus?","showDates?","isInChatWindow?","jumpPresent?","jumpToNewMessage?","thread","order?","scrollRef?","showEmptyMessage?","showJumpPresent?","messageActions?",];static defaultProps={isInChatWindow:false,jumpPresent:0,order:"asc",showDates:true,showEmptyMessage:true,showJumpPresent:true,messageActions:true,};static template="mail.Thread";smoothScrollingDeferred;smoothScrollingTimeout;isSmoothScrolling=false;setup(){super.setup();this.escape=escape;this.applyScroll=this.applyScroll.bind(this);this.saveScroll=this.saveScroll.bind(this);this.onScroll=this.onScroll.bind(this);this.registerMessageRef=this.registerMessageRef.bind(this);this.store=useService("mail.store");this.ui=useService("ui");this.state=useState({isFocused:false,isReplyingTo:false,mountedAndLoaded:false,showJumpPresent:false,scrollTop:null,});this.lastJumpPresent=this.props.jumpPresent;this.orm=useService("orm");this.ui=useService("ui");this.messageHighlight=this.env.messageHighlight?useState(this.env.messageHighlight):null;this.scrollingToHighlight=false;this.refByMessageId=reactive(new Map(),()=>{this.scrollToHighlighted();});useEffect(()=>{this.scrollToHighlighted();},()=>[this.messageHighlight?.highlightedMessageId]);this.present=useRef("load-newer");this.jumpPresentRef=useRef("jump-present");this.root=useRef("messages");this.visibleState=useVisible("messages",()=>{this.updateShowJumpPresent();});this.scrollableRef=this.props.scrollRef??this.root;useRefListener(this.scrollableRef,"scrollend",()=>(this.state.scrollTop=this.scrollableRef.el.scrollTop));this.loadOlderState=useVisible("load-older",async()=>{await Promise.all([this.messageHighlight?.scrollPromise,this.smoothScrollingDeferred,]);if(this.loadOlderState.isVisible){toRaw(this.props.thread).fetchMoreMessages();}},{ready:false});this.loadNewerState=useVisible("load-newer",async()=>{await Promise.all([this.messageHighlight?.scrollPromise,this.smoothScrollingDeferred,]);if(this.loadNewerState.isVisible){toRaw(this.props.thread).fetchMoreMessages("newer");}},{ready:false});this.presentThresholdState=useVisible("present-treshold",()=>this.updateShowJumpPresent());this.setupScroll();useEffect((focus)=>{if(focus&&this.state.mountedAndLoaded){this.root.el.focus();}},()=>[this.props.autofocus+this.props.thread.autofocus,this.state.mountedAndLoaded]);useEffect(()=>{this.computeJumpPresentPosition();},()=>[this.jumpPresentRef.el,this.viewportEl]);useEffect(()=>this.updateShowJumpPresent(),()=>[this.props.thread.loadNewer]);useEffect(()=>{if(this.props.jumpPresent!==this.lastJumpPresent){this.jumpToPresent({immediate:true});}},()=>[this.props.jumpPresent]);useEffect(()=>{if(this.props.thread.highlightMessage&&this.state.mountedAndLoaded){this.messageHighlight?.highlightMessage(this.props.thread.highlightMessage,this.props.thread);this.props.thread.highlightMessage=null;}},()=>[this.props.thread.highlightMessage,this.state.mountedAndLoaded]);useEffect(()=>{if(!this.state.mountedAndLoaded){return;}
this.updateShowJumpPresent();},()=>[this.state.mountedAndLoaded]);onMounted(()=>{if(!this.env.chatter||this.env.chatter?.fetchMessages){if(this.env.chatter){this.env.chatter.fetchMessages=false;}
this.fetchMessages();}});onWillUnmount(()=>{if(this.state.isFocused){this.props.thread.isFocusedCounter--;}});useEffect((isLoaded)=>{this.state.mountedAndLoaded=isLoaded;},()=>[this.props.thread.isLoaded,this.state.mountedAndLoaded]);useEffect(()=>{if(!this.props.jumpToNewMessage){return;}
const el=this.refByMessageId.get(this.props.thread.self_member_id.new_message_separator_ui-1)?.el;if(el){el.querySelector(".o-mail-Message-jumpTarget").scrollIntoView({behavior:"instant",block:"center",});}},()=>[this.props.jumpToNewMessage]);useBus(this.env.bus,"MAIL:RELOAD-THREAD",({detail})=>{const{model,id}=this.props.thread;if(detail.model===model&&detail.id===id){toRaw(this.props.thread).fetchNewMessages();}});onWillUpdateProps((nextProps)=>{if(nextProps.thread.notEq(this.props.thread)){this.lastJumpPresent=nextProps.jumpPresent;}
if(!this.env.chatter||this.env.chatter?.fetchMessages){if(this.env.chatter){this.env.chatter.fetchMessages=false;}
toRaw(nextProps.thread).fetchNewMessages();}});}
computeJumpPresentPosition(){if(!this.viewportEl||!this.jumpPresentRef.el){return;}
const width=this.viewportEl.clientWidth;const height=this.viewportEl.clientHeight;const computedStyle=window.getComputedStyle(this.viewportEl);const ps=parseInt(computedStyle.getPropertyValue("padding-left"));const pe=parseInt(computedStyle.getPropertyValue("padding-right"));const pt=parseInt(computedStyle.getPropertyValue("padding-top"));const pb=parseInt(computedStyle.getPropertyValue("padding-bottom"));this.jumpPresentRef.el.style.transform=`translate(${
            this.env.inChatter ? 22 : width - ps - pe - 22
        }px, ${
            this.env.inChatter && !this.env.inChatter.aside
                ? -22
                : height - pt - pb - (this.env.inChatter?.aside ? 75 : 0)
        }px)`;}
setupScroll(){this.lastSetValue=undefined;this.loadedAndPatched=false;this.snapshot=undefined;this.newestPersistentMessage=undefined;this.oldestPersistentMessage=undefined;this.loadNewer=undefined;let stopOnChange=Record.onChange(this.props.thread,"isLoaded",()=>{if(!this.props.thread.isLoaded||!this.state.mountedAndLoaded){this.reset();}});onWillUpdateProps((nextProps)=>{if(nextProps.thread.notEq(this.props.thread)){stopOnChange();stopOnChange=Record.onChange(nextProps.thread,"isLoaded",()=>{if(!nextProps.thread.isLoaded||!this.state.mountedAndLoaded){this.reset();}});}});onWillDestroy(()=>stopOnChange());onWillPatch(()=>{if(!this.loadedAndPatched){return;}
this.snapshot={scrollHeight:this.scrollableRef.el.scrollHeight,scrollTop:this.scrollableRef.el.scrollTop,};});useEffect(this.applyScroll);useChildSubEnv({getCurrentThread:()=>this.props.thread,onImageLoaded:this.applyScroll,});const observer=new ResizeObserver(()=>{this.computeJumpPresentPosition();this.applyScroll();});useEffect((el,mountedAndLoaded)=>{if(el&&mountedAndLoaded){el.addEventListener("scroll",this.onScroll);observer.observe(el);return()=>{observer.unobserve(el);el.removeEventListener("scroll",this.onScroll);};}},()=>[this.scrollableRef.el,this.state.mountedAndLoaded]);}
applyScroll(){if(!this.props.thread.isLoaded||!this.state.mountedAndLoaded){this.reset();return;}
const thread=toRaw(this.props.thread);this.applyScrollContextually(thread);this.snapshot=undefined;this.newestPersistentMessage=thread.newestPersistentMessage;this.oldestPersistentMessage=thread.oldestPersistentMessage;this.loadNewer=thread.loadNewer;if(!this.loadedAndPatched){this.loadedAndPatched=true;this.loadOlderState.ready=true;this.loadNewerState.ready=true;}}
applyScrollContextually(thread){const olderMessages=thread.oldestPersistentMessage?.id<this.oldestPersistentMessage?.id;const newerMessages=thread.newestPersistentMessage?.id>this.newestPersistentMessage?.id;const messagesAtTop=(this.props.order==="asc"&&olderMessages)||(this.props.order==="desc"&&newerMessages);const messagesAtBottom=(this.props.order==="desc"&&olderMessages)||(this.props.order==="asc"&&newerMessages&&(this.loadNewer||typeof thread.scrollTop!=="string"||!thread.scrollTop?.includes("bottom")));if(this.snapshot&&messagesAtTop){this.setScroll(this.snapshot.scrollTop+
this.scrollableRef.el.scrollHeight-
this.snapshot.scrollHeight);}else if(this.snapshot&&messagesAtBottom){this.setScroll(this.snapshot.scrollTop);}else if(!this.env.messageHighlight?.highlightedMessageId&&thread.scrollTop!==undefined){let value;if(typeof thread.scrollTop==="string"&&thread.scrollTop?.includes("bottom")){value=this.props.order==="asc"?this.scrollableRef.el.scrollHeight-this.scrollableRef.el.clientHeight:0;}else{value=this.props.order==="asc"?thread.scrollTop:this.scrollableRef.el.scrollHeight-
thread.scrollTop-
this.scrollableRef.el.clientHeight;}
if((this.lastSetValue===undefined||Math.abs(this.lastSetValue-value)>1)&&!this.isSmoothScrolling){this.setScroll(value,{smooth:typeof thread.scrollTop==="string"&&thread.scrollTop?.includes("smooth"),});}}}
fetchMessages(){toRaw(this.props.thread).fetchNewMessages();}
get viewportEl(){let viewportEl=this.scrollableRef.el;if(viewportEl&&viewportEl.clientHeight>browser.innerHeight){while(viewportEl&&viewportEl.clientHeight>browser.innerHeight){viewportEl=viewportEl.parentElement;}}
return viewportEl;}
get PRESENT_THRESHOLD(){const threshold=(this.viewportEl?.clientHeight??0)*PRESENT_VIEWPORT_THRESHOLD;return this.state.showJumpPresent?threshold-200:threshold;}
updateShowJumpPresent(){this.state.showJumpPresent=this.visibleState.isVisible&&(this.props.thread.loadNewer||this.presentThresholdState.isVisible===false);}
onClickLoadOlder(){this.props.thread.fetchMoreMessages();}
async onClickPreferences(){const actionDescription=await this.orm.call("res.users","action_get");actionDescription.res_id=this.store.self.main_user_id?.id;this.env.services.action.doAction(actionDescription);}
onFocusin(){this.state.isFocused=true;this.props.thread.isFocusedCounter++;const thread=toRaw(this.props.thread);if(thread?.scrollTop==="bottom"&&!thread.scrollUnread&&!thread.markedAsUnread){thread?.markAsRead();}}
onFocusout(){this.state.isFocused=false;this.props.thread.isFocusedCounter--;}
getMessageClassName(message){return!message.isNotification&&this.messageHighlight?.highlightedMessageId===message.id?"o-highlighted bg-view shadow-lg pb-1":"";}
async jumpToPresent({immediate=false}={}){this.messageHighlight?.clear();if(!immediate||this.props.thread.loadNewer){await this.props.thread.loadAround();this.props.thread.loadNewer=false;this.state.showJumpPresent=false;}
this.props.thread.scrollTop=immediate?"bottom":"bottom-smooth";if(!this.ui.isSmall){this.props.thread.composer.autofocus++;}}
registerMessageRef(message,ref){if(!ref){this.refByMessageId.delete(message.id);return;}
this.refByMessageId.set(message.id,markRaw(ref));}
reset(){this.state.mountedAndLoaded=false;this.loadOlderState.ready=false;this.loadNewerState.ready=false;this.lastSetValue=undefined;this.snapshot=undefined;this.newestPersistentMessage=undefined;this.oldestPersistentMessage=undefined;this.loadedAndPatched=false;this.loadNewer=false;}
isSquashed(msg,prevMsg){if(this.props.thread.model==="mail.box"){return false;}
if(!prevMsg||prevMsg.message_type==="notification"||this.env.inChatter){return false;}
if(!msg.author?.eq(prevMsg.author)){return false;}
if(!msg.thread?.eq(prevMsg.thread)){return false;}
if(msg.isNote){return false;}
return msg.datetime.ts-prevMsg.datetime.ts<5*60*1000;}
get isAtBottom(){if(this.loadNewer){return false;}
return this.props.order==="asc"?this.scrollableRef.el.scrollHeight-
this.scrollableRef.el.scrollTop-
this.scrollableRef.el.clientHeight<30:this.scrollableRef.el.scrollTop<30;}
onScroll(){const thread=toRaw(this.props.thread);if(this.isAtBottom&&!thread.markedAsUnread&&thread.isFocused&&!thread.markingAsRead){thread.markAsRead();}
this.saveScroll();}
saveScroll(){const thread=toRaw(this.props.thread);const isBottom=this.isAtBottom;if(isBottom){thread.scrollTop="bottom";}else{thread.scrollTop=this.props.order==="asc"?this.scrollableRef.el.scrollTop:this.scrollableRef.el.scrollHeight-
this.scrollableRef.el.scrollTop-
this.scrollableRef.el.clientHeight;}}
async scrollToHighlighted(){if(!this.messageHighlight?.highlightedMessageId||this.scrollingToHighlight){return;}
const el=this.refByMessageId.get(this.messageHighlight.highlightedMessageId)?.el;if(el){this.scrollingToHighlight=true;await this.messageHighlight.startupDeferred;this.messageHighlight.scrollTo(el.querySelector(".o-mail-Message-jumpTarget")).then(()=>(this.scrollingToHighlight=false));}}
get orderedMessages(){const messages=this.state.mountedAndLoaded?this.props.thread.messages:this.props.thread.phantomMessages;return this.props.order==="asc"?[...messages]:[...messages].reverse();}
get showLoadOlder(){return(this.props.thread.loadOlder&&this.props.thread.isLoaded&&!this.props.thread.isTransient&&!this.props.thread.hasLoadingFailed&&!this.messageHighlight?.initiated&&!this.messageHighlight?.highlightedMessageId);}
setScroll(value,{smooth=false}={}){if(smooth){clearTimeout(this.smoothScrollingTimeout);this.isSmoothScrolling=true;this.smoothScrollingDeferred=new Deferred();const onSmoothScrollingEnd=()=>{this.smoothScrollingDeferred.resolve();this.smoothScrollingDeferred=undefined;this.isSmoothScrolling=false;};if("onscrollend"in window){document.addEventListener("scrollend",onSmoothScrollingEnd,{capture:true,once:true,});}else{this.smoothScrollingTimeout=setTimeout(onSmoothScrollingEnd,250);}}
this.scrollableRef.el.scrollTo({behavior:smooth?"smooth":undefined,top:value});this.lastSetValue=value;this.messageHighlight?.startupDeferred?.resolve();this.saveScroll();}
get showStartMessage(){return(this.state.mountedAndLoaded&&["channel","group","chat"].includes(this.props.thread.channel_type));}
get startMessageTitle(){const channelName=this.props.thread.name;if(this.props.thread.parent_channel_id){return channelName;}
if(this.props.thread.channel_type==="channel"){return _t("Welcome to #%(channelName)s!",{channelName});}
return this.props.thread.displayName;}
get startMessageSubtitle(){if(this.props.thread.parent_channel_id){const authorName=Object.values(this.store["res.partner"].records).find((partner)=>partner.main_user_id?.eq(this.props.thread.create_uid))?.name;if(authorName){return _t("Started by %(authorName)s",{authorName});}}
if(this.props.thread.channel_type==="channel"){return _t("This is the start of the #%(channelName)s channel",{channelName:this.props.thread.name,});}
if(this.props.thread.channel_type==="group"){return _t("This is the start of %(conversationName)s group",{conversationName:this.props.thread.displayName,});}
return _t("This is the start of your direct chat with %(userName)s",{userName:this.props.thread.displayName,});}}
return __exports;});;

/* /mail/static/src/core/common/thread_actions.js */
odoo.define('@mail/core/common/thread_actions',['@odoo/owl','@web/core/l10n/translation','@web/core/registry','@mail/core/common/search_messages_panel','@web/core/utils/misc','@mail/core/common/action','@mail/discuss/call/common/meeting_chat','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{useSubEnv,useComponent,useState}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{registry}=require("@web/core/registry");const{SearchMessagesPanel}=require("@mail/core/common/search_messages_panel");const{markEventHandled}=require("@web/core/utils/misc");const{Action,ACTION_TAGS,UseActions}=require("@mail/core/common/action");const{MeetingChat}=require("@mail/discuss/call/common/meeting_chat");const{useService}=require("@web/core/utils/hooks");const threadActionsRegistry=__exports.threadActionsRegistry=registry.category("mail.thread/actions");__exports.registerThreadAction=registerThreadAction;function registerThreadAction(id,definition){threadActionsRegistry.add(id,definition);}
registerThreadAction("fold-chat-window",{condition:({owner})=>owner.props.chatWindow&&!owner.isDiscussSidebarChannelActions,icon:"oi oi-fw oi-minus",name:({owner})=>(!owner.props.chatWindow?.isOpen?_t("Open"):_t("Fold")),open:({owner})=>owner.toggleFold(),displayActive:({owner})=>!owner.props.chatWindow?.isOpen,sequence:99,sequenceQuick:20,});registerThreadAction("rename-thread",{condition:({owner,thread})=>thread&&owner.props.chatWindow?.isOpen&&(thread.is_editable||thread.channel_type==="chat")&&!owner.isDiscussSidebarChannelActions,icon:"fa fa-fw fa-pencil",name:_t("Rename Thread"),open:({owner})=>(owner.state.editingName=true),sequence:30,sequenceGroup:20,});registerThreadAction("close",{condition:({owner})=>owner.props.chatWindow&&!owner.isDiscussSidebarChannelActions,icon:"oi fa-fw oi-close",name:_t("Close Chat Window (ESC)"),open:({owner})=>owner.close(),sequence:100,sequenceQuick:10,});registerThreadAction("search-messages",{actionPanelComponent:SearchMessagesPanel,condition:({owner,thread})=>["discuss.channel","mail.box"].includes(thread?.model)&&(!owner.props.chatWindow||owner.props.chatWindow.isOpen)&&!owner.isDiscussSidebarChannelActions,hotkey:"f",panelOuterClass:"o-mail-SearchMessagesPanel bg-inherit",icon:"oi oi-fw oi-search",name:({action})=>(action.isActive?_t("Close Search"):_t("Search Messages")),sequence:20,sequenceGroup:20,setup:({action})=>useSubEnv({searchMenu:{open:()=>action.open(),close:()=>{if(action.isActive){action.close();}},},}),toggle:true,});registerThreadAction("meeting-chat",{actionPanelComponent:MeetingChat,badge:({thread})=>thread.isUnread,badgeIcon:({thread})=>!thread.importantCounter&&"fa fa-circle text-700",badgeText:({thread})=>thread.importantCounter||undefined,condition:({owner})=>owner.env.inMeetingView,icon:"fa fa-fw fa-comments",name:_t("Chat"),panelOuterClass:"bg-100 border border-secondary",sequence:30,toggle:true,tags:({thread})=>{const tags=[];if(thread.importantCounter){tags.push(ACTION_TAGS.IMPORTANT_BADGE);}
return tags;},});const ThreadAction=__exports.ThreadAction=class ThreadAction extends Action{popover=null;threadFn;constructor({thread}){super(...arguments);this.threadFn=typeof thread==="function"?thread:()=>thread;}
get params(){return Object.assign(super.params,{thread:this.threadFn()});}
get actionPanelComponent(){return this.definition.actionPanelComponent;}
get actionPanelComponentCondition(){return this.isActive&&this.actionPanelComponent&&this.condition&&!this.popover;}
get actionPanelComponentProps(){return this.definition.actionPanelComponentProps?.call(this,this.params);}
close({nextActiveAction}={}){if(this.toggle){this.owner.threadActions.activeAction=this.owner.threadActions.actionStack.pop();}
this.definition.close?.call(this,Object.assign(this.params,{nextActiveAction}));}
get isActive(){return this.id===this.owner.threadActions.activeAction?.id;}
get nameClass(){return typeof this.definition.nameClass==="function"?this.definition.nameClass.call(this,this.params):this.definition.nameClass;}
onSelected(ev,{keepPrevious}={}){if(ev){markEventHandled(ev,"ThreadAction.onSelected");}
if(this.toggle&&this.isActive){this.close();}else{this.open({keepPrevious});}}
open({keepPrevious}={}){if(this.toggle){if(this.owner.threadActions.activeAction){if(keepPrevious){this.owner.threadActions.actionStack.push(this.owner.threadActions.activeAction);}else{this.owner.threadActions.activeAction.close({nextActiveAction:this});}}
this.owner.threadActions.activeAction=this;}
this.definition.open?.call(this,this.params);}
get panelOuterClass(){return typeof this.definition.panelOuterClass==="function"?this.definition.panelOuterClass.call(this,this.params):this.definition.panelOuterClass;}
get toggle(){return this.definition.toggle;}}
class UseThreadActions extends UseActions{ActionClass=ThreadAction;actionStack=[];activeAction=null;}
__exports.useThreadActions=useThreadActions;function useThreadActions({thread}={}){const component=useComponent();const transformedActions=threadActionsRegistry.getEntries().map(([id,definition])=>new ThreadAction({owner:component,id,definition,thread}));for(const action of transformedActions){action.setup();}
return useState(new UseThreadActions(component,transformedActions,useService("mail.store")));}
return __exports;});;

/* /mail/static/src/core/common/thread_compare.js */
odoo.define('@mail/core/common/thread_compare',['@web/core/registry'],function(require){'use strict';let __exports={};const{registry}=require("@web/core/registry");const threadCompareRegistry=__exports.threadCompareRegistry=registry.category("mail.thread_compare");threadCompareRegistry.add("mail.needaction",(thread1,thread2)=>{const aNeedaction=thread1.needactionMessages.length;const bNeedaction=thread2.needactionMessages.length;if(aNeedaction>0&&bNeedaction===0){return-1;}
if(bNeedaction>0&&aNeedaction===0){return 1;}},{sequence:10});threadCompareRegistry.add("mail.message-datetime",(thread1,thread2)=>{const aMessageDatetime=thread1.newestPersistentOfAllMessage?.datetime;const bMessageDateTime=thread2.newestPersistentOfAllMessage?.datetime;if(!aMessageDatetime&&bMessageDateTime){return 1;}
if(!bMessageDateTime&&aMessageDatetime){return-1;}
if(aMessageDatetime&&bMessageDateTime&&aMessageDatetime!==bMessageDateTime){return bMessageDateTime-aMessageDatetime;}},{sequence:40});return __exports;});;

/* /mail/static/src/core/common/thread_icon.js */
odoo.define('@mail/core/common/thread_icon',['@web/core/utils/hooks','@odoo/owl','@mail/core/common/thread_model','@web/core/l10n/translation','@mail/core/common/im_status'],function(require){'use strict';let __exports={};const{useService}=require("@web/core/utils/hooks");const{Component}=require("@odoo/owl");const{Thread}=require("@mail/core/common/thread_model");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{ImStatus}=require("@mail/core/common/im_status");const ThreadIcon=__exports.ThreadIcon=class ThreadIcon extends Component{static template="mail.ThreadIcon";static components={ImStatus};static props={thread:{type:Thread},size:{optional:true,validate:(size)=>["small","medium","large"].includes(size)},className:{type:String,optional:true},title:{type:Boolean,optional:true},};static defaultProps={size:"medium",className:"",title:true,};setup(){super.setup();this.store=useService("mail.store");}
get correspondent(){return this.props.thread.correspondent;}
get defaultChatIcon(){return{class:"fa fa-question-circle opacity-75",title:_t("No IM status available"),};}}
return __exports;});;

/* /mail/static/src/core/common/thread_model.js */
odoo.define('@mail/core/common/thread_model',['@mail/core/common/record','@mail/utils/common/format','@mail/utils/common/misc','@web/core/network/rpc','@web/core/l10n/translation','@web/core/user','@web/core/utils/concurrency'],function(require){'use strict';let __exports={};const{AND,fields,Record}=require("@mail/core/common/record");const{generateEmojisOnHtml}=require("@mail/utils/common/format");const{assignDefined}=require("@mail/utils/common/misc");const{rpc}=require("@web/core/network/rpc");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{user}=require("@web/core/user");const{Deferred}=require("@web/core/utils/concurrency");const Thread=__exports.Thread=class Thread extends Record{static id=AND("model","id");static localIdToActiveId(localId){if(!localId){return undefined;}
return localId.split(",").slice(1).join("_").replace(" AND ","_");}
static async getOrFetch(data,fieldNames=[]){let thread=this.get(data);if(data.id>0&&(!thread||fieldNames.some((fieldName)=>thread[fieldName]===undefined))){await this.store.fetchStoreData("mail.thread",{thread_model:data.model,thread_id:data.id,request_list:fieldNames,});thread=this.get(data);if(!thread?.exists()){return;}}
return thread;}
autofocus=0;create_uid=fields.One("res.users");id;uuid;model;allMessages=fields.Many("mail.message",{inverse:"thread",});storeAsAllChannels=fields.One("Store",{compute(){if(this.model==="discuss.channel"){return this.store;}},eager:true,});areAttachmentsLoaded=false;group_public_id=fields.One("res.groups");attachments=fields.Many("ir.attachment",{sort:(a1,a2)=>(a1.id<a2.id?1:-1),});get allowedToLeaveChannelTypes(){return["channel","group"];}
get canLeave(){return(this.allowedToLeaveChannelTypes.includes(this.channel_type)&&this.group_ids.length===0&&this.store.self_partner);}
get allowedToUnpinChannelTypes(){return["chat"];}
get canUnpin(){return(this.parent_channel_id||this.allowedToUnpinChannelTypes.includes(this.channel_type));}
can_react=true;chat_window=fields.One("ChatWindow",{inverse:"thread",});close_chat_window=fields.Attr(undefined,{onUpdate(){if(this.close_chat_window){this.close_chat_window=undefined;this.closeChatWindow({force:true});}},});composer=fields.One("Composer",{compute:()=>({}),inverse:"thread",onDelete:(r)=>r.delete(),});counter=0;counter_bus_id=0;description;display_name;displayToSelf=fields.Attr(false,{compute(){return(this.self_member_id?.is_pinned||(["channel","group"].includes(this.channel_type)&&this.hasSelfAsMember&&!this.parent_channel_id));},onUpdate(){this.onPinStateUpdated();},});followers=fields.Many("mail.followers",{onAdd(r){r.thread=this;},onDelete:(r)=>r.delete(),});selfFollower=fields.One("mail.followers",{onAdd(r){r.thread=this;},onDelete:(r)=>r.delete(),});followersCount;loadOlder=false;loadNewer=false;get importantCounter(){if(this.model==="mail.box"){return this.counter;}
return this.message_needaction_counter;}
isDisplayed=fields.Attr(false,{compute(){return this.computeIsDisplayed();},onUpdate(){this.isDisplayedOnUpdate();},});isDisplayedOnUpdate(){}
get isFocused(){return this.isFocusedCounter!==0;}
isFocusedCounter=fields.Attr(0,{onUpdate(){if(this.isFocusedCounter<0){this.isFocusedCounter=0;}},});isLoadingAttachments=false;isLoadedDeferred=new Deferred();isLoaded=fields.Attr(false,{onUpdate(){if(this.isLoaded){this.isLoadedDeferred.resolve();}else{const def=this.isLoadedDeferred;this.isLoadedDeferred=new Deferred();this.isLoadedDeferred.then(()=>def.resolve());}},});message_main_attachment_id=fields.One("ir.attachment");message_needaction_counter=0;message_needaction_counter_bus_id=0;messageInEdition=fields.One("mail.message",{inverse:"threadAsInEdition"});messages=fields.Many("mail.message");phantomMessages=fields.Many("mail.message");modelName;module_icon;pendingNewMessages=fields.Many("mail.message");needactionMessages=fields.Many("mail.message",{inverse:"threadAsNeedaction",sort:(message1,message2)=>message1.id-message2.id,});portal_partner=fields.One("res.partner");status="new";scrollTop="bottom";transientMessages=fields.Many("mail.message");additionalRecipients=fields.Attr([]);suggestedRecipients=fields.Attr([]);partner_fields;primary_email_field;hasLoadingFailed=false;canPostOnReadonly;is_editable;isLocallyPinned=fields.Attr(false,{onUpdate(){this.onPinStateUpdated();},});fetchMembersState="not_fetched";highlightMessage=fields.One("mail.message");access_token;hash;pid;get accessRestrictedToGroupText(){if(!this.group_public_id?.full_name){return false;}
return _t('Access restricted to group "%(groupFullName)s"',{groupFullName:this.group_public_id.full_name,});}
get busChannel(){return`${this.model}_${this.id}`;}
get followersFullyLoaded(){return(this.followersCount===(this.selfFollower?this.followers.length+1:this.followers.length));}
get attachmentsInWebClientView(){const attachments=this.attachments.filter((attachment)=>(attachment.isPdf||attachment.isImage)&&!attachment.uploading);attachments.sort((a1,a2)=>a2.id-a1.id);return attachments;}
get isUnread(){return this.needactionMessages.length>0;}
get typesAllowingCalls(){return["chat","channel","group"];}
get allowCalls(){return(!this.isTransient&&this.typesAllowingCalls.includes(this.channel_type)&&!this.correspondent?.persona.eq(this.store.odoobot));}
getPersonaName(persona){return persona?.displayName||persona?.name;}
get hasAttachmentPanel(){return this.model==="discuss.channel";}
get isChatChannel(){return["chat","group"].includes(this.channel_type);}
get supportsCustomChannelName(){return this.isChatChannel&&this.channel_type!=="group";}
get displayName(){return this.display_name;}
computeIsDisplayed(){return this.store.ChatWindow.get({thread:this})?.isOpen;}
get avatarUrl(){return this.module_icon??this.store.DEFAULT_AVATAR;}
get allowDescription(){return["channel","group"].includes(this.channel_type);}
get fullNameWithParent(){const text=this.parent_channel_id?`${this.parent_channel_id.displayName} > ${this.displayName}`:this.displayName;return text;}
get isTransient(){return!this.id||this.id<0;}
get lastEditableMessageOfSelf(){const editableMessagesBySelf=this.nonEmptyMessages.filter((message)=>message.isSelfAuthored&&message.editable);if(editableMessagesBySelf.length>0){return editableMessagesBySelf.at(-1);}
return null;}
get needactionCounter(){return this.message_needaction_counter;}
newestMessage=fields.One("mail.message",{inverse:"threadAsNewest",compute(){return this.messages.at(-1);},});get newestPersistentMessage(){return this.messages.findLast((msg)=>Number.isInteger(msg.id));}
newestPersistentAllMessages=fields.Many("mail.message",{compute(){const allPersistentMessages=this.allMessages.filter((message)=>Number.isInteger(message.id));allPersistentMessages.sort((m1,m2)=>m2.id-m1.id);return allPersistentMessages;},});newestPersistentOfAllMessage=fields.One("mail.message",{compute(){return this.newestPersistentAllMessages[0];},});get oldestPersistentMessage(){return this.messages.find((msg)=>Number.isInteger(msg.id));}
onPinStateUpdated(){}
get invitationLink(){if(!this.uuid||this.channel_type==="chat"){return undefined;}
return`${window.location.origin}/chat/${this.id}/${this.uuid}`;}
get isEmpty(){return this.messages.length===0;}
get nonEmptyMessages(){return this.messages.filter((message)=>!message.isEmpty);}
get persistentMessages(){return this.messages.filter((message)=>!message.is_transient&&!message.isPending);}
get prefix(){return this.isChatChannel?"@":"#";}
get rpcParams(){return{};}
async checkReadAccess(){await this.store.Thread.getOrFetch(this,["hasReadAccess"]);return this.hasReadAccess;}
executeCommand(command,body=""){return this.store.env.services.orm.call("discuss.channel",command.methodName,[[this.id]],{body});}
async fetchMessages({after,around,before}={}){this.status="loading";if(!["mail.box","discuss.channel"].includes(this.model)&&!this.id){this.isLoaded=true;return[];}
let res;try{res=await this.fetchMessagesData({after,around,before});this.hasLoadingFailed=false;}catch(e){this.hasLoadingFailed=true;this.isLoaded=true;this.status="ready";throw e;}
this.store.insert(res.data);const msgs=this.store["mail.message"].insert(res.messages.reverse());this.isLoaded=true;this.status="ready";return msgs;}
async fetchMessagesData({after,around,before}={}){return await rpc(this.getFetchRoute(),{...this.getFetchParams(),fetch_params:{limit:!around&&around!==0?this.store.FETCH_LIMIT:this.store.FETCH_LIMIT*2,after,around,before,},});}
async fetchMoreMessages(epoch="older"){if(this.status==="loading"||(epoch==="older"&&!this.loadOlder)||(epoch==="newer"&&!this.loadNewer)){return;}
const before=epoch==="older"?this.oldestPersistentMessage?.id:undefined;const after=epoch==="newer"?this.newestPersistentMessage?.id:undefined;let fetched=[];try{fetched=await this.fetchMessages({after,before});}catch{return;}
if((after!==undefined&&!this.messages.some((message)=>message.id===after))||(before!==undefined&&!this.messages.some((message)=>message.id===before))){return;}
const alreadyKnownMessages=new Set(this.messages.map(({id})=>id));const messagesToAdd=fetched.filter((message)=>!alreadyKnownMessages.has(message.id));if(epoch==="older"){this.messages.unshift(...messagesToAdd);}else{this.messages.push(...messagesToAdd);}
if(fetched.length<this.store.FETCH_LIMIT){if(epoch==="older"){this.loadOlder=false;}else if(epoch==="newer"){this.loadNewer=false;const missingMessages=this.pendingNewMessages.filter(({id})=>!alreadyKnownMessages.has(id));if(missingMessages.length>0){this.messages.push(...missingMessages);this.messages.sort((m1,m2)=>m1.id-m2.id);}}}
this._enrichMessagesWithTransient();this.pendingNewMessages=[];}
get effectiveSelf(){return this.store.self_partner||this.store.self_guest;}
async fetchNewMessages(){if(this.status==="loading"||(this.isLoaded&&["discuss.channel","mail.box"].includes(this.model))){return;}
const after=this.isLoaded?this.newestPersistentMessage?.id:undefined;let fetched=[];try{fetched=await this.fetchMessages({after});}catch{return;}
let startIndex;if(after===undefined){startIndex=0;}else{const afterIndex=this.messages.findIndex((message)=>message.id===after);if(afterIndex===-1){return;}else{startIndex=afterIndex+1;}}
const alreadyKnownMessages=new Set(this.messages.map((m)=>m.id));const filtered=fetched.filter((message)=>!alreadyKnownMessages.has(message.id)&&(this.persistentMessages.length===0||message.id<this.oldestPersistentMessage.id||message.id>this.newestPersistentMessage.id));this.messages.splice(startIndex,0,...filtered);Object.assign(this,{loadOlder:after===undefined&&fetched.length===this.store.FETCH_LIMIT?true:after===undefined&&fetched.length!==this.store.FETCH_LIMIT?false:this.loadOlder,});}
getFetchParams(){if(this.model==="discuss.channel"){return{channel_id:this.id};}
if(this.model==="mail.box"){return{};}
return{thread_id:this.id,thread_model:this.model,...this.rpcParams,};}
getFetchRoute(){if(this.model==="discuss.channel"){return"/discuss/channel/messages";}
if(this.model==="mail.box"&&this.id==="inbox"){return`/mail/inbox/messages`;}
if(this.model==="mail.box"&&this.id==="starred"){return`/mail/starred/messages`;}
if(this.model==="mail.box"&&this.id==="history"){return`/mail/history/messages`;}
return this.fetchRouteChatter;}
get fetchRouteChatter(){return"/mail/thread/messages";}
async loadAround(messageId){if(this.status==="loading"||(this.isLoaded&&this.messages.some(({id})=>id===messageId))){return;}
this.isLoaded=false;this.scrollTop=undefined;try{this.phantomMessages=this.messages;this.messages=await this.fetchMessages({around:messageId});this.phantomMessages=[];}catch{this.isLoaded=true;return;}
this.isLoaded=true;this.loadNewer=messageId!==undefined?true:false;this.loadOlder=true;const limit=!messageId&&messageId!==0?this.store.FETCH_LIMIT:this.store.FETCH_LIMIT*2;if(this.messages.length<limit){const olderMessagesCount=this.messages.filter(({id})=>id<messageId).length;const newerMessagesCount=this.messages.filter(({id})=>id>messageId).length;if(olderMessagesCount<limit/2-1){this.loadOlder=false;}
if(newerMessagesCount<limit/2){this.loadNewer=false;}}
this._enrichMessagesWithTransient();}
async markAllMessagesAsRead(){await this.store.env.services.orm.silent.call("mail.message","mark_all_as_read",[[["model","=",this.model],["res_id","=",this.id],],]);this.message_needaction_counter=0;}
async markAsFetched(){await this.store.env.services.orm.silent.call("discuss.channel","channel_fetched",[[this.id],]);}
markAsRead(options){const newestPersistentMessage=this.newestPersistentOfAllMessage;if(!newestPersistentMessage&&!this.isLoaded){this.isLoadedDeferred.then(()=>new Promise(setTimeout)).then(()=>this.markAsRead(options));return;}
if(this.message_needaction_counter>0){this.markAllMessagesAsRead();}}
async notifyAvatarToServer(data){await rpc("/discuss/channel/update_avatar",{channel_id:this.id,data,});}
async notifyDescriptionToServer(description){this.description=description;return this.store.env.services.orm.call("discuss.channel","channel_change_description",[[this.id]],{description});}
onNewSelfMessage(message){}
open(options){return false;}
async openChatWindow({focus=false,fromMessagingMenu,bypassCompact,swapOpened}={}){const thread=await this.store.Thread.getOrFetch(this);if(!thread){return;}
await this.store.chatHub.initPromise;const cw=this.store.ChatWindow.insert(assignDefined({thread:this},{fromMessagingMenu,bypassCompact}));cw.open({focus,swapOpened});return cw;}
async closeChatWindow(options={}){await this.store.chatHub.initPromise;const chatWindow=this.store.ChatWindow.get({thread:this});await chatWindow?.close({notifyState:false,...options});}
async rename(name){const newName=name.trim();if(newName!==this.displayName&&((newName&&this.channel_type==="channel")||this.isChatChannel)){if(this.channel_type==="channel"||this.channel_type==="group"){this.name=newName;await this.store.env.services.orm.call("discuss.channel","channel_rename",[[this.id]],{name:newName});}else if(this.supportsCustomChannelName){if(this.self_member_id){this.self_member_id.custom_channel_name=newName;}
await this.store.env.services.orm.call("discuss.channel","channel_set_custom_name",[[this.id]],{name:newName});}}}
addOrReplaceMessage(message,tmpMsg){if(tmpMsg&&tmpMsg.in(this.messages)&&this.effectiveSelf.eq(message.author)){this.messages.splice(this.messages.indexOf(tmpMsg),1,message);return;}
this.messages.add(message);}
async post(body,postData={},extraData={}){let tmpMsg;postData.attachments=postData.attachments?[...postData.attachments]:[];const{attachments,parentId}=postData;const params=await this.store.getMessagePostParams({body,postData,thread:this});Object.assign(params,extraData);const tmpId=this.store.getNextTemporaryId();params.context={...user.context,...params.context,temporary_id:tmpId};if(parentId){params.post_data.parent_id=parentId;}
if(this.model!=="discuss.channel"){params.thread_id=this.id;params.thread_model=this.model;}else{const tmpData={id:tmpId,attachment_ids:attachments,res_id:this.id,model:"discuss.channel",};if(this.store.self_partner){tmpData.author_id=this.store.self_partner;}else{tmpData.author_guest_id=this.store.self_guest;}
if(parentId){tmpData.parent_id=this.store["mail.message"].get(parentId);}
tmpMsg=this.store["mail.message"].insert({...tmpData,body:await generateEmojisOnHtml(body),isPending:true,thread:this,});this.messages.push(tmpMsg);this.onNewSelfMessage(tmpMsg);}
const data=await this.store.doMessagePost(params,tmpMsg);if(!data){return;}
this.store.insert(data.store_data);const message=this.store["mail.message"].get(data.message_id);this.addOrReplaceMessage(message,tmpMsg);this.onNewSelfMessage(message);tmpMsg?.delete();if(message.hasLink&&this.store.hasLinkPreviewFeature){rpc("/mail/link_preview",{message_id:message.id},{silent:true});}
return message;}
async setMainAttachmentFromIndex(index){this.message_main_attachment_id=this.attachmentsInWebClientView[index];await this.store.env.services.orm.call("ir.attachment","register_as_main_attachment",[this.message_main_attachment_id.id,]);}
_enrichMessagesWithTransient(){for(const message of this.transientMessages){if(message.id<this.oldestPersistentMessage&&!this.loadOlder){this.messages.unshift(message);}else if(message.id>this.newestPersistentMessage&&!this.loadNewer){this.messages.push(message);}else{let afterIndex=this.messages.findIndex((msg)=>msg.id>message.id);if(afterIndex===-1){afterIndex=this.messages.length+1;}
this.messages.splice(afterIndex-1,0,message);}}}
async leaveChannel({force=false}={}){if(this.channel_type!=="group"&&this.create_uid?.eq(this.store.self.main_user_id)&&!force){await this.askLeaveConfirmation(_t("You are the administrator of this channel. Are you sure you want to leave?"));}
if(this.channel_type==="group"&&!force){await this.askLeaveConfirmation(_t("You are about to leave this group conversation and will no longer have access to it unless you are invited again. Are you sure you want to continue?"));}
await this.closeChatWindow();await this.store.env.services.orm.silent.call("discuss.channel","action_unfollow",[this.id,]);}
_getActualModelName(){return this.model==="discuss.channel"?"discuss.channel":"mail.thread";}}
Thread.register();return __exports;});;

/* /mail/static/src/core/common/volume_model.js */
odoo.define('@mail/core/common/volume_model',['@mail/core/common/record'],function(require){'use strict';let __exports={};const{OR,fields,Record}=require("@mail/core/common/record");const Volume=__exports.Volume=class Volume extends Record{static id=OR("partner_id","guest_id");partner_id=fields.One("res.partner");guest_id=fields.One("mail.guest");get persona(){return this.partner_id||this.guest_id;}
volume=1;}
Volume.register();return __exports;});;

/* /mail/static/src/core/web_portal/message_patch.js */
odoo.define('@mail/core/web_portal/message_patch',['@web/core/utils/patch','@mail/core/common/message','@odoo/owl'],function(require){'use strict';let __exports={};const{patch}=require("@web/core/utils/patch");const{Message}=require("@mail/core/common/message");const{onWillUnmount}=require("@odoo/owl");patch(Message.prototype,{setup(){super.setup(...arguments);this.state.lastReadMoreIndex=0;this.state.isReadMoreByIndex=new Map();onWillUnmount(()=>{this.messageBody.el?.querySelector(".o-mail-ellipsis")?.remove();});},prepareMessageBody(bodyEl){if(!bodyEl){return;}
super.prepareMessageBody(...arguments);Array.from(bodyEl.querySelectorAll(".o-mail-ellipsis")).forEach((el)=>el.remove());this.insertEllipsisbtn(bodyEl);},insertEllipsisbtn(bodyEl){function prevAll(e,selector){const res=[];while((e=e.previousElementSibling)){if(e.matches(selector)){res.push(e);}}
return res;}
function prev(e,selector){while((e=e.previousElementSibling)){if(e.matches(selector)){return e;}}}
function hide(el){el.dataset.oMailDisplay=el.style.display;el.style.display="none";}
function toggle(el,condition=false){if(condition){let newDisplay=el.dataset.oMailDisplay;if(newDisplay==="none"){newDisplay=null;}
el.style.display=newDisplay;}else{hide(el);}}
const groups=[];let ellipsisNodes;const ELEMENT_NODE=1;const TEXT_NODE=3;const childrenEl=Array.from(bodyEl.childNodes).filter(function(childEl){return(childEl.nodeType===ELEMENT_NODE||(childEl.nodeType===TEXT_NODE&&childEl.nodeValue.trim()));});for(const childEl of childrenEl){if(childEl.nodeType===TEXT_NODE&&prevAll(childEl,'[id*="stopSpelling"]').length>0){const newChildEl=document.createElement("span");newChildEl.textContent=childEl.textContent;newChildEl.dataset.oMailQuote="1";childEl.parentNode.replaceChild(newChildEl,childEl);}
if((childEl.nodeType===ELEMENT_NODE&&childEl.getAttribute("data-o-mail-quote"))||(childEl.nodeName==="BR"&&prev(childEl,'[data-o-mail-quote="1"]'))){if(!ellipsisNodes){ellipsisNodes=[];groups.push(ellipsisNodes);}
hide(childEl);ellipsisNodes.push(childEl);}else{ellipsisNodes=undefined;this.insertEllipsisbtn(childEl);}}
for(const group of groups){const index=this.state.lastReadMoreIndex++;const ellipsisbtnEl=document.createElement("button");ellipsisbtnEl.className="o-mail-ellipsis badge rounded-pill border-0 py-0 px-1";const iconellipsisEl=document.createElement("i");iconellipsisEl.className="oi oi-ellipsis-h oi-large";ellipsisbtnEl.append(iconellipsisEl);group[0].parentNode.insertBefore(ellipsisbtnEl,group[0]);if(!this.state.isReadMoreByIndex.has(index)){this.state.isReadMoreByIndex.set(index,true);}
const updateFromState=()=>{const isReadMore=this.state.isReadMoreByIndex.get(index);for(const childEl of group){hide(childEl);toggle(childEl,!isReadMore);}};ellipsisbtnEl.addEventListener("click",(e)=>{e.preventDefault();this.state.isReadMoreByIndex.set(index,!this.state.isReadMoreByIndex.get(index));updateFromState();});updateFromState();}},});return __exports;});;

/* /mail/static/src/discuss/call/common/blur_manager.js */
odoo.define('@mail/discuss/call/common/blur_manager',['@mail/utils/common/misc','@web/core/browser/browser'],function(require){'use strict';let __exports={};const{closeStream}=require("@mail/utils/common/misc");const{browser}=require("@web/core/browser/browser");const FPS=30;function drawAndBlurImageOnCanvas(image,blurAmount,canvas){canvas.width=image.width;canvas.height=image.height;if(blurAmount===0){canvas.getContext("2d").drawImage(image,0,0,image.width,image.height);return;}
canvas.getContext("2d").clearRect(0,0,image.width,image.height);canvas.getContext("2d").save();canvas.getContext("2d").filter=`blur(${blurAmount}px)`;canvas.getContext("2d").drawImage(image,0,0,image.width,image.height);canvas.getContext("2d").restore();}
const BlurManager=__exports.BlurManager=class BlurManager{canvas=document.createElement("canvas");canvasBlur=document.createElement("canvas");canvasMask=document.createElement("canvas");canvasStream;isVideoDataLoaded=false;rejectStreamPromise;resolveStreamPromise;selfieSegmentation=new window.SelfieSegmentation({locateFile:(file)=>{return`https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation@0.1/${file}`;},});stream;video=document.createElement("video");worker;constructor(stream,{backgroundBlur=10,edgeBlur=10,modelSelection=1,selfieMode=false}={}){this.edgeBlur=edgeBlur;this.backgroundBlur=backgroundBlur;this._onVideoPlay=this._onVideoPlay.bind(this);this.video.addEventListener("loadeddata",this._onVideoPlay);this.canvas.getContext("2d");this.canvasStream=this.canvas.captureStream();let rejectStreamPromise;let resolveStreamPromise;Object.assign(this,{stream:new Promise((resolve,reject)=>{rejectStreamPromise=reject;resolveStreamPromise=resolve;}),rejectStreamPromise,resolveStreamPromise,});try{this.worker=new Worker("/mail/static/src/discuss/call/common/tick_worker.js");this.worker.onmessage=(e)=>this._handleWorkerMessage(e);this.worker.onerror=()=>{this._terminateWorker();this._requestFrame();};}catch{this.worker=null;}
this.video.srcObject=stream;this.video.load();this.selfieSegmentation.setOptions({selfieMode,modelSelection,});this.selfieSegmentation.onResults((r)=>this._onSelfieSegmentationResults(r));this.video.autoplay=true;Promise.resolve(this.video.play()).catch(()=>{});}
close(){this.video.removeEventListener("loadeddata",this._onVideoPlay);this.video.srcObject=null;this.isVideoDataLoaded=false;this.selfieSegmentation.reset();closeStream(this.canvasStream);this.canvasStream=null;this._terminateWorker();if(this.rejectStreamPromise){this.rejectStreamPromise(new Error("The source stream was removed before the beginning of the blur process"));}}
async _handleWorkerMessage(e){if(e.data.command==="tick"){await this._onFrame();this.worker.postMessage({command:"tock"});}}
_terminateWorker(){if(this.worker){this.worker.postMessage({command:"stop"});this.worker.terminate();}
this.worker=null;}
_drawWithCompositing(image,compositeOperation){this.canvas.getContext("2d").globalCompositeOperation=compositeOperation;this.canvas.getContext("2d").drawImage(image,0,0);}
_onVideoPlay(){this.isVideoDataLoaded=true;if(this.worker){this.worker.postMessage({command:"start",fps:FPS});}else{this._requestFrame();}}
async _onFrame(){if(!this.selfieSegmentation){return;}
if(!this.video){return;}
if(!this.isVideoDataLoaded){return;}
await this.selfieSegmentation.send({image:this.video});}
_onSelfieSegmentationResults(results){drawAndBlurImageOnCanvas(results.image,this.backgroundBlur,this.canvasBlur);this.canvas.width=this.canvasBlur.width;this.canvas.height=this.canvasBlur.height;drawAndBlurImageOnCanvas(results.segmentationMask,this.edgeBlur,this.canvasMask);this.canvas.getContext("2d").save();this.canvas.getContext("2d").drawImage(results.image,0,0,this.canvas.width,this.canvas.height);this._drawWithCompositing(this.canvasMask,"destination-in");this._drawWithCompositing(this.canvasBlur,"destination-over");this.canvas.getContext("2d").restore();if(this.resolveStreamPromise){this.resolveStreamPromise(this.canvasStream);this.resolveStreamPromise=null;}}
_requestFrame(){if(!this.isVideoDataLoaded){return;}
browser.requestAnimationFrame(async()=>{await this._onFrame();if(!this.worker){browser.setTimeout(()=>this._requestFrame(),Math.floor(1000/FPS));}});}}
return __exports;});;

/* /mail/static/src/discuss/call/common/blur_performance_warning.js */
odoo.define('@mail/discuss/call/common/blur_performance_warning',['@mail/discuss/call/common/call_dropdown','@odoo/owl','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{CallDropdown}=require("@mail/discuss/call/common/call_dropdown");const{Component}=require("@odoo/owl");const{useService}=require("@web/core/utils/hooks");const BlurPerformanceWarning=__exports.BlurPerformanceWarning=class BlurPerformanceWarning extends Component{static template="discuss.BlurPerformanceWarning";static props={};static components={CallDropdown};setup(){this.store=useService("mail.store");}
onClickClose(){this.store.settings.blurPerformanceWarning=false;}}
return __exports;});;

/* /mail/static/src/discuss/call/common/call.js */
odoo.define('@mail/discuss/call/common/call',['@mail/discuss/call/common/blur_performance_warning','@mail/discuss/call/common/call_action_list','@mail/discuss/call/common/call_participant_card','@mail/discuss/call/common/ptt_ad_banner','@odoo/owl','@web/core/browser/browser','@web/core/browser/feature_detection','@web/core/hotkeys/hotkey_hook','@web/core/utils/hooks','@web/core/utils/misc','@mail/discuss/call/common/call_actions','@mail/core/common/action_list','@mail/core/common/action','@mail/utils/common/hooks'],function(require){'use strict';let __exports={};const{BlurPerformanceWarning}=require("@mail/discuss/call/common/blur_performance_warning");const{CallActionList}=require("@mail/discuss/call/common/call_action_list");const{CallParticipantCard}=require("@mail/discuss/call/common/call_participant_card");const{PttAdBanner}=require("@mail/discuss/call/common/ptt_ad_banner");const{Component,onMounted,onPatched,onWillUnmount,toRaw,useRef,useState}=require("@odoo/owl");const{browser}=require("@web/core/browser/browser");const{isMobileOS}=require("@web/core/browser/feature_detection");const{useHotkey}=require("@web/core/hotkeys/hotkey_hook");const{useService}=require("@web/core/utils/hooks");const{isEventHandled,markEventHandled}=require("@web/core/utils/misc");const{useCallActions}=require("@mail/discuss/call/common/call_actions");const{ActionList}=require("@mail/core/common/action_list");const{ACTION_TAGS}=require("@mail/core/common/action");const{inDiscussCallViewProps,useInDiscussCallView}=require("@mail/utils/common/hooks");const Call=__exports.Call=class Call extends Component{static components={ActionList,BlurPerformanceWarning,CallActionList,CallParticipantCard,PttAdBanner,};static props=["thread?","compact?","hasOverlay?",...inDiscussCallViewProps];static defaultProps={hasOverlay:true};static template="discuss.Call";overlayTimeout;setup(){super.setup();this.grid=useRef("grid");this.root=useRef("root");this.notification=useService("notification");this.rtc=useService("discuss.rtc");this.isMobileOs=isMobileOS();this.ui=useService("ui");this.state=useState({sidebar:false,tileWidth:0,tileHeight:0,columnCount:0,overlay:false,insetCard:undefined,});this.store=useService("mail.store");this.callActions=useCallActions({thread:()=>this.channel});onMounted(()=>{this.resizeObserver=new ResizeObserver(()=>this.arrangeTiles());this.resizeObserver.observe(this.grid.el);this.arrangeTiles();});onPatched(()=>this.arrangeTiles());onWillUnmount(()=>{this.resizeObserver.disconnect();browser.clearTimeout(this.overlayTimeout);});useHotkey("shift+d",()=>this.rtc.toggleDeafen());useHotkey("shift+m",()=>this.rtc.toggleMicrophone());useInDiscussCallView();}
get layoutActions(){if(!this.isActiveCall){return[];}
return this.callActions.actions.filter((action)=>action.tags.includes(ACTION_TAGS.CALL_LAYOUT));}
get isFullSize(){return this.props.isPip||this.rtc.state.isFullscreen;}
get isActiveCall(){return Boolean(this.channel.eq(this.rtc.channel));}
get minimized(){if(this.rtc.state.isFullscreen||!this.channel||this.channel.activeRtcSession){return false;}
if(!this.isActiveCall||this.channel.videoCount===0||this.props.compact){return true;}
return false;}
get channel(){return this.props.thread||this.rtc.channel;}
get visibleMainCards(){const activeSession=this.channel.activeRtcSession;if(!activeSession){this.state.insetCard=undefined;return this.channel.visibleCards;}
const type=activeSession.mainVideoStreamType;if(type==="screen"||activeSession.is_screen_sharing_on){this.setInset(activeSession,type==="camera"?"screen":"camera");}else{this.state.insetCard=undefined;}
return[{key:"session_"+activeSession.id,session:activeSession,type,videoStream:activeSession.getStream(type),},];}
setInset(session,videoType){const key="session_"+session.id;if(toRaw(this.state).insetCard?.key===key){this.state.insetCard.type=videoType;this.state.insetCard.videoStream=session.getStream(videoType);}else{this.state.insetCard={key,session,type:videoType,videoStream:session.getStream(videoType),};}}
get hasCallNotifications(){return Boolean((!this.props.compact||this.rtc.state.isFullscreen)&&this.isActiveCall&&this.rtc.notifications.size);}
get hasSidebarButton(){return Boolean(this.channel.activeRtcSession&&this.state.overlay&&(!this.props.compact||this.rtc.state.isFullscreen));}
get isControllerFloating(){return this.rtc.state.isFullscreen||(this.channel.activeRtcSession&&!this.ui.isSmall);}
onMouseleaveMain(ev){if(ev.relatedTarget&&ev.relatedTarget.closest(".o-dropdown--menu")){return;}
this.state.overlay=false;}
onMousemoveMain(ev){if(isEventHandled(ev,"CallMain.MousemoveOverlay")){return;}
this.showOverlay();}
onMousemoveOverlay(ev){markEventHandled(ev,"CallMain.MousemoveOverlay");this.state.overlay=true;browser.clearTimeout(this.overlayTimeout);}
showOverlay(){this.state.overlay=true;browser.clearTimeout(this.overlayTimeout);this.overlayTimeout=browser.setTimeout(()=>{this.state.overlay=false;},3000);}
arrangeTiles(){if(!this.grid.el){return;}
this.grid.el.style.setProperty("--width","0");this.grid.el.style.setProperty("--height","0");const{width,height}=this.grid.el.getBoundingClientRect();const aspectRatio=this.minimized?1:16/9;const tileCount=this.grid.el.children.length;let optimal={area:0,columnCount:0,tileHeight:0,tileWidth:0,};for(let columnCount=1;columnCount<=tileCount;columnCount++){const rowCount=Math.ceil(tileCount/columnCount);const potentialHeight=width/(columnCount*aspectRatio);const potentialWidth=height/rowCount;let tileHeight;let tileWidth;if(potentialHeight>potentialWidth){tileHeight=Math.floor(potentialWidth);tileWidth=Math.floor(tileHeight*aspectRatio);}else{tileWidth=Math.floor(width/columnCount);tileHeight=Math.floor(tileWidth/aspectRatio);}
const area=tileHeight*tileWidth;if(area<=optimal.area){continue;}
optimal={area,columnCount,tileHeight,tileWidth,};}
Object.assign(this.state,{tileWidth:optimal.tileWidth,tileHeight:optimal.tileHeight,columnCount:optimal.columnCount,});this.grid.el.style.setProperty("--width",`${this.state.tileWidth}px`);this.grid.el.style.setProperty("--height",`${this.state.tileHeight}px`);}}
return __exports;});;

/* /mail/static/src/discuss/call/common/call_action_list.js */
odoo.define('@mail/discuss/call/common/call_action_list',['@odoo/owl','@web/core/browser/feature_detection','@web/core/l10n/translation','@web/core/utils/hooks','@mail/discuss/call/common/call_actions','@web/core/popover/popover_hook','@web/core/tooltip/tooltip','@mail/discuss/call/common/thread_model_patch','@mail/core/common/action_list','@mail/core/common/action'],function(require){'use strict';let __exports={};const{Component,onWillRender,toRaw,useRef}=require("@odoo/owl");const{isMobileOS}=require("@web/core/browser/feature_detection");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{useService}=require("@web/core/utils/hooks");const{useCallActions}=require("@mail/discuss/call/common/call_actions");const{usePopover}=require("@web/core/popover/popover_hook");const{Tooltip}=require("@web/core/tooltip/tooltip");const{CALL_PROMOTE_FULLSCREEN}=require("@mail/discuss/call/common/thread_model_patch");const{ActionList}=require("@mail/core/common/action_list");const{ACTION_TAGS}=require("@mail/core/common/action");const CallActionList=__exports.CallActionList=class CallActionList extends Component{static components={ActionList};static props=["thread","compact?"];static template="discuss.CallActionList";setup(){super.setup();this.store=useService("mail.store");this.rtc=useService("discuss.rtc");this.pipService=useService("discuss.pip_service");this.callActions=useCallActions({thread:()=>this.props.thread});this.more=useRef("more");this.root=useRef("root");this.popover=usePopover(Tooltip,{position:"top-middle",});onWillRender(()=>{const partition=toRaw(this.callActions).partition;const other=partition.other.filter((a)=>!a.tags.includes(ACTION_TAGS.CALL_LAYOUT));const group2=[];for(const groupActions of partition.group){const filtered=groupActions.filter((a)=>!a.tags.includes(ACTION_TAGS.CALL_LAYOUT));const sequenceGroup=filtered[0].sequenceGroup;const maxQuickActions=sequenceGroup===200?1:4;const quickActions=filtered.slice(0,maxQuickActions);const moreActions=filtered.slice(maxQuickActions);const newGroup=moreActions?.length?[...quickActions,this.callActions.more({actions:moreActions,dropdownMenuClass:"m-0 mb-1",dropdownPosition:"top-end",name:this.MORE,},sequenceGroup),]:quickActions;group2.push(newGroup);}
this.actions=[...group2,other];});}
get isPromotingFullscreen(){return Boolean(!this.env.pipWindow&&this.props.thread.promoteFullscreen===CALL_PROMOTE_FULLSCREEN.ACTIVE);}
get MORE(){return _t("More");}
get isOfActiveCall(){return Boolean(this.props.thread.eq(this.rtc.channel));}
get isSmall(){return Boolean(this.props.compact&&this.rtc.state.isFullscreen);}
get isMobileOS(){return isMobileOS();}
onMouseenterMore(){if(this.isPromotingFullscreen){this.popover.open(this.more.el,{tooltip:_t("Enter full screen!")});this.props.thread.promoteFullscreen=CALL_PROMOTE_FULLSCREEN.DISCARDED;}}
onMouseleaveMore(){if(this.popover.isOpen){this.popover.close();}}
onClickMore(){if(this.popover.isOpen){this.popover.close();}}}
return __exports;});;

/* /mail/static/src/discuss/call/common/call_actions.js */
odoo.define('@mail/discuss/call/common/call_actions',['@mail/core/common/action','@odoo/owl','@web/core/browser/feature_detection','@web/core/l10n/translation','@web/core/registry','@web/core/utils/hooks','@mail/discuss/call/common/quick_voice_settings','@mail/discuss/call/common/quick_video_settings','@mail/utils/common/format','@mail/discuss/call/common/thread_model_patch'],function(require){'use strict';let __exports={};const{Action,ACTION_TAGS,UseActions}=require("@mail/core/common/action");const{useComponent,useState}=require("@odoo/owl");const{isMobileOS}=require("@web/core/browser/feature_detection");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{registry}=require("@web/core/registry");const{useService}=require("@web/core/utils/hooks");const{QuickVoiceSettings}=require("@mail/discuss/call/common/quick_voice_settings");const{QuickVideoSettings}=require("@mail/discuss/call/common/quick_video_settings");const{attClassObjectToString}=require("@mail/utils/common/format");const{CALL_PROMOTE_FULLSCREEN}=require("@mail/discuss/call/common/thread_model_patch");const callActionsRegistry=__exports.callActionsRegistry=registry.category("discuss.call/actions");const CALL_ICON_DEAFEN=__exports.CALL_ICON_DEAFEN="fa fa-deaf";const CALL_ICON_MUTED=__exports.CALL_ICON_MUTED="fa fa-microphone-slash";__exports.registerCallAction=registerCallAction;function registerCallAction(id,definition){callActionsRegistry.add(id,definition);}
const muteAction=__exports.muteAction={badge:({owner,store})=>!owner.env.inCallMenu&&store.rtc.microphonePermission!=="granted",badgeIcon:"fa fa-exclamation",condition:({owner,store,thread})=>thread?.isSelfInCall&&(owner.env.inCallMenu||!store.rtc.selfSession?.is_deaf),name:({store})=>(store.rtc.selfSession.isMute?_t("Unmute"):_t("Mute")),isActive:({store})=>(store.rtc.selfSession?.isMute&&store.rtc.microphonePermission==="granted")||store.rtc.selfSession?.is_deaf,isTracked:true,icon:({action,owner,store})=>action.isActive?store.rtc.selfSession?.is_deaf&&!owner.env.inCallMenu?CALL_ICON_DEAFEN:CALL_ICON_MUTED:"fa fa-microphone",hotkey:"shift+m",onSelected:({store})=>store.rtc.toggleMicrophone(),sequence:10,sequenceGroup:100,tags:({action,store})=>{const tags=[];if(action.isActive){tags.push(ACTION_TAGS.DANGER);}
if(store.rtc.microphonePermission!=="granted"){tags.push(ACTION_TAGS.DANGER,ACTION_TAGS.WARNING_BADGE);}
return tags;},};registerCallAction("mute",muteAction);const quickActionSettings=__exports.quickActionSettings={condition:({owner,thread})=>!owner.env.inCallMenu&&thread?.isSelfInCall,dropdown:true,dropdownComponent:QuickVoiceSettings,dropdownMenuClass:"p-2",dropdownPosition:"top-end",icon:"oi oi-chevron-up o-xsmaller",name:_t("Voice Settings"),sequence:15,sequenceGroup:100,};registerCallAction("quick-voice-settings",quickActionSettings);registerCallAction("deafen",{condition:({owner,store,thread})=>thread?.isSelfInCall&&(owner.env.inCallMenu||store.rtc.selfSession?.is_deaf),name:({store})=>(store.rtc.selfSession.is_deaf?_t("Undeafen"):_t("Deafen")),isActive:({store})=>store.rtc.selfSession?.is_deaf,isTracked:true,icon:({action})=>(action.isActive?CALL_ICON_DEAFEN:"fa fa-headphones"),hotkey:"shift+d",onSelected:({store})=>store.rtc.toggleDeafen(),sequence:10,sequenceGroup:100,tags:({action})=>(action.isActive?ACTION_TAGS.DANGER:undefined),});const cameraOnAction=__exports.cameraOnAction={badge:({owner,store})=>!owner.env.inCallMenu&&store.rtc.cameraPermission!=="granted",badgeIcon:"fa fa-exclamation",condition:({thread})=>thread?.isSelfInCall,disabledCondition:({store})=>store.rtc?.isRemote,name:({store})=>store.rtc?.isRemote?_t("Camera is unavailable outside the call tab."):store.rtc.selfSession.is_camera_on?_t("Stop camera"):_t("Turn camera on"),isActive:({store})=>store.rtc.selfSession?.is_camera_on,isTracked:true,icon:"fa fa-video-camera",onSelected:({owner,store})=>store.rtc.toggleVideo("camera",{env:owner.env}),sequence:10,sequenceGroup:120,tags:({action,store})=>{const tags=[];if(action.isActive){tags.push(ACTION_TAGS.SUCCESS);}
if(store.rtc.cameraPermission!=="granted"){tags.push(ACTION_TAGS.DANGER,ACTION_TAGS.WARNING_BADGE);}
return tags;},};registerCallAction("camera-on",cameraOnAction);const quickVideoSettings=__exports.quickVideoSettings={condition:({owner,thread})=>!owner.env.inCallMenu&&thread?.isSelfInCall,dropdown:true,dropdownComponent:QuickVideoSettings,dropdownMenuClass:"p-2",dropdownPosition:"top-end",icon:"oi oi-chevron-up o-xsmaller",name:_t("Video Settings"),sequence:15,sequenceGroup:120,};registerCallAction("quick-video-settings",quickVideoSettings);const switchCameraAction=__exports.switchCameraAction={condition:({store,thread})=>thread?.isSelfInCall&&isMobileOS()&&store.rtc.selfSession?.is_camera_on,name:_t("Switch Camera"),isActive:false,icon:"fa fa-refresh",onSelected:({store})=>store.rtc.toggleCameraFacingMode(),sequence:40,sequenceGroup:100,};registerCallAction("switch-camera",switchCameraAction);registerCallAction("raise-hand",{condition:({thread})=>thread?.isSelfInCall,name:({store})=>(store.rtc.selfSession.raisingHand?_t("Lower Hand"):_t("Raise Hand")),isActive:({store})=>store.rtc.selfSession?.raisingHand,isTracked:true,icon:"fa fa-hand-paper-o",onSelected:({store})=>store.rtc.raiseHand(!store.rtc.selfSession.raisingHand),sequence:50,sequenceGroup:200,});registerCallAction("share-screen",{condition:({thread})=>thread?.isSelfInCall&&!isMobileOS(),disabledCondition:({store})=>store.rtc?.isRemote,name:({store})=>store.rtc?.isRemote?_t("Screen sharing is unavailable outside the call tab."):store.rtc.selfSession.is_screen_sharing_on?_t("Stop Sharing Screen"):_t("Share Screen"),isTracked:true,isActive:({store})=>store.rtc.selfSession?.is_screen_sharing_on,icon:"fa fa-desktop",onSelected:({owner,store})=>store.rtc.toggleVideo("screen",{env:owner.env}),sequence:40,sequenceGroup:200,tags:({action})=>(action.isActive?ACTION_TAGS.SUCCESS:undefined),});registerCallAction("auto-focus",{condition:({owner,thread})=>!owner.env.inCallMenu&&thread?.isSelfInCall,name:({store})=>store.settings.useCallAutoFocus?_t("Disable speaker autofocus"):_t("Autofocus speaker"),isActive:({store})=>store.settings?.useCallAutoFocus,icon:({action})=>(action.isActive?"fa fa-eye":"fa fa-eye-slash"),onSelected:({store})=>(store.settings.useCallAutoFocus=!store.settings.useCallAutoFocus),sequence:50,sequenceGroup:200,});const blurBackgroundAction=__exports.blurBackgroundAction={condition:false,name:({store})=>(store.settings.useBlur?_t("Remove Blur"):_t("Blur Background")),isActive:({store})=>store?.settings?.useBlur,icon:"fa fa-photo",onSelected:({store})=>(store.settings.useBlur=!store.settings.useBlur),sequence:60,sequenceGroup:200,};registerCallAction("fullscreen",{btnClass:({thread})=>attClassObjectToString({"o-discuss-CallActionList-pulse":Boolean(thread.promoteFullscreen===CALL_PROMOTE_FULLSCREEN.ACTIVE),}),condition:({thread})=>thread?.isSelfInCall,name:({store})=>(store.rtc.state.isFullscreen?_t("Exit Fullscreen"):_t("Fullscreen")),isActive:({store})=>store.rtc.state.isFullscreen,icon:({action})=>(action.isActive?"fa fa-compress":"fa fa-expand"),onSelected:({store,thread})=>{thread.promoteFullscreen=CALL_PROMOTE_FULLSCREEN.DISCARDED;if(store.rtc.state.isFullscreen){store.rtc.exitFullscreen();}else{store.rtc.closePip();store.rtc.enterFullscreen();}},sequence:80,tags:ACTION_TAGS.CALL_LAYOUT,});registerCallAction("picture-in-picture",{condition:({owner,store,thread})=>!owner.env.inCallMenu&&thread?.isSelfInCall&&store.env.services["discuss.pip_service"]&&!store.env?.isSmall,disabledCondition:({store})=>store.rtc?.isRemote,name:({store})=>store.rtc?.state.isPipMode?_t("Exit Picture in Picture"):_t("Picture in Picture"),isActive:({store})=>store.rtc?.state.isPipMode,icon:"oi oi-launch",onSelected:({owner,store,thread})=>{thread.promoteFullscreen=CALL_PROMOTE_FULLSCREEN.DISCARDED;const isPipMode=store.rtc?.state.isPipMode;if(isPipMode){store.rtc.closePip();}else{store.rtc.openPip({context:owner});}},sequence:70,tags:ACTION_TAGS.CALL_LAYOUT,});const acceptWithCamera=__exports.acceptWithCamera={condition:({thread})=>thread?.self_member_id?.rtc_inviting_session_id?.is_camera_on&&typeof thread?.useCameraByDefault!=="boolean",disabledCondition:({store})=>store.rtc?.state.hasPendingRequest,name:_t("Accept with camera"),icon:"fa fa-video-camera",onSelected:({store,thread})=>store.rtc.toggleCall(thread,{camera:true}),sequence:100,sequenceGroup:300,tags:[ACTION_TAGS.JOIN_LEAVE_CALL,ACTION_TAGS.SUCCESS],};registerCallAction("accept-with-camera",acceptWithCamera);registerCallAction("join-back",{btnClass:({owner})=>attClassObjectToString({"text-nowrap pe-2 rounded-pill":true,"mx-1":!owner.env.inCallInvitation,}),condition:({thread})=>!thread?.isSelfInCall&&typeof thread?.useCameraByDefault==="boolean",disabledCondition:({store})=>store.rtc?.state.hasPendingRequest,icon:({thread})=>(thread.useCameraByDefault?"fa fa-video-camera":"fa fa-phone"),inlineName:({owner})=>(owner.env.inCallInvitation?undefined:_t("Join")),name:({thread})=>(thread.useCameraByDefault?_t("Join Video Call"):_t("Join Call")),onSelected:({store,thread})=>store.rtc.toggleCall(thread,{camera:thread.useCameraByDefault}),sequence:110,sequenceGroup:300,tags:[ACTION_TAGS.JOIN_LEAVE_CALL,ACTION_TAGS.SUCCESS],});registerCallAction("join-with-camera",{btnClass:"text-nowrap",condition:({thread})=>!thread?.isSelfInCall&&!thread?.self_member_id?.rtc_inviting_session_id&&typeof thread?.useCameraByDefault!=="boolean",disabledCondition:({store})=>store.rtc?.state.hasPendingRequest,name:_t("Join Video Call"),icon:"fa fa-video-camera",onSelected:({store,thread})=>store.rtc.toggleCall(thread,{camera:true}),sequence:120,sequenceGroup:300,tags:[ACTION_TAGS.JOIN_LEAVE_CALL,ACTION_TAGS.SUCCESS],});const joinAction=__exports.joinAction={condition:({thread})=>!thread?.isSelfInCall&&typeof thread?.useCameraByDefault!=="boolean",disabledCondition:({store})=>store.rtc?.state.hasPendingRequest,name:_t("Join Call"),icon:"fa fa-phone",onSelected:({store,thread},ev)=>store.rtc.toggleCall(thread),sequence:130,sequenceGroup:300,tags:[ACTION_TAGS.JOIN_LEAVE_CALL,ACTION_TAGS.SUCCESS],};registerCallAction("join",joinAction);const rejectAction=__exports.rejectAction={btnClass:({owner,thread})=>attClassObjectToString({"pe-2 rounded-pill":typeof thread?.useCameraByDefault==="boolean","mx-1":!owner.env.inCallInvitation&&typeof thread?.useCameraByDefault==="boolean",}),condition:({thread})=>thread?.self_member_id?.rtc_inviting_session_id,disabledCondition:({store})=>store.rtc?.state.hasPendingRequest,icon:"oi oi-close",inlineName:({owner,thread})=>!owner.env.inCallInvitation&&typeof thread?.useCameraByDefault==="boolean"?_t("Reject"):undefined,name:_t("Reject"),onSelected:({store,thread})=>{if(store.rtc.state.hasPendingRequest){return;}
store.rtc.leaveCall(thread);},sequence:140,sequenceGroup:300,tags:[ACTION_TAGS.JOIN_LEAVE_CALL,ACTION_TAGS.DANGER],};registerCallAction("reject",rejectAction);registerCallAction("disconnect",{condition:({thread})=>thread?.isSelfInCall&&!thread?.self_member_id?.rtc_inviting_session_id,disabledCondition:({store})=>store.rtc?.state.hasPendingRequest,name:_t("Disconnect"),icon:"fa fa-phone",onSelected:({store,thread})=>store.rtc.toggleCall(thread),sequence:150,sequenceGroup:300,tags:[ACTION_TAGS.JOIN_LEAVE_CALL,ACTION_TAGS.DANGER],});const CallAction=__exports.CallAction=class CallAction extends Action{threadFn;constructor({thread}){super(...arguments);this.threadFn=typeof thread==="function"?thread:()=>thread;}
get params(){return Object.assign(super.params,{thread:this.threadFn()});}
get isTracked(){return this.definition.isTracked;}}
class UseCallActions extends UseActions{ActionClass=CallAction;}
__exports.useCallActions=useCallActions;function useCallActions({thread}={}){const component=useComponent();const transformedActions=callActionsRegistry.getEntries().map(([id,definition])=>new CallAction({owner:component,id,definition,thread}));return useState(new UseCallActions(component,transformedActions,useService("mail.store")));}
return __exports;});;

/* /mail/static/src/discuss/call/common/call_components.js */
odoo.define('@mail/discuss/call/common/call_components',['@web/core/registry','@mail/discuss/call/common/call','@mail/discuss/call/common/meeting'],function(require){'use strict';let __exports={};const{registry}=require("@web/core/registry");const{Call}=require("@mail/discuss/call/common/call");const{Meeting}=require("@mail/discuss/call/common/meeting");const callComponentsRegistry=registry.category("discuss.call/components");callComponentsRegistry.add("Call",Call).add("Meeting",Meeting);return __exports;});;

/* /mail/static/src/discuss/call/common/call_context_menu.js */
odoo.define('@mail/discuss/call/common/call_context_menu',['@odoo/owl','@web/core/browser/browser','@web/core/l10n/translation','@web/core/utils/hooks','@mail/discuss/call/common/rtc_service'],function(require){'use strict';let __exports={};const{Component,onMounted,onWillUnmount,useState}=require("@odoo/owl");const{browser}=require("@web/core/browser/browser");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{useService}=require("@web/core/utils/hooks");const{CONNECTION_TYPES}=require("@mail/discuss/call/common/rtc_service");const PROTOCOLS_TEXT={host:"HOST",srflx:"STUN",prflx:"STUN",relay:"TURN"};const CallContextMenu=__exports.CallContextMenu=class CallContextMenu extends Component{static props=["rtcSession","close?"];static template="discuss.CallContextMenu";updateStatsTimeout;rtcConnectionTypes=CONNECTION_TYPES;setup(){super.setup();this.store=useService("mail.store");this.rtc=useService("discuss.rtc");this.state=useState({downloadStats:{},uploadStats:{},producerStats:{},peerStats:{},rangeVolume:this.volume,});onMounted(()=>{if(!this.env.debug){return;}
this.updateStats();this.updateStatsTimeout=browser.setInterval(()=>this.updateStats(),3000);});onWillUnmount(()=>browser.clearInterval(this.updateStatsTimeout));}
get isSelf(){return this.rtc.selfSession?.eq(this.props.rtcSession);}
get inboundConnectionTypeText(){const candidateType=this.rtc.state.connectionType===CONNECTION_TYPES.SERVER?this.state.downloadStats.remoteCandidateType:this.state.peerStats.remoteCandidateType;return this.formatProtocol(candidateType);}
get outboundConnectionTypeText(){const candidateType=this.rtc.state.connectionType===CONNECTION_TYPES.SERVER?this.state.uploadStats.localCandidateType:this.state.peerStats.localCandidateType;return this.formatProtocol(candidateType);}
get volume(){return this.store.settings.getVolume(this.props.rtcSession);}
formatProtocol(candidateType){if(!candidateType){return _t("no connection");}
return _t("%(candidateType)s (%(protocol)s)",{candidateType,protocol:PROTOCOLS_TEXT[candidateType],});}
async updateStats(){if(this.rtc.localSession?.eq(this.props.rtcSession)){if(this.rtc.sfuClient){const{uploadStats,downloadStats,...producerStats}=await this.rtc.sfuClient.getStats();if(!uploadStats||!downloadStats){return;}
const formattedUploadStats={};for(const value of uploadStats.values?.()||[]){switch(value.type){case"candidate-pair":if(value.state==="succeeded"&&value.localCandidateId){formattedUploadStats.localCandidateType=uploadStats.get(value.localCandidateId)?.candidateType||"";formattedUploadStats.availableOutgoingBitrate=value.availableOutgoingBitrate;}
break;case"transport":formattedUploadStats.dtlsState=value.dtlsState;formattedUploadStats.iceState=value.iceState;formattedUploadStats.packetsSent=value.packetsSent;break;}}
const formattedDownloadStats={};for(const value of downloadStats.values?.()||[]){switch(value.type){case"candidate-pair":if(value.state==="succeeded"&&value.localCandidateId){formattedDownloadStats.remoteCandidateType=downloadStats.get(value.remoteCandidateId)?.candidateType||"";}
break;case"transport":formattedDownloadStats.dtlsState=value.dtlsState;formattedDownloadStats.iceState=value.iceState;formattedDownloadStats.packetsReceived=value.packetsReceived;break;}}
const formattedProducerStats={};for(const[type,stat]of Object.entries(producerStats)){const currentTypeStats={};for(const value of stat.values()){switch(value.type){case"codec":currentTypeStats.codec=value.mimeType;currentTypeStats.clockRate=value.clockRate;break;}}
formattedProducerStats[type]=currentTypeStats;}
this.state.uploadStats=formattedUploadStats;this.state.downloadStats=formattedDownloadStats;this.state.producerStats=formattedProducerStats;}
return;}
this.state.peerStats=await this.rtc.p2pService.getFormattedStats(this.props.rtcSession.id);}
onChangeVolume(ev){const volume=Number(ev.target.value);this.rtc.setVolume(this.props.rtcSession,volume);}}
return __exports;});;

/* /mail/static/src/discuss/call/common/call_dropdown.js */
odoo.define('@mail/discuss/call/common/call_dropdown',['@odoo/owl','@web/core/navigation/navigation','@web/core/position/position_hook'],function(require){'use strict';let __exports={};const{Component,useRef,useState,useExternalListener,useSubEnv}=require("@odoo/owl");const{useNavigation}=require("@web/core/navigation/navigation");const{usePosition}=require("@web/core/position/position_hook");const CallDropdown=__exports.CallDropdown=class CallDropdown extends Component{static template="discuss.CallDropdown";static props={position:{type:String,optional:true},class:{type:String,optional:true},menuClass:{type:String,optional:true},slots:{optional:true},openByDefault:{type:Boolean,optional:true},state:{type:Object,optional:true},};static defaultProps={position:"bottom",class:"",menuClass:"",openByDefault:false,};setup(){super.setup();this.triggerRef=useRef("trigger");this.menuRef=useRef("menu");this.state=useState({isOpen:this.props.openByDefault});usePosition("menu",()=>this.triggerRef.el,{position:this.props.position,margin:4,flip:true,});useExternalListener(this.window,"click",this.onClickAway,{capture:true});useExternalListener(this.window,"keydown",this.onKeydown);useSubEnv({inCallDropdown:{close:()=>this.close()}});this.navigation=useNavigation(this.menuRef,{isNavigationAvailable:()=>this.state.isOpen,getItems:()=>{if(this.state.isOpen&&this.menuRef.el){return this.menuRef.el.querySelectorAll(":scope .o-navigable, :scope .o-dropdown");}
return[];},});}
get window(){return this.env.pipWindow||window;}
get isOpen(){return this.state.isOpen;}
toggle(){this.isOpen?this.close():this.open();}
open(){this.state.isOpen=true;}
close(){this.state.isOpen=false;}
handleClick(ev){ev.preventDefault();ev.stopPropagation();this.toggle();}
onClickAway(ev){if(!this.isOpen){return;}
const isOutsideClick=!this.triggerRef.el?.contains(ev.target)&&!this.menuRef.el?.contains(ev.target);if(isOutsideClick){this.close();}}
onClickMenu(ev){ev.stopPropagation();}
onKeydown(ev){if(ev.key==="Escape"&&this.isOpen){ev.preventDefault();this.close();}}}
return __exports;});;

/* /mail/static/src/discuss/call/common/call_infinite_mirroring_warning.js */
odoo.define('@mail/discuss/call/common/call_infinite_mirroring_warning',['@odoo/owl'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const CallInfiniteMirroringWarning=__exports.CallInfiniteMirroringWarning=class CallInfiniteMirroringWarning extends Component{static template="discuss.CallInfiniteMirroringWarning";static props={onClose:{type:Function},};}
return __exports;});;

/* /mail/static/src/discuss/call/common/call_invitation.js */
odoo.define('@mail/discuss/call/common/call_invitation',['@mail/core/common/action','@mail/core/common/action_list','@mail/discuss/call/common/call_actions','@mail/discuss/call/common/call_preview','@odoo/owl','@web/core/l10n/translation','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Action,ACTION_TAGS}=require("@mail/core/common/action");const{ActionList}=require("@mail/core/common/action_list");const{acceptWithCamera,CallAction,joinAction,rejectAction,}=require("@mail/discuss/call/common/call_actions");const{CallPreview}=require("@mail/discuss/call/common/call_preview");const{Component,useState,useSubEnv}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{useService}=require("@web/core/utils/hooks");const CallInvitation=__exports.CallInvitation=class CallInvitation extends Component{static props=["thread"];static template="discuss.CallInvitation";static components={ActionList,CallPreview};setup(){super.setup();this.rtc=useService("discuss.rtc");this.store=useService("mail.store");this.ui=useService("ui");this.state=useState({activateCamera:0,activateMicrophone:0,showCameraPreview:false,hasCamera:false,hasMicrophone:this.rtc.microphonePermission==="granted",});useSubEnv({inCallInvitation:true});}
joinCall(){this.props.thread.open({focus:true});this.rtc.toggleCall(this.props.thread,{audio:this.state.hasMicrophone,camera:this.state.hasCamera,});}
get acceptOrRejectActions(){const joinUpdated={...joinAction,btnClass:joinAction.btnClass+" o-me-0_5",onSelected:()=>this.joinCall(),};const acceptWithCameraUpdated={...acceptWithCamera,btnClass:acceptWithCamera.btnClass+" o-me-0_5",onSelected:()=>{this.state.hasCamera=true;this.joinCall();},condition:true,};return[new CallAction({id:"accept-with-camera",definition:acceptWithCameraUpdated,owner:this,store:this.store,thread:this.props.thread,}),new CallAction({id:"join",definition:joinUpdated,owner:this,store:this.store,thread:this.props.thread,}),new CallAction({id:"reject",definition:rejectAction,owner:this,store:this.store,thread:this.props.thread,}),];}
get otherActions(){return[new Action({id:"toggle-camera-preview",definition:{name:()=>this.state.showCameraPreview?_t("Hide camera preview"):_t("Show camera preview"),icon:()=>this.state.showCameraPreview?"fa fa-chevron-up":"fa fa-chevron-down",onSelected:()=>{this.state.showCameraPreview=!this.state.showCameraPreview;if(this.rtc.cameraPermission!=="denied"){this.state.activateCamera++;}
if(this.state.hasMicrophone){this.state.activateMicrophone++;}},tags:()=>[ACTION_TAGS.CALL_LAYOUT],},store:this.store,}),];}
get avatarTitle(){const channelName=this.props.thread.displayName;if(this.props.thread.channel_type==="chat"){return _t("View chat with %(channel_name)s",{channel_name:channelName});}
return _t("View the %(channel_name)s channel",{channel_name:channelName});}
get inviter(){return this.props.thread.self_member_id?.rtc_inviting_session_id?.channel_member_id;}
get incomingCallText(){if(this.props.thread.channel_type==="chat"||!this.inviter){return _t("Incoming call");}
return _t("Incoming call from %(inviter)s",{inviter:this.inviter.name});}
onCallSettingsChanged(settings){if(settings.microphone!==undefined){this.state.hasMicrophone=settings.microphone;}
if(settings.camera!==undefined){this.state.hasCamera=settings.camera;}}}
return __exports;});;

/* /mail/static/src/discuss/call/common/call_invitations.js */
odoo.define('@mail/discuss/call/common/call_invitations',['@mail/discuss/call/common/call_invitation','@mail/utils/common/misc','@odoo/owl','@web/core/registry','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{CallInvitation}=require("@mail/discuss/call/common/call_invitation");const{onChange}=require("@mail/utils/common/misc");const{Component}=require("@odoo/owl");const{registry}=require("@web/core/registry");const{useService}=require("@web/core/utils/hooks");const CallInvitations=__exports.CallInvitations=class CallInvitations extends Component{static props=[];static components={CallInvitation};static template="discuss.CallInvitations";setup(){super.setup();this.rtc=useService("discuss.rtc");this.store=useService("mail.store");}}
const callInvitationsService=__exports.callInvitationsService={dependencies:["discuss.rtc","mail.store","overlay"],start(env,services){const store=services["mail.store"];let removeOverlay;const onChangeRingingThreadsLength=()=>{if(store.ringingThreads.length>0){if(!removeOverlay){removeOverlay=services.overlay.add(CallInvitations,{});}}else{removeOverlay?.();removeOverlay=undefined;}};onChangeRingingThreadsLength();onChange(store.ringingThreads,"length",onChangeRingingThreadsLength);},};registry.category("services").add("discuss.call_invitations",callInvitationsService);return __exports;});;

/* /mail/static/src/discuss/call/common/call_menu.js */
odoo.define('@mail/discuss/call/common/call_menu',['@odoo/owl','@mail/core/common/action_list','@mail/discuss/call/common/call_actions','@web/core/dropdown/dropdown','@web/core/registry','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Component,useSubEnv}=require("@odoo/owl");const{ActionList}=require("@mail/core/common/action_list");const{useCallActions}=require("@mail/discuss/call/common/call_actions");const{Dropdown}=require("@web/core/dropdown/dropdown");const{registry}=require("@web/core/registry");const{useService}=require("@web/core/utils/hooks");const CallMenu=__exports.CallMenu=class CallMenu extends Component{static props=[];static template="discuss.CallMenu";static components={ActionList,Dropdown};setup(){super.setup();this.rtc=useService("discuss.rtc");this.callActions=useCallActions({thread:()=>this.rtc.channel});this.isEnterprise=odoo.info&&odoo.info.isEnterprise;useSubEnv({inCallMenu:true});}
get icon(){const res=this.rtc.callActions.find((action)=>action.id===this.rtc.lastSelfCallAction)?.icon;return(typeof res==="function"?res():res)??"fa fa-microphone";}}
registry.category("systray").add("discuss.CallMenu",{Component:CallMenu},{sequence:100});return __exports;});;

/* /mail/static/src/discuss/call/common/call_participant_card.js */
odoo.define('@mail/discuss/call/common/call_participant_card',['@mail/discuss/call/common/call_context_menu','@mail/discuss/call/common/call_participant_video','@mail/discuss/call/common/call_dropdown','@mail/discuss/call/common/rtc_service','@mail/utils/common/hooks','@web/core/utils/misc','@web/core/browser/browser','@web/core/browser/feature_detection','@odoo/owl','@web/core/utils/hooks','@web/core/network/rpc'],function(require){'use strict';let __exports={};const{CallContextMenu}=require("@mail/discuss/call/common/call_context_menu");const{CallParticipantVideo}=require("@mail/discuss/call/common/call_participant_video");const{CallDropdown}=require("@mail/discuss/call/common/call_dropdown");const{CONNECTION_TYPES}=require("@mail/discuss/call/common/rtc_service");const{useHover}=require("@mail/utils/common/hooks");const{isEventHandled}=require("@web/core/utils/misc");const{browser}=require("@web/core/browser/browser");const{isMobileOS}=require("@web/core/browser/feature_detection");const{Component,onMounted,onWillUnmount,useRef,useExternalListener}=require("@odoo/owl");const{useService}=require("@web/core/utils/hooks");const{rpc}=require("@web/core/network/rpc");const HIDDEN_CONNECTION_STATES=new Set(["connected","completed"]);const CallParticipantCard=__exports.CallParticipantCard=class CallParticipantCard extends Component{static props=["className","cardData","thread","minimized?","inset?","isSidebarItem?","compact?",];static components={CallParticipantVideo,CallContextMenu,CallDropdown};static template="discuss.CallParticipantCard";setup(){super.setup();this.contextMenuAnchorRef=useRef("contextMenuAnchor");this.root=useRef("root");this.rtc=useService("discuss.rtc");this.store=useService("mail.store");this.ui=useService("ui");this.rootHover=useHover("root");this.resumeStreamHover=useHover("resumeStream");this.isMobileOS=isMobileOS();this.dragPos=undefined;this.isDrag=false;this.parentBoundingRect=undefined;onMounted(()=>{if(!this.rtcSession){return;}
this.rtc.updateVideoDownload(this.rtcSession,{viewCountIncrement:1,});});onWillUnmount(()=>{if(!this.rtcSession){return;}
this.rtc.updateVideoDownload(this.rtcSession,{viewCountIncrement:-1,});});useExternalListener(browser,"fullscreenchange",this.onFullScreenChange);}
get isContextMenuAvailable(){return(this.isOfActiveCall&&(this.rtcSession.notEq(this.rtc.selfSession)||(this.env.debug&&this.rtc.state.connectionType===CONNECTION_TYPES.SERVER)));}
get isRemoteVideo(){if(!this.rtcSession){return false;}
return(this.rtc.isRemote&&(this.rtcSession.is_screen_sharing_on||this.rtcSession.is_camera_on));}
get isSmall(){return Boolean(this.props.isSidebarItem||this.ui.isSmall||this.props.minimized||this.props.inset);}
get window(){return this.env.pipWindow||window;}
get showLiveLabel(){if(this.props.isSidebarItem){return false;}
if(this.props.cardData.type==="screen"){if(this.props.inset){return true;}else{return(!this.rtcSession.eq(this.rtcSession.channel.activeRtcSession)&&!this.props.minimized);}}
return false;}
get showRemoteWarning(){return!this.props.minimized&&!this.props.inset&&this.isRemoteVideo;}
get rtcSession(){return this.props.cardData.session;}
get channelMember(){return this.rtcSession?this.rtcSession.channel_member_id:this.props.cardData.member;}
get isOfActiveCall(){return Boolean(this.rtcSession&&this.rtcSession.channel?.eq(this.rtc.channel));}
get showConnectionState(){if(!this.rtcSession||!this.rtc.isHost||!this.isOfActiveCall||HIDDEN_CONNECTION_STATES.has(this.rtcSession.connectionState)){return false;}
if(this.rtc.state.connectionType===CONNECTION_TYPES.SERVER){return this.rtcSession.eq(this.rtc?.selfSession);}else{return this.rtcSession.notEq(this.rtc?.selfSession);}}
get showServerState(){return false;}
get name(){return this.channelMember?.name;}
get hasMediaError(){return(this.isOfActiveCall&&Boolean(this.rtcSession?.videoError||this.rtcSession?.audioError));}
get hasVideo(){return Boolean(this.props.cardData.videoStream);}
get isTalking(){return Boolean(this.rtcSession&&this.rtcSession.isActuallyTalking&&!this.rtc.selfSession?.is_deaf);}
get hasRaisingHand(){const screenStream=this.rtcSession.videoStreams.get("screen");return Boolean(this.rtcSession.raisingHand&&(!screenStream||screenStream!==this.props.cardData.videoStream));}
get isActiveRtcSession(){return this.rtcSession&&this.rtcSession.eq(this.rtcSession.channel?.activeRtcSession);}
async onClick(ev){if(isEventHandled(ev,"CallParticipantCard.clickVolumeAnchor")){return;}
if(this.isDrag){this.isDrag=false;return;}
if(this.rtcSession){const channel=this.rtcSession.channel;this.rtcSession.mainVideoStreamType=this.props.cardData.type;if(this.rtcSession.eq(channel.activeRtcSession)&&!this.props.inset){channel.activeRtcSession=undefined;this.rtcSession.mainVideoStreamType=undefined;}else{const activeRtcSession=channel.activeRtcSession;const currentMainVideoType=this.rtcSession.mainVideoStreamType;channel.activeRtcSession=this.rtcSession;if(this.props.inset&&activeRtcSession){this.props.inset(activeRtcSession,currentMainVideoType);}}
return;}
await rpc("/mail/rtc/channel/cancel_call_invitation",{channel_id:this.props.thread.id,member_ids:[this.channelMember.id],});}
async onClickReplay(){this.env.bus.trigger("RTC-SERVICE:PLAY_MEDIA");}
onMouseDown(){if(!this.props.inset){return;}
const onMousemove=(ev)=>this.drag(ev);const onMouseup=()=>{const insetEl=this.root.el;const bottomOffset=this.env.inChatWindow?this.window.innerHeight*0.05:0;if(parseInt(insetEl.style.left)<insetEl.parentNode.offsetWidth/2){insetEl.style.left="1vh";insetEl.style.right="";}else{insetEl.style.left="";insetEl.style.right="1vh";}
if(parseInt(insetEl.style.top)<(insetEl.parentNode.offsetHeight-bottomOffset)/2){insetEl.style.top="1vh";insetEl.style.bottom="";}else{insetEl.style.bottom=this.env.inChatWindow?"5vh":"1vh";insetEl.style.top="unset";}
this.dragPos=undefined;this.parentBoundingRect=undefined;document.removeEventListener("mouseup",onMouseup);document.removeEventListener("mousemove",onMousemove);};document.addEventListener("mouseup",onMouseup);document.addEventListener("mousemove",onMousemove);}
onTouchMove(ev){if(!this.props.inset){return;}
this.drag(ev);}
drag(ev){this.isDrag=true;const insetEl=this.root.el;const parent=insetEl.parentNode;const boundingRect=this.parentBoundingRect||(this.parentBoundingRect=parent.getBoundingClientRect());const bottomOffset=this.env.inChatWindow?this.window.innerHeight*0.05:0;const clientX=Math.max((ev.clientX??ev.touches[0].clientX)-boundingRect.left,0);const clientY=Math.max((ev.clientY??ev.touches[0].clientY)-boundingRect.top,0);if(!this.dragPos){this.dragPos={posX:clientX,posY:clientY};}
const dX=this.dragPos.posX-clientX;const dY=this.dragPos.posY-clientY;const widthOffset=parent.offsetWidth-insetEl.clientWidth;const heightOffset=parent.offsetHeight-insetEl.clientHeight-bottomOffset;this.dragPos.posX=Math.min(clientX,widthOffset);this.dragPos.posY=Math.min(clientY,heightOffset);insetEl.style.left=Math.min(Math.max(insetEl.offsetLeft-dX,0),widthOffset)+"px";insetEl.style.top=Math.min(Math.max(insetEl.offsetTop-dY,0),heightOffset)+"px";}
onFullScreenChange(){this.root.el.style="left:''; top:''";}}
return __exports;});;

/* /mail/static/src/discuss/call/common/call_participant_video.js */
odoo.define('@mail/discuss/call/common/call_participant_video',['@odoo/owl','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Component,onMounted,onPatched,status,useExternalListener,useRef}=require("@odoo/owl");const{useService}=require("@web/core/utils/hooks");const CallParticipantVideo=__exports.CallParticipantVideo=class CallParticipantVideo extends Component{static props=["session","type","inset?"];static template="discuss.CallParticipantVideo";setup(){super.setup();this.rtc=useService("discuss.rtc");this.store=useService("mail.store");this.root=useRef("root");onMounted(()=>this._update());onPatched(()=>this._update());useExternalListener(this.env.bus,"RTC-SERVICE:PLAY_MEDIA",async()=>{await this.play();});}
_update(){if(!this.root.el){return;}
if(!this.props.session||!this.props.session.getStream(this.props.type)){this.root.el.srcObject=undefined;}else{this.root.el.srcObject=this.props.session.getStream(this.props.type);}
this.root.el.load();}
async play(){try{await this.root.el?.play?.();this.props.session.videoError=undefined;}catch(error){if(status(this)==="destroyed"){return;}
this.props.session.videoError=error.name;}}
async onVideoLoadedMetaData(){await this.play();}}
return __exports;});;

/* /mail/static/src/discuss/call/common/call_permission_dialog.js */
odoo.define('@mail/discuss/call/common/call_permission_dialog',['@odoo/owl','@web/core/dialog/dialog','@web/core/l10n/translation','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const{Dialog}=require("@web/core/dialog/dialog");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{useService}=require("@web/core/utils/hooks");const CallPermissionDialog=__exports.CallPermissionDialog=class CallPermissionDialog extends Component{static components={Dialog};static props={close:Function,media:{type:String,validate:(s)=>["camera","microphone"].includes(s),},useMicrophone:Function,useCamera:Function,};static template="discuss.CallPermissionDialog";setup(){this.rtc=useService("discuss.rtc");}
async onClickUseMicrophone(){if(await this.rtc.askForBrowserPermission({audio:true})){await this.props.useMicrophone();}
this.props.close();}
async onClickUseCamera(){if(await this.rtc.askForBrowserPermission({video:true})){await this.props.useCamera();}
this.props.close();}
async onClickUseMicAndCamera(){if(await this.rtc.askForBrowserPermission({audio:true,video:true})){await Promise.all([this.props.useMicrophone(),this.props.useCamera()]);}
this.props.close();}
get primaryActionText(){return this.props.media==="camera"?_t("Use Camera"):_t("Use Microphone");}
get permissionPrompt(){if(this.props.media==="microphone"){return _t("Do you want people to hear you in the meeting?");}
return _t("Do you want people to see you in the meeting?");}
get permissionNote(){return _t("You can still turn off your %s anytime.",this.props.media);}}
return __exports;});;

/* /mail/static/src/discuss/call/common/call_preview.js */
odoo.define('@mail/discuss/call/common/call_preview',['@mail/core/common/action','@mail/core/common/action_list','@mail/discuss/call/common/call_actions','@mail/discuss/call/common/call_permission_dialog','@mail/utils/common/misc','@odoo/owl','@web/core/l10n/translation','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Action,ACTION_TAGS}=require("@mail/core/common/action");const{ActionList}=require("@mail/core/common/action_list");const{cameraOnAction,muteAction,quickActionSettings,quickVideoSettings,}=require("@mail/discuss/call/common/call_actions");const{CallPermissionDialog}=require("@mail/discuss/call/common/call_permission_dialog");const{closeStream,onChange}=require("@mail/utils/common/misc");const{Component,onWillDestroy,status,useEffect,useRef,useState}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{useService}=require("@web/core/utils/hooks");const CallPreview=__exports.CallPreview=class CallPreview extends Component{static template="mail.CallPreview";static props=["activateCamera?","activateMicrophone?","onSettingsChanged?"];static components={ActionList};setup(){this.dialog=useService("dialog");this.notification=useService("notification");this.rtc=useService("discuss.rtc");this.store=useService("mail.store");this.state=useState({audioStream:null,blurManager:null,videoStream:null});this.audioRef=useRef("audio");this.videoRef=useRef("video");useEffect((videoEl,audioEl,audioStream,videoStream,blurStream)=>{if(audioEl&&!audioEl.srcObject&&audioStream){audioEl.srcObject=audioStream;}
if(videoEl&&!videoEl.srcObject&&videoStream){videoEl.srcObject=blurStream??videoStream;}},()=>[this.videoRef.el,this.audioRef.el,this.state.audioStream,this.state.videoStream,this.state.blurManager?.stream,]);if(this.hasRtcSupport){onChange(this.rtc,"microphonePermission",()=>{if(this.rtc.microphonePermission!=="granted"){this.disableMicrophone();}});onChange(this.rtc,"cameraPermission",()=>{if(this.rtc.cameraPermission!=="granted"){this.disableCamera();}});onChange(this.store.settings,"audioInputDeviceId",()=>{if(this.state.audioStream){closeStream(this.state.audioStream);this.enableMicrophone();}});onChange(this.store.settings,"cameraInputDeviceId",()=>{if(this.state.videoStream){closeStream(this.state.videoStream);this.enableCamera();}});onChange(this.store.settings,"audioOutputDeviceId",(deviceId)=>{this.audioRef.el?.setSinkId?.(deviceId).catch(()=>{});});onChange(this.store.settings,"useBlur",()=>{if(this.store.settings.useBlur){this.enableBlur();}else{this.disableBlur();}});onChange(this.store.settings,["edgeBlurAmount","backgroundBlurAmount"],()=>{if(this.state.blurManager){this.state.blurManager.edgeBlur=this.store.settings.edgeBlurAmount;this.state.blurManager.backgroundBlur=this.store.settings.backgroundBlurAmount;}});onWillDestroy(()=>{closeStream(this.state.audioStream);closeStream(this.state.videoStream);});useEffect((activateCamera)=>{if(activateCamera>0&&!this.state.videoStream){this.enableCamera();}},()=>[this.props.activateCamera]);useEffect((activateMicrophone)=>{if(activateMicrophone>0&&!this.state.audioStream){this.enableMicrophone();}},()=>[this.props.activateMicrophone]);}}
get hasRtcSupport(){return Boolean(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&window.MediaStream);}
get actions(){const cameraOnActionUpdated={...cameraOnAction,name:()=>(this.state.videoStream?_t("Stop camera"):_t("Turn camera on")),isActive:()=>this.state.videoStream,onSelected:()=>this.toggleCamera(),tags:(...args)=>{const tags=cameraOnAction.tags?.(...args)??[];if(!args[0].action.isActive){tags.push(ACTION_TAGS.DANGER);}
return tags;},};const muteActionUpdated={...muteAction,isActive:()=>!this.state.audioStream,name:({action})=>(action.isActive?_t("Unmute"):_t("Mute")),onSelected:()=>this.toggleMic(),};return[[new Action({id:"toggle-microphone",owner:this,definition:muteActionUpdated,store:this.store,}),new Action({id:"audio-settings",owner:this,definition:quickActionSettings,store:this.store,}),],[new Action({id:"toggle-camera",owner:this,definition:cameraOnActionUpdated,store:this.store,}),new Action({id:"video-settings",owner:this,definition:quickVideoSettings,store:this.store,}),],];}
async enableMicrophone(){if(this.rtc.microphonePermission!=="granted"&&!(await this.rtc.askForBrowserPermission({audio:true}))){return;}
this.state.audioStream=await navigator.mediaDevices.getUserMedia({audio:this.store.settings.audioConstraints,});if(status(this)==="destroyed"){closeStream(this.state.audioStream);return;}
if(this.audioRef.el){this.audioRef.el.srcObject=this.state.audioStream;}
this.props.onSettingsChanged?.({microphone:true});}
disableMicrophone(){closeStream(this.state.audioStream);this.state.audioStream=null;if(this.audioRef.el){this.audioRef.el.srcObject=null;}
this.props.onSettingsChanged?.({microphone:false});}
async toggleMic(){if(this.state.audioStream){this.disableMicrophone();return;}
if(this.rtc.microphonePermission==="prompt"){this.dialog.add(CallPermissionDialog,{media:"microphone",useMicrophone:()=>this.enableMicrophone(),useCamera:()=>this.enableCamera(),});return;}
await this.enableMicrophone();}
async enableCamera(){if(this.rtc.cameraPermission!=="granted"&&!(await this.rtc.askForBrowserPermission({video:true}))){return;}
this.state.videoStream=await navigator.mediaDevices.getUserMedia({video:this.store.settings.cameraConstraints,});if(!this.videoRef.el){return;}
if(status(this)==="destroyed"){closeStream(this.state.videoStream);return;}
if(this.videoRef.el){this.videoRef.el.srcObject=this.state.videoStream;}
this.props.onSettingsChanged?.({camera:true});if(this.store.settings.useBlur){await this.enableBlur();}}
disableCamera(){closeStream(this.state.videoStream);this.state.videoStream=null;this.state.blurManager?.close();this.state.blurManager=undefined;if(this.videoRef.el){this.videoRef.el.srcObject=null;}
this.props.onSettingsChanged?.({camera:false});}
async toggleCamera(){if(this.state.videoStream){this.disableCamera();return;}
if(this.rtc.cameraPermission==="prompt"){this.dialog.add(CallPermissionDialog,{media:"camera",useMicrophone:()=>this.enableMicrophone(),useCamera:()=>this.enableCamera(),});return;}
await this.enableCamera();}
async enableBlur(){this.store.settings.useBlur=true;if(!this.videoRef.el){return;}
try{this.state.blurManager=await this.rtc.applyBlurEffect(this.state.videoStream);this.videoRef.el.srcObject=await this.state.blurManager.stream;}catch(_e){this.notification.add(_e.message,{type:"warning"});this.disableBlur();}}
disableBlur(){this.store.settings.useBlur=false;if(this.videoRef.el){this.videoRef.el.srcObject=this.state.videoStream;}
this.state.blurManager?.close();this.state.blurManager=undefined;}
toggleBlur(){if(this.state.blurManager){this.disableBlur();return;}
this.enableBlur();}}
return __exports;});;

/* /mail/static/src/discuss/call/common/call_settings.js */
odoo.define('@mail/discuss/call/common/call_settings',['@odoo/owl','@web/core/l10n/translation','@web/core/browser/browser','@web/core/utils/timing','@web/core/browser/feature_detection','@web/core/utils/hooks','@mail/utils/common/hooks','@mail/discuss/core/common/action_panel','@mail/discuss/call/common/device_select','@web/core/dialog/dialog'],function(require){'use strict';let __exports={};const{Component,onWillStart,useExternalListener,useState,xml}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{browser}=require("@web/core/browser/browser");const{debounce}=require("@web/core/utils/timing");const{isMobileOS}=require("@web/core/browser/feature_detection");const{useService}=require("@web/core/utils/hooks");const{useMicrophoneVolume}=require("@mail/utils/common/hooks");const{ActionPanel}=require("@mail/discuss/core/common/action_panel");const{DeviceSelect}=require("@mail/discuss/call/common/device_select");const{Dialog}=require("@web/core/dialog/dialog");const CallSettings=__exports.CallSettings=class CallSettings extends Component{static template="discuss.CallSettings";static props=["withActionPanel?","*"];static defaultProps={withActionPanel:true,};static components={ActionPanel,DeviceSelect};setup(){super.setup();this.notification=useService("notification");this.store=useService("mail.store");this.rtc=useService("discuss.rtc");this.microphoneVolume=useMicrophoneVolume();this.state=useState({userDevices:[],});this.pttExtService=useService("discuss.ptt_extension");this.saveBackgroundBlurAmount=debounce(()=>{browser.localStorage.setItem("mail_user_setting_background_blur_amount",this.store.settings.backgroundBlurAmount.toString());},2000);this.saveEdgeBlurAmount=debounce(()=>{browser.localStorage.setItem("mail_user_setting_edge_blur_amount",this.store.settings.edgeBlurAmount.toString());},2000);useExternalListener(browser,"keydown",this._onKeyDown,{capture:true});useExternalListener(browser,"keyup",this._onKeyUp,{capture:true});onWillStart(async()=>{if(!browser.navigator.mediaDevices){this.notification.add(_t("Media devices unobtainable. SSL might not be set up properly."),{type:"warning"});console.warn("Media devices unobtainable. SSL might not be set up properly.");return;}
this.state.userDevices=await browser.navigator.mediaDevices.enumerateDevices();});}
get stopText(){return _t("Stop");}
get testText(){return _t("Test");}
get pushToTalkKeyText(){const{shiftKey,ctrlKey,altKey,key}=this.store.settings.pushToTalkKeyFormat();const f=(k,name)=>(k?name:"");const keys=[f(ctrlKey,"Ctrl"),f(altKey,"Alt"),f(shiftKey,"Shift"),key].filter(Boolean);return keys.join(" + ");}
get isMobileOS(){return isMobileOS();}
_onKeyDown(ev){if(!this.store.settings.isRegisteringKey){return;}
ev.stopPropagation();ev.preventDefault();this.store.settings.setPushToTalkKey(ev);}
_onKeyUp(ev){if(!this.store.settings.isRegisteringKey){return;}
ev.stopPropagation();ev.preventDefault();this.store.settings.isRegisteringKey=false;}
onChangeLogRtc(ev){this.store.settings.logRtc=ev.target.checked;}
onChangeSelectAudioInput(ev){this.store.settings.setAudioInputDevice(ev.target.value);}
onClickDownloadLogs(){this.rtc.dumpLogs({download:true});}
onClickRegisterKeyButton(){this.store.settings.isRegisteringKey=!this.store.settings.isRegisteringKey;}
onChangeDelay(ev){this.store.settings.setDelayValue(ev.target.value);}
onChangeBlur(ev){this.store.settings.useBlur=ev.target.checked;}
onChangeShowOnlyVideo(ev){const showOnlyVideo=ev.target.checked;this.store.settings.showOnlyVideo=showOnlyVideo;browser.localStorage.setItem("mail_user_setting_show_only_video",this.store.settings.showOnlyVideo);const activeRtcSessions=this.store.allActiveRtcSessions;if(showOnlyVideo&&activeRtcSessions){activeRtcSessions.filter((rtcSession)=>!rtcSession.videoStream).forEach((rtcSession)=>{rtcSession.channel.activeRtcSession=undefined;});}}
onChangeBackgroundBlurAmount(ev){this.store.settings.backgroundBlurAmount=Number(ev.target.value);this.saveBackgroundBlurAmount();}
onChangeEdgeBlurAmount(ev){this.store.settings.edgeBlurAmount=Number(ev.target.value);this.saveEdgeBlurAmount();}}
const CallSettingsDialog=__exports.CallSettingsDialog=class CallSettingsDialog extends Component{static template=xml`
        <Dialog size="medium" footer="false" title.translate="Voice &amp; Video Settings">
            <CallSettings withActionPanel="false"/>
        </Dialog>
    `;static props=["*"];static components={CallSettings,Dialog};}
return __exports;});;

/* /mail/static/src/discuss/call/common/channel_member_patch.js */
odoo.define('@mail/discuss/call/common/channel_member_patch',['@mail/discuss/core/common/channel_member_model','@mail/core/common/record','@web/core/browser/browser','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{ChannelMember}=require("@mail/discuss/core/common/channel_member_model");const{fields}=require("@mail/core/common/record");const{browser}=require("@web/core/browser/browser");const{patch}=require("@web/core/utils/patch");ChannelMember.CANCEL_CALL_INVITE_DELAY=30000;const ChannelMemberPatch={setup(){super.setup(...arguments);this.rtc_inviting_session_id=fields.One("discuss.channel.rtc.session",{onAdd(r){if(!this.channel_id){return;}
this.channel_id.rtc_session_ids.add(r);this.store.ringingThreads.add(this.channel_id);this.channel_id.cancelRtcInvitationTimeout=browser.setTimeout(()=>{this.store.env.services["discuss.rtc"].leaveCall(this.channel_id);},ChannelMember.CANCEL_CALL_INVITE_DELAY);},onDelete(){if(!this.channel_id){return;}
browser.clearTimeout(this.channel_id.cancelRtcInvitationTimeout);this.store.ringingThreads.delete(this.channel_id);},});this.rtcSession=fields.One("discuss.channel.rtc.session");},};patch(ChannelMember.prototype,ChannelMemberPatch);return __exports;});;

/* /mail/static/src/discuss/call/common/chat_window_patch.js */
odoo.define('@mail/discuss/call/common/chat_window_patch',['@mail/core/common/chat_window','@mail/discuss/call/common/call','@mail/discuss/call/common/pip_banner','@web/core/utils/hooks','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{ChatWindow}=require("@mail/core/common/chat_window");const{Call}=require("@mail/discuss/call/common/call");const{PipBanner}=require("@mail/discuss/call/common/pip_banner");const{useService}=require("@web/core/utils/hooks");const{patch}=require("@web/core/utils/patch");Object.assign(ChatWindow.components,{Call,PipBanner});patch(ChatWindow.prototype,{setup(){super.setup(...arguments);this.rtc=useService("discuss.rtc");},});return __exports;});;

/* /mail/static/src/discuss/call/common/device_select.js */
odoo.define('@mail/discuss/call/common/device_select',['@odoo/owl','@web/core/browser/browser','@web/core/l10n/translation','@web/core/utils/hooks','@web/core/browser/feature_detection'],function(require){'use strict';let __exports={};const{Component,onWillDestroy,onWillStart,useState}=require("@odoo/owl");const{browser}=require("@web/core/browser/browser");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{useService}=require("@web/core/utils/hooks");const{isBrowserChrome}=require("@web/core/browser/feature_detection");const deviceKind=new Set(["audioinput","videoinput","audiooutput"]);const DeviceSelect=__exports.DeviceSelect=class DeviceSelect extends Component{static props={kind:{type:String,validate:(string)=>deviceKind.has(string),},};static template="discuss.CallDeviceSelect";setup(){super.setup();this.store=useService("mail.store");this.notification=useService("notification");this.state=useState({userDevices:[],});this.abortController=new AbortController();this.isBrowserChrome=isBrowserChrome();onWillStart(async()=>{if(!browser.navigator.mediaDevices){this.notification.add(_t("Media devices unobtainable. SSL might not be set up properly."),{type:"warning"});console.warn("Media devices unobtainable. SSL might not be set up properly.");return;}
await this.updateDevicesList();this.setupEventListeners();});onWillDestroy(()=>{this.abortController.abort();});}
async updateDevicesList(){this.state.userDevices=await browser.navigator.mediaDevices.enumerateDevices();}
async setupEventListeners(){const boundHandler=this.updateDevicesList.bind(this);const signal=this.abortController.signal;browser.navigator.mediaDevices.addEventListener("devicechange",boundHandler,{signal});if(this.props.kind=="videoinput"){const cameraPermission=await browser.navigator.permissions.query({name:"camera"});cameraPermission.addEventListener("change",boundHandler,{signal});}else{const microphonePermission=await browser.navigator.permissions.query({name:"microphone",});microphonePermission.addEventListener("change",boundHandler,{signal});}}
async showPermissionDialog(kind){if(kind==="videoinput"){if(this.store.rtc.cameraPermission==="denied"){this.store.rtc.showMediaUnavailableWarning({camera:true});}else{this.store.rtc.showMediaPermissionDialog("camera");return;}}else{if(this.store.rtc.microphonePermission==="denied"){this.store.rtc.showMediaUnavailableWarning({microphone:true});}else{this.store.rtc.showMediaPermissionDialog("microphone");return;}}}
isSelected(id){switch(this.props.kind){case"audioinput":return this.store.settings.audioInputDeviceId===id;case"videoinput":return this.store.settings.cameraInputDeviceId===id;case"audiooutput":return this.store.settings.audioOutputDeviceId===id;}}
onChangeSelectAudioInput(ev){switch(this.props.kind){case"audioinput":this.store.settings.setAudioInputDevice(ev.target.value);return;case"videoinput":this.store.settings.setCameraInputDevice(ev.target.value);return;case"audiooutput":this.store.settings.setAudioOutputDevice(ev.target.value);return;}}
isPermissionGranted(kind){if(kind==="videoinput"){return this.store.rtc.cameraPermission==="granted";}
return this.store.rtc.microphonePermission==="granted";}}
return __exports;});;

/* /mail/static/src/discuss/call/common/discuss_call_settings_client_action.js */
odoo.define('@mail/discuss/call/common/discuss_call_settings_client_action',['@odoo/owl','@web/core/registry','@mail/discuss/call/common/call_settings'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const{registry}=require("@web/core/registry");const{CallSettings}=require("@mail/discuss/call/common/call_settings");const DiscussCallSettingsClientAction=__exports.DiscussCallSettingsClientAction=class DiscussCallSettingsClientAction extends Component{static components={CallSettings};static props=["*"];static template="mail.DiscussCallSettingsClientAction";}
registry.category("actions").add("mail.discuss_call_settings_action",DiscussCallSettingsClientAction);return __exports;});;

/* /mail/static/src/discuss/call/common/discuss_p2p_service.js */
odoo.define('@mail/discuss/call/common/discuss_p2p_service',['@web/core/registry','@mail/discuss/call/common/peer_to_peer'],function(require){'use strict';let __exports={};const{registry}=require("@web/core/registry");const{PeerToPeer}=require("@mail/discuss/call/common/peer_to_peer");const discussP2P=__exports.discussP2P={dependencies:["bus_service"],start(env,services){const p2p=new PeerToPeer({logLevel:env.debug?"info":undefined,notificationRoute:"/mail/rtc/session/notify_call_members",});services["bus_service"].subscribe("discuss.channel.rtc.session/peer_notification",({sender,notifications})=>{for(const content of notifications){p2p.handleNotification(sender,content);}});return p2p;},};registry.category("services").add("discuss.p2p",discussP2P);return __exports;});;

/* /mail/static/src/discuss/call/common/mail_guest_model_patch.js */
odoo.define('@mail/discuss/call/common/mail_guest_model_patch',['@mail/core/common/mail_guest_model','@mail/model/misc','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{MailGuest}=require("@mail/core/common/mail_guest_model");const{fields}=require("@mail/model/misc");const{patch}=require("@web/core/utils/patch");patch(MailGuest.prototype,{setup(){super.setup(...arguments);this.currentRtcSession=fields.One("discuss.channel.rtc.session",{inverse:"guest_id"});},});return __exports;});;

/* /mail/static/src/discuss/call/common/meeting.js */
odoo.define('@mail/discuss/call/common/meeting',['@mail/core/common/composer','@mail/core/common/thread','@mail/discuss/call/common/call','@mail/discuss/call/common/call_action_list','@mail/discuss/core/common/channel_invitation','@mail/utils/common/hooks','@odoo/owl','@web/core/dropdown/dropdown','@web/core/utils/hooks','@mail/discuss/call/common/meeting_side_actions','@mail/core/common/thread_actions','@mail/core/common/message_search_hook'],function(require){'use strict';let __exports={};const{Composer}=require("@mail/core/common/composer");const{Thread}=require("@mail/core/common/thread");const{Call}=require("@mail/discuss/call/common/call");const{CallActionList}=require("@mail/discuss/call/common/call_action_list");const{ChannelInvitation}=require("@mail/discuss/core/common/channel_invitation");const{inDiscussCallViewProps,useInDiscussCallView,useMessageScrolling,}=require("@mail/utils/common/hooks");const{Component,onMounted,onWillUnmount,useChildSubEnv,useSubEnv}=require("@odoo/owl");const{Dropdown}=require("@web/core/dropdown/dropdown");const{useService}=require("@web/core/utils/hooks");const{MeetingSideActions}=require("@mail/discuss/call/common/meeting_side_actions");const{useThreadActions}=require("@mail/core/common/thread_actions");const{useMessageSearch}=require("@mail/core/common/message_search_hook");const Meeting=__exports.Meeting=class Meeting extends Component{static template="mail.Meeting";static props=["autoOpenAction?",...inDiscussCallViewProps];static components={Call,CallActionList,ChannelInvitation,Composer,Dropdown,MeetingSideActions,Thread,};setup(){this.store=useService("mail.store");this.ui=useService("ui");this.rtc=useService("discuss.rtc");onMounted(()=>{if(this.props.autoOpenAction){this.threadActions.actions.find((a)=>a.id===this.props.autoOpenAction)?.onSelected();}});useInDiscussCallView();useSubEnv({inMeetingView:{openChat:()=>this.threadActions.actions.find((action)=>action.id==="meeting-chat")?.open(),},});this.threadActions=useThreadActions({thread:()=>this.thread});this.messageHighlight=useMessageScrolling();this.messageSearch=useMessageSearch(this.thread);useChildSubEnv({closeActionPanel:()=>this.threadActions.activeAction?.close(),messageHighlight:this.messageHighlight,messageSearch:this.messageSearch,});onMounted(()=>(this.store.meetingViewOpened=true));onWillUnmount(()=>(this.store.meetingViewOpened=false));}
get thread(){return this.store.rtc.channel;}}
return __exports;});;

/* /mail/static/src/discuss/call/common/meeting_chat.js */
odoo.define('@mail/discuss/call/common/meeting_chat',['@mail/core/common/composer','@mail/core/common/thread','@mail/discuss/core/common/action_panel','@mail/discuss/typing/common/typing','@odoo/owl','@web/core/browser/feature_detection','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Composer}=require("@mail/core/common/composer");const{Thread}=require("@mail/core/common/thread");const{ActionPanel}=require("@mail/discuss/core/common/action_panel");const{Typing}=require("@mail/discuss/typing/common/typing");const{Component,useState,useSubEnv}=require("@odoo/owl");const{isMobileOS}=require("@web/core/browser/feature_detection");const{useChildRef,useService}=require("@web/core/utils/hooks");const MeetingChat=__exports.MeetingChat=class MeetingChat extends Component{static template="mail.MeetingChat";static components={ActionPanel,Composer,Thread,Typing,};static props=["thread?"];setup(){this.store=useService("mail.store");this.ui=useService("ui");this.rtc=useService("discuss.rtc");this.state=useState({jumpPresent:0});this.panelContentRef=useChildRef();this.isMobileOS=isMobileOS();useSubEnv({inMeetingChat:true});}
get thread(){return this.store.rtc.channel;}}
return __exports;});;

/* /mail/static/src/discuss/call/common/meeting_side_actions.js */
odoo.define('@mail/discuss/call/common/meeting_side_actions',['@mail/core/common/action_list','@odoo/owl','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{ActionList}=require("@mail/core/common/action_list");const{Component,useSubEnv}=require("@odoo/owl");const{useService}=require("@web/core/utils/hooks");const MeetingSideActions=__exports.MeetingSideActions=class MeetingSideActions extends Component{static template="mail.MeetingSideActions";static props=["threadActions"];static components={ActionList};setup(){this.store=useService("mail.store");useSubEnv({inMeetingSideActions:true});}
computeActions(){const quickThreadActionIds=["invite-people","meeting-chat"];const threadActions=this.props.threadActions;const{quick,other,group}=threadActions.partition;const partitionedActions={quick:quick.filter((action)=>!quickThreadActionIds.includes(action.id)),other:other.filter((action)=>!quickThreadActionIds.includes(action.id)),group:group.map((group)=>group.filter((action)=>!quickThreadActionIds.includes(action.id))).filter((g)=>g.length>0),};const actions=threadActions.actions.filter((action)=>quickThreadActionIds.includes(action.id));actions.push(threadActions.more({actions:[partitionedActions.quick,partitionedActions.other,...partitionedActions.group,],}));this.actions=actions;}}
return __exports;});;

/* /mail/static/src/discuss/call/common/peer_to_peer.js */
odoo.define('@mail/discuss/call/common/peer_to_peer',['@web/core/network/rpc','@web/core/utils/concurrency','@web/core/browser/browser'],function(require){'use strict';let __exports={};const{rpc}=require("@web/core/network/rpc");const{Deferred}=require("@web/core/utils/concurrency");const{browser}=require("@web/core/browser/browser");const STREAM_TYPE=__exports.STREAM_TYPE=Object.freeze({AUDIO:"audio",CAMERA:"camera",SCREEN:"screen",});const UPDATE_EVENT=__exports.UPDATE_EVENT=Object.freeze({BROADCAST:"broadcast",CONNECTION_CHANGE:"connection_change",DISCONNECT:"disconnect",INFO_CHANGE:"info_change",RECOVERY:"recovery",TRACK:"track",});const LOG_LEVEL=Object.freeze({NONE:"none",DEBUG:"debug",INFO:"info",WARN:"warn",ERROR:"error",});const INTERNAL_EVENT=Object.freeze({ANSWER:"answer",BROADCAST:"broadcast",DISCONNECT:"disconnect",ICE_CANDIDATE:"ice-candidate",INFO:"info",OFFER:"offer",TRACK_CHANGE:"trackChange",});const ORDERED_TRANSCEIVER_TYPES=[STREAM_TYPE.AUDIO,STREAM_TYPE.CAMERA,STREAM_TYPE.SCREEN];const DEFAULT_BUS_BATCH_DELAY=100;const INITIAL_RECONNECT_DELAY=2_000+Math.random()*1_000;const MAXIMUM_RECONNECT_DELAY=25_000+Math.random()*5_000;const INVALID_ICE_CONNECTION_STATES=new Set(["disconnected","failed","closed"]);const IS_CLIENT_RTC_COMPATIBLE=Boolean(window.RTCPeerConnection&&window.MediaStream);const DEFAULT_ICE_SERVERS=[{urls:["stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302"]},];const DEFAULT_NOTIFICATION_ROUTE="/mail/rtc/session/notify_call_members";const Peer=__exports.Peer=class Peer{id;connection;connectRetryDelay=INITIAL_RECONNECT_DELAY;sequence=0;dataChannel;hasPriority=false;isBuildingOffer=false;isBuildingAnswer=false;medias=Object.seal({[STREAM_TYPE.AUDIO]:{track:null,active:false,accepted:true,},[STREAM_TYPE.SCREEN]:{track:null,active:false,accepted:true,},[STREAM_TYPE.CAMERA]:{track:null,active:false,accepted:true,},});constructor(id,{connection,dataChannel,hasPriority=false,connectRetryDelay=INITIAL_RECONNECT_DELAY,sequence=0,}){this.id=id;this.connection=connection;this.dataChannel=dataChannel;this.hasPriority=hasPriority;this.connectRetryDelay=connectRetryDelay;this.sequence=sequence;this.ready=new Deferred();}
disconnect(){if(this.connection){const RTCRtpSenders=this.connection.getSenders();for(const sender of RTCRtpSenders){try{this.connection.removeTrack(sender);}catch{}}
for(const transceiver of this.connection.getTransceivers()){try{transceiver.stop();}catch{}}}
this.ready.resolve?.();this.connection?.close();this.connection=undefined;this.dataChannel?.close();this.dataChannel=undefined;for(const media of Object.values(this.medias)){media.track?.stop();}}
getRecommendedTransceiverDirection(streamType,canUpload=false){if(this.medias[streamType].accepted){return canUpload?"sendrecv":"recvonly";}else{return canUpload?"sendonly":"inactive";}}
getTransceiver(streamType){if(!this.connection){return;}
const transceivers=this.connection.getTransceivers();return transceivers[ORDERED_TRANSCEIVER_TYPES.indexOf(streamType)];}
getTransceiverStreamType(transceiver){const transceivers=this.connection.getTransceivers();return ORDERED_TRANSCEIVER_TYPES[transceivers.indexOf(transceiver)];}}
const PeerToPeer=__exports.PeerToPeer=class PeerToPeer extends EventTarget{selfId;channelId;peers=new Map();acceptOffer=async(id,sequence)=>true;_batchDelay=DEFAULT_BUS_BATCH_DELAY;_localInfo=Object.seal({isSelfMuted:false,isRaisingHand:false,isDeaf:false,isTalking:false,isCameraOn:false,isScreenSharingOn:false,});_iceServers;_isPendingNotify=false;_notificationsToSend=new Map();_isAntiGlareEnabled=true;_tmpNotificationId=0;_recoverTimeouts=new Map();_notificationRoute;_isStreamingEnabled=true;_tracks=Object.seal({[STREAM_TYPE.AUDIO]:null,[STREAM_TYPE.SCREEN]:null,[STREAM_TYPE.CAMERA]:null,});_loggingFunctions={[LOG_LEVEL.DEBUG]:()=>{},[LOG_LEVEL.INFO]:()=>{},[LOG_LEVEL.WARN]:()=>{},[LOG_LEVEL.ERROR]:()=>{},};get isActive(){return Boolean(this.selfId!==undefined&&this.channelId!==undefined);}
constructor({notificationRoute=DEFAULT_NOTIFICATION_ROUTE,logLevel=LOG_LEVEL.ERROR,batchDelay=DEFAULT_BUS_BATCH_DELAY,antiGlare=true,enableStreaming=true,}={}){super();this._isStreamingEnabled=enableStreaming;this._isAntiGlareEnabled=antiGlare;this._notificationRoute=notificationRoute;this._batchDelay=batchDelay;this.setLoggingLevel(logLevel);}
connect(selfId,channelId,{info={},iceServers=DEFAULT_ICE_SERVERS}={}){if(!IS_CLIENT_RTC_COMPATIBLE){throw new Error("RTCPeerConnection is not supported");}
this.selfId=selfId;this.channelId=channelId;this._iceServers=iceServers;this._localInfo=Object.assign(this._localInfo,info);}
removeALlPeers(){for(const peer of this.peers.values()){this.removePeer(peer.id);}
this.peers.clear();}
disconnect(){this.removeALlPeers();this.selfId=undefined;this.channelId=undefined;this._isPendingNotify=false;this._notificationsToSend.clear();this._localInfo=Object.assign(this._localInfo,{isSelfMuted:false,isRaisingHand:false,isDeaf:false,isTalking:false,isCameraOn:false,isScreenSharingOn:false,});}
async addPeer(id,options={}){const peer=this.peers.get(id);if(peer){return peer;}
const newPeer=this._createPeer(id,options);await newPeer.ready;return newPeer;}
removePeer(id){const recoverTimeoutId=this._recoverTimeouts.get(id);browser.clearTimeout(recoverTimeoutId);this._recoverTimeouts.delete(id);const peer=this.peers.get(id);if(!peer){return;}
this.peers.delete(id);peer.disconnect();}
broadcast(message){this._dataChannelBroadcast(INTERNAL_EVENT.BROADCAST,message);}
async getFormattedStats(id){const peer=this.peers.get(id);const formattedStats={};if(!peer){return formattedStats;}
formattedStats.connectionState=peer.connection.connectionState;formattedStats.iceConnectionState=peer.connection.iceConnectionState;formattedStats.iceGatheringState=peer.connection.iceGatheringState;const stats=await peer.connection.getStats();for(const value of stats?.values()||[]){switch(value.type){case"candidate-pair":if(value.state==="succeeded"&&value.localCandidateId){formattedStats.localCandidateType=stats.get(value.localCandidateId)?.candidateType||"";formattedStats.remoteCandidateType=stats.get(value.remoteCandidateId)?.candidateType||"";}
break;case"data-channel":formattedStats.dataChannelState=value.state;break;case"transport":formattedStats.dtlsState=value.dtlsState;formattedStats.iceState=value.iceState;formattedStats.packetsReceived=value.packetsReceived;formattedStats.packetsSent=value.packetsSent;break;}}
return formattedStats;}
updateDownload(id,states){const peer=this.peers.get(id);if(!peer){return;}
for(const[streamType,accepted]of Object.entries(states)){peer.medias[streamType].accepted=accepted;const transceiver=peer.getTransceiver(streamType);if(!transceiver){this._recover(id,`no transceiver available when updating direction`);return;}
transceiver.direction=peer.getRecommendedTransceiverDirection(streamType,Boolean(this._tracks[streamType]));}}
async updateUpload(streamType,track){this._tracks[streamType]=track||null;this.updateInfo({isScreenSharingOn:Boolean(this._tracks[STREAM_TYPE.SCREEN]),isCameraOn:Boolean(this._tracks[STREAM_TYPE.CAMERA]),});const proms=[];for(const peer of this.peers.values()){proms.push(peer.ready.then(()=>this._updateRemote(peer,streamType)));}
await Promise.all(proms);}
updateInfo(info){this._localInfo=Object.assign(this._localInfo,info);this._dataChannelBroadcast(INTERNAL_EVENT.INFO,this._localInfo);}
async handleNotification(id,content){const{event,channelId,payload}=JSON.parse(content);this._emitLog(id,`received notification: ${event}`,LOG_LEVEL.DEBUG);if(channelId!==this.channelId){return;}
let peer=this.peers.get(id);if(event!==INTERNAL_EVENT.OFFER&&!peer?.connection){this._emitLog(id,`received ${event} for missing peer ${id}`,LOG_LEVEL.WARN);return;}
switch(event){case INTERNAL_EVENT.ANSWER:{this._emitLog(id,`received answer`,LOG_LEVEL.DEBUG);if(INVALID_ICE_CONNECTION_STATES.has(peer.connection.iceConnectionState)||peer.connection.signalingState==="stable"||peer.connection.signalingState==="have-remote-offer"){return;}
const description=new window.RTCSessionDescription(payload.sdp);try{await peer.connection.setRemoteDescription(description);}catch{this._recover(id,"answer handling: Failed at setting remoteDescription");}
break;}
case INTERNAL_EVENT.BROADCAST:{this._emitUpdate({name:UPDATE_EVENT.BROADCAST,payload:{senderId:id,message:payload},});peer.ready.resolve(true);break;}
case INTERNAL_EVENT.DISCONNECT:{this.removePeer(id);this._emitUpdate({name:UPDATE_EVENT.DISCONNECT,payload:{sessionId:id}});break;}
case INTERNAL_EVENT.ICE_CANDIDATE:{if(INVALID_ICE_CONNECTION_STATES.has(peer.connection.iceConnectionState)){return;}
const rtcIceCandidate=new window.RTCIceCandidate(payload.candidate);try{await peer.connection.addIceCandidate(rtcIceCandidate);}catch{this._recover(id,"failed at adding ice candidate");}
break;}
case INTERNAL_EVENT.INFO:{const{isTalking,isCameraOn,isScreenSharingOn}=payload;peer.medias[STREAM_TYPE.AUDIO].active=isTalking;peer.medias[STREAM_TYPE.CAMERA].active=isCameraOn;peer.medias[STREAM_TYPE.SCREEN].active=isScreenSharingOn;this._emitUpdate({name:UPDATE_EVENT.INFO_CHANGE,payload:{[id]:payload},});break;}
case INTERNAL_EVENT.OFFER:{try{const accepted=await this.acceptOffer(id,payload.sequence);if(!accepted){this._emitLog(id,"offer rejected",LOG_LEVEL.INFO);return;}}catch(error){this._emitLog(id,`offer rejected: ${error}`,LOG_LEVEL.INFO);}
if(!peer){peer=this._createPeer(id,{sequence:payload.sequence});}
if(!peer.connection||INVALID_ICE_CONNECTION_STATES.has(peer.connection.iceConnectionState)||peer.connection.signalingState==="have-remote-offer"){return;}
const isStable=peer.connection.signalingState==="stable"||peer.isBuildingAnswer;const hasOfferCollision=!isStable||peer.isBuildingOffer;if(hasOfferCollision&&peer.hasPriority&&this._isAntiGlareEnabled){this._emitLog(peer.id,`rolling back due to offer collision: ${peer.connection.signalingState}`,LOG_LEVEL.WARN);try{await peer.connection.setLocalDescription({type:"rollback"});}catch{this._recover(id,`failed rollback`);}}
const description=new window.RTCSessionDescription(payload.sdp);try{await peer.connection.setRemoteDescription(description);}catch{this._recover(id,"failed at setting remoteDescription");return;}
if(!peer.connection){this._emitLog(id,"the peer connection was closed during offer negotiation",LOG_LEVEL.WARN);return;}
if(this._isStreamingEnabled){if(peer.connection.getTransceivers().length===0){for(const streamType of ORDERED_TRANSCEIVER_TYPES){const type=streamType===STREAM_TYPE.AUDIO?"audio":"video";peer.connection.addTransceiver(type);}}
for(const transceiverName of ORDERED_TRANSCEIVER_TYPES){await this._updateRemote(peer,transceiverName);}}
peer.isBuildingAnswer=true;try{await peer.connection.setLocalDescription(await peer.connection.createAnswer());}catch{peer.isBuildingAnswer=false;this._recover(id,"offer handling: failed at setting answer localDescription");return;}
peer.isBuildingAnswer=false;if(!this.isActive||!this.peers.has(id)){return;}
this._emitLog(id,`sending answer`,LOG_LEVEL.DEBUG);await this._busNotify(INTERNAL_EVENT.ANSWER,{payload:{sdp:peer.connection.localDescription,},targets:[peer.id],});this._recover(peer.id,"standard answer timeout");break;}}}
setLoggingLevel(logLevel){const makeLog=(level)=>(id,message)=>{this.dispatchEvent(new CustomEvent("log",{detail:{id,level,message}}));};this._loggingFunctions={[LOG_LEVEL.DEBUG]:()=>{},[LOG_LEVEL.INFO]:()=>{},[LOG_LEVEL.WARN]:()=>{},[LOG_LEVEL.ERROR]:()=>{},};switch(logLevel){case LOG_LEVEL.DEBUG:this._loggingFunctions[LOG_LEVEL.DEBUG]=makeLog(LOG_LEVEL.DEBUG);case LOG_LEVEL.INFO:this._loggingFunctions[LOG_LEVEL.INFO]=makeLog(LOG_LEVEL.INFO);case LOG_LEVEL.WARN:this._loggingFunctions[LOG_LEVEL.WARN]=makeLog(LOG_LEVEL.WARN);case LOG_LEVEL.ERROR:this._loggingFunctions[LOG_LEVEL.ERROR]=makeLog(LOG_LEVEL.ERROR);}}
_dataChannelBroadcast(internalEvent,message){for(const peer of this.peers.values()){if(!peer?.dataChannel||peer?.dataChannel.readyState!=="open"){continue;}
peer.dataChannel.send(JSON.stringify({event:internalEvent,channelId:this.channelId,payload:message,}));}}
_emitUpdate(detail){this.dispatchEvent(new CustomEvent("update",{detail}));}
_emitLog(id,message,level=LOG_LEVEL.DEBUG){this._loggingFunctions[level](id,message);}
_recover(id,reason=""){this._emitLog(id,`connection recovery candidate: ${reason}`,LOG_LEVEL.WARN);if(this._recoverTimeouts.get(id)){return;}
const peer=this.peers.get(id);if(!peer){return;}
const delay=Math.min(peer.connectRetryDelay*1.5,MAXIMUM_RECONNECT_DELAY)+1000*Math.random();this._recoverTimeouts.set(id,browser.setTimeout(async()=>{const peer=this.peers.get(id);this._recoverTimeouts.delete(id);const connectionSuccess=peer.connection.connectionState==="connected"||peer.connection.connectionState==="completed";const iceSuccess=peer.connection.iceConnectionState==="connected"||peer.connection.iceConnectionState==="completed";if(!peer?.connection||!this.channelId||(connectionSuccess&&iceSuccess)){return;}
this._emitUpdate({name:UPDATE_EVENT.RECOVERY,payload:{id}});this._emitLog(id,`attempting to recover connection: ${reason}`,LOG_LEVEL.ERROR);this._busNotify(INTERNAL_EVENT.DISCONNECT,{targets:[peer.id]});this.removePeer(peer.id);this.addPeer(peer.id,{connectRetryDelay:delay,sequence:peer.sequence});},delay));}
async _sendNotifications(){if(this._isPendingNotify){return;}
this._isPendingNotify=true;await new Promise((resolve)=>setTimeout(resolve,this._batchDelay));if(!this.isActive){this._isPendingNotify=false;return;}
const ids=[];const notifications=[];this._notificationsToSend.forEach((notification,id)=>{ids.push(id);notifications.push([notification.sender,notification.targets,JSON.stringify({event:notification.event,channelId:notification.channelId,payload:notification.payload,}),]);});try{await rpc(this._notificationRoute,{peer_notifications:notifications,},{silent:true});for(const id of ids){this._notificationsToSend.delete(id);}}finally{this._isPendingNotify=false;if(this._notificationsToSend.size>0){await this._sendNotifications();}}}
async _busNotify(event,{payload,targets}={}){targets=targets||Array.from(this.peers.keys());let id;if(event===INTERNAL_EVENT.OFFER){id=`latestOffer_to:${targets[0]}`;}else{id=++this._tmpNotificationId;}
this._notificationsToSend.set(id,{channelId:this.channelId,event,payload,sender:this.selfId,targets,});await this._sendNotifications();}
async _updateRemote(peer,streamType){const track=this._tracks[streamType];const transceiver=peer.getTransceiver(streamType);if(!transceiver){return;}
try{await transceiver.sender.replaceTrack(track);transceiver.direction=peer.getRecommendedTransceiverDirection(streamType,Boolean(track));}catch(error){this._recover(peer.id,`failed to update ${streamType} transceiver for peer ${peer.id}: ${error}`);}}
_createPeer(id,options={}){this.removePeer(id);const peerConnection=new window.RTCPeerConnection({iceServers:this._iceServers});const dataChannel=peerConnection.createDataChannel("notifications",{negotiated:true,id:1,});const peer=new Peer(id,{...options,connection:peerConnection,dataChannel,hasPriority:id>this.selfId,});this._emitUpdate({name:UPDATE_EVENT.CONNECTION_CHANGE,payload:{id,peer,state:"searching for network"},});this.peers.set(id,peer);peerConnection.addEventListener("icecandidate",async(event)=>{if(!event.candidate){return;}
if(!this.isActive||!this.peers.has(id)){return;}
await this._busNotify(INTERNAL_EVENT.ICE_CANDIDATE,{payload:{candidate:event.candidate,},targets:[id],});});peerConnection.addEventListener("iceconnectionstatechange",async()=>{switch(peerConnection.iceConnectionState){case"closed":this.removePeer(id);break;case"failed":case"disconnected":this._recover(peer.id,1000,"ice connection disconnected");break;}});peerConnection.addEventListener("icegatheringstatechange",()=>{this._emitLog(id,`gathering state change: ${peerConnection.iceGatheringState}`,LOG_LEVEL.INFO);});peerConnection.addEventListener("connectionstatechange",async()=>{this._emitUpdate({name:UPDATE_EVENT.CONNECTION_CHANGE,payload:{id,peer,state:peerConnection.connectionState},});switch(peerConnection.connectionState){case"closed":this.removePeer(id);break;case"failed":case"disconnected":this._recover(peer.id,1000,"connection disconnected");break;}
this._emitLog(id,`connection state change: ${peerConnection.connectionState}`,LOG_LEVEL.INFO);});peerConnection.addEventListener("icecandidateerror",async(error)=>{this._recover(id,`ice candidate error: ${error.errorText}`);});peerConnection.addEventListener("negotiationneeded",async()=>{peer.isBuildingOffer=true;try{await peerConnection.setLocalDescription(await peerConnection.createOffer());}catch(error){this._recover(id,`failed to set local Description for offer: ${error}`);peer.isBuildingOffer=false;return;}
peer.isBuildingOffer=false;if(!this.isActive||!this.peers.has(id)){return;}
await this._busNotify(INTERNAL_EVENT.OFFER,{payload:{sdp:peerConnection.localDescription,sequence:peer.sequence,},targets:[id],});});peerConnection.addEventListener("track",async({transceiver,track})=>{if(!peer?.id||!this.peers.has(peer.id)){return;}
const streamType=peer.getTransceiverStreamType(transceiver);if(!streamType){this._recover(id,"received track for unknown transceiver");return;}
peer.medias[streamType].track=track;if(!(await peer.ready)){return;}
this._emitUpdate({name:UPDATE_EVENT.TRACK,payload:{sessionId:id,type:streamType,track,active:peer.medias[streamType].active,sequence:peer.sequence,},});});dataChannel.addEventListener("message",async(event)=>{await this.handleNotification(id,event.data);});dataChannel.addEventListener("open",()=>{if(dataChannel.readyState!=="open"){return;}
dataChannel.send(JSON.stringify({event:INTERNAL_EVENT.INFO,channelId:this.channelId,payload:this._localInfo,}));this.broadcast({sequence:peer.sequence});});return peer;}}
return __exports;});;

/* /mail/static/src/discuss/call/common/pip_banner.js */
odoo.define('@mail/discuss/call/common/pip_banner',['@odoo/owl','@mail/discuss/call/common/call_action_list','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Component,useSubEnv}=require("@odoo/owl");const{CallActionList}=require("@mail/discuss/call/common/call_action_list");const{useService}=require("@web/core/utils/hooks");const PipBanner=__exports.PipBanner=class PipBanner extends Component{static template="discuss.pipBanner";static props=["compact?"];static components={CallActionList};setup(){super.setup();this.rtc=useService("discuss.rtc");useSubEnv({isDiscussPipBanner:true});}
onClickClose(){this.rtc.closePip();}}
return __exports;});;

/* /mail/static/src/discuss/call/common/pip_service.js */
odoo.define('@mail/discuss/call/common/pip_service',['@web/core/registry','@odoo/owl','@mail/discuss/call/common/meeting'],function(require){'use strict';let __exports={};const{registry}=require("@web/core/registry");const{reactive}=require("@odoo/owl");const{Meeting}=require("@mail/discuss/call/common/meeting");const callPipService=__exports.callPipService={dependencies:["mail.popout"],start(env,services){const popoutService=services["mail.popout"];const popout=popoutService.createManager(Symbol("discuss.native.pip"));let pipWindow=null;const state=reactive({active:false,});popout.addHooks(()=>{},()=>{state.active=false;env.services["discuss.rtc"]?.channel?.openChatWindow();});function closePip(){state.active=false;pipWindow?.close();}
async function openPip({context}){const rtc=env.services["discuss.rtc"];if(!rtc?.channel){return;}
state.active=true;const isShadowRoot=context?.root?.el?.getRootNode()instanceof ShadowRoot;pipWindow=await popout.pip(Meeting,{props:{isPip:true},options:{useAlternativeAssets:isShadowRoot},});pipWindow.addEventListener("keydown",(ev)=>{rtc.onKeyDown(ev);});pipWindow.addEventListener("keyup",(ev)=>{rtc.onKeyUp(ev);});pipWindow.document.body.style.backgroundColor="black";pipWindow.document.body.style.overflow="hidden";pipWindow.document.body.style.display="block";}
return reactive({get isNativePipAvailable(){return Boolean(window.documentPictureInPicture);},get pipWindow(){return pipWindow;},state,closePip,openPip,});},};registry.category("services").add("discuss.pip_service",callPipService);return __exports;});;

/* /mail/static/src/discuss/call/common/ptt_ad_banner.js */
odoo.define('@mail/discuss/call/common/ptt_ad_banner',['@odoo/owl','@web/core/browser/browser','@web/core/browser/feature_detection','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Component,useState}=require("@odoo/owl");const{browser}=require("@web/core/browser/browser");const{isMobileOS}=require("@web/core/browser/feature_detection");const{useService}=require("@web/core/utils/hooks");const PttAdBanner=__exports.PttAdBanner=class PttAdBanner extends Component{static template="discuss.pttAdBanner";static props={};static LOCAL_STORAGE_KEY="ptt_ad_banner_discarded";setup(){super.setup();this.pttExtService=useService("discuss.ptt_extension");this.store=useService("mail.store");this.state=useState({wasDiscarded:browser.localStorage.getItem(PttAdBanner.LOCAL_STORAGE_KEY),});}
onClickClose(){browser.localStorage.setItem(PttAdBanner.LOCAL_STORAGE_KEY,true);this.state.wasDiscarded=true;}
get isVisible(){return(!this.pttExtService.isEnabled&&this.store.settings.use_push_to_talk&&!isMobileOS()&&!this.state.wasDiscarded);}}
return __exports;});;

/* /mail/static/src/discuss/call/common/ptt_extension_service.js */
odoo.define('@mail/discuss/call/common/ptt_extension_service',['@odoo/owl','@mail/utils/common/misc','@web/core/browser/browser','@web/core/registry','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{markup,reactive}=require("@odoo/owl");const{parseVersion}=require("@mail/utils/common/misc");const{browser}=require("@web/core/browser/browser");const{registry}=require("@web/core/registry");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const pttExtensionServiceInternal=__exports.pttExtensionServiceInternal={onAnswerIsEnabled(pttService){pttService.isEnabled=true;},};const pttExtensionHookService=__exports.pttExtensionHookService={start(env){const INITIAL_RELEASE_TIMEOUT=750;const COMMON_RELEASE_TIMEOUT=200;const EXT_ID="mdiacebcbkmjjlpclnbcgiepgifcnpmg";const versionPromise=window.chrome?.runtime?.sendMessage(EXT_ID,{type:"ask-version"}).catch(()=>"1.0.0.0")??Promise.resolve("1.0.0.0");const self=reactive({isEnabled:undefined,voiceActivated:undefined,notifyIsTalking(isTalking){sendMessage("is-talking",isTalking);},subscribe(){sendMessage("subscribe");},unsubscribe(){self.voiceActivated=false;sendMessage("unsubscribe");},downloadURL:`https://chromewebstore.google.com/detail/discuss-push-to-talk/${EXT_ID}`,get downloadText(){return _t("The Push-to-Talk feature is only accessible within tab focus. To enable the Push-to-Talk functionality outside of this tab, we recommend downloading our %(anchor_start)sextension%(anchor_end)s.",{anchor_start:markup`<a href="${this.downloadURL}" target="_blank" class="text-reset text-decoration-underline">`,anchor_end:markup`</a>`,});},});browser.addEventListener("message",({data,origin,source})=>{const rtc=env.services["discuss.rtc"];if(source!==window||origin!==location.origin||data.from!=="discuss-push-to-talk"||(!rtc&&data.type!=="answer-is-enabled")){return;}
switch(data.type){case"push-to-talk-pressed":{self.voiceActivated=false;const isFirstPress=!rtc.selfSession?.isTalking;rtc.onPushToTalk();if(rtc.selfSession?.isTalking){rtc.setPttReleaseTimeout(isFirstPress?INITIAL_RELEASE_TIMEOUT:COMMON_RELEASE_TIMEOUT);}}
break;case"toggle-voice":{if(self.voiceActivated){rtc.setPttReleaseTimeout(0);}else{rtc.onPushToTalk();}
self.voiceActivated=!self.voiceActivated;}
break;case"answer-is-enabled":pttExtensionServiceInternal.onAnswerIsEnabled(self);break;}});async function sendMessage(type,value){if(!self.isEnabled&&type!=="ask-is-enabled"){return;}
const version=parseVersion(await versionPromise);if(location.origin==="null"){return;}
if(version.isLowerThan("1.0.0.2")){window.postMessage({from:"discuss",type,value},location.origin);return;}
window.chrome?.runtime?.sendMessage(EXT_ID,{type,value});}
sendMessage("ask-is-enabled");return self;},};registry.category("services").add("discuss.ptt_extension",pttExtensionHookService);return __exports;});;

/* /mail/static/src/discuss/call/common/quick_video_settings.js */
odoo.define('@mail/discuss/call/common/quick_video_settings',['@odoo/owl','@mail/discuss/call/common/call_settings','@mail/discuss/call/common/device_select','@web/core/utils/hooks','@web/core/browser/feature_detection'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const{CallSettingsDialog}=require("@mail/discuss/call/common/call_settings");const{DeviceSelect}=require("@mail/discuss/call/common/device_select");const{useService}=require("@web/core/utils/hooks");const{isBrowserSafari}=require("@web/core/browser/feature_detection");const QuickVideoSettings=__exports.QuickVideoSettings=class QuickVideoSettings extends Component{static template="discuss.QuickVideoSettings";static props=[];static components={DeviceSelect};setup(){super.setup();this.store=useService("mail.store");this.dialogService=useService("dialog");this.isBrowserSafari=isBrowserSafari;}
onClickVideoSettings(){this.dialogService.add(CallSettingsDialog,{});}}
return __exports;});;

/* /mail/static/src/discuss/call/common/quick_voice_settings.js */
odoo.define('@mail/discuss/call/common/quick_voice_settings',['@odoo/owl','@mail/discuss/call/common/call_settings','@mail/discuss/call/common/device_select','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const{CallSettingsDialog}=require("@mail/discuss/call/common/call_settings");const{DeviceSelect}=require("@mail/discuss/call/common/device_select");const{useService}=require("@web/core/utils/hooks");const QuickVoiceSettings=__exports.QuickVoiceSettings=class QuickVoiceSettings extends Component{static template="discuss.QuickVoiceSettings";static props=[];static components={DeviceSelect};setup(){super.setup();this.store=useService("mail.store");this.dialogService=useService("dialog");}
onClickVoiceSettings(){this.dialogService.add(CallSettingsDialog,{});}}
return __exports;});;

/* /mail/static/src/discuss/call/common/res_partner_model_patch.js */
odoo.define('@mail/discuss/call/common/res_partner_model_patch',['@mail/core/common/res_partner_model','@mail/model/misc','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{ResPartner}=require("@mail/core/common/res_partner_model");const{fields}=require("@mail/model/misc");const{patch}=require("@web/core/utils/patch");patch(ResPartner.prototype,{setup(){super.setup(...arguments);this.currentRtcSession=fields.One("discuss.channel.rtc.session",{inverse:"partner_id",});},});return __exports;});;

/* /mail/static/src/discuss/call/common/rtc_service.js */
odoo.define('@mail/discuss/call/common/rtc_service',['@mail/core/common/record','@mail/discuss/call/common/blur_manager','@mail/discuss/call/common/call_permission_dialog','@mail/discuss/call/common/thread_model_patch','@mail/utils/common/media_monitoring','@web/core/network/rpc','@mail/utils/common/misc','@mail/discuss/call/common/call_infinite_mirroring_warning','@odoo/owl','@web/core/browser/browser','@web/core/l10n/translation','@web/core/registry','@web/core/utils/objects','@web/core/utils/timing','@web/core/assets','@web/core/utils/functions','@web/core/utils/urls','@web/core/browser/feature_detection','@mail/discuss/call/common/call_actions'],function(require){'use strict';let __exports={};const{fields,Record}=require("@mail/core/common/record");const{BlurManager}=require("@mail/discuss/call/common/blur_manager");const{CallPermissionDialog}=require("@mail/discuss/call/common/call_permission_dialog");const{CALL_PROMOTE_FULLSCREEN}=require("@mail/discuss/call/common/thread_model_patch");const{monitorAudio}=require("@mail/utils/common/media_monitoring");const{rpc}=require("@web/core/network/rpc");const{assignDefined,closeStream,onChange}=require("@mail/utils/common/misc");const{CallInfiniteMirroringWarning}=require("@mail/discuss/call/common/call_infinite_mirroring_warning");const{reactive,toRaw}=require("@odoo/owl");const{browser}=require("@web/core/browser/browser");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{registry}=require("@web/core/registry");const{pick}=require("@web/core/utils/objects");const{debounce}=require("@web/core/utils/timing");const{loadBundle,loadJS}=require("@web/core/assets");const{memoize}=require("@web/core/utils/functions");const{url}=require("@web/core/utils/urls");const{isBrowserSafari,isMobileOS}=require("@web/core/browser/feature_detection");const{CallAction}=require("@mail/discuss/call/common/call_actions");let sequence=1;const getSequence=()=>sequence++;const loadSfuAssets=memoize(async()=>await loadBundle("mail.assets_odoo_sfu"));function subscribe(target,event,f){target.addEventListener(event,f);return()=>target.removeEventListener(event,f);}
const PTT_RELEASE_DURATION=__exports.PTT_RELEASE_DURATION=200;const SW_MESSAGE_TYPE={POST_RTC_LOGS:"POST_RTC_LOGS",};const CONNECTION_TYPES=__exports.CONNECTION_TYPES={P2P:"p2p",SERVER:"server"};const SCREEN_CONFIG={width:{max:1920},height:{max:1080},aspectRatio:16/9,frameRate:{max:24,},};const IS_CLIENT_RTC_COMPATIBLE=Boolean(window.RTCPeerConnection&&window.MediaStream);function GET_DEFAULT_ICE_SERVERS(){return[{urls:["stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302"]}];}
const CROSS_TAB_HOST_MESSAGE=__exports.CROSS_TAB_HOST_MESSAGE={PING:"PING",UPDATE_REMOTE:"UPDATE_REMOTE",CLOSE:"CLOSE",PIP_CHANGE:"PIP_CHANGE",};const CROSS_TAB_CLIENT_MESSAGE=__exports.CROSS_TAB_CLIENT_MESSAGE={INIT:"INIT",REQUEST_ACTION:"REQUEST_ACTION",LEAVE:"LEAVE",UPDATE_VOLUME:"UPDATE_VOLUME",};const PING_INTERVAL=30_000;const UNAVAILABLE_AS_REMOTE=_t("This action can only be done in the call tab.");const CALL_FULLSCREEN_ID=Symbol("CALL_FULLSCREEN");function hasTurn(iceServers){return iceServers.some((server)=>{let hasTurn=false;if(server.url){hasTurn=server.url.startsWith("turn:");}
if(server.urls){if(Array.isArray(server.urls)){hasTurn=server.urls.some((url)=>url.startsWith("turn:"))||hasTurn;}else{hasTurn=server.urls.startsWith("turn:")||hasTurn;}}
return hasTurn;});}
const Network=__exports.Network=class Network{p2p;sfu;_listeners=[];constructor(p2p,sfu){this.p2p=p2p;this.sfu=sfu;}
getSfuConsumerStats(sessionId){const consumers=this.sfu?._consumers.get(sessionId);if(!consumers){return[];}
return Object.entries(consumers).map(([type,consumer])=>{let state="active";if(!consumer){state="no consumer";}else if(consumer.closed){state="closed";}else if(consumer.paused){state="paused";}else if(!consumer.track){state="no track";}else if(!consumer.track.enabled){state="track disabled";}else if(consumer.track.muted){state="track muted";}
return{type,state};});}
addSfu(sfu){if(this.sfu){this.sfu.disconnect();}
this.sfu=sfu;}
removeSfu(){if(!this.sfu){return;}
for(const{name,f}of this._listeners){this.sfu.removeEventListener(name,f);}
this.sfu.disconnect();}
addEventListener(name,f){this._listeners.push({name,f});this.p2p.addEventListener(name,f);this.sfu?.addEventListener(name,f);}
async updateUpload(type,track){const proms=[this.p2p.updateUpload(type,track)];if(this.sfu?.state==="connected"){proms.push(this.sfu.updateUpload(type,track));}
await Promise.all(proms);}
updateDownload(sessionId,states){this.p2p.updateDownload(sessionId,states);this.sfu?.updateDownload(sessionId,states);}
updateInfo(info,options={}){this.p2p.updateInfo(info,options);this.sfu?.updateInfo(info,options);}
disconnect(){for(const{name,f}of this._listeners.splice(0)){this.p2p.removeEventListener(name,f);this.sfu?.removeEventListener(name,f);}
this.p2p.disconnect();this.sfu?.disconnect();}}
const Rtc=__exports.Rtc=class Rtc extends Record{notifications=reactive(new Map());timeouts=new Map();downloadTimeouts=new Map();iceServers=fields.Attr(undefined,{compute(){return this.iceServers?this.iceServers:GET_DEFAULT_ICE_SERVERS();},});microphonePermission;cameraPermission;localSession=fields.One("discuss.channel.rtc.session");selfSession=fields.One("discuss.channel.rtc.session",{compute(){return(this.localSession||this.store["discuss.channel.rtc.session"].get(this._remotelyHostedSessionId));},onDelete(){if(this.channel){this.channel.promoteFullscreen=CALL_PROMOTE_FULLSCREEN.INACTIVE;}},});channel=fields.One("Thread",{compute(){if(this.state.channel){return this.state.channel;}
if(this._remotelyHostedChannelId){return this.store.Thread.insert({model:"discuss.channel",id:this._remotelyHostedChannelId,});}},onUpdate(){if(!this.channel){return;}
this.store.Thread.getOrFetch({model:"discuss.channel",id:this.channel.id,});},});rootEl;serverInfo;network;sfuClient=undefined;lastActions={};actionsStack=[];lastSelfCallAction=undefined;cleanups=[];sfuTimeout;audioContext;_broadcastChannel=new browser.BroadcastChannel("call_sync_state");_remotelyHostedSessionId;_remotelyHostedChannelId;_crossTabTimeoutId;_p2pRecoveryCount=0;upgradeConnectionDebounce=debounce(()=>{this._upgradeConnection();},15000,{leading:true,trailing:false});get isRemote(){return Boolean(this._remotelyHostedChannelId);}
get isHost(){return Boolean(this.localSession);}
callActions=fields.Attr([],{compute(){const transformedActions=registry.category("discuss.call/actions").getEntries().map(([id,definition])=>new CallAction({owner:this,id,definition}));for(const action of transformedActions){action.setup();}
return transformedActions;},onUpdate(){for(const action of this.callActions){if(action.isActive===this.lastActions[action.id]){continue;}
if(!action.isTracked){continue;}
if(action.isActive){if(!this.actionsStack.includes(action.id)){this.actionsStack.unshift(action.id);}}else{this.actionsStack.splice(this.actionsStack.indexOf(action.id),1);}}
this.lastSelfCallAction=this.actionsStack[0];this.lastActions=Object.fromEntries(this.callActions.map((action)=>[action.id,action.isActive]));},});setup(){this.linkVoiceActivationDebounce=debounce(this.linkVoiceActivation,500);this.state=reactive({connectionType:undefined,hasPendingRequest:false,channel:undefined,logs:{},sendCamera:false,sendScreen:false,updateAndBroadcastDebounce:undefined,micAudioTrack:undefined,screenAudioTrack:undefined,audioTrack:undefined,cameraTrack:undefined,screenTrack:undefined,disconnectAudioMonitor:undefined,pttReleaseTimeout:undefined,sourceCameraStream:null,sourceScreenStream:null,fallbackMode:false,isPipMode:false,isFullscreen:false,});this.blurManager=undefined;}
start(){const services=this.store.env.services;this.notification=services.notification;this.overlay=services.overlay;this.dialog=services.dialog;this.soundEffectsService=services["mail.sound_effects"];this.pttExtService=services["discuss.ptt_extension"];if(this._broadcastChannel){this._broadcastChannel.onmessage=this._onBroadcastChannelMessage.bind(this);this._postToTabs({type:CROSS_TAB_CLIENT_MESSAGE.INIT});}
this.p2pService=services["discuss.p2p"];onChange(this.store.settings,"useBlur",()=>{if(this.state.sendCamera){this.toggleVideo("camera",{force:true});}});onChange(this.store.settings,["edgeBlurAmount","backgroundBlurAmount"],()=>{if(this.blurManager){this.blurManager.edgeBlur=this.store.settings.edgeBlurAmount;this.blurManager.backgroundBlur=this.store.settings.backgroundBlurAmount;}});onChange(this.store.settings,["voiceActivationThreshold","use_push_to_talk"],()=>{this.linkVoiceActivationDebounce();});onChange(this.store.settings,"audioInputDeviceId",async()=>{if(this.localSession){await this.resetMicAudioTrack({force:true});}});onChange(this.store.settings,"audioOutputDeviceId",async()=>{if(this.localSession){await this.setOutputDevice(this.store.settings.audioOutputDeviceId);}});onChange(this.store.settings,"cameraInputDeviceId",async()=>{if(this.localSession&&this.state.cameraTrack){await this.toggleVideo("camera",{force:true,refreshStream:true});}});this.store.env.bus.addEventListener("RTC-SERVICE:PLAY_MEDIA",()=>{const channel=this.state.channel;if(!channel){return;}
for(const session of channel.rtc_session_ids){session.playAudio();}});browser.addEventListener("blur",()=>this.onBlur());browser.addEventListener("keydown",(ev)=>{this.onKeyDown(ev);},{capture:true});browser.addEventListener("keyup",(ev)=>{this.onKeyUp(ev);},{capture:true});browser.addEventListener("pagehide",()=>{if(this.state.channel){const data=JSON.stringify({params:{channel_id:this.state.channel.id,session_id:this.selfSession.id},});const blob=new Blob([data],{type:"application/json"});browser.navigator.sendBeacon("/mail/rtc/channel/leave_call",blob);this.sfuClient?.disconnect();}});browser.setInterval(async()=>{if(!this.localSession||!this.state.channel){return;}
this._postToTabs({type:CROSS_TAB_HOST_MESSAGE.PING,hostedSessionId:this.localSession.id,});await this.ping();if(!this.localSession||!this.state.channel){return;}
this.call();},PING_INTERVAL);}
get displaySurface(){return this.state.sourceScreenStream?.getVideoTracks()[0]?.getSettings().displaySurface;}
isPushToTalkRelease(ev){if(!this.state.channel||!this.store.settings.use_push_to_talk||(ev instanceof KeyboardEvent&&!this.store.settings.isPushToTalkKey(ev))||!this.localSession.isTalking||this.pttExtService.voiceActivated){return false;}
return true;}
onKeyDown(ev){if(!this.store.settings.isPushToTalkKey(ev)){return;}
this.onPushToTalk();}
onKeyUp(ev){if(!this.isPushToTalkRelease(ev)){return;}
this.setPttReleaseTimeout();}
onBlur(){if(!this.isPushToTalkRelease()){return;}
this.setPttReleaseTimeout();}
showMirroringWarning(){this.state.screenTrack.enabled=false;const trackEndedFn=()=>this.removeMirroringWarning?.();this.removeMirroringWarning=this.overlay.add(CallInfiniteMirroringWarning,{onClose:({stopScreensharing}={})=>{this.removeMirroringWarning({stopScreensharing});},},{onRemove:({stopScreensharing}={})=>{if(stopScreensharing){this.toggleVideo("screen",false);}
this.state.screenTrack?.removeEventListener("ended",trackEndedFn);this.removeMirroringWarning=null;},});this.state.screenTrack.addEventListener("ended",trackEndedFn,{once:true});}
setPttReleaseTimeout(duration=PTT_RELEASE_DURATION){this.state.pttReleaseTimeout=browser.setTimeout(()=>{this.setTalking(false);if(!this.localSession?.isMute){this.soundEffectsService.play("ptt-release");}},Math.max(this.store.settings.voice_active_duration||0,duration));}
onPushToTalk(){if(!this.state.channel||this.store.settings.isRegisteringKey||!this.store.settings.use_push_to_talk){return;}
browser.clearTimeout(this.state.pttReleaseTimeout);if(!this.localSession.isTalking&&!this.localSession.isMute){this.soundEffectsService.play("ptt-press");}
this.setTalking(true);}
async openPip(options){if(this.isHost){this.exitFullscreen();await this.pipService.openPip(options);return;}
this.notification.add(UNAVAILABLE_AS_REMOTE,{type:"warning",});}
closePip(){if(this.isHost){this.pipService.closePip();}else{this._remoteAction({pip:false});}}
addCallNotification({id,text,delay=3000}){if(this.notifications.has(id)){return;}
this.notifications.set(id,{id,text});this.timeouts.set(id,browser.setTimeout(()=>{this.notifications.delete(id);this.timeouts.delete(id);},delay));}
removeCallNotification(id){browser.clearTimeout(this.timeouts.get(id));this.notifications.delete(id);this.timeouts.delete(id);}
async leaveCall(channel=this.state.channel){this.store.fullscreenChannel=null;this.state.hasPendingRequest=true;await this.rpcLeaveCall(channel);this.endCall(channel);this.state.hasPendingRequest=false;}
endCall(channel=this.state.channel){this._endHost();if(channel.self_member_id){channel.self_member_id.rtc_inviting_session_id=undefined;}
channel.activeRtcSession=undefined;if(channel.eq(this.state.channel)){this.state.logs.end=new Date().toISOString();this.dumpLogs();this.pttExtService.unsubscribe();this.network?.disconnect();this.clear();this.soundEffectsService.play("call-leave");}}
async deafen(){if(this.isRemote){this._remoteAction({is_deaf:true});return;}
await this.setDeaf(true);this.soundEffectsService.play("earphone-off");}
setRemoteRaiseHand(session,active){if(Boolean(session.raisingHand)===active){return;}
Object.assign(session,{raisingHand:active?new Date():undefined,});const notificationId="raise_hand_"+session.id;if(session.raisingHand){this.addCallNotification({id:notificationId,text:_t("%s raised their hand",session.name),});}else{this.removeCallNotification(notificationId);}}
setVolume(session,volume){session.volume=volume;this.store.settings.saveVolumeSetting({guestId:session?.guest_id?.id,partnerId:session?.partner_id?.id,volume,});this._postToTabs({type:CROSS_TAB_CLIENT_MESSAGE.UPDATE_VOLUME,changes:{sessionId:session.id,volume},});}
async mute(){if(this.isRemote){this._remoteAction({is_muted:true});return;}
await this.setMute(true);this.soundEffectsService.play("mic-off");}
async enterFullscreen(props){const Meeting=registry.category("discuss.call/components").get("Meeting");this.store.fullscreenChannel=this.channel;await this.fullscreen.enter(Meeting,{id:CALL_FULLSCREEN_ID,keepBrowserHeader:true,props,rootId:this.rootEl?.getRootNode()?.host?.id,});}
async exitFullscreen(){this.store.fullscreenChannel=null;await this.fullscreen.exit(CALL_FULLSCREEN_ID);}
async toggleCall(channel,{audio=true,camera}={}){if(channel.id===this._remotelyHostedChannelId){this._postToTabs({type:CROSS_TAB_CLIENT_MESSAGE.LEAVE});this.clear();return;}
await Promise.resolve(()=>loadJS(url("/mail/static/lib/selfie_segmentation/selfie_segmentation.js")).catch(()=>{}));if(this.state.hasPendingRequest){return;}
const isActiveCall=channel.eq(this.state.channel);if(this.state.channel){await this.leaveCall(this.state.channel);}
if(!isActiveCall){const joinCallOpts={audio,camera};if(this.microphonePermission!=="granted"){joinCallOpts.audio=false;}
await this.joinCall(channel,joinCallOpts);}}
async toggleCameraFacingMode(){this.store.settings.cameraFacingMode=this.store.settings.cameraFacingMode==="user"?"environment":"user";await this.toggleVideo("camera",{force:true,refreshStream:true});}
async toggleDeafen(){if(this.selfSession.is_deaf){await this.undeafen();if(this.selfSession.is_muted){await this.unmute();}}else{await this.deafen();}}
async toggleMicrophone(){if(this.selfSession.isMute){if(this.selfSession.is_muted){await this.unmute();}
if(this.selfSession.is_deaf){await this.undeafen();}}else{await this.mute();}}
async undeafen(){if(this.isRemote){this._remoteAction({is_deaf:false});return;}
await this.setDeaf(false);this.soundEffectsService.play("earphone-on");}
showMediaPermissionDialog(media){this.closeCallPermissionDialog=this.dialog.add(CallPermissionDialog,{media,useMicrophone:()=>this.unmute(),useCamera:()=>this.toggleVideo("camera",{force:true,refreshStream:true}),},{context:{root:{el:this.rootEl}}});}
showMediaUnavailableWarning({microphone,camera,screen}){let errorMessage;if(microphone&&camera){errorMessage=_t("Camera and microphone access blocked. Enable in browser settings.");}else if(camera){errorMessage=_t("Camera access blocked. Enable in browser settings.");}else if(microphone){errorMessage=_t("Microphone access blocked. Enable in browser settings.");}else if(screen){errorMessage=_t("Screen sharing access blocked. Enable in browser settings.");}
this.notification.add(errorMessage,{type:"warning"});}
async askForBrowserPermission({audio,video}){try{const stream=await browser.navigator.mediaDevices.getUserMedia({audio:audio?this.store.settings.audioConstraints:false,video:video?this.store.settings.cameraConstraints:false,});if(isBrowserSafari()||isMobileOS()){if(audio){this.microphonePermission="granted";}
if(video){this.cameraPermission="granted";}}
closeStream(stream);}catch{this.showMediaUnavailableWarning({microphone:audio,camera:video});}
if(audio&&video){return this.microphonePermission==="granted"&&this.cameraPermission==="granted";}
return audio?this.microphonePermission==="granted":this.cameraPermission==="granted";}
async unmute(){if(this.isRemote){this._remoteAction({is_muted:false});return;}
if(this.microphonePermission==="prompt"){this.showMediaPermissionDialog("microphone");return;}
if(this.state.micAudioTrack){await this.setMute(false);}else{await this.resetMicAudioTrack({force:true});}
this.soundEffectsService.play("mic-on");}
async _loadSfu(){const load=async()=>{await loadSfuAssets();const sfuModule=odoo.loader.modules.get("@mail/../lib/odoo_sfu/odoo_sfu");this.SFU_CLIENT_STATE=sfuModule.SFU_CLIENT_STATE;this.sfuClient=new sfuModule.SfuClient();};try{await load();}catch{await new Promise((resolve,reject)=>{browser.setTimeout(async()=>{try{await load();}catch(error){reject(error);}
resolve();},1000);});}}
updateUpload(){this.network?.updateUpload("audio",this.state.audioTrack);this.network?.updateUpload("camera",this.state.cameraTrack);this.network?.updateUpload("screen",this.state.screenTrack);}
async _initConnection(){this.localSession.connectionState="selecting network type";this.state.connectionType=CONNECTION_TYPES.P2P;this.network?.disconnect();this.p2pService.connect(this.localSession.id,this.state.channel.id,{info:this.formatInfo(),iceServers:this.iceServers,});this.network=new Network(this.p2pService);this.updateUpload();if(this.serverInfo){this.log(this.localSession,"loading sfu server",{step:"loading sfu server",serverInfo:toRaw(this.serverInfo),});this.localSession.connectionState="loading SFU assets";try{await this._loadSfu();this.state.connectionType=CONNECTION_TYPES.SERVER;if(this.network){this.network.addSfu(this.sfuClient);}else{return;}}catch(e){this.state.fallbackMode=true;this.notification.add(_t("Failed to load the SFU server, falling back to peer-to-peer"),{type:"warning",});this.log(this.localSession,"failed to load sfu server",{error:e,important:true,});}
this.selfSession.connectionState="initializing";}else{this.log(this.localSession,"no sfu server info, using peer-to-peer");}
this.network.addEventListener("stateChange",this._handleSfuClientStateChange);this.network.addEventListener("update",this._handleNetworkUpdates);this.network.addEventListener("log",({detail:{id,level,message}})=>{const session=this.store["discuss.channel.rtc.session"].get(id);if(session){this.log(session,message,{step:"p2p",level,important:true});}});if(this.state.channel){await this.call();this.updateUpload();}}
_remoteAction(changes){this._postToTabs({type:CROSS_TAB_CLIENT_MESSAGE.REQUEST_ACTION,changes,});}
_updateInfo(){if(!this.isHost){return;}
const info=toRaw(this.formatInfo());this.network?.updateInfo(info);this._updateRemoteTabs({[this.localSession.id]:info});}
_host(){this._remotelyHostedChannelId=undefined;this._remotelyHostedSessionId=this.localSession.id;this._updateRemoteTabs({[this.localSession.id]:toRaw(this.formatInfo())});}
_endHost(){this._postToTabs({type:CROSS_TAB_HOST_MESSAGE.CLOSE,hostedSessionId:this._remotelyHostedSessionId,});}
_updateRemoteTabs(changes){this._postToTabs({type:CROSS_TAB_HOST_MESSAGE.UPDATE_REMOTE,hostedChannelId:this.state.channel.id,hostedSessionId:this.localSession.id,changes,});}
_postToTabs(message){if(!this._broadcastChannel){this.log(this.selfSession,"broadcast channel not available");return;}
try{this._broadcastChannel.postMessage(message);}catch(error){this.log(this.selfSession,"failed to post message to broadcast channel",{error});}}
_refreshCrossTabTimeout(){browser.clearTimeout(this._crossTabTimeoutId);this._crossTabTimeoutId=browser.setTimeout(()=>{this.clear();},PING_INTERVAL+10_000);}
async _onBroadcastChannelMessage({data:{type,hostedChannelId,hostedSessionId,changes},}){switch(type){case CROSS_TAB_HOST_MESSAGE.UPDATE_REMOTE:if(this.isHost){return;}
this._remotelyHostedSessionId=hostedSessionId;this._remotelyHostedChannelId=hostedChannelId;this._refreshCrossTabTimeout();this.updateSessionInfo(changes);return;case CROSS_TAB_HOST_MESSAGE.CLOSE:{if(this._remotelyHostedSessionId!==hostedSessionId){return;}
this.clear();return;}
case CROSS_TAB_HOST_MESSAGE.PIP_CHANGE:{if(this.isHost){return;}
this.state.isPipMode=changes.isPipMode;return;}
case CROSS_TAB_HOST_MESSAGE.PING:{this._refreshCrossTabTimeout();return;}
case CROSS_TAB_CLIENT_MESSAGE.INIT:{if(!this.isHost){return;}
this._updateRemoteTabs({[this.localSession.id]:toRaw(this.formatInfo())});this._postToTabs({type:CROSS_TAB_HOST_MESSAGE.PIP_CHANGE,changes:{isPipMode:this.state.isPipMode},});return;}
case CROSS_TAB_CLIENT_MESSAGE.REQUEST_ACTION:{if(!this.isHost){return;}
await this._localAction(changes);this._updateRemoteTabs({[this.localSession.id]:toRaw(this.formatInfo())});return;}
case CROSS_TAB_CLIENT_MESSAGE.LEAVE:{if(!this.isHost){return;}
await this.leaveCall(this.channel);return;}
case CROSS_TAB_CLIENT_MESSAGE.UPDATE_VOLUME:{const session=this.store["discuss.channel.rtc.session"].get(changes.sessionId);if(!session){return;}
session.volume=changes.volume;return;}}}
async _localAction(actions={}){const promises=[];for(const[key,value]of Object.entries(actions)){switch(key){case"is_muted":if(value===this.localSession.is_muted){break;}
promises.push(value?this.mute():this.unmute());break;case"is_deaf":if(value===this.localSession.is_deaf){break;}
value?promises.push(this.deafen()):promises.push(this.undeafen());break;case"raisingHand":if(value===Boolean(this.localSession.raisingHand)){break;}
promises.push(this.raiseHand(value));break;case"pip":if(value===this.state.isPipMode){break;}
if(value){promises.push(this.openPip());}else{this.closePip();}
break;}}
await Promise.all(promises);}
log(session,entry,param2={}){if(!session){return;}
const{error,step,state,important,...data}=param2;session.logStep=entry;if(!this.store.settings.logRtc&&!important){return;}
console.debug(`%c${new Date().toLocaleString()} - [${entry}]`,"color: #e36f17; font-weight: bold;",toRaw(session)._raw,param2);if(!this.state.logs){return;}
let sessionEntry=this.state.logs.entriesBySessionId[session.id];if(!sessionEntry){this.state.logs.entriesBySessionId[session.id]=sessionEntry={step:"",state:"",logs:[],};}
if(step){sessionEntry.step=step;}
if(state){sessionEntry.state=state;}
sessionEntry.logs.push({event:`${new Date().toISOString()}: ${entry}`,error:error&&{name:error.name,message:error.message,stack:error.stack&&error.stack.split("\n"),},...data,});}
async _handleNetworkUpdates({detail:{name,payload}}){if(!this.state.channel){return;}
switch(name){case"broadcast":{const{senderId,message:{sequence},}=payload;if(!sequence){return;}
const session=await this.store["discuss.channel.rtc.session"].getWhenReady(senderId);if(!session){return;}
if(!session.sequence||session.sequence<sequence){session.sequence=sequence;}}
return;case"connection_change":{const{id,state}=payload;const session=this.store["discuss.channel.rtc.session"].get(id);if(!session){return;}
session.connectionState=state;}
return;case"disconnect":{const{sessionId}=payload;const session=this.store["discuss.channel.rtc.session"].get(sessionId);if(!session){return;}
this.disconnect(session);}
return;case"info_change":this.updateSessionInfo(payload);return;case"track":{const{sessionId,type,track,active,sequence}=payload;const session=await this.store["discuss.channel.rtc.session"].getWhenReady(sessionId);if(!session||!this.state.channel){this.log(this.selfSession,`track received for unknown session ${sessionId} (${this.state.connectionType})`);return;}
if(sequence&&sequence<session.sequence){this.log(session,`track received for old sequence ${sequence} (${this.state.connectionType})`);return;}
this.log(session,`${type} track received (${this.state.connectionType})`);try{await this.handleRemoteTrack({session,track,type,active});}catch{}
setTimeout(()=>{this.updateVideoDownload(session);},2000);}
return;case"recovery":{const{id}=payload;const session=this.store["discuss.channel.rtc.session"].get(id);if(this.selfSession?.persona.main_user_id?.share!==false||this.serverInfo||this.state.fallbackMode||!session?.channel.eq(this.state.channel)){return;}
this._p2pRecoveryCount++;if(this._p2pRecoveryCount>1||!hasTurn(this.iceServers)){this.upgradeConnectionDebounce();}}}}
async _handleSfuClientStateChange({detail:{state,cause}}){this.log(this.localSession,`connection state change: ${state}`,{state,cause});this.localSession.connectionState=state;switch(state){case this.SFU_CLIENT_STATE.AUTHENTICATED:this.p2pService.removeALlPeers();this.sfuClient.broadcast({sequence:getSequence()});break;case this.SFU_CLIENT_STATE.CONNECTED:browser.clearTimeout(this.sfuTimeout);this.sfuClient.updateInfo(this.formatInfo(),{needRefresh:true,});this.sfuClient.updateUpload("audio",this.state.audioTrack);this.sfuClient.updateUpload("camera",this.state.cameraTrack);this.sfuClient.updateUpload("screen",this.state.screenTrack);return;case this.SFU_CLIENT_STATE.CLOSED:{if(!this.state.channel){return;}
let text;if(cause==="full"){text=_t("Channel full");this.leaveCall();}else{text=_t("Connection to SFU server closed by the server, falling back to peer-to-peer");this.log(this.localSession,text,{important:true});this._downgradeConnection();}
this.notification.add(text,{type:"warning",});}
return;}}
async _upgradeConnection(){const channelId=this.state.channel?.id;if(this.serverInfo||this.state.fallbackMode||!channelId){return;}
await rpc("/mail/rtc/channel/upgrade_connection",{channel_id:channelId},{silent:true});}
updateSessionInfo(payload){if(!payload){return;}
if(this.isHost){this._updateRemoteTabs(payload);}
for(const[id,info]of Object.entries(payload)){(async()=>{const session=await this.store["discuss.channel.rtc.session"].getWhenReady(Number(id));if(!session||session.eq(this.localSession)||!this.channel){return;}
this.setRemoteRaiseHand(session,info.isRaisingHand);delete info.isRaisingHand;assignDefined(session,{is_muted:info.isSelfMuted??info.is_muted,is_deaf:info.isDeaf??info.is_deaf,isTalking:info.isTalking,is_camera_on:info.isCameraOn??info.is_camera_on,is_screen_sharing_on:info.isScreenSharingOn??info.is_screen_sharing_on,});})();}}
async _downgradeConnection(){this.serverInfo=undefined;this.state.fallbackMode=true;this.state.connectionType=CONNECTION_TYPES.P2P;this.network.removeSfu();await this.call();this.updateUpload();}
async call({asFallback=false}={}){if(asFallback&&!this.state.fallbackMode){return;}
if(this.state.connectionType===CONNECTION_TYPES.SERVER){if(this.sfuClient.state===this.SFU_CLIENT_STATE.DISCONNECTED){browser.clearTimeout(this.sfuTimeout);this.sfuTimeout=browser.setTimeout(()=>{this.log(this.selfSession,"sfu connection timeout",{important:true});this._downgradeConnection();},10000);await this.sfuClient.connect(this.serverInfo.url,this.serverInfo.jsonWebToken,{channelUUID:this.serverInfo.channelUUID,iceServers:this.iceServers,});}
return;}
if(this.state.channel.rtc_session_ids.length===0){return;}
const sequence=getSequence();for(const session of this.state.channel.rtc_session_ids){if(session.eq(this.localSession)){continue;}
this.p2pService.addPeer(session.id,{sequence});}}
async handleRemoteTrack({session,track,type,active=true}){session.updateStreamState(type,active);await this.updateStream(session,track,{mute:this.localSession.is_deaf,videoType:type,});this.updateActiveSession(session,type,{addVideo:true});}
async joinCall(channel,{audio=true,camera=false}={}){if(!IS_CLIENT_RTC_COMPATIBLE){this.notification.add(_t("Your browser does not support webRTC."),{type:"warning"});return;}
this.pttExtService.subscribe();this.state.hasPendingRequest=true;const data=await rpc("/mail/rtc/channel/join_call",{camera,channel_id:channel.id,check_rtc_session_ids:channel.rtc_session_ids.map((session)=>session.id),},{silent:true});this.state.hasPendingRequest=false;this.clear();this.state.channel=channel;this.store.insert(data);this.newLogs();this.state.updateAndBroadcastDebounce=debounce(async()=>{if(!this.localSession){return;}
await rpc("/mail/rtc/session/update_and_broadcast",{session_id:this.localSession.id,values:pick(this.localSession,"is_camera_on","is_deaf","is_muted","is_screen_sharing_on"),},{silent:true});},3000,{leading:true,trailing:true});if(this.state.channel.self_member_id){this.state.channel.self_member_id.rtc_inviting_session_id=undefined;}
if(camera){await this.toggleVideo("camera");}
if(!this.selfSession){return;}
await this._initConnection();await this.resetMicAudioTrack({force:audio});if(!this.state.channel?.id){return;}
this.soundEffectsService.play("call-join");this._host();this.cleanups.push(subscribe(browser,"beforeunload",(event)=>{event.preventDefault();}));this.channel?.focusAvailableVideo();}
newLogs(){this.state.logs={channelId:this.state.channel.id,selfSessionId:this.localSession.id,start:new Date().toISOString(),hasTurn:hasTurn(this.iceServers),entriesBySessionId:{},};}
dumpLogs({download=false}={}){const logs=[];if(this.state.logs){logs.push({type:"timeline",entry:this.state.logs.start,value:toRaw(this.state.logs),});}
if(this.state.channel){logs.push(this.buildSnapshot());}
if(logs.length||download){browser.navigator.serviceWorker?.controller?.postMessage({name:SW_MESSAGE_TYPE.POST_RTC_LOGS,logs,download,});}}
buildSnapshot(){const server={};if(this.state.connectionType===CONNECTION_TYPES.SERVER){server.info=toRaw(this.serverInfo);server.state=this.sfuClient?.state;server.errors=this.sfuClient?.errors.map((error)=>error.message);}
const sessions=this.state.channel.rtc_session_ids.map((session)=>{const sessionInfo={id:session.id,channelMemberId:session.channel_member_id?.id,state:session.connectionState,audioError:session.audioError,videoError:session.videoError,sfuConsumers:this.network?.getSfuConsumerStats(session.id),};if(session.eq(this.selfSession)){sessionInfo.isSelf=true;}
const audioEl=session.audioElement;if(audioEl){sessionInfo.audio={state:audioEl.readyState,muted:audioEl.muted,paused:audioEl.paused,networkState:audioEl.networkState,};}
const peer=this.p2pService?.peers.get(session.id);if(peer){sessionInfo.peer={id:peer.id,state:peer.connection.connectionState,iceState:peer.connection.iceConnectionState,};}
return sessionInfo;});return{type:"snapshot",entry:new Date().toISOString(),value:{server,sessions,connectionType:this.state.connectionType,fallback:this.state.fallbackMode,},};}
logSnapshot(){if(!this.state.channel){return;}
browser.navigator.serviceWorker?.controller?.postMessage({name:SW_MESSAGE_TYPE.POST_RTC_LOGS,logs:[this.buildSnapshot()],});}
async rpcLeaveCall(channel){await rpc("/mail/rtc/channel/leave_call",{channel_id:channel.id,},{silent:true});}
async ping(){const data=await rpc("/discuss/channel/ping",{channel_id:this.state.channel.id,check_rtc_session_ids:this.state.channel.rtc_session_ids.map((session)=>session.id),rtc_session_id:this.localSession.id,},{silent:true});this.store.insert(data);}
disconnect(session){const downloadTimeout=this.downloadTimeouts.get(session.id);if(downloadTimeout){clearTimeout(downloadTimeout);this.downloadTimeouts.delete(session.id);}
this.removeCallNotification("raise_hand_"+session.id);session.raisingHand=undefined;session.logStep=undefined;session.audioError=undefined;session.videoError=undefined;session.connectionState=undefined;session.isTalking=false;session.mainVideoStreamType=undefined;this.removeAudioFromSession(session);this.removeVideoFromSession(session);this.p2pService?.removePeer(session.id);this.log(session,"peer removed",{step:"peer removed"});}
clear(){if(this.state.channel){for(const session of this.state.channel.rtc_session_ids){this.removeAudioFromSession(session);this.removeVideoFromSession(session);session.isTalking=false;}}
this.exitFullscreen();this._remotelyHostedSessionId=undefined;this._remotelyHostedChannelId=undefined;browser.clearTimeout(this._crossTabTimeoutId);this.cleanups.splice(0).forEach((cleanup)=>cleanup());browser.clearTimeout(this.sfuTimeout);this.sfuClient=undefined;this.network=undefined;this.audioContext?.close();this.audioContext=undefined;this._p2pRecoveryCount=0;this.closeCallPermissionDialog?.();this.state.updateAndBroadcastDebounce?.cancel();this.state.disconnectAudioMonitor?.();this.state.micAudioTrack?.stop();this.state.screenAudioTrack?.stop();this.state.audioTrack?.stop();this.state.cameraTrack?.stop();this.state.screenTrack?.stop();this.state.fallbackMode=undefined;this.state.isPipMode=false;closeStream(this.state.sourceCameraStream);this.state.sourceCameraStream=null;closeStream(this.state.sourceScreenStream);this.state.sourceScreenStream=null;if(this.blurManager){this.blurManager.close();this.blurManager=undefined;}
this.update({localSession:undefined,serverInfo:undefined,});Object.assign(this.state,{updateAndBroadcastDebounce:undefined,connectionType:undefined,disconnectAudioMonitor:undefined,cameraTrack:undefined,screenTrack:undefined,screenAudioTrack:undefined,micAudioTrack:undefined,audioTrack:undefined,sendCamera:false,sendScreen:false,channel:undefined,fallbackMode:false,});this.pipService?.closePip();}
async setDeaf(is_deaf){this.updateAndBroadcast({is_deaf});for(const session of this.state.channel.rtc_session_ids){if(!session.audioElement){continue;}
session.audioElement.muted=is_deaf;}
await this.refreshMicAudioStatus();}
async setOutputDevice(deviceId){const promises=[];for(const session of this.state.channel.rtc_session_ids){if(!session.audioElement){continue;}
promises.push(session.audioElement.setSinkId(deviceId));}
await Promise.all(promises);}
async setMute(is_muted){this.updateAndBroadcast({is_muted});await this.refreshMicAudioStatus();}
async raiseHand(raise){if(this.isRemote){this._remoteAction({raisingHand:raise});return;}
if(!this.localSession||!this.state.channel){return;}
this.localSession.raisingHand=raise?new Date():undefined;await this._updateInfo();}
async setTalking(isTalking){if(!this.localSession||isTalking===this.localSession.isTalking){return;}
this.localSession.isTalking=isTalking;if(!this.localSession.isMute){this.pttExtService.notifyIsTalking(isTalking);await this.refreshMicAudioStatus();}}
async applyBlurEffect(videoStream){return new BlurManager(videoStream,{backgroundBlur:this.store.settings.backgroundBlurAmount,edgeBlur:this.store.settings.edgeBlurAmount,});}
async toggleVideo(type,options){let force;let env;let refreshStream;if(typeof options==="boolean"){force=options;}else{force=options?.force;env=options?.env;refreshStream=options?.refreshStream;}
if(this.isRemote){this.notification.add(UNAVAILABLE_AS_REMOTE,{type:"warning",});return;}
if(!this.state.channel?.id){return;}
switch(type){case"camera":{if(this.cameraPermission==="prompt"&&!this.state.cameraTrack){this.showMediaPermissionDialog("camera");return;}
const track=this.state.cameraTrack;const sendCamera=force??!this.state.sendCamera;this.state.sendCamera=false;await this.setVideo(track,type,{activateVideo:sendCamera,env,refreshStream});break;}
case"screen":{const track=this.state.screenTrack;const sendScreen=force??!this.state.sendScreen;this.state.sendScreen=false;await this.setVideo(track,type,{activateVideo:sendScreen,env});break;}}
if(this.localSession){switch(type){case"camera":{this.removeVideoFromSession(this.localSession,{type:"camera",cleanup:false,});if(this.state.cameraTrack){this.updateStream(this.localSession,this.state.cameraTrack);}
break;}
case"screen":{if(!this.state.screenTrack){this.removeVideoFromSession(this.localSession,{type:"screen",cleanup:false,});}else{this.updateStream(this.localSession,this.state.screenTrack);}
break;}}}
const updatedTrack=type==="camera"?this.state.cameraTrack:this.state.screenTrack;await this.network?.updateUpload(type,updatedTrack);if(!this.localSession){return;}
switch(type){case"camera":{this.updateAndBroadcast({is_camera_on:!!this.state.sendCamera,});break;}
case"screen":{this.updateAndBroadcast({is_screen_sharing_on:!!this.state.sendScreen,});break;}}}
updateAndBroadcast(data){this._updateRemoteTabs({[this.localSession.id]:data});assignDefined(this.localSession,data);this.state.updateAndBroadcastDebounce?.();}
async refreshMicAudioStatus(){if(!this.state.micAudioTrack){return;}
this.state.micAudioTrack.enabled=!this.localSession.isMute&&this.localSession.isTalking;this._updateInfo();}
async setVideo(track,type,options){let activateVideo;let env;if(typeof options==="boolean"){activateVideo=options??false;}else{activateVideo=options?.activateVideo??false;env=options?.env;}
const stopVideo=()=>{if(track){track.stop();}
switch(type){case"camera":{this.state.cameraTrack=undefined;closeStream(this.state.sourceCameraStream);this.state.sourceCameraStream=null;break;}
case"screen":{this.state.screenTrack=undefined;closeStream(this.state.sourceScreenStream);this.state.sourceScreenStream=null;break;}}};if(!activateVideo){if(type==="screen"){this.soundEffectsService.play("screen-sharing");}
if(type==="camera"&&this.blurManager){this.blurManager.close();this.blurManager=undefined;}
stopVideo();return;}
let sourceStream;const sourceWindow=env?.pipWindow??browser;try{if(type==="camera"){if(this.state.sourceCameraStream&&!options?.refreshStream){sourceStream=this.state.sourceCameraStream;}else{closeStream(this.state.sourceCameraStream);sourceStream=await sourceWindow.navigator.mediaDevices.getUserMedia({video:this.store.settings.cameraConstraints,});}}
if(type==="screen"){if(this.state.sourceScreenStream){sourceStream=this.state.sourceScreenStream;}else{sourceStream=await sourceWindow.navigator.mediaDevices.getDisplayMedia({video:SCREEN_CONFIG,audio:true,});}
this.soundEffectsService.play("screen-sharing");}}catch{this.showMediaUnavailableWarning({camera:type==="camera",screen:type==="screen",});stopVideo();return;}
if(!this.selfSession){closeStream(sourceStream);return;}
let outputTrack=sourceStream?sourceStream.getVideoTracks()[0]:undefined;const screenAudioTrack=sourceStream?sourceStream.getAudioTracks()[0]:undefined;if(outputTrack){outputTrack.addEventListener("ended",async()=>{await this.toggleVideo(type,{force:false});});if(type==="camera"&&isMobileOS()){const settings=outputTrack.getSettings();if(settings?.facingMode){this.store.settings.cameraFacingMode=settings.facingMode;}else if(!this.store.settings.cameraFacingMode){this.store.settings.cameraFacingMode="user";}}}
if(this.store.settings.useBlur&&type==="camera"){this.blurManager?.close();this.blurManager=undefined;try{this.blurManager=await this.applyBlurEffect(sourceStream);const blurredStream=await this.blurManager.stream;outputTrack=blurredStream.getVideoTracks()[0];}catch(_e){this.notification.add(_e.message,{type:"warning"});this.store.settings.useBlur=false;outputTrack=sourceStream.getVideoTracks()[0];}}else if(!this.store.settings.useBlur&&type==="camera"){this.blurManager?.close();this.blurManager=undefined;}
switch(type){case"camera":{Object.assign(this.state,{sourceCameraStream:sourceStream,cameraTrack:outputTrack,sendCamera:Boolean(outputTrack),isCameraSourceExternal:Boolean(sourceStream)&&env?.pipWindow,});break;}
case"screen":{Object.assign(this.state,{sourceScreenStream:sourceStream,screenTrack:outputTrack,screenAudioTrack:screenAudioTrack,sendScreen:Boolean(outputTrack),isScreenSourceExternal:Boolean(sourceStream)&&env?.pipWindow,});break;}}
if(this.state.screenAudioTrack){this.updateAudioTrack();}}
async updateAudioTrack(){const{micAudioTrack,screenAudioTrack}=this.state;if(!micAudioTrack&&!screenAudioTrack){return;}
if(micAudioTrack&&screenAudioTrack){await this.audioContext?.close();this.audioContext=undefined;this.audioContext=new AudioContext();const micSource=this.audioContext.createMediaStreamSource(new MediaStream([micAudioTrack]));const screenSource=this.audioContext.createMediaStreamSource(new MediaStream([screenAudioTrack]));const destination=this.audioContext.createMediaStreamDestination();micSource.connect(destination);screenSource.connect(destination);this.state.audioTrack=destination.stream.getAudioTracks()[0];}else{this.state.audioTrack=micAudioTrack??screenAudioTrack;}
await this.network?.updateUpload("audio",this.state.audioTrack);}
async resetMicAudioTrack({force=false}){this.state.micAudioTrack?.stop();this.state.micAudioTrack=undefined;this.state.audioTrack?.stop();this.state.audioTrack=undefined;if(!this.state.channel){return;}
if(this.localSession){this.setMute(true);}
if(force){let micAudioTrack;try{const audioStream=await browser.navigator.mediaDevices.getUserMedia({audio:this.store.settings.audioConstraints,});micAudioTrack=audioStream.getAudioTracks()[0];if(this.localSession){this.setMute(false);}}catch{this.showMediaUnavailableWarning({microphone:true});return;}
if(!this.localSession){micAudioTrack.stop();return;}
micAudioTrack.addEventListener("ended",async()=>{await this.resetMicAudioTrack({force:false});this.setMute(true);});micAudioTrack.enabled=!this.localSession.isMute&&this.localSession.isTalking;this.state.micAudioTrack=micAudioTrack;this.linkVoiceActivationDebounce();this.updateAudioTrack();}}
async linkVoiceActivation(){this.state.disconnectAudioMonitor?.();if(!this.localSession){return;}
if(this.store.settings.use_push_to_talk||!this.state.channel||!this.state.micAudioTrack){this.localSession.isTalking=false;await this.refreshMicAudioStatus();return;}
try{this.state.disconnectAudioMonitor=await monitorAudio(this.state.micAudioTrack,{onThreshold:async(isAboveThreshold)=>{this.setTalking(isAboveThreshold);},volumeThreshold:this.store.settings.voiceActivationThreshold,});}catch{this.notification.add(_t("Your browser does not support voice activation"),{type:"warning",});this.localSession.isTalking=true;}
await this.refreshMicAudioStatus();}
deleteSession(id){const session=this.store["discuss.channel.rtc.session"].get(id);if(session){if(this.localSession&&session.eq(this.localSession)){this.notifyServerDisconnect();this.endCall();}
this.disconnect(session);session.delete();}}
notifyServerDisconnect(){this.log(this.localSession,"self session deleted by the server, ending call",{important:true,});this.notification.add(_t("Disconnected from the call by the server"),{type:"warning",});}
formatInfo(){this.localSession.is_camera_on=Boolean(this.state.cameraTrack);this.localSession.is_screen_sharing_on=Boolean(this.state.screenTrack);return this.localSession.info;}
async updateStream(session,track,{mute,videoType}={}){const stream=new window.MediaStream();stream.addTrack(track);if(track.kind==="audio"){const audioElement=session.audioElement||new window.Audio();audioElement.srcObject=stream;audioElement.load();audioElement.muted=mute;audioElement.volume=this.store.settings.getVolume(session);audioElement.autoplay=true;session.audioElement=audioElement;session.audioStream=stream;session.is_muted=false;session.isTalking=false;await session.playAudio();}
if(track.kind==="video"){videoType=videoType?videoType:track.id===this.state.cameraTrack?.id?"camera":"screen";session.videoStreams.set(videoType,stream);this.updateActiveSession(session,videoType,{addVideo:true});}}
removeVideoFromSession(session,{type,cleanup=true}={}){if(type){this.updateActiveSession(session,type);if(cleanup){closeStream(session.videoStreams.get(type));}
session.videoStreams.delete(type);if(this.selfSession.videoStreams.size===0&&this.selfSession.eq(this.state.channel.activeRtcSession)){this.state.channel.activeRtcSession=undefined;}}else{if(cleanup){for(const stream of session.videoStreams.values()){closeStream(stream);}}
session.videoStreams.clear();}}
removeAudioFromSession(session){closeStream(session.audioStream);if(session.audioElement){session.audioElement.pause();try{session.audioElement.srcObject=undefined;}catch{}}
session.audioStream=undefined;}
updateActiveSession(session,videoType,{addVideo=false}={}){const activeRtcSession=this.state.channel.activeRtcSession;if(addVideo){if(videoType==="screen"){this.state.channel.activeRtcSession=session;session.mainVideoStreamType=videoType;return;}
if(activeRtcSession&&session.hasVideo&&!session.isMainVideoStreamActive){session.mainVideoStreamType=videoType;}
return;}
if(!activeRtcSession||activeRtcSession.notEq(session)){return;}
if(activeRtcSession.isMainVideoStreamActive){if(videoType===session.mainVideoStreamType){if(videoType==="screen"){session.mainVideoStreamType="camera";}else if(this.actionsStack.includes("camera-on")&&this.actionsStack.includes("share-screen")){session.mainVideoStreamType="screen";}}}}
updateVideoDownload(rtcSession,{viewCountIncrement=0}={}){rtcSession.videoComponentCount+=viewCountIncrement;const downloadTimeout=this.downloadTimeouts.get(rtcSession.id);if(downloadTimeout){this.downloadTimeouts.delete(rtcSession.id);browser.clearTimeout(downloadTimeout);}
if(rtcSession.videoComponentCount>0){this.network?.updateDownload(rtcSession.id,{camera:true,screen:true,});}else{this.downloadTimeouts.set(rtcSession.id,browser.setTimeout(()=>{this.downloadTimeouts.delete(rtcSession.id);this.network?.updateDownload(rtcSession.id,{camera:false,screen:false,});},1000));}}}
Rtc.register();const rtcService=__exports.rtcService={dependencies:["bus_service","discuss.p2p","discuss.pip_service","discuss.ptt_extension","mail.fullscreen","mail.sound_effects","mail.store","legacy_multi_tab","notification","presence",],start(env,services){const store=env.services["mail.store"];const rtc=store.rtc;rtc.pipService=services["discuss.pip_service"];onChange(rtc.pipService.state,"active",()=>{const isPipMode=rtc.pipService.state.active;if(!isPipMode){rtc.channel?.openChatWindow();}
rtc.state.isPipMode=isPipMode;rtc._postToTabs({type:CROSS_TAB_HOST_MESSAGE.PIP_CHANGE,changes:{isPipMode},});});rtc.fullscreen=services["mail.fullscreen"];onChange(rtc.fullscreen,"id",()=>{const wasFullscreen=rtc.state.isFullscreen;rtc.state.isFullscreen=rtc.fullscreen.id===CALL_FULLSCREEN_ID;if(rtc.state.screenTrack&&rtc.displaySurface!=="browser"&&rtc.fullscreen.id===CALL_FULLSCREEN_ID){rtc.showMirroringWarning();}else if(!rtc.state.isFullscreen){rtc.removeMirroringWarning?.();if(wasFullscreen&&rtc.state.screenTrack){rtc.state.screenTrack.enabled=true;}}});browser.navigator.permissions?.query({name:"microphone"}).then((status)=>{rtc.microphonePermission=status.state;status.onchange=()=>(rtc.microphonePermission=status.state);});browser.navigator.permissions?.query({name:"camera"}).then((status)=>{rtc.cameraPermission=status.state;status.onchange=()=>(rtc.cameraPermission=status.state);});rtc.p2pService=services["discuss.p2p"];rtc.p2pService.acceptOffer=async(id,sequence)=>{const session=await store["discuss.channel.rtc.session"].getWhenReady(Number(id));return sequence>=session?.sequence;};services["bus_service"].subscribe("discuss.channel.rtc.session/sfu_hot_swap",async({serverInfo})=>{if(!rtc.localSession){return;}
if(rtc.serverInfo?.channelUUID===serverInfo.channelUUID){rtc.p2pService.removeALlPeers();return;}
rtc.serverInfo=serverInfo;await rtc._initConnection();});services["bus_service"].subscribe("discuss.channel.rtc.session/ended",({sessionId})=>{if(rtc.localSession?.id===sessionId){rtc.notifyServerDisconnect();rtc.endCall();}});services["bus_service"].subscribe("res.users.settings.volumes",(payload)=>{if(payload){rtc.store.Volume.insert(payload);}});services["bus_service"].subscribe("discuss.channel.rtc.session/update_and_broadcast",(payload)=>{const{data,channelId}=payload;if(channelId!==rtc.channel?.id){rtc.store.insert(data);}});services["presence"].bus.addEventListener("presence",()=>{env.bus.trigger("RTC-SERVICE:PLAY_MEDIA");},{once:true});return rtc;},};registry.category("services").add("discuss.rtc",rtcService);return __exports;});;

/* /mail/static/src/discuss/call/common/rtc_session_model.js */
odoo.define('@mail/discuss/call/common/rtc_session_model',['@mail/core/common/record','@web/core/utils/concurrency'],function(require){'use strict';let __exports={};const{fields,Record}=require("@mail/core/common/record");const{Deferred}=require("@web/core/utils/concurrency");const RtcSession=__exports.RtcSession=class RtcSession extends Record{static _name="discuss.channel.rtc.session";static id="id";static awaitedRecords=new Map();static _insert(){const session=super._insert(...arguments);session.channel?.rtc_session_ids.add(session);return session;}
static async getWhenReady(id){const session=this.get(id);if(!session){let deferred=this.awaitedRecords.get(id);if(!deferred){deferred=new Deferred();this.awaitedRecords.set(id,deferred);setTimeout(()=>{deferred.resolve();this.awaitedRecords.delete(id);},120_000);}
return deferred;}
return session;}
static new(){const record=super.new(...arguments);this.awaitedRecords.get(record.id)?.resolve(record);this.awaitedRecords.delete(record.id);return record;}
channel_member_id=fields.One("discuss.channel.member",{inverse:"rtcSession"});partner_id=fields.One("res.partner",{compute(){return this.channel_member_id?.partner_id;},});guest_id=fields.One("mail.guest",{compute(){return this.channel_member_id?.guest_id;},});get persona(){return this.partner_id||this.guest_id;}
is_camera_on;is_screen_sharing_on=fields.Attr(undefined,{onUpdate(){if(this.eq(this.channel?.activeRtcSession)&&this.mainVideoStreamType==="screen"&&!this.is_screen_sharing_on){this.channel.activeRtcSession=undefined;}},});id;is_deaf;is_muted;audioElement;audioStream;dataChannel;audioError;videoError;isTalking=fields.Attr(false,{onUpdate(){if(this.isTalking&&!this.isMute){this.talkingTime=this.store.nextTalkingTime++;}
this.channel?.updateCallFocusStack(this);},});isActuallyTalking=fields.Attr(false,{compute(){return this.isTalking&&!this.isMute;},});isVideoStreaming=fields.Attr(false,{compute(){return this.is_screen_sharing_on||this.is_camera_on;},onUpdate(){if(this.isVideoStreaming&&this.channel?.channel_type==="chat"&&this.store.rtc.selfSession?.in(this.channel.rtc_session_ids)){this.channel.focusAvailableVideo();}},});shortStatus=fields.Attr(undefined,{compute(){if(this.is_screen_sharing_on){return"live";}
if(this.is_deaf){return"deafen";}
if(this.isMute){return"mute";}},});talkingTime=0;localVolume;peerConnection;raisingHand;videoComponentCount=0;videoStreams=new Map();mainVideoStreamType;sequence=0;connectionState;logStep;get channel(){return this.channel_member_id?.channel_id;}
get isMute(){return this.is_muted||this.is_deaf;}
get mainVideoStream(){return this.isMainVideoStreamActive&&this.videoStreams.get(this.mainVideoStreamType);}
get isMainVideoStreamActive(){if(!this.mainVideoStreamType){return false;}
return this.mainVideoStreamType==="camera"?this.is_camera_on:this.is_screen_sharing_on;}
get hasVideo(){return this.is_screen_sharing_on||this.is_camera_on;}
getStream(type){const isActive=type==="camera"?this.is_camera_on:this.is_screen_sharing_on;return isActive&&this.videoStreams.get(type);}
get info(){return{isSelfMuted:this.is_muted,isRaisingHand:Boolean(this.raisingHand),isDeaf:this.is_deaf,isTalking:this.isTalking,isCameraOn:this.is_camera_on,isScreenSharingOn:this.is_screen_sharing_on,};}
get name(){return this.channel_member_id?.name;}
get volume(){return this.audioElement?.volume||this.localVolume;}
set volume(value){if(this.audioElement){this.audioElement.volume=value;}
this.localVolume=value;}
async playAudio(){if(!this.audioElement){return;}
if(this.store.settings.audioOutputDeviceId){await this.audioElement.setSinkId(this.store.settings.audioOutputDeviceId).catch();}
try{await this.audioElement.play();this.audioError=undefined;}catch(error){this.audioError=error.name;}}
updateStreamState(type,state){if(type==="camera"){this.is_camera_on=state;}else if(type==="screen"){this.is_screen_sharing_on=state;}}}
RtcSession.register();return __exports;});;

/* /mail/static/src/discuss/call/common/settings_model_patch.js */
odoo.define('@mail/discuss/call/common/settings_model_patch',['@mail/core/common/settings_model','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Settings}=require("@mail/core/common/settings_model");const{patch}=require("@web/core/utils/patch");const SettingsPatch={setup(){super.setup(...arguments);},getVolume(rtcSession){return(rtcSession.volume??this.volumes.find((volume)=>volume.partner_id?.eq(rtcSession.partner_id)||volume.guest_id?.eq(rtcSession.guest_id))?.volume??0.5);},};patch(Settings.prototype,SettingsPatch);return __exports;});;

/* /mail/static/src/discuss/call/common/store_service_patch.js */
odoo.define('@mail/discuss/call/common/store_service_patch',['@mail/core/common/record','@mail/core/common/store_service','@web/core/browser/router','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{fields}=require("@mail/core/common/record");const{Store}=require("@mail/core/common/store_service");const{router}=require("@web/core/browser/router");const{patch}=require("@web/core/utils/patch");const StorePatch={setup(){super.setup(...arguments);this.rtc=fields.One("Rtc",{compute(){return{};},});this.ringingThreads=fields.Many("Thread",{onUpdate(){if(this.ringingThreads.length>0){this.env.services["mail.sound_effects"].play("call-invitation",{loop:true,});}else{this.env.services["mail.sound_effects"].stop("call-invitation");}},});this.allActiveRtcSessions=fields.Many("discuss.channel.rtc.session");this.nextTalkingTime=1;this.fullscreenChannel=fields.One("Thread");this._hasFullscreenUrl=fields.Attr(false,{compute(){return this.discuss?.thread?.eq(this.fullscreenChannel);},onUpdate(){if(!this.discuss?.hasRestoredThread){return;}
this._hasFullscreenUrlOnUpdate();},eager:true,});this.meetingViewOpened=false;},_hasFullscreenUrlOnUpdate(){router.pushState({fullscreen:this._hasFullscreenUrl?true:undefined,});},onStarted(){super.onStarted(...arguments);this.rtc.start();},sortMembers(m1,m2){const m1HasRtc=Boolean(m1.rtcSession);const m2HasRtc=Boolean(m2.rtcSession);if(m1HasRtc===m2HasRtc){const m1RaisingValue=m1.rtcSession?.raisingHand||Infinity;const m2RaisingValue=m2.rtcSession?.raisingHand||Infinity;if(m1HasRtc&&m1RaisingValue!==m2RaisingValue){return m1RaisingValue-m2RaisingValue;}else{return super.sortMembers(m1,m2);}}else{return m2HasRtc-m1HasRtc;}},};patch(Store.prototype,StorePatch);return __exports;});;

/* /mail/static/src/discuss/call/common/thread_actions.js */
odoo.define('@mail/discuss/call/common/thread_actions',['@mail/core/common/action','@mail/core/common/thread_actions','@mail/discuss/call/common/call_settings','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{ACTION_TAGS}=require("@mail/core/common/action");const{registerThreadAction}=require("@mail/core/common/thread_actions");const{CallSettings}=require("@mail/discuss/call/common/call_settings");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);registerThreadAction("call",{condition:({store,thread})=>thread?.allowCalls&&!thread?.eq(store.rtc.channel),icon:"fa fa-fw fa-phone",name:({thread})=>thread.rtc_session_ids.length>0?_t("Join the Call"):_t("Start Call"),open:({store,thread})=>store.rtc.toggleCall(thread),sequence:10,sequenceQuick:30,tags:[ACTION_TAGS.SUCCESS,ACTION_TAGS.JOIN_LEAVE_CALL],});registerThreadAction("camera-call",{condition:({store,thread})=>thread?.allowCalls&&!thread?.eq(store.rtc.channel),icon:"fa fa-fw fa-video-camera",name:({thread})=>thread.rtc_session_ids.length>0?_t("Join the Call with Camera"):_t("Start Video Call"),open:({store,thread})=>store.rtc.toggleCall(thread,{camera:true}),sequence:5,sequenceQuick:({owner})=>(owner.env.inDiscussApp?25:35),tags:[ACTION_TAGS.SUCCESS,ACTION_TAGS.JOIN_LEAVE_CALL],});registerThreadAction("call-settings",{actionPanelComponent:CallSettings,actionPanelComponentProps:()=>({isCompact:true}),condition:({owner,store,thread})=>thread?.allowCalls&&(owner.props.chatWindow?.isOpen||store.inPublicPage)&&!owner.isDiscussSidebarChannelActions,icon:"fa fa-fw fa-gear",name:_t("Call Settings"),sequence:20,sequenceGroup:30,toggle:true,});registerThreadAction("disconnect",{condition:({owner,store,thread})=>store.rtc.selfSession?.in(thread?.rtc_session_ids)&&owner.isDiscussSidebarChannelActions,open:({store,thread})=>store.rtc.toggleCall(thread),icon:"fa fa-fw fa-phone",name:_t("Disconnect"),sequence:30,sequenceGroup:10,tags:[ACTION_TAGS.DANGER,ACTION_TAGS.JOIN_LEAVE_CALL],});return __exports;});;

/* /mail/static/src/discuss/call/common/thread_model_patch.js */
odoo.define('@mail/discuss/call/common/thread_model_patch',['@mail/core/common/record','@mail/core/common/thread_model','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{fields}=require("@mail/core/common/record");const{Thread}=require("@mail/core/common/thread_model");const{patch}=require("@web/core/utils/patch");const CALL_PROMOTE_FULLSCREEN=__exports.CALL_PROMOTE_FULLSCREEN=Object.freeze({INACTIVE:"INACTIVE",ACTIVE:"ACTIVE",DISCARDED:"DISCARDED",});const ThreadPatch={setup(){super.setup(...arguments);this.activeRtcSession=fields.One("discuss.channel.rtc.session",{onAdd(r){this.store.allActiveRtcSessions.add(r);},onDelete(r){this.store.allActiveRtcSessions.delete(r);},});this.promoteFullscreen=CALL_PROMOTE_FULLSCREEN.DISABLED;this.hadSelfSession=false;this.lastSessionIds=new Set();this.cancelRtcInvitationTimeout;this.rtc_session_ids=fields.Many("discuss.channel.rtc.session",{onDelete(r){this.store.env.services["discuss.rtc"].deleteSession(r.id);},async onUpdate(){const hadSelfSession=this.hadSelfSession;const lastSessionIds=this.lastSessionIds;this.hadSelfSession=Boolean(this.store.rtc.selfSession?.in(this.rtc_session_ids));this.lastSessionIds=new Set(this.rtc_session_ids.map((s)=>s.id));const shouldPlayJoinSound=[...this.lastSessionIds].some((id)=>!lastSessionIds.has(id));const shouldPlayLeaveSound=[...lastSessionIds].some((id)=>!this.lastSessionIds.has(id));if(!hadSelfSession||!this.hadSelfSession||!(await this.store.env.services["multi_tab"].isOnMainTab())){return;}
if(shouldPlayJoinSound){this.store.env.services["mail.sound_effects"].play("call-join");this.store.rtc.call({asFallback:true});}
if(shouldPlayLeaveSound){this.store.env.services["mail.sound_effects"].play("member-leave");}},});this.videoCountNotSelf=fields.Attr(0,{compute(){return this.rtc_session_ids.filter((s)=>s.hasVideo&&s.notEq(this.store.rtc.selfSession)).length;},onUpdate(){if(this.promoteFullscreen===CALL_PROMOTE_FULLSCREEN.DISCARDED){return;}
this.promoteFullscreen=this.videoCountNotSelf>0&&this.chat_window?.isOpen?CALL_PROMOTE_FULLSCREEN.ACTIVE:CALL_PROMOTE_FULLSCREEN.INACTIVE;},});this.videoCount=fields.Attr(0,{compute(){return this.rtc_session_ids.filter((s)=>s.hasVideo).length;},});this.focusStack=fields.Many("discuss.channel.rtc.session");this.visibleCards=fields.Attr([],{compute(){const raisingHandCards=[];const sessionCards=[];const invitationCards=[];const filterVideos=this.store.settings.showOnlyVideo&&this.videoCount>0;for(const session of this.rtc_session_ids){const target=session.raisingHand?raisingHandCards:sessionCards;const cameraStream=session.is_camera_on?session.videoStreams.get("camera"):undefined;if(!filterVideos||cameraStream){target.push({key:"session_main_"+session.id,session,type:"camera",videoStream:cameraStream,});}
const screenStream=session.is_screen_sharing_on?session.videoStreams.get("screen"):undefined;if(screenStream){target.push({key:"session_secondary_"+session.id,session,type:"screen",videoStream:screenStream,});}}
if(!filterVideos){for(const member of this.invited_member_ids){invitationCards.push({key:"member_"+member.id,member});}}
raisingHandCards.sort((c1,c2)=>c1.session.raisingHand-c2.session.raisingHand);sessionCards.sort((c1,c2)=>c1.session.channel_member_id?.persona?.name?.localeCompare(c2.session.channel_member_id?.persona?.name)??1);invitationCards.sort((c1,c2)=>c1.member.persona?.name?.localeCompare(c2.member.persona?.name)??1);return raisingHandCards.concat(sessionCards,invitationCards);},});this.useCameraByDefault=fields.Attr(null,{compute(){if(this.channel_type==="chat"&&this.store.rtc.selfSession?.channel?.eq(this)){return this.store.rtc.selfSession.is_camera_on;}
return JSON.parse(localStorage.getItem(`discuss_channel_camera_default_${this.id}`));},onUpdate(){if(this.useCameraByDefault!==null){localStorage.setItem(`discuss_channel_camera_default_${this.id}`,JSON.stringify(this.useCameraByDefault));}},});},get isCallDisplayedInChatWindow(){return this.chat_window?.isOpen&&!this.store.meetingViewOpened;},get isSelfInCall(){return this.store.rtc.selfSession&&this.eq(this.store.rtc.channel);},get showCallView(){return!this.store.rtc.state.isFullscreen&&this.rtc_session_ids.length>0;},focusAvailableVideo(){if(!this.store.settings.useCallAutoFocus||!(this.store.env.services.ui.isSmall||this.store.rtc.state.isPipMode||this.isCallDisplayedInChatWindow)){return;}
const otherStreamingSession=this.rtc_session_ids.find((session)=>session.notEq(this.store.rtc.selfSession)&&session.hasVideo);if(!otherStreamingSession){return;}
this.activeRtcSession=otherStreamingSession;otherStreamingSession.mainVideoStreamType=otherStreamingSession.is_screen_sharing_on?"screen":"camera";},open(options){if(this.store.fullscreenChannel?.notEq(this)){this.store.rtc.exitFullscreen();}
return super.open(...arguments);},updateCallFocusStack(session){if(this.notEq(this.store.rtc?.channel)||session.eq(this.store.rtc.selfSession)||!this.activeRtcSession||!this.store.settings.useCallAutoFocus||this.activeRtcSession?.mainVideoStreamType==="screen"){return;}
this.focusStack.delete(session);if(session.isTalking&&!session.isMute){this.focusStack.push(session);}
const activeSession=this.focusStack.at(-1);if(!activeSession){return;}
this.activeRtcSession=activeSession;activeSession.mainVideoStreamType="camera";},};patch(Thread.prototype,ThreadPatch);return __exports;});;

/* /mail/static/src/discuss/call/common/tick_worker.js */
odoo.define('@mail/discuss/call/common/tick_worker',[],function(require){'use strict';let __exports={};let intervalId=null;let awaitingTock=false;let isRunning=false;function reset(){if(intervalId){clearInterval(intervalId);intervalId=null;}
awaitingTock=false;isRunning=false;}
function startProcessing(fps){if(isRunning){return;}
isRunning=true;intervalId=setInterval(()=>{if(awaitingTock){return;}
awaitingTock=true;self.postMessage({command:"tick"});},Math.floor(1000/(fps||30)));}
self.onmessage=(e)=>{if(!e.data?.command){return;}
const{command,fps}=e.data;switch(command){case"start":startProcessing(fps);break;case"tock":awaitingTock=false;break;case"stop":reset();break;default:break;}};self.onmessageerror=()=>{awaitingTock=false;};self.onerror=reset;return __exports;});;

/* /mail/static/src/discuss/core/common/action_panel.js */
odoo.define('@mail/discuss/core/common/action_panel',['@mail/utils/common/format','@odoo/owl','@web/core/resizable_panel/resizable_panel','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{attClassObjectToString}=require("@mail/utils/common/format");const{Component,useSubEnv}=require("@odoo/owl");const{ResizablePanel}=require("@web/core/resizable_panel/resizable_panel");const{useForwardRefToParent,useService}=require("@web/core/utils/hooks");const ActionPanel=__exports.ActionPanel=class ActionPanel extends Component{static template="mail.ActionPanel";static components={ResizablePanel};static props=["contentRef?","icon?","title?","resizable?","slots?","initialWidth?","minWidth?",];static defaultProps={contentPadding:true,resizable:true};setup(){super.setup();this.store=useService("mail.store");this.ui=useService("ui");useForwardRefToParent("contentRef");useSubEnv({inDiscussActionPanel:true});}
get classNames(){return attClassObjectToString({"o-mail-ActionPanel overflow-auto o-scrollbar-thin d-flex flex-column flex-shrink-0 position-relative py-2 pt-0 h-100 bg-inherit":true,"o-mail-ActionPanel-chatter":this.env.inChatter,"o-chatWindow":this.env.inChatWindow,"px-2":!this.env.inChatter&&!this.env.inMeetingChat,rounded:!this.props.resizable,});}
get minWidth(){return this.props.minWidth;}
get initialWidth(){return this.props.initialWidth;}}
return __exports;});;

/* /mail/static/src/discuss/core/common/attachment_model_patch.js */
odoo.define('@mail/discuss/core/common/attachment_model_patch',['@mail/core/common/attachment_model','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Attachment}=require("@mail/core/common/attachment_model");const{patch}=require("@web/core/utils/patch");const attachmentPatch={get isDeletable(){if(this.message&&this.thread?.model==="discuss.channel"){return this.message.editable;}
return super.isDeletable;},};patch(Attachment.prototype,attachmentPatch);return __exports;});;

/* /mail/static/src/discuss/core/common/attachment_panel.js */
odoo.define('@mail/discuss/core/common/attachment_panel',['@mail/core/common/date_section','@mail/discuss/core/common/action_panel','@mail/core/common/attachment_list','@odoo/owl','@web/core/utils/hooks','@mail/utils/common/hooks'],function(require){'use strict';let __exports={};const{DateSection}=require("@mail/core/common/date_section");const{ActionPanel}=require("@mail/discuss/core/common/action_panel");const{AttachmentList}=require("@mail/core/common/attachment_list");const{Component,onWillStart,onWillUpdateProps}=require("@odoo/owl");const{useService}=require("@web/core/utils/hooks");const{useSequential,useVisible}=require("@mail/utils/common/hooks");const AttachmentPanel=__exports.AttachmentPanel=class AttachmentPanel extends Component{static components={ActionPanel,AttachmentList,DateSection};static props=["thread"];static template="mail.AttachmentPanel";setup(){super.setup();this.sequential=useSequential();this.store=useService("mail.store");this.ormService=useService("orm");this.attachmentUploadService=useService("mail.attachment_upload");onWillStart(()=>{this.props.thread.fetchMoreAttachments();});onWillUpdateProps((nextProps)=>{if(nextProps.thread.notEq(this.props.thread)){nextProps.thread.fetchMoreAttachments();}});useVisible("load-older",(isVisible)=>{if(isVisible){this.props.thread.fetchMoreAttachments();}});}
get attachmentsByDate(){const attachmentsByDate={};for(const attachment of this.props.thread.attachments){const attachments=attachmentsByDate[attachment.monthYear]??[];attachments.push(attachment);attachmentsByDate[attachment.monthYear]=attachments;}
return attachmentsByDate;}}
return __exports;});;

/* /mail/static/src/discuss/core/common/avatar_stack.js */
odoo.define('@mail/discuss/core/common/avatar_stack',['@odoo/owl'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const AvatarStack=__exports.AvatarStack=class AvatarStack extends Component{static template="mail.AvatarStack";static props={containerClass:{type:String,optional:true},direction:{type:String,optional:true,validate:(d)=>["v","h"].includes(d)},avatarClass:{type:Function,optional:true},max:{type:Number,optional:true},onClick:{type:Function,optional:true},personas:Array,size:{type:Number,optional:true},slots:{optional:true},};static defaultProps={avatarClass:()=>"",onClick:()=>{},max:4,size:24,direction:"h",};getStyle(index){const styles=["box-sizing: content-box",`height: ${this.props.size}px`,"margin: 1px",`padding: 1.5px`,`width: ${this.props.size}px`,`z-index: ${this.props.personas.length - index}`,];if(index!==0){const marginDirection=this.props.direction==="v"?"top":"left";styles.push(`margin-${marginDirection}: -${this.props.size / 4.5}px`);}
return styles.join(";");}}
return __exports;});;

/* /mail/static/src/discuss/core/common/channel_commands.js */
odoo.define('@mail/discuss/core/common/channel_commands',['@web/core/l10n/translation','@web/core/registry'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{registry}=require("@web/core/registry");const commandRegistry=registry.category("discuss.channel_commands");commandRegistry.add("help",{help:_t("Show a helper message"),methodName:"execute_command_help",}).add("leave",{help:_t("Leave this channel"),methodName:"execute_command_leave",}).add("who",{channel_types:["channel","chat","group"],help:_t("List users in the current channel"),methodName:"execute_command_who",});return __exports;});;

/* /mail/static/src/discuss/core/common/channel_invitation.js */
odoo.define('@mail/discuss/core/common/channel_invitation',['@mail/core/common/im_status','@mail/discuss/core/common/action_panel','@odoo/owl','@mail/utils/common/hooks','@web/core/l10n/translation','@web/core/utils/hooks','@web/core/utils/timing'],function(require){'use strict';let __exports={};const{ImStatus}=require("@mail/core/common/im_status");const{ActionPanel}=require("@mail/discuss/core/common/action_panel");const{Component,onMounted,onWillStart,useEffect,useRef,useState}=require("@odoo/owl");const{useSequential}=require("@mail/utils/common/hooks");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{useService}=require("@web/core/utils/hooks");const{useDebounced}=require("@web/core/utils/timing");const ChannelInvitation=__exports.ChannelInvitation=class ChannelInvitation extends Component{static components={ImStatus,ActionPanel};static defaultProps={hasSizeConstraints:false};static props=["autofocus?","hasSizeConstraints?","thread?","close?","className?","state?",];static template="discuss.ChannelInvitation";setup(){super.setup();this.orm=useService("orm");this.store=useService("mail.store");this.rtc=useService("discuss.rtc");this.notification=useService("notification");this.suggestionService=useService("mail.suggestion");this.ui=useService("ui");this.inputRef=useRef("input");this.sequential=useSequential();this.state=useState({searchResultCount:0,searchStr:"",selectableEmails:[],selectablePartners:[],selectedEmails:[],selectedPartners:[],sentEmails:new Set(),});this.debouncedFetchPartnersToInvite=useDebounced(this.fetchPartnersToInvite.bind(this),250);onWillStart(()=>{if(this.store.self_partner){this.fetchPartnersToInvite();}});onMounted(()=>{if(this.store.self_partner&&this.props.thread){this.inputRef.el.focus();}});useEffect(()=>{if(this.props.autofocus){this.inputRef.el?.focus();}},()=>[this.props.autofocus]);}
get selectablePartners(){return this.props.state?.selectablePartners??this.state.selectablePartners;}
set selectablePartners(partners){if(this.props.state?.selectablePartners){this.props.state.selectablePartners=partners;}else{this.state.selectablePartners=partners;}}
get selectedPartners(){return this.props.state?.selectedPartners??this.state.selectedPartners;}
set selectedPartners(partners){if(this.props.state?.selectedPartners){this.props.state.selectedPartners=partners;}else{this.state.selectedPartners=partners;}}
get searchStr(){return this.props.state?.searchStr??this.state.searchStr;}
set searchStr(newSearchStr){if(this.props.state?.searchStr!==undefined){this.props.state.searchStr=newSearchStr;}else{this.state.searchStr=newSearchStr;}}
get showingResultNarrowText(){return _t("Showing %(result_count)s results out of %(total_count)s. Narrow your search to see more choices.",{result_count:this.selectablePartners.length,total_count:this.state.searchResultCount,});}
get searchPlaceholder(){if(this.props.thread?.allow_invite_by_email){return _t("Invite people or email");}
return _t("Search people to invite");}
async fetchPartnersToInvite(){const results=await this.sequential(()=>this.orm.call("res.partner","search_for_channel_invite",[this.searchStr,this.props.thread?.id??false,]));if(!results){return;}
this.store.insert(results.store_data);const selectablePartners=results.partner_ids.map((id)=>this.store["res.partner"].get(id));this.selectablePartners=this.suggestionService.sortPartnerSuggestions(selectablePartners,this.searchStr,this.props.thread);this.state.searchResultCount=results["count"];const selectableEmails=this.state.selectedEmails.filter((addr)=>addr.includes(this.searchStr));if(results.selectable_email){selectableEmails.push(results.selectable_email);}
if(results.email_already_sent){this.state.sentEmails.add(results.selectable_email);}
this.state.selectableEmails=[...new Set(selectableEmails)];}
onInput(){this.searchStr=this.inputRef.el.value;this.debouncedFetchPartnersToInvite();}
onClickSelectablePartner(partner){if(partner.in(this.selectedPartners)){const index=this.selectedPartners.indexOf(partner);if(index!==-1){this.selectedPartners.splice(index,1);}
return;}
this.selectedPartners.push(partner);}
onClickSelectableEmail(email){const index=this.state.selectedEmails.indexOf(email);if(index!==-1){this.state.selectedEmails.splice(index,1);return;}
this.state.selectedEmails.push(email);}
onClickSelectedPartner(partner){const index=this.selectedPartners.indexOf(partner);this.selectedPartners.splice(index,1);}
onClickSelectedEmail(email){const index=this.state.selectedEmails.indexOf(email);this.state.selectedEmails.splice(index,1);}
onFocusInvitationLinkInput(ev){ev.target.select();}
async onClickCopy(ev){let notification=_t("Invitation link copied!");let type="success";const clipboard=this.env.inDiscussCallView?.isPip?this.rtc.pipService.pipWindow?.navigator.clipboard:navigator.clipboard;try{await clipboard.writeText(this.props.thread.invitationLink);}catch{notification=_t("Invitation link copy failed (Permission denied?)!");type="danger";}
this.notification.add(notification,{type});}
async onClickInvite(){if(this.props.thread.channel_type==="chat"){const partnerIds=this.selectedPartners.map((partner)=>partner.id);if(this.props.thread.correspondent?.partner_id){partnerIds.unshift(this.props.thread.correspondent.partner_id.id);}
await this.store.startChat(partnerIds);this.props.close?.();return;}
const invitePromises=[];if(this.selectedPartners.length){invitePromises.push(this.orm.call("discuss.channel","add_members",[[this.props.thread.id]],{partner_ids:this.selectedPartners.map((partner)=>partner.id),invite_to_rtc_call:this.rtc.state.channel?.eq(this.props.thread),}));}
if(this.state.selectedEmails.length){invitePromises.push(this.orm.call("discuss.channel","invite_by_email",[this.props.thread.id],{emails:this.state.selectedEmails,}));}
await Promise.all(invitePromises);this.state.selectedEmails=[];this.state.selectedPartners=[];this.props.close?.();}
get invitationButtonText(){if(!this.props.thread){return"";}
if(this.props.thread.channel_type==="channel"){return _t("Invite");}else if(this.props.thread.channel_type==="group"){return _t("Invite to Group Chat");}else if(this.props.thread.channel_type==="chat"){if(this.props.thread.correspondent?.persona.eq(this.store.self)){if(this.selectedPartners.length===0){return _t("Invite");}
if(this.selectedPartners.length===1){const alreadyChat=Object.values(this.store.Thread.records).some((thread)=>thread.channel_type==="chat"&&thread.correspondent?.partner_id?.eq(this.selectedPartners[0]));if(alreadyChat){return _t("Go to conversation");}
return _t("Start a Conversation");}}
return _t("Create Group Chat");}
return _t("Invite");}}
return __exports;});;

/* /mail/static/src/discuss/core/common/channel_member_list.js */
odoo.define('@mail/discuss/core/common/channel_member_list',['@mail/core/common/im_status','@mail/discuss/core/common/action_panel','@odoo/owl','@web/core/l10n/translation','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{ImStatus}=require("@mail/core/common/im_status");const{ActionPanel}=require("@mail/discuss/core/common/action_panel");const{Component,onWillUpdateProps,onWillStart}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{useService}=require("@web/core/utils/hooks");const ChannelMemberList=__exports.ChannelMemberList=class ChannelMemberList extends Component{static components={ImStatus,ActionPanel};static props=["thread","openChannelInvitePanel","className?"];static template="discuss.ChannelMemberList";setup(){super.setup();this.store=useService("mail.store");onWillStart(()=>{if(this.props.thread.fetchMembersState==="not_fetched"){this.props.thread.fetchChannelMembers();}});onWillUpdateProps((nextProps)=>{if(nextProps.thread.fetchMembersState==="not_fetched"){nextProps.thread.fetchChannelMembers();}});}
get onlineSectionText(){return _t("Online - %(online_count)s",{online_count:this.props.thread.onlineMembers.length,});}
get offlineSectionText(){return _t("Offline - %(offline_count)s",{offline_count:this.props.thread.offlineMembers.length,});}
canOpenChatWith(member){if(this.store.inPublicPage){return false;}
if(member.guest_id){return false;}
return true;}
onClickAvatar(ev,member){if(!this.canOpenChatWith(member)){return;}
this.store.openChat({partnerId:member.partner_id.id});}}
return __exports;});;

/* /mail/static/src/discuss/core/common/channel_member_model.js */
odoo.define('@mail/discuss/core/common/channel_member_model',['@mail/core/common/store_service','@mail/core/common/record','@web/core/browser/browser','@web/core/l10n/dates','@web/core/user'],function(require){'use strict';let __exports={};const{Store}=require("@mail/core/common/store_service");const{fields,Record}=require("@mail/core/common/record");const{browser}=require("@web/core/browser/browser");const{deserializeDateTime}=require("@web/core/l10n/dates");const{user}=require("@web/core/user");const{DateTime}=luxon;const ChannelMember=__exports.ChannelMember=class ChannelMember extends Record{static _name="discuss.channel.member";static id="id";create_date;custom_channel_name;custom_notifications;id;is_pinned=fields.Attr(undefined,{compute(){return(!this.unpin_dt||(this.last_interest_dt&&this.last_interest_dt>=this.unpin_dt)||(this.channel_id?.last_interest_dt&&this.channel_id?.last_interest_dt>=this.unpin_dt));},onUpdate(){this.channel_id?.onPinStateUpdated();},});last_interest_dt=fields.Datetime();last_seen_dt=fields.Datetime();guest_id=fields.One("mail.guest");partner_id=fields.One("res.partner");get persona(){return this.partner_id||this.guest_id;}
channel_id=fields.One("Thread",{inverse:"channel_member_ids"});threadAsSelf=fields.One("Thread",{compute(){if(this.store.self?.eq(this.persona)){return this.channel_id;}},});fetched_message_id=fields.One("mail.message");seen_message_id=fields.One("mail.message");hideUnreadBanner=false;message_unread_counter=fields.Attr(0,{onUpdate(){if(this.message_unread_counter===0||!this.channel_id?.isDisplayed||this.channel_id?.scrollTop!=="bottom"||this.channel_id.markedAsUnread||!this.channel_id.isFocused){this.message_unread_counter_ui=this.message_unread_counter;}},});message_unread_counter_ui=0;message_unread_counter_bus_id=0;mute_until_dt=fields.Datetime();new_message_separator=fields.Attr(null,{onUpdate(){if(!this.channel_id?.isDisplayed){this.new_message_separator_ui=this.new_message_separator;}},});new_message_separator_ui=null;isTyping=false;is_typing_dt=fields.Datetime({onUpdate(){browser.clearTimeout(this.typingTimeoutId);if(!this.is_typing_dt||DateTime.now().diff(this.is_typing_dt).milliseconds>Store.OTHER_LONG_TYPING){this.isTyping=false;}
if(this.isTyping){this.typingTimeoutId=browser.setTimeout(()=>(this.isTyping=false),Store.OTHER_LONG_TYPING);}},});threadAsTyping=fields.One("Thread",{compute(){return this.isTyping?this.channel_id:undefined;},eager:true,onDelete(){browser.clearTimeout(this.typingTimeoutId);},});typingTimeoutId;unpin_dt=fields.Datetime();get name(){if(this.guest_id){return this.guest_id.name;}
return this.channel_id.getPersonaName(this.partner_id);}
get avatarUrl(){return this.partner_id?.avatarUrl||this.guest_id?.avatarUrl;}
get im_status(){return this.partner_id?.im_status||this.guest_id?.im_status;}
getLangName(){return this.persona.lang_name;}
get memberSince(){return this.create_date?deserializeDateTime(this.create_date):undefined;}
hasSeen(message){return this.persona.eq(message.author)||this.seen_message_id?.id>=message.id;}
get lastSeenDt(){return this.last_seen_dt?this.last_seen_dt.toLocaleString(DateTime.TIME_24_SIMPLE,{locale:user.lang,}):undefined;}}
ChannelMember.register();return __exports;});;

/* /mail/static/src/discuss/core/common/delete_thread_dialog.js */
odoo.define('@mail/discuss/core/common/delete_thread_dialog',['@mail/discuss/core/common/action_panel','@odoo/owl','@web/core/network/rpc','@web/core/l10n/translation','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{ActionPanel}=require("@mail/discuss/core/common/action_panel");const{Component}=require("@odoo/owl");const{rpc}=require("@web/core/network/rpc");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{useService}=require("@web/core/utils/hooks");const DeleteThreadDialog=__exports.DeleteThreadDialog=class DeleteThreadDialog extends Component{static components={ActionPanel};static props=["thread","close"];static template="discuss.DeleteThreadDialog";setup(){super.setup();this.store=useService("mail.store");}
async onConfirmation(){let toOpenThread;const threadName=this.props.thread.name;if(this.store.discuss?.thread?.eq(this.props.thread)||this.env.inChatWindow){toOpenThread=this.props.thread.parent_channel_id;}
await rpc("/discuss/channel/sub_channel/delete",{sub_channel_id:this.props.thread.id,});if(toOpenThread?.exists()){toOpenThread.open();}
this.props.close();this.env.services.notification.add(_t('Thread "%(thread_name)s" has been deleted',{thread_name:threadName}),{type:"info"});}}
return __exports;});;

/* /mail/static/src/discuss/core/common/discuss_core_common_service.js */
odoo.define('@mail/discuss/core/common/discuss_core_common_service',['@odoo/owl','@web/core/registry'],function(require){'use strict';let __exports={};const{markup,reactive}=require("@odoo/owl");const{registry}=require("@web/core/registry");const DiscussCoreCommon=__exports.DiscussCoreCommon=class DiscussCoreCommon{constructor(env,services){this.busService=services.bus_service;this.env=env;this.notificationService=services.notification;this.orm=services.orm;this.presence=services.presence;this.store=services["mail.store"];}
setup(){this.busService.subscribe("discuss.channel/delete",(payload,metadata)=>{const thread=this.store.Thread.insert({id:payload.id,model:"discuss.channel",});this._handleNotificationChannelDelete(thread,metadata);});this.busService.subscribe("discuss.channel/new_message",(payload,metadata)=>{this.store.insert(payload.data);this._handleNotificationNewMessage(payload,metadata);});this.busService.subscribe("discuss.channel/transient_message",(payload)=>{const{body,channel_id}=payload;const lastMessageId=this.store.getLastMessageId();const message=this.store["mail.message"].insert({author_id:this.store.odoobot,body:markup(body),id:lastMessageId+0.01,subtype_id:this.store.mt_note,is_transient:true,thread:{id:channel_id,model:"discuss.channel"},});message.thread.messages.push(message);message.thread.transientMessages.push(message);});this.busService.subscribe("discuss.channel.member/fetched",(payload)=>{const{channel_id,id,last_message_id,partner_id}=payload;this.store["discuss.channel.member"].insert({id,fetched_message_id:{id:last_message_id},partner_id:{id:partner_id},thread:{id:channel_id,model:"discuss.channel"},});});this.env.bus.addEventListener("mail.message/delete",({detail:{message,notifId}})=>{if(message.thread){const{self_member_id}=message.thread;if(message.id>self_member_id?.seen_message_id.id&&notifId>self_member_id.message_unread_counter_bus_id){self_member_id.message_unread_counter--;}}});}
async _handleNotificationChannelDelete(thread,metadata){await thread.closeChatWindow({force:true});thread.messages.splice(0,thread.messages.length);thread.delete();}
async _handleNotificationNewMessage(payload,{id:notifId}){const{data,id:channelId,silent,temporary_id}=payload;const channel=await this.store.Thread.getOrFetch({model:"discuss.channel",id:channelId,});if(!channel){return;}
const message=this.store["mail.message"].get(data["mail.message"][0]);if(!message){return;}
if(message.notIn(channel.messages)){if(!channel.loadNewer){channel.addOrReplaceMessage(message,this.store["mail.message"].get(temporary_id));}else if(channel.status==="loading"){channel.pendingNewMessages.push(message);}
if(message.isSelfAuthored){channel.onNewSelfMessage(message);}else{if(channel.isDisplayed&&channel.self_member_id?.new_message_separator_ui===0){channel.self_member_id.new_message_separator_ui=message.id;}
if(!channel.isDisplayed&&channel.self_member_id){channel.scrollUnread=true;}
if(notifId>channel.self_member_id?.message_unread_counter_bus_id&&!message.isNotification){channel.self_member_id.message_unread_counter++;}}}
if(channel.channel_type!=="channel"&&this.store.self_partner&&channel.self_member_id){channel.markAsFetched();}
if(!channel.loadNewer&&!message.isSelfAuthored&&channel.composer.isFocused&&this.store.self_partner&&channel.newestPersistentMessage?.eq(channel.newestMessage)&&!channel.markedAsUnread){channel.markAsRead();}
this.env.bus.trigger("discuss.channel/new_message",{channel,message,silent});const authorMember=channel.channel_member_ids.find((member)=>member.persona?.eq(message.author));if(authorMember){authorMember.seen_message_id=message;}}}
const discussCoreCommon=__exports.discussCoreCommon={dependencies:["bus_service","mail.out_of_focus","mail.store","notification","orm","presence",],start(env,services){const discussCoreCommon=reactive(new DiscussCoreCommon(env,services));discussCoreCommon.setup(env,services);return discussCoreCommon;},};registry.category("services").add("discuss.core.common",discussCoreCommon);return __exports;});;

/* /mail/static/src/discuss/core/common/discuss_notification_settings.js */
odoo.define('@mail/discuss/core/common/discuss_notification_settings',['@odoo/owl','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Component,useState}=require("@odoo/owl");const{useService}=require("@web/core/utils/hooks");const DiscussNotificationSettings=__exports.DiscussNotificationSettings=class DiscussNotificationSettings extends Component{static props={};static template="mail.DiscussNotificationSettings";setup(){this.store=useService("mail.store");this.state=useState({selectedDuration:false,});}
onChangeMessageSound(){this.store.settings.messageSound=!this.store.settings.messageSound;}}
return __exports;});;

/* /mail/static/src/discuss/core/common/discuss_notification_settings_client_action.js */
odoo.define('@mail/discuss/core/common/discuss_notification_settings_client_action',['@odoo/owl','@web/core/registry','@mail/discuss/core/common/discuss_notification_settings'],function(require){'use strict';let __exports={};const{Component,xml}=require("@odoo/owl");const{registry}=require("@web/core/registry");const{DiscussNotificationSettings}=require("@mail/discuss/core/common/discuss_notification_settings");const DiscussNotificationSettingsClientAction=__exports.DiscussNotificationSettingsClientAction=class DiscussNotificationSettingsClientAction extends Component{static components={DiscussNotificationSettings};static props=["*"];static template=xml`
        <div class="o-mail-DiscussNotificationSettingsClientAction mx-3 my-2">
            <DiscussNotificationSettings/>
        </div>
    `;}
registry.category("actions").add("mail.discuss_notification_settings_action",DiscussNotificationSettingsClientAction);return __exports;});;

/* /mail/static/src/discuss/core/common/mail_guest_model_patch.js */
odoo.define('@mail/discuss/core/common/mail_guest_model_patch',['@mail/core/common/mail_guest_model','@mail/core/common/record','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{MailGuest}=require("@mail/core/common/mail_guest_model");const{fields}=require("@mail/core/common/record");const{patch}=require("@web/core/utils/patch");const mailGuestPatch={setup(){super.setup();this.channelMembers=fields.Many("discuss.channel.member");},};patch(MailGuest.prototype,mailGuestPatch);return __exports;});;

/* /mail/static/src/discuss/core/common/message_actions.js */
odoo.define('@mail/discuss/core/common/message_actions',['@mail/core/common/message_actions','@odoo/owl','@web/core/l10n/translation','@web/core/network/rpc'],function(require){'use strict';let __exports={};const{registerMessageAction}=require("@mail/core/common/message_actions");const{toRaw}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{rpc}=require("@web/core/network/rpc");registerMessageAction("set-new-message-separator",{condition:({message,thread})=>thread&&thread.self_member_id&&thread.eq(message.thread)&&!message.hasNewMessageSeparator&&message.persistent,icon:"fa fa-eye-slash",name:_t("Mark as Unread"),onSelected:({message:msg})=>{const message=toRaw(msg);const selfMember=message.thread?.self_member_id;if(selfMember){selfMember.new_message_separator=message.id;selfMember.new_message_separator_ui=selfMember.new_message_separator;}
message.thread.markedAsUnread=true;rpc("/discuss/channel/set_new_message_separator",{channel_id:message.thread.id,message_id:message.id,});},sequence:70,});return __exports;});;

/* /mail/static/src/discuss/core/common/message_model_patch.js */
odoo.define('@mail/discuss/core/common/message_model_patch',['@mail/core/common/message_model','@mail/core/common/record','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Message}=require("@mail/core/common/message_model");const{fields}=require("@mail/core/common/record");const{patch}=require("@web/core/utils/patch");const messagePatch={setup(){super.setup();this.hasEveryoneSeen=fields.Attr(false,{compute(){return this.thread?.membersThatCanSeen.every((m)=>m.hasSeen(this));},});this.hasNewMessageSeparator=fields.Attr(false,{compute(){return this.thread?.self_member_id?.new_message_separator===this.id;},});this.hasSomeoneFetched=fields.Attr(false,{compute(){return this.thread?.channel_member_ids.some((m)=>m.persona.notEq(this.author)&&m.fetched_message_id?.id>=this.id);},});this.hasSomeoneSeen=fields.Attr(false,{compute(){return this.thread?.membersThatCanSeen.filter((member)=>member.persona.notEq(this.author)).some((m)=>m.hasSeen(this));},});this.isMessagePreviousToLastSelfMessageSeenByEveryone=fields.Attr(false,{compute(){if(!this.thread?.lastSelfMessageSeenByEveryone){return false;}
return this.id<this.thread.lastSelfMessageSeenByEveryone.id;},});this.mentionedChannelPromises=[];this.threadAsFirstUnread=fields.One("Thread",{inverse:"firstUnreadMessage"});},get channelMemberHaveSeen(){return this.thread.membersThatCanSeen.filter((m)=>m.hasSeen(this)&&m.persona.notEq(this.author));},async edit(body,attachments=[],{mentionedChannels=[],mentionedPartners=[],mentionedRoles=[]}={}){return await super.edit(body,attachments,{mentionedChannels,mentionedPartners,mentionedRoles,});},};patch(Message.prototype,messagePatch);return __exports;});;

/* /mail/static/src/discuss/core/common/message_patch.js */
odoo.define('@mail/discuss/core/common/message_patch',['@mail/core/common/message','@mail/discuss/core/common/message_seen_indicator','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Message}=require("@mail/core/common/message");const{MessageSeenIndicator}=require("@mail/discuss/core/common/message_seen_indicator");const{patch}=require("@web/core/utils/patch");Message.components={...Message.components,MessageSeenIndicator};const messagePatch={get showSeenIndicator(){return this.props.message.isSelfAuthored&&this.props.thread?.hasSeenFeature;},};patch(Message.prototype,messagePatch);return __exports;});;

/* /mail/static/src/discuss/core/common/message_seen_indicator.js */
odoo.define('@mail/discuss/core/common/message_seen_indicator',['@odoo/owl','@web/core/dialog/dialog','@web/core/l10n/translation','@web/core/utils/hooks','@web/core/browser/browser'],function(require){'use strict';let __exports={};const{Component,useExternalListener,useRef}=require("@odoo/owl");const{Dialog}=require("@web/core/dialog/dialog");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{useService}=require("@web/core/utils/hooks");const{browser}=require("@web/core/browser/browser");class MessageSeenIndicatorDialog extends Component{static components={Dialog};static template="mail.MessageSeenIndicatorDialog";static props=["message","close?"];setup(){super.setup();this.contentRef=useRef("content");useExternalListener(browser,"click",(ev)=>{if(!this.contentRef?.el.contains(ev.target)){this.props.close();}},true);}}
const MessageSeenIndicator=__exports.MessageSeenIndicator=class MessageSeenIndicator extends Component{static template="mail.MessageSeenIndicator";static props=["message","thread","className?"];setup(){super.setup();this.dialog=useService("dialog");}
get summary(){if(this.props.message.hasEveryoneSeen){if(this.props.thread.correspondent&&this.props.thread.channel_member_ids.length===2){return _t("Seen by %(user)s",{user:this.props.thread.correspondent.name});}
return _t("Seen by everyone");}
const seenMembers=this.props.message.channelMemberHaveSeen;const[user1,user2,user3]=seenMembers.map((member)=>member.name);switch(seenMembers.length){case 0:return _t("Sent");case 1:return _t("Seen by %(user)s",{user:user1});case 2:return _t("Seen by %(user1)s and %(user2)s",{user1,user2});case 3:return _t("Seen by %(user1)s, %(user2)s and %(user3)s",{user1,user2,user3});case 4:return _t("Seen by %(user1)s, %(user2)s, %(user3)s and 1 other",{user1,user2,user3,});default:return _t("Seen by %(user1)s, %(user2)s, %(user3)s and %(count)s others",{user1,user2,user3,count:seenMembers.length-3,});}}
openDialog(){if(this.props.message.channelMemberHaveSeen.length===0){return;}
this.dialog.add(MessageSeenIndicatorDialog,{message:this.props.message});}}
return __exports;});;

/* /mail/static/src/discuss/core/common/notification_settings.js */
odoo.define('@mail/discuss/core/common/notification_settings',['@odoo/owl','@mail/discuss/core/common/action_panel','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_item','@web/core/utils/hooks','@mail/discuss/core/common/discuss_notification_settings_client_action','@web/core/dialog/dialog'],function(require){'use strict';let __exports={};const{Component,xml}=require("@odoo/owl");const{ActionPanel}=require("@mail/discuss/core/common/action_panel");const{Dropdown}=require("@web/core/dropdown/dropdown");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{useService}=require("@web/core/utils/hooks");const{DiscussNotificationSettingsClientAction}=require("@mail/discuss/core/common/discuss_notification_settings_client_action");const{Dialog}=require("@web/core/dialog/dialog");class NotificationDialog extends Component{static props=["close?"];static components={Dialog,DiscussNotificationSettingsClientAction};static template=xml`
        <Dialog size="'md'" footer="false">
            <DiscussNotificationSettingsClientAction/>
        </Dialog>
    `;}
const NotificationSettings=__exports.NotificationSettings=class NotificationSettings extends Component{static components={ActionPanel,Dropdown,DropdownItem};static props=["hasSizeConstraints?","thread","close?","className?"];static template="discuss.NotificationSettings";setup(){this.store=useService("mail.store");this.dialog=useService("dialog");this.ui=useService("ui");}
setMute(minutes){this.store.settings.setMuteDuration(minutes,this.props.thread);this.props.close?.();}
onClickAllConversationsMuted(){this.dialog.add(NotificationDialog);}}
return __exports;});;

/* /mail/static/src/discuss/core/common/partner_compare.js */
odoo.define('@mail/discuss/core/common/partner_compare',['@mail/core/common/partner_compare'],function(require){'use strict';let __exports={};const{partnerCompareRegistry}=require("@mail/core/common/partner_compare");partnerCompareRegistry.add("discuss.recent-chats",(p1,p2,{env,context})=>{const recentChatPartnerIds=context.recentChatPartnerIds||env.services["mail.store"].getRecentChatPartnerIds();const recentChatIndex_p1=recentChatPartnerIds.findIndex((partnerId)=>partnerId===p1.id);const recentChatIndex_p2=recentChatPartnerIds.findIndex((partnerId)=>partnerId===p2.id);if(recentChatIndex_p1!==-1&&recentChatIndex_p2===-1){return-1;}else if(recentChatIndex_p1===-1&&recentChatIndex_p2!==-1){return 1;}else if(recentChatIndex_p1<recentChatIndex_p2){return-1;}else if(recentChatIndex_p1>recentChatIndex_p2){return 1;}},{sequence:25});partnerCompareRegistry.add("discuss.members",(p1,p2,{thread,context:{memberPartnerIds}})=>{if(thread?.model==="discuss.channel"){const isMember1=memberPartnerIds.has(p1.id);const isMember2=memberPartnerIds.has(p2.id);if(isMember1&&!isMember2){return-1;}
if(!isMember1&&isMember2){return 1;}}},{sequence:40});return __exports;});;

/* /mail/static/src/discuss/core/common/res_partner_model_patch.js */
odoo.define('@mail/discuss/core/common/res_partner_model_patch',['@mail/core/common/res_partner_model','@mail/core/common/record','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{ResPartner}=require("@mail/core/common/res_partner_model");const{fields}=require("@mail/core/common/record");const{patch}=require("@web/core/utils/patch");const resPartnerPatch={setup(){super.setup();this.channelMembers=fields.Many("discuss.channel.member");},};patch(ResPartner.prototype,resPartnerPatch);return __exports;});;

/* /mail/static/src/discuss/core/common/store_service_patch.js */
odoo.define('@mail/discuss/core/common/store_service_patch',['@mail/core/common/store_service','@mail/utils/common/misc','@web/core/utils/patch','@web/core/utils/timing'],function(require){'use strict';let __exports={};const{Store}=require("@mail/core/common/store_service");const{compareDatetime}=require("@mail/utils/common/misc");const{patch}=require("@web/core/utils/patch");const{debounce}=require("@web/core/utils/timing");const storeServicePatch={setup(){super.setup();this.channelIdsFetchingDeferred=new Map();this.channel_types_with_seen_infos=[];this.updateBusSubscription=debounce(()=>this.env.services.bus_service.forceUpdateChannels(),0);},get onlineMemberStatuses(){return["away","bot","busy","online"];},async createGroupChat({default_display_mode,partners_to,name}){const{channel}=await this.fetchStoreData("/discuss/create_group",{default_display_mode,partners_to,name},{readonly:false,requestData:true});await channel.open({focus:true});return channel;},async fetchChannel(channelId){const fetchParam=this.fetchParams.find(([name])=>name==="discuss.channel");if(fetchParam){const[,channelIds,dataRequest]=fetchParam;channelIds.push(channelId);await dataRequest._resultDef;}else{await this.fetchStoreData("discuss.channel",[channelId]);}},getRecentChatPartnerIds(){return Object.values(this.Thread.records).filter((thread)=>thread.channel_type==="chat"&&thread.correspondent?.partner_id).sort((a,b)=>compareDatetime(b.lastInterestDt,a.lastInterestDt)||b.id-a.id).map((thread)=>thread.correspondent.partner_id.id);},sortMembers(m1,m2){return m1.name?.localeCompare(m2.name)||m1.id-m2.id;},async startChat(partnerIds){const partners_to=[...new Set([this.self.id,...partnerIds])];if(partners_to.length===1){const chat=await this.joinChat(partners_to[0],true);chat.open({focus:true,bypassCompact:true});}else if(partners_to.length===2){const correspondentId=partners_to.find((partnerId)=>partnerId!==this.store.self.id);const chat=await this.joinChat(correspondentId,true);chat.open({focus:true,bypassCompact:true});}else{await this.createGroupChat({partners_to});}},};patch(Store.prototype,storeServicePatch);return __exports;});;

/* /mail/static/src/discuss/core/common/suggestion_service_patch.js */
odoo.define('@mail/discuss/core/common/suggestion_service_patch',['@mail/core/common/suggestion_service','@mail/utils/common/format','@web/core/registry','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{SuggestionService}=require("@mail/core/common/suggestion_service");const{cleanTerm}=require("@mail/utils/common/format");const{registry}=require("@web/core/registry");const{patch}=require("@web/core/utils/patch");const commandRegistry=registry.category("discuss.channel_commands");const suggestionServicePatch={getSupportedDelimiters(thread,env){const res=super.getSupportedDelimiters(...arguments);return thread?.model==="discuss.channel"?[...res,["/",0]]:res;},isSuggestionValid(partner,thread){if(thread?.model==="discuss.channel"&&partner.eq(this.store.odoobot)){return true;}
return super.isSuggestionValid(...arguments);},getPartnerSuggestions(thread){const isNonPublicChannel=thread&&(thread.channel_type==="group"||thread.channel_type==="chat"||(thread.channel_type==="channel"&&(thread.parent_channel_id||thread).group_public_id));if(isNonPublicChannel){const partnersById=new Map([...thread.channel_member_ids,...(thread.parent_channel_id?.channel_member_ids??[]),].filter((m)=>m.partner_id).map((m)=>[m.partner_id.id,m.partner_id]));if(thread.channel_type==="channel"){const group=(thread.parent_channel_id||thread).group_public_id;group.partners.forEach((partner)=>partnersById.set(partner.id,partner));}
return Array.from(partnersById.values());}else{return super.getPartnerSuggestions(...arguments);}},searchSuggestions({delimiter,term},{thread}={}){if(delimiter==="/"){return this.searchChannelCommand(cleanTerm(term),thread);}
return super.searchSuggestions(...arguments);},searchChannelCommand(cleanedSearchTerm,thread){if(!thread.model==="discuss.channel"){return;}
const commands=commandRegistry.getEntries().filter(([name,command])=>{if(!cleanTerm(name).includes(cleanedSearchTerm)){return false;}
if(command.channel_types){return command.channel_types.includes(thread.channel_type);}
return true;}).map(([name,command])=>({channel_types:command.channel_types,help:command.help,id:command.id,name,}));const sortFunc=(c1,c2)=>{if(c1.channel_types&&!c2.channel_types){return-1;}
if(!c1.channel_types&&c2.channel_types){return 1;}
const cleanedName1=cleanTerm(c1.name);const cleanedName2=cleanTerm(c2.name);if(cleanedName1.startsWith(cleanedSearchTerm)&&!cleanedName2.startsWith(cleanedSearchTerm)){return-1;}
if(!cleanedName1.startsWith(cleanedSearchTerm)&&cleanedName2.startsWith(cleanedSearchTerm)){return 1;}
if(cleanedName1<cleanedName2){return-1;}
if(cleanedName1>cleanedName2){return 1;}
return c1.id-c2.id;};return{type:"ChannelCommand",suggestions:commands.sort(sortFunc),};},sortPartnerSuggestionsContext(thread){return Object.assign(super.sortPartnerSuggestionsContext(),{recentChatPartnerIds:this.store.getRecentChatPartnerIds(),memberPartnerIds:new Set(thread?.channel_member_ids.filter((member)=>member.partner_id).map((member)=>member.partner_id.id)),});},};patch(SuggestionService.prototype,suggestionServicePatch);return __exports;});;

/* /mail/static/src/discuss/core/common/thread_actions.js */
odoo.define('@mail/discuss/core/common/thread_actions',['@mail/core/common/action','@mail/core/common/thread_actions','@mail/discuss/core/common/attachment_panel','@mail/discuss/core/common/channel_invitation','@mail/discuss/core/common/channel_member_list','@mail/discuss/core/common/delete_thread_dialog','@mail/discuss/core/common/notification_settings','@odoo/owl','@web/core/dialog/dialog','@web/core/l10n/translation','@web/core/popover/popover_hook'],function(require){'use strict';let __exports={};const{ACTION_TAGS}=require("@mail/core/common/action");const{registerThreadAction}=require("@mail/core/common/thread_actions");const{AttachmentPanel}=require("@mail/discuss/core/common/attachment_panel");const{ChannelInvitation}=require("@mail/discuss/core/common/channel_invitation");const{ChannelMemberList}=require("@mail/discuss/core/common/channel_member_list");const{DeleteThreadDialog}=require("@mail/discuss/core/common/delete_thread_dialog");const{NotificationSettings}=require("@mail/discuss/core/common/notification_settings");const{Component,xml}=require("@odoo/owl");const{Dialog}=require("@web/core/dialog/dialog");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{usePopover}=require("@web/core/popover/popover_hook");class ChannelActionDialog extends Component{static props=["title","contentComponent","contentProps","close?"];static components={Dialog};static template=xml`
        <Dialog size="'md'" title="props.title" footer="false" contentClass="'o-bg-body'" bodyClass="'p-1'">
            <t t-component="props.contentComponent" t-props="props.contentProps"/>
        </Dialog>
    `;}
registerThreadAction("notification-settings",{actionPanelComponent:NotificationSettings,condition:({owner,store,thread})=>thread?.model==="discuss.channel"&&store.self_partner&&(!owner.props.chatWindow||owner.props.chatWindow.isOpen),setup({owner}){if(!owner.props.chatWindow){this.popover=usePopover(NotificationSettings,{onClose:()=>this.close(),position:"bottom-end",fixedPosition:true,popoverClass:this.panelOuterClass,});}},open({owner,store,thread}){if(owner.isDiscussSidebarChannelActions||owner.env.inMeetingView){store.env.services.dialog?.add(ChannelActionDialog,{title:thread.name,contentComponent:NotificationSettings,contentProps:{thread},});}else{this.popover?.open(owner.root.el.querySelector(`[name="${this.id}"]`),{hasSizeConstraints:true,thread,});}},close:({action})=>action.popover?.close(),icon:({thread})=>thread.self_member_id?.mute_until_dt?"fa fa-fw text-danger fa-bell-slash":"fa fa-fw fa-bell",name:_t("Notification Settings"),panelOuterClass:"bg-100 border border-secondary",sequence:10,sequenceGroup:30,toggle:true,});registerThreadAction("attachments",{actionPanelComponent:AttachmentPanel,condition:({owner,thread})=>thread?.hasAttachmentPanel&&(!owner.props.chatWindow||owner.props.chatWindow.isOpen)&&!owner.isDiscussSidebarChannelActions,icon:"fa fa-fw fa-paperclip",name:_t("Attachments"),sequence:10,sequenceGroup:10,toggle:true,});registerThreadAction("invite-people",{actionPanelComponent:ChannelInvitation,actionPanelComponentProps:({action})=>({close:()=>action.close()}),close:({action})=>action.popover?.close(),condition:({owner,thread})=>thread?.model==="discuss.channel"&&(!owner.props.chatWindow||owner.props.chatWindow.isOpen),panelOuterClass:({owner})=>`o-discuss-ChannelInvitation ${
            owner.props.chatWindow ? "bg-inherit" : ""
        } bg-100 border border-secondary`,icon:"oi oi-fw oi-user-plus",name:_t("Invite People"),open({owner,store,thread}){if(owner.isDiscussSidebarChannelActions){store.env.services.dialog?.add(ChannelActionDialog,{title:thread.displayName,contentComponent:ChannelInvitation,contentProps:{autofocus:true,thread,close:()=>store.env.services.dialog.closeAll(),},});}else if(!owner.env.inMeetingView){this.popover?.open(owner.root.el.querySelector(`[name="${this.id}"]`),{hasSizeConstraints:true,thread,});}},sequence:({owner})=>(owner.isDiscussSidebarChannelActions?20:10),sequenceGroup:20,setup({owner}){if(!owner.props.chatWindow&&!owner.env.inMeetingView){this.popover=usePopover(ChannelInvitation,{onClose:()=>this.close(),popoverClass:this.panelOuterClass,});}},toggle:true,});registerThreadAction("member-list",{actionPanelComponent:ChannelMemberList,actionPanelComponentProps:({owner})=>({openChannelInvitePanel({keepPrevious}={}){owner.threadActions.actions.find(({id})=>id==="invite-people")?.open({keepPrevious});},}),condition:({owner,thread})=>thread?.hasMemberList&&(!owner.props.chatWindow||owner.props.chatWindow.isOpen)&&!owner.isDiscussSidebarChannelActions,panelOuterClass:"o-discuss-ChannelMemberList bg-inherit",icon:"oi oi-fw oi-users",name:_t("Members"),close:({action,nextActiveAction,owner,store})=>{if(action.condition&&owner.env.inDiscussApp&&store.discuss?.shouldDisableMemberPanelAutoOpenFromClose(nextActiveAction)){store.discuss.isMemberPanelOpenByDefault=false;}},open:({owner,store})=>{if(owner.env.inDiscussApp){store.discuss.isMemberPanelOpenByDefault=true;}},sequence:30,sequenceGroup:10,toggle:true,});registerThreadAction("mark-read",{condition:({owner,thread})=>thread?.self_member_id&&thread.self_member_id.message_unread_counter>0&&!thread.self_member_id.mute_until_dt&&owner.isDiscussSidebarChannelActions,open:({owner})=>owner.thread.markAsRead(),icon:"fa fa-fw fa-check",name:_t("Mark Read"),sequence:10,sequenceGroup:20,});registerThreadAction("delete-thread",{actionPanelComponent:DeleteThreadDialog,actionPanelComponentProps({action}){return{close:()=>action.close()};},condition({owner,store,thread}){return(thread?.parent_channel_id&&store.self.main_user_id?.eq(thread.create_uid)&&!owner.isDiscussContent);},panelOuterClass:"bg-100",icon:"fa fa-fw fa-trash",iconLarge:"fa fa-fw fa-lg fa-trash",name:_t("Delete Thread"),close:({action})=>action.popover?.close(),toggle:true,open:({action,owner,store,thread})=>{if(owner.isDiscussSidebarChannelActions){store.env.services.dialog?.add(ChannelActionDialog,{title:thread.name,contentComponent:DeleteThreadDialog,contentProps:{close:()=>store.env.services.dialog.closeAll(),thread,},});}},sequence:({owner})=>(owner.props.chatWindow?50:40),sequenceGroup:40,tags:[ACTION_TAGS.DANGER],});return __exports;});;

/* /mail/static/src/discuss/core/common/thread_compare_patch.js */
odoo.define('@mail/discuss/core/common/thread_compare_patch',['@mail/core/common/thread_compare','@mail/utils/common/misc'],function(require){'use strict';let __exports={};const{threadCompareRegistry}=require("@mail/core/common/thread_compare");const{compareDatetime}=require("@mail/utils/common/misc");threadCompareRegistry.add("mail.unread",(thread1,thread2)=>{const aUnread=thread1.self_member_id?.message_unread_counter;const bUnread=thread2.self_member_id?.message_unread_counter;if(aUnread>0&&bUnread===0){return-1;}
if(bUnread>0&&aUnread===0){return 1;}},{sequence:20});threadCompareRegistry.add("mail.last-interest",(thread1,thread2)=>{const aLastInterestDt=thread1.lastInterestDt;const bLastInterestDt=thread2.lastInterestDt;if(aLastInterestDt&&bLastInterestDt){const res=compareDatetime(bLastInterestDt,aLastInterestDt);if(res!==0){return res;}}},{sequence:30});return __exports;});;

/* /mail/static/src/discuss/core/common/thread_model_patch.js */
odoo.define('@mail/discuss/core/common/thread_model_patch',['@mail/core/common/record','@mail/core/common/thread_model','@mail/utils/common/hooks','@mail/utils/common/misc','@web/core/l10n/translation','@web/core/l10n/utils','@web/core/network/rpc','@web/core/registry','@web/core/utils/concurrency','@web/core/utils/html','@web/core/utils/patch','@web/core/utils/urls'],function(require){'use strict';let __exports={};const{fields}=require("@mail/core/common/record");const{Thread}=require("@mail/core/common/thread_model");const{useSequential}=require("@mail/utils/common/hooks");const{compareDatetime,effectWithCleanup,nearestGreaterThanOrEqual,}=require("@mail/utils/common/misc");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{formatList}=require("@web/core/l10n/utils");const{rpc}=require("@web/core/network/rpc");const{registry}=require("@web/core/registry");const{Deferred}=require("@web/core/utils/concurrency");const{createElementWithContent}=require("@web/core/utils/html");const{patch}=require("@web/core/utils/patch");const{imageUrl}=require("@web/core/utils/urls");const commandRegistry=registry.category("discuss.channel_commands");const threadStaticPatch={new(){const thread=super.new(...arguments);effectWithCleanup({effect(busChannel,busService){if(busService&&busChannel){busService.addChannel(busChannel);return()=>busService.deleteChannel(busChannel);}},dependencies:(thread)=>[thread.shouldSubscribeToBusChannel&&thread.busChannel,thread.store.env.services.bus_service,],reactiveTargets:[thread],});return thread;},async getOrFetch(data,fieldNames=[]){if(data.model!=="discuss.channel"||data.id<1){return super.getOrFetch(...arguments);}
const thread=this.store.Thread.get({id:data.id,model:data.model});if(thread?.fetchChannelInfoState==="fetched"){return Promise.resolve(thread);}
const fetchChannelInfoDeferred=this.store.channelIdsFetchingDeferred.get(data.id);if(fetchChannelInfoDeferred){return fetchChannelInfoDeferred;}
const def=new Deferred();this.store.channelIdsFetchingDeferred.set(data.id,def);this.store.fetchChannel(data.id).then(()=>{this.store.channelIdsFetchingDeferred.delete(data.id);const thread=this.store.Thread.get({id:data.id,model:data.model});if(thread?.exists()){thread.fetchChannelInfoState="fetched";def.resolve(thread);}else{def.resolve();}},()=>{this.store.channelIdsFetchingDeferred.delete(data.id);const thread=this.store.Thread.get({id:data.id,model:data.model});if(thread?.exists()){def.reject(thread);}else{def.reject();}});return def;},};patch(Thread,threadStaticPatch);const threadPatch={setup(){super.setup();this.channel_member_ids=fields.Many("discuss.channel.member",{inverse:"channel_id",onDelete:(r)=>r.delete(),sort:(m1,m2)=>m1.id-m2.id,});this.correspondent=fields.One("discuss.channel.member",{compute(){return this.computeCorrespondent();},});this.correspondentCountry=fields.One("res.country",{compute(){return this.correspondent?.persona?.country_id??this.country_id;},});this.default_display_mode=undefined;this.fetchChannelInfoDeferred=undefined;this.fetchChannelInfoState="not_fetched";this.group_ids=fields.Many("res.groups");this.hasOtherMembersTyping=fields.Attr(false,{compute(){return this.otherTypingMembers.length>0;},});this.hasSeenFeature=fields.Attr(false,{compute(){return this.store.channel_types_with_seen_infos.includes(this.channel_type);},});this.firstUnreadMessage=fields.One("mail.message",{compute(){if(!this.self_member_id){return null;}
const messages=this.messages.filter((m)=>!m.isNotification);const separator=this.self_member_id.new_message_separator_ui;if(separator===0&&!this.loadOlder){return messages[0];}
if(!separator||messages.length===0||messages.at(-1).id<separator){return null;}
let message=this.store["mail.message"].get({id:separator});if(!message||this.notEq(message.thread)){message=nearestGreaterThanOrEqual(messages,separator,(msg)=>msg.id);}
return message;},inverse:"threadAsFirstUnread",});this.invited_member_ids=fields.Many("discuss.channel.member");this.last_interest_dt=fields.Datetime();this.lastInterestDt=fields.Datetime({compute(){const selfMemberLastInterestDt=this.self_member_id?.last_interest_dt;const lastInterestDt=this.last_interest_dt;return compareDatetime(selfMemberLastInterestDt,lastInterestDt)>0?selfMemberLastInterestDt:lastInterestDt;},});this.lastMessageSeenByAllId=fields.Attr(undefined,{compute(){if(!this.hasSeenFeature){return;}
return this.channel_member_ids.reduce((lastMessageSeenByAllId,member)=>{if(member.notEq(this.selfMember)&&member.seen_message_id){return lastMessageSeenByAllId?Math.min(lastMessageSeenByAllId,member.seen_message_id.id):member.seen_message_id.id;}else{return lastMessageSeenByAllId;}},undefined);},});this.lastSelfMessageSeenByEveryone=fields.One("mail.message",{compute(){if(!this.lastMessageSeenByAllId){return false;}
let res;for(let i=this.persistentMessages.length-1;i>=0;i--){const message=this.persistentMessages[i];if(!message.isSelfAuthored){continue;}
if(message.id>this.lastMessageSeenByAllId){continue;}
res=message;break;}
return res;},});this.markReadSequential=useSequential();this.markedAsUnread=false;this.markingAsRead=false;this.member_count=undefined;this.name=undefined;this.channel_name_member_ids=fields.Many("discuss.channel.member");this.onlineMembers=fields.Many("discuss.channel.member",{compute(){return this.channel_member_ids.filter((member)=>this.store.onlineMemberStatuses.includes(member.im_status)).sort((m1,m2)=>this.store.sortMembers(m1,m2));},});this.offlineMembers=fields.Many("discuss.channel.member",{compute(){return this._computeOfflineMembers().sort((m1,m2)=>this.store.sortMembers(m1,m2));},});this.otherTypingMembers=fields.Many("discuss.channel.member",{compute(){return this.typingMembers.filter((member)=>!member.persona?.eq(this.store.self));},});this.self_member_id=fields.One("discuss.channel.member",{inverse:"threadAsSelf",});this.scrollUnread=true;this.toggleBusSubscription=fields.Attr(false,{compute(){return(this.model==="discuss.channel"&&this.self_member_id?.memberSince>=this.store.env.services.bus_service.startedAt);},onUpdate(){this.store.updateBusSubscription();},});this.typingMembers=fields.Many("discuss.channel.member",{inverse:"threadAsTyping"});},_computeOfflineMembers(){return this.channel_member_ids.filter((member)=>!this.store.onlineMemberStatuses.includes(member.im_status));},get allow_invite_by_email(){return(this.channel_type==="group"||(this.channel_type==="channel"&&!this.group_public_id));},get areAllMembersLoaded(){return this.member_count===this.channel_member_ids.length;},get avatarUrl(){if(this.channel_type==="channel"||this.channel_type==="group"){return imageUrl("discuss.channel",this.id,"avatar_128",{unique:this.avatar_cache_key,});}
if(this.channel_type==="chat"&&this.correspondent){return this.correspondent.avatarUrl;}
return super.avatarUrl;},get showCorrespondentCountry(){return false;},async checkReadAccess(){const res=await super.checkReadAccess();if(!res&&this.model==="discuss.channel"){return this.channel_type;}
return res;},computeCorrespondent(){if(["channel","group"].includes(this.channel_type)){return undefined;}
const correspondents=this.correspondents;if(correspondents.length===1){return correspondents[0];}
if(correspondents.length===0&&this.channel_member_ids.length===1){return this.channel_member_ids[0];}
return undefined;},get correspondents(){return this.channel_member_ids.filter(({persona})=>persona?.notEq(this.store.self));},get displayName(){if(this.supportsCustomChannelName&&this.self_member_id?.custom_channel_name){return this.self_member_id.custom_channel_name;}
if(this.channel_type==="chat"&&this.correspondent){return this.correspondent.name;}
if(this.channel_name_member_ids.length&&!this.name){const nameParts=this.channel_name_member_ids.sort((m1,m2)=>m1.id-m2.id).slice(0,3).map((member)=>member.name);if(this.member_count>3){const remaining=this.member_count-3;nameParts.push(remaining===1?_t("1 other"):_t("%s others",remaining));}
return formatList(nameParts);}
if(this.model==="discuss.channel"&&this.name){return this.name;}
return super.displayName;},async fetchChannelMembers(){if(this.fetchMembersState==="pending"){return;}
const previousState=this.fetchMembersState;this.fetchMembersState="pending";const known_member_ids=this.channel_member_ids.map((channelMember)=>channelMember.id);let data;try{data=await rpc("/discuss/channel/members",{channel_id:this.id,known_member_ids:known_member_ids,});}catch(e){this.fetchMembersState=previousState;throw e;}
this.fetchMembersState="fetched";this.store.insert(data);},async fetchMoreAttachments(limit=30){if(this.isLoadingAttachments||this.areAttachmentsLoaded){return;}
this.isLoadingAttachments=true;try{const data=await rpc("/discuss/channel/attachments",{before:Math.min(...this.attachments.map(({id})=>id)),channel_id:this.id,limit,});this.store.insert(data.store_data);if(data.count<limit){this.areAttachmentsLoaded=true;}}finally{this.isLoadingAttachments=false;}},get hasMemberList(){return["channel","group"].includes(this.channel_type);},get hasSelfAsMember(){return Boolean(this.self_member_id);},get importantCounter(){if(this.isChatChannel&&this.self_member_id?.message_unread_counter_ui){return this.self_member_id.message_unread_counter_ui;}
if(this.discussAppCategory?.id==="channels"){if(this.store.settings.channel_notifications==="no_notif"){return 0;}
if(this.store.settings.channel_notifications==="all"&&!this.self_member_id?.mute_until_dt){return this.self_member_id?.message_unread_counter_ui;}}
return super.importantCounter;},isDisplayedOnUpdate(){super.isDisplayedOnUpdate(...arguments);if(!this.self_member_id){return;}
if(!this.isDisplayed){this.self_member_id.new_message_separator_ui=this.self_member_id.new_message_separator;this.markedAsUnread=false;}},get isUnread(){return this.self_member_id?.message_unread_counter>0||super.isUnread;},markAsRead(){super.markAsRead(...arguments);if(!this.self_member_id){return;}
const newestPersistentMessage=this.newestPersistentOfAllMessage;if(!newestPersistentMessage){return;}
const alreadyReadBySelf=this.self_member_id.seen_message_id?.id>=newestPersistentMessage.id&&this.self_member_id.new_message_separator>newestPersistentMessage.id;if(alreadyReadBySelf){return;}
this.markReadSequential(async()=>{this.markingAsRead=true;return rpc("/discuss/channel/mark_as_read",{channel_id:this.id,last_message_id:newestPersistentMessage.id,},{silent:true}).catch((e)=>{if(e.code!==404){throw e;}});}).then(()=>(this.markingAsRead=false));},get membersThatCanSeen(){return this.channel_member_ids;},get needactionCounter(){return this.isChatChannel?this.self_member_id?.message_unread_counter??0:super.needactionCounter;},onNewSelfMessage(message){if(!this.self_member_id||message.id<this.self_member_id.seen_message_id?.id){return;}
this.self_member_id.seen_message_id=message;this.self_member_id.new_message_separator=message.id+1;this.self_member_id.new_message_separator_ui=this.self_member_id.new_message_separator;this.markedAsUnread=false;},open(options){if(this.model==="discuss.channel"){const res=this.openChannel();if(res){return res;}
this.openChatWindow(options);return true;}
return super.open(...arguments);},openChannel(){return false;},async post(body){const textContent=createElementWithContent("div",body).textContent.trim();if(this.model==="discuss.channel"&&textContent.startsWith("/")){const[firstWord]=textContent.substring(1).split(/\s/);const command=commandRegistry.get(firstWord,false);if(command&&(!command.channel_types||command.channel_types.includes(this.channel_type))){await this.executeCommand(command,textContent);return;}}
return super.post(...arguments);},get shouldSubscribeToBusChannel(){return Boolean(this.model==="discuss.channel"&&!this.isTransient&&!this.self_member_id&&(this.isLocallyPinned||this.chat_window?.isOpen));},get showUnreadBanner(){return this.self_member_id?.message_unread_counter_ui>0;},get unknownMembersCount(){return(this.member_count??0)-this.channel_member_ids.length;},};patch(Thread.prototype,threadPatch);return __exports;});;

/* /mail/static/src/discuss/core/common/thread_patch.js */
odoo.define('@mail/discuss/core/common/thread_patch',['@mail/core/common/thread','@odoo/owl','@web/core/l10n/translation','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Thread}=require("@mail/core/common/thread");const{useEffect,toRaw}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{patch}=require("@web/core/utils/patch");const threadPatch={setup(){super.setup(...arguments);useEffect((loadNewer,mountedAndLoaded)=>{if(loadNewer||!mountedAndLoaded||!this.props.thread.self_member_id||!this.scrollableRef.el){return;}
const el=this.scrollableRef.el;if(Math.abs(el.scrollTop+el.clientHeight-el.scrollHeight)<=1){this.props.thread.self_member_id.hideUnreadBanner=true;}},()=>[this.props.thread.loadNewer,this.state.mountedAndLoaded,this.state.scrollTop]);},applyScrollContextually(thread){if(thread.self_member_id&&thread.scrollUnread){if(thread.firstUnreadMessage){const messageEl=this.refByMessageId.get(thread.firstUnreadMessage.id)?.el;if(!messageEl){return;}
const messageCenter=messageEl.offsetTop-
this.scrollableRef.el.offsetHeight/2+
messageEl.offsetHeight/2;this.setScroll(messageCenter);}else{const scrollTop=this.props.order==="asc"?this.scrollableRef.el.scrollHeight-this.scrollableRef.el.clientHeight:0;this.setScroll(scrollTop);}
thread.scrollUnread=false;if(this.isAtBottom&&!thread.markedAsUnread&&thread.isFocused){thread.markAsRead();}}else{super.applyScrollContextually(...arguments);}},fetchMessages(){if(this.props.thread.self_member_id&&this.props.thread.scrollUnread){toRaw(this.props.thread).loadAround(this.props.thread.self_member_id.new_message_separator);}else{super.fetchMessages();}},get newMessageBannerText(){if(this.props.thread.self_member_id?.message_unread_counter>1){return _t("%s new messages",this.props.thread.self_member_id.message_unread_counter);}
return _t("1 new message");},async onClickUnreadMessagesBanner(){await this.props.thread.loadAround(this.props.thread.self_member_id.new_message_separator_ui);this.messageHighlight?.highlightMessage(this.props.thread.firstUnreadMessage,this.props.thread);},};patch(Thread.prototype,threadPatch);return __exports;});;

/* /mail/static/src/discuss/gif_picker/common/composer_actions_patch.js */
odoo.define('@mail/discuss/gif_picker/common/composer_actions_patch',['@mail/core/common/composer_actions','@web/core/l10n/translation','@web/core/utils/misc','@mail/discuss/gif_picker/common/gif_picker'],function(require){'use strict';let __exports={};const{registerComposerAction,pickerOnClick,pickerSetup,}=require("@mail/core/common/composer_actions");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{markEventHandled}=require("@web/core/utils/misc");const{useGifPicker}=require("@mail/discuss/gif_picker/common/gif_picker");registerComposerAction("add-gif",{condition:({composer,owner,store})=>(store.hasGifPickerFeature||store.self.main_user_id?.is_admin)&&!owner.env.inChatter&&!composer.message,isPicker:true,pickerName:_t("GIF"),icon:"oi oi-gif-picker",name:_t("Add GIFs"),onSelected({owner},ev){pickerOnClick(owner,this,ev);markEventHandled(ev,"Composer.onClickAddGif");},setup({owner}){pickerSetup(this,()=>useGifPicker(undefined,{onSelect:(gif)=>owner.sendGifMessage(gif),onClose:()=>owner.setActivePicker(null),},{arrow:false}));},sequence:({owner})=>(!owner.env.inDiscussApp?40:undefined),sequenceQuick:({owner})=>(owner.env.inDiscussApp?15:undefined),});return __exports;});;

/* /mail/static/src/discuss/gif_picker/common/composer_patch.js */
odoo.define('@mail/discuss/gif_picker/common/composer_patch',['@mail/core/common/composer','@web/core/utils/misc','@odoo/owl','@web/core/utils/hooks','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Composer}=require("@mail/core/common/composer");const{markEventHandled}=require("@web/core/utils/misc");const{markup,useRef}=require("@odoo/owl");const{useService}=require("@web/core/utils/hooks");const{patch}=require("@web/core/utils/patch");const composerPatch={setup(){this.gifButton=useRef("gif-button");super.setup();this.ui=useService("ui");},get pickerSettings(){const setting=super.pickerSettings;if(this.hasGifPicker){setting.pickers.gif=(gif)=>this.sendGifMessage(gif);if(this.hasGifPickerButton){setting.buttons.push(this.gifButton);}}
return setting;},get hasGifPicker(){return((this.store.hasGifPickerFeature||this.store.self.main_user_id?.is_admin)&&!this.env.inChatter&&!this.props.composer.message);},get hasGifPickerButton(){return this.hasGifPicker&&!this.ui.isSmall&&!this.env.inChatWindow;},onClickAddGif(ev){markEventHandled(ev,"Composer.onClickAddGif");},async sendGifMessage(gif){const href=encodeURI(gif.url);await this._sendMessage(markup`<a href="${href}" target="_blank" rel="noreferrer noopener">${gif.url}</a>`,{parentId:this.props.composer.replyToMessage?.id,});},};patch(Composer.prototype,composerPatch);return __exports;});;

/* /mail/static/src/discuss/gif_picker/common/gif_picker.js */
odoo.define('@mail/discuss/gif_picker/common/gif_picker',['@mail/core/common/gif','@mail/utils/common/hooks','@odoo/owl','@web/core/user','@web/core/utils/hooks','@web/core/utils/timing','@web/core/network/rpc','@web/core/emoji_picker/emoji_picker'],function(require){'use strict';let __exports={};const{Gif}=require("@mail/core/common/gif");const{useOnBottomScrolled,useSequential}=require("@mail/utils/common/hooks");const{Component,onWillStart,useState,useEffect}=require("@odoo/owl");const{user}=require("@web/core/user");const{useService,useAutofocus}=require("@web/core/utils/hooks");const{useDebounced}=require("@web/core/utils/timing");const{rpc}=require("@web/core/network/rpc");const{PICKER_PROPS,usePicker}=require("@web/core/emoji_picker/emoji_picker");__exports.useGifPicker=useGifPicker;function useGifPicker(...args){return usePicker(GifPicker,...args);}
const GifPicker=__exports.GifPicker=class GifPicker extends Component{static template="discuss.GifPicker";static props=PICKER_PROPS;static components={Gif};setup(){super.setup();this.orm=useService("orm");this.store=useService("mail.store");this.sequential=useSequential();this.inputRef=useAutofocus();useOnBottomScrolled("scroller",()=>{if(!this.state.showCategories){if(!this.showFavorite){this.search();}else{this.loadFavoritesDebounced(this.offset);}}},300);this.next="";this.showFavorite=false;this.offset=0;this.state=useState({favorites:{gifs:[],offset:0,},searchTerm:"",showCategories:true,categories:[],loadingGif:false,loadingError:false,evenGif:{gifs:new Map(),columnSize:0,},oddGif:{gifs:new Map(),columnSize:0,},focused:false,});this.loadFavoritesDebounced=useDebounced(this.loadFavorites,200);onWillStart(()=>{this.loadCategories();});if(this.store.self_partner){onWillStart(()=>{this.loadFavorites();});}
useEffect(()=>{if(this.props.state?.picker!==this.props.PICKERS?.GIF){return;}
this.clear();this.search();if(this.searchTerm){this.closeCategories();}else{this.openCategories();}},()=>[this.searchTerm,this.props.state?.picker]);}
get style(){return"";}
get searchTerm(){return this.props.state?this.props.state.searchTerm:this.state.searchTerm;}
set searchTerm(value){if(this.props.state){this.props.state.searchTerm=value;}else{this.state.searchTerm=value;}}
async loadCategories(){if(!this.store.hasGifPickerFeature){return;}
try{let{language,region}=new Intl.Locale(user.lang);if(!region&&language==="sr"){region="RS";}
const{tags}=await rpc("/discuss/gif/categories",{country:region,locale:`${language}_${region}`,},{silent:true});if(tags){this.state.categories=tags;}}catch{this.state.loadingError=true;}}
openCategories(){this.showFavorite=false;this.state.showCategories=true;this.searchTerm="";this.clear();}
closeCategories(){this.state.showCategories=false;}
async search(){if(!this.searchTerm){return;}
try{let{language,region}=new Intl.Locale(user.lang);if(!region&&language==="sr"){region="RS";}
const params={country:region,locale:`${language}_${region}`,search_term:this.searchTerm,};if(this.next){params.position=this.next;}
const res=await this.sequential(()=>{this.state.loadingGif=true;const res=rpc("/discuss/gif/search",params,{silent:true,});this.state.loadingGif=false;return res;});if(res){const{next,results}=res;this.next=next;for(const gif of results){this.pushGif(gif);}
this.state.loadingError=false;}}catch{this.state.loadingError=true;}}
pushGif(gif){if(this.state.evenGif.columnSize<=this.state.oddGif.columnSize){this.state.evenGif.gifs.set(gif.id,gif);this.state.evenGif.columnSize+=gif.media_formats.tinygif.dims[1];}else{this.state.oddGif.gifs.set(gif.id,gif);this.state.oddGif.columnSize+=gif.media_formats.tinygif.dims[1];}}
onClickGif(gif){this.props.onSelect(gif,true);this.props.close?.();}
clear(){this.state.evenGif.gifs.clear();this.state.evenGif.columnSize=0;this.state.oddGif.gifs.clear();this.state.oddGif.columnSize=0;}
async onClickCategory(category){this.clear();this.searchTerm=category.searchterm;this.inputRef.el?.focus();this.closeCategories();}
async onClickFavorite(gif){if(!this.isFavorite(gif)){this.state.favorites.gifs.push(gif);await this.orm.silent.create("discuss.gif.favorite",[{tenor_gif_id:gif.id}]);}else{const index=this.state.favorites.gifs.findIndex(({id})=>id===gif.id);if(index>=0){this.state.favorites.gifs.splice(index,1);}
await rpc("/discuss/gif/remove_favorite",{tenor_gif_id:gif.id},{silent:true});}}
async loadFavorites(){if(!this.store.hasGifPickerFeature){return;}
this.state.loadingGif=true;try{const[results]=await rpc("/discuss/gif/favorites",{offset:this.offset},{silent:true});this.offset+=20;this.state.favorites.gifs.push(...results);}catch{this.state.loadingError=true;}
this.state.loadingGif=false;}
isFavorite(gif){return this.state.favorites.gifs.map((favorite)=>favorite.id).includes(gif.id);}
onClickFavoritesCategory(){this.showFavorite=true;for(const gif of this.state.favorites.gifs){this.pushGif(gif);}
this.closeCategories();}}
return __exports;});;

/* /mail/static/src/discuss/gif_picker/common/store_service_patch.js */
odoo.define('@mail/discuss/gif_picker/common/store_service_patch',['@mail/core/common/store_service','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Store}=require("@mail/core/common/store_service");const{patch}=require("@web/core/utils/patch");const StorePatch={setup(){super.setup(...arguments);this.hasGifPickerFeature=false;},};patch(Store.prototype,StorePatch);return __exports;});;

/* /mail/static/src/discuss/message_pin/common/message_actions.js */
odoo.define('@mail/discuss/message_pin/common/message_actions',['@web/core/l10n/translation','@mail/core/common/message_actions'],function(require){'use strict';let __exports={};const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{registerMessageAction}=require("@mail/core/common/message_actions");registerMessageAction("pin",{condition:({store,thread})=>store.self_partner&&thread?.model==="discuss.channel",icon:"fa fa-thumb-tack",name:({message})=>(message.pinned_at?_t("Unpin"):_t("Pin")),onSelected:({message})=>message.pin(),sequence:65,});return __exports;});;

/* /mail/static/src/discuss/message_pin/common/message_model_patch.js */
odoo.define('@mail/discuss/message_pin/common/message_model_patch',['@web/core/utils/patch','@mail/core/common/message_model','@mail/core/common/record','@web/core/l10n/translation','@mail/core/common/message_confirm_dialog','@web/core/utils/concurrency'],function(require){'use strict';let __exports={};const{patch}=require("@web/core/utils/patch");const{Message}=require("@mail/core/common/message_model");const{fields}=require("@mail/core/common/record");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{MessageConfirmDialog}=require("@mail/core/common/message_confirm_dialog");const{Deferred}=require("@web/core/utils/concurrency");patch(Message.prototype,{setup(){super.setup();this.pinned_at=fields.Datetime();},pin(){if(this.pinned_at){return this.unpin();}
const def=new Deferred();this.store.env.services.dialog.add(MessageConfirmDialog,{confirmText:_t("Yeah, pin it!"),message:this,prompt:_t("You sure want this message pinned to %(conversation)s forever and ever?",{conversation:this.thread.prefix+this.thread.displayName,}),size:"md",title:_t("Pin It"),onConfirm:()=>{def.resolve(true);this.store.env.services.orm.call("discuss.channel","set_message_pin",[this.thread.id],{message_id:this.id,pinned:true});},},{onClose:()=>def.resolve(false)});return def;},unpin(){const def=new Deferred();this.store.env.services.dialog.add(MessageConfirmDialog,{confirmColor:"btn-danger",confirmText:_t("Yes, remove it please"),message:this,prompt:_t("Well, nothing lasts forever, but are you sure you want to unpin this message?"),size:"md",title:_t("Unpin Message"),onConfirm:()=>{def.resolve(true);this.store.env.services.orm.call("discuss.channel","set_message_pin",[this.thread.id],{message_id:this.id,pinned:false});},},{onClose:()=>def.resolve(false)});return def;},});return __exports;});;

/* /mail/static/src/discuss/message_pin/common/message_patch.js */
odoo.define('@mail/discuss/message_pin/common/message_patch',['@mail/core/common/message','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Message}=require("@mail/core/common/message");const{patch}=require("@web/core/utils/patch");patch(Message,{components:{...Message.components},});patch(Message.prototype,{get isAlignedRight(){return!this.env.messageCard&&super.isAlignedRight;},get shouldDisplayAuthorName(){if(this.env.messageCard){return true;}
return super.shouldDisplayAuthorName;},});return __exports;});;

/* /mail/static/src/discuss/message_pin/common/notification_message_patch.js */
odoo.define('@mail/discuss/message_pin/common/notification_message_patch',['@mail/core/common/notification_message','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{NotificationMessage}=require("@mail/core/common/notification_message");const{patch}=require("@web/core/utils/patch");patch(NotificationMessage.prototype,{async onClickNotificationMessage(ev){const{oeType}=ev.target.dataset;if(oeType==="pin-menu"){this.env.pinMenu?.open();}
await super.onClickNotificationMessage(...arguments);},});return __exports;});;

/* /mail/static/src/discuss/message_pin/common/pinned_messages_panel.js */
odoo.define('@mail/discuss/message_pin/common/pinned_messages_panel',['@mail/core/common/message_card_list','@mail/discuss/core/common/action_panel','@odoo/owl','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{MessageCardList}=require("@mail/core/common/message_card_list");const{ActionPanel}=require("@mail/discuss/core/common/action_panel");const{Component,onWillStart,onWillUpdateProps}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const PinnedMessagesPanel=__exports.PinnedMessagesPanel=class PinnedMessagesPanel extends Component{static components={MessageCardList,ActionPanel,};static props=["thread","className?"];static template="discuss.PinnedMessagesPanel";setup(){super.setup();onWillStart(()=>{this.props.thread.fetchPinnedMessages();});onWillUpdateProps((nextProps)=>{if(nextProps.thread.notEq(this.props.thread)){nextProps.thread.fetchPinnedMessages();}});}
get emptyText(){if(this.props.thread.channel_type==="channel"){return _t("This channel doesn't have any pinned messages.");}else{return _t("This conversation doesn't have any pinned messages.");}}}
return __exports;});;

/* /mail/static/src/discuss/message_pin/common/thread_actions.js */
odoo.define('@mail/discuss/message_pin/common/thread_actions',['@mail/core/common/thread_actions','@mail/discuss/message_pin/common/pinned_messages_panel','@odoo/owl','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{registerThreadAction}=require("@mail/core/common/thread_actions");const{PinnedMessagesPanel}=require("@mail/discuss/message_pin/common/pinned_messages_panel");const{useChildSubEnv}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);registerThreadAction("pinned-messages",{actionPanelComponent:PinnedMessagesPanel,condition:({owner,thread})=>thread?.model==="discuss.channel"&&(!owner.props.chatWindow||owner.props.chatWindow.isOpen)&&!owner.isDiscussSidebarChannelActions,panelOuterClass:"o-discuss-PinnedMessagesPanel bg-inherit",icon:"fa fa-fw fa-thumb-tack",name:({action})=>(action.isActive?_t("Hide Pinned Messages"):_t("Pinned Messages")),sequence:20,sequenceGroup:10,setup(){useChildSubEnv({pinMenu:{open:()=>this.open(),close:()=>{if(this.isActive){this.close();}},},});},toggle:true,});return __exports;});;

/* /mail/static/src/discuss/message_pin/common/thread_model_patch.js */
odoo.define('@mail/discuss/message_pin/common/thread_model_patch',['@web/core/utils/patch','@mail/core/common/record','@mail/core/common/thread_model','@web/core/network/rpc'],function(require){'use strict';let __exports={};const{patch}=require("@web/core/utils/patch");const{fields}=require("@mail/core/common/record");const{Thread}=require("@mail/core/common/thread_model");const{rpc}=require("@web/core/network/rpc");patch(Thread.prototype,{setup(){super.setup();this.pinnedMessagesState=undefined;this.pinnedMessages=fields.Many("mail.message",{compute(){return this.allMessages.filter((m)=>m.pinned_at);},sort:(m1,m2)=>{if(m1.pinned_at===m2.pinned_at){return m1.id-m2.id;}
return m1.pinned_at<m2.pinned_at?1:-1;},});},async fetchPinnedMessages(){if(this.model!=="discuss.channel"||["loaded","loading"].includes(this.pinnedMessagesState)){return;}
this.pinnedMessagesState="loading";let data;try{data=await rpc("/discuss/channel/pinned_messages",{channel_id:this.id,});}catch(e){this.pinnedMessagesState="error";throw e;}
this.store.insert(data);this.pinnedMessagesState="loaded";},});return __exports;});;

/* /mail/static/src/discuss/typing/common/composer_patch.js */
odoo.define('@mail/discuss/typing/common/composer_patch',['@mail/core/common/composer','@mail/discuss/typing/common/typing','@web/core/network/rpc','@odoo/owl','@web/core/browser/browser','@web/core/registry','@web/core/utils/patch','@web/core/utils/timing'],function(require){'use strict';let __exports={};const{Composer}=require("@mail/core/common/composer");const{Typing}=require("@mail/discuss/typing/common/typing");const{rpc}=require("@web/core/network/rpc");const{onWillDestroy}=require("@odoo/owl");const{browser}=require("@web/core/browser/browser");const{registry}=require("@web/core/registry");const{patch}=require("@web/core/utils/patch");const{useDebounced}=require("@web/core/utils/timing");const commandRegistry=registry.category("discuss.channel_commands");const SHORT_TYPING=__exports.SHORT_TYPING=5000;const LONG_TYPING=__exports.LONG_TYPING=50000;patch(Composer,{components:{...Composer.components,Typing},});patch(Composer.prototype,{setup(){super.setup();this.typingNotified=false;this.stopTypingDebounced=useDebounced(this.stopTyping.bind(this),SHORT_TYPING);onWillDestroy(()=>{this.stopTyping();});},notifyIsTyping(is_typing=true){if(this.thread?.model==="discuss.channel"&&this.thread.id>0){rpc("/discuss/channel/notify_typing",{channel_id:this.thread.id,is_typing,},{silent:true});}},onInput(ev){super.onInput(ev);this.detectTyping(ev);},detectTyping(){const value=this.props.composer.composerText;if(this.thread?.model==="discuss.channel"&&value.startsWith("/")){const[firstWord]=value.substring(1).split(/\s/);const command=commandRegistry.get(firstWord,false);if(value==="/"||this.hasSuggestions||(command&&(!command.channel_types||command.channel_types.includes(this.thread.channel_type)))){this.stopTyping();return;}}
if(!this.typingNotified&&value){this.typingNotified=true;this.notifyIsTyping();browser.setTimeout(()=>(this.typingNotified=false),LONG_TYPING);}
this.stopTypingDebounced();},async sendMessage(){await super.sendMessage();this.stopTyping();},stopTyping(){if(this.typingNotified){this.typingNotified=false;this.notifyIsTyping(false);}},addEmoji(str){const res=super.addEmoji(str);this.detectTyping();return res;},});return __exports;});;

/* /mail/static/src/discuss/typing/common/thread_icon_patch.js */
odoo.define('@mail/discuss/typing/common/thread_icon_patch',['@mail/core/common/thread_icon','@mail/discuss/typing/common/typing','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{ThreadIcon}=require("@mail/core/common/thread_icon");const{Typing}=require("@mail/discuss/typing/common/typing");const{patch}=require("@web/core/utils/patch");patch(ThreadIcon,{components:{...ThreadIcon.components,Typing},});return __exports;});;

/* /mail/static/src/discuss/typing/common/typing.js */
odoo.define('@mail/discuss/typing/common/typing',['@odoo/owl','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const Typing=__exports.Typing=class Typing extends Component{static defaultProps={size:"small",displayText:true,};static props=["channel?","size?","displayText?","member?"];static template="discuss.Typing";get text(){const typingMemberNames=this.props.member?[this.props.member.name]:this.props.channel.otherTypingMembers.map(({name})=>name);if(typingMemberNames.length===1){return _t("%s is typing...",typingMemberNames[0]);}
if(typingMemberNames.length===2){return _t("%(user1)s and %(user2)s are typing...",{user1:typingMemberNames[0],user2:typingMemberNames[1],});}
return _t("%(user1)s, %(user2)s and more are typing...",{user1:typingMemberNames[0],user2:typingMemberNames[1],});}}
return __exports;});;

/* /mail/static/src/discuss/voice_message/common/attachment_list_patch.js */
odoo.define('@mail/discuss/voice_message/common/attachment_list_patch',['@mail/core/common/attachment_list','@mail/discuss/voice_message/common/voice_player','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{AttachmentList}=require("@mail/core/common/attachment_list");const{VoicePlayer}=require("@mail/discuss/voice_message/common/voice_player");const{patch}=require("@web/core/utils/patch");patch(AttachmentList,{components:{...AttachmentList.components,VoicePlayer},});return __exports;});;

/* /mail/static/src/discuss/voice_message/common/attachment_model_patch.js */
odoo.define('@mail/discuss/voice_message/common/attachment_model_patch',['@mail/core/common/attachment_model','@mail/core/common/record','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Attachment}=require("@mail/core/common/attachment_model");const{fields}=require("@mail/core/common/record");const{patch}=require("@web/core/utils/patch");const attachmentPatch={setup(){this.voice_ids=fields.Many("discuss.voice.metadata");},get isViewable(){return!this.voice&&super.isViewable;},delete(){if(this.voice&&this.id>0){this.store.env.services["discuss.voice_message"].activePlayer=null;}
super.delete(...arguments);},onClickAttachment(attachment){if(!attachment.voice){super.onClickAttachment(attachment);}},get voice(){return this.voice_ids.length>0;},};patch(Attachment.prototype,attachmentPatch);return __exports;});;

/* /mail/static/src/discuss/voice_message/common/attachment_uploader_hook_patch.js */
odoo.define('@mail/discuss/voice_message/common/attachment_uploader_hook_patch',['@mail/core/common/attachment_upload_service','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{AttachmentUploadService}=require("@mail/core/common/attachment_upload_service");const{patch}=require("@web/core/utils/patch");patch(AttachmentUploadService.prototype,{_makeAttachmentData(upload,tmpId,thread,tmpUrl){const attachmentData=super._makeAttachmentData(...arguments);if(upload.data.get("voice")){attachmentData.voice_ids=[this.store["discuss.voice.metadata"].insert({id:-1})];}
return attachmentData;},_buildFormData(formData,tmpURL,thread,composer,tmpId,options){super._buildFormData(...arguments);if(options?.voice){formData.append("voice",true);}
return formData;},});return __exports;});;

/* /mail/static/src/discuss/voice_message/common/composer_actions_patch.js */
odoo.define('@mail/discuss/voice_message/common/composer_actions_patch',['@mail/core/common/composer_actions','@odoo/owl','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{registerComposerAction}=require("@mail/core/common/composer_actions");const{Component,xml}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);registerComposerAction("voice-start",{condition:({composer,owner})=>composer.targetThread?.model==="discuss.channel"&&owner.voiceRecorder&&!owner.voiceRecorder?.recording&&!composer.voiceAttachment,icon:"fa fa-microphone",name:_t("Voice Message"),onSelected:({owner})=>owner.voiceRecorder.onClick(),sequence:10,});registerComposerAction("voice-stop",{condition:({composer,owner})=>composer.targetThread?.model==="discuss.channel"&&owner.voiceRecorder?.recording,icon:"fa fa-circle text-danger o-mail-VoiceRecorder-dot",name:_t("Stop Recording"),onSelected:({owner})=>owner.voiceRecorder.onClick(),sequence:10,});registerComposerAction("voice-recording",{component:class VoiceMessageRecordingButton extends Component{static props=["composer","state"];static template=xml`
            <button class="o-mail-VoiceRecorder d-flex align-items-center btn border-0 o-recording rounded-start-0 rounded-end user-select-none p-0" t-att-title="title" t-att-disabled="props.state.isActionPending or props.composer.voiceAttachment" t-on-click="props.state.onClick">
                <div class="o-mail-VoiceRecorder-elapsed o-active recording ms-2 me-1" t-att-class="{ 'text-danger': props.state.limitWarning }" style="font-variant-numeric: tabular-nums;">
                    <span class="d-flex text-truncate" t-esc="props.state.elapsed"/>
                </div>
                <span class="rounded-circle p-1"><i class="fa fa-fw fa-circle text-danger o-mail-VoiceRecorder-dot"/></span>
            </button>
        `;get title(){return _t("Stop Recording");}},componentProps:({composer,owner})=>({composer,state:owner.voiceRecorder}),condition:({composer,owner})=>composer.targetThread?.model==="discuss.channel"&&owner.voiceRecorder?.recording,sequenceQuick:10,});return __exports;});;

/* /mail/static/src/discuss/voice_message/common/composer_model_patch.js */
odoo.define('@mail/discuss/voice_message/common/composer_model_patch',['@mail/core/common/composer_model','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Composer}=require("@mail/core/common/composer_model");const{patch}=require("@web/core/utils/patch");patch(Composer.prototype,{get voiceAttachment(){return this.attachments.find((attachment)=>attachment.voice);},});return __exports;});;

/* /mail/static/src/discuss/voice_message/common/composer_patch.js */
odoo.define('@mail/discuss/voice_message/common/composer_patch',['@mail/core/common/composer','@web/core/utils/patch','@mail/discuss/voice_message/common/voice_recorder'],function(require){'use strict';let __exports={};const{Composer}=require("@mail/core/common/composer");const{patch}=require("@web/core/utils/patch");const{useVoiceRecorder}=require("@mail/discuss/voice_message/common/voice_recorder");patch(Composer,{components:{...Composer.components},});patch(Composer.prototype,{setup(){super.setup();this.voiceRecorder=useVoiceRecorder();},get isSendButtonDisabled(){return this.voiceRecording?.recording||super.isSendButtonDisabled;},onKeydown(ev){if(ev.key==="Enter"&&this.voiceRecording?.recording){ev.preventDefault();return;}
return super.onKeydown(ev);},});return __exports;});;

/* /mail/static/src/discuss/voice_message/common/mp3_encoder.js */
odoo.define('@mail/discuss/voice_message/common/mp3_encoder',[],function(require){'use strict';let __exports={};const MAX_SAMPLES=1152;const Mp3Encoder=__exports.Mp3Encoder=class Mp3Encoder{config;encoding;mp3Encoder;samplesMono;constructor(config={}){this.config={sampleRate:44100,bitRate:128,};Object.assign(this.config,config);this.mp3Encoder=new lamejs.Mp3Encoder(1,this.config.sampleRate,this.config.bitRate);this.samplesMono=null;this.clearBuffer();}
clearBuffer(){this.dataBuffer=[];}
appendToBuffer(buffer){this.dataBuffer.push(new Int8Array(buffer));}
floatTo16BitPCM(input,output){for(let i=0;i<input.length;i++){const s=Math.max(-1,Math.min(1,input[i]));output[i]=s<0?s*0x8000:s*0x7fff;}}
convertBuffer(arrayBuffer){const data=new Float32Array(arrayBuffer);const out=new Int16Array(arrayBuffer.length);this.floatTo16BitPCM(data,out);return out;}
encode(arrayBuffer){this.encoding=true;this.samplesMono=this.convertBuffer(arrayBuffer);let remaining=this.samplesMono.length;for(let i=0;remaining>=0;i+=MAX_SAMPLES){const left=this.samplesMono.subarray(i,i+MAX_SAMPLES);const mp3buffer=this.mp3Encoder.encodeBuffer(left);this.appendToBuffer(mp3buffer);remaining-=MAX_SAMPLES;}}
finish(){if(this.encoding){this.appendToBuffer(this.mp3Encoder.flush());return this.dataBuffer;}else{return[];}}}
return __exports;});;

/* /mail/static/src/discuss/voice_message/common/voice_message_service.js */
odoo.define('@mail/discuss/voice_message/common/voice_message_service',['@web/core/assets','@web/core/registry','@web/core/utils/functions'],function(require){'use strict';let __exports={};const{loadBundle}=require("@web/core/assets");const{registry}=require("@web/core/registry");const{memoize}=require("@web/core/utils/functions");const loader={loadLamejs:memoize(()=>loadBundle("mail.assets_lamejs")),};__exports.loadLamejs=loadLamejs;async function loadLamejs(){try{await loader.loadLamejs();}catch{}}
const VoiceMessageService=__exports.VoiceMessageService=class VoiceMessageService{constructor(env){this.activePlayer=null;}}
const voiceMessageService=__exports.voiceMessageService={start(env){return new VoiceMessageService(env);},};registry.category("services").add("discuss.voice_message",voiceMessageService);return __exports;});;

/* /mail/static/src/discuss/voice_message/common/voice_metadata_model.js */
odoo.define('@mail/discuss/voice_message/common/voice_metadata_model',['@mail/model/misc','@mail/model/record'],function(require){'use strict';let __exports={};const{fields}=require("@mail/model/misc");const{Record}=require("@mail/model/record");const VoiceMetadata=__exports.VoiceMetadata=class VoiceMetadata extends Record{static _name="discuss.voice.metadata";static id="id";attachment_id=fields.One("ir.attachment",{inverse:"voice_ids"});}
VoiceMetadata.register();return __exports;});;

/* /mail/static/src/discuss/voice_message/common/voice_player.js */
odoo.define('@mail/discuss/voice_message/common/voice_player',['@odoo/owl','@web/core/browser/browser','@web/core/utils/hooks','@web/core/utils/urls'],function(require){'use strict';let __exports={};const{Component,useState,onMounted,onWillUnmount,useEffect,useRef,status,}=require("@odoo/owl");const{browser}=require("@web/core/browser/browser");const{useService}=require("@web/core/utils/hooks");const{url}=require("@web/core/utils/urls");const WAVE_COLOR="#7775";const VoicePlayer=__exports.VoicePlayer=class VoicePlayer extends Component{static props=["attachment"];static template="mail.VoicePlayer";lastPlaytime=0;lastPos=0;startPosition=0;progressColor;gainNode;audioCtx;scheduledPause;buffer;analyser;source;width;height;wrapper;progressWave;waveCtx;progressCtx;setup(){super.setup();this.wrapperRef=useRef("wrapper");this.drawerRef=useRef("drawer");this.waveRef=useRef("wave");this.progressRef=useRef("progress");this.voiceMessageService=useService("discuss.voice_message");this.state=useState({paused:true,playing:false,repeat:false,visualTime:"-- : --",});useEffect((playing)=>{if(playing){this.addOnAudioProcess();}},()=>[this.state.playing]);useEffect((uploading)=>{if(uploading){return;}
if(this.wasUploading&&!uploading){this.makeAudio();}
this.wasUploading=uploading;},()=>[this.props.attachment.uploading]);onMounted(()=>{this.initElements();this.wrapper.addEventListener("click",(e)=>{if(this.props.attachment.uploading){return;}
const clientX=(e.targetTouches?e.targetTouches[0]:e).clientX;const bcr=this.wrapper.getBoundingClientRect();const progressPixels=clientX-bcr.left;const progress=Math.min(Math.max(0,progressPixels/this.wrapper.scrollWidth),1);this.seekTo(progress);});if(!this.props.attachment.uploading){this.makeAudio();}
this.wasUploading=this.props.attachment.uploading;});onWillUnmount(()=>{if(this.state.playing){this.pause();}
this.destroyWebAudio();});}
makeAudio(){this.audioCtx=new browser.AudioContext();this.gainNode=this.audioCtx.createGain();this.gainNode.connect(this.audioCtx.destination);this.analyser=this.audioCtx.createAnalyser();this.analyser.connect(this.gainNode);this.fetchFile(url(this.props.attachment.urlRoute,{...this.props.attachment.urlQueryParams,})).then((arrayBuffer)=>this.drawBuffer(arrayBuffer));}
_fetch(...args){return fetch(...args);}
async fetchFile(url){const response=await this._fetch(url);if(!response.ok){throw new Error("HTTP error status: "+response.status);}
const arrayBuffer=await response.arrayBuffer();return arrayBuffer;}
getPlayedTime(){return this.audioCtx.currentTime-this.lastPlaytime;}
getCurrentTime(){if(this.state.paused){return this.startPosition;}else{return this.startPosition+this.getPlayedTime();}}
play(){if(this.voiceMessageService.activePlayer){this.voiceMessageService.activePlayer.pause();}
this.voiceMessageService.activePlayer=this;this.state.repeat=false;this.createSource();const{start,end}=this.seekToElapsed();this.scheduledPause=end;this.source.start(0,start);this.state.playing=true;this.state.paused=false;}
pause(options){this.voiceMessageService.activePlayer=null;if(options?.end){this.state.repeat=true;}
this.scheduledPause=null;this.startPosition+=this.getPlayedTime();if(this.source){try{this.source.stop();}catch(e){if(e.name==="InvalidStateError"){return;}
throw e;}}
if(!options?.continue){this.state.paused=true;this.state.playing=false;}}
getPeaks(){const peaks=[];const sampleSize=this.buffer.length/this.width;const sampleStep=Math.floor(sampleSize/10);const chan=this.buffer.getChannelData(0);let i;for(i=0;i<this.width;i++){const start=Math.floor(i*sampleSize);const end=Math.floor(start+sampleSize);let min=chan[start];let max=min;let j;for(j=start;j<end;j+=sampleStep){const value=chan[j];if(value>max){max=value;}
if(value<min){min=value;}}
peaks[i]=max;}
return peaks;}
createSource(){this.source?.disconnect();this.source=this.audioCtx.createBufferSource();this.source.buffer=this.buffer;this.source.connect(this.analyser);}
seekToElapsed(start,end){this.scheduledPause=null;if(start===undefined){start=this.getCurrentTime();if(start>=this.buffer.duration){start=0;}}
if(end===undefined){end=this.buffer.duration;}
this.startPosition=start;this.lastPlaytime=this.audioCtx.currentTime;return{start,end};}
onProgress(progress){const position=Math.round(progress*this.width);if(position<this.lastPos||position-this.lastPos>=1){this.lastPos=position;this.progressWave.style.width=position+"px";}}
seekTo(progress){if(this.state.playing){this.pause({continue:true});}
this.state.repeat=false;const elapsedTime=progress*this.buffer.duration;this.state.visualTime=this.generateTime(Math.floor(elapsedTime));this.seekToElapsed(elapsedTime);this.onProgress(progress);if(this.state.playing){this.play();}}
async drawBuffer(arrayBuffer){const buffer=await this.audioCtx.decodeAudioData(arrayBuffer);this.state.visualTime=this.generateTime(Math.floor(buffer.duration));this.startPosition=0;this.lastPlaytime=this.audioCtx.currentTime;this.buffer=buffer;this.createSource();this.drawWave(this.getPeaks());}
async destroyWebAudio(){this.source?.disconnect();this.gainNode?.disconnect();this.analyser?.disconnect();try{await this.audioCtx?.close();}catch(e){if(e.name==="InvalidStateError"){return;}
throw e;}}
addOnAudioProcess(){if(status(this)==="destroyed"){return;}
const time=this.getCurrentTime();if(time>=this.scheduledPause&&this.state.playing){this.pause({end:true});}else if(this.state.playing){this.state.visualTime=this.generateTime(Math.floor(time));const playedPercents=this.getCurrentTime()/this.buffer.duration;this.onProgress(playedPercents);requestAnimationFrame(()=>this.addOnAudioProcess());}}
generateTime(timeInSecond){const second=timeInSecond%60;const minute=Math.floor(timeInSecond/60);return((minute<10?"0"+minute:minute)+" : "+(second<10?"0"+second:second));}
initElements(){this.wrapper=this.wrapperRef.el;this.progressWave=this.drawerRef.el;this.progressColor=getComputedStyle(this.wrapper).getPropertyValue("--primary");this.width=this.wrapper.clientWidth;this.height=this.wrapper.clientHeight;const wave=this.waveRef.el;wave.width=this.width;wave.height=this.height;this.waveCtx=wave.getContext("2d");this.waveCtx.fillStyle=WAVE_COLOR;const progress=this.progressRef.el;progress.width=this.width;progress.height=this.height;this.progressCtx=progress.getContext("2d");this.progressCtx.fillStyle=this.progressColor;}
drawWave(peaks){return requestAnimationFrame(()=>{this.drawLines(peaks);this.fillRect(0,this.height/2,this.width,0.5);});}
fillRect(x,y,width,height){const intersection={x1:x,y1:y,x2:x+width,y2:y+height,};if(intersection.x1<intersection.x2){this.fillRects(intersection.x1,intersection.y1,intersection.x2-intersection.x1,intersection.y2-intersection.y1);}}
fillRects(x,y,width,height){this.waveCtx.fillRect(x,y,width,height);this.progressCtx.fillRect(x,y,width,height);}
drawLines(peaks){this.drawLineToContext(this.waveCtx,peaks);this.drawLineToContext(this.progressCtx,peaks);}
drawLineToContext(ctx,peaks){const maxPeak=Math.max(...peaks);let i,peak;for(i=0;i<=peaks.length;i++){peak=peaks[i];const h=(peak*this.height)/maxPeak;ctx.fillRect(i,(this.height-h)/2,1.5,h);}}
onClickPlayPause(){if(this.props.attachment.uploading){return;}
if(this.state.paused){this.play();}else{this.pause();}}}
return __exports;});;

/* /mail/static/src/discuss/voice_message/common/voice_recorder.js */
odoo.define('@mail/discuss/voice_message/common/voice_recorder',['@odoo/owl','@web/core/utils/hooks','@web/core/l10n/translation','@web/core/browser/browser','@mail/discuss/voice_message/common/mp3_encoder','@mail/discuss/voice_message/common/voice_message_service'],function(require){'use strict';let __exports={};const{useState,onWillUnmount,status,useComponent}=require("@odoo/owl");const{useService}=require("@web/core/utils/hooks");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{browser}=require("@web/core/browser/browser");const{Mp3Encoder}=require("@mail/discuss/voice_message/common/mp3_encoder");const{loadLamejs}=require("@mail/discuss/voice_message/common/voice_message_service");const patchable=__exports.patchable={makeFile(file){return file;},};__exports.useVoiceRecorder=useVoiceRecorder;function useVoiceRecorder(){let microphone;let startTimeStamp;let audioContext;let streamSource;let processor;let encoder;const component=useComponent();const state=useState({limitWarning:false,isActionPending:false,recording:component.props.state?.recording??false,elapsed:"00 : 00",onClick(){if(state.recording){stopRecording();}else{startRecording();}},});const notification=useService("notification");const store=useService("mail.store");const config={bitRate:128};onWillUnmount(()=>{if(state.recording){notification.add(_t("Voice recording stopped"),{type:"warning"});stopRecording();}else{cleanUp();}});function filename(){return("Voice-"+
new Date().toISOString().split("T")[0]+"-"+
Math.floor(Math.random()*100000)+".mp3");}
async function startRecording(){if(state.isActionPending){return;}
state.isActionPending=true;if(!microphone){try{microphone=await browser.navigator.mediaDevices.getUserMedia({audio:store.settings.audioConstraints,});if(status(component)==="destroyed"){cleanUp();return;}}catch{notification.add(_t('"%(hostname)s" needs to access your microphone',{hostname:window.location.host,}),{type:"warning"});state.isActionPending=false;return;}}
state.elapsed="00 : 00";state.recording=true;audioContext=new browser.AudioContext();await loadLamejs();await audioContext.audioWorklet.addModule("/discuss/voice/worklet_processor");processor=new browser.AudioWorkletNode(audioContext,"processor");processor.port.onmessage=(e)=>{if(state.recording&&!startTimeStamp){startTimeStamp=e.timeStamp;}
if(!startTimeStamp){return;}
const elapsedSeconds=Math.floor((e.timeStamp-startTimeStamp)/1000);const second=elapsedSeconds%60;const minute=Math.floor(elapsedSeconds/60);state.elapsed=(minute<10?"0"+minute:minute)+" : "+
(second<10?"0"+second:second);if(elapsedSeconds>55&&elapsedSeconds<60){state.limitWarning=true;}
if(elapsedSeconds===60){notification.add(_t("The duration of voice messages is limited to 1 minute."),{type:"warning",});stopRecording();}
if(!e.data){return;}
_encode(e.data);};streamSource=audioContext.createMediaStreamSource(microphone);streamSource.connect(processor);processor.connect(audioContext.destination);config.sampleRate=audioContext.sampleRate;encoder=new Mp3Encoder(config);state.isActionPending=false;}
function _encode(data){encoder.encode(data);}
function _getEncoderBuffer(){return encoder.finish();}
function _makeFile(buffer,type){return patchable.makeFile(new File(buffer,filename(),{type}));}
function stopRecording(){getMp3().then((buffer)=>{const file=_makeFile(buffer,"audio/mp3");if(file.size===0){return;}
component.attachmentUploader.uploadFile(file,{voice:true});}).catch(()=>{});cleanUp();}
function cleanUp(){if(processor&&streamSource){streamSource.disconnect();processor.disconnect();if(audioContext&&audioContext.state!=="closed"){audioContext.close();}}
startTimeStamp=false;microphone?.getTracks().forEach((track)=>track.stop());microphone=null;state.recording=false;state.limitWarning=false;}
function getMp3(){const finalBuffer=_getEncoderBuffer();return new Promise((resolve,reject)=>{if(finalBuffer.length===0){reject(new Error("No buffer to send"));}else{resolve(finalBuffer);encoder.clearBuffer();}});}
return state;}
return __exports;});;

/* /mail/static/src/utils/common/dates.js */
odoo.define('@mail/utils/common/dates',[],function(require){'use strict';let __exports={};const{DateTime}=luxon;__exports.computeDelay=computeDelay;function computeDelay(datetime){if(!datetime){return 0;}
const today=DateTime.now().startOf("day");return datetime.diff(today,"days").days;}
__exports.getMsToTomorrow=getMsToTomorrow;function getMsToTomorrow(){const now=new Date();const night=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1,0,0,0);return night.getTime()-now.getTime();}
__exports.isToday=isToday;function isToday(datetime){if(!datetime){return false;}
return(datetime.toLocaleString(DateTime.DATE_FULL)===DateTime.now().toLocaleString(DateTime.DATE_FULL));}
return __exports;});;

/* /mail/static/src/utils/common/format.js */
odoo.define('@mail/utils/common/format',['@odoo/owl','@web/core/browser/router','@web/core/emoji_picker/emoji_picker','@web/core/l10n/utils','@web/core/utils/html','@web/core/utils/strings','@web/core/utils/urls','@web/core/utils/xml'],function(require){'use strict';let __exports={};const{htmlEscape,markup}=require("@odoo/owl");const{router}=require("@web/core/browser/router");const{loadEmoji,loader}=require("@web/core/emoji_picker/emoji_picker");const{normalize}=require("@web/core/l10n/utils");const{createDocumentFragmentFromContent,createElementWithContent,htmlFormatList,htmlJoin,htmlReplace,htmlReplaceAll,htmlTrim,setElementContent,}=require("@web/core/utils/html");const{escapeRegExp}=require("@web/core/utils/strings");const{getOrigin}=require("@web/core/utils/urls");const{setAttributes}=require("@web/core/utils/xml");const urlRegexp=/\b(?:https?:\/\/\d{1,3}(?:\.\d{1,3}){3}|(?:https?:\/\/|(?:www\.))[-a-z0-9@:%._+~#=\u00C0-\u024F\u1E00-\u1EFF]{1,256}\.[a-z]{2,13})\b(?:[-a-z0-9@:%_+~#?&[\]^|{}`\\'$//=\u00C0-\u024F\u1E00-\u1EFF]|[.]*[-a-z0-9@:%_+~#?&[\]^|{}`\\'$//=\u00C0-\u024F\u1E00-\u1EFF]|,(?!$| )|\.(?!$| |\.)|;(?!$| ))*/gi;const messageUrlRegExp=new RegExp(`^${escapeRegExp(getOrigin())}/mail/message/(\\d+)$`);__exports.prettifyMessageText=prettifyMessageText;function prettifyMessageText(rawBody,{validMentions={},thread}={}){if(rawBody instanceof markup().constructor){return rawBody;}
let body=htmlTrim(rawBody);body=htmlReplace(body,/(\r|\n){2,}/g,()=>markup`<br/><br/>`);body=htmlReplace(body,/(\r|\n)/g,()=>markup`<br/>`);body=htmlReplace(body,/&nbsp;/g,()=>" ");body=htmlTrim(body);body=generateMentionsLinks(body,{...validMentions,thread});body=parseAndTransform(body,addLink);return body;}
__exports.generateEmojisOnHtml=generateEmojisOnHtml;async function generateEmojisOnHtml(htmlBody,{allowEmojiLoading=true}={}){let body=htmlBody;if(allowEmojiLoading||odoo.loader.modules.get("@web/core/emoji_picker/emoji_data")){body=await _generateEmojisOnHtml(body);}
return body;}
__exports.prettifyMessageContent=prettifyMessageContent;async function prettifyMessageContent(rawBody,{validMentions=[],allowEmojiLoading=true}={}){let body=prettifyMessageText(rawBody,{validMentions});body=await generateEmojisOnHtml(body,{allowEmojiLoading});return body;}
__exports.parseAndTransform=parseAndTransform;function parseAndTransform(htmlString,transformFunction){const div=document.createElement("div");try{setElementContent(div,htmlString);}catch{div.appendChild(createElementWithContent("pre",htmlString));}
return _parseAndTransform(Array.from(div.childNodes),transformFunction);}
function _parseAndTransform(nodes,transformFunction){if(!nodes){return;}
return htmlJoin(Object.values(nodes).map((node)=>transformFunction(node,function(){return _parseAndTransform(node.childNodes,transformFunction);})));}
function linkify(text){let curIndex=0;let result="";let match;while((match=urlRegexp.exec(text))!==null){result=htmlJoin([result,text.slice(curIndex,match.index)]);const inputUrl=decodeURI(match[0]);const url=!/^https?:\/\//i.test(inputUrl)?"http://"+inputUrl:inputUrl;const link=document.createElement("a");setAttributes(link,{target:"_blank",rel:"noreferrer noopener",href:encodeURI(url),});link.textContent=inputUrl;const messageMatch=messageUrlRegExp.exec(url);if(messageMatch!==null){setAttributes(link,{"data-oe-id":messageMatch[1],"data-oe-model":"mail.message",});link.classList.add("o_message_redirect");}
result=htmlJoin([result,markup(link.outerHTML)]);curIndex=match.index+match[0].length;}
return htmlJoin([result,text.slice(curIndex)]);}
__exports.addLink=addLink;function addLink(node,transformChildren){if(node.nodeType===3){const linkified=linkify(node.textContent);if(linkified.toString()!==node.textContent){const div=createElementWithContent("div",linkified);for(const childNode of[...div.childNodes]){node.parentNode.insertBefore(childNode,node);}
node.parentNode.removeChild(node);return linkified;}
return node.textContent;}
if(node.tagName==="A"){return markup(node.outerHTML);}
transformChildren();return markup(node.outerHTML);}
function generateMentionElement({className,id,model,text}){const link=document.createElement("a");setAttributes(link,{href:router.stateToUrl({model:model,resId:id}),class:className,"data-oe-id":id,"data-oe-model":model,"data-oe-protected":"true",target:"_blank",contenteditable:"false",});link.textContent=text;return link;}
__exports.generatePartnerMentionElement=generatePartnerMentionElement;function generatePartnerMentionElement(partner,thread){return generateMentionElement({className:"o_mail_redirect",id:partner.id,model:"res.partner",text:`@${thread?.getPersonaName(partner) ?? partner.name}`,});}
__exports.generateRoleMentionElement=generateRoleMentionElement;function generateRoleMentionElement(role){return generateMentionElement({className:"o-discuss-mention",id:role.id,model:"res.role",text:`@${role.name}`,});}
__exports.generateSpecialMentionElement=generateSpecialMentionElement;function generateSpecialMentionElement(label){const link=document.createElement("a");setAttributes(link,{class:"o-discuss-mention","data-oe-protected":"true",contenteditable:"false",});link.textContent=`@${label}`;return link;}
__exports.generateThreadMentionElement=generateThreadMentionElement;function generateThreadMentionElement(thread){return generateMentionElement({className:`o_channel_redirect${
            thread.parent_channel_id ? " o_channel_redirect_asThread" : ""
        }`,id:thread.id,model:"discuss.channel",text:`#${thread.fullNameWithParent}`,});}
function generateMentionsLinks(body,{partners=[],roles=[],threads=[],specialMentions=[],thread}){const mentions=[];for(const partner of partners){const placeholder=`@-mention-partner-${partner.id}`;const text=`@${thread?.getPersonaName(partner) ?? partner.name}`;mentions.push({link:generatePartnerMentionElement(partner,thread),placeholder,});body=htmlReplace(body,text,placeholder);}
for(const thread of threads){const placeholder=`#-mention-channel-${thread.id}`;const text=`#${thread.fullNameWithParent}`;mentions.push({link:generateThreadMentionElement(thread),placeholder,});body=htmlReplace(body,text,placeholder);}
for(const special of specialMentions){const text=`@${special}`;const placeholder=`@-mention-special-${special}`;mentions.push({link:generateSpecialMentionElement(special),placeholder,});body=htmlReplace(body,text,placeholder);}
for(const role of roles){const placeholder=`@-mention-role-${role.id}`;const text=`@${role.name}`;mentions.push({link:generateRoleMentionElement(role),placeholder,});body=htmlReplace(body,text,placeholder);}
for(const mention of mentions){const link=mention.link;body=htmlReplace(body,mention.placeholder,markup(link.outerHTML));}
return htmlEscape(body);}
async function _generateEmojisOnHtml(htmlString){const{emojis}=await loadEmoji();for(const emoji of emojis){for(const source of[...emoji.shortcodes,...emoji.emoticons]){const escapedSource=htmlEscape(String(source));const regexp=new RegExp("(\\s|^)("+escapeRegExp(escapedSource)+")(?=\\s|$|<)","g");htmlString=htmlReplace(htmlString,regexp,(_,group1)=>group1+emoji.codepoints);}}
return htmlEscape(htmlString);}
__exports.getNonEditableMentions=getNonEditableMentions;function getNonEditableMentions(body){const doc=createDocumentFragmentFromContent(body);for(const block of doc.body.querySelectorAll(".o_mail_reply_hide")){block.classList.remove("o_mail_reply_hide");}
for(const mention of doc.body.querySelectorAll(".o_mail_redirect")){mention.setAttribute("contenteditable",false);}
for(const mention of doc.body.querySelectorAll(".o_channel_redirect")){mention.setAttribute("contenteditable",false);}
for(const mention of doc.body.querySelectorAll(".o-discuss-mention")){mention.setAttribute("contenteditable",false);}
return markup(doc.body.innerHTML);}
__exports.htmlToTextContentInline=htmlToTextContentInline;function htmlToTextContentInline(htmlString){htmlString=htmlReplace(htmlString,/<br\s*\/?>/gi,()=>" ");const div=document.createElement("div");try{setElementContent(div,htmlString);}catch{div.appendChild(createElementWithContent("pre",htmlString));}
return div.textContent.trim().replace(/[\n\r]/g,"").replace(/\s\s+/g," ");}
__exports.convertBrToLineBreak=convertBrToLineBreak;function convertBrToLineBreak(str){str=htmlReplace(str,/<br\s*\/?>/gi,()=>"\n");return createDocumentFragmentFromContent(str).body.textContent;}
__exports.cleanTerm=cleanTerm;function cleanTerm(term){return typeof term==="string"?normalize(term):"";}
__exports.parseEmail=parseEmail;function parseEmail(text){if(!text){return;}
let result=text.match(/"?(.*?)"? <(.*@.*)>/);if(result){const name=(result[1]||"").trim().replace(/(^"|"$)/g,"");return[name,(result[2]||"").trim()];}
result=text.match(/(.*@.*)/);if(result){return[String(result[1]||"").trim(),String(result[1]||"").trim()];}
return[text,false];}
const EMOJI_REGEX=__exports.EMOJI_REGEX=/\p{Emoji_Presentation}|\p{Emoji}\uFE0F|\u200d/gu;__exports.decorateEmojis=decorateEmojis;function decorateEmojis(content){if(!loader.loaded||!content){return content;}
const doc=createDocumentFragmentFromContent(content);const nodes=doc.evaluate(".//text()",doc.body,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null);for(let i=0;i<nodes.snapshotLength;i++){const node=nodes.snapshotItem(i);const span=document.createElement("span");setElementContent(span,htmlReplaceAll(node.textContent,loader.loaded.emojiRegex,(codepoints)=>markup(`<span class="o-mail-emoji" title="${htmlFormatList(
                        loader.loaded.emojiValueToShortcodes[codepoints],
                        { style: "unit-narrow" }
                    )}">${htmlEscape(codepoints)}</span>`)));node.replaceWith(...span.childNodes);}
return markup(doc.body.innerHTML);}
__exports.attClassObjectToString=attClassObjectToString;function attClassObjectToString(obj){return Object.entries(obj).filter(([_,val])=>val).map(([key,_])=>key).join(" ");}
return __exports;});;

/* /mail/static/src/utils/common/hooks.js */
odoo.define('@mail/utils/common/hooks',['@odoo/owl','@mail/utils/common/media_monitoring','@web/core/browser/browser','@web/core/overlay/overlay_container','@web/core/utils/concurrency','@web/core/utils/draggable_hook_builder_owl','@web/core/l10n/translation','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Component,onMounted,onPatched,onWillUnmount,toRaw,useComponent,useEffect,useRef,useState,useSubEnv,xml,}=require("@odoo/owl");const{monitorAudio}=require("@mail/utils/common/media_monitoring");const{browser}=require("@web/core/browser/browser");const{OVERLAY_SYMBOL}=require("@web/core/overlay/overlay_container");const{Deferred}=require("@web/core/utils/concurrency");const{makeDraggableHook}=require("@web/core/utils/draggable_hook_builder_owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{useService}=require("@web/core/utils/hooks");__exports.useLazyExternalListener=useLazyExternalListener;function useLazyExternalListener(target,eventName,handler,eventParams){const boundHandler=handler.bind(useComponent());let t;onMounted(()=>{t=target();if(!t){return;}
t.addEventListener(eventName,boundHandler,eventParams);});onPatched(()=>{const t2=target();if(t!==t2){if(t){t.removeEventListener(eventName,boundHandler,eventParams);}
if(t2){t2.addEventListener(eventName,boundHandler,eventParams);}
t=t2;}});onWillUnmount(()=>{if(!t){return;}
t.removeEventListener(eventName,boundHandler,eventParams);});}
__exports.onExternalClick=onExternalClick;function onExternalClick(refName,cb){let downTarget,upTarget;const ref=useRef(refName);function onClick(ev){if(ref.el&&!ref.el.contains(ev.composedPath()[0])){cb(ev,{downTarget,upTarget});upTarget=downTarget=null;}}
function onMousedown(ev){downTarget=ev.target;}
function onMouseup(ev){upTarget=ev.target;}
onMounted(()=>{document.body.addEventListener("mousedown",onMousedown,true);document.body.addEventListener("mouseup",onMouseup,true);document.body.addEventListener("click",onClick,true);});onWillUnmount(()=>{document.body.removeEventListener("mousedown",onMousedown,true);document.body.removeEventListener("mouseup",onMouseup,true);document.body.removeEventListener("click",onClick,true);});}
__exports.useHover=useHover;function useHover(refNames,{onHover,onAway,stateObserver,onHovering}={}){refNames=Array.isArray(refNames)?refNames:[refNames];const targets=[];let wasHovering=false;let hoveringTimeout;let awayTimeout;let lastHoveredTarget;for(const refName of refNames){if(typeof refName==="function"){targets.push({ref:refName});continue;}
targets.push({ref:useRef(refName)});}
const state=useState({set isHover(newIsHover){if(this._isHover!==newIsHover){this._isHover=newIsHover;this._count++;}},get isHover(){void this._count;return this._isHover;},_contains:[],_count:0,_isHover:false,_targets:targets,addTarget(target){state._targets.push(target);const handleMouseenter=(ev)=>onmouseenter(ev);const handleMouseleave=(ev)=>onmouseleave(ev);target.ref.el.addEventListener("mouseenter",handleMouseenter,true);target.ref.el.addEventListener("mouseleave",handleMouseleave,true);return()=>{target.ref.el.removeEventListener("mouseenter",handleMouseenter,true);target.ref.el.removeEventListener("mouseleave",handleMouseleave,true);const idx=state._targets.findIndex((t)=>t===target);if(idx){state._targets.splice(idx,1);}};},});function setHover(hovering){if(hovering&&!wasHovering){state.isHover=true;clearTimeout(awayTimeout);clearTimeout(hoveringTimeout);if(typeof onHover==="function"){onHover();}
if(Array.isArray(onHovering)){const[delay,cb]=onHovering;hoveringTimeout=setTimeout(()=>{cb();},delay);}}else if(!hovering){state.isHover=false;clearTimeout(awayTimeout);if(typeof onAway==="function"){awayTimeout=setTimeout(()=>{clearTimeout(hoveringTimeout);onAway();},100);}}
wasHovering=hovering;}
function onmouseenter(ev){if(state.isHover){return;}
for(const target of toRaw(state)._targets){if(!target.ref.el){continue;}
if(target.ref.el.contains(ev.target)){setHover(true);lastHoveredTarget=target;return;}}
for(const contains of state._contains){if(contains(ev.target)){setHover(true);return;}}}
function onmouseleave(ev){if(!state.isHover){return;}
for(const target of toRaw(state._targets)){if(!target.ref.el){continue;}
if(target.ref.el.contains(ev.relatedTarget)){return;}}
for(const contains of state._contains){if(contains(ev.relatedTarget)){return;}}
setHover(false);lastHoveredTarget=null;}
for(const target of targets){useLazyExternalListener(()=>target.ref.el,"mouseenter",(ev)=>onmouseenter(ev),true);useLazyExternalListener(()=>target.ref.el,"mouseleave",(ev)=>onmouseleave(ev),true);}
if(stateObserver){useEffect((open)=>{if((lastHoveredTarget&&!lastHoveredTarget.ref.el)||!open){setHover(false);lastHoveredTarget=null;}},stateObserver);}
return state;}
const UseHoverOverlay=__exports.UseHoverOverlay=class UseHoverOverlay extends Component{static props=["slots","hover"];static template=xml`<div t-ref="root"><t t-slot="default"/></div>`;setup(){super.setup();this.root=useRef("root");const overlayContains=toRaw(this.env[OVERLAY_SYMBOL].contains);let removeTarget;onMounted(()=>{this.props.hover._contains.push(overlayContains);removeTarget=this.props.hover.addTarget({ref:{el:this.root.el.closest(".o-overlay-item")},});});onWillUnmount(()=>{const idx=this.props.hover._contains.find((c)=>c===overlayContains);if(idx){this.props.hover._contains.splice(idx,1);}
removeTarget?.();});}}
__exports.useOnBottomScrolled=useOnBottomScrolled;function useOnBottomScrolled(refName,callback,threshold=1){const ref=useRef(refName);function onScroll(){if(Math.abs(ref.el.scrollTop+ref.el.clientHeight-ref.el.scrollHeight)<threshold){callback();}}
onMounted(()=>{ref.el?.addEventListener("scroll",onScroll);});onWillUnmount(()=>{ref.el?.removeEventListener("scroll",onScroll);});}
__exports.useVisible=useVisible;function useVisible(refName,cb,{ready=true}={}){const ref=useRef(refName);const state=useState({isVisible:undefined,ready,});function setValue(value){state.isVisible=value;cb?.(state.isVisible);}
const observer=new IntersectionObserver((entries)=>{setValue(entries.at(-1).isIntersecting);});useEffect((el,ready)=>{if(el&&ready){observer.observe(el);return()=>{setValue(undefined);observer.unobserve(el);};}},()=>[ref.el,state.ready]);return state;}
__exports.useMessageScrolling=useMessageScrolling;function useMessageScrolling(duration=2000){let timeout;const state=useState({clear(){if(this.highlightedMessageId){browser.clearTimeout(timeout);timeout=null;this.highlightedMessageId=null;}},async highlightMessage(message,thread){if(thread.model!=="mail.box"&&thread.notEq(message.thread)){return;}
state.initiated=true;let messageScrollDirection;if(message.notIn(thread.messages)){messageScrollDirection=message.id<thread.messages[0]?.id?"top":"bottom";await thread.loadAround(message.id);}
const lastHighlightedMessageId=state.highlightedMessageId;this.clear();if(lastHighlightedMessageId===message.id){await new Promise(setTimeout);}
thread.scrollTop=messageScrollDirection==="top"?"bottom":undefined;if(thread.scrollTop==="bottom"){state.startupDeferred=new Deferred();await state.startupDeferred;state.startupDeferred=null;}
state.highlightedMessageId=message.id;state.initiated=false;timeout=browser.setTimeout(()=>this.clear(),duration);},initiated:false,startupDeferred:null,scrollPromise:null,scrollTo(el){state.scrollPromise?.resolve();const scrollPromise=new Deferred();state.scrollPromise=scrollPromise;if("onscrollend"in window){document.addEventListener("scrollend",scrollPromise.resolve,{capture:true,once:true,});}else{setTimeout(scrollPromise.resolve,250);}
el.scrollIntoView({behavior:"smooth",block:"center"});return scrollPromise;},highlightedMessageId:null,});return state;}
__exports.useMicrophoneVolume=useMicrophoneVolume;function useMicrophoneVolume(){let isClosed=false;let audioTrack=null;let disconnectAudioMonitor;let audioMonitorPromise;const store=useService("mail.store");const state=useState({isReady:true,isActive:false,value:0,toggle:async()=>{if(!state.isReady){return;}
state.isReady=false;disconnectAudioMonitor?.();disconnectAudioMonitor=undefined;if(audioTrack){audioTrack.stop();audioTrack=null;state.isReady=true;state.isActive=false;state.value=0;return;}
let track;try{const audioStream=await browser.navigator.mediaDevices.getUserMedia({audio:store.settings.audioConstraints,});track=audioStream.getAudioTracks()[0];}catch{store.env.services.notification.add(_t('"%(hostname)s" requires microphone access',{hostname:browser.location.host,}),{type:"warning"});return;}
if(isClosed){track.stop();return;}
audioMonitorPromise=monitorAudio(track,{onTic:(value)=>{state.value=value;},processInterval:100,});disconnectAudioMonitor=await audioMonitorPromise;audioTrack=track;state.isActive=true;state.isReady=true;},});onWillUnmount(async()=>{isClosed=true;await audioMonitorPromise;audioTrack?.stop();disconnectAudioMonitor?.();});return state;}
__exports.useSelection=useSelection;function useSelection({refName,model,preserveOnClickAwayPredicate=()=>false}){const ui=useService("ui");const ref=useRef(refName);function onSelectionChange(){const activeElement=ref.el?.getRootNode().activeElement;if(activeElement&&activeElement===ref.el){Object.assign(model,{start:ref.el.selectionStart,end:ref.el.selectionEnd,direction:ref.el.selectionDirection,});}}
onExternalClick(refName,async(ev)=>{if(await preserveOnClickAwayPredicate(ev)){return;}
if(!ref.el){return;}
Object.assign(model,{start:ref.el.value.length,end:ref.el.value.length,direction:ref.el.selectionDirection,});});onMounted(()=>{document.addEventListener("selectionchange",onSelectionChange);document.addEventListener("input",onSelectionChange);});onWillUnmount(()=>{document.removeEventListener("selectionchange",onSelectionChange);document.removeEventListener("input",onSelectionChange);});return{restore(){ref.el?.setSelectionRange(model.start,model.end,model.direction);},moveCursor(position){model.start=model.end=position;if(ref.el&&!ui.isSmall){ref.el.selectionStart=ref.el.selectionEnd=position;}},};}
__exports.useSequential=useSequential;function useSequential(){let inProgress=false;let nextFunction;let nextResolve;let nextReject;async function call(){const resolve=nextResolve;const reject=nextReject;const func=nextFunction;nextResolve=undefined;nextReject=undefined;nextFunction=undefined;inProgress=true;try{const data=await func();resolve(data);}catch(e){reject(e);}
inProgress=false;if(nextFunction&&nextResolve){call();}}
return(func)=>{nextResolve?.();const prom=new Promise((resolve,reject)=>{nextResolve=resolve;nextReject=reject;});nextFunction=func;if(!inProgress){call();}
return prom;};}
__exports.useDiscussSystray=useDiscussSystray;function useDiscussSystray(){const ui=useService("ui");return{class:"o-mail-DiscussSystray-class",get contentClass(){return`d-flex flex-column flex-grow-1 ${
                ui.isSmall ? "overflow-auto o-scrollbar-thin w-100 mh-100" : ""
            }`;},get menuClass(){return`p-0 o-mail-DiscussSystray ${
                ui.isSmall
                    ? "o-mail-systrayFullscreenDropdownMenu start-0 w-100 mh-100 d-flex flex-column mt-0 border-0 shadow-lg"
                    : ""
            }`;},};}
const useMovable=__exports.useMovable=makeDraggableHook({name:"useMovable",onWillStartDrag({ctx,addCleanup,addStyle,getRect}){ctx.current.container=document.createElement("div");addStyle(ctx.current.container,{position:"fixed",top:0,bottom:0,left:0,right:0,});ctx.current.element.after(ctx.current.container);addCleanup(()=>ctx.current.container.remove());},onDragStart:()=>true,onDragEnd:()=>true,onDrop({ctx,getRect}){const{top,left}=getRect(ctx.current.element);return{top,left};},});const LONG_PRESS_DELAY=__exports.LONG_PRESS_DELAY=400;__exports.useLongPress=useLongPress;function useLongPress(refName,{action,predicate=()=>true}={}){const MOVE_TRESHOLD=10;const ref=useRef(refName);let timer=null;let startX=0;let startY=0;function reset(){clearTimeout(timer);timer=null;}
useLazyExternalListener(()=>ref.el,"touchstart",(ev)=>{if(!predicate()){return;}
const touch=ev.touches[0];startX=touch.clientX;startY=touch.clientY;timer=setTimeout(()=>{action();reset();},LONG_PRESS_DELAY);});useLazyExternalListener(()=>ref.el,"touchmove",(ev)=>{if(!timer){return;}
const touch=ev.touches[0];const dx=touch.screenX-startX;const dy=touch.screenY-startY;if(Math.hypot(dx,dy)>MOVE_TRESHOLD){reset();}});useLazyExternalListener(()=>ref.el,"touchend",reset);useLazyExternalListener(()=>ref.el,"touchcancel",reset);}
const inDiscussCallViewProps=__exports.inDiscussCallViewProps=["isPip?"];__exports.useInDiscussCallView=useInDiscussCallView;function useInDiscussCallView(){const component=useComponent();useSubEnv({inDiscussCallView:{get isPip(){return component.props.isPip;},},});}
return __exports;});;

/* /mail/static/src/utils/common/media_monitoring.js */
odoo.define('@mail/utils/common/media_monitoring',[],function(require){'use strict';let __exports={};const HUMAN_VOICE_FREQUENCY_RANGE=[80,1000];__exports.monitorAudio=monitorAudio;async function monitorAudio(track,processorOptions){const monitoredTrack=track.clone();monitoredTrack.enabled=true;const stream=new window.MediaStream([monitoredTrack]);const AudioContext=window.AudioContext||window.webkitAudioContext;if(!AudioContext){throw"missing audio context";}
const audioContext=new AudioContext();const source=audioContext.createMediaStreamSource(stream);let processor;try{processor=await _loadAudioWorkletProcessor(source,audioContext,processorOptions);}catch{processor=_loadScriptProcessor(source,audioContext,processorOptions);}
return async()=>{processor.disconnect();source.disconnect();monitoredTrack.stop();try{await audioContext.close();}catch(e){if(e.name==="InvalidStateError"){return;}
throw e;}};}
function _loadScriptProcessor(source,audioContext,{frequencyRange=HUMAN_VOICE_FREQUENCY_RANGE,minimumActiveCycles=30,onThreshold,onTic,volumeThreshold=0.3,}={}){const bitSize=1024;const analyser=audioContext.createAnalyser();source.connect(analyser);const scriptProcessorNode=audioContext.createScriptProcessor(bitSize,1,1);analyser.connect(scriptProcessorNode);analyser.fftsize=bitSize;scriptProcessorNode.connect(audioContext.destination);const processInterval=50;const intervalInFrames=(processInterval/1000)*analyser.context.sampleRate;let nextUpdateFrame=processInterval;let activityBuffer=0;let wasAboveThreshold=undefined;let isAboveThreshold=false;scriptProcessorNode.onaudioprocess=()=>{nextUpdateFrame-=bitSize;if(nextUpdateFrame>=0){return;}
nextUpdateFrame+=intervalInFrames;const normalizedVolume=getFrequencyAverage(analyser,frequencyRange[0],frequencyRange[1]);if(normalizedVolume>=volumeThreshold){activityBuffer=minimumActiveCycles;}else if(normalizedVolume<volumeThreshold&&activityBuffer>0){activityBuffer--;}
isAboveThreshold=activityBuffer>0;onTic?.(normalizedVolume);if(wasAboveThreshold!==isAboveThreshold){wasAboveThreshold=isAboveThreshold;onThreshold?.(isAboveThreshold);}};return{disconnect:()=>{analyser.disconnect();scriptProcessorNode.disconnect();scriptProcessorNode.onaudioprocess=null;},};}
async function _loadAudioWorkletProcessor(source,audioContext,{frequencyRange=HUMAN_VOICE_FREQUENCY_RANGE,minimumActiveCycles=10,onThreshold,onTic,volumeThreshold=0.3,normalizationParameters={boost:1,shift:0.6},}={}){await audioContext.resume();await audioContext.audioWorklet.addModule("/mail/rtc/audio_worklet_processor_v2");const thresholdProcessor=new window.AudioWorkletNode(audioContext,"audio-processor",{processorOptions:{minimumActiveCycles,volumeThreshold,frequencyRange,normalizationParameters,postAllTics:!!onTic,},});source.connect(thresholdProcessor);thresholdProcessor.port.onmessage=(event)=>{const{isAboveThreshold,volume}=event.data;if(isAboveThreshold!==undefined){onThreshold?.(isAboveThreshold);}
if(volume!==undefined){onTic?.(volume);}};return{disconnect:()=>{thresholdProcessor.disconnect();},};}
function getFrequencyAverage(analyser,lowerFrequency,higherFrequency){const frequencies=new window.Uint8Array(analyser.frequencyBinCount);analyser.getByteFrequencyData(frequencies);const sampleRate=analyser.context.sampleRate;const startIndex=_getFrequencyIndex(lowerFrequency,sampleRate,analyser.frequencyBinCount);const endIndex=_getFrequencyIndex(higherFrequency,sampleRate,analyser.frequencyBinCount);const count=endIndex-startIndex;let sum=0;for(let index=startIndex;index<endIndex;index++){sum+=frequencies[index]/255;}
if(!count){return 0;}
return sum/count;}
function _getFrequencyIndex(targetFrequency,sampleRate,binCount){const index=Math.round((targetFrequency/(sampleRate/2))*binCount);return Math.min(Math.max(0,index),binCount);}
return __exports;});;

/* /mail/static/src/utils/common/misc.js */
odoo.define('@mail/utils/common/misc',['@odoo/owl','@web/core/assets','@web/core/utils/functions','@web/core/network/rpc','@web/core/utils/reactive'],function(require){'use strict';let __exports={};const{reactive}=require("@odoo/owl");const{AssetsLoadingError,getBundle}=require("@web/core/assets");const{memoize}=require("@web/core/utils/functions");const{rpc}=require("@web/core/network/rpc");const{effect}=require("@web/core/utils/reactive");__exports.assignDefined=assignDefined;function assignDefined(obj,data,keys=Object.keys(data)){for(const key of keys){if(data[key]!==undefined){obj[key]=data[key];}}
return obj;}
__exports.assignGetter=assignGetter;function assignGetter(obj,data){const properties=Object.fromEntries(Object.entries(data).map(([getterName,getterFn])=>[getterName,{get:getterFn,set:()=>{},},]));Object.defineProperties(obj,properties);}
__exports.assignIn=assignIn;function assignIn(obj,data,keys=Object.keys(data)){for(const key of keys){if(key in data){obj[key]=data[key];}}
return obj;}
__exports.nearestGreaterThanOrEqual=nearestGreaterThanOrEqual;function nearestGreaterThanOrEqual(list,target,itemToCompareVal){const findNext=(left,right,next)=>{if(left>right){return next;}
const index=Math.floor((left+right)/2);const item=list[index];const val=itemToCompareVal?.(item)??item;if(val===target){return item;}else if(val>target){return findNext(left,index-1,item);}else{return findNext(index+1,right,next);}};return findNext(0,list.length-1,null);}
const mailGlobal=__exports.mailGlobal={isInTest:false,};__exports.rpcWithEnv=rpcWithEnv;function rpcWithEnv(){return rpc;}
__exports.isDragSourceExternalFile=isDragSourceExternalFile;function isDragSourceExternalFile(dataTransfer){const dragDataType=dataTransfer.types;if(dragDataType.constructor===window.DOMStringList){return dragDataType.contains("Files");}
if(dragDataType.constructor===Array){return dragDataType.includes("Files");}
return false;}
__exports.onChange=onChange;function onChange(target,key,callback){let proxy;function _observe(){const val=proxy[key];if(typeof val==="object"&&val!==null){void Object.keys(val);}
if(Array.isArray(val)){void val.length;void val.forEach((i)=>i);}}
if(Array.isArray(key)){for(const k of key){onChange(target,k,callback);}
return;}
proxy=reactive(target,()=>{_observe();callback();});_observe();return proxy;}
__exports.closeStream=closeStream;function closeStream(stream){stream?.getTracks?.().forEach((track)=>track.stop());}
__exports.compareDatetime=compareDatetime;function compareDatetime(date1,date2){if(date1?.ts===date2?.ts){return 0;}
if(!date1){return-1;}
if(!date2){return 1;}
return date1.ts-date2.ts;}
function compareVersion(v1,v2){const parts1=v1.split(".");const parts2=v2.split(".");for(let i=0;i<Math.max(parts1.length,parts2.length);i++){const num1=parseInt(parts1[i])||0;const num2=parseInt(parts2[i])||0;if(num1<num2){return-1;}
if(num1>num2){return 1;}}
return 0;}
__exports.parseVersion=parseVersion;function parseVersion(v){return{isLowerThan(other){return compareVersion(v,other)<0;},};}
__exports.convertToEmbedURL=convertToEmbedURL;function convertToEmbedURL(url){const ytRegex=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|live\/|watch\?v=|&v=)([^#&?]*).*/;const ytMatch=url.match(ytRegex);if(ytMatch?.length===3){const youtubeURL=new URL(`/embed/${ytMatch[2]}`,"https://www.youtube.com");youtubeURL.searchParams.set("autoplay","1");return{url:youtubeURL.toString(),provider:"youtube"};}
const gdriveRegex=/(?:drive\.google\.com\/(?:file\/d\/|open\?id=|uc\?id=))([^/?&]+)/;const gdriveMatch=url.match(gdriveRegex);if(gdriveMatch?.length===2){const gdriveURL=new URL(`/file/d/${gdriveMatch[1]}/preview`,"https://drive.google.com");return{url:gdriveURL.toString(),provider:"google-drive"};}
return{url:null,provider:null};}
const hasHardwareAcceleration=__exports.hasHardwareAcceleration=memoize(()=>{const canvas=document.createElement("canvas");const gl=canvas.getContext("webgl2")||canvas.getContext("webgl")||canvas.getContext("experimental-webgl");if(!gl){return false;}
const debugInfo=gl.getExtension("WEBGL_debug_renderer_info");if(debugInfo){const renderer=gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);if(/swiftshader|llvmpipe|software/i.test(renderer)){return false;}}
return true;});__exports.effectWithCleanup=effectWithCleanup;function effectWithCleanup({effect:effectFn,dependencies,reactiveTargets}){let cleanup;let prevDependencies;effect((...deps)=>{const nextDependencies=dependencies(...deps);const changed=!prevDependencies||(Array.isArray(nextDependencies)?nextDependencies.some((v,i)=>v!==prevDependencies[i]):Object.keys(nextDependencies).some((key)=>nextDependencies[key]!==prevDependencies[key]));if(changed){prevDependencies=Array.isArray(nextDependencies)?[...nextDependencies]:{...nextDependencies};cleanup?.();cleanup=Array.isArray(nextDependencies)?effectFn(...nextDependencies):effectFn({...nextDependencies});}},reactiveTargets);}
__exports.effectWithDebouncedCleanup=effectWithDebouncedCleanup;function effectWithDebouncedCleanup({delay,dependencies,effect:effectFn,predicate,reactiveTargets,}){let timeout;let active=false;let cleanup;effectWithCleanup({effect(ctx){const{predicate,...deps}=ctx;if(!predicate){return;}
clearTimeout(timeout);if(!active){cleanup=effectFn(deps);active=true;}
return()=>{timeout=setTimeout(()=>{cleanup();active=false;},delay);};},dependencies:(...targets)=>({predicate:predicate(...targets),...dependencies(...targets),}),reactiveTargets,});}
__exports.loadCssFromBundle=loadCssFromBundle;async function loadCssFromBundle(targetNode,bundleName){try{const res=await getBundle(bundleName);for(const url of res.cssLibs){const link=document.createElement("link");link.rel="stylesheet";link.href=url;targetNode.appendChild(link);await new Promise((res,rej)=>{link.addEventListener("load",res);link.addEventListener("error",rej);});}}catch(e){if(e instanceof AssetsLoadingError&&e.cause instanceof TypeError){return new Promise(()=>{});}else{throw e;}}}
return __exports;});;

/* /mail/static/src/utils/common/pdf_thumbnail.js */
odoo.define('@mail/utils/common/pdf_thumbnail',['@web/core/utils/pdfjs'],function(require){'use strict';let __exports={};const{loadPDFJSAssets}=require("@web/core/utils/pdfjs");__exports.generatePdfThumbnail=generatePdfThumbnail;async function generatePdfThumbnail(pdfUrl,options={height:256,width:256}){let initialWorkerSrc=false,isPdfValid,pdf,thumbnail;try{await loadPDFJSAssets();initialWorkerSrc=globalThis.pdfjsLib.GlobalWorkerOptions.workerSrc;globalThis.pdfjsLib.GlobalWorkerOptions.workerSrc="/web/static/lib/pdfjs/build/pdf.worker.js";}catch{return{thumbnail,pdfEnabled:false};}
try{if(pdfUrl.startsWith("blob:")){pdfUrl=URL.createObjectURL(pdfUrl);pdf=await globalThis.pdfjsLib.getDocument(pdfUrl).promise;URL.revokeObjectURL(pdfUrl);}else{pdf=await globalThis.pdfjsLib.getDocument(pdfUrl).promise;}}catch(_error){if(_error.status===415){isPdfValid=false;}else if(_error.name!=="UnexpectedResponseException"&&_error.status&&_error.status!==403){pdf=undefined;}}finally{globalThis.pdfjsLib.GlobalWorkerOptions.workerSrc=initialWorkerSrc;}
if(pdf){isPdfValid=true;const page=await pdf.getPage(1);const viewPort=page.getViewport({scale:1});const canvas=document.createElement("canvas");canvas.width=options.width;canvas.height=options.height;const scale=canvas.width/viewPort.width;await page.render({canvasContext:canvas.getContext("2d"),viewport:page.getViewport({scale}),}).promise;thumbnail=canvas.toDataURL("image/jpeg").replace("data:image/jpeg;base64,","");}
return{isPdfValid,thumbnail,pdfEnabled:true};}
return __exports;});;

/* /mail/static/src/chatter/web_portal/chatter.js */
odoo.define('@mail/chatter/web_portal/chatter',['@mail/core/common/composer','@mail/core/common/thread','@odoo/owl','@web/core/l10n/translation','@web/core/utils/hooks','@web/core/utils/timing'],function(require){'use strict';let __exports={};const{Composer}=require("@mail/core/common/composer");const{Thread}=require("@mail/core/common/thread");const{Component,onMounted,onWillUpdateProps,useChildSubEnv,useRef,useState,}=require("@odoo/owl");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{useService}=require("@web/core/utils/hooks");const{useThrottleForAnimation}=require("@web/core/utils/timing");const Chatter=__exports.Chatter=class Chatter extends Component{static template="mail.Chatter";static components={Thread,Composer};static props=["composer?","threadId?","threadModel","twoColumns?"];static defaultProps={composer:true,threadId:false,twoColumns:false};setup(){this.store=useService("mail.store");this.state=useState({jumpThreadPresent:0,thread:undefined,aside:false,disabled:!this.props.threadId,});this.rootRef=useRef("root");this.onScrollDebounced=useThrottleForAnimation(this.onScroll);useChildSubEnv(this.childSubEnv);onMounted(this._onMounted);onWillUpdateProps((nextProps)=>{this.state.disabled=!nextProps.threadId;if(this.props.threadId!==nextProps.threadId||this.props.threadModel!==nextProps.threadModel){this.changeThread(nextProps.threadModel,nextProps.threadId);}
if(!this.env.chatter||this.env.chatter?.fetchThreadData){if(this.env.chatter){this.env.chatter.fetchThreadData=false;}
this.load(this.state.thread,this.requestList);}});}
get afterPostRequestList(){return["messages"];}
get childSubEnv(){return{inChatter:this.state};}
get onCloseFullComposerRequestList(){return["messages"];}
get requestList(){return[];}
changeThread(threadModel,threadId){this.state.thread=this.store.Thread.insert({model:threadModel,id:threadId});if(threadId===false){if(this.state.thread.messages.length===0){this.state.thread.messages.push({id:this.store.getNextTemporaryId(),author_id:this.state.thread.effectiveSelf,body:_t("Creating a new record..."),message_type:"notification",thread:this.state.thread,trackingValues:[],res_id:threadId,model:threadModel,});}}}
async load(thread,requestList){if(!thread.id||!this.state.thread?.eq(thread)){return;}
await thread.fetchThreadData(requestList);}
onCloseFullComposerCallback(){this.load(this.state.thread,this.onCloseFullComposerRequestList);}
_onMounted(){this.changeThread(this.props.threadModel,this.props.threadId);if(!this.env.chatter||this.env.chatter?.fetchThreadData){if(this.env.chatter){this.env.chatter.fetchThreadData=false;}
this.load(this.state.thread,this.requestList);}}
onPostCallback(){this.state.jumpThreadPresent++;this.load(this.state.thread,this.afterPostRequestList);}
onScroll(){this.state.isTopStickyPinned=this.rootRef.el.scrollTop!==0;}}
return __exports;});;

/* /mail/static/src/chatter/web_portal/composer_patch.js */
odoo.define('@mail/chatter/web_portal/composer_patch',['@mail/core/common/composer','@web/core/l10n/translation','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Composer}=require("@mail/core/common/composer");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"mail",...args);const{patch}=require("@web/core/utils/patch");patch(Composer.prototype,{get placeholder(){if(this.thread&&this.thread.model!=="discuss.channel"&&!this.props.placeholder){if(this.props.type==="message"){return _t("Send a message to followers");}else{return _t("Log an internal note");}}
return super.placeholder;},});return __exports;});;

/* /mail/static/src/chatter/web_portal/thread_model_patch.js */
odoo.define('@mail/chatter/web_portal/thread_model_patch',['@mail/core/common/thread_model','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Thread}=require("@mail/core/common/thread_model");const{patch}=require("@web/core/utils/patch");patch(Thread.prototype,{async fetchThreadData(requestList){if(requestList.includes("messages")){this.fetchNewMessages();}
await this.store.fetchStoreData("mail.thread",{access_params:this.rpcParams,request_list:requestList,thread_id:this.id,thread_model:this.model,});},});return __exports;});;

/* /portal/static/src/chatter/core/chatter_patch.js */
odoo.define('@portal/chatter/core/chatter_patch',['@mail/chatter/web_portal/chatter'],function(require){'use strict';let __exports={};const{Chatter}=require("@mail/chatter/web_portal/chatter");Chatter.template="portal.Chatter";return __exports;});;

/* /portal/static/src/chatter/core/composer_patch.js */
odoo.define('@portal/chatter/core/composer_patch',['@mail/core/common/composer','@web/core/l10n/translation','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Composer}=require("@mail/core/common/composer");const{appTranslateFn}=require("@web/core/l10n/translation");const _t=(str,...args)=>appTranslateFn(str,"portal",...args);const{patch}=require("@web/core/utils/patch");patch(Composer.prototype,{get placeholder(){if(this.env.inFrontendPortalChatter){return _t("Write a message");}
return super.placeholder;},});return __exports;});;

/* /portal/static/src/chatter/core/thread_model_patch.js */
odoo.define('@portal/chatter/core/thread_model_patch',['@mail/core/common/thread_model','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Thread}=require("@mail/core/common/thread_model");const{patch}=require("@web/core/utils/patch");patch(Thread.prototype,{get fetchRouteChatter(){return"/mail/chatter_fetch";},});return __exports;});;

/* /portal/static/src/chatter/frontend/attachment_upload_service_patch.js */
odoo.define('@portal/chatter/frontend/attachment_upload_service_patch',['@mail/core/common/attachment_upload_service','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{AttachmentUploadService}=require("@mail/core/common/attachment_upload_service");const{patch}=require("@web/core/utils/patch");patch(AttachmentUploadService.prototype,{_buildFormData(formData,file,thread,composer,tmpId,options){super._buildFormData(...arguments);if(thread.rpcParams.hash&&thread.rpcParams.pid){formData.append("hash",thread.rpcParams.hash);formData.append("pid",thread.rpcParams.pid);}
if(thread.rpcParams.token){formData.append("token",thread.rpcParams.token);}
return formData;},});return __exports;});;

/* /portal/static/src/chatter/frontend/chat_hub_service_patch.js */
odoo.define('@portal/chatter/frontend/chat_hub_service_patch',['@mail/core/common/chat_hub','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{chatHubService}=require("@mail/core/common/chat_hub");const{patch}=require("@web/core/utils/patch");patch(chatHubService,{start(){},});return __exports;});;

/* /portal/static/src/chatter/frontend/chatter_patch.js */
odoo.define('@portal/chatter/frontend/chatter_patch',['@mail/chatter/web_portal/chatter','@web/core/utils/patch','@odoo/owl'],function(require){'use strict';let __exports={};const{Chatter}=require("@mail/chatter/web_portal/chatter");const{patch}=require("@web/core/utils/patch");const{useRef,onWillPatch,useEffect}=require("@odoo/owl");patch(Chatter.prototype,{setup(){super.setup(...arguments);this.topRef=useRef("top");onWillPatch(()=>{const headerEl=document.querySelector("#wrapwrap header");if(!this.props.twoColumns&&headerEl&&!headerEl.matches(".o_header_sidebar")){const paddingTop=headerEl.getBoundingClientRect().height+15+"px";this.observer=new window.IntersectionObserver(([e])=>(e.target.style.paddingTop=e.target.getBoundingClientRect().y<1?paddingTop:"20px"),{threshold:[1],});}});useEffect(()=>{if(this.topRef.el){this.observer?.observe(this.topRef.el);}},()=>[this.topRef.el]);},});return __exports;});;

/* /portal/static/src/chatter/frontend/composer_model_patch.js */
odoo.define('@portal/chatter/frontend/composer_model_patch',['@mail/core/common/composer_model','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Composer}=require("@mail/core/common/composer_model");const{patch}=require("@web/core/utils/patch");patch(Composer.prototype,{portalComment:false,});return __exports;});;

/* /portal/static/src/chatter/frontend/composer_patch.js */
odoo.define('@portal/chatter/frontend/composer_patch',['@mail/core/common/composer','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Composer}=require("@mail/core/common/composer");const{patch}=require("@web/core/utils/patch");patch(Composer.prototype,{get showComposerAvatar(){return super.showComposerAvatar||(this.compact&&this.props.composer.portalComment);},get shouldHideFromMessageListOnDelete(){return this.env.inFrontendPortalChatter||super.shouldHideFromMessageListOnDelete;},});return __exports;});;

/* /portal/static/src/chatter/frontend/message_model_patch.js */
odoo.define('@portal/chatter/frontend/message_model_patch',['@web/core/utils/patch','@mail/core/common/message_model'],function(require){'use strict';let __exports={};const{patch}=require("@web/core/utils/patch");const{Message}=require("@mail/core/common/message_model");patch(Message.prototype,{get canToggleStar(){let result=super.canToggleStar;if(this.thread&&this.thread.model!=="discuss.channel"){result=result&&this.thread.hasReadAccess;}
return result;},});return __exports;});;

/* /portal/static/src/chatter/frontend/message_patch.js */
odoo.define('@portal/chatter/frontend/message_patch',['@mail/core/common/message','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Message}=require("@mail/core/common/message");const{patch}=require("@web/core/utils/patch");patch(Message.prototype,{get authorAvatarUrl(){if(this.message.author_avatar_url){return this.message.author_avatar_url;}
if(this.message.thread.access_token){return`/mail/avatar/mail.message/${this.message.id}/author_avatar/50x50?access_token=${this.message.thread.access_token}`;}
return super.authorAvatarUrl;},get shouldHideFromMessageListOnDelete(){return this.env.inFrontendPortalChatter||super.shouldHideFromMessageListOnDelete;},});return __exports;});;

/* /portal/static/src/chatter/frontend/portal_chatter.js */
odoo.define('@portal/chatter/frontend/portal_chatter',['@mail/chatter/web_portal/chatter','@web/core/overlay/overlay_container','@odoo/owl','@web/core/utils/hooks'],function(require){'use strict';let __exports={};const{Chatter}=require("@mail/chatter/web_portal/chatter");const{OverlayContainer}=require("@web/core/overlay/overlay_container");const{Component,xml,useSubEnv}=require("@odoo/owl");const{useService}=require("@web/core/utils/hooks");const PortalChatter=__exports.PortalChatter=class PortalChatter extends Component{static template=xml`
        <Chatter threadId="props.resId" threadModel="props.resModel" composer="props.composer" twoColumns="props.twoColumns"/>
        <div class="position-fixed" style="z-index:1030"><OverlayContainer overlays="overlayService.overlays"/></div>
    `;static components={Chatter,OverlayContainer};static props=["resId","resModel","composer","twoColumns","displayRating"];setup(){useSubEnv({displayRating:this.props.displayRating,inFrontendPortalChatter:true,});this.overlayService=useService("overlay");this.store=useService("mail.store");this.env.bus.addEventListener("reload_chatter_content",(ev)=>this._reloadChatterContent(ev.detail));}
async _reloadChatterContent(data){const thread=this.store.Thread.get({id:this.props.resId,model:this.props.resModel,});thread.messages=await thread.fetchMessages();}}
return __exports;});;

/* /portal/static/src/chatter/frontend/portal_chatter_service.js */
odoo.define('@portal/chatter/frontend/portal_chatter_service',['@portal/chatter/frontend/portal_chatter','@odoo/owl','@web/core/registry','@web/core/network/rpc','@web/session','@web/core/l10n/translation','@web/core/templates','@mail/utils/common/misc'],function(require){'use strict';let __exports={};const{PortalChatter}=require("@portal/chatter/frontend/portal_chatter");const{App}=require("@odoo/owl");const{registry}=require("@web/core/registry");const{rpc}=require("@web/core/network/rpc");const{session}=require("@web/session");const{appTranslateFn}=require("@web/core/l10n/translation");const{getTemplate}=require("@web/core/templates");const{loadCssFromBundle}=require("@mail/utils/common/misc");const PortalChatterService=__exports.PortalChatterService=class PortalChatterService{constructor(env,services){this.setup(env,services);}
setup(env,services){this.store=services["mail.store"];this.busService=services.bus_service;}
async createShadow(root){const shadow=root.attachShadow({mode:"open"});await loadCssFromBundle(shadow,"portal.assets_chatter_style");return shadow;}
async initialize(env){const chatterEl=document.querySelector(".o_portal_chatter");const props={resId:parseInt(chatterEl.getAttribute("data-res_id")),resModel:chatterEl.getAttribute("data-res_model"),composer:parseInt(chatterEl.getAttribute("data-allow_composer"))&&(chatterEl.getAttribute("data-token")||!session.is_public),twoColumns:chatterEl.getAttribute("data-two_columns")==="true"?true:false,displayRating:chatterEl.getAttribute("data-display_rating")==="True"?true:false,};const root=document.createElement("div");root.setAttribute("id","chatterRoot");if(props.twoColumns){root.classList.add("p-0");}
chatterEl.appendChild(root);this.createShadow(root).then((shadow)=>{new App(PortalChatter,{env,getTemplate,props,translatableAttributes:["data-tooltip"],translateFn:appTranslateFn,dev:env.debug,}).mount(shadow);});const thread=this.store.Thread.insert({model:props.resModel,id:props.resId});Object.assign(thread,{access_token:chatterEl.getAttribute("data-token"),hash:chatterEl.getAttribute("data-hash"),pid:parseInt(chatterEl.getAttribute("data-pid")),});const data=await rpc("/portal/chatter_init",{thread_model:props.resModel,thread_id:props.resId,...thread.rpcParams,},{silent:true});this.store.insert(data);odoo.portalChatterReady.resolve(true);}}
const portalChatterService=__exports.portalChatterService={dependencies:["mail.store","bus_service"],start(env,services){const portalChatter=new PortalChatterService(env,services);portalChatter.initialize(env);return portalChatter;},};registry.category("services").add("portal.chatter",portalChatterService);return __exports;});;

/* /portal/static/src/chatter/frontend/suggestion_service_patch.js */
odoo.define('@portal/chatter/frontend/suggestion_service_patch',['@mail/core/common/suggestion_service','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{SuggestionService}=require("@mail/core/common/suggestion_service");const{patch}=require("@web/core/utils/patch");const suggestionServicePatch={getSupportedDelimiters(thread,env){if(env?.inFrontendPortalChatter){return[["::"],[":",undefined,2]];}
return super.getSupportedDelimiters(...arguments);},};patch(SuggestionService.prototype,suggestionServicePatch);return __exports;});;

/* /portal/static/src/chatter/frontend/thread_model_patch.js */
odoo.define('@portal/chatter/frontend/thread_model_patch',['@mail/core/common/thread_model','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Thread}=require("@mail/core/common/thread_model");const{patch}=require("@web/core/utils/patch");patch(Thread.prototype,{setup(){super.setup(...arguments);this.hasReadAccess;},get effectiveSelf(){if(this.portal_partner&&!this.store.self_partner){return this.portal_partner;}
return super.effectiveSelf;},get rpcParams(){return{...super.rpcParams,...(this.access_token?{token:this.access_token}:{}),...(this.hash?{hash:this.hash}:{}),...(this.pid?{pid:this.pid}:{}),};},});return __exports;});;

/* /rating/static/src/core/common/message_model_patch.js */
odoo.define('@rating/core/common/message_model_patch',['@mail/core/common/message_model','@mail/core/common/record','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Message}=require("@mail/core/common/message_model");const{fields}=require("@mail/core/common/record");const{patch}=require("@web/core/utils/patch");patch(Message.prototype,{setup(){super.setup(...arguments);this.rating_id=fields.One("rating.rating");},computeIsEmpty(){return super.computeIsEmpty()&&!this.rating_id&&!this.rating_value;},get removeParams(){return{...super.removeParams,rating_value:false};},});return __exports;});;

/* /rating/static/src/core/common/rating_model.js */
odoo.define('@rating/core/common/rating_model',['@mail/core/common/record'],function(require){'use strict';let __exports={};const{Record}=require("@mail/core/common/record");const Rating=__exports.Rating=class Rating extends Record{static _name="rating.rating";static id="id";id;rating;rating_image_url;rating_text;}
Rating.register();return __exports;});;

/* /portal_rating/static/src/chatter/frontend/chatter_patch.js */
odoo.define('@portal_rating/chatter/frontend/chatter_patch',['@mail/chatter/web_portal/chatter','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Chatter}=require("@mail/chatter/web_portal/chatter");const{patch}=require("@web/core/utils/patch");const chatterPatch={async onClickStarDomain(star){const{thread}=this.state;Object.assign(thread,{loadOlder:false,rating_stats:this.ratingStats,selectedRating:star,});thread.messages=await thread.fetchMessages();thread.loadOlder=thread.messages.length===this.store.FETCH_LIMIT;},async onClickStarDomainReset(){const{thread}=this.state;Object.assign(thread,{loadOlder:false,selectedRating:false,});thread.messages=await thread.fetchMessages();thread.loadOlder=thread.messages.length===this.store.FETCH_LIMIT;},get ratingStats(){return this.state.thread?.messages.at(-1)?.rating_stats||this.state.thread?.rating_stats;},};patch(Chatter.prototype,chatterPatch);return __exports;});;

/* /portal_rating/static/src/chatter/frontend/composer_model_patch.js */
odoo.define('@portal_rating/chatter/frontend/composer_model_patch',['@web/core/utils/patch','@mail/core/common/composer_model'],function(require){'use strict';let __exports={};const{patch}=require("@web/core/utils/patch");const{Composer}=require("@mail/core/common/composer_model");patch(Composer.prototype,{get syncHtmlWithMessage(){return super.syncHtmlWithMessage&&!this.portalComment;},});return __exports;});;

/* /portal_rating/static/src/chatter/frontend/composer_patch.js */
odoo.define('@portal_rating/chatter/frontend/composer_patch',['@mail/core/common/composer','@web/core/utils/patch','@web/core/network/rpc','@odoo/owl'],function(require){'use strict';let __exports={};const{Composer}=require("@mail/core/common/composer");const{patch}=require("@web/core/utils/patch");const{rpc}=require("@web/core/network/rpc");const{useState}=require("@odoo/owl");patch(Composer.prototype,{setup(){super.setup(...arguments);this.portalState=useState({ratingValue:4,starValue:4,});},get allowUpload(){return super.allowUpload&&!this.props.composer.portalComment;},async editMessage(){if(this.props.composer.portalComment){await this.savePublisherComment();return;}
await super.editMessage();},async savePublisherComment(){if(!this.state.active){return;}
this.state.active=false;const data=await rpc("/website/rating/comment",{rating_id:this.message.rating_id.id,publisher_comment:this.props.composer.composerText.trim(),});this.message.rating_id=data;this.props.onPostCallback();},get canProcessMessage(){return super.canProcessMessage||(this.message&&this.message.rating_value);},get askDeleteFromEdit(){return super.askDeleteFromEdit&&!this.message.rating_value;},onMoveStar(ev){const index=parseInt(ev.currentTarget.getAttribute("index"));this.portalState.starValue=index+1;},onClickStar(){this.portalState.ratingValue=this.portalState.starValue;},get postData(){const postData=super.postData;if(this.env.displayRating&&!this.message){postData.rating_value=this.portalState.ratingValue;}
return postData;},});return __exports;});;

/* /portal_rating/static/src/chatter/frontend/message_model_patch.js */
odoo.define('@portal_rating/chatter/frontend/message_model_patch',['@mail/core/common/message_model','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Message}=require("@mail/core/common/message_model");const{patch}=require("@web/core/utils/patch");const messagePatch={async remove({removeFromThread=false}={}){const data=await super.remove(...arguments);if(this.thread&&removeFromThread){this.thread.messages.forEach((message)=>{message.rating_stats=this.thread.rating_stats;});}
return data;},};patch(Message.prototype,messagePatch);return __exports;});;

/* /portal_rating/static/src/chatter/frontend/message_patch.js */
odoo.define('@portal_rating/chatter/frontend/message_patch',['@mail/core/common/message','@mail/utils/common/format','@web/core/dropdown/dropdown_item','@web/core/network/rpc','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Message}=require("@mail/core/common/message");const{convertBrToLineBreak}=require("@mail/utils/common/format");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{rpc}=require("@web/core/network/rpc");const{patch}=require("@web/core/utils/patch");Message.components={...Message.components,DropdownItem};patch(Message.prototype,{setup(){super.setup(...arguments);this.state.editRating=false;},get isEditing(){return!this.state.editRating&&super.isEditing;},get ratingValue(){return this.message.rating_value||this.message.rating_id?.rating;},onClikEditComment(){this.state.editRating=!this.state.editRating;if(this.state.editRating){const messageContent=convertBrToLineBreak(this.props.message.rating_id.publisher_comment);this.props.message.composer={message:this.props.message,composerHtml:this.props.message.rating_id.publisher_comment,portalComment:true,selection:{start:messageContent.length,end:messageContent.length,direction:"none",},};}else{this.message.composer=null;}},exitEditCommentMode(){this.props.message.composer.clear();this.message.composer=null;this.state.editRating=false;},async deleteComment(){const data=await rpc("/website/rating/comment",{rating_id:this.message.rating_id.id,publisher_comment:"",});this.message.rating_id=data;},});return __exports;});;

/* /portal_rating/static/src/chatter/frontend/store_service_patch.js */
odoo.define('@portal_rating/chatter/frontend/store_service_patch',['@mail/core/common/store_service','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Store}=require("@mail/core/common/store_service");const{patch}=require("@web/core/utils/patch");patch(Store.prototype,{async getMessagePostParams({postData}){const params=await super.getMessagePostParams(...arguments);if(postData.rating_value){params.post_data.rating_value=postData.rating_value;}
return params;},});return __exports;});;

/* /portal_rating/static/src/chatter/frontend/thread_model_patch.js */
odoo.define('@portal_rating/chatter/frontend/thread_model_patch',['@mail/core/common/thread_model','@web/core/utils/patch'],function(require){'use strict';let __exports={};const{Thread}=require("@mail/core/common/thread_model");const{patch}=require("@web/core/utils/patch");patch(Thread.prototype,{setup(){super.setup();this.selectedRating;this.rating_stats;},getFetchParams(){const params=super.getFetchParams(...arguments);if(this.model!=="discuss.channel"){params["rating_include"]=true;if(this.selectedRating){params["rating_value"]=this.selectedRating;}}
return params;},});return __exports;});

                    /*******************************************
                    *  Templates                               *
                    *******************************************/

                    odoo.define("portal.assets_chatter.bundle.xml", ["@web/core/templates"], function(require) {
                        "use strict";
                        const { checkPrimaryTemplateParents, registerTemplate, registerTemplateExtension } = require("@web/core/templates");
                        /* portal.assets_chatter */
                        registerTemplate("html_editor.AttachmentError", `/html_editor/static/src/main/media/media_dialog/attachment_error.xml`, `<t t-name="html_editor.AttachmentError" xml:space="preserve">
    <Dialog title="title">
        <div class="form-text">
            <p>The image could not be deleted because it is used in the
                following pages or views:</p>
            <ul t-foreach="props.views" t-as="view" t-key="view.id">
                <li>
                    <a t-att-href="'/odoo/ir.ui.view/' + window.encodeURIComponent(view.id)">
                        <t t-esc="view.name"/>
                    </a>
                </li>
            </ul>
        </div>
        <t t-set-slot="footer">
            <button class="btn btn-primary" t-on-click="() =&gt; this.props.close()">
                Ok
            </button>
        </t>
    </Dialog>
</t>
`);
registerTemplate("html_editor.DocumentAttachment", `/html_editor/static/src/main/media/media_dialog/document_selector.xml`, `<t t-name="html_editor.DocumentAttachment" xml:space="preserve">
    <div class="o_existing_attachment_cell o_we_attachment_highlight card col-2 position-relative mb-2 p-2 opacity-trigger-hover" t-att-class="{ o_we_attachment_selected: props.selected }">
        <RemoveButton remove="() =&gt; this.remove()"/>
        <div t-att-data-url="props.url" role="img" t-att-aria-label="props.name" t-att-title="props.name" t-att-data-mimetype="props.mimetype" class="o_image d-flex align-items-center justify-content-center"/>
        <button class="o_btn_reset o_button_area cursor-pointer" t-on-click="props.selectAttachment" t-att-aria-label="props.name"/>
        <small class="o_file_name d-block text-truncate" t-esc="props.name"/>
    </div>
</t>

`);
registerTemplate("html_editor.DocumentsListTemplate", `/html_editor/static/src/main/media/media_dialog/document_selector.xml`, `<t t-name="html_editor.DocumentsListTemplate" xml:space="preserve">
    <div class="o_we_existing_attachments o_we_documents" t-ref="existing-attachments">
        <div t-if="!hasContent" class="o_nocontent_help">
            <p class="o_empty_folder_image">No documents found.</p>
            <p class="o_empty_folder_subtitle">You can upload documents with the button located in the top left of the screen.</p>
        </div>
        <div t-else="" class="d-flex flex-wrap gap-2">
            <t t-foreach="state.attachments" t-as="attachment" t-key="attachment.id">
                <DocumentAttachment url="attachment.url" name="attachment.name" mimetype="attachment.mimetype" id="attachment.id" onRemoved="(attachmentId) =&gt; this.onRemoved(attachmentId)" selected="this.selectedAttachmentIds.includes(attachment.id)" selectAttachment="() =&gt; this.onClickDocument(attachment)"/>
            </t>
        </div>
    </div>
</t>
`);
registerTemplate("html_editor.FileSelectorControlPanel", `/html_editor/static/src/main/media/media_dialog/file_selector.xml`, `<t t-name="html_editor.FileSelectorControlPanel" xml:space="preserve">
    <div class="o_we_file_selector_control_panel sticky-top d-flex flex-wrap gap-2 mb-1 p-3 align-items-end">
        <SearchMedia searchPlaceholder="props.searchPlaceholder" needle="props.needle" search="props.search"/>
        <div class="d-flex gap-3 justify-content-start align-items-center">
            <div t-if="props.showOptimizedOption" class="flex-shrink-0 form-check form-switch align-items-center" t-on-change="props.changeShowOptimized">
                <input class="o_we_show_optimized form-check-input" type="checkbox" t-att-checked="props.showOptimized" id="o_we_show_optimized_switch"/>
                <label class="form-check-label" for="o_we_show_optimized_switch">
                    Show optimized images
                </label>
            </div>
            <select t-if="showSearchServiceSelect" class="o_input o_we_search_select form-select pe-5" t-on-change="ev =&gt; props.changeSearchService(ev.target.value)">
                <option t-att-selected="props.searchService === 'all'" value="all">All</option>
                <option t-att-selected="props.searchService === 'database'" value="database">My Images</option>
                <option t-if="props.useMediaLibrary" t-att-selected="props.searchService === 'media-library'" value="media-library">Illustrations</option>
            </select>
        </div>
        <div class="col justify-content-end flex-nowrap input-group has-validation">
            <input type="text" class="form-control o_input o_we_url_input o_we_transition_ease flex-grow-0" t-att-class="{ o_we_horizontal_collapse: !state.showUrlInput, 'w-auto': state.showUrlInput }" name="url" t-att-placeholder="props.urlPlaceholder" t-model="state.urlInput" t-on-input="onUrlInput" t-if="state.showUrlInput" t-ref="urlInput"/>
            <button type="button" class="btn o_upload_media_url_button text-nowrap" t-att-class="{ 'btn-primary': state.urlInput, 'btn-secondary': !state.urlInput}" t-on-click="onUrlUploadClick" t-att-disabled="!enableUrlUploadClick">
                    <t t-esc="props.addText"/>
            </button>
            <div class="d-flex align-items-center">
                <span t-if="state.urlInput and state.isValidatingUrl" class="o_we_url_loading mx-2 fa fa-lg fa-circle-o-notch fa-spin" title="Loading..."/>
                <span t-elif="state.urlInput and state.isValidUrl and state.isValidFileFormat" class="o_we_url_success text-success mx-2 fa fa-lg fa-check" title="The URL seems valid."/>
                <span t-elif="state.urlInput and !state.isValidUrl" class="o_we_url_error text-danger mx-2 oi oi-large oi-close" title="The URL does not seem to work."/>
                <span t-elif="props.urlWarningTitle and state.urlInput and state.isValidUrl and !state.isValidFileFormat" class="o_we_url_warning text-warning mx-2 fa fa-lg fa-warning" t-att-title="props.urlWarningTitle"/>
            </div>
        </div>
        <input type="file" class="d-none o_file_input" t-on-change="onChangeFileInput" t-ref="file-input" t-att-accept="props.accept" t-att-multiple="props.multiSelect and 'multiple'"/>
        <div class="col-auto btn-group">
            <button type="button" class="btn btn-secondary o_upload_media_button" t-on-click="onClickUpload">
                <t t-esc="props.uploadText"/>
            </button>
        </div>
    </div>
</t>

`);
registerTemplate("html_editor.FileSelector", `/html_editor/static/src/main/media/media_dialog/file_selector.xml`, `<t t-name="html_editor.FileSelector" xml:space="preserve">
    <div>
        <FileSelectorControlPanel uploadText="uploadText" accept="fileMimetypes" urlPlaceholder="urlPlaceholder" addText="addText" searchPlaceholder="searchPlaceholder" urlWarningTitle="urlWarningTitle" uploadUrl="(url) =&gt; this.uploadUrl(url)" uploadFiles="(files) =&gt; this.uploadFiles(files)" showOptimizedOption="showOptimizedOption" showOptimized="state.showOptimized" changeShowOptimized="showOptimized =&gt; this.state.showOptimized = !this.state.showOptimized" changeSearchService="service =&gt; this.state.searchService = service" searchService="state.searchService" needle="state.needle" search="(needle) =&gt; this.handleSearch(needle)" useMediaLibrary="props.useMediaLibrary" validateUrl="validateUrl" multiSelect="props.multiSelect"/>
        <t t-call="{{ constructor.attachmentsListTemplate }}"/>
        <div name="load_more_attachments" class="pt-3 pb-1 text-center mx-auto o_we_load_more" t-ref="load-more-button">
            <button t-if="canLoadMore" class="btn btn-primary o_load_more" type="button" t-on-click="handleLoadMore">
                Load more...
            </button>
            <div t-elif="hasContent" class="mt-2 o_load_done_msg">
                <span><i t-esc="allLoadedText"/></span>
            </div>
        </div>
        <div t-if="this.state.canScrollAttachments" class="position-sticky d-flex align-items-center mx-auto btn btn-primary rounded-circle oi oi-chevron-down o_scroll_attachments" t-on-click="handleScrollAttachments"/>
    </div>
</t>
`);
registerTemplate("html_editor.IconSelector", `/html_editor/static/src/main/media/media_dialog/icon_selector.xml`, `<t t-name="html_editor.IconSelector" xml:space="preserve">
    <div>
        <div class="o_we_file_selector_control_panel sticky-top d-flex gap-2 align-items-center mb-1 py-4 px-3">
            <SearchMedia searchPlaceholder.translate="Search a pictogram" search.bind="this.search" needle="state.needle"/>
        </div>
        <div class="font-icons-icons">
            <t t-foreach="state.fonts" t-as="font" t-key="font.base">
                <div t-if="!font.icons.length" class="o_nocontent_help">
                    <p class="o_empty_folder_image">No pictograms found.</p>
                    <p class="o_empty_folder_subtitle">Try searching with other keywords.</p>
                </div>
                <span t-foreach="font.icons" t-as="icon" t-key="icon.id" t-att-title="icon.names[0]" t-att-aria-label="icon.names[0]" role="img" class="font-icons-icon m-2 fs-2 p-3 cursor-pointer text-center" t-att-class="{ o_we_attachment_selected: this.selectedMediaIds.includes(icon.id) }" t-attf-class="{{ font.base }} {{ icon.names[0] }}" t-on-click="() =&gt; this.onClickIcon(font, icon)"/>
            </t>
        </div>
    </div>
</t>
`);
registerTemplate("html_editor.AutoResizeImage", `/html_editor/static/src/main/media/media_dialog/image_selector.xml`, `<t t-name="html_editor.AutoResizeImage" xml:space="preserve">
    <div t-ref="auto-resize-image-container" class="o_existing_attachment_cell o_we_image align-items-center justify-content-center me-1 mb-1 opacity-trigger-hover opacity-0" t-att-class="{             o_we_attachment_optimized: props.isOptimized,             'o_loaded position-relative opacity-100': state.loaded,             o_we_attachment_selected: props.selected,             'position-fixed': !state.loaded,          }">
        <RemoveButton t-if="props.isRemovable" model="props.model" remove="() =&gt; this.remove()"/>
        <div class="o_we_media_dialog_img_wrapper" t-att-class="{ 'bg-light': props.unselectable }">
             <t t-set="unselectable_attachment_title">You can not use this image in a field</t>
             <img t-ref="auto-resize-image" class="o_we_attachment_highlight img img-fluid w-100" t-att-class="{ 'opacity-25': props.unselectable}" t-att-src="props.src" t-att-alt="props.altDescription" loading="lazy" t-att-title="props.unselectable ? unselectable_attachment_title : props.title" t-on-load="onImageLoaded"/>
             <a t-if="props.author" class="o_we_media_author position-absolute start-0 bottom-0 end-0 text-truncate text-center text-primary fs-6 bg-white-50" t-att-href="props.authorLink" target="_blank" t-esc="props.author"/>
        </div>
        <button class="o_btn_reset o_button_area" t-att-class="{ 'cursor-pointer': !props.unselectable }" t-on-click="props.onImageClick" t-att-aria-label="props.unselectable ? unselectable_attachment_title : props.title"/>
        <span t-if="props.isOptimized" class="badge position-absolute bottom-0 end-0 m-1 text-bg-success">Optimized</span>
    </div>
</t>

`);
registerTemplate("html_editor.ExternalImage", `/html_editor/static/src/main/media/media_dialog/image_selector.xml`, `<t t-name="html_editor.ExternalImage" xml:space="preserve">
    <t t-if="record.mediaType == 'libraryMedia'">
        <AutoResizeImage author="record.author" src="record.thumbnail_url" authorLink="record.author_link" title="record.tooltip" altDescription="record.tooltip" minRowHeight="MIN_ROW_HEIGHT" selected="this.selectedMediaIds.includes(record.id)" onImageClick="() =&gt; this.onClickMedia(record)" onLoaded="(imgEl) =&gt; this.onImageLoaded(imgEl, record)"/>
    </t>
</t>

`);
registerTemplate("html_editor.ImagesListTemplate", `/html_editor/static/src/main/media/media_dialog/image_selector.xml`, `<t t-name="html_editor.ImagesListTemplate" xml:space="preserve">
    <div class="o_we_existing_attachments o_we_images d-flex flex-wrap my-0" t-ref="existing-attachments">
        <t t-if="!hasContent and !isFetching">
            <div t-if="state.needle" class="o_nocontent_help">
                <p class="o_empty_folder_image">No images found.</p>
                <p class="o_empty_folder_subtitle">Wow, it feels a bit empty in here. Upload from the button in the top right corner!</p>
            </div>
            <div t-else="" class="o_we_search_prompt">
                <h2>Search the web for royalty-free images</h2>
            </div>
        </t>
        <t t-else="">
            <t t-if="['all', 'database'].includes(state.searchService)">
                <t t-foreach="state.attachments" t-as="attachment" t-key="attachment.id">
                    <AutoResizeImage t-if="!attachment.original_id or state.showOptimized" id="attachment.id" isOptimized="!!attachment.original_id" isRemovable="true" onRemoved="(attachmentId) =&gt; this.onRemoved(attachmentId)" selected="this.selectedAttachmentIds.includes(attachment.id)" src="attachment.thumbnail_src or attachment.image_src" name="attachment.name" title="attachment.name" unselectable="!!attachment.unselectable" altDescription="attachment.altDescription" model="attachment.res_model" minRowHeight="MIN_ROW_HEIGHT" onImageClick="() =&gt; this.onClickAttachment(attachment)" onLoaded="(imgEl) =&gt; this.onImageLoaded(imgEl, attachment)"/>
                </t>
            </t>
            <t id="o_we_media_library_images" t-if="['all', 'media-library'].includes(state.searchService)">
                <t t-foreach="state.libraryMedia" t-as="record" t-key="record.id">
                    <t t-call="html_editor.ExternalImage"/>
                </t>
            </t>

            <t t-foreach="[...Array(20).keys()]" t-as="i" t-key="i">
                <div class="o_we_attachment_placeholder"/>
            </t>
        </t>
    </div>
</t>
`);
registerTemplate("html_editor.MediaDialog", `/html_editor/static/src/main/media/media_dialog/media_dialog.xml`, `<t t-name="html_editor.MediaDialog" xml:space="preserve">
    <Dialog contentClass="contentClass" size="size" title="title" modalRef="modalRef">
        <Notebook pages="notebookPages" onPageUpdate.bind="onTabChange" defaultPage="state.activeTab"/>
        <t t-set-slot="footer">
            <button class="btn btn-primary" t-on-click="() =&gt; this.save()" t-ref="add-button" data-hotkey="q">Add</button>
            <button class="btn btn-secondary" t-on-click="() =&gt; this.props.close()" data-hotkey="x">Discard</button>
        </t>
    </Dialog>
</t>
`);
registerTemplate("html_editor.SearchMedia", `/html_editor/static/src/main/media/media_dialog/search_media.xml`, `<t t-name="html_editor.SearchMedia" xml:space="preserve">
    <div class="position-relative mw-lg-25 flex-grow-1 me-auto">
        <input type="text" class="o_we_search o_input form-control pe-4" t-att-placeholder="props.searchPlaceholder.trim()" t-model="state.input" t-ref="autofocus"/>
        <i class="oi oi-search input-group-text position-absolute end-0 top-50 me-n3 px-2 py-1 translate-middle bg-transparent border-0" title="Search" role="img" aria-label="Search"/>
    </div>
</t>
`);
registerTemplate("html_editor.ProgressBar", `/html_editor/static/src/main/media/media_dialog/upload_progress_toast/upload_progress_toast.xml`, `<t t-name="html_editor.ProgressBar" xml:space="preserve">
    <small class="text-info d-flex align-items-center me-2">
        <span t-if="!props.hasError and !props.uploaded"><i class="fa fa-circle-o-notch fa-spin me-2"/></span>
        <span class="fst-italic fw-bold text-truncate flex-grow-1 me-2" t-esc="props.name"/>
        <span class="fw-bold text-nowrap" t-esc="props.size"/>
    </small>
    <small t-if="props.uploaded or props.hasError" class="d-flex align-items-center mt-1">
        <span t-if="props.uploaded" class="text-success"><i class="fa fa-check my-1 me-1"/> File has been uploaded</span>
        <span t-else="" class="text-danger"><i class="oi oi-close float-start my-1 me-1"/> <span class="o_we_error_text" t-esc="errorMessage"/></span>
    </small>
    <div t-else="" class="progress mt-2">
        <div class="progress-bar bg-info progress-bar-striped progress-bar-animated" role="progressbar" t-attf-style="width: {{this.progress}}%;" aria-label="Progress bar"><span t-esc="this.progress + '%'"/></div>
    </div>
    <hr/>
</t>

`);
registerTemplate("html_editor.UploadProgressToast", `/html_editor/static/src/main/media/media_dialog/upload_progress_toast/upload_progress_toast.xml`, `<t t-name="html_editor.UploadProgressToast" xml:space="preserve">
    <div class="editor_notification_manager o_notification_manager o_upload_progress_toast">
        <div t-if="state.isVisible" class="o_notification position-relative show fade mb-2 border border-info bg-white d-flex justify-content-between" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="editor_notification_body o_notification_body ps-2 py-2">
                <div class="me-auto o_notification_content">
                    <div t-foreach="state.files" t-as="file" t-key="file" class="o_we_progressbar">
                        <ProgressBar progress="file_value.progress" errorMessage="file_value.errorMessage" hasError="file_value.hasError" name="file_value.name" uploaded="file_value.uploaded" size="file_value.size"/>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-close o_notification_close p-2" aria-label="Close" t-on-click="props.close"/>
        </div>
    </div>
</t>
`);
registerTemplate("html_editor.VideoOption", `/html_editor/static/src/main/media/media_dialog/video_selector.xml`, `<t t-name="html_editor.VideoOption" xml:space="preserve">
    <div class="mb-1" t-attf-class="{{ showStartAtInput ? 'd-flex align-items-start gap-2 cursor-pointer' : ''}}">
        <Switch value="!!props.value" onChange="props.onChangeOption" label="props.label" description="props.description" extraClasses="'d-flex align-items-start cursor-pointer flex-shrink-0'"/>
        <t t-if="showStartAtInput">
            <input type="text" placeholder="MM:SS" class="o_input w-lg-auto" t-att-value="props.value" t-on-input="props.onChangeStartAt"/>
        </t>
    </div>
</t>

`);
registerTemplate("html_editor.VideoIframe", `/html_editor/static/src/main/media/media_dialog/video_selector.xml`, `<t t-name="html_editor.VideoIframe" xml:space="preserve">
    <iframe t-att-src="this.props.src" class="o_video_dialog_iframe mw-100 mh-100 overflow-hidden shadow" width="1280" height="720" allowfullscreen="allowfullscreen" frameborder="0"/>
</t>

`);
registerTemplate("html_editor.VideoSelector", `/html_editor/static/src/main/media/media_dialog/video_selector.xml`, `<t t-name="html_editor.VideoSelector" xml:space="preserve">
    <div class="row">
        <div class="col mt-4 o_video_dialog_form">
            <div class="mb-2">
                <label for="o_video_text">
                    <b>Video code </b>(URL or Embed)
                </label>
                <div class="text-start">
                    <small class="text-muted">Accepts <b><i>Youtube</i></b>, <b><i>Vimeo</i></b>, <b><i>Dailymotion</i></b> and <b><i>Instagram</i></b> videos</small>
                </div>
                <textarea t-ref="autofocus" t-model="state.urlInput" class="form-control" id="o_video_text" placeholder="Copy-paste your URL or embed code here" t-on-input="onChangeUrl" t-att-class="{ 'is-valid': state.urlInput and !this.state.errorMessage, 'is-invalid': state.urlInput and this.state.errorMessage }"/>
            </div>
            <div t-if="shownOptions.length" class="o_video_dialog_options">
                <VideoOption t-foreach="shownOptions" t-as="option" t-key="option.id" name="option.id" value="value" onChangeOption="() =&gt; this.onChangeOption(option.id)" onChangeStartAt="(ev) =&gt; this.onChangeStartAt(ev, option.id)" label="option.label" description="option.description"/>
            </div>
            <t t-if="state.vimeoPreviews.length">
                <span class="fw-bold">Suggestions</span>
                <div id="video-suggestion" class="mt-4 d-flex flex-wrap mh-75 overflow-auto">
                    <t t-foreach="state.vimeoPreviews" t-as="vimeoPreview" t-key="vimeoPreview.id">
                        <div class="o_sample_video w-25 mh-100 cursor-pointer" t-on-click="() =&gt; this.onClickSuggestion(vimeoPreview.src)">
                            <img class="mw-100 mh-100 p-1" t-att-src="vimeoPreview.thumbnailSrc"/>
                        </div>
                    </t>
                </div>
            </t>
        </div>
        <div class="col-md-6">
            <div class="o_video_preview position-relative border-0 p-3">
                <div t-if="this.state.src and !this.state.errorMessage" class="o_video_dialog_preview_text mb-2">Preview</div>
                <div class="media_iframe_video">
                    <div class="media_iframe_video_size"/>
                    <VideoIframe t-if="this.state.src and !this.state.errorMessage" src="this.state.src"/>
                    <div t-if="this.state.errorMessage" class="alert alert-warning o_video_dialog_iframe mw-100 mh-100 mb-2 mt-2" t-esc="this.state.errorMessage"/>
                </div>
            </div>
        </div>
    </div>
</t>
`);
registerTemplateExtension("html_editor.ExternalImage", `/web_unsplash/static/src/media_dialog/media_dialog.xml`, `<t t-inherit="html_editor.ExternalImage" t-inherit-mode="extension" xml:space="preserve">
        <xpath expr="//t[@t-if]" position="after">
            <t t-elif="record.mediaType === 'unsplashRecord'">
                <AutoResizeImage src="record.url" author="record.user.name" authorLink="record.user.links.html" name="record.user.name" title="record.user.name" altDescription="record.alt_description" selected="this.selectedRecordIds.includes(record.id)" onImageClick="() =&gt; this.onClickRecord(record)" minRowHeight="MIN_ROW_HEIGHT" onLoaded="(imgEl) =&gt; this.onImageLoaded(imgEl, record)"/>
            </t>
        </xpath>
    </t>

    `);
registerTemplateExtension("html_editor.ImagesListTemplate", `/web_unsplash/static/src/media_dialog/media_dialog.xml`, `<t t-inherit="html_editor.ImagesListTemplate" t-inherit-mode="extension" xml:space="preserve">
        <xpath expr="//t[@id='o_we_media_library_images']" position="replace">
            <t id="o_we_media_library_images" t-if="['all', 'unsplash', 'media-library'].includes(state.searchService)">
                <t t-foreach="combinedRecords" t-as="record" t-key="record.id">
                    <t t-call="html_editor.ExternalImage"/>
                </t>
            </t>
        </xpath>
    </t>

    `);
registerTemplateExtension("html_editor.FileSelector", `/web_unsplash/static/src/media_dialog/media_dialog.xml`, `<t t-inherit="html_editor.FileSelector" t-inherit-mode="extension" xml:space="preserve">
        <xpath expr="//div[@name='load_more_attachments']" position="before">
            <div t-if="unsplashState?.unsplashError" class="d-flex mt-2 unsplash_error">
                <UnsplashError title="errorTitle" subtitle="errorSubtitle" showCredentials="['key_not_found', 401].includes(unsplashState.unsplashError)" submitCredentials="(key, appId)  =&gt; this.submitCredentials(key, appId)" hasCredentialsError="unsplashState.unsplashError === 401"/>
            </div>
        </xpath>
    </t>

    `);
registerTemplateExtension("html_editor.FileSelector", `/web_unsplash/static/src/media_dialog/media_dialog.xml`, `<t t-inherit="html_editor.FileSelector" t-inherit-mode="extension" xml:space="preserve">
        <xpath expr="//FileSelectorControlPanel" position="attributes">
            <attribute name="useUnsplash">unsplashState?.useUnsplash</attribute>
        </xpath>
    </t>
`);
registerTemplateExtension("html_editor.FileSelectorControlPanel", `/web_unsplash/static/src/media_dialog/media_dialog.xml`, `<t t-inherit="html_editor.FileSelectorControlPanel" t-inherit-mode="extension" xml:space="preserve">
        <xpath expr="//option[@value='media-library']" position="after">
            <option t-if="props.useUnsplash" t-att-selected="props.searchService === 'unsplash'" value="unsplash">Photos (via Unsplash)</option>
        </xpath>
    </t>

    `);
registerTemplate("web_unsplash.UnsplashCredentials", `/web_unsplash/static/src/unsplash_credentials/unsplash_credentials.xml`, `<t t-name="web_unsplash.UnsplashCredentials" xml:space="preserve">
        <div class="d-flex align-items-center flex-wrap">
            <a href="https://www.odoo.com/documentation/latest/applications/websites/website/optimize/unsplash.html#generate-an-unsplash-access-key" class="me-1" target="_blank">Get an Access key</a>
            and paste it here:
            <input type="text" class="o_input o_required_modifier form-control w-auto mx-2" id="accessKeyInput" placeholder="Paste your access key here" t-model="state.key" t-on-input="() =&gt; this.state.hasKeyError = false" t-att-class="{ 'is-invalid': state.hasKeyError }"/>
            and paste
            <a href="https://www.odoo.com/documentation/latest/applications/websites/website/optimize/unsplash.html#generate-an-unsplash-application-id" class="mx-1" target="_blank">Application ID</a>
            here:
            <input type="text" class="o_input o_required_modifier form-control w-auto ms-2" placeholder="Paste your application ID here" t-model="state.appId" t-on-input="() =&gt; this.state.hasAppIdError = false" t-att-class="{ 'is-invalid': state.hasAppIdError }"/>
            <button type="button" class="btn btn-primary w-auto ms-3 p-auto save_unsplash" t-on-click="() =&gt; this.submitCredentials()">Apply</button>
        </div>
    </t>
`);
registerTemplate("web_unsplash.UnsplashError", `/web_unsplash/static/src/unsplash_error/unsplash_error.xml`, `<t t-name="web_unsplash.UnsplashError" xml:space="preserve">
        <div class="alert alert-info w-100">
            <h4><t t-esc="props.title"/></h4>
            <p><t t-esc="props.subtitle"/></p>
            <UnsplashCredentials t-if="props.showCredentials" submitCredentials="props.submitCredentials" hasCredentialsError="props.hasCredentialsError"/>
        </div>
    </t>
`);
registerTemplate("html_editor.HtmlViewer", `/html_editor/static/src/components/html_viewer/html_viewer.xml`, `<t t-name="html_editor.HtmlViewer" xml:space="preserve">
        <t t-if="this.showIframe">
            <iframe t-ref="iframe" t-att-class="{'d-none': !this.state.iframeVisible, 'o_readonly': true}" t-att-sandbox="props.config.hasFullHtml ? 'allow-same-origin allow-popups allow-popups-to-escape-sandbox' : false"/>
        </t>
        <t t-else="">
            <div t-ref="readonlyContent" class="o_readonly" t-out="state.value"/>
        </t>
    </t>
`);
registerTemplate("html_editor.LocalOverlayContainer", `/html_editor/static/src/local_overlay_container.xml`, `<t t-name="html_editor.LocalOverlayContainer" xml:space="preserve">
        <div class="o-wysiwyg-local-overlay position-relative h-0 w-0" t-ref="localOverlay"/>
        <div class="o-wysiwyg-local-overlay position-relative h-0 w-0">
            <t t-foreach="Components.entries" t-as="C" t-key="C[0]">
                <div class="oe-local-overlay" t-att-data-oe-local-overlay-id="C[0]">
                    <ErrorHandler onError="error =&gt; this.handleComponentError(error, C)">
                        <t t-component="C[1].Component" t-props="C[1].props"/>
                    </ErrorHandler>
                </div>
            </t>
        </div>
    </t>
`);
registerTemplate("html_editor.EmbeddedComponentToolbar", `/html_editor/static/src/others/embedded_components/core/embedded_component_toolbar/embedded_component_toolbar.xml`, `<t t-name="html_editor.EmbeddedComponentToolbar" xml:space="preserve">
        <span class="o_embedded_toolbar d-flex justify-content-end align-items-center">
            <span t-attf-class="btn-group d-flex flex-wrap #{ props.buttonsGroupClass ? props.buttonsGroupClass : '' }">
                <t t-slot="buttons"/>
            </span>
        </span>
    </t>
    `);
registerTemplate("html_editor.EmbeddedComponentToolbarButton", `/html_editor/static/src/others/embedded_components/core/embedded_component_toolbar/embedded_component_toolbar.xml`, `<t t-name="html_editor.EmbeddedComponentToolbarButton" xml:space="preserve">
        <button t-if="!props.hidden" t-ref="buttonRef" t-on-click="props.onClick" t-att-name="props.name" t-att-title="props.title" class="btn btn-primary btn-link btn-sm border-0 py-0 text-break text-start text-o-color-2 text-capitalize fw-bold border-transparent bg-transparent">
            <i t-if="props.icon" t-attf-class="fa #{props.icon} me-1"/>
            <span class="o_embedded_toolbar_button_text" t-out="props.label"/>
        </button>
    </t>
`);
registerTemplate("html_editor.ReadonlyEmbeddedFile", `/html_editor/static/src/others/embedded_components/core/file/readonly_file.xml`, `<t t-name="html_editor.ReadonlyEmbeddedFile" t-inherit="html_editor.StaticFileBox" t-inherit-mode="primary" xml:space="preserve">
        <xpath expr="//span[hasclass('o_file_image')]" position="inside">
            <a t-att-href="fileModel.downloadUrl" t-on-click.prevent.stop="onClickFileImage" class="w-100"/>
        </xpath>

        <xpath expr="//span[hasclass('o_file_name_container')]/a" position="replace">
            <span class="o_file_name" t-out="fileModel.filename"/>
        </xpath>

        <xpath expr="//span[hasclass('o_file_name_container')]" position="after">
            <span class="flex-grow-1 d-flex justify-content-end">

                <EmbeddedComponentToolbar>
                    <t t-set-slot="buttons"/>
                </EmbeddedComponentToolbar>
            </span>
        </xpath>

    </t>

`);
registerTemplate("html_editor.StaticFileBox", `/html_editor/static/src/others/embedded_components/core/file/static_file.xml`, `<t t-name="html_editor.StaticFileBox" xml:space="preserve">
        <span class="d-flex flex-grow-1 align-items-center alert alert-info">

            <span class="o_file_image d-flex o_image user-select-none" t-att-title="fileModel.filename" t-att-data-mimetype="fileModel.mimetype"/>

            <span class="o_file_name_container mx-2">
                <a class="o_link_readonly o-contenteditable-true" t-att-href="fileModel.downloadUrl" t-out="fileModel.filename" contenteditable="true"/>
            </span>
        </span>
    </t>
`);
registerTemplate("html_editor.EmbeddedTableOfContent", `/html_editor/static/src/others/embedded_components/core/table_of_content/table_of_content.xml`, `<t t-name="html_editor.EmbeddedTableOfContent" xml:space="preserve">
    <div class="px-1" t-att-class="{ 'pb-1' : !state.folded and state.toc.headings.length }">
        <div class="d-flex align-items-center cursor-pointer user-select-none" t-on-click="() =&gt; { this.state.folded = !this.state.folded; }">
            <div class="o_embedded_toc_label p-1 fw-bold">
                Table of Contents
                <i t-attf-class="align-self-center fa fa-fw fa-caret-#{ state.folded ? 'right' : 'down' }"/>
            </div>
        </div>
        <div t-if="!state.folded" class="o_embedded_toc_content">
            <t t-foreach="this.state.toc.headings" t-as="heading" t-key="heading_index">
                <a href="#" contenteditable="false" t-out="heading.name" t-on-click.prevent="() =&gt; this.onTocLinkClick(heading)" t-attf-class="o_no_link_popover py-1 pe-1 d-block text-reset o_embedded_toc_link #{'o_embedded_toc_link_depth_' + heading.depth}"/>
            </t>
        </div>
    </div>
    <div class="p-1" t-if="displayTocHint()">
        <i class="o_embedded_toc_hint px-1">
            Add headings to fill the Table of Contents
        </i>
    </div>
</t>
`);
registerTemplate("html_editor.EmbeddedToggleBlock", `/html_editor/static/src/others/embedded_components/core/toggle_block/toggle_block.xml`, `<t t-name="html_editor.EmbeddedToggleBlock" xml:space="preserve">
       <div class="d-flex flex-row align-items-center">
            <button class="btn p-0 border-0 align-items-center justify-content-center btn-light" t-on-click="onToggle" type="button">
                <i t-attf-class="fa align-self-center fa-caret-{{this.state.showContent ? 'down' : 'right'}}"/>
            </button>
            <div class="flex-fill ms-1" t-ref="title"/>
        </div>
        <div class="ps-4 ms-1" t-att-class="{ 'd-none': !state.showContent }" t-ref="content"/>
    </t>
`);
registerTemplate("html_editor.EmbeddedVideo", `/html_editor/static/src/others/embedded_components/core/video/readonly_video.xml`, `<t t-name="html_editor.EmbeddedVideo" xml:space="preserve">
        <iframe t-ref="iframeRef" t-att-src="url" title="Video player" frameborder="0" allowfullscreen="allowfullscreen" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share">
            Your browser does not support iframe.
        </iframe>
    </t>
`);
registerTemplate("html_editor.Wysiwyg", `/html_editor/static/src/wysiwyg.xml`, `<t t-name="html_editor.Wysiwyg" xml:space="preserve">
        <div class="o-wysiwyg d-flex flex-column p-0" t-att-class="props.class" t-att-style="props.style">
            <LocalOverlayContainer localOverlay="overlayRef" identifier="env.localOverlayContainerKey"/>
            <div class="flex-grow-1" t-att-class="{'overflow-auto': !props.iframe}">
                <t t-if="props.iframe">
                    <iframe t-ref="content" class="w-100 h-100" t-att-data-class="props.contentClass" t-on-blur="props.onBlur"/>
                </t>
                <t t-else="">
                    <div t-att-class="props.contentClass" t-ref="content" t-on-blur="props.onBlur" contenteditable="true"/>
                </t>
            </div>
        </div>
    </t>
`);
registerTemplate("html_editor.HistoryDialog", `/html_editor/static/src/components/history_dialog/history_dialog.xml`, `<t t-name="html_editor.HistoryDialog" xml:space="preserve">
        <Dialog size="size" title="title" contentClass="'h-100 html-history-dialog-container'" t-on-close="props.close" t-on-cancel="props.close" t-on-confirm="_onRestoreRevisionClick" t-on-after-render="_onAfterRender">
            <div t-attf-class="dialog-container html-history-dialog #{state.revisionLoading ? 'html-history-loading' : 'html-history-loaded'}">
                <div class="revision-list d-flex flex-column align-content-stretch" t-attf-style="max-height: {{state.cssMaxHeight}}px;">
                    <t t-if="!state.revisionsData.length">
                        <div class="text-center w-100 pb-2 pt-0 px-0 fw-bolder">No history</div>
                    </t>

                    <t t-foreach="state.revisionsData" t-as="rev" t-key="rev.revision_id">
                        <a type="object" href="#" role="button" t-attf-title="Show the document submited by #{rev.create_user_name}, on #{this.getRevisionDate(rev)}" t-att-class="this.getRevisionClasses(rev)" t-on-click="() =&gt; this.updateCurrentRevision(rev.revision_id )">
                            <small><t t-esc="this.getRevisionDate(rev)"/></small>
                            <div class="o_avatar">
                                <img class="rounded" t-att-src="this.getRevisionAuthorAvatar(rev)" t-att-alt="rev.create_user_name" t-att-title="rev.create_user_name"/>
                            </div>
                        </a>
                    </t>
                </div>
                <div class="history-container" t-attf-style="max-height: {{state.cssMaxHeight}}px;">
                    <div t-attf-class="history-content-view #{state.currentView === 'content' ? '' : 'd-none'}">
                        <div class="history-view-top-bar">
                            <div>
                                <div class="text-info smaller">
                                    <i class="fa fa-info-circle me-1" title="Version date"/>
                                    Showing the document as it was on <t t-esc="this.getRevisionDate(this.currentRevision)"/>, submited by <t t-esc="this.currentRevision.create_user_name"/>
                                </div>
                            </div>
                            <div>
                                <a type="object" href="#" role="button" class="btn btn-secondary" t-on-click="() =&gt; state.currentView = 'comparison'">
                                    <i class="fa fa-exchange" title="View comparison"/>
                                    View comparison
                                </a>
                            </div>
                        </div>
                        <div class="history-view-inner" t-attf-style="max-height: {{state.cssMaxHeight-20}}px;">
                            <t t-if="state.revisionLoading">
                                <div class="d-flex flex-column justify-content-center align-items-center">
                                    <img src="/web/static/img/spin.svg" alt="Loading..." class="me-2" style="filter: invert(1); opacity: 0.5; width: 30px; height: 30px;"/>
                                    <p class="m-0 text-muted loading-text">
                                        <em>Loading...</em>
                                    </p>
                                </div>
                            </t>
                            <t t-elif="state.revisionContent?.length">
                                <div class="pe-none">
                                    <HtmlViewer config="getConfig('revisionContent')"/>
                                </div>
                            </t>
                            <t t-else="" t-out="props.noContentHelper"/>
                        </div>
                    </div>
                    <div t-attf-class="history-comparison-view #{state.currentView === 'comparison' ? '' : 'd-none'}">
                        <div class="history-view-top-bar">
                            <t t-if="env.debug">
                                <div class="toggle-view-btns">
                                    <div class="btn-group" role="group">
                                        <input type="radio" class="btn-check" name="vbtn-radio" id="unified-view-btn" t-on-click="() =&gt; state.isComparisonSplit = false" t-att-checked="state.isComparisonSplit ? '' : 'checked'"/>
                                        <label class="btn btn-secondary" for="unified-view-btn">Unified view</label>
                                        <input type="radio" class="btn-check" name="vbtn-radio" id="split-view-btn" t-on-click="() =&gt; state.isComparisonSplit = true" t-att-checked="state.isComparisonSplit ? 'checked' : ''"/>
                                        <label class="btn btn-secondary" for="split-view-btn">Split view</label>
                                    </div>
                                </div>
                            </t>
                            <div>
                                <div class="text-info smaller">
                                    <i class="fa fa-info-circle me-1" title="Version date"/>
                                    Showing all differences between the current version and the selected one updated by <t t-esc="this.currentRevision.create_user_name"/> on <t t-esc="this.getRevisionDate(this.currentRevision)"/>
                                </div>
                            </div>
                            <div>
                                <a type="object" href="#" role="button" class="btn btn-secondary" t-on-click="() =&gt; state.currentView = 'content'">
                                    <i class="fa fa-eye" title="View Content"/>
                                    View content
                                </a>
                            </div>
                        </div>
                        <div class="history-view-inner" t-attf-style="max-height: {{state.cssMaxHeight-60}}px;">
                            <t t-if="state.revisionLoading">
                                <div class="d-flex flex-column justify-content-center align-items-center">
                                    <img src="/web/static/img/spin.svg" alt="Loading..." class="me-2" style="filter: invert(1); opacity: 0.5; width: 30px; height: 30px;"/>
                                    <p class="m-0 text-muted loading-text">
                                        <em>Loading...</em>
                                    </p>
                                </div>
                            </t>
                            <t t-elif="state.revisionComparison?.length">
                                <div t-attf-class="history-comparison-split #{state.isComparisonSplit ? '' : 'd-none'}">
                                    <HtmlViewer config="getConfig('revisionComparisonSplit')"/>
                                </div>
                                <div t-attf-class="pe-none history-comparison-unified #{state.isComparisonSplit ? 'd-none' : ''}">
                                    <HtmlViewer config="getConfig('revisionComparison')"/>
                                </div>
                            </t>
                            <t t-else="">
                                <span class="text-muted fst-italic">This is the current version, nothing to compare.</span>
                            </t>
                        </div>
                    </div>
                </div>
            </div>
            <t t-set-slot="footer">
                <button class="btn btn-primary" t-on-click="_onRestoreRevisionClick" t-att-disabled="state.revisionLoading || state.revisionId === -1">Restore history</button>
                <button class="btn btn-secondary" t-on-click="props.close">Discard</button>
            </t>
        </Dialog>
    </t>
`);
registerTemplate("html_editor.AlignSelector", `/html_editor/static/src/main/align/align_selector.xml`, `<t t-name="html_editor.AlignSelector" xml:space="preserve">
        <Dropdown menuClass="'o-we-toolbar-dropdown'" bottomSheet="false" menuRef="menuRef">
            <button class="btn btn-light" t-att-title="props.title" name="text_align">
                <span class="px-1 d-flex align-items-center">
                    <i t-att-class="\`fa fa-align-\${state.displayName}\`"/>
                </span>
            </button>
            <t t-set-slot="content">
                <div data-prevent-closing-overlay="true">
                    <t t-foreach="items" t-as="item" t-key="item_index">
                        <button t-attf-class="btn btn-light fa fa-align-{{item.mode}}" t-att-class="{ active: item.mode === state.displayName }" t-on-click="() =&gt; this.onSelected(item)" t-on-pointerdown.prevent="() =&gt; {}"/>
                    </t>
                </div>
            </t>
        </Dropdown>
    </t>
`);
registerTemplate("html_editor.ChatGPTTranslateDialog", `/html_editor/static/src/main/chatgpt/chatgpt_translate_dialog.xml`, `<t t-name="html_editor.ChatGPTTranslateDialog" xml:space="preserve">
    <Dialog size="'lg'" title.translate="Translate with AI">
        <div t-if="state.translationInProgress" class="d-flex">
            <img src="/web/static/img/spin.svg" alt="Loading..." class="me-2" style="filter:invert(1); opacity: 0.5; width: 30px; height: 30px;"/>
            <p class="m-0 text-muted align-self-center">
                <em>Translating...</em>
            </p>
        </div>
        <t t-else="">
            <t t-set="message" t-value="state.messages[0]"/>
            <div t-att-data-message-id="message.id" t-att-class="message.isError ? 'o-message-error border-danger bg-danger p-2' : ''" class="o-chatgpt-translated">
                <t t-out="formatContent(message.text)"/>
            </div>
        </t>


        <t t-set-slot="footer">
            <button class="btn btn-primary" t-on-click="_confirm" t-att-disabled="state.translationInProgress || state.messages[0].isError">Insert</button>
            <button class="btn btn-secondary" t-on-click="_cancel">Cancel</button>
        </t>
    </Dialog>
</t>
`);
registerTemplate("html_editor.LanguageSelector", `/html_editor/static/src/main/chatgpt/language_selector.xml`, `<t t-name="html_editor.LanguageSelector" xml:space="preserve">
        <t t-if="state.languages.length === 1">
            <t t-call="html_editor.translateButton">
                <t t-set="onClick" t-value="() =&gt; this.onSelected(state.languages[0][1])"/>
            </t>
        </t>
        <Dropdown t-else="" menuRef="menuRef">
            <t t-call="html_editor.translateButton">
                <t t-set="onClick" t-value="() =&gt; {}"/>
            </t>
            <t t-set-slot="content">
                <div data-prevent-closing-overlay="true">
                    <t t-foreach="state.languages" t-as="language" t-key="language[0]">
                        <DropdownItem class="'user-select-none'" onSelected="() =&gt; this.onSelected(language[1])">
                            <div class="lang" t-esc="language[1]"/>
                        </DropdownItem>
                    </t>
                </div>
            </t>
        </Dropdown>
    </t>

    `);
registerTemplate("html_editor.translateButton", `/html_editor/static/src/main/chatgpt/language_selector.xml`, `<t t-name="html_editor.translateButton" xml:space="preserve">
        <button class="btn btn-light" name="translate" t-att-title="props.title" t-att-disabled="props.isDisabled" t-on-click="onClick">

            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="oe-language-icon" version="1.1" id="Layer_1" viewBox="796 796 200 200" enable-background="new 796 796 200 200" xml:space="preserve">
            <g>
                <path d="M973.166,818.5H818.833c-12.591,0-22.833,10.243-22.833,22.833v109.333c0,12.59,10.243,22.833,22.833,22.833h154.333                     c12.59,0,22.834-10.243,22.834-22.833V841.333C996,828.743,985.756,818.5,973.166,818.5z M896,961.5h-77.167                     c-5.973,0-10.833-4.859-10.833-10.833V841.333c0-5.974,4.86-10.833,10.833-10.833H896V961.5z M978.58,872.129                     c-0.547,9.145-5.668,27.261-20.869,39.845c4.615,1.022,9.629,1.573,14.92,1.573v12c-10.551,0-20.238-1.919-28.469-5.325                     c-7.689,3.301-16.969,5.325-28.125,5.325v-12c5.132,0,9.924-0.501,14.366-1.498c-8.412-7.016-13.382-16.311-13.382-26.78h11.999                     c0,8.857,5.66,16.517,14.884,21.623c4.641-2.66,8.702-6.112,12.164-10.351c5.628-6.886,8.502-14.521,9.754-20.042h-49.785v-12                     h22.297v-11.986h12V864.5h21.055c1.986,0,3.902,0.831,5.258,2.28C977.986,868.199,978.697,870.155,978.58,872.129z"/>
                <g>
                    <g>
                        <path d="M839.035,914.262l-4.45,11.258h-15.971l26.355-61.09h15.971l25.746,61.09h-16.583l-4.363-11.258H839.035z                             M852.475,879.876l-8.902,22.604h17.629L852.475,879.876z"/>
                    </g>
                </g>
            </g>
            </svg>
        </button>
    </t>

`);
registerTemplate("html_editor.ColorPickerGradientTab", `/html_editor/static/src/main/font/color_picker_gradient_tab.xml`, `<t t-name="html_editor.ColorPickerGradientTab" xml:space="preserve">
    <t t-set="currentGradient" t-value="getCurrentGradientColor()"/>
    <div class="o_colorpicker_sections p-2 d-grid gap-1" style="grid-template-columns: 1fr 1fr;" t-on-click="props.onColorClick" t-on-mouseover="props.onColorPointerOver" t-on-mouseout="props.onColorPointerOut" t-on-focusin="props.onFocusin" t-on-focusout="props.onFocusout">
        <t t-set="gradientsWithOpacity" t-value="DEFAULT_GRADIENT_COLORS.map((gradient) =&gt; applyOpacityToGradient(gradient, props.defaultOpacity))"/>
        <t t-foreach="gradientsWithOpacity" t-as="gradient" t-key="gradient">
            <button class="w-100 m-0 o_color_button o_color_picker_button o_gradient_color_button btn p-0" t-att-class="{'selected': currentGradient?.includes(gradient)}" t-attf-style="background-image: #{gradient};" t-att-data-color="gradient"/>
        </t>
    </div>
    <div class="px-2">
        <button t-attf-style="{{ currentGradient ? \`background-image: \${currentGradient}\` : '' }};" class="w-50 btn mb-2 o_custom_gradient_button o_color_picker_button" t-att-class="{'selected': currentGradient and !gradientsWithOpacity.includes(currentGradient)}" t-att-data-color="currentGradient" t-on-click="toggleGradientPicker" title="Define a custom gradient">
            Custom
        </button>
        <GradientPicker t-if="state.showGradientPicker" onGradientChange.bind="props.applyColor" onGradientPreview.bind="props.onColorPreview" setOnCloseCallback.bind="props.setOnCloseCallback" setOperationCallbacks.bind="props.setOperationCallbacks" selectedGradient="getCurrentGradientColor()" noTransparency="props.noTransparency"/>
    </div>
</t>
`);
registerTemplate("html_editor.ColorSelector", `/html_editor/static/src/main/font/color_selector.xml`, `<t t-name="html_editor.ColorSelector" xml:space="preserve">
    <button t-ref="root" class="btn btn-light" t-attf-class="o-select-color-{{props.type}} {{this.colorPicker.isOpen ? 'active' : ''}}" t-att-title="props.title" t-att-disabled="props.isDisabled">
        <t t-if="props.type === 'foreground'">
            <i class="fa fa-fw fa-font py-1" t-att-style="this.getSelectedColorStyle()"/>
        </t>
        <t t-else="">
            <i class="fa fa-fw fa-paint-brush py-1" t-att-style="this.getSelectedColorStyle()"/>
        </t>
    </button>
</t>

`);
registerTemplate("html_editor.FontFamilySelector", `/html_editor/static/src/main/font/font_family_selector.xml`, `<t t-name="html_editor.FontFamilySelector" xml:space="preserve">
        <Dropdown menuClass="'o_font_family_selector_menu'" menuRef="menuRef">
            <button class="btn btn-light" t-att-title="props.title" name="font_family" t-att-disabled="props.isDisabled">
                <span class="px-1" t-esc="props.currentFontFamily.displayName"/>
            </button>
            <t t-set-slot="content">
                <div data-prevent-closing-overlay="true">
                    <t t-foreach="props.fontFamilyItems" t-as="item" t-key="item_index">
                        <DropdownItem attrs="{ name: item.nameShort }" onSelected="() =&gt; props.onSelected(item)" t-on-pointerdown.prevent="() =&gt; {}">
                            <t t-esc="item.name"/>
                        </DropdownItem>
                    </t>
                </div>
            </t>
        </Dropdown>
    </t>
`);
registerTemplate("html_editor.FontSelector", `/html_editor/static/src/main/font/font_selector.xml`, `<t t-name="html_editor.FontSelector" xml:space="preserve">
        <Dropdown menuClass="'o_font_selector_menu'" menuRef="menuRef">
            <button class="btn btn-light" t-att-title="props.title" name="font" t-att-disabled="props.isDisabled">
                <span class="px-1" t-esc="state.displayName"/>
            </button>
            <t t-set-slot="content">
                <div data-prevent-closing-overlay="true">
                    <t t-foreach="items" t-as="item" t-key="item_index">
                        <DropdownItem attrs="{ name: item.tagName }" onSelected="() =&gt; this.onSelected(item)" t-on-pointerdown.prevent="() =&gt; {}">
                            <t t-esc="item.name"/>
                        </DropdownItem>
                    </t>
                </div>
            </t>
        </Dropdown>
    </t>
`);
registerTemplate("html_editor.FontSizeSelector", `/html_editor/static/src/main/font/font_size_selector.xml`, `<t t-name="html_editor.FontSizeSelector" xml:space="preserve">
        <Dropdown state="dropdown" menuClass="'o_font_size_selector_menu'" menuRef="menuRef">
            <button class="btn btn-light" t-att-title="props.title" name="font_size_selector" t-att-disabled="props.isDisabled">
                <iframe t-ref="iframeContent" style="width: 4ch; height:100%;"/>
            </button>
            <t t-set-slot="content">
                <div data-prevent-closing-overlay="true">
                    <t t-foreach="items" t-as="item" t-key="item_index">
                        <DropdownItem onSelected="() =&gt; this.onSelected(item)" t-on-pointerdown.prevent="() =&gt; {}">
                            <t t-out="item.name"/>
                        </DropdownItem>
                    </t>
                </div>
            </t>
        </Dropdown>
    </t>
`);
registerTemplate("html_editor.GradientPicker", `/html_editor/static/src/main/font/gradient_picker/gradient_picker.xml`, `<t t-name="html_editor.GradientPicker" xml:space="preserve">
        <div class="d-flex flex-column">

            <div class="align-items-center d-flex justify-content-between my-2 o_type_row">
                Type
                <span class="d-flex justify-content-between">
                    <button t-attf-class="btn btn-sm btn-light {{ this.state.type === 'linear' ? 'active' : ''}}" t-on-click="() =&gt; this.selectType('linear')"> Linear </button>
                    <button t-attf-class="btn btn-sm btn-light {{ this.state.type === 'radial' ? 'active' : ''}}" t-on-click="() =&gt; this.selectType('radial')"> Radial </button>
                </span>
            </div>

            <div t-if="this.state.type === 'linear'" class="d-flex align-items-center justify-content-between mb-1">
                Angle
                <span class="d-flex justify-content-between align-items-center">
                    <div class="d-flex justify-content-center align-items-center my-auto me-2 position-relative gradient-angle-knob" t-ref="gradientAngleKnob" t-attf-style="--angle: #{this.state.angle}deg;" t-on-mousedown="onKnobMouseDown">
                        <div class="position-absolute gradient-angle-thumb"/>
                    </div>
                    <div class="o_color_gradient_input d-flex align-items-center">
                        <input name="angle" type="number" min="0" max="360" t-att-value="this.state.angle" t-on-change="onAngleChange"/>
                        <label class="flex-grow-0 ms-1 mb-0">deg</label>
                    </div>
                </span>
            </div>
            <div t-else="" class="d-flex flex-column gap-1 mb-1">
                Size
                <div class="d-flex align-items-center justify-content-between">
                    <button t-on-click="() =&gt; this.onSizeChange('closest-side')" t-attf-class="btn btn-light p-0 {{ this.state.size === 'closest-side' ? \`active\` : ''}}" title="Extend to the closest side">
                        <svg xmlns="http://www.w3.org/2000/svg" width="45" height="45" viewBox="0 0 16 20" fill="none">
                            <rect x="1.5" y="3.5" width="13" height="13" stroke="#AAAAAD"/>
                            <path d="M3 4H9V8C9 8.55228 8.55228 9 8 9H4C3.44772 9 3 8.55228 3 8V4Z" fill="#8C8C92"/>
                            <path d="M6 11C7.65685 11 9 9.65685 9 8C9 6.34315 7.65685 5 6 5C4.34315 5 3 6.34315 3 8C3 9.65685 4.34315 11 6 11Z" fill="#74747B"/>
                            <path d="M6 10C7.10457 10 8 9.10457 8 8C8 6.89543 7.10457 6 6 6C4.89543 6 4 6.89543 4 8C4 9.10457 4.89543 10 6 10Z" fill="white"/>
                            <rect x="2" y="3" width="12" height="1" fill="white"/>
                        </svg>
                    </button>
                    <button t-on-click="() =&gt; this.onSizeChange('closest-corner')" t-attf-class="btn btn-light p-0 {{ this.state.size === 'closest-corner' ? \`active\` : ''}}" title="Extend to the closest corner">
                        <svg xmlns="http://www.w3.org/2000/svg" width="45" height="45" viewBox="0 0 16 20" fill="none">
                            <rect x="1.5" y="3.5" width="13" height="13" stroke="#AAAAAD"/>
                            <path d="M2 4H9V7C9 9.20914 7.20914 11 5 11H2V4Z" fill="#8C8C92"/>
                            <path d="M6 11C7.65685 11 9 9.65685 9 8C9 6.34315 7.65685 5 6 5C4.34315 5 3 6.34315 3 8C3 9.65685 4.34315 11 6 11Z" fill="#74747B"/>
                            <path d="M6 10C7.10457 10 8 9.10457 8 8C8 6.89543 7.10457 6 6 6C4.89543 6 4 6.89543 4 8C4 9.10457 4.89543 10 6 10Z" fill="white"/>
                            <rect x="1" y="3" width="8" height="1" fill="white"/>
                            <rect x="1" y="11" width="8" height="1" transform="rotate(-90 1 11)" fill="white"/>
                        </svg>
                    </button>
                    <button t-on-click="() =&gt; this.onSizeChange('farthest-side')" t-attf-class="btn btn-light p-0 {{ this.state.size === 'farthest-side' ? \`active\` : ''}}" title="Extend to the farthest side">
                        <svg xmlns="http://www.w3.org/2000/svg" width="45" height="45" viewBox="0 0 16 20" fill="none">
                            <rect x="1.5" y="3.5" width="13" height="13" stroke="#AAAAAD"/>
                            <path d="M7 12C10.3137 12 14 10.2091 14 8C14 5.79086 10.3137 4 7 4C3.68629 4 2 5.79086 2 8C2 10.2091 3.68629 12 7 12Z" fill="#8C8C92"/>
                            <path d="M6 11C7.65685 11 9 9.65685 9 8C9 6.34315 7.65685 5 6 5C4.34315 5 3 6.34315 3 8C3 9.65685 4.34315 11 6 11Z" fill="#74747B"/>
                            <path d="M6 10C7.10457 10 8 9.10457 8 8C8 6.89543 7.10457 6 6 6C4.89543 6 4 6.89543 4 8C4 9.10457 4.89543 10 6 10Z" fill="white"/>
                            <rect x="14" y="4" width="1" height="12" fill="white"/>
                        </svg>
                    </button>
                    <button t-on-click="() =&gt; this.onSizeChange('farthest-corner')" t-attf-class="btn btn-light p-0 {{ this.state.size === 'farthest-corner' ? \`active\` : ''}}" title="Extend to the farthest corner">
                        <svg xmlns="http://www.w3.org/2000/svg" width="45" height="45" viewBox="0 0 16 20" fill="none">
                            <rect x="1.5" y="3.5" width="13" height="13" stroke="#AAAAAD"/>
                            <path d="M2 4H14V10C14 13.3137 11.3137 16 8 16H2V4Z" fill="#8C8C92"/>
                            <path d="M6 11C7.65685 11 9 9.65685 9 8C9 6.34315 7.65685 5 6 5C4.34315 5 3 6.34315 3 8C3 9.65685 4.34315 11 6 11Z" fill="#74747B"/>
                            <path d="M6 10C7.10457 10 8 9.10457 8 8C8 6.89543 7.10457 6 6 6C4.89543 6 4 6.89543 4 8C4 9.10457 4.89543 10 6 10Z" fill="white"/>
                            <rect x="15" y="17" width="7" height="0.999999" transform="rotate(-180 15 17)" fill="white"/>
                            <rect x="15" y="10" width="7" height="1" transform="rotate(90 15 10)" fill="white"/>
                        </svg>
                    </button>
                </div>
                <div class="d-flex align-items-center justify-content-between">
                    Position X
                    <span class="o_color_gradient_input">
                        <input name="positionX" type="number" min="0" max="100" t-att-value="this.positions['x']" t-on-change="(ev) =&gt; this.onPositionChange('x', ev)"/>
                    </span>
                </div>
                <div class="d-flex align-items-center justify-content-between">
                    Position Y
                    <span class="o_color_gradient_input">
                        <input name="positionY" type="number" min="0" max="100" t-att-value="this.positions['y']" t-on-change="(ev) =&gt; this.onPositionChange('y', ev)"/>
                    </span>
                </div>
            </div>

            <div class="custom-gradient-configurator">
                 <div class="gradient-checkers"/>
                <div class="gradient-preview" t-attf-style="background-image: #{this.cssGradients.preview};" t-on-click="this.onGradientPreviewClick">
                </div>
                <style><t t-out="this.cssGradients.sliderThumbStyle"/></style>
                <div class="gradient-colors">
                    <div t-foreach="this.colors" t-as="color" t-key="color_index">
                        <input type="range" min="0" max="100" t-att-value="color.percentage" t-att-class="{'active': this.state.currentColorIndex === color_index}" t-attf-name="custom gradient percentage color #{color_index+1}" t-on-click="() =&gt; this.state.currentColorIndex = color_index" t-on-change="(ev) =&gt; this.onColorPercentageChange(color_index, ev)"/>
                    </div>
                </div>
                <div class="gradient-color-bin">
                    <t t-if="this.colors.length &gt; 2">
                        <a t-on-click="() =&gt; this.removeColor(this.state.currentColorIndex)" t-attf-style="left: #{this.colors[this.state.currentColorIndex].percentage}%" type="button" class="btn btn-sm btn-light"><i class="fa fa-fw fa-trash" role="img"/></a>
                    </t>
                </div>
            </div>

            <ColorPicker onColorSelect.bind="onColorChange" onColorPreview.bind="onColorPreview" setOnCloseCallback.bind="props.setOnCloseCallback" setOperationCallbacks.bind="props.setOperationCallbacks" defaultColor="this.currentColorHex" selectedColor="this.currentColorHex" noTransparency="props.noTransparency"/>
        </div>
    </t>
`);
registerTemplate("html_editor.linkPopover", `/html_editor/static/src/main/link/link_popover.xml`, `<t t-name="html_editor.linkPopover" xml:space="preserve">
        <div class="o-we-linkpopover d-flex bg-light overflow-auto shadow" t-on-keydown="onKeydown" role="dialog" aria-modal="true" aria-label="Link Popover">
            <div t-if="state.editing" class="container-fluid d-flex vertical-center p-2" t-ref="editing-wrapper">
                <div t-if="state.isImage" class="col p-2 o_link_popover_container">
                    <div class="input-group mb-1">
                        <input name="o_linkpopover_url_img" t-ref="url" class="o_we_href_input_link border-dark-subtle form-control form-control-sm" t-model="state.url" title="URL" placeholder="Type your URL" t-on-keydown="onKeydownEnter"/>
                        <button class="o_we_apply_link btn btn-sm btn-primary" t-att-class="{'mx-1': state.type ===  ''}" t-on-click="onClickApply">Apply</button>
                    </div>
                </div>
                <div t-else="" class="d-flex">
                    <t t-if="state.showAdvancedOptions">
                        <div class="o_advance_option_panel">
                            <div class="o_advance_options_grid" style="width: 200px;">
                                <button t-if="state.showAdvancedOptions" class="fa fa-angle-left btn btn-secondary border-10" t-on-click="toggleAdvancedOptions"/>
                                    <t t-foreach="Object.values(state.relAttributeOptions)" t-as="opt" t-key="opt.label">
                                        <t t-if="opt.label !== 'noopener'">
                                            <div class="o_seo_option_row d-flex justify-content-between align-items-center py-1 gap-2">
                                                <span t-att-title="opt.description"><t t-out="opt.label"/></span>
                                                <CheckBox value="opt.isChecked" onChange="toggleRelAttr.bind(this, opt.label)"/>
                                            </div>
                                        </t>
                                    </t>
                                <div class="o_seo_option_row d-flex justify-content-between align-items-center py-1 gap-2">
                                    <span>Open in new tab</span>
                                    <CheckBox value="state.linkTarget === '_blank'" onChange="onClickNewWindow.bind(this)" className="'target-blank-option'"/>
                                </div>
                                <t t-if="state.linkTarget === '_blank'">
                                    <div class="o_seo_option_row o_seo_option_child d-flex justify-content-between align-items-center py-1 gap-2 ps-4">
                                        <span>noopener</span>
                                        <CheckBox value="state.relAttributeOptions.noopener.isChecked" onChange="toggleRelAttr.bind(this, 'noopener')"/>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </t>
                <t t-else="">
                    <div class="col p-2 o_link_popover_container">
                        <div class="input-group mb-2" t-att-class="{'d-none': !state.showLabel}">
                            <input t-ref="label" class="o_we_label_link border-dark-subtle form-control form-control-sm" t-model="state.label" title="Label" placeholder="Add a label for your link" t-on-input="onChange"/>
                        </div>
                        <div class="input-group mb-2">
                            <input t-ref="url" name="o_linkpopover_url" class="o_we_href_input_link border-dark-subtle form-control form-control-sm" t-model="state.url" title="URL" placeholder="e.g. https://www.odoo.com" t-on-keydown="onKeydownEnter" t-on-input="this.onChange"/>
                            <span class="ms-1" t-if="props.canUpload and !state.url">
                                or <button class="btn btn-light btn-sm" t-on-click="uploadFile"><i class="fa fa-upload"/></button>
                            </span>

                        </div>
                        <div class="input-group">
                            <select name="link_type" class="form-select form-select-sm border-dark-subtle w-100 mb-1" t-model="state.type" t-on-change="onChange">
                                <t t-foreach="this.colorsData" t-as="colorData" t-key="colorData.type">
                                    <t t-if="props.allowCustomStyle or colorData.type !== 'custom'">
                                        <option t-att-value="colorData.type" t-att-selected="state.type === colorData.type" t-attf-class="o_btn_preview" t-out="colorData.label"/>
                                    </t>
                                </t>
                            </select>
                        </div>
                        <div t-if="state.type" class="input-group">
                            <select name="link_style_size" class="form-select form-select-sm border-dark-subtle mb-1" t-model="state.buttonSize" t-on-change="onChange" aria-label="Select button size">
                                <option t-foreach="this.buttonSizesData" t-as="buttonSizesData" t-key="buttonSizesData.size" t-att-value="buttonSizesData.size" t-att-selected="state.buttonSize === buttonSizesData.size" t-out="buttonSizesData.label"/>
                            </select>
                            <select name="link_style_shape" class="form-select form-select-sm link-style border-dark-subtle mb-1" t-model="state.buttonShape" t-on-change="onChange" aria-label="Select button shape">
                                <option t-foreach="this.buttonShapeData" t-as="buttonShapeData" t-key="buttonShapeData.shape" t-att-value="buttonShapeData.shape" t-att-selected="state.buttonShape === buttonShapeData.shape" t-out="buttonShapeData.label"/>
                            </select>
                        </div>

                        <t t-if="state.type === 'custom'">
                            <div class="d-flex mb-1 custom-text-color">
                                <label>Text Color</label>
                                <button class="o_we_color_preview custom-text-picker me-3" t-att-data-color="this.customTextColorState.selectedColor" t-ref="customTextColorButton" t-attf-style="background-color: {{this.props.formatColor(this.customTextColorState.selectedColor)}}"/>
                                <label>Fill Color</label>
                                <button class="o_we_color_preview custom-fill-picker" t-att-data-color="this.customFillColorState.selectedColor" t-ref="customFillColorButton" t-attf-style="{{this.customFillColorState.selectedColor?.includes('gradient') ? 'background-image' : 'background-color'}}: {{this.props.formatColor(this.customFillColorState.selectedColor)}}"/>
                            </div>
                            <div class="d-flex mb-1 custom-border align-items-center">
                                <label class="flex-shrink-0">Border</label>
                                <div class="input-group me-1">
                                    <input type="number" min="0" class="form-control form-control-sm custom-border-size flex-grow-0" t-model="state.customBorderSize" placeholder="Border Size" t-on-keydown="onKeydownEnter" t-on-input="onInput"/>
                                    <span class="input-group-text">px</span>
                                </div>
                                <div class="d-flex align-items-center" t-if="state.customBorderSize &gt; 0">
                                    <select name="link_style_border" class="form-select form-select-sm custom-border-style me-1" t-model="state.customBorderStyle" t-on-change="onChange">
                                        <t t-foreach="this.borderData" t-as="borderData" t-key="borderData.style">
                                            <option t-att-value="borderData.style" t-att-selected="state.customBorderStyle === borderData.style">
                                                <span t-esc="borderData.label"/>
                                            </option>
                                        </t>
                                    </select>
                                    <button class="o_we_color_preview custom-border-picker" t-att-data-color="this.customBorderColorState.selectedColor" t-ref="customBorderColorButton" t-attf-style="background-color: {{this.props.formatColor(this.customBorderColorState.selectedColor)}}"/>
                                </div>
                            </div>
                        </t>
                        <t t-if="props.allowTargetBlank">
                            <t t-if="state.isDocument">
                                <CheckBox value="state.directDownload" onChange="onClickDirectDownload.bind(this)" className="'direct-download-option'">
                                    Direct download
                                </CheckBox>
                            </t>
                        </t>
                        <t t-if="props.allowStripDomain and isAbsoluteURLInCurrentDomain()">
                            <CheckBox value="state.stripDomain" onChange="onClickStripDomain.bind(this)" className="'strip-domain-option'">
                                Autoconvert to relative link
                            </CheckBox>
                        </t>
                        <div class="d-flex justify-content-between align-items-center mt-1">
                            <div>
                                <button class="o_we_apply_link btn btn-sm btn-primary" t-att-disabled="!state.url" t-on-click="onClickApply">Apply</button>
                                <button class="o_we_discard_link btn btn-sm btn-secondary ms-1" t-on-click="props.onDiscard">Discard</button>
                            </div>
                            <div class="d-flex align-items-center gap-1">
                                <a t-if="props.canRemove and state.url" href="#" class="o_we_remove_link text-dark d-flex me-1" t-on-click.prevent="onClickRemove" title="Remove Link">
                                    <i class="fa fa-chain-broken"/>
                                </a>
                                <button class="btn btn-sm btn-secondary" title="Advanced mode" t-att-disabled="!state.url" t-on-click="toggleAdvancedOptions">
                                    <i class="fa fa-gear"/>
                                </button>
                            </div>
                        </div>
                    </div>
                </t>
            </div>
        </div>
            <div t-else="" style="width: 274px;" data-prevent-closing-overlay="true">
                <div class="d-flex flex-column p-2">
                    <div class="d-flex">
                        <span class="o_we_preview_favicon" style="width: 16px; height: 32px">
                            <img t-if="state.previewIcon.type === 'imgSrc'" t-att-src="state.previewIcon.value" class="align-content-center"/>
                            <span t-elif="state.previewIcon.type === 'mimetype'" class="o_image" t-att-data-mimetype="state.previewIcon.value"/>
                            <i t-else="" t-attf-class="fa fa-fw {{state.previewIcon.value}}"/>
                        </span>
                        <div class="ms-1 w-100">
                            <div class="d-flex">
                                <a href="#" target="_blank" t-attf-href="{{state.url}}" class="o_we_url_link fw-bold flex-grow-1 text-truncate" style="max-width: 160px;" t-attf-title="{{state.urlTitle}}">
                                    <t t-esc="state.urlTitle"/>
                                </a>
                                <div class="flex-grow-1 d-flex justify-content-end align-items-center gap-1">
                                    <a href="#" class="mx-1 o_we_replace_title_btn text-dark" t-if="!state.isImage and state.urlTitle and state.label === '' and !state.showReplaceTitleBanner" t-on-click="onClickReplaceTitle" title="Replace URL with its title">
                                        <i class="fa fa-magic"/>
                                    </a>
                                    <t t-if="props.canEdit">
                                        <a href="#" class="o_we_edit_link btn btn-sm btn-secondary" t-on-click="onClickEdit" title="Edit Link">Edit</a>
                                    </t>
                                </div>
                            </div>
                            <div t-if="state.urlTitle and state.url and state.urlTitle !== state.url" class="text-truncate" style="max-width: 200px; font-size: 12px;">
                                <span t-attf-class="o_we_full_url text-muted o_we_webkit_box" t-attf-title="{{state.url}}">
                                    <t t-if="state.url" t-esc="state.url"/>
                                    <t t-else="">No URL specified</t>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div t-if="state.imgSrc" class="o_extra_info_card" style="align-self: center; max-width: 235px">
                            <a href="#" target="_blank" t-attf-href="{{state.url}}" title="Open in a new tab">
                                <img t-att-src="state.imgSrc" class="img-fluid mb-1" style="max-width: 230; max-height: 100%;"/>
                            </a>
                    </div>
                    <div t-if="state.urlDescription" class="d-flex">
                        <i class="fa fa-align-right align-content-center"/>
                        <span class="ms-1 o_we_description_link_preview" style="display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; font-size: 12px;color: gray; overflow: hidden;" t-attf-title="{{state.urlDescription}}">
                            <t t-esc="state.urlDescription"/>
                        </span>
                    </div>
                </div>
                <div t-if="!state.isImage and state.urlTitle and state.label === '' and state.showReplaceTitleBanner" class="d-flex align-items-baseline" style="background-color: var(--primary);">
                    <i class="fa fa-magic fa-fw m-1" style="color: var(--o-cc1-btn-primary-text);"/>
                    <span class="me-2 flex-grow-1" style="color: var(--o-cc1-btn-primary-text);font-size: smaller;">Replace URL with its title?</span>
                    <button class=" btn btn-sm btn-primary o_we_replace_title_btn" style="margin: 1px;font-size: smaller;" t-on-click="onClickReplaceTitle">Yes</button>
                </div>
            </div>
        </div>
    </t>

`);
registerTemplate("html_editor.ListSelector", `/html_editor/static/src/main/list/list_selector.xml`, `<t t-name="html_editor.ListSelector" xml:space="preserve">
        <Dropdown menuClass="'o-we-toolbar-dropdown'" bottomSheet="false" menuRef="menuRef">
            <button class="btn btn-light fa fa-list-ul" t-att-title="props.title" name="list_selector"/>
            <t t-set-slot="content" t-key="props.key.value">
                <div data-prevent-closing-overlay="true">
                    <t t-set="activeMode" t-value="getActiveMode()"/>
                    <t t-foreach="props.getButtons()" t-as="button" t-key="button_index">
                        <button t-att-title="button.description" t-att-name="button.id" t-attf-class="btn btn-light fa {{button.icon}}" t-att-class="{ active: activeMode === button.mode }" t-on-click="button.run"/>
                    </t>
                </div>
            </t>
        </Dropdown>
    </t>
`);
registerTemplate("html_editor.ImageCrop", `/html_editor/static/src/main/media/image_crop.xml`, `<t t-name="html_editor.ImageCrop" xml:space="preserve">
        <div class="o_we_crop_widget" contenteditable="false" t-ref="el" t-on-zoom="this.onCropZoom">
            <div class="o_we_cropper_wrapper" t-ref="cropperWrapper">
                <img class="o_we_cropper_img" t-ref="imageRef"/>
                <div class="o_we_crop_buttons text-center mt16 position-fixed o_we_no_overlay" contenteditable="false">
                    <div class="btn-group btn-group-toggle" title="Aspect Ratio" data-bs-toggle="buttons">
                        <t t-foreach="this.aspectRatios" t-as="ratio" t-key="ratio">
                            <t t-set="is_active" t-value="ratio === this.aspectRatio"/>
                            <label t-attf-class="btn #{is_active and 'active' or ''}" t-on-click="() =&gt; this.setAspectRatio(ratio)">
                                <input type="radio"/><t t-esc="ratio_value.label"/>
                            </label>
                        </t>
                    </div>
                    <div class="btn-group" role="group">
                        <button type="button" title="Zoom In" t-on-click="() =&gt; this.onZoom(0.1)"><i class="fa fa-fw fa-search-plus"/></button>
                        <button type="button" title="Zoom Out" t-on-click="() =&gt; this.onZoom(-0.1)"><i class="fa fa-fw fa-search-minus"/></button>
                    </div>
                    <div class="btn-group" role="group">
                        <button type="button" title="Rotate Left" t-on-click="() =&gt; this.onRotate(-90)"><i class="fa fa-fw fa-rotate-left"/></button>
                        <button type="button" title="Rotate Right" t-on-click="() =&gt; this.onRotate(90)"><i class="fa fa-fw fa-rotate-right"/></button>
                    </div>
                    <div class="btn-group" role="group">
                        <button type="button" title="Flip Horizontal" t-on-click="() =&gt; this.onFlip('scaleX')"><i class="oi oi-fw oi-arrows-h"/></button>
                        <button type="button" title="Flip Vertical" t-on-click="() =&gt; this.onFlip('scaleY')"><i class="oi oi-fw oi-arrows-v"/></button>
                    </div>
                    <div class="btn-group" role="group">
                        <button type="button" title="Reset Image" t-on-click="this.onReset"><i class="fa fa-refresh"/> Reset Image</button>
                    </div>
                    <div class="btn-group" role="group">
                        <button type="button" t-on-click="this.save" class="btn btn-primary"><i class="fa fa-check" role="presentation"/> Apply</button>
                        <button type="button" t-on-click="this.closeCropper" class="btn btn-danger"><i class="oi oi-close" role="presentation"/> Discard</button>
                    </div>
                </div>
            </div>
        </div>
    </t>
`);
registerTemplate("html_editor.ImageDescription", `/html_editor/static/src/main/media/image_description.xml`, `<t t-name="html_editor.ImageDescription" xml:space="preserve">
        <button class="btn btn-light" t-att-title="props.title" t-on-click="this.props.openImageDescriptionPopover">
            Description
        </button>
    </t>

    `);
registerTemplate("html_editor.ImageDescriptionPopover", `/html_editor/static/src/main/media/image_description.xml`, `<t t-name="html_editor.ImageDescriptionPopover" xml:space="preserve">
        <div class="o-we-image-description-popover p-3">
            <input t-ref="description" type="text" t-model="this.state.description" placeholder="Description" title="'Alt tag' specifies an alternate text for an image, if the image cannot be displayed (slow connection, missing image, screen reader ...)." name="description" class="border-dark-subtle form-control mb-2"/>
            <input type="text" t-model="this.state.tooltip" placeholder="Tooltip" title="'Title tag' is shown as a tooltip when you hover the picture." name="tooltip" class="border-dark-subtle form-control mb-2"/>
            <div class="mt-3">
                <button class="o_we_apply_link btn btn-sm btn-primary" t-on-click="this.onSave">Apply</button>
                <button class="o_we_discard_link btn btn-sm btn-dark ms-1" t-on-click="this.props.close">Discard</button>
            </div>
        </div>
    </t>
`);
registerTemplate("html_editor.ImageToolbarDropdown", `/html_editor/static/src/main/media/image_toolbar_dropdown.xml`, `<t t-name="html_editor.ImageToolbarDropdown" xml:space="preserve">
        <Dropdown menuClass="\`\${props.name}_selector\`" menuRef="menuRef">
            <button t-att-title="props.title" class="btn btn-light">
                <t t-if="props.icon" t-call="{{props.icon}}"/>
                <t t-elif="state &amp;&amp; state.displayName" t-esc="state.displayName"/>
                <t t-else="" t-esc="props.title"/>
            </button>
            <t t-set-slot="content">
                <t t-foreach="items" t-as="item" t-key="item_index">
                    <DropdownItem class="'user-select-none'" onSelected="() =&gt; this.onSelected(item)">
                        <t t-esc="item.name"/>
                    </DropdownItem>
                </t>
            </t>
        </Dropdown>
    </t>

    `);
registerTemplate("html_editor.ImagePaddingIcon", `/html_editor/static/src/main/media/image_toolbar_dropdown.xml`, `<t t-name="html_editor.ImagePaddingIcon" xml:space="preserve">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" width="20" height="20" stroke-width="2">
            <path d="M4 4m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z"/>
            <path d="M8 16v.01"/>
            <path d="M8 12v.01"/>
            <path d="M8 8v.01"/>
            <path d="M16 16v.01"/>
            <path d="M16 12v.01"/>
            <path d="M16 8v.01"/>
            <path d="M12 8v.01"/>
            <path d="M12 16v.01"/>
        </svg>
    </t>
`);
registerTemplate("html_editor.ImageTransformButton", `/html_editor/static/src/main/media/image_transform_button.xml`, `<t t-name="html_editor.ImageTransformButton" xml:space="preserve">
        <button class="btn btn-light" t-att-class="{active: state.active, disabled: props.isDisabled}" t-att-title="state.active ? props.activeTitle : props.title" t-att-name="props.id" t-on-click="onButtonClick">
            <span class="fa fa-fw" t-att-class="props.icon"/>
        </button>
    </t>
`);
registerTemplate("html_editor.ImageTransformation", `/html_editor/static/src/main/media/image_transformation.xml`, `<t t-name="html_editor.ImageTransformation" xml:space="preserve">
        <div class="transfo-container" t-ref="transfoContainer" t-on-mousedown.prevent="mouseDown">
            <div class="transfo-controls" t-ref="transfoControls">
                <div style="cursor: crosshair; position: absolute; margin: -30px; top: 0; right: 0; padding: 1px 0 0 1px;" class="transfo-rotator">
                    <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"/>
                    <i class="fa fa-repeat fa-stack-1x fa-inverse"/>
                    </span>
                </div>
                <div style="top: 0%; left: 0%; cursor: nw-resize;" class="transfo-scaler transfo-scaler-tl"/>
                <div style="top: 0%; left: 100%; cursor: ne-resize;" class="transfo-scaler transfo-scaler-tr"/>
                <div style="top: 100%; left: 100%; cursor: se-resize;" class="transfo-scaler transfo-scaler-br"/>
                <div style="top: 100%; left: 0%; cursor: sw-resize;" class=" transfo-scaler transfo-scaler-bl"/>
                <div style="top: 0%; left: 50%; cursor: n-resize;" class="transfo-scaler transfo-scaler-tc"/>
                <div style="top: 100%; left: 50%; cursor: s-resize;" class="transfo-scaler transfo-scaler-bc"/>
                <div style="top: 50%; left: 0%; cursor: w-resize;" class="transfo-scaler transfo-scaler-ml"/>
                <div style="top: 50%; left: 100%; cursor: e-resize;" class="transfo-scaler transfo-scaler-mr"/>
                <div style="border: 0; width: 0px; height: 0px; top: 50%; left: 50%;" class="transfo-scaler transfo-scaler-mc" t-ref="transfoCenter"/>
            </div>
        </div>
    </t>
`);
registerTemplate("html_editor.Powerbox", `/html_editor/static/src/main/powerbox/powerbox.xml`, `<t t-name="html_editor.Powerbox" xml:space="preserve">
        <div t-ref="root" class="o-we-powerbox py-2 bg-light overflow-auto my-1" style="width:300px;max-height:40vh;" t-on-mousedown.stop="" t-on-scroll="onScroll">
            <t t-foreach="commands" t-as="command" t-key="command_index">
                <t t-if="showCategories and command.categoryId !== lastCategory">
                    <div class="o-we-category mx-3 my-1 text-uppercase"><t t-esc="command.categoryName"/></div></t>
                    <t t-set="lastCategory" t-value="command.categoryId">
                </t>
                <div class="o-we-command d-flex align-items-center px-3 py-2 cursor-pointer" t-att-class="{active: command_index === currentIndex}" t-on-mouseenter="() =&gt; this.onMouseEnter(command_index)" t-on-mousedown="(ev) =&gt; ev.preventDefault()" t-on-click="() =&gt; this.props.applyCommand(command)">
                    <div class="border rounded">
                        <i class="o-we-command-img d-flex align-items-center justify-content-center fa" t-att-class="command.icon"/>
                    </div>
                    <div class="ms-3">
                        <div class="o-we-command-name" t-esc="command.title"/>
                        <div class="o-we-command-description" t-esc="command.description"/>
                    </div>
                </div>
            </t>
        </div>
    </t>
`);
registerTemplate("html_editor.Signature", `/html_editor/static/src/main/signature.xml`, `<t t-name="html_editor.Signature" xml:space="preserve">
        <div t-att-class="signatureClass" t-out="signature"/>
    </t>
`);
registerTemplate("html_editor.TableAlignSelector", `/html_editor/static/src/main/table/table_align_selector.xml`, `<t t-name="html_editor.TableAlignSelector" xml:space="preserve">
        <Dropdown menuClass="'o-we-toolbar-dropdown'" bottomSheet="false" menuRef="menuRef">
            <button class="btn btn-light" t-att-title="props.title" name="vertical_align">
                <t t-set="selectedItem" t-value="items.find(item =&gt; item.mode === state.displayName)"/>
                <t t-call="{{ selectedItem ? selectedItem.template : 'html_editor.VerticalAlignTop' }}"/>
            </button>
            <t t-set-slot="content">
                <div data-prevent-closing-overlay="true">
                    <t t-foreach="items" t-as="item" t-key="item.mode">
                        <button t-attf-class="btn btn-light" t-att-class="{ active: item.mode === state.displayName }" t-on-pointerdown.prevent="() =&gt; {}" t-on-click="() =&gt; this.onSelected(item)">
                            <t t-call="{{item.template}}"/>
                        </button>
                    </t>
                </div>
            </t>
        </Dropdown>
    </t>

    `);
registerTemplate("html_editor.VerticalAlignTop", `/html_editor/static/src/main/table/table_align_selector.xml`, `<t t-name="html_editor.VerticalAlignTop" xml:space="preserve">
        <svg xmlns="http://www.w3.org/2000/svg" class="oe-vertical-align-icon" name="vertical_align_top" viewBox="0 0 60 60" width="16" height="16">
            <g>
                <path d="M51.542,9.5H36.458C34.551,9.5,33,11.051,33,12.958v29.083c0,1.907,1.551,3.458,3.458,3.458h15.083                     c1.907,0,3.458-1.551,3.458-3.458V12.958C55,11.051,53.449,9.5,51.542,9.5z M53,13.5v28.042                     c0,0.804-0.654,1.458-1.458,1.458H36.458C35.654,43.5,35,42.846,35,42.042V12.958c0-0.804,0.654-1.458,1.458-1.458h15.083                     c0.804,0,1.458,0.654,1.458,1.458V13.5z"/>
                <path d="M23.542,9.5H8.458C6.551,9.5,5,11.051,5,12.958v39.083C5,53.949,6.551,55.5,8.458,55.5h15.083                     c1.907,0,3.458-1.551,3.458-3.458V12.958C27,11.051,25.449,9.5,23.542,9.5z"/>
                <path d="M59,4.5H1c-0.552,0-1,0.448-1,1s0.448,1,1,1h58c0.552,0,1-0.448,1-1S59.552,4.5,59,4.5z"/>
            </g>
        </svg>
    </t>

    `);
registerTemplate("html_editor.VerticalAlignMiddle", `/html_editor/static/src/main/table/table_align_selector.xml`, `<t t-name="html_editor.VerticalAlignMiddle" xml:space="preserve">
        <svg xmlns="http://www.w3.org/2000/svg" class="oe-vertical-align-icon" name="vertical_align_middle" viewBox="0 0 60 60" width="16" height="16">
            <g>
                <path d="M59,29h-4V15.458C55,13.551,53.448,12,51.541,12H36.458C34.551,12,33,13.551,33,15.458V29h-6V10.458                     C27,8.551,25.449,7,23.542,7H8.458C6.551,7,5,8.551,5,10.458V29H1c-0.552,0-1,0.448-1,1s0.448,1,1,1h4v18.542                     C5,51.449,6.551,53,8.458,53h15.083C25.449,53,27,51.449,27,49.542V31h6v13.542C33,46.449,34.551,48,36.458,48h15.083                     C53.449,48,55,46.449,55,44.542V31h4c0.553,0,1-0.448,1-1S59.553,29,59,29z M53,34v10.542                     C53,45.346,52.346,46,51.542,46H36.458C35.654,46,35,45.346,35,44.542V15.458C35,14.654,35.654,14,36.458,14h15.083                     C52.346,14,53,14.654,53,15.458V34z"/>
            </g>
        </svg>
    </t>

    `);
registerTemplate("html_editor.VerticalAlignBottom", `/html_editor/static/src/main/table/table_align_selector.xml`, `<t t-name="html_editor.VerticalAlignBottom" xml:space="preserve">
        <svg xmlns="http://www.w3.org/2000/svg" class="oe-vertical-align-icon" name="vertical_align_bottom" viewBox="0 0 60 60" width="16" height="16">
            <g>
                <path d="M36.458,50.5h15.083c1.669,0,3.065-1.188,3.388-2.762C54.976,47.513,55,47.28,55,47.042V17.958                     c0-1.907-1.551-3.458-3.458-3.458H36.459C34.552,14.5,33,16.051,33,17.958v29.083c0,0.238,0.024,0.471,0.07,0.696                     C33.393,49.312,34.789,50.5,36.458,50.5z M35,17.958c0-0.804,0.654-1.458,1.459-1.458h15.083c0.804,0,1.458,0.654,1.458,1.458                     v29.584c0,0.201-0.041,0.393-0.115,0.567c-0.222,0.523-0.741,0.891-1.344,0.891H36.459c-0.604,0-1.122-0.368-1.344-0.891                     C35.041,47.434,35,47.243,35,47.042V17.958z"/>
                <path d="M8.458,50.5h15.083c1.907,0,3.459-1.551,3.459-3.458V7.958C27,6.051,25.449,4.5,23.542,4.5H8.459                     C6.552,4.5,5,6.051,5,7.958v39.083C5,48.949,6.551,50.5,8.458,50.5z"/>
                <path d="M59,53.5H1c-0.553,0-1,0.448-1,1s0.447,1,1,1h58c0.553,0,1-0.448,1-1S59.553,53.5,59,53.5z"/>
            </g>
        </svg>
    </t>
`);
registerTemplate("html_editor.TableMenu", `/html_editor/static/src/main/table/table_menu.xml`, `<t t-name="html_editor.TableMenu" xml:space="preserve">
        <Dropdown menuClass="'m-0'" position="props.type === 'column' ? 'bottom' : 'right'" state="props.dropdownState" bottomSheet="false">
            <button t-att-data-type="props.type" class="o-we-table-menu oi" t-attf-class="oi-ellipsis-{{props.type === 'column' ? 'h w-100' : 'v h-100 px-0'}}"/>
            <t t-set-slot="content">
                <div t-on-pointerdown.stop="() =&gt; {}">
                    <t t-foreach="items" t-as="item" t-key="item_index">
                        <DropdownItem onSelected="() =&gt; this.onSelected(item)">
                            <div class="user-select-none" t-att-name="item.name">
                                <span t-if="item.icon" class="me-2 fa" t-att-class="item.icon"/>
                                <span t-esc="item.text"/>
                            </div>
                        </DropdownItem>
                    </t>
                 </div>
            </t>
        </Dropdown>
    </t>
`);
registerTemplate("html_editor.TablePicker", `/html_editor/static/src/main/table/table_picker.xml`, `<t t-name="html_editor.TablePicker" xml:space="preserve">
        <div class="o-we-tablepicker bg-light p-1 my-1" t-on-click="insertTable" t-on-mousedown.stop="">
            <t t-foreach="new Array(state.rows + 1)" t-as="row" t-key="row_index">
                <div class="o-we-row d-flex">
                    <t t-foreach="new Array(state.cols + 1)" t-as="col" t-key="col_index">
                        <div class="o-we-cell" t-att-class="{'active': col_index lt state.cols and row_index lt state.rows}" t-on-mouseenter="() =&gt; this.updateSize(col_index + 1, row_index + 1)"/>
                    </t>
                </div>
            </t>
            <div class="text-center"><t t-esc="state.cols"/>x<t t-esc="state.rows"/></div>
        </div>
    </t>
`);
registerTemplate("html_editor.MobileToolbar", `/html_editor/static/src/main/toolbar/mobile_toolbar.xml`, `<t t-name="html_editor.MobileToolbar" xml:space="preserve">
        <div t-ref="toolbarWrapper" class="o-toolbar-above-keyboard">
            <Toolbar t-props="this.props"/>
        </div>
    </t>
`);
registerTemplate("html_editor.Toolbar", `/html_editor/static/src/main/toolbar/toolbar.xml`, `<t t-name="html_editor.Toolbar" xml:space="preserve">
        <div class="o-we-toolbar d-flex align-items-center m-0" t-att-class="props.class" style="overflow-x: auto; overflow-y:hidden" t-on-pointerdown.prevent="" t-att-data-namespace="state.namespace" data-prevent-closing-overlay="true">
            <t t-foreach="state.buttonGroups" t-as="buttonGroup" t-key="buttonGroup.id">
                <span class="o-we-toolbar-vertical-separator"/>
                <div class="btn-group" t-att-name="buttonGroup.id">
                    <t t-foreach="buttonGroup.buttons" t-as="button" t-key="button.id">
                            <t t-if="button.Component">
                                <t t-component="button.Component" t-props="button.props" title="button.description" getSelection.bind="props.getSelection" isDisabled="'isDisabled' in button.props ? button.props.isDisabled : !!button.isDisabled"/>
                            </t>
                            <button t-else="" class="btn btn-light" t-att-class="{                                     active: button.isActive,                                     disabled: button.isDisabled,                                 }" t-att-disabled="button.isDisabled" t-att-title="button.description" t-att-name="button.id" t-on-click="() =&gt; this.onButtonClick(button)">
                                <span t-if="button.icon" t-att-class="button.icon.includes('fa-') ? 'fa fa-fw ' + button.icon : 'oi oi-fw ' + button.icon"/>
                                <span t-if="button.text" t-esc="button.text"/>
                            </button>
                    </t>
                </div>
            </t>
        </div>
    </t>
`);
registerTemplate("html_editor.EmbeddedCaption", `/html_editor/static/src/others/embedded_components/backend/caption/caption.xml`, `<t t-name="html_editor.EmbeddedCaption" xml:space="preserve">
        <input t-attf-class="border-0 p-0" t-ref="captionInput" type="text" maxLength="100" t-att-placeholder="'Write your caption here'" t-on-blur="onInputBlur" t-on-keydown.stop="" t-on-beforeinput="onInputBeforeInput" t-on-keyup="onInputKeyup" t-att-value="state.caption"/>
    </t>
`);
registerTemplate("html_editor.EmbeddedFile", `/html_editor/static/src/others/embedded_components/backend/file/file.xml`, `<t t-name="html_editor.EmbeddedFile" t-inherit="html_editor.ReadonlyEmbeddedFile" t-inherit-mode="primary" xml:space="preserve">
        <xpath expr="//span[hasclass('o_file_name_container')]" position="after">
            <input t-attf-class="rounded border-0 mx-2 #{ localState.editFileName ? '' : 'd-none'}" t-ref="nameInput" type="text" maxLength="100" t-att-placeholder="fileModel.filename" t-on-blur="onBlurNameInput" t-on-input.stop="" t-on-keydown.stop="onKeydownNameInput" t-att-value="fileModel.filename"/>
        </xpath>
        <xpath expr="//span[hasclass('o_file_name_container')]" position="attributes">
            <attribute name="t-att-class">{
                "d-none": localState.editFileName,
                "cursor-pointer": true,
            }</attribute>
            <attribute name="t-on-focus">onFocusFileName</attribute>
            <attribute name="tabindex">-1</attribute>
        </xpath>
        <xpath expr="//span[hasclass('o_file_name')]" position="after">
            <i class="fa fa-pencil mx-1 invisible align-items-center d-inline-flex"/>
        </xpath>
    </t>
`);
registerTemplate("html_editor.CodeToolbar", `/html_editor/static/src/others/embedded_components/backend/syntax_highlighting/code_toolbar.xml`, `<t t-name="html_editor.CodeToolbar" xml:space="preserve">
        <div t-att-class="props.isActive ? 'show' : ''" class="o_code_toolbar">
            <div data-prevent-closing-overlay="true">
                <Dropdown menuClass="'o_language_selector'">
                    <button class="btn" t-att-title="languages[props.currentLanguage]" name="language">
                        <span class="px-1" t-esc="languages[props.currentLanguage]"/>
                        <i class="fa fa-caret-down"/>
                    </button>
                    <t t-set-slot="content">
                        <t t-foreach="Object.entries(languages)" t-as="language" t-key="language[0]">
                            <DropdownItem attrs="{ name: language[1] }" onSelected="() =&gt; props.onLanguageChange(language[0])" t-on-pointerdown.prevent="() =&gt; {}">
                                <t t-esc="language[1]"/>
                            </DropdownItem>
                        </t>
                    </t>
                </Dropdown>
                <CopyButton content="props.getContent" copyText.translate="Copy" successText.translate="Code copied to the clipboard."/>
                <button class="text-nowrap btn" t-on-click="this.props.convertToParagraph">
                    <span class="mx-1 fa fa-paragraph" title="Convert to paragraph"/>
                </button>
            </div>
        </div>
    </t>
`);
registerTemplate("html_editor.EmbeddedSyntaxHighlighting", `/html_editor/static/src/others/embedded_components/backend/syntax_highlighting/syntax_highlighting.xml`, `<t t-name="html_editor.EmbeddedSyntaxHighlighting" xml:space="preserve">
        <CodeToolbar target="state.host" currentLanguage="embeddedState.languageId" getContent="() =&gt; this.textarea.value" onLanguageChange="onLanguageChange.bind(this)" convertToParagraph="this.props.convertToParagraph"/>
        <pre t-ref="pre"/>
        <textarea t-ref="textarea" class="o_prism_source" contenteditable="true" placeholder="Code" t-on-input="onInput" t-on-scroll="onScroll" t-on-keydown="onKeydown" t-on-focus="props.onTextareaFocus"/>
    </t>
`);
registerTemplate("html_editor.VideoSettings", `/html_editor/static/src/others/embedded_components/backend/video/video.xml`, `<t t-name="html_editor.VideoSettings" xml:space="preserve">
        <Dropdown state="this.props.dropdown">
            <button t-ref="menuRef" class="btn btn-light shadow border py-1 px-1 ms-1" title="More options">
                <i class="oi oi-fw oi-ellipsis-v"/>
            </button>
            <t t-set-slot="content">
                <DropdownItem onSelected="props.replaceVideo">
                    <i class="fa-fw fa fa-exchange me-1"/>Replace
                </DropdownItem>
                <DropdownItem onSelected="props.removeVideo" class="'text-danger'">
                    <i class="fa fa-fw fa-trash me-1"/>Remove
                </DropdownItem>
            </t>
        </Dropdown>
    </t>
`);
registerTemplate("html_editor.EmbeddedCaptionBlueprint", `/html_editor/static/src/others/embedded_components/plugins/caption_plugin/caption_blueprint.xml`, `<t t-name="html_editor.EmbeddedCaptionBlueprint" xml:space="preserve">
        <figcaption t-att-data-embedded-props="embeddedProps" data-embedded="caption" data-oe-protected="true" contenteditable="false" class="mt-2"/>
    </t>
`);
registerTemplate("html_editor.EmbeddedFileBlueprint", `/html_editor/static/src/others/embedded_components/plugins/embedded_file_plugin/file_blueprint.xml`, `<t t-name="html_editor.EmbeddedFileBlueprint" xml:space="preserve">
        <span t-att-data-embedded-props="embeddedProps" data-embedded="file" data-oe-protected="true" contenteditable="false" class="o_file_box o-contenteditable-false"/>
    </t>
`);
registerTemplate("html_editor.EmbeddedSyntaxHighlightingBlueprint", `/html_editor/static/src/others/embedded_components/plugins/syntax_highlighting_plugin/syntax_highlighting_blueprint.xml`, `<t t-name="html_editor.EmbeddedSyntaxHighlightingBlueprint" xml:space="preserve">
        <div t-att-data-embedded-props="embeddedProps" data-embedded="syntaxHighlighting" data-oe-protected="true" contenteditable="false" class="o_syntax_highlighting"/>
    </t>
`);
registerTemplate("html_editor.TableOfContentBlueprint", `/html_editor/static/src/others/embedded_components/plugins/table_of_content_plugin/table_of_content_blueprint.xml`, `<t t-name="html_editor.TableOfContentBlueprint" xml:space="preserve">
        <div data-embedded="tableOfContent" data-oe-protected="true" contenteditable="false"/>
    </t>
`);
registerTemplate("html_editor.EmbeddedToggleBlockBlueprint", `/html_editor/static/src/others/embedded_components/plugins/toggle_block_plugin/toggle_block_blueprint.xml`, `<t t-name="html_editor.EmbeddedToggleBlockBlueprint" xml:space="preserve">
        <div data-embedded="toggleBlock" data-oe-protected="true" contenteditable="false" t-att-data-embedded-props="embeddedProps">
            <div data-embedded-editable="title" data-oe-protected="false" contenteditable="true">
                <t t-tag="baseContainerNodeName" t-att="baseContainerAttributes"><br/></t>
            </div>
            <div data-embedded-editable="content" data-oe-protected="false" contenteditable="true">
                <t t-tag="baseContainerNodeName" t-att="baseContainerAttributes"><br/></t>
            </div>
        </div>
    </t>
`);
registerTemplate("html_editor.EmbeddedVideoBlueprint", `/html_editor/static/src/others/embedded_components/plugins/video_plugin/video_blueprint.xml`, `<t t-name="html_editor.EmbeddedVideoBlueprint" xml:space="preserve">
        <div t-att-data-embedded-props="embeddedProps" data-embedded="video" data-oe-protected="true" contenteditable="false"/>
    </t>
`);
registerTemplate("html_editor.QWebPicker", `/html_editor/static/src/others/qweb_picker.xml`, `<t t-name="html_editor.QWebPicker" xml:space="preserve">
        <div class="o-we-qweb-picker bg-white my-1">
            <t t-foreach="state.groups" t-as="group" t-key="group_index">
                <select class="form-select" t-on-change="onChange">
                    <t t-foreach="group" t-as="element" t-key="element_index">
                        <option t-attf-value="{{group_index}},{{element_index}}" t-att-selected="element.isActive">
                            <t t-esc="element.label"/>
                        </option>
                    </t>
                </select>
            </t>
        </div>
    </t>
`);
registerTemplate("web.DebugMenu", `/web/static/src/core/debug/debug_menu.xml`, `<t t-name="web.DebugMenu" xml:space="preserve">
        <div class="o_debug_manager">
            <Dropdown beforeOpen.bind="loadGroupedItems" position="'bottom-end'">
                <button t-att-class="\`o-dropdown--narrow \${env.inDialog?'btn btn-link':''}\`">
                    <i class="fa fa-bug" role="img" aria-label="Open developer tools"/>
                </button>
                <t t-set-slot="content">
                    <t t-foreach="sectionEntries" t-as="entry" t-key="entry[0]">
                        <div class="dropdown-menu_group dropdown-header">
                            <t t-esc="getSectionLabel(entry[0])"/>
                        </div>
                        <t t-foreach="entry[1]" t-as="element" t-key="element_index">
                            <DropdownItem t-if="element.type == 'item'" onSelected="element.callback" attrs="{ href: element.href }">
                                <span t-att-class="entry[0] and 'ps-3'" t-esc="element.description"/>
                            </DropdownItem>
                            <t t-if="element.type == 'component'" t-component="element.Component" t-props="element.props"/>
                        </t>
                    </t>
                </t>
            </Dropdown>
        </div>
    </t>

`);
registerTemplate("web.DebugMenu.SetDefaultDialog", `/web/static/src/core/debug/debug_menu_items.xml`, `<t t-name="web.DebugMenu.SetDefaultDialog" xml:space="preserve">
        <Dialog title.translate="Set Default Values">
            <table style="width: 100%">
                <tr>
                    <td>
                        <label for="formview_default_fields" class="oe_label oe_align_right">
                            Default:
                        </label>
                    </td>
                    <td class="oe_form_required">
                        <select id="formview_default_fields" class="o_input" t-model="state.fieldToSet">
                            <option value=""/>
                            <option t-foreach="defaultFields" t-as="field" t-att-value="field.name" t-key="field.name">
                                <t t-esc="field.string"/> = <t t-esc="field.displayed"/>
                            </option>
                        </select>
                    </td>
                </tr>
                <tr t-if="conditions.length">
                    <td>
                        <label for="formview_default_conditions" class="oe_label oe_align_right">
                            Condition:
                        </label>
                    </td>
                    <td>
                        <select id="formview_default_conditions" class="o_input" t-model="state.condition">
                            <option value=""/>
                            <option t-foreach="conditions" t-as="cond" t-att-value="cond.name + '=' + cond.value" t-key="cond.name">
                                <t t-esc="cond.string"/>=<t t-esc="cond.displayed"/>
                            </option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <input type="radio" id="formview_default_self" value="self" name="scope" t-model="state.scope"/>
                        <label for="formview_default_self" class="oe_label" style="display: inline;">
                            Only you
                        </label>
                        <br/>
                        <input type="radio" id="formview_default_all" value="all" name="scope" t-model="state.scope"/>
                        <label for="formview_default_all" class="oe_label" style="display: inline;">
                            All users
                        </label>
                    </td>
                </tr>
            </table>
            <t t-set-slot="footer">
                <button class="btn btn-secondary" t-on-click="props.close">Close</button>
                <button class="btn btn-secondary" t-on-click="saveDefault">Save default</button>
            </t>
        </Dialog>
    </t>

    `);
registerTemplate("web.DebugMenu.GetMetadataDialog", `/web/static/src/core/debug/debug_menu_items.xml`, `<t t-name="web.DebugMenu.GetMetadataDialog" xml:space="preserve">
        <Dialog title.translate="Metadata">
            <table class="table table-sm table-striped">
                <tr>
                    <th>ID:</th>
                    <td><t t-esc="state.id"/></td>
                </tr>
                <tr>
                    <th>XML ID:</th>
                    <td>
                        <t t-if="state.xmlids.length &gt; 1">
                            <t t-foreach="state.xmlids" t-as="imd" t-key="imd['xmlid']">
                                <div t-att-class="&quot;p-0 &quot; + (imd[&quot;xmlid&quot;] === state.xmlid ? &quot;fw-bolder &quot; : &quot;&quot;) + (imd[&quot;noupdate&quot;] === true ? &quot;fst-italic &quot; : &quot;&quot;)" t-esc="imd['xmlid']"/>
                            </t>
                        </t>
                        <t t-elif="state.xmlid" t-esc="state.xmlid"/>
                        <t t-else="">
                            / <a t-on-click="onClickCreateXmlid"> (create)</a>
                        </t>
                    </td>
                </tr>
                <tr>
                    <th>No Update:</th>
                    <td>
                        <t t-esc="state.noupdate"/>
                        <t t-if="state.xmlid">
                            <a t-on-click="toggleNoupdate"> (change)</a>
                        </t>
                    </td>
                </tr>
                <tr>
                    <th>Creation User:</th>
                    <td><t t-esc="state.creator"/></td>
                </tr>
                <tr>
                    <th>Creation Date:</th>
                    <td><t t-esc="state.createDate"/></td>
                </tr>
                <tr>
                    <th>Latest Modification by:</th>
                    <td><t t-esc="state.lastModifiedBy"/></td>
                </tr>
                <tr>
                    <th>Latest Modification Date:</th>
                    <td><t t-esc="state.writeDate"/></td>
                </tr>
            </table>
        </Dialog>
    </t>

    `);
registerTemplate("web.DebugMenu.GetViewDialog", `/web/static/src/core/debug/debug_menu_items.xml`, `<t t-name="web.DebugMenu.GetViewDialog" xml:space="preserve">
        <Dialog title.translate="Computed Arch">
            <pre t-esc="props.arch"/>
            <t t-set-slot="footer">
                <button class="btn btn-primary o-default-button" t-on-click="() =&gt; props.close()">Close</button>
            </t>
        </Dialog>
    </t>
`);
registerTemplate("web.ActionMenus", `/web/static/src/search/action_menus/action_menus.xml`, `<t t-name="web.ActionMenus" xml:space="preserve">
        <div class="o_cp_action_menus d-flex pe-2 gap-1">
            <div t-if="props.items.print?.length" class="d-inline-block">
                <Dropdown beforeOpen.bind="loadPrintItems">
                    <button class="btn btn-secondary" data-hotkey="shift+u">
                        <i class="fa fa-print me-1"/>
                        <span class="o_dropdown_title" t-out="props.printDropdownTitle"/>
                    </button>
                    <t t-set-slot="content">
                        <t t-foreach="state.printItems" t-as="item" t-key="item.key">
                            <DropdownItem class="item.class" onSelected="() =&gt; this.onItemSelected(item)" t-out="item.description"/>
                        </t>
                    </t>
                </Dropdown>
            </div>

            <div t-if="actionItems.length" class="d-inline-block">
                <Dropdown>
                    <button class="btn btn-secondary" data-hotkey="u">
                        <i class="fa fa-cog me-1"/>
                        <span class="o_dropdown_title">Actions</span>
                    </button>
                    <t t-set-slot="content">
                        <t t-foreach="actionItems" t-as="item" t-key="item.key">
                            <t t-if="currentGroup !== null and currentGroup !== item.groupNumber">
                                <div role="separator" class="dropdown-divider"/>
                            </t>
                            <t t-if="item.Component" t-component="item.Component" t-props="item.props"/>
                            <DropdownItem t-else="" class="item.class ? item.class + ' o_menu_item' : 'o_menu_item'" onSelected="() =&gt; this.onItemSelected(item)">
                                <i t-if="item.icon" t-att-class="item.icon + ' me-1 fa-fw oi-fw'"/>
                                <t t-esc="item.description"/>
                            </DropdownItem>
                            <t t-set="currentGroup" t-value="item.groupNumber"/>
                        </t>
                    </t>
                </Dropdown>
        </div>
        </div>
    </t>

`);
registerTemplate("web.Breadcrumbs", `/web/static/src/search/breadcrumbs/breadcrumbs.xml`, `<t t-name="web.Breadcrumbs" xml:space="preserve">
        <t t-set="currentBreadcrumbs" t-value="props.breadcrumbs.slice(-1)"/>
        <t t-set="visiblePathBreadcrumbs" t-value="props.breadcrumbs.slice(-3, -1)"/>
        <t t-set="collapsedBreadcrumbs" t-value="props.breadcrumbs.slice(0, -3).reverse()"/>
        <t t-set="breadcrumb" t-value="currentBreadcrumbs[0] || {}"/>

        <div t-if="collapsedBreadcrumbs.length || visiblePathBreadcrumbs.length" class="o_breadcrumb d-flex flex-row flex-md-column align-self-stretch justify-content-between min-w-0">
            <t t-if="env.isSmall">
                <t t-set="previousBreadcrumb" t-value="visiblePathBreadcrumbs.at(-1)"/>
                <button class="o_back_button btn btn-link d-print-none px-1 py-0" t-on-click.prevent="previousBreadcrumb.onSelected">
                    <i class="oi oi-fw oi-arrow-left"/>
                </button>
            </t>
            <t t-else="">
                <ol class="breadcrumb flex-nowrap text-nowrap lh-sm">
                    <li t-if="collapsedBreadcrumbs.length" class="breadcrumb-item d-inline-flex min-w-0">
                        <Dropdown>
                            <button class="btn btn-light btn-sm px-1 p-0">
                                <i class="oi oi-ellipsis-h"/>
                            </button>
                            <t t-set-slot="content">
                                <t t-foreach="collapsedBreadcrumbs" t-as="breadcrumb" t-key="breadcrumb.jsId">
                                    <DropdownItem onSelected="breadcrumb.onSelected" attrs="{ href: breadcrumb.url, 'data-tooltip': getBreadcrumbTooltip(breadcrumb)}">
                                        <t t-call="web.Breadcrumb.Name"/>
                                    </DropdownItem>
                                </t>
                            </t>
                        </Dropdown>
                    </li>
                    <t t-foreach="visiblePathBreadcrumbs" t-as="breadcrumb" t-key="breadcrumb.jsId">
                        <li class="breadcrumb-item d-inline-flex min-w-0" t-att-class="{ o_back_button: breadcrumb_last }" t-att-data-hotkey="breadcrumb_last and 'b'" t-on-click.prevent="breadcrumb.onSelected">
                            <a t-att-href="breadcrumb.url" class="fw-bold text-truncate" t-att-data-tooltip="'Back to &quot;' + breadcrumb.name + '&quot;' + (breadcrumb.isFormView ? ' form' : '')"><t t-call="web.Breadcrumb.Name"/></a>
                        </li>
                    </t>
                </ol>
            </t>
            <div class="d-flex gap-1 text-truncate">
                <div class="o_last_breadcrumb_item active d-flex gap-2 align-items-center min-w-0 lh-sm">
                    <span class="min-w-0 text-truncate"><t t-call="web.Breadcrumb.Name"/></span>
                </div>
                <t t-call="web.Breadcrumb.Actions"/>
            </div>
        </div>

        <div t-else="" class="o_breadcrumb d-flex gap-1 text-truncate">
            <div class="o_last_breadcrumb_item active d-flex fs-4 min-w-0 align-items-center">
                <span class="min-w-0 text-truncate"><t t-call="web.Breadcrumb.Name"/></span>
            </div>
            <t t-call="web.Breadcrumb.Actions"/>
        </div>

        <t t-slot="breadcrumb-status-indicator"/>
    </t>

    `);
registerTemplate("web.Breadcrumb.Actions", `/web/static/src/search/breadcrumbs/breadcrumbs.xml`, `<t t-name="web.Breadcrumb.Actions" xml:space="preserve">
        <div class="o_control_panel_breadcrumbs_actions d-inline-flex d-print-none">
            <t t-slot="breadcrumb-additional-actions"/>
        </div>
    </t>

    `);
registerTemplate("web.Breadcrumb.Name", `/web/static/src/search/breadcrumbs/breadcrumbs.xml`, `<t t-name="web.Breadcrumb.Name" xml:space="preserve">
        <t t-if="breadcrumb.name" t-out="breadcrumb.name"/>
        <em t-else="" class="text-warning">Unnamed</em>
    </t>

`);
registerTemplate("web.CogMenu", `/web/static/src/search/cog_menu/cog_menu.xml`, `<t t-name="web.CogMenu" xml:space="preserve">
        <div t-if="hasItems" class="o_cp_action_menus d-flex align-items-center gap-1" t-att-class="{'pe-2': !env.isSmall}">
            <div class="lh-1">
                <Dropdown menuClass="'lh-base'" beforeOpen.bind="loadPrintItems">
                    <button class="d-print-none btn" t-att-class="env.isSmall ? 'btn-secondary' : 'lh-sm p-0 border-0'" data-hotkey="u" data-tooltip="Actions" aria-label="Actions menu">
                        <i class="fa fa-fw fa-cog"/>
                    </button>

                    <t t-set-slot="content">
                        <t t-slot="default"/>
                        <t t-if="state.printItems.length">
                            <Dropdown t-if="state.printItems.length &gt; 1">
                                <button>
                                    <i class="fa fa-print me-1"/> <t t-out="props.printDropdownTitle"/>
                                </button>
                                <t t-set-slot="content">
                                    <DropdownItem t-foreach="state.printItems" t-as="item" t-key="item.key" class="'o_menu_item'" attrs="{ 'aria-label': this.getPrintItemAriaLabel(item) }" onSelected="() =&gt; this.onItemSelected(item)">
                                        <t t-esc="item.description"/>
                                    </DropdownItem>
                                </t>
                            </Dropdown>

                            <DropdownItem t-else="" class="'o_menu_item'" attrs="{ 'aria-label': this.getPrintItemAriaLabel(state.printItems[0]) }" onSelected="() =&gt; this.onItemSelected(state.printItems[0])">
                                <i class="fa fa-print me-1"/> <t t-out="state.printItems[0].description"/>
                            </DropdownItem>
                        </t>

                        <t t-foreach="cogItems" t-as="item" t-key="item.key">
                            <t t-if="currentGroup !== null and currentGroup !== item.groupNumber">
                                <div role="separator" class="dropdown-divider"/>
                            </t>

                            <t t-if="item.Component" t-component="item.Component" t-props="item.props"/>

                            <DropdownItem t-else="" class="item.class ? item.class + ' o_menu_item' : 'o_menu_item'" onSelected="() =&gt; this.onItemSelected(item)">
                                <i t-if="item.icon" t-att-class="item.icon" class="fa-fw oi-fw me-1"/>
                                <t t-esc="item.description"/>
                            </DropdownItem>

                            <t t-set="currentGroup" t-value="item.groupNumber"/>
                        </t>
                    </t>
                </Dropdown>
            </div>
        </div>
    </t>

`);
registerTemplate("web.ControlPanel", `/web/static/src/search/control_panel/control_panel.xml`, `<t t-name="web.ControlPanel" xml:space="preserve">
        <div class="o_control_panel d-flex flex-column gap-3 px-3 pt-2 pb-3" t-ref="root" data-command-category="actions">
            <Transition t-if="!env.isSmall" visible="state.embeddedInfos.showEmbedded" name="'o-fade'" t-slot-scope="transition" leaveDuration="500">
                <div class="o_embedded_actions overflow-hidden d-flex flex-wrap w-100 align-items-center justify-content-center gap-2" t-att-class="transition.className">
                    <t t-foreach="state.embeddedInfos.embeddedActions" t-as="action" t-key="action.id">
                        <t t-if="_isEmbeddedActionVisible(action)">
                            <button class="btn btn-secondary o_draggable" t-att-class="{ 'active': state.embeddedInfos.currentEmbeddedAction?.id === action.id}" t-on-click="() =&gt; this.onEmbeddedActionClick(action)" t-att-data-id="action.id">
                                <span t-out="action.name"/>
                            </button>
                        </t>
                    </t>
                    <t t-call="web.embeddedActionsDropdown"/>
                </div>
            </Transition>
            <div class="o_control_panel_main d-flex flex-wrap flex-lg-nowrap justify-content-between align-items-lg-start gap-2 gap-lg-3 flex-grow-1">
                <div class="o_control_panel_breadcrumbs d-flex align-items-center gap-1 order-0 h-lg-100">
                    <div class="o_control_panel_main_buttons d-flex gap-1 d-empty-none d-print-none" t-on-keydown="onMainButtonsKeydown">
                        <t t-slot="control-panel-create-button"/>
                        <t t-slot="layout-buttons"/>
                        <t t-slot="control-panel-always-buttons"/>
                        <Dropdown t-if="env.isSmall" menuClass="'o-control-panel-adaptive-dropdown'" onOpened.bind="dropdownifyButtons">
                            <button class="btn btn-secondary o-control-panel-adaptive-dropdown" title="More">
                                <i class="oi oi-fw oi-ellipsis-v"/>
                            </button>
                            <t t-set-slot="content">
                                <t t-slot="control-panel-create-button"/>
                                <t t-slot="layout-buttons"/>
                                <t t-slot="control-panel-always-buttons"/>
                            </t>
                        </Dropdown>
                    </div>
                    <t t-if="env.config.noBreadcrumbs">
                        <section class="o_control_panel_breadcrumbs_actions d-contents d-print-none">
                            <t t-slot="control-panel-additional-actions"/>
                            <t t-slot="control-panel-status-indicator"/>
                        </section>
                    </t>
                    <t t-elif="env.isSmall">

                        <div class="o_fallback_breadcrumbs d-contents"/>
                        <Breadcrumbs breadcrumbs="breadcrumbs" t-portal="'.o_navbar_breadcrumbs, .o_fallback_breadcrumbs'"/>
                        <section class="o_control_panel_breadcrumbs_actions d-contents">
                            <t t-slot="control-panel-additional-actions"/>
                            <t t-slot="control-panel-status-indicator"/>
                        </section>
                    </t>
                    <t t-else="">
                        <Breadcrumbs breadcrumbs="breadcrumbs">
                            <t t-set-slot="breadcrumb-status-indicator">
                                <t t-slot="control-panel-status-indicator"/>
                            </t>
                            <t t-set-slot="breadcrumb-additional-actions">
                                <t t-slot="control-panel-additional-actions"/>
                            </t>
                        </Breadcrumbs>
                    </t>
                    <div t-if="!env.isSmall" class="me-auto"/> 
                </div>

                <div class="o_control_panel_actions d-empty-none d-flex align-items-center justify-content-start justify-content-lg-around order-2 order-lg-1 w-100 mw-100 w-lg-auto">
                    <t t-if="display.layoutActions" t-slot="layout-actions"/>
                    <t t-slot="control-panel-selection-actions"/>
                </div>

                <div class="o_control_panel_navigation d-flex flex-wrap flex-md-nowrap justify-content-end gap-1 gap-xl-3 order-1 order-lg-2 flex-grow-1">
                    <t t-if="state.embeddedInfos.embeddedActions?.length and env.isSmall">
                        <t t-call="web.embeddedActionsDropdown"/>
                    </t>
                    <div t-if="pagerProps and pagerProps.total &gt; 0" class="o_cp_pager text-nowrap " role="search">
                        <Pager t-props="pagerProps"/>
                    </div>
                    <button t-if="state.embeddedInfos.embeddedActions?.length and !env.isSmall" name="embedded_actions" class="btn btn-secondary" t-att-class="{active: state.embeddedInfos.showEmbedded}" t-on-click="onClickShowEmbedded" title="View related documents">
                        <i class="fa fa-sliders"/>
                    </button>
                    <t t-if="env.config.viewSwitcherEntries?.length &gt; 1">
                        <div t-if="env.isSmall" class="o_cp_switch_buttons btn-group d-print-none">
                            <Dropdown menuClass="{o_cp_switch_buttons: true, o_custom_bottom_sheet: true }">
                                <button class="btn btn-secondary">
                                    <t t-set="activeView" t-value="env.config.viewSwitcherEntries.find((view) =&gt; view.active)"/>
                                    <i class="oi-fw" t-att-class="activeView.icon"/>
                                </button>
                                <t t-set-slot="content">
                                    <t t-foreach="env.config.viewSwitcherEntries" t-as="view" t-key="view.type">
                                        <DropdownItem onSelected="() =&gt; this.switchView(view.type)" class="view.active ? 'selected' : ''">
                                            <i class="oi-fw" t-att-class="view.icon"/>
                                            <span class="ms-1" t-out="view.name"/>
                                        </DropdownItem>
                                    </t>
                                </t>
                            </Dropdown>
                        </div>
                        <nav t-else="" class="o_cp_switch_buttons d-print-none d-inline-flex btn-group">
                            <t t-foreach="env.config.viewSwitcherEntries" t-as="view" t-key="view.type">
                                <button class="btn btn-secondary o_switch_view " t-attf-class="o_{{view.type}} {{view.active ? 'active' : ''}}" t-att-data-tooltip="view.name" t-custom-click="(ev, isMiddleClick) =&gt; this.switchView(view.type, isMiddleClick)" t-att-aria-label="view.name + ' View'">
                                    <i class="oi-fw" t-att-class="view.icon"/>
                                </button>
                            </t>
                        </nav>
                    </t>
                    <t t-slot="control-panel-navigation-additional"/>
                </div>
            </div>
        </div>
    </t>

    `);
registerTemplate("web.embeddedActionsDropdown", `/web/static/src/search/control_panel/control_panel.xml`, `<t t-name="web.embeddedActionsDropdown" xml:space="preserve">
        <Dropdown menuClass="'o_embedded_actions_dropdown_menu'">
            <button name="openEmbeddedActions" class="btn btn-secondary">
                <i class="fa fa-fw fa-sliders"/>
            </button>
            <t t-set-slot="content">
                <t t-foreach="state.embeddedInfos.embeddedActions" t-as="action" t-key="action.id">
                    <DropdownItem class="this.getDropdownClass(action)" onSelected="() =&gt; this.env.isSmall ? this.onEmbeddedActionClick(action) : this._setVisibility(action.id)" closingMode="'none'">
                        <div class="d-flex p-0 pe-1 align-items-center justify-content-between">
                            <span t-out="action.name"/>
                            <i t-if="action.is_deletable" class="o_icon_right btn btn-link text-danger p-0 position-absolute end-0 fa fa-trash-o" title="Delete item" t-on-click.stop="() =&gt; this.openConfirmationDialog(action)"/>
                        </div>
                    </DropdownItem>
                </t>
                <div role="separator" class="dropdown-divider"/>
                <AccordionItem class="'o_save_current_view'" description.translate="Save View">
                    <div class="px-2 py-2">
                        <input type="text" t-ref="newActionNameRef" class="o_input mb-2" t-model.trim="state.embeddedInfos.newActionName"/>
                        <CheckBox value="state.embeddedInfos.newActionIsShared" onChange.bind="_onShareCheckboxChange">
                            <span data-tooltip="Make this embedded action available to other users">Shared</span>
                        </CheckBox>
                    </div>
                    <div class="px-3 py-2">
                        <button class="o_save_favorite btn btn-primary w-100" t-on-click="_saveNewAction">
                            Save
                        </button>
                    </div>
                </AccordionItem>
            </t>
        </Dropdown>
    </t>

`);
registerTemplate("web.CustomFavoriteItem", `/web/static/src/search/custom_favorite_item/custom_favorite_item.xml`, `<t t-name="web.CustomFavoriteItem" xml:space="preserve">
        <AccordionItem class="'o_add_favorite text-truncate'" description.translate="Save current search">
            <div class="px-3 py-1">
                <input type="text" class="o_input my-1" t-ref="description" t-model.trim="state.description" t-on-keydown="onInputKeydown"/>
                <CheckBox value="state.isDefault" onChange.bind="(checked) =&gt; this.state.isDefault = checked">
                    <span data-tooltip="Use this filter by default when opening this view">Default filter</span>
                </CheckBox>
            </div>
            <div class="px-3 pb-2 d-flex gap-2">
                <button class="o_save_favorite btn btn-primary w-100" t-on-click="saveFavorite">
                    Save
                </button>
                <button class="o_edit_favorite btn btn-secondary w-100" t-on-click="editFavorite">
                    Edit
                </button>
            </div>
        </AccordionItem>
    </t>

`);
registerTemplate("web.CustomGroupByItem", `/web/static/src/search/custom_group_by_item/custom_group_by_item.xml`, `<t t-name="web.CustomGroupByItem" xml:space="preserve">
        <select class="o_add_custom_group_menu o_menu_item dropdown-item" t-on-change="(ev) =&gt; this.onSelected(ev)">
            <option value="" disabled="true" selected="true" hidden="true">Custom Group</option>
            <option t-foreach="props.fields" t-as="field" t-key="field.name" t-if="field.type !== 'properties' and !field.isProperty" t-att-value="field.name" t-esc="field.string"/>
        </select>
    </t>

`);
registerTemplate("web.Layout", `/web/static/src/search/layout.xml`, `<t t-name="web.Layout" xml:space="preserve">
        <t t-if="env.inDialog" t-portal="'#' + env.dialogId + ' .modal-footer'">
            <t t-slot="layout-buttons"/>
        </t>
        <t t-component="components.ControlPanel" slots="controlPanelSlots" t-if="props.display.controlPanel" display="props.display.controlPanel"/>
        <main t-ref="content" class="o_content" t-attf-class="{{props.className}}" t-att-class="{ 'o_component_with_search_panel': props.display.searchPanel }">
            <t t-component="components.SearchPanel" t-if="props.display.searchPanel"/>
            <t t-slot="default" contentRef="contentRef"/>
        </main>
    </t>

`);
registerTemplate("web.PropertiesGroupByItem", `/web/static/src/search/properties_group_by_item/properties_group_by_item.xml`, `<t t-name="web.PropertiesGroupByItem" xml:space="preserve">
        <AccordionItem class="'o_add_custom_group_menu text-truncate'" description="props.item.description" selected="isActive">
            <t t-set="items" t-value="state.groupByItems"/>
            <t t-if="items and items.length">
                <t t-foreach="items" t-as="item" t-key="item.name">
                    <t t-set="description" t-value="isSingleParent ? item.description : \`\${item.description} (\${item.definitionRecordName})\`"/>

                    <AccordionItem t-if="item.options" description="description" selected="item.isActive">
                        <t t-foreach="item.options" t-as="option" t-key="option.id">
                            <t t-set="optionName" t-value="\`\${item.name}:\${option.id}\`"/>
                            <CheckboxItem class="{ o_item_option: true, selected: option.isActive }" checked="option.isActive" closingMode="'none'" t-esc="option.description" onSelected="() =&gt; this.onGroup({ itemId: item.id, optionId: option.id})"/>
                        </t>
                    </AccordionItem>

                    <CheckboxItem t-else="" class="{ o_menu_item: true, selected: item.isActive }" checked="item.isActive" closingMode="'none'" t-esc="description" onSelected="() =&gt; this.onGroup({ itemId: item.id })"/>
                </t>
            </t>
            <DropdownItem t-else="" closingMode="'none'" class="'fst-italic'">
                No Properties
            </DropdownItem>
        </AccordionItem>
    </t>
`);
registerTemplate("web.SearchBar.Facets", `/web/static/src/search/search_bar/search_bar.xml`, `<t t-name="web.SearchBar.Facets" xml:space="preserve">
        <t t-foreach="env.searchModel.facets" t-as="facet" t-key="facet_index">
            <div class="o_searchview_facet position-relative d-inline-flex align-items-stretch rounded-2 bg-200 text-nowrap opacity-trigger-hover mw-100" t-att-class="{o_facet_with_domain: facet.domain }" role="listitem" aria-label="search" tabindex="0">


                <div class="position-absolute start-0 top-0 bottom-0 end-0 bg-view border rounded-2 shadow opacity-0 opacity-100-hover"/>

                <div class="o_searchview_facet_label position-relative rounded-start-2 px-1 rounded-end-0 p-0" t-on-click="(ev) =&gt; this.onFacetLabelClick(ev.target, facet)" t-att-role="facet.domain ? 'button' : 'img'" t-att-class="{                         'text-bg-action': facet.type == 'groupBy',                         'btn': facet.type == 'groupBy' and env.searchModel.canOrderByCount,                         'btn btn-primary': facet.type == 'field' || facet.type == 'filter',                         'btn btn-favourite': facet.type == 'favorite'                     }">
                    <i t-if="facet.icon" class="small fa-fw" t-att-class="facet.icon" role="image"/>
                    <small t-else="" class="px-1" t-esc="facet.title"/>


                    <span t-if="facet.domain" class="position-absolute start-0 top-0 bottom-0 end-0 bg-inherit opacity-0 opacity-100-hover" t-att-class="{'px-2 transition-base': !facet.icon}">
                        <i class="fa fa-fw fa-pencil"/>
                    </span>
                    <span t-if="env.searchModel.canOrderByCount and facet.type === 'groupBy' and !env.searchModel.orderByCount" class="position-absolute start-0 top-0 bottom-0 end-0 bg-inherit opacity-0 opacity-100-hover" t-att-class="{'px-2 transition-base': !facet.icon}">
                        <i class="fa fa-fw fa-sort"/>
                    </span>
                </div>

                <div class="o_facet_values position-relative d-flex flex-wrap align-items-center ps-2 rounded-end-2 text-wrap overflow-hidden">
                    <t t-foreach="facet.values" t-as="facetValue" t-key="facetValue_index">
                        <em t-if="!facetValue_first" class="o_facet_values_sep small fw-bold mx-1 opacity-50" t-esc="facet.separator"/>
                        <small class="o_facet_value text-truncate" t-esc="facetValue" t-att-title="facet.tooltip or facetValue"/>
                    </t>
                    <button class="o_facet_remove oi oi-close btn btn-link py-0 px-2 text-danger d-print-none" role="button" aria-label="Remove" title="Remove" t-on-click="() =&gt; this.onFacetRemove(facet)"/>
                </div>
            </div>
        </t>
    </t>

    `);
registerTemplate("web.SearchBar.QuickSearchItems", `/web/static/src/search/search_bar/search_bar.xml`, `<t t-name="web.SearchBar.QuickSearchItems" xml:space="preserve">
        <t t-foreach="items" t-as="item" t-key="item.id">
            <DropdownItem class="{ o_indent: item.isChild }" attrs="{ id: item.id }" onSelected="() =&gt; this.selectItem(item)" closingMode="'none'">
                <t t-if="item.isParent">
                    <a t-att-class="{ o_expand: true, 'ms-4': item.isFieldProperty}" href="#" t-on-click.stop.prevent="() =&gt; this.toggleItem(item, !item.isExpanded)">
                        <i t-attf-class="fa fa-caret-{{ item.isExpanded ? 'down' : 'right' }}"/>
                    </a>
                </t>
                <a href="#" t-on-click.prevent="" t-att-class="{'ps-3 pe-2 text-truncate': item.isFieldProperty }" t-att-title="item.title">
                    <t t-if="item.isAddCustomFilterButton"><span class="text-action">Custom Filter...</span></t>
                    <t t-elif="item.loadMore"><span class="text-action"><t t-esc="item.label"/></span></t>
                    <t t-elif="item.isChild">
                        <t t-esc="item.label"/>
                    </t>
                    <t t-elif="!item.isFieldProperty"> Search </t> <b t-esc="item.searchItemDescription"/> <t t-if="item.preposition"> <t t-esc="item.preposition"/>: <b class="fst-italic text-primary" t-esc="item.label"/> </t>
                </a>
            </DropdownItem>
        </t>
    </t>

    `);
registerTemplate("web.SearchBar", `/web/static/src/search/search_bar/search_bar.xml`, `<t t-name="web.SearchBar" xml:space="preserve">
        <div t-if="visibilityState.showSearchBar" class="o_cp_searchview d-flex input-group" role="search" t-ref="root">
            <Dropdown state="inputDropdownState" manual="true" noClasses="true" position="'bottom-fit'" menuClass="'o_searchview_autocomplete'" navigationOptions="inputDropdownNavOptions" onStateChanged.bind="onInputDropdownChanged" menuRef="menuRef" bottomSheet="false">
                <div class="o_searchview form-control d-print-contents d-flex align-items-center py-1 border-end-0" role="search" aria-autocomplete="list">
                    <button class="d-print-none btn border-0 p-0" role="button" aria-label="Search..." title="Search..." t-on-click="this.onClickSearchIcon">
                        <i class="o_searchview_icon oi oi-search me-2" role="img"/>
                    </button>
                    <div class="o_searchview_input_container d-flex flex-grow-1 flex-wrap gap-1 mw-100" t-ref="facetContainerRef">
                        <t t-call="web.SearchBar.Facets"/>
                        <input type="text" class="o_searchview_input o_input d-print-none flex-grow-1 w-auto border-0" accesskey="Q" placeholder="Search..." role="searchbox" t-ref="autofocus" t-on-click="onSearchClick" t-on-input="onSearchInput" t-on-compositionend="onCompositionEnd"/>
                    </div>
                </div>
                <t t-set-slot="content">
                    <t t-call="web.SearchBar.QuickSearchItems"/>
                </t>
            </Dropdown>
            <SearchBarMenu dropdownState="searchBarDropdownState">
                <t t-slot="search-bar-additional-menu"/>
            </SearchBarMenu>
        </div>
    </t>

`);
registerTemplate("web.SearchBar.Toggler", `/web/static/src/search/search_bar/search_bar_toggler.xml`, `<t t-name="web.SearchBar.Toggler" xml:space="preserve">
        <button t-if="props.isSmall" t-attf-class="btn btn-secondary {{ props.showSearchBar ? 'active' : '' }}" t-on-click="props.toggleSearchBar">
            <i class="fa fa-fw fa-search"/>
        </button>
    </t>

`);
registerTemplate("web.SearchBarMenu", `/web/static/src/search/search_bar_menu/search_bar_menu.xml`, `<t t-name="web.SearchBarMenu" xml:space="preserve">
        <Dropdown menuClass="'o_search_bar_menu d-flex flex-wrap flex-lg-nowrap w-100 w-md-auto mx-md-auto mt-2 py-3'" position="'bottom-end'" state="this.props.dropdownState" t-if="this.env.searchModel.searchMenuTypes.size" bottomSheet="false">
            <button class="o_searchview_dropdown_toggler d-print-none btn btn-outline-secondary o-dropdown-caret rounded-start-0" data-hotkey="shift+q" title="Toggle Search Panel">
            </button>
            <t t-set-slot="content">

                <t t-if="this.env.searchModel.searchMenuTypes.has('filter')">
                    <div class="o_dropdown_container o_filter_menu w-100 w-lg-auto h-100 px-3 mb-4 mb-lg-0 border-end">
                        <div class="px-3 fs-5 mb-2">
                            <i class="me-2 text-primary" t-att-class="facet_icons.filter"/>
                            <h5 class="o_dropdown_title d-inline">Filters</h5>
                        </div>
                        <t t-set="currentGroup" t-value="null"/>
                        <t t-foreach="filterItems" t-as="item" t-key="item.id">
                            <t t-if="currentGroup !== null and currentGroup !== item.groupNumber">
                                <div class="dropdown-divider" role="separator"/>
                            </t>
                            <t t-if="item.options">
                                <AccordionItem class="'text-truncate'" description="item.description" selected="item.isActive">
                                    <t t-set="subGroup" t-value="null"/>
                                    <t t-foreach="item.options" t-as="option" t-key="option.id">
                                        <t t-if="subGroup !== null and subGroup !== option.groupNumber">
                                            <div class="dropdown-divider" role="separator"/>
                                        </t>
                                        <CheckboxItem class="{ o_item_option: true, selected: option.isActive }" t-esc="option.description" checked="option.isActive" closingMode="'none'" onSelected="() =&gt; this.onFilterSelected({ itemId: item.id, optionId: option.id })"/>
                                        <t t-set="subGroup" t-value="option.groupNumber"/>
                                    </t>
                                </AccordionItem>
                            </t>
                            <t t-else="">
                                <CheckboxItem class="{ 'o_menu_item text-truncate': true, selected: item.isActive }" checked="item.isActive" closingMode="'none'" t-esc="item.description" attrs="{ title: item.description.length &gt; 15 ? item.description : ''}" onSelected="() =&gt; this.onFilterSelected({ itemId: item.id })"/>
                            </t>
                            <t t-set="currentGroup" t-value="item.groupNumber"/>
                        </t>
                        <t t-if="filterItems.length">
                            <div role="separator" class="dropdown-divider"/>
                        </t>
                        <DropdownItem class="'o_menu_item o_add_custom_filter'" onSelected.bind="onAddCustomFilterClick">Custom Filter...</DropdownItem>
                    </div>
                </t>

                <t t-if="this.env.searchModel.searchMenuTypes.has('groupBy')">
                    <div class="o_dropdown_container o_group_by_menu w-100 w-lg-auto h-100 px-3 mb-4 mb-lg-0 border-end">
                        <div class="px-3 fs-5 mb-2">
                            <i class="me-2 text-action" t-att-class="facet_icons.groupBy"/>
                            <h5 class="o_dropdown_title d-inline">Group By</h5>
                        </div>
                        <t t-set="currentGroup" t-value="null"/>
                        <t t-foreach="groupByItems" t-as="item" t-key="item.id">
                            <t t-if="currentGroup !== null and currentGroup !== item.groupNumber">
                                <div class="dropdown-divider" role="separator"/>
                            </t>
                            <t t-if="item.fieldType === 'properties'">
                                <PropertiesGroupByItem item="item" onGroup.bind="onGroupBySelected"/>
                            </t>
                            <t t-elif="item.options">
                                <AccordionItem class="'text-truncate'" description="item.description" selected="item.isActive">
                                    <t t-set="subGroup" t-value="null"/>
                                    <t t-foreach="item.options" t-as="option" t-key="option.id">
                                        <t t-if="subGroup !== null and subGroup !== option.groupNumber">
                                            <div class="dropdown-divider" role="separator"/>
                                        </t>
                                        <CheckboxItem class="{ o_item_option: true, selected: option.isActive }" checked="option.isActive ? true : false" closingMode="'none'" t-esc="option.description" attrs="{ title: option.description.length &gt; 15 ? option.description : ''}" onSelected="() =&gt; this.onGroupBySelected({ itemId: item.id, optionId: option.id})"/>
                                        <t t-set="subGroup" t-value="option.groupNumber"/>
                                    </t>
                                </AccordionItem>
                            </t>
                            <t t-else="">
                                <CheckboxItem class="{ 'o_menu_item text-truncate': true, selected: item.isActive }" checked="item.isActive" closingMode="'none'" t-esc="item.description" attrs="{ title: item.description.length &gt; 15 ? item.description : ''}" onSelected="() =&gt; this.onGroupBySelected({ itemId: item.id })"/>
                            </t>
                            <t t-set="currentGroup" t-value="item.groupNumber"/>
                        </t>
                        <t t-if="!hideCustomGroupBy and fields.length">
                            <div t-if="groupByItems.length" role="separator" class="dropdown-divider"/>
                            <CustomGroupByItem fields="fields" onAddCustomGroup.bind="onAddCustomGroup"/>
                        </t>
                    </div>
                </t>

                <t t-if="this.env.searchModel.searchMenuTypes.has('favorite')">
                    <div class="o_dropdown_container o_favorite_menu w-100 w-lg-auto h-100 px-3">
                        <t t-set="sharedFavoritesItems" t-value="sharedFavorites"/>
                        <t t-set="favoriteItems" t-value="favorites"/>
                        <div class="px-3 fs-5 mb-2">
                            <i class="me-2 text-favourite" t-att-class="facet_icons.favorite"/>
                            <h5 class="o_dropdown_title d-inline">Favorites</h5>
                        </div>
                        <t t-foreach="favoriteItems" t-as="item" t-key="item.id">
                            <t t-call="web.SearchBarMenu.FavoriteItem"/>
                        </t>
                        <t t-if="favoriteItems.length">
                            <div role="separator" class="dropdown-divider"/>
                        </t>
                        <t t-foreach="sharedFavoritesItems" t-as="item" t-key="item.id">
                            <t t-call="web.SearchBarMenu.FavoriteItem"/>
                        </t>
                        <DropdownItem t-if="!this.state.sharedFavoritesExpanded" class="'o_menu_item o_expand_shared_favorites'" closingMode="'none'" onSelected.bind="() =&gt; this.state.sharedFavoritesExpanded = true">More...</DropdownItem>
                        <div t-if="sharedFavoritesItems.length" role="separator" class="dropdown-divider"/>
                        <t t-set="currentGroup" t-value="null"/>
                        <t t-foreach="otherItems" t-as="item" t-key="item.key">
                            <t t-if="currentGroup !== null and currentGroup !== item.groupNumber">
                                <div role="separator" class="dropdown-divider"/>
                            </t>
                            <t t-component="item.Component"/>
                            <t t-set="currentGroup" t-value="item.groupNumber"/>
                        </t>
                    </div>
                </t>
                <t t-slot="default"/>
            </t>
        </Dropdown>
    </t>

    `);
registerTemplate("web.SearchBarMenu.FavoriteItem", `/web/static/src/search/search_bar_menu/search_bar_menu.xml`, `<t t-name="web.SearchBarMenu.FavoriteItem" xml:space="preserve">
        <t t-set="item" t-value="item"/>
        <CheckboxItem class="{ 'o_menu_item o_favorite_item text-truncate': true, selected: item.isActive }" checked="item.isActive" closingMode="'none'" onSelected="() =&gt; this.onFavoriteSelected(item.id)">
            <span class="d-flex p-0 align-items-center justify-content-between">
                <span t-esc="item.description" t-att-title="item.description.length &gt; 15 ? item.description : ''" class="text-truncate flex-grow-1"/>
                <i class="ms-1 fa fa-pencil d-none" title="Edit favorite" t-on-click.stop="() =&gt; this.editFavorite(item.id)"/>
            </span>
        </CheckboxItem>
    </t>

`);
registerTemplate("web.SearchPanel", `/web/static/src/search/search_panel/search_panel.xml`, `<t t-name="web.SearchPanel" xml:space="preserve">
    <t t-if="env.isSmall">
        <t t-call="web.SearchPanel.Small"/>
    </t>
    <t t-else="">
        <t t-if="state.sidebarExpanded" t-call="web.SearchPanel.Regular"/>
        <t t-else="" t-call="web.SearchPanel.Sidebar"/>
    </t>
</t>

`);
registerTemplate("web.SearchPanel.Sidebar", `/web/static/src/search/search_panel/search_panel.xml`, `<t t-name="web.SearchPanel.Sidebar" xml:space="preserve">
    <div class="bg-view h-100 o_search_panel_sidebar cursor-pointer d-print-none" t-on-click="toggleSidebar">
        <t t-set="categories" t-value="getCategorySelection()"/>
        <t t-set="filters" t-value="getFilterSelection()"/>
        <div class="d-flex">
            <button class="btn btn-light btn-sm m-1 mb-2 p-2">
                <i class="oi oi-fw oi-panel-right fa-flip-horizontal"/>
            </button>
            <div class="o_search_panel_current_selection text-truncate mx-auto">
                <t t-if="!categories.length and !filters.length">
                    All
                </t>
                <t t-else="">
                    <t t-foreach="categories" t-as="category" t-key="category_index">
                        <span class="o_search_panel_category mb-2">
                            <i t-if="category.icon" t-attf-class="o_search_panel_section_icon fa {{ category.icon }} fa-rotate-90 mb-2" t-att-style="category.color and ('color: ' + category.color)"/>
                            <t t-esc="category.values.join(' / ')"/>
                        </span>
                    </t>
                    <t t-foreach="filters" t-as="filter" t-key="filter_index">
                        <span class="o_search_panel_filter mb-2">
                            <i t-if="filter.icon" t-attf-class="o_search_panel_section_icon fa {{ filter.icon }} fa-rotate-90 mb-2" t-att-style="filter.color and ('color: ' + filter.color)"/>
                            <t t-esc="filter.values.join(', ')"/>
                        </span>
                    </t>
                </t>
            </div>
        </div>
    </div>
</t>

`);
registerTemplate("web.SearchPanelContent", `/web/static/src/search/search_panel/search_panel.xml`, `<t t-name="web.SearchPanelContent" xml:space="preserve">
    <div class="o_search_panel flex-grow-0 flex-shrink-0 h-100 pb-5 bg-view overflow-auto position-relative" t-att-class="env.searchModel.searchPanelInfo.className" t-attf-class="#{env.isSmall ? 'px-3' : 'pe-1 ps-3'}" t-ref="root">
        <button t-if="!env.isSmall" class="btn btn-light btn-sm end-0 m-2 position-absolute px-2 py-1 top-0 z-1" t-on-click="toggleSidebar">
            <i class="oi oi-fw oi-panel-right fa-flip-horizontal"/>
        </button>
        <div t-if="!sections or sections.length === 0" class="o_search_panel_empty_state me-3">
            <button class="btn mt-2 w-100 overflow-visible">
                <div class="d-flex align-items-center me-2 ms-auto">All</div>
            </button>
        </div>
        <section t-foreach="sections" t-as="section" t-key="section.id" t-attf-class="o_search_panel_section o_search_panel_{{ section.type }}">
            <header class="o_search_panel_section_header pt-4 pb-2 text-uppercase cursor-default">
                <i t-attf-class="fa {{ section.icon }} o_search_panel_section_icon {{!section.color &amp;&amp; section.type == 'filter' ? 'text-warning' : !section.color ? 'text-primary': ''}} me-2" t-att-style="section.color and ('color: ' + section.color)"/>
                <b t-esc="section.description"/>
            </header>
            <t t-call="web.SearchPanel.Section"/>
        </section>
    </div>
    <div class="h-100">
        <span class="o_search_panel_resize" t-on-click.stop.prevent="" t-on-pointerdown.stop.prevent="_onStartResize"/>
    </div>
</t>

`);
registerTemplate("web.SearchPanel.Section", `/web/static/src/search/search_panel/search_panel.xml`, `<t t-name="web.SearchPanel.Section" xml:space="preserve">
    <div t-if="section.errorMsg" class="alert alert-warning">
        <span><t t-esc="section.errorMsg"/></span>
    </div>
    <ul t-else="" class="list-group d-block o_search_panel_field px-2 px-md-0">
        <t t-if="section.type === 'category'" t-call="{{ constructor.subTemplates.category }}">
            <t t-set="values" t-value="section.rootIds"/>
        </t>
        <t t-elif="section.groups">
            <li t-foreach="section.sortedGroupIds" t-as="groupId" t-key="groupId" class="o_search_panel_filter_group list-group-item p-0 border-0" t-att-class="groupId_last? 'mb-0' : 'mb-3'">

                <t t-set="_section" t-value="section"/>
                <t t-set="group" t-value="section.groups.get(groupId)"/>
                <header class="o_search_panel_group_header pb-1">
                    <div class="form-check w-100">

                        <input type="checkbox" class="form-check-input" t-attf-id="{{ section.id }}_input_{{ groupId }})" t-on-click="() =&gt; this.toggleFilterGroup(section.id, group)"/>
                        <label t-attf-for="{{ section.id }}_input_{{ groupId }})" class="o_search_panel_label form-check-label d-flex align-items-center justify-content-between w-100 cursor-pointer" t-att-class="{ o_with_counters: group.enableCounters }" t-att-title="group.tooltip or false">
                            <span class="o_search_panel_label_title text-truncate" t-attf-class="{{ group.color_index ? 'o_tag o_badge badge rounded-pill o_tag_color_' + group.color_index : ''}}">
                                <t t-esc="group.name"/>
                            </span>
                        </label>
                    </div>
                </header>
                <ul class="list-group d-block">
                    <t t-call="{{ constructor.subTemplates.filtersGroup }}">
                        <t t-set="values" t-value="group.values"/>
                        <t t-set="isChildList" t-value="true"/>

                        <t t-set="section" t-value="_section"/>
                    </t>
                </ul>
            </li>
            <ul t-if="section.groups.get(false)" class="list-group d-block">
                <t t-call="{{ constructor.subTemplates.filtersGroup }}">
                    <t t-set="group" t-value="section.groups.get(false)"/>
                    <t t-set="values" t-value="group.values"/>

                    <t t-set="section" t-value="section"/>
                </t>
            </ul>
        </t>
        <t t-else="" t-call="{{ constructor.subTemplates.filtersGroup }}">
            <t t-set="values" t-value="section.values"/>
        </t>
    </ul>
</t>

`);
registerTemplate("web.SearchPanel.Regular", `/web/static/src/search/search_panel/search_panel.xml`, `<t t-name="web.SearchPanel.Regular" t-inherit="web.SearchPanelContent" t-inherit-mode="primary" xml:space="preserve"/>

`);
registerTemplate("web.SearchPanel.Small", `/web/static/src/search/search_panel/search_panel.xml`, `<t t-name="web.SearchPanel.Small" xml:space="preserve">
    <div class="o_search_panel w-100 overflow-visible" t-ref="root">
        <div class="d-flex overflow-auto align-items-center px-2 border-top">
            <div t-if="!sections or sections.length === 0" class="o_search_panel_empty_state me-3">
                <button class="btn w-100">
                    <div class="d-flex align-items-center me-2 ms-auto">All</div>
                </button>
            </div>
            <Dropdown t-foreach="sections" t-as="section" t-key="section.id" state="getDropdownState(section.id)" menuClass="'my-2 mx-1'" onOpened.bind="updateGroupHeadersChecked">
                <span class="btn btn-secondary my-2 mx-1 o-dropdown-caret">
                    <i t-attf-class="fa {{ section.icon }} o_search_panel_section_icon {{!section.color &amp;&amp; section.type == 'filter' ? 'text-warning' : !section.color ? 'text-primary': ''}} me-2" t-att-style="section.color and ('color: ' + section.color)"/>
                    <b class="pe-2" t-if="section.type !== 'category' || !state.active[section.id]" t-esc="section.description"/>
                    <b class="pe-2" t-else="" t-esc="section.values.get(section.activeValueId)['display_name']"/>
                </span>
                <t t-set-slot="content">
                    <div t-attf-class="o_search_panel_{{ section.type }}" class="o_search_panel_section">
                        <t t-call="web.SearchPanel.Section"/>
                    </div>
                    <div t-if="section.type !== 'category' and hasSelection(section.id)" class="text-end">
                        <a href="#" title="Clear All" class="btn btn-link text-nowrap text-uppercase" t-on-click="() =&gt; this.clearSelection(section.id)">CLEAR ALL</a>
                    </div>
                </t>
            </Dropdown>
            <a href="#" t-if="hasSelection()" title="Clear All" class="btn btn-link text-nowrap text-uppercase" t-on-click="() =&gt; this.clearSelection()">CLEAR ALL</a>
        </div>
    </div>
</t>

`);
registerTemplate("web.SearchPanel.Category", `/web/static/src/search/search_panel/search_panel.xml`, `<t t-name="web.SearchPanel.Category" xml:space="preserve">
    <t t-foreach="values" t-as="valueId" t-key="valueId">
        <t t-set="value" t-value="section.values.get(valueId)"/>
        <li class="o_search_panel_category_value list-group-item py-1 cursor-pointer border-0 pe-0" t-att-class="isChildList ? env.isSmall ? '' : 'o_treeEntry' : 'ps-0'">
            <header class="list-group-item list-group-item-action d-flex align-items-center px-0 py-lg-0 border-0" t-att-class="{'active text-black fw-bold': state.active[section.id] === valueId}" t-on-click="() =&gt; this.toggleCategory(section, value)">
                <div class="o_search_panel_label d-flex align-items-center overflow-hidden w-100 cursor-pointer mb-0" t-att-class="{'o_with_counters': section.enableCounters }" t-att-data-tooltip="value.display_name">
                    <button class="o_toggle_fold btn p-0 px-1 flex-shrink-0 text-center">
                        <i t-if="value.childrenIds.length" class="fa" t-att-class="{                                 'fa-caret-down' : state.expanded[section.id][valueId],                                 'fa-caret-right':  !state.expanded[section.id][valueId]                             }"/>
                    </button>
                    <span class="o_search_panel_label_title text-truncate" t-att-class="{'fw-bold' : value.bold}" t-esc="value.display_name"/>
                </div>
                <small t-if="section.enableCounters and value.__count gt 0" class="o_search_panel_counter text-muted mx-2 fw-bold" t-esc="value.__count"/>
            </header>
            <ul t-if="value.childrenIds.length and state.expanded[section.id][valueId]" class="list-group d-block">
                <t t-call="{{ constructor.subTemplates.category }}">
                    <t t-set="values" t-value="value.childrenIds"/>
                    <t t-set="isChildList" t-value="true"/>
                </t>
            </ul>
        </li>
    </t>
</t>

`);
registerTemplate("web.SearchPanel.FiltersGroup", `/web/static/src/search/search_panel/search_panel.xml`, `<t t-name="web.SearchPanel.FiltersGroup" xml:space="preserve">
    <li t-foreach="[...values.keys()]" t-as="valueId" t-key="valueId" class="o_search_panel_filter_value list-group-item p-0 mb-1 border-0 cursor-pointer" t-att-class="{ 'ps-2' : isChildList }">
        <t t-set="value" t-value="values.get(valueId)"/>
        <div class="form-check w-100">
            <input type="checkbox" t-attf-id="{{ section.id }}_input_{{ valueId }}" t-att-checked="state.active[section.id][valueId]" class="form-check-input" t-on-click="ev =&gt; this.toggleFilterValue(section.id, valueId, ev)"/>
            <label class="o_search_panel_label form-check-label d-flex align-items-center justify-content-between w-100 cursor-pointer" t-attf-for="{{ section.id }}_input_{{ valueId }}" t-att-title="(group and group.tooltip) or false">
                <span class="o_search_panel_label_title text-truncate" t-esc="value.display_name"/>
                <span t-if="section.enableCounters and value.__count gt 0" class="o_search_panel_counter text-muted mx-2 small" t-esc="value.__count"/>
            </label>
        </div>
    </li>
</t>

`);
registerTemplate("web.WithSearch", `/web/static/src/search/with_search/with_search.xml`, `<t t-name="web.WithSearch" xml:space="preserve">
    <t t-slot="default" context="searchModel.context" domain="searchModel.domain" groupBy="searchModel.groupBy" orderBy="searchModel.orderBy" display="searchModel.display"/>
  </t>

`);
registerTemplate("web.FileUploader", `/web/static/src/views/fields/file_handler.xml`, `<t t-name="web.FileUploader" xml:space="preserve">
        <t t-if="state.isUploading and props.showUploadingText">Uploading...</t>
        <span t-else="" t-on-click.prevent="onSelectFileButtonClick" style="display:contents">
            <t t-slot="toggler"/>
        </span>
        <t t-slot="default"/>
        <input type="file" t-att-name="props.inputName" t-ref="fileInput" t-attf-class="o_input_file d-none {{ props.fileUploadClass or '' }}" t-att-multiple="props.multiUpload ? 'multiple' : false" t-att-accept="props.acceptedFileExtensions or '*'" t-on-change="onFileChange"/>
    </t>

`);
registerTemplate("mail.ActionList", `/mail/static/src/core/common/action_list.xml`, `<t t-name="mail.ActionList" xml:space="preserve">
    <div class="o-mail-ActionList flex-shrink-0 d-flex" t-att-class="{ 'align-items-center': props.inline,'flex-column': !props.inline }">
        <t t-set="groupAttClass" t-value="{             [props.groupClass]: true,             'flex-column w-100 bg-transparent': !props.inline,             'o-inline rounded-3': props.inline,             'o-rounded-bubble': props.inline and !hasBtnBg,         }"/>
        <t t-foreach="groups" t-as="group" t-key="group_index">
            <span t-if="group.length" class="o-mail-ActionList-group btn-group" t-att-class="groupAttClass">
                <Action t-foreach="group" t-as="action" t-key="action.id" t-props="getActionProps(action, group, { isFirstInGroup: action_first, index: action_index, isLastInGroup: action_last })"/>
            </span>
            <t t-if="!group_last" t-call="mail.ActionList.groupSeparator"/>
        </t>
    </div>
</t>

`);
registerTemplate("mail.ActionList.groupSeparator", `/mail/static/src/core/common/action_list.xml`, `<t t-name="mail.ActionList.groupSeparator" xml:space="preserve">
    <span t-if="props.inline" class="text-muted align-self-stretch ms-2 me-1"/>
    <hr t-else="" class="mx-2 my-1 o-rounded-bubble"/>
</t>

`);
registerTemplate("mail.Action", `/mail/static/src/core/common/action_list.xml`, `<t t-name="mail.Action" xml:space="preserve">
    <t t-if="action.dropdown">
        <t t-component="Dropdown" menuClass="(action.dropdownMenuClass ?? '') + ' ' + store.discussDropdownMenuClass(this)" position="action.dropdownPosition" state="action.dropdownState">
            <t t-call="mail.Action.main"/>
            <t t-set-slot="content">
                <t t-if="action.dropdownComponent" t-component="action.dropdownComponent" t-props="action.dropdownComponentProps"/>
                <t t-elif="action.dropdownTemplate" t-call="{{ action.dropdownTemplate }}">
                    <t t-set="templateParams" t-value="action.dropdownTemplateParams"/>
                </t>
                <t t-elif="action.definition?.isMoreAction">
                    <t t-component="ActionList" actions="action.definition.actions" dropdown="true"/>
                </t>
                <t t-else="">No content.</t>
            </t>
        </t>
    </t>
    <t t-else="" t-call="mail.Action.main"/>
</t>

`);
registerTemplate("mail.Action.main", `/mail/static/src/core/common/action_list.xml`, `<t t-name="mail.Action.main" xml:space="preserve">
    <t t-set="isComposerRoundedBtn" t-value="props.inline and env.inComposer"/>
    <t t-set="isThreadRoundedBtn" t-value="props.inline and action.tags.includes('JOIN_LEAVE_CALL') and action.icon and !action.inlineName"/>
    <t t-set="btnClass" t-value="attClassObjectToString({         [action.btnClass ?? '']: true,         [action.tagClassNames]: true,         'position-relative': true,         'active': action.isActive,         'o-mail-ActionList-button btn btn-secondary btn-group-item': true,         'o-first': props.isFirstInGroup,         'o-last': props.isLastInGroup,         'o-odooControlPanelSwitchStyle': props.odooControlPanelSwitchStyle,         'o-hasBtnBg': hasBtnBg,         'rounded-circle': isComposerRoundedBtn or isThreadRoundedBtn,         'rounded-start-3': !isComposerRoundedBtn and !isThreadRoundedBtn and !action.tags.includes('JOIN_LEAVE_CALL') and props.inline and props.isFirstInGroup,         'rounded-end-3': !isComposerRoundedBtn and !isThreadRoundedBtn and !action.tags.includes('JOIN_LEAVE_CALL') and props.inline and props.isLastInGroup,         'px-2 o-py-1_5': props.inline and env.inMeetingView and !env.inComposer,         'o-px-1_5 py-1': props.inline and (hasBtnBg and !action.tags.includes('JOIN_LEAVE_CALL') and !env.inMeetingView) or (!hasBtnBg and env.inComposer),         'd-flex align-items-center': props.inline and hasBtnBg and action.tags.includes('JOIN_LEAVE_CALL') and !env.inChatWindow,         'o-p-1_5': props.inline and hasBtnBg and action.tags.includes('JOIN_LEAVE_CALL') and !env.inChatWindow and !env.inMeetingView,         'p-1 d-flex align-items-center': props.inline and hasBtnBg and action.tags.includes('JOIN_LEAVE_CALL') and env.inChatWindow,         'o-inline': props.inline,         'o-p-0_5': props.inline and !hasBtnBg and !env.inComposer,         'border-0': props.inline and !hasBtnBg and action.icon,         'border-2 o-px-0_5 o-mx-0_5': props.inline and !hasBtnBg and !action.icon,         'px-3 py-2': props.dropdown and ui.isSmall,         'py-1': props.dropdown and !ui.isSmall,         'text-start px-2': !props.inline and !ui.isSmall,         'btn-danger': action.tags.includes('DANGER'),         'btn-success': action.tags.includes('SUCCESS'),         'o-text-white border-0 o-simulateDarkTheme': store.shouldSimulateDarkTheme(this),         'bg-700': store.shouldSimulateDarkTheme(this) and !action.tags.includes('DANGER') and !action.tags.includes('SUCCESS') and !action.tags.includes('CALL_LAYOUT'),         'bg-transparent': store.shouldSimulateDarkTheme(this) and action.tags.includes('CALL_LAYOUT'),         'opacity-75 opacity-100-hover': action.tags.includes('CALL_LAYOUT'),     })"/>
    <t t-set="attrs" t-value="{ 'aria-label': action.name, 'disabled': action.disabledCondition, 'name': action.id, 'data-sequence': action.sequence, 'data-sequence-group': action.sequenceGroup, 'data-sequence-quick': action.sequenceQuick }"/>
    <t t-if="action.component and action.componentCondition" t-component="action.component" t-props="action.componentProps"/>
    <DropdownItem t-elif="props.dropdown" class="btnClass + ' d-flex align-items-center ' + (ui.isSmall ? 'gap-2' : 'gap-1')" tag="'button'" onSelected="(ev) =&gt; this.onSelected(action, ev)" attrs="attrs">
        <t t-call="mail.Action.content"/>
    </DropdownItem>
    <button t-else="" t-att-class="btnClass" t-att="Object.assign(attrs, { 'title': action.name })" t-on-click="(ev) =&gt; this.onSelected(action, ev)" t-att-data-hotkey="action.hotkey" t-att-style="props.style">
        <t t-call="mail.Action.content"/>
        <t t-if="action.badge" t-call="mail.Action.badge">
            <t t-set="extraBadgeClass" t-value="'position-absolute me-n1 mt-n1 end-0'"/>
        </t>
    </button>
</t>

`);
registerTemplate("mail.Action.content", `/mail/static/src/core/common/action_list.xml`, `<t t-name="mail.Action.content" xml:space="preserve">
    <t t-if="action.icon?.template" t-call="{{ action.icon.template }}">
        <t t-set="templateParams" t-value="action.icon.params"/>
    </t>
    <i t-elif="action.icon" t-attf-class="{{ action.icon }}" t-att-class="{ 'o-fs-small': props.dropdown, 'fa-fw': props.fw }"/>
    <i t-elif="props.dropdown" class="fa-question fa-fw opacity-0" t-att-class="props.fw ? 'fa-fw' : ''"/>
    <span t-if="action.name and (props.dropdown or (props.inline and (!action.icon or action.inlineName)))" class="o-mail-ActionList-actionLabel" t-attf-class="{{ action.nameClass }}" t-att-class="{ 'mx-1': props.dropdown }" t-out="(props.inline and action.inlineName) or action.name"/>
    <t t-if="props.dropdown and action.badge" t-call="mail.Action.badge"/>
</t>

`);
registerTemplate("mail.Action.badge", `/mail/static/src/core/common/action_list.xml`, `<t t-name="mail.Action.badge" xml:space="preserve">
    <span class="fw-bolder badge p-0 rounded-circle d-flex justify-content-center align-items-center" t-attf-class="{{ extraBadgeClass }}" t-att-class="{ 'bg-warning': action.tags.includes('WARNING_BADGE'), 'o-discuss-badge': action.tags.includes('IMPORTANT_BADGE') }" style="aspect-ratio: 1; font-size: 0.6rem;">
        <i t-if="action.badgeIcon" t-att-class="action.badgeIcon"/><span t-elif="action.badgeText" t-esc="action.badgeText"/>
    </span>
</t>

`);
registerTemplate("mail.AttachmentList", `/mail/static/src/core/common/attachment_list.xml`, `<t t-name="mail.AttachmentList" xml:space="preserve">
        <div class="o-mail-AttachmentList overflow-y-auto d-flex flex-column mt-1" t-att-class="{                 'o-inComposer': env.inComposer,                 'o-inChatWindow': env.inChatWindow,             }">
            <div class="d-flex flex-wrap gap-2" t-att-class="{'justify-content-end': isInChatWindowAndIsAlignedRight and !env.inComposer}" role="menu">
                <div t-foreach="props.attachments" t-as="attachment" t-key="attachment.id" t-att-aria-label="attachment.name" class="o-mail-AttachmentContainer d-flex border position-relative rounded-3" t-att-title="attachment.name ? attachment.name : undefined" t-att-class="{                         'o-inMessage': env.inMessage,                         'o-isImage': attachment.isImage,                         'o-isUploading opacity-25': attachment.uploading,                         'o-viewable': attachment.isViewable,                     }" tabindex="0" t-att-data-mimetype="attachment.mimetype" t-on-click="() =&gt; this.onClickAttachment(attachment)" role="menuitem">

                    <Gif t-if="attachment.mimetype === 'image/gif'" src="getImageUrl(attachment)" paused="attachment.gifPaused" alt="attachment.name" class="'o-mail-AttachmentImage img img-fluid w-100 rounded-3 ' + (env.inMessage ? 'object-fit-contain o-inMessage' : 'object-fit-cover')"/>
                    <img t-elif="attachment.isImage" class="o-mail-AttachmentImage img img-fluid w-100 rounded-3" t-att-class="{ 'object-fit-contain o-inMessage': env.inMessage, 'object-fit-cover': !env.inMessage }" t-att-src="getImageUrl(attachment)" t-att-alt="attachment.name" t-on-load="onImageLoaded"/>

                    <div t-else="" class="o-mail-AttachmentCard d-flex flex-column w-100 h-100">
                        <div class="d-flex justify-content-center align-items-center flex-grow-1 bg-white position-relative rounded-3 rounded-bottom-0" t-on-click="() =&gt; this.onClickAttachment(attachment)">
                            <div t-if="!attachment.has_thumbnail" class="o_image" role="menuitem" aria-label="Preview" t-att-tabindex="-1" t-att-aria-disabled="false" t-att-data-mimetype="attachment.mimetype"/>
                            <img t-else="" t-att-src="attachment.thumbnailUrl" t-att-alt="attachment.name"/>
                        </div>
                         <div class="o-mail-AttachmentCard-info d-flex align-items-center px-2 py-1 bg-200 rounded-bottom-3">
                            <div class="o-mail-AttachmentCard-image o_image me-2 flex-shrink-0" role="menuitem" aria-label="Preview" t-att-tabindex="-1" t-att-aria-disabled="false" t-att-data-mimetype="attachment.mimetype"/>
                            <div t-if="attachment.name" class="text-truncate align-items-center fw-bold" t-out="props.messageSearch?.highlight(attachment.name) ?? attachment.name"/>
                        </div>
                    </div>

                    <div t-if="!isMobileOS" class="o-mail-Attachment-hover position-absolute top-0 bottom-0 start-0 end-0 p-2 d-flex flex-column align-items-start o-opacity-hoverable opacity-100-hover opacity-0 rounded-3" t-att-class="{ 'o-image': attachment.isImage }">
                        <div class="d-flex flex-row align-items-start gap-2">
                            <img t-if="attachment.isImage" src="/mail/static/src/img/image_icon.png" class="mw-100 mh-100 rounded o-mt-0_5" draggable="false"/>
                            <div t-else="" class="o-mail-Attachment-hover-image o_image flex-shrink-0" t-att-data-mimetype="attachment.mimetype"/>
                            <div t-if="attachment.name" class="o-mail-Attachment-hoverImageText fw-bold overflow-hidden text-break" t-att-class="{ 'o-text-white': attachment.isImage }" t-out="props.messageSearch?.highlight(attachment.name) ?? attachment.name"/>
                        </div>
                        <div t-if="attachment.file_size" class="ms-4 o-mt-0_5" t-att-class="{ 'ps-1': !attachment.isImage }">
                            <span class="opacity-75" t-att-class="{ 'o-text-white': attachment.isImage }"><t t-out="Math.round(attachment.file_size / 1024, 4)"/>KB</span>
                        </div>

                        <div class="o-mail-AttachmentButtons d-flex justify-content-start ms-4 mb-1 mt-auto pt-2">
                            <a t-if="!attachment.isImage and attachment.type === 'url'" class="w-100 h-100 btn bg-500 o-p-1_5 d-flex justify-content-center align-items-center" t-att-href="attachment.url" target="_blank" title="Open Link">
                                <i class="fa fa-external-link o-text-white" role="img" aria-label="Open Link"/>
                            </a>
                            <button t-elif="canDownload(attachment)" class="btn bg-500 w-100 h-100 o-p-1_5 d-flex justify-content-center align-items-center shadow-sm" t-on-click.stop="() =&gt; this.onClickDownload(attachment)" title="Download">
                                <i class="fa fa-download o-text-white" role="img" aria-label="Download"/>
                            </button>
                            <button t-if="showDelete" class="o-mail-Attachment-unlink btn bg-500 w-100 h-100 o-p-1_5 d-flex ms-2 justify-content-center align-items-center shadow-sm" t-att-class="{ 'o-inComposer': env.inComposer }" t-on-click.stop="() =&gt; this.onClickUnlink(attachment)" title="Remove">
                                <i class="fa fa-trash o-text-white" role="img" aria-label="Remove"/>
                            </button>
                        </div>
                    </div>

                    <Actions t-else="" actions="getActions(attachment)"/>

                    <div t-if="attachment.uploading" class="position-absolute top-0 bottom-0 start-0 end-0 d-flex align-items-center justify-content-center" title="Uploading">
                        <i class="fa fa-circle-o-notch fa-spin"/>
                    </div>

                    <div t-if="showUploaded(attachment)" class="o-Attachment-uploaded position-absolute top-0 d-flex" t-att-class="!isMobileOS ? 'end-0' : 'start-0'" title="Uploaded">
                        <i class="fa fa-check"/>
                    </div>
                </div>
            </div>
        </div>
    </t>

    `);
registerTemplate("mail.Actions", `/mail/static/src/core/common/attachment_list.xml`, `<t t-name="mail.Actions" xml:space="preserve">
        <div class="position-absolute end-0 p-1 o-text-white">
            <button t-if="props.actions.length === 1" class="btn btn-sm btn-light rounded px-1 py-0" tabindex="0" t-att-aria-label="props.actions[0].label" t-att-title="props.actions[0].label" role="menuitem" t-on-click.stop="props.actions[0].onSelect">
                <i t-att-class="props.actions[0].icon"/>
            </button>
            <Dropdown t-else="" menuClass="'d-flex flex-column py-0'" state="actionsMenuState" position="'right-start'">
                <button class="btn btn-sm btn-light rounded px-1 py-0" tabindex="0" aria-label="Actions" title="Actions" role="menuitem">
                    <i class="oi oi-chevron-down"/>
                </button>
                <t t-set-slot="content">
                    <DropdownItem t-foreach="props.actions" t-as="action" t-key="action_index" class="'px-2 py-1 d-flex align-items-center rounded-0'" onSelected="action.onSelect">
                        <i class="fa-fw" t-att-class="action.icon"/>
                        <span class="mx-2" t-out="action.label"/>
                    </DropdownItem>
                </t>
            </Dropdown>
        </div>
    </t>

`);
registerTemplate("mail.AttachmentView", `/mail/static/src/core/common/attachment_view.xml`, `<t t-name="mail.AttachmentView" xml:space="preserve">
        <div t-if="state.thread.attachmentsInWebClientView.length &gt; 0" class="o-mail-Attachment">
            <div class="o_attachment_control popout d-print-none cursor-pointer" t-on-click="onClickPopout" data-tooltip="Open preview in a separate window." data-tooltip-delay="400">
                <i class="fa fa-window-restore" aria-hidden="Pop out"/>
            </div>
            <t t-if="state.thread.message_main_attachment_id">
                <h3 t-if="!state.thread.message_main_attachment_id.isPdf" class="mt0 mb8 ps-2 text-muted text-center"><t t-esc="displayName"/></h3>
                <div t-if="state.thread.message_main_attachment_id.isImage" class="o-mail-Attachment-imgContainer">
                    <img id="attachment_img" class="img img-fluid d-block" t-att-src="state.thread.message_main_attachment_id.defaultSource"/>
                </div>
                <iframe t-if="state.thread.message_main_attachment_id.isPdf" class="d-print-none mb48" t-att-src="state.thread.message_main_attachment_id.defaultSource" t-ref="iframeViewerPdf"/>
                <t t-if="state.thread.attachmentsInWebClientView.length &gt; 1 or (state.thread.attachmentsInWebClientView.length &gt; 0 and !(state.thread.message_main_attachment_id.isPdf or state.thread.message_main_attachment_id.isImage))">
                    <a class="arrow o_move_previous text-center" href="#" t-on-click.prevent="onClickPrevious">
                        <span class="oi oi-chevron-left"/>
                    </a>
                    <a class="arrow o_move_next text-center" href="#" t-on-click.prevent="onClickNext">
                        <span class="oi oi-chevron-right"/>
                    </a>
                </t>
            </t>
        </div>
    </t>

    `);
registerTemplate("mail.PopoutAttachmentView", `/mail/static/src/core/common/attachment_view.xml`, `<t t-name="mail.PopoutAttachmentView" xml:space="preserve">
        <div class="o-mail-PopoutAttachmentView">
            <t t-call="mail.AttachmentView"/>
        </div>
    </t>

`);
registerTemplate("mail.AutoresizeInput", `/mail/static/src/core/common/autoresize_input.xml`, `<t t-name="mail.AutoresizeInput" xml:space="preserve">
    <input class="o-mail-AutoresizeInput px-1 border-1 text-truncate rounded" t-attf-class="{{ props.className }}" t-att-class="{'o-focused': state.isFocused}" t-att-placeholder="props.placeholder" t-att-disabled="!props.enabled" t-att-title="state.value" t-model="state.value" t-on-keydown="onKeydownInput" t-on-focus="() =&gt; this.state.isFocused = true" t-on-blur="onBlurInput" t-ref="input" type="text"/>
</t>

`);
registerTemplate("mail.ChatBubble", `/mail/static/src/core/common/chat_bubble.xml`, `<t t-name="mail.ChatBubble" xml:space="preserve">
        <div class="o-mail-ChatBubble position-relative" t-att-name="props.chatWindow.displayName" t-att-class="{ 'o-bouncing': state.bouncing, 'o-active': popover.isOpen, 'o-mobile': isMobileOS }" t-on-click="() =&gt; props.chatWindow.open({ focus: true })" t-on-animationend="() =&gt; state.bouncing = false" t-ref="root">
            <span class="o-mail-ChatBubble-unreadIndicator position-absolute" t-att-class="{ 'opacity-0': !thread?.isUnread or thread?.importantCounter }"><i class="fa fa-circle"/></span>
            <div t-if="thread?.importantCounter &gt; 0" class="o-mail-ChatBubble-counter position-absolute badge rounded-pill fw-bold o-discuss-badge shadow" t-out="thread?.importantCounter"/>
            <button t-if="!env.embedLivechat and !isMobileOS" class="o-mail-ChatBubble-close position-absolute shadow rounded-circle fw-bold bg-view" title="Close Chat Bubble" t-on-click.stop="() =&gt; this.props.chatWindow.close()"><i class="oi oi-close"/></button>
            <ImStatus t-if="showImStatus" className="'o-mail-ChatBubble-status position-absolute'" member="thread.correspondent">
                <t t-set-slot="pre_icon">
                    <i style="font-size: 18px; right: -2px; bottom: -2px; z-index: -1;" t-att-class="{                         'bg-success rounded-pill position-absolute': thread?.correspondent?.isTyping,                         'fa fa-circle position-absolute text-100': !thread?.correspondent?.isTyping,                     }"/>
                </t>
            </ImStatus>
            <CountryFlag t-if="thread?.showCorrespondentCountry" country="thread.correspondentCountry" class="'o-mail-ChatBubble-country position-absolute bottom-0 border shadow-sm'"/>
            <button class="o-mail-ChatHub-bubbleBtn btn shadow">
                <img class="o-mail-ChatBubble-avatar bg-view rounded-circle object-fit-cover" t-att-class="{ 'o-big': env.embedLivechat }" t-att-src="thread?.avatarUrl" alt="Thread image" draggable="false"/>
            </button>
        </div>
    </t>

    `);
registerTemplate("mail.ChatBubblePreview", `/mail/static/src/core/common/chat_bubble.xml`, `<t t-name="mail.ChatBubblePreview" xml:space="preserve">
        <div class="o-mail-ChatBubble-preview o-mail-ChatBubble-menu px-0 py-1 shadow-sm border border-secondary bg-100 o-rounded-bubble">
            <div class="text-truncate base-fs fw-bolder mb-0 mx-2 px-1" t-esc="props.chatWindow.displayName"/>
            <t t-set="message" t-value="thread?.newestPersistentOfAllMessage"/>
            <div t-if="previewText" class="text-truncate small mx-2 px-1 text-muted">
                <t t-call="mail.message_preview_prefix">
                    <t t-set="message" t-value="message"/>
                </t>
                <t t-if="message.hasOnlyAttachments">
                    <i class="fa me-1" t-att-class="message.previewIcon"/>
                    <t t-out="message.previewText"/>
                </t>
                <t t-else="" t-out="previewText"/>
            </div>
        </div>
    </t>


    `);
registerTemplate("mail.message_preview_prefix", `/mail/static/src/core/common/chat_bubble.xml`, `<t t-name="mail.message_preview_prefix" xml:space="preserve">
        <t t-if="message.isSelfAuthored">
            <i class="fa fa-mail-reply me-1 opacity-75"/>You:
        </t>
        <t t-elif="!message.author?.eq(thread.correspondent?.persona)">
            <t t-esc="message.authorName"/>:
        </t>
    </t>

`);
registerTemplate("mail.ChatHub", `/mail/static/src/core/common/chat_hub.xml`, `<t t-name="mail.ChatHub" xml:space="preserve">
    <div class="o-mail-ChatHub d-print-none">

        <t t-set="visibleChatWindows" t-value="chatHub.compact ? chatHub.opened.filter(({ bypassCompact }) =&gt; bypassCompact) : chatHub.opened "/>
        <t t-foreach="visibleChatWindows" t-as="cw" t-key="cw.localId">
            <ChatWindow chatWindow="cw" t-if="cw.canShow" right="chatHub.BUBBLE_START + chatHub.BUBBLE + (chatHub.BUBBLE_OUTER*2) + (visibleChatWindows.length - cw_index - 1) * (chatHub.WINDOW + chatHub.WINDOW_INBETWEEN * 2)"/>
        </t>
        <div class="o-mail-ChatHub-bubbles position-fixed d-flex flex-column align-content-start justify-content-end align-items-center" t-attf-style="top: {{position.top}}; left: {{position.left}}; right: {{position.right}}; --mail-ChatHub-bubbles-bottom: {{position.bottom}}" t-att-class="{ 'o-liftUp': busMonitoring.hasConnectionIssues, 'o-mobile': isMobileOS }" t-ref="bubbles">
            <div class="d-flex flex-column align-content-start justify-content-end align-items-center gap-1">
                <Dropdown t-if="(chatHub.showConversations and !chatHub.compact) or position.dragged" state="options" position="'top-end'" menuClass="'m-0 mb-1 ' + store.discussDropdownMenuClass(this)">
                    <button class="o-mail-ChatHub-bubbleBtn btn o-mail-ChatHub-optionsBtn bg-100 mt-1" t-att-class="{ 'opacity-0': !bubblesHover.isHover and !position.dragged and !options.isOpen and !isMobileOS, 'o-bubblesHover': (bubblesHover.isHover or position.dragged) and !isMobileOS, 'o-active': bubblesHover.isHover or options.isOpen }" title="Chat Options"><i class="oi oi-ellipsis-h"/></button>
                    <t t-set-slot="content">
                        <ActionList actions="optionActions" dropdown="true"/>
                    </t>
                </Dropdown>
                <t t-if="store.chatHub.compact and chatHub.showConversations" t-call="mail.ChatHub.compactButton"/>
                <t t-else="">
                    <t t-foreach="chatHub.folded.slice(0, chatHub.maxFolded)" t-as="cw" t-key="cw.localId">
                        <ChatBubble t-if="cw.canShow" chatWindow="cw"/>
                    </t>
                    <div class="o-mail-ChatHub-extraActions"/>
                    <t t-if="chatHub.showConversations and chatHub.folded.length &gt; chatHub.maxFolded" t-call="mail.ChatHub.hiddenButton"/>
                </t>
            </div>
        </div>
    </div>
</t>

`);
registerTemplate("mail.ChatHub.compactButton", `/mail/static/src/core/common/chat_hub.xml`, `<t t-name="mail.ChatHub.compactButton" xml:space="preserve">

    <Dropdown manual="true">
        <div class="o-mail-ChatHub-bubbleBtn o-mail-ChatHub-compact o-mail-ChatBubble justify-content-center">
            <div t-if="compactCounter &gt; 0" class="o-mail-ChatHub-hiddenBtnCounter position-absolute badge rounded-pill fw-bold o-discuss-badge shadow">
                <t t-out="compactCounter"/>
            </div>
            <button class="o-mail-ChatHub-bubbleBtn btn fs-2 shadow" t-on-click="expand">
                <i class="o-mail-ChatHub-hiddenBtnIcon d-flex justify-content-center align-items-center btn rounded-circle shadow-sm fa fa-comments"/>
            </button>
        </div>
    </Dropdown>
</t>

`);
registerTemplate("mail.ChatHub.hiddenButton", `/mail/static/src/core/common/chat_hub.xml`, `<t t-name="mail.ChatHub.hiddenButton" xml:space="preserve">
    <Dropdown t-if="chatHub.folded.length &gt; chatHub.maxFolded" state="more" position="'left-middle'" menuClass="'o-mail-ChatHub-hiddenMenu mx-1 my-0 bg-100 ' + store.discussDropdownMenuClass(this)" manual="true">
        <div class="o-mail-ChatBubble o-mail-ChatHub-hiddenBtn justify-content-center" t-att-class="{ 'o-active': more.isOpen }" t-on-click="() =&gt; store.chatHub.compact = true" t-ref="more-button">
            <div t-if="hiddenCounter &gt; 0" class="o-mail-ChatHub-hiddenBtnCounter position-absolute badge rounded-pill fw-bold o-discuss-badge shadow">
                <t t-out="hiddenCounter"/>
            </div>
            <button class="o-mail-ChatHub-bubbleBtn btn outline-0 shadow">
                <span class="o-mail-ChatHub-hiddenBtnIcon d-flex justify-content-center align-items-center btn rounded-circle shadow-sm fs-2" t-att-class="{ 'o-active': more.isOpen }">+<t t-esc="chatHub.folded.slice(chatHub.maxFolded).length"/></span>
            </button>
        </div>
        <t t-set-slot="content">
            <ul class="m-0 p-0 overflow-auto o-scrollbar-thin bg-100" role="menu" t-ref="more-menu">
                <t t-foreach="chatHub.folded.slice(chatHub.maxFolded)" t-as="cw" t-key="cw.localId">
                    <li class="o-mail-ChatHub-hiddenItem gap-2 px-2 py-1" role="menuitem" t-att-name="cw.displayName" t-on-click="() =&gt; cw.open({ focus: true })">
                        <img class="o-mail-ChatHub-hiddenAvatar rounded-circle object-fit-cover" t-att-src="cw.thread?.avatarUrl" alt="Thread image" draggable="false"/>
                        <p class="text-truncate fw-bold mb-0" t-esc="cw.displayName"/>
                        <div t-if="cw.thread?.importantCounter &gt; 0" class="o-mail-ChatHub-hiddenCounter badge rounded-pill fw-bold o-discuss-badge" style="padding: 3px 6px">
                            <t t-out="cw.thread?.importantCounter"/>
                        </div>
                        <button class="o-mail-ChatHub-hiddenClose o-mail-ChatBubble-close d-flex align-items-center rounded" t-on-click.stop="() =&gt; cw.close()">
                            <i class="oi oi-close"/>
                        </button>
                    </li>
                </t>
            </ul>
        </t>
    </Dropdown>
</t>

`);
registerTemplate("mail.ChatWindow", `/mail/static/src/core/common/chat_window.xml`, `<t t-name="mail.ChatWindow" xml:space="preserve">
    <t t-set="partitionedActions" t-value="threadActions.partition"/>
    <div class="o-mail-ChatWindow fixed-bottom overflow-hidden d-flex flex-column shadow bg-100" t-att-style="style" t-att-class="attClass" t-on-keydown="onKeydown" tabindex="1">
        <div class="o-mail-ChatWindow-header d-flex align-items-center flex-shrink-0 bg-100 z-1 border-bottom border-secondary" t-on-click="onClickHeader" t-att-class="{ 'cursor-pointer': !ui.isSmall and !props.chatWindow.actionsDisabled }">
            <t t-if="hasActionsMenu">
                <div class="d-flex text-truncate bg-inherit">
                    <Dropdown position="ui.isSmall ? 'bottom-end' : 'left-start'" onStateChanged="isOpen =&gt; this.onActionsMenuStateChanged(isOpen)" menuClass="store.discussDropdownMenuClass(this)">
                        <button class="o-mail-ChatWindow-moreActions btn rounded-0 d-flex align-items-center o-ps-1_5 pe-0 py-1 my-0 w-100 rounded-end-0 bg-inherit" t-att-class="{ 'rounded-top-3': !ui.isSmall, 'o-active': state.actionsMenuOpened, 'o-hover': actionsMenuButtonHover.isHover and !parentChannelHover.isHover }" t-att-disabled="state.editingName or props.chatWindow.actionsDisabled" t-att-title="actionsMenuTitleText" t-ref="actionsMenuButton">
                            <t t-call="mail.ChatWindow.headerContent"/>
                            <i t-if="!state.editingName" class="fa fa-fw fa-caret-down"/>
                        </button>
                        <t t-set-slot="content">
                            <t t-set="quickActionsInDropdown" t-value="partitionedActions.quick.slice(ui.isSmall ? 2 : 4)"/>
                            <ActionList actions="[quickActionsInDropdown, partitionedActions.other, ...partitionedActions.group]" dropdown="true" thread="thread"/>
                        </t>
                    </Dropdown>
                </div>
                <AutoresizeInput t-if="state.editingName" className="'text-truncate fw-bold flex-shrink-1 me-1 py-0 ' + (ui.isSmall ? 'fs-4' : 'fs-5')" enabled="true" autofocus="true" onValidate.bind="renameThread" value="props.chatWindow.displayName"/>
                <i t-if="state.editingName" class="fa fa-fw fa-caret-down opacity-50"/>
            </t>
            <t t-else="">
                <t t-call="mail.ChatWindow.headerContent"/>
            </t>
            <div t-if="thread and thread.importantCounter &gt; 0" class="o-mail-ChatWindow-counter mx-1 badge rounded-pill fw-bold o-discuss-badge shadow-sm" t-ref="needactionCounter">
                <t t-out="thread.importantCounter"/>
            </div>
            <div class="ms-1 flex-grow-1"/>
            <div class="d-flex flex-shrink-0 me-1">
                <ActionList actions="partitionedActions.quick.slice(0, ui.isSmall ? 2 : 4).reverse()" inline="true" thread="thread"/>
            </div>
            <t t-if="this.store.inPublicPage and !this.store.self_partner">
                <button class="btn ps-1" t-if="!state.editingGuestName">
                    <img class="o-mail-DiscussContent-selfAvatar rounded-circle object-fit-cover flex-shrink-0" alt="Avatar" t-att-src="store.self.avatarUrl" t-on-click="() =&gt; state.editingGuestName = true"/>
                </button>
                <AutoresizeInput t-if="state.editingGuestName" className="'py-1 me-2'" autofocus="true" onValidate.bind="renameGuest" value="store.self.name"/>
            </t>
        </div>
        <div t-if="!props.chatWindow.folded or ui.isSmall" class="d-flex flex-column h-100 overflow-auto o-scrollbar-thin position-relative bg-inherit" t-att-class="{ 'opacity-50': state.editingName }" t-ref="content">
            <t name="thread content">
                <div t-if="threadActions.activeAction?.actionPanelComponentCondition" class="h-100" t-attf-class="{{ threadActions.activeAction.panelOuterClass }}">
                    <t t-component="threadActions.activeAction.actionPanelComponent" t-props="{ ...threadActions.activeAction.actionPanelComponentProps, thread }"/>
                </div>
                <t t-elif="thread">
                    <Thread autofocus="isMobileOS ? props.chatWindow.autofocus : undefined" isInChatWindow="true" thread="thread" t-key="thread.localId" jumpPresent="state.jumpThreadPresent" jumpToNewMessage="props.chatWindow.jumpToNewMessage"/>
                    <t t-call="mail.ChatWindow.memberTyping"/>
                    <Composer composer="thread.composer" autofocus="isMobileOS ? undefined : props.chatWindow.autofocus" mode="'compact'" onPostCallback.bind="() =&gt; this.state.jumpThreadPresent++" dropzoneRef="contentRef" type="composerType"/>
                </t>
            </t>
        </div>
    </div>
</t>

`);
registerTemplate("mail.ChatWindow.headerContent", `/mail/static/src/core/common/chat_window.xml`, `<t t-name="mail.ChatWindow.headerContent" xml:space="preserve">
    <div class="o-mail-ChatWindow-threadAvatar position-relative bg-inherit my-0 me-1" t-att-class="{         'py-1': !thread or threadActions.actions.length gt 3,         'py-2': thread and threadActions.actions.length lte 3,         'ms-1': thread,         'ms-3': !thread,         'ps-2': !hasActionsMenu,     }" name="threadAvatar">
        <img t-if="thread" class="rounded-3 object-fit-cover" t-att-src="thread.parent_channel_id?.avatarUrl ?? thread.avatarUrl" alt="Thread Image"/>
        <ImStatus t-if="showImStatus" className="'o-mail-ChatWindow-imStatus position-absolute'" member="thread.correspondent" size="'sm'"/>
    </div>
    <t t-if="thread?.parent_channel_id">
        <span class="fw-bold small o-mx-0_5 opacity-75 opacity-100-hover cursor-pointer o-hover-text-underline rounded fs-6" t-esc="thread.parent_channel_id.displayName" title="Open Channel" t-ref="parentChannel" t-on-click.stop="() =&gt; this.thread.parent_channel_id.open({ focus: true })"/>
        <i class="fa fa-chevron-right o-xsmaller ms-1 mt-1 text-muted opacity-75"/>
    </t>
    <CountryFlag t-if="thread?.showCorrespondentCountry" country="thread.correspondentCountry" class="'o-mail-ChatWindow-country border shadow-sm'"/>
    <div t-if="!state.editingName" class="text-truncate fw-bold border border-transparent o-mx-0_5 my-0 py-1" t-att-title="props.chatWindow.displayName" t-esc="props.chatWindow.displayName" t-att-class="{ 'fs-4': ui.isSmall, 'fs-5': !ui.isSmall }"/>
</t>

`);
registerTemplate("mail.ChatWindow.memberTyping", `/mail/static/src/core/common/chat_window.xml`, `<t t-name="mail.ChatWindow.memberTyping" xml:space="preserve">
    <div t-if="thread.hasOtherMembersTyping" class="d-flex bg-inherit position-relative">
        <div class="o-mail-ChatWindow-typing d-flex px-3 position-absolute bottom-0 start-0 w-100 bg-inherit align-items-center">
            <Typing channel="thread" size="'medium'"/>
        </div>
    </div>
</t>

`);
registerTemplate("mail.Composer", `/mail/static/src/core/common/composer.xml`, `<t t-name="mail.Composer" xml:space="preserve">
    <t t-set="isChatterComposer" t-value="extended and !props.composer.message"/>
    <t t-set="partitionedActions" t-value="composerActions.partition"/>
    <t t-set="compact" t-value="props.mode === 'compact'"/>
    <t t-set="normal" t-value="props.mode === 'normal'"/>
    <t t-set="extended" t-value="props.mode === 'extended'"/>
    <t t-set="actionsContainerClass" t-value="'o-mail-Composer-actions d-flex o-rounded-bubble'"/>
    <div t-ref="root">
        <div class="o-mail-Composer d-grid flex-shrink-0 pt-0 position-relative" t-att-class="{                     'pb-2': extended and !props.composer.message,                     'o-extended': extended,                     'o-isUiSmall': ui.isSmall,                     'ps-2 pe-4 pb-2': normal and !env.inDiscussApp and !env.inMeetingView,                     'ps-0 pe-3 pb-2': normal and env.inMeetingView,                     'o-hasSelfAvatar': showComposerAvatar,                     'o-focused': props.composer.isFocused,                     'o-editing': props.composer.message,                     'o-chatWindow mx-2 my-1': env.inChatWindow,                     'mb-2': env.inChatWindow and !props.composer.message,                     'o-discussApp pt-1 ps-2 pe-4 o-pb-2_5': env.inDiscussApp,                 }" t-attf-class="{{ props.className }}">
            <FileUploader t-if="allowUpload" multiUpload="isMultiUpload" onUploaded.bind="(data) =&gt; { attachmentUploader.uploadData(data) }">
                <t t-set-slot="toggler">
                    <button t-att-disabled="!state.active or areAllActionsDisabled" class="d-none" title="Attach files" aria-label="Attach files" t-ref="file-uploader"><i class="fa fa-fw fa-paperclip"/></button>
                </t>
            </FileUploader>
            <div t-if="showComposerAvatar" class="o-mail-Composer-sidebarMain flex-shrink-0 d-flex">
                <img class="o-mail-Composer-avatar mx-auto o_avatar rounded-3" t-att-src="(thread?.effectiveSelf or message.effectiveSelf).avatarUrl" alt="Avatar of user"/>
            </div>
            <div class="o-mail-Composer-coreHeader">
                <div t-if="props.composer.replyToMessage" class="text-truncate small p-2">
                    <span class="cursor-pointer" t-on-click="() =&gt; env.messageHighlight?.highlightMessage(props.composer.replyToMessage, props.composer.thread)">
                        Replying to <b t-esc="props.composer.replyToMessage.authorName"/>
                    </span>
                    <span t-if="props.composer.replyToMessage.thread?.notEq(props.composer.thread)">
                        on: <b><t t-esc="props.composer.replyToMessage.thread.displayName"/></b>
                    </span>
                    <i class="fa fa-lg fa-times-circle rounded-circle p-0 ms-1 cursor-pointer" title="Stop replying" t-on-click="() =&gt; (props.composer.replyToMessage = undefined)"/>
                </div>
                <span t-if="props.composer.message and ui.isSmall" class="px-1" t-on-click="onClickCancelOrSaveEditText">
                    <button class="btn btn-sm btn-secondary rounded-pill border border-secondary ps-1 pe-2 py-0 mb-1" t-att-data-type="EDIT_CLICK_TYPE.CANCEL">
                        <i class="oi oi-close pe-2" t-att-data-type="EDIT_CLICK_TYPE.CANCEL"/>
                        Discard editing
                    </button>
                </span>
            </div>
            <div class="o-mail-Composer-coreMain d-flex flex-nowrap align-items-start flex-grow-1" t-att-class="{ 'flex-column' : extended or props.composer.message }">
                <div class="o-mail-Composer-inputContainer o-mail-Composer-bg d-flex flex-grow-1 border o-rounded-bubble" t-att-class="{                         'o-iosPwa': isIosPwa,                         'align-self-stretch' : extended,                         'w-100': props.composer.message,                     }" t-ref="input-container">
                    <div t-if="!extended" t-attf-class="{{ actionsContainerClass }}">
                        <Dropdown t-if="partitionedActions.other.length &gt; 0" position="'top-start'" menuClass="store.discussDropdownMenuClass(this)">
                            <t t-call="mail.Composer.moreActions"/>
                            <t t-set-slot="content">
                                <ActionList actions="partitionedActions.other" dropdown="true"/>
                            </t>
                        </Dropdown>
                    </div>
                    <div class="position-relative flex-grow-1">
                        <t t-set="inputClasses" t-value="{                             'o-mail-Composer-inputStyle form-control border-0 o-rounded-bubble': true,                             'o-mobile': isMobileOS,                             'ps-2': partitionedActions.other.length === 0,                         }"/>
                        <Wysiwyg t-if="composerService.htmlEnabled" class="'w-100 text-break overflow-auto'" config="this.wysiwygConfig" onLoad.bind="onLoadWysiwyg"/>
                        <t t-else="">
                                <textarea class="o-mail-Composer-input o-mail-Composer-bg shadow-none overflow-auto o-scrollbar-thin o-discuss-text-body user-select-auto" t-att-class="inputClasses" t-ref="textarea" t-on-keydown="onKeydown" t-on-focusin="onFocusin" t-on-focusout="onFocusout" t-on-click="(ev) =&gt; markEventHandled(ev, 'composer.onClickTextarea')" t-on-paste="onPaste" t-model="props.composer.composerText" t-on-input="(ev) =&gt; this.onInput(ev)" t-att-placeholder="placeholder" t-att-readOnly="!state.active" tabindex="0"/>

                            <textarea class="o-mail-Composer-fake position-absolute overflow-hidden" t-att-class="inputClasses" t-att-value="props.composer.composerText" t-ref="fakeTextarea" disabled="1"/>
                        </t>
                    </div>
                    <t t-call="mail.Composer.quickActions"/>
                </div>
            </div>
            <div class="o-mail-Composer-footer overflow-auto o-scrollbar-thin">
                <AttachmentList t-if="props.composer.attachments.length &gt; 0" attachments="props.composer.attachments" unlinkAttachment.bind="(...args) =&gt; attachmentUploader.unlink(...args)"/>
                <div t-if="!extended and !props.composer.message" class="o-mail-Composer-pickerContainer" t-att-class="{ 'o-active': composerActions.activePicker and ui.isSmall }" t-ref="picker-container">
                    <div t-if="partitionedActions.pickers.length &gt; 1 and composerActions.activePicker and ui.isSmall" class="o-mail-Composer-pickerSelection btn-group w-100">
                        <button t-foreach="partitionedActions.pickers" t-as="pickerAction" t-key="'PICKER_' + pickerAction.id" class="btn btn-secondary" t-esc="pickerAction.pickerName" t-on-click="(ev) =&gt; pickerAction.onSelected(ev)" t-att-class="{                             'active': pickerAction.picker.isOpen                         }"/>
                    </div>
                    <div t-ref="picker-target"/>
                </div>
                <div t-else="" class="d-flex align-items-center gap-1 w-100 pe-2">
                    <div class="pt-1" t-att-class="{ 'mt-2': !props.composer.message }">
                        <span t-if="props.composer.message and !ui.isSmall" class="text-muted px-1 small" t-out="CANCEL_OR_SAVE_EDIT_TEXT" t-on-click="onClickCancelOrSaveEditText"/>
                        <t t-elif="!props.composer.message">
                            <t t-call="mail.Composer.sendButton"/>
                            <span t-if="!isSendButtonDisabled and !isMobileOS" class="text-muted small ms-1" t-out="OR_PRESS_SEND_KEYBIND"/>
                        </t>
                    </div>
                    <span class="flex-grow-1"/>
                    <t t-if="!props.composer.message" t-call="mail.Composer.extraActions"/>
                </div>
            </div>
        </div>
    </div>
    <NavigableList t-if="suggestion" class="'o-mail-Composer-suggestionList'" t-props="navigableListProps"/>
</t>

`);
registerTemplate("mail.Composer.sendButton", `/mail/static/src/core/common/composer.xml`, `<t t-name="mail.Composer.sendButton" xml:space="preserve">
    <button class="o-mail-Composer-send btn" t-att-class="{             'btn-primary btn-sm': extended,             'btn-link rounded-circle p-0': !extended,             'me-2': env.inDiscussApp,             'border-start-0': env.inDiscussApp and !props.composer.message,             'border-0': props.composer.message,         }" t-on-click="sendMessage" t-att-disabled="isSendButtonDisabled" t-att-aria-label="SEND_TEXT">
        <t t-if="thread and thread.model !== 'discuss.channel'" t-out="SEND_TEXT"/>
        <t t-else=""><i class="fa fa-fw fa-lg fa-paper-plane-o"/></t>
    </button>
</t>

`);
registerTemplate("mail.Composer.quickActions", `/mail/static/src/core/common/composer.xml`, `<t t-name="mail.Composer.quickActions" xml:space="preserve">
    <div class="o-mail-Composer-quickActions o-mail-Composer-bg" t-attf-class="{{ actionsContainerClass }}" t-ref="quick-actions">
        <div class="o-mail-Composer-mainActions d-flex flex-grow-1 align-items-baseline">
            <ActionList actions="partitionedActions.quick" inline="true"/>
        </div>
    </div>
</t>

`);
registerTemplate("mail.Composer.moreActions", `/mail/static/src/core/common/composer.xml`, `<t t-name="mail.Composer.moreActions" xml:space="preserve">
    <div class="o-mail-Composer-bg" t-attf-class="{{ actionsContainerClass }}" t-ref="more-actions">
        <div class="o-mail-Composer-mainActions d-flex flex-grow-1 align-items-baseline">
            <t t-set="moreName">More Actions</t>
            <ActionList inline="true" actions="[{                 'disabledCondition': areAllActionsDisabled,                 'icon': 'fa fa-plus-circle',                 'id': 'more-actions',                 'name': moreName,                 'tags': [],             }]"/> 
        </div>
    </div>
</t>

`);
registerTemplate("mail.Composer.extraActions", `/mail/static/src/core/common/composer.xml`, `<t t-name="mail.Composer.extraActions" xml:space="preserve">
    <div class="me-2 o-mail-Composer-extraActions" t-attf-class="{{ actionsContainerClass }}" t-ref="extra-actions">
        <div class="o-mail-Composer-mainActions d-flex flex-grow-1 align-items-baseline">
            <ActionList actions="partitionedActions.other" inline="true"/>
        </div>
    </div>
</t>

    `);
registerTemplate("mail.Composer.suggestionSpecial", `/mail/static/src/core/common/composer.xml`, `<t t-name="mail.Composer.suggestionSpecial" xml:space="preserve">
        <strong class="px-2 py-1 align-self-center flex-shrink-0 text-truncate">
            <t t-esc="option.displayName"/>
        </strong>
        <em class="text-600 text-truncate align-self-center">
            <t t-esc="option.description"/>
        </em>
    </t>

    `);
registerTemplate("mail.Composer.suggestionPartner", `/mail/static/src/core/common/composer.xml`, `<t t-name="mail.Composer.suggestionPartner" xml:space="preserve">
        <t t-set="partner" t-value="option.partner"/>
        <ImStatus t-if="partner" persona="partner"/>
        <strong class="px-2 py-1 align-self-center flex-shrink-0 text-truncate">
            <t t-esc="partner.name"/>
            <t t-if="option.thread and partner.name !== option.thread.getPersonaName(partner)">
                "<t t-esc="option.thread.getPersonaName(partner)"/>"
            </t>
        </strong>
        <span t-if="partner.email" class="text-600 text-truncate align-self-center">(<t t-esc="partner.email"/>)</span>
    </t>

    `);
registerTemplate("mail.Composer.suggestionRole", `/mail/static/src/core/common/composer.xml`, `<t t-name="mail.Composer.suggestionRole" xml:space="preserve">
        <strong class="px-2 py-1 align-self-center flex-shrink-0 text-truncate" t-esc="option.label"/>
        <em class="text-600 text-truncate align-self-center">
            <t t-if="option.thread?.channel_type === 'channel'">Notify users with this role who have permission to view this channel</t>
            <t t-else="">Notify users with this role</t>
        </em>
    </t>

    `);
registerTemplate("mail.Composer.suggestionThread", `/mail/static/src/core/common/composer.xml`, `<t t-name="mail.Composer.suggestionThread" xml:space="preserve">
        <strong class="px-2 py-1 align-self-center flex-shrink-0 text-truncate">
            <i t-attf-class="fa #{option.thread.parent_channel_id ? 'fa-comments-o' : 'fa-hashtag'} me-2"/>
            <t t-if="option.thread.parent_channel_id">
                <t t-esc="option.thread.parent_channel_id.displayName"/>
                <i class="oi oi-chevron-right o-xsmaller mx-1"/>
            </t>
            <t t-esc="option.thread.displayName"/>
        </strong>
    </t>

    `);
registerTemplate("mail.Composer.suggestionChannelCommand", `/mail/static/src/core/common/composer.xml`, `<t t-name="mail.Composer.suggestionChannelCommand" xml:space="preserve">
        <strong class="px-2 py-1 align-self-center flex-shrink-0 text-truncate">
            <t t-esc="option.label"/>
        </strong>
        <span class="text-600 text-truncate align-self-center">
            <t t-esc="option.help"/>
        </span>
    </t>

    `);
registerTemplate("mail.Composer.suggestionCannedResponse", `/mail/static/src/core/common/composer.xml`, `<t t-name="mail.Composer.suggestionCannedResponse" xml:space="preserve">
        <strong class="px-2 py-1 align-self-center flex-shrink-1 text-truncate">
            <t t-esc="option.source"/>
        </strong>
        <span class="text-600 text-truncate align-self-center" style="flex-basis: 20%;">
            <t t-esc="option.label"/>
        </span>
    </t>
    `);
registerTemplate("mail.Composer.suggestionEmoji", `/mail/static/src/core/common/composer.xml`, `<t t-name="mail.Composer.suggestionEmoji" xml:space="preserve">
        <strong class="px-2 align-self-center flex-shrink-1 fs-3">
            <t t-esc="option.emoji.codepoints"/>
        </strong>
        <em class="text-600 text-truncate align-self-center">
            <t t-esc="option.emoji.shortcodes.join(' ')"/>
        </em>
    </t>
`);
registerTemplate("mail.CountryFlag", `/mail/static/src/core/common/country_flag.xml`, `<t t-name="mail.CountryFlag" xml:space="preserve">
        <img class="o-mail-CountryFlag" t-att-class="props.class" t-att-title="props.country.name" t-att-src="props.country.flagUrl"/>
    </t>

`);
registerTemplate("mail.DateSection", `/mail/static/src/core/common/date_section.xml`, `<t t-name="mail.DateSection" xml:space="preserve">
    <div class="o-mail-DateSection d-flex align-items-center w-100 fw-bold z-1" t-attf-class="{{ props.className }}">
        <hr class="o-discuss-separator flex-grow-1"/>
        <span class="px-2 smaller text-muted opacity-50" t-att-class="{ 'user-select-none': isMobileOS }"><t t-esc="props.date"/></span>
        <hr class="o-discuss-separator flex-grow-1"/>
    </div>
</t>
`);
registerTemplate("mail.Gif", `/mail/static/src/core/common/gif.xml`, `<t t-name="mail.Gif" xml:space="preserve">
       <img t-att-src="props.paused and state.snapshot ? state.snapshot : props.src" t-att-loading="props.loading" t-att-data-paused="props.paused" t-att-alt="props.alt" t-att-class="props.class" t-att-style="props.style" t-on-click="() =&gt; props.onClick?.()" t-on-load="onLoad"/>
    </t>
`);
registerTemplate("mail.ImStatus", `/mail/static/src/core/common/im_status.xml`, `<t t-name="mail.ImStatus" xml:space="preserve">
        <div class="o-mail-ImStatus d-flex justify-content-center flex-shrink-0 align-items-center bg-white bg-opacity-100" t-attf-class="{{ props.className }}" t-att-style="props.style" t-att-class="{             'o-md': props.size === 'md' or props.size === 'medium',             'o-sm': props.size === 'sm' or props.size === 'small',             'rounded-circle': !props.member?.isTyping,             'rounded-pill': props.member?.isTyping,         }">
            <span class="d-flex flex-column" t-att-class="{                 'smaller': props.size === 'md' or props.size === 'medium',                 'o-xsmaller': props.size === 'sm' or props.size === 'small',             }">
                <t t-slot="pre_icon"/>
                <t name="icon">
                    <t t-if="(!props.member or !props.member.isTyping) and persona">
                        <i t-if="persona.im_status === 'online'" class="fa fa-circle text-success" title="Online" role="img" aria-label="User is online"/>
                        <i t-elif="persona.im_status === 'away'" class="fa fa-circle o-yellow" title="Idle" role="img" aria-label="User is idle"/>
                        <i t-elif="persona.im_status === 'busy'" class="fa fa-minus-circle text-danger" title="Busy" role="img" aria-label="User is busy"/>
                        <i t-elif="persona.im_status === 'offline'" class="fa fa-circle-o text-700 opacity-75" title="Offline" role="img" aria-label="User is offline"/>
                        <i t-elif="persona.im_status === 'bot'" class="fa fa-heart text-success" title="Bot" role="img" aria-label="User is a bot"/>
                        <i t-else="" class="fa fa-question-circle opacity-75" title="No IM status available"/>
                    </t>
                    <div t-if="props.member?.isTyping" class="rounded-pill" style="padding: 1px;" t-att-class="{ 'bg-300': env.inChatBubble, 'bg-inherit': !env.inChatBubble }">
                        <div class="bg-success rounded-pill" style="padding: 3px;">
                            <Typing member="props.member" channel="props.member.threadAsTyping" size="['sm', 'smaller'].includes(props.size) ? 'sm' : 'md'" displayText="false"/>
                        </div>
                    </div>
                </t>
            </span>
        </div>
    </t>

`);
registerTemplate("mail.ImStatusDropdown", `/mail/static/src/core/common/im_status_dropdown.xml`, `<t t-name="mail.ImStatusDropdown" xml:space="preserve">
        <Dropdown menuClass="'o-mail-ImStatusDropdown'">
            <a href="#" t-att-class="{ 'd-block text-body py-3 fs-4 d-flex flex-row gap-2': env.isSmall }"><ImStatus persona="store.self"/> <span t-esc="readableImStatus"/> <i t-if="env.isSmall" class="oi oi-chevron-right ms-auto mt-1"/></a>
            <t t-set-slot="content">
                <DropdownItem class="{ 'active': this.store.self.im_status.includes('online') }" onSelected="() =&gt; this.setManualImStatus('online')"><i class="fa fa-circle text-success me-1" title="Online" role="img"/> Online</DropdownItem>
                <hr class="my-1"/>
                <DropdownItem class="{ 'active': this.store.self.im_status.includes('away') }" onSelected="() =&gt; this.setManualImStatus('away')"><i class="fa fa-circle o-yellow me-1" title="Away" role="img"/> Away</DropdownItem>
                <DropdownItem class="{ 'active': this.store.self.im_status.includes('busy') }" onSelected="() =&gt; this.setManualImStatus('busy')">
                    <i class="fa fa-minus-circle text-danger me-1" title="Busy" role="img"/> Do Not Disturb
                    <div class="small text-muted">You will not receive any notifications</div>
                </DropdownItem>
                <DropdownItem class="{ 'active': this.store.self.im_status.includes('offline') }" onSelected="() =&gt; this.setManualImStatus('offline')"><i class="fa fa-circle-o text-700 opacity-75 me-1" title="Offline" role="img"/> Offline</DropdownItem>
            </t>
        </Dropdown>
    </t>
`);
registerTemplate("mail.LinkPreview", `/mail/static/src/core/common/link_preview.xml`, `<t t-name="mail.LinkPreview" xml:space="preserve">
        <t t-if="props.linkPreview.isCard">
            <t t-call="mail.LinkPreviewCard"/>
        </t>
        <t t-if="props.linkPreview.isVideo">
            <t t-call="mail.LinkPreviewVideo"/>
        </t>
        <t t-if="props.linkPreview.isImage">
            <t t-call="mail.LinkPreviewImage"/>
        </t>
    </t>

    `);
registerTemplate("mail.LinkPreviewCard", `/mail/static/src/core/common/link_preview.xml`, `<t t-name="mail.LinkPreviewCard" xml:space="preserve">
        <div class="o-mail-LinkPreviewCard card position-relative w-100 mb-2 rounded bg-view shadow-sm overflow-hidden" t-att-class="{ 'me-2': env.inChatter }" t-attf-class="{{ className }}">
            <div class="row g-0 flex-row-reverse h-100">
                <div class="col min-w-0" t-att-class="{ 'd-flex align-items-center': !props.linkPreview.og_description }">
                    <div class="px-3 py-2">
                        <h6 class="card-title mb-0 me-2" t-attf-class="{{ props.linkPreview.og_description ? 'text-truncate' : 'overflow-hidden' }}">
                            <a t-att-href="props.linkPreview.source_url" target="_blank" t-out="props.linkPreview.og_title"/>
                        </h6>
                        <span t-if="props.linkPreview.og_site_name" t-out="props.linkPreview.og_site_name"/>
                        <p t-if="props.linkPreview.og_description" class="o-mail-LinkPreviewCard-description card-text mb-0 mt-2 text-muted small overflow-hidden" t-out="props.linkPreview.og_description"/>
                    </div>
                </div>
                <div class="o-mail-LinkPreviewCard-imageLinkWrap col-4 d-block">
                    <a t-att-href="props.linkPreview.source_url" target="_blank">
                        <img t-if="props.linkPreview.og_image" class="w-100 h-100 object-fit-cover" t-att-src="props.linkPreview.og_image" t-att-alt="props.linkPreview.og_title" t-on-load="onImageLoaded"/>
                        <span t-else="" class="d-flex align-items-center justify-content-center w-100 h-100 bg-100 text-300">
                            <i class="fa fa-camera fa-2x"/>
                        </span>
                    </a>
                </div>
            </div>
            <t t-if="props.delete" t-call="mail.LinkPreview.aside">
                <t t-set="className" t-value="'fa fa-stack p-0 opacity-75 opacity-100-hover'"/>
            </t>
        </div>
    </t>

    `);
registerTemplate("mail.LinkPreviewImage", `/mail/static/src/core/common/link_preview.xml`, `<t t-name="mail.LinkPreviewImage" xml:space="preserve">
        <div class="o-mail-LinkPreviewImage position-relative mb-2 rounded" t-att-class="{ 'me-2': env.inChatter }" t-attf-class="{{ className }}">
            <a t-if="props.linkPreview.imageUrl" t-att-href="props.linkPreview.imageUrl" target="_blank">
                <Gif t-if="props.linkPreview.isGif" paused="props.gifPaused" class="'h-auto w-auto rounded'" src="props.linkPreview.imageUrl" onLoad.bind="onImageLoaded"/>
                <img t-else="" class="h-auto w-auto rounded" t-att-src="props.linkPreview.imageUrl" t-on-load="onImageLoaded"/>
            </a>
            <t t-if="props.delete" t-call="mail.LinkPreview.aside">
                <t t-set="className" t-value="'btn btn-sm btn-dark mt-2 me-2 rounded opacity-75 opacity-100-hover'"/>
            </t>
        </div>
    </t>

    `);
registerTemplate("mail.LinkPreviewVideo", `/mail/static/src/core/common/link_preview.xml`, `<t t-name="mail.LinkPreviewVideo" xml:space="preserve">
        <div class="o-mail-LinkPreviewVideo card position-relative w-100 mb-2 rounded bg-view shadow-sm overflow-hidden" t-att-data-provider="props.linkPreview.videoProvider" t-att-class="{ 'me-2': env.inChatter, 'o-mail-LinkPreviewVideo-embed': props.linkPreview.videoURL, 'o-mail-LinkPreviewVideo-started': state.startVideo }" t-attf-class="{{ className }}">
            <div class="row g-0 flex-row-reverse">
                <div class="col min-w-0" t-att-class="{ 'd-flex align-items-center': !props.linkPreview.og_description }">
                    <div class="d-flex flex-column gap-1 px-3 py-2 bg-view">
                        <p t-if="props.linkPreview.og_site_name" class="mb-0 card-text text-muted smaller overflow-hidden" t-out="props.linkPreview.og_site_name"/>
                        <h6 class="o-mail-LinkPreviewVideo-title card-title mb-0 me-2" t-attf-class="{{ props.linkPreview.og_description ? 'text-truncate' : 'o-mail-LinkPreviewVideo-hasDescription overflow-hidden' }}">
                            <a t-att-href="props.linkPreview.source_url" target="_blank" t-esc="props.linkPreview.og_title"/>
                        </h6>
                        <p t-if="props.linkPreview.og_description" class="o-mail-LinkPreviewVideo-description o-mail-LinkPreviewVideo-hasDescription card-text mb-0 text-muted small overflow-hidden" t-out="props.linkPreview.og_description"/>
                    </div>
                </div>
                <div t-if="!props.linkPreview.videoURL" class="col-4 d-block">
                    <a t-att-href="props.linkPreview.source_url" target="_blank"><t t-call="mail.LinkPreviewVideo.preview"/></a>
                </div>
            </div>
            <div t-if="props.linkPreview.videoURL" class="o-mail-LinkPreviewVideo-container">
                <div t-if="!state.videoLoaded" class="o-mail-LinkPreviewVideo-videoWrap h-100 w-100" t-on-click="() =&gt; state.startVideo = true"><t t-call="mail.LinkPreviewVideo.preview"/></div>
                <iframe t-if="state.startVideo" t-att-src="props.linkPreview.videoURL" class="h-100 w-100" t-att-class="{'d-none': !state.videoLoaded}" allow="autoplay" frameborder="0" allowFullScreen="true" t-ref="video"/>
            </div>
            <t t-if="props.delete" t-call="mail.LinkPreview.aside">
                <t t-set="className" t-value="'fa fa-stack p-0 opacity-75 opacity-100-hover'"/>
            </t>
        </div>
    </t>

    `);
registerTemplate("mail.LinkPreview.aside", `/mail/static/src/core/common/link_preview.xml`, `<t t-name="mail.LinkPreview.aside" xml:space="preserve">
        <div t-if="props.message?.allowsEdition" class="position-absolute top-0 end-0 small">
            <button t-attf-class="{{ className }}" class="o-mail-LinkPreview-aside btn" aria-label="Remove" t-on-click="onClick">
                <i class="fa fa-times"/>
            </button>
        </div>
    </t>

    `);
registerTemplate("mail.LinkPreviewVideo.preview", `/mail/static/src/core/common/link_preview.xml`, `<t t-name="mail.LinkPreviewVideo.preview" xml:space="preserve">
        <div class="o-mail-LinkPreviewVideo-overlay position-relative h-100 rounded-bottom" t-att-class="{'bg-dark': !props.linkPreview.og_image}">
            <img t-if="props.linkPreview.og_image" class="img-fluid h-100 object-fit-cover" t-att-src="props.linkPreview.og_image" t-att-alt="props.linkPreview.og_title" t-on-load="onImageLoaded"/>
            <i t-elif="props.linkPreview.videoURL" class="fa fa-television fa-8x position-absolute top-50 start-50 translate-middle"/>
            <span t-else="" class="d-flex align-items-center justify-content-center w-100 h-100 bg-100 text-300">
                <i class="fa fa-camera fa-2x"/>
            </span>
            <div class="position-absolute top-50 start-50 translate-middle">
                <div t-if="!state.startVideo" class="o-mail-LinkPreviewVideo-play btn btn-lg rounded transition-base">
                    <i class="fa fa-play"/>
                </div>
                <div t-elif="!props.linkPreview.og_image" class="spinner-border text-muted"/>
            </div>
        </div>
    </t>
`);
registerTemplate("mail.LinkPreviewConfirmDelete", `/mail/static/src/core/common/link_preview_confirm_delete.xml`, `<t t-name="mail.LinkPreviewConfirmDelete" xml:space="preserve">
        <Dialog size="'md'" title.translate="Confirmation" modalRef="modalRef">
            <p class="mx-3 mb-3">Do you really want to delete this preview?</p>
            <t t-component="props.LinkPreview" linkPreview="props.linkPreview"/>
            <t t-set-slot="footer">
                <button class="btn btn-danger me-2" t-on-click="onClickOk">Delete</button>
                <button t-if="props.deleteAll" class="btn btn-outline-danger me-2" t-on-click="onClickDeleteAll">Delete all previews</button>
                <button class="btn btn-secondary me-2" t-on-click="onClickCancel">Cancel</button>
            </t>
        </Dialog>
    </t>
`);
registerTemplate("mail.MailAttachmentDropzone", `/mail/static/src/core/common/mail_attachment_dropzone.xml`, `<t t-name="mail.MailAttachmentDropzone" xml:space="preserve">
        <Dropzone t-props="this.props">
            <h4>Drop Files here <i class="fa fa-paperclip"/></h4>
        </Dropzone>
    </t>
`);
registerTemplate("mail.Fullscreen", `/mail/static/src/core/common/mail_fullscreen.xml`, `<t t-name="mail.Fullscreen" xml:space="preserve">
        <div class="fixed-top vw-100 vh-100">
            <t t-component="props.component" t-props="props.props"/>
        </div>
    </t>
`);
registerTemplate("mail.Message", `/mail/static/src/core/common/message.xml`, `<t t-name="mail.Message" xml:space="preserve">
        <ActionSwiper onRightSwipe="hasTouch() and props.thread?.eq(store.inbox) ? { action: () =&gt; this.message.setDone(), bgColor: 'bg-success', icon: 'fa-check-circle' } : undefined">
            <t t-set="dummy" t-value="computeActions()"/>
            <div class="o-mail-Message position-relative rounded-0 bg-inherit" t-att-data-starred="message.starred" t-att-data-persistent="message.persistent" t-att-class="attClass" role="group" t-att-aria-label="messageTypeText" t-on-click="onClick" t-on-mouseenter="onMouseenter" t-on-mouseleave="onMouseleave" t-ref="root" t-if="message.exists()">
                <div class="o-mail-Message-jumpTarget position-absolute top-0 pe-none"/>
                <div t-if="props.asCard and isMobileOS" class="position-absolute end-0 z-1 m-n2"><t t-call="mail.Message.actions"/></div>
                <div class="o-mail-Message-core position-relative d-flex flex-shrink-0 bg-inherit">
                    <div class="o-mail-Message-sidebar d-flex flex-shrink-0 align-items-center flex-column bg-inherit" t-att-class="{ 'align-items-start': !isAlignedRight, 'o-inChatWindow': env.inChatWindow }">
                        <t t-if="!props.squashed">
                            <div class="o-mail-Message-avatarContainer position-relative bg-inherit rounded-3" t-att-class="getAvatarContainerAttClass()">
                                <img class="o-mail-Message-avatar w-100 h-100 rounded-3" t-att-src="authorAvatarUrl" t-att-class="authorAvatarAttClass"/>
                            </div>
                            <t t-if="message.starred" t-call="mail.Message.sidebarStarred"/>
                        </t>
                        <t t-elif="message.isPending" t-call="mail.Message.pendingStatus"/>
                        <t t-elif="!message.is_transient">
                            <small t-if="isActive and props.showDates" class="o-mail-Message-date o-xsmaller mt-2 text-center lh-1" t-att-title="message.datetimeShort">
                                <t t-esc="message.dateSimple"/>
                            </small>
                            <t t-elif="message.starred" t-call="mail.Message.sidebarStarred"/>
                        </t>
                    </div>
                    <div class="w-100 o-min-width-0" t-att-class="{ 'flex-grow-1': isEditing }" t-ref="messageContent">
                        <div t-if="!props.squashed" class="o-mail-Message-header d-flex flex-wrap align-items-baseline lh-1" t-att-class="{ 'mb-1': !message.isNote, 'pe-2': props.asCard and isMobileOS }" name="header">
                            <span t-if="message.authorName and shouldDisplayAuthorName" class="o-mail-Message-author smaller" t-att-class="getAuthorAttClass()">
                                <strong class="me-1 o-fw-600" t-esc="message.authorName"/>
                            </span>
                            <t t-if="!isAlignedRight" t-call="mail.Message.notification"/>
                            <t t-if="isAlignedRight and !message.bubbleColor and !(props.asCard and isMobileOS)" t-call="mail.Message.actions"/>
                            <small t-if="!message.is_transient" class="o-mail-Message-date o-xsmaller" t-att-title="message.datetimeShort">
                                <t t-if="message.isPending" t-call="mail.Message.pendingStatus"/>
                                <t t-else="" t-out="message.dateSimpleWithDay"/>
                            </small>
                            <small t-if="isPersistentMessageFromAnotherThread" t-on-click.prevent="openRecord" class="ms-1 text-500">
                                <t t-if="message.thread.model !== 'discuss.channel'">
                                    on <a t-if="message.thread.displayName" t-att-href="message.resUrl" t-esc="message.thread.displayName"/><em class="pe-1 text-decoration-line-through" t-else="">Deleted document</em>
                                </t>
                                <t t-else="">
                                    (from <a t-att-href="message.resUrl"><t t-esc="message.thread.prefix"/><t t-esc="message.thread.displayName or message.default_subject"/></a>)
                                </t>
                            </small>
                            <div t-if="props.message.scheduledDatetime" t-att-class="{ 'ms-2': (props.isInChatWindow and isAlignedRight) or (isPersistentMessageFromAnotherThread) }" t-att-title="props.message.scheduledDateSimple">
                                <span class="text-600 cursor-pointer">
                                    <i class="fa fa-calendar-o"/>
                                </span>
                            </div>
                            <t t-if="isAlignedRight" t-call="mail.Message.notification"/>
                            <t t-if="!isAlignedRight and !message.bubbleColor and !(props.asCard and isMobileOS)" t-call="mail.Message.actions"/>
                        </div>
                        <div class="o-mail-Message-contentContainer position-relative d-flex" t-att-class="{ 'flex-row-reverse': isAlignedRight }">
                            <div class="o-mail-Message-content o-min-width-0" t-att-class="{ 'w-100': isEditing, 'opacity-50': message.isPending, 'pt-1': message.isNote }">
                                <div class="o-mail-Message-textContent position-relative d-flex" t-att-class="{ 'w-100': isEditing }">
                                    <t t-set="showTextVisually" t-value="!message.linkPreviewSquash and (message.hasTextContent or message.subtype_id?.description or message.isEmpty)"/>
                                    <t t-if="message.message_type === 'notification' and message.richBody" t-call="mail.Message.bodyAsNotification" name="bodyAsNotification"/>
                                    <t t-if="message.isEmpty or (message.message_type !== 'notification' and !message.is_transient and (message.hasTextContent or message.subtype_id?.description or isEditing or message.parent_id))">
                                        <MessageLinkPreviewList t-if="!isEditing and message.linkPreviewSquash and !message.parent_id" messageLinkPreviews="message.message_link_preview_ids"/>
                                        <t t-else="">
                                            <div t-if="message.bubbleColor and !props.squashed" class="o-mail-Message-bubbleTail position-absolute d-flex" t-att-style="isAlignedRight ? 'right: -4px; transform: rotateY(180deg);' : 'left: -4px;'" t-att-class="{                                                 'o-blue': message.bubbleColor === 'blue',                                                 'o-green': message.bubbleColor === 'green',                                                 'o-orange': message.bubbleColor === 'orange',                                             }">
                                                <svg viewBox="0 0 6 12" height="12" width="6" x="0px" y="0px">
                                                    <path class="o-mail-Message-bubbleTailBorder" fill="currentColor" d="M 0, 0 L 5, 9 V 0 z"/>
                                                    <path class="o-mail-Message-bubbleTailBg" fill="currentColor" d="M 2, 1 L 5, 7 V 1 z"/>
                                                </svg>
                                            </div>
                                            <div class="position-relative overflow-x-auto overflow-y-hidden d-inline-block o-discuss-text-body" t-att-class="{                                                 'w-100': isEditing,                                                 'o-rounded-bubble': message.bubbleColor and props.squashed,                                                 'o-rounded-bottom-bubble': message.bubbleColor and !props.squashed,                                                 'o-rounded-start-bubble': message.bubbleColor and !props.squashed and isAlignedRight,                                                 'o-rounded-end-bubble': message.bubbleColor and !props.squashed and !isAlignedRight,                                             }">
                                                <div t-if="message.bubbleColor" class="o-mail-Message-bubble position-absolute top-0 start-0 w-100 h-100 border" t-att-class="{                                                     'o-rounded-bubble': props.squashed,                                                     'o-rounded-bottom-bubble': !props.squashed,                                                     'o-rounded-start-bubble': !props.squashed and isAlignedRight,                                                     'o-rounded-end-bubble': !props.squashed and !isAlignedRight,                                                     'o-blue': message.bubbleColor === 'blue',                                                     'o-green': message.bubbleColor === 'green',                                                     'o-orange': message.bubbleColor === 'orange',                                                 }"/>
                                                <MessageInReply t-if="message.parent_id" class="'mx-2 p-1 pb-0 ' + (showTextVisually ? 'mt-1' : 'my-1')" message="message" onClick="props.onParentMessageClick"/>
                                                <div class="position-relative text-break o-mail-Message-body" t-att-class="{                                                             'p-1': message.isNote,                                                             'fs-1': !isEditing and !env.inChatter and message.onlyEmojis,                                                             'mb-0': !message.isNote,                                                             'py-2': !message.isNote and !isEditing and showTextVisually,                                                             'pt-2 pb-1': !message.isNote and isEditing,                                                             'o-note': message.isNote,                                                             'o-rounded-bubble': props.squashed,                                                             'align-self-start o-rounded-end-bubble o-rounded-bottom-bubble': !isEditing and !message.isNote and !props.squashed,                                                             'flex-grow-1': isEditing,                                                             }" t-ref="body">
                                                    <i t-if="message.isEmpty" class="text-muted opacity-75" t-out="message.inlineBody"/>
                                                    <Composer t-elif="isEditing" autofocus="true" composer="message.composer" onDiscardCallback.bind="exitEditMode" onPostCallback.bind="exitEditMode" mode="'compact'" sidebar="false"/>
                                                    <t t-else="">
                                                        <em t-if="message.subject and !message.isSubjectSimilarToThreadName and !message.isSubjectDefault" class="d-block text-muted smaller">Subject: <t t-out="props.messageSearch?.highlight(message.subject) ?? message.subject"/></em>
                                                        <div class="overflow-x-auto" t-if="message.message_type and message.message_type.includes('email')" t-ref="shadowBody"/>
                                                        <t t-elif="message.showTranslation" t-out="message.richTranslationValue"/>
                                                        <div class="o-mail-Message-richBody overflow-x-auto" t-elif="message.hasTextContent and message.richBody and !message.linkPreviewSquash" t-out="props.messageSearch?.highlight(message.richBody) ?? message.richBody"/>
                                                        <p class="fst-italic text-muted small" t-if="message.showTranslation">
                                                            <t t-if="message.translationSource" t-esc="translatedFromText"/>
                                                        </p>
                                                        <p class="fst-italic text-muted small" t-if="message.translationErrors">
                                                            <i class="text-danger fa fa-warning" role="img" aria-label="Translation Failure"/>
                                                            <t t-if="message.translationErrors" t-esc="translationFailureText"/>
                                                        </p>
                                                        <t t-if="showSubtypeDescription" t-out="props.messageSearch?.highlight(message.subtype_id?.description) ?? message.subtype_id?.description"/>
                                                    </t>
                                                </div>
                                            </div>
                                        </t>
                                    </t>
                                    <t t-if="message.bubbleColor and message.hasTextContent and !env.inChatWindow and !(props.asCard and isMobileOS)" t-call="mail.Message.actions"/>
                                </div>
                                <div class="position-relative">
                                    <AttachmentList t-if="message.attachment_ids.length &gt; 0" attachments="message.attachment_ids.map((a) =&gt; a)" unlinkAttachment.bind="onClickAttachmentUnlink" messageSearch="props.messageSearch"/>
                                </div>
                                <MessageLinkPreviewList t-if="(message.message_link_preview_ids.length &gt; 0 and store.hasLinkPreviewFeature and !message.linkPreviewSquash) or (!isEditing and message.linkPreviewSquash and message.parent_id)" messageLinkPreviews="message.message_link_preview_ids"/>
                            </div>
                            <t t-if="message.bubbleColor and (!message.hasTextContent or env.inChatWindow) and !(props.asCard and isMobileOS)" t-call="mail.Message.actions"/>
                        </div>
                        <MessageReactions message="message" openReactionMenu="openReactionMenu" t-if="message.reactions.length"/>
                        <t name="after-reactions"/>
                    </div>
                </div>
            </div>
        </ActionSwiper>
    </t>

`);
registerTemplate("mail.Message.edited", `/mail/static/src/core/common/message.xml`, `<t t-name="mail.Message.edited" xml:space="preserve">
    <span class="o-xsmaller opacity-50"> (edited)</span>
</t>

`);
registerTemplate("mail.Message.actions", `/mail/static/src/core/common/message.xml`, `<t t-name="mail.Message.actions" xml:space="preserve">
    <div t-if="props.hasActions and message.hasActions and !isEditing and !env.inChatter?.disabled" class="o-mail-Message-actions d-print-none d-flex align-items-start" t-att-class="{             'start-0': isAlignedRight,             'mt-1': message.bubbleColor and !props.asCard and !isMobileOS,             'my-n2': !message.bubbleColor and !props.asCard and !isMobileOS,             'gap-1': isMobileOS,             'mx-1': !isMobileOS,             'invisible': !isActive and !isMobileOS,             'o-expanded': optionsDropdown.isOpen         }">
        <t t-if="isMobileOS">
            <Dropdown state="optionsDropdown" menuClass="store.discussDropdownMenuClass(this)">
                <button class="d-none"/>
                <t t-set-slot="content">
                    <ActionList actions="messageActions.actions" dropdown="true"/>
                </t>
            </Dropdown>
        </t>
        <t t-set="isReverse" t-value="env.inChatWindow and isAlignedRight"/>
        <t t-if="isMobileOS and isReverse" t-call="mail.Message.emptyQuickAction"/>
        <div class="d-flex rounded-1 overflow-hidden gap-1" t-att-class="{ 'flex-row-reverse': isReverse }">
            <ActionList actions="actions" inline="true" fw="false"/>
            <t t-foreach="Array.from({ length: quickActionCount - quickActions.length - 1 })" t-as="emptyQuickAction" t-key="emptyQuickAction_index">
                <t t-call="mail.Message.emptyQuickAction"/>
            </t>
        </div>
        <t t-if="isMobileOS and !isReverse" t-call="mail.Message.emptyQuickAction"/>
    </div>
</t>

`);
registerTemplate("mail.Message.emptyQuickAction", `/mail/static/src/core/common/message.xml`, `<t t-name="mail.Message.emptyQuickAction" xml:space="preserve">
    <button class="btn border-0 o-p-0_5 rounded-0 opacity-0 pe-none">
        <i class="fa-lg fa fa-question"/>
    </button>
</t>

`);
registerTemplate("mail.Message.notification", `/mail/static/src/core/common/message.xml`, `<t t-name="mail.Message.notification" xml:space="preserve">
    <div t-if="message.thread?.eq(props.thread) and message.notification_ids.length &gt; 0" class="mx-1">
        <span class="o-mail-Message-notification cursor-pointer opacity-100-hover" t-att-class="message.failureNotifications.length &gt; 0 ? 'text-danger opacity-75' : 'opacity-50'" role="button" tabindex="0" t-on-click="onClickNotification">
            <i t-att-class="message.notification_ids[0].icon" role="img" aria-label="Delivery failure"/> <span class="fw-bold small" t-if="message.notification_ids[0].label" t-out="message.notification_ids[0].label"/>
        </span>
    </div>
    <div t-elif="message.thread?.eq(props.thread) and (message.incoming_email_to?.length or message.incoming_email_cc?.length)" class="mx-1">
        <span class="o-mail-Message-notification cursor-pointer" t-att-class="message.failureNotifications.length &gt; 0 ? 'text-danger' : text-600" role="button" tabindex="0" t-on-click="onClickNotification">
            <i class="fa fa-envelope-o" role="img"/>
        </span>
    </div>
</t>

`);
registerTemplate("mail.Message.bodyAsNotification", `/mail/static/src/core/common/message.xml`, `<t t-name="mail.Message.bodyAsNotification" xml:space="preserve">
    <div class="o-mail-Message-body text-break mb-0 w-100" t-att-class="{'o-note': message.message_type == 'notification'}">
        <t t-out="props.messageSearch?.highlight(message.richBody) ?? message.richBody"/>
    </div>
</t>

`);
registerTemplate("mail.Message.pendingStatus", `/mail/static/src/core/common/message.xml`, `<t t-name="mail.Message.pendingStatus" xml:space="preserve">
    <button t-if="message.postFailRedo" class="btn p-0" title="Failed to post the message. Click to retry" t-on-click="() =&gt; message.postFailRedo?.()"><i class="fa fa-fw fa-warning text-warning"/></button>
    <span t-else="" class="o-mail-Message-pendingProgress"><i class="fa fa-fw fa-circle-o-notch fa-spin opacity-50"/></span>
</t>

`);
registerTemplate("mail.Message.mentionedChannelIcon", `/mail/static/src/core/common/message.xml`, `<t t-name="mail.Message.mentionedChannelIcon" xml:space="preserve">
    <i t-att-class="icon"/>
</t>

`);
registerTemplate("mail.Message.sidebarStarred", `/mail/static/src/core/common/message.xml`, `<t t-name="mail.Message.sidebarStarred" xml:space="preserve">
    <small class="text-center lh-1 o-opacity-35" t-att-class="{ 'align-self-start ms-1': isAlignedRight, 'align-self-end me-1': !isAlignedRight, 'mt-2': props.squashed, 'mt-1': !props.squashed }" title="Starred message">
        <i class="fa fa-star o-mail-Message-starred"/>
    </small>
</t>

    `);
registerTemplate("mail.Message.messageLink", `/mail/static/src/core/common/message.xml`, `<t t-name="mail.Message.messageLink" xml:space="preserve">
        <span>
            <span class="me-1" t-out="message.thread.displayName"/>
            <span class="fa fa-angle-right me-1" aria-hidden="true"/>
            <span class="fa fa-comment" aria-hidden="true"/>
        </span>
    </t>

`);
registerTemplate("mail.MessageCardList", `/mail/static/src/core/common/message_card_list.xml`, `<t t-name="mail.MessageCardList" xml:space="preserve">
        <div class="o-mail-MessageCardList d-flex flex-column" t-att-class="{ 'justify-content-center flex-grow-1': props.messages.length === 0 }" t-ref="message-list">
            <div class="card mb-2 rounded-3 border-dark shadow-sm" t-foreach="props.messages" t-as="message" t-key="message.id">
                <div class="card-body ps-0 py-2 rounded-3">
                    <div class="position-absolute top-0 end-0 z-1 mx-2 my-1 d-flex align-items-center">
                        <a role="button" class="o-mail-MessageCard-jump rounded bg-400 badge opacity-0" t-att-class="{ 'opacity-100 py-1 px-2': ui.isSmall }" t-on-click="() =&gt; this.onClickJump(message)">Jump</a>
                        <button t-if="props.mode === 'pin' and store.self_partner" class="btn btn-link text-reset ms-2 p-0 opacity-25 opacity-100-hover" t-att-class="{ 'fs-5': ui.isSmall }" title="Unpin" t-on-click="message.unpin">
                            <i class="oi oi-close"/>
                        </button>
                    </div>
                    <Message hasActions="false" message="message" thread="props.thread" messageSearch="props.messageSearch"/>
                </div>
            </div>
            <span t-if="props.loadMore" class="mb-1" t-ref="load-more"/>
            <p t-if="props.showEmpty !== undefined ? props.showEmpty : props.messages.length === 0" t-esc="emptyText" class="text-center fst-italic text-500 fs-6"/>
        </div>
    </t>

`);
registerTemplate("mail.MessageConfirmDialog", `/mail/static/src/core/common/message_confirm_dialog.xml`, `<t t-name="mail.MessageConfirmDialog" xml:space="preserve">
    <Dialog size="props.size" title="props.title" contentClass="'o-bg-body'">
        <p class="mx-3 mb-3" t-esc="props.prompt"/>
        <blockquote class="mx-3 mb-3 fst-normal" style="pointer-events:none;">
            <t t-component="messageComponent" message="props.message" isReadOnly="true" hasActions="false"/>
        </blockquote>
        <t t-set-slot="footer">
            <button class="btn me-2" t-att-class="props.confirmColor" t-on-click="onClickConfirm" t-out="props.confirmText"/>
            <button class="btn btn-secondary me-2" t-on-click="props.close">Cancel</button>
        </t>
    </Dialog>
</t>

`);
registerTemplate("mail.MessageInReply", `/mail/static/src/core/common/message_in_reply.xml`, `<t t-name="mail.MessageInReply" xml:space="preserve">
        <div class="o-mail-MessageInReply" t-attf-class="{{ props.class }}">
            <small class="o-mail-MessageInReply-core o-mail-Message-bubble o-muted border position-relative d-flex px-2 py-1 rounded-start-0 o-rounded-end-bubble d-inline-flex" t-att-class="{                 'o-blue': props.message.parent_id.bubbleColor === 'blue',                 'o-green': props.message.parent_id.bubbleColor === 'green',                 'o-orange': props.message.parent_id.bubbleColor === 'orange',             }">
                <span class="d-inline-flex align-items-center" t-att-class="{ 'cursor-pointer': props.onClick }" t-on-click="() =&gt; this.props.onClick?.()">
                    <t t-if="!props.message.parent_id.isEmpty">
                        <img class="o-mail-MessageInReply-avatar me-2 rounded object-fit-cover" t-att-src="authorAvatarUrl" t-att-title="props.message.parent_id.authorName" alt="Avatar"/>
                        <span class="o-mail-MessageInReply-content overflow-hidden smaller">
                            <b class="o-mail-MessageInReply-author o-fw-600"><t t-out="props.message.parent_id.authorName"/></b>:
                            <span class="o-mail-MessageInReply-message ms-1 text-break">
                                <t t-if="!props.message.parent_id.isBodyEmpty">
                                    <t t-out="props.message.parent_id.inlineBody"/>
                                    <em t-if="props.message.parent_id.edited" class="smaller fw-bold text-500"> (edited)</em>
                                </t>
                                <t t-elif="props.message.parent_id.attachment_ids.length &gt; 0">
                                    <span class="me-2 fst-italic">Click to see the attachments</span>
                                    <i class="fa fa-image"/>
                                </t>
                            </span>
                        </span>
                    </t>
                    <i t-else="">Original message was deleted</i>
                </span>
            </small>
        </div>
    </t>
`);
registerTemplate("mail.MessageLinkPreviewList", `/mail/static/src/core/common/message_link_preview_list.xml`, `<t t-name="mail.MessageLinkPreviewList" xml:space="preserve">
        <div class="o-mail-LinkPreviewList d-flex flex-column mt-2" t-att-class="{ 'me-2 pe-4': env.inChatWindow and !env.alignedRight, 'ms-2 ps-4': env.inChatWindow and env.alignedRight }">
            <div class="d-flex flex-grow-1 flex-wrap">
                <t t-if="props.messageLinkPreviews.length &gt; 1">
                    <t t-foreach="props.messageLinkPreviews" t-as="messageLinkPreview" t-key="messageLinkPreview.id">
                        <LinkPreview linkPreview="messageLinkPreview.link_preview_id" delete.bind="messageLinkPreview.hide" deleteAll.bind="messageLinkPreview.message_id.hideAllLinkPreviews" gifPaused="messageLinkPreview.gifPaused" message="messageLinkPreview.message_id"/>
                    </t>
                </t>
                <t t-else="">
                   <LinkPreview linkPreview="props.messageLinkPreviews[0].link_preview_id" delete.bind="props.messageLinkPreviews[0].hide" gifPaused="props.messageLinkPreviews[0].gifPaused" message="props.messageLinkPreviews[0].message_id"/>
                </t>
            </div>
        </div>
    </t>
`);
registerTemplate("mail.MessageNotificationPopover", `/mail/static/src/core/common/message_notification_popover.xml`, `<t t-name="mail.MessageNotificationPopover" xml:space="preserve">
        <div class="o-mail-MessageNotificationPopover m-2">
            <t t-set="otherNotifications" t-value="this.props.message.notification_ids.filter((notif) =&gt; !notif._proxy.isFollowerNotification)"/>
            <t t-set="followerNotifications" t-value="this.props.message.notification_ids.filter((notif) =&gt; notif._proxy.isFollowerNotification)"/>
            <div t-foreach="otherNotifications" t-as="notification" t-key="notification.id">
                <i class="me-2 fa-fw" t-att-class="notification.statusIcon" t-att-title="notification.statusTitle" role="img"/>
                <span t-if="notification.res_partner_id">
                    <t t-esc="props.message.getPersonaName(notification.res_partner_id)"/>
                    <t t-if="notification.res_partner_id.email and !notification.isFailure"> (<t t-out="notification.res_partner_id.email"/>)</t>
                </span>
                <span t-elif="notification.mail_email_address" t-out="notification.mail_email_address"/>
                <span class="ms-1 text-muted" t-if="notification.isFailure">(<t t-esc="notification.failureMessage"/>)</span>
            </div>
            <div t-if="props.message.incoming_email_cc or props.message.incoming_email_to" t-foreach="(props.message.incoming_email_cc || []).concat(props.message.incoming_email_to || [])" t-as="incomingEmail" t-key="incomingEmail_index">
                <i class="me-2 fa fa-fw fa-send-o"/>
                <span t-if="incomingEmail[0]" t-out="incomingEmail[0]" class="pe-1"/>
                <span t-if="incomingEmail[1]" t-out="incomingEmail[1]" class="ps-1"/>
            </div>
            <div t-foreach="followerNotifications" t-as="notification" t-key="notification.id">
                <i class="me-2 fa-fw" t-att-class="notification.statusIcon" t-att-title="notification.statusTitle" role="img"/>
                <span t-if="notification.res_partner_id">
                    <t t-esc="props.message.getPersonaName(notification.res_partner_id)"/>
                    <t t-if="notification.res_partner_id.email and !notification.isFailure"> (<t t-out="notification.res_partner_id.email"/>)</t>
                </span>
                <span t-elif="notification.mail_email_address" t-out="notification.mail_email_address"/>
                <span class="ms-1 text-muted" t-if="notification.isFailure">(<t t-esc="notification.failureMessage"/>)</span>
            </div>
        </div>
    </t>

`);
registerTemplate("mail.MessageReactionList", `/mail/static/src/core/common/message_reaction_list.xml`, `<t t-name="mail.MessageReactionList" xml:space="preserve">
        <Dropdown state="preview" position="'top-middle'" menuClass="'mt-1 overflow-visible ' + store.discussDropdownMenuClass(this)" manual="true" bottomSheet="false">
            <t t-call="mail.MessageReactionList.button"/>
            <t t-set-slot="content">
                <t t-call="mail.MessageReactionList.preview"/>
            </t>
        </Dropdown>
    </t>

    `);
registerTemplate("mail.MessageReactionList.button", `/mail/static/src/core/common/message_reaction_list.xml`, `<t t-name="mail.MessageReactionList.button" xml:space="preserve">
        <button class="position-relative o-mail-MessageReaction btn d-flex p-0 bg-view border o-rounded-bubble mb-1 fs-5 px-1 gap-1 align-items-center" t-on-click="() =&gt; this.onClickReaction(props.reaction)" t-on-contextmenu="onContextMenu" t-on-mouseenter="loadEmoji" t-ref="reactionButton" t-att-class="{             'o-selfReacted border-primary text-primary fw-bold': hasSelfReacted(props.reaction),             'border-secondary': !hasSelfReacted(props.reaction),             'ms-1': env.inChatWindow and env.alignedRight,             'me-1': !(env.inChatWindow and env.alignedRight),             'cursor-default': !props.message.canAddReaction(),         }">
            <span t-esc="props.reaction.content"/>
            <span class="small" t-esc="props.reaction.count"/>
        </button>
    </t>

    `);
registerTemplate("mail.MessageReactionList.preview", `/mail/static/src/core/common/message_reaction_list.xml`, `<t t-name="mail.MessageReactionList.preview" xml:space="preserve">
        <div class="o-mail-MessageReactionList-preview px-0 py-1 cursor-pointer d-flex" t-on-click="(ev) =&gt; this.onClickReactionList(props.reaction)" t-ref="reactionList">
            <div class="d-flex align-items-center mx-2 gap-2">
                <span class="fs-1" t-esc="props.reaction.content"/>
                <span class="o-mail-MessageReactionList-previewText small me-1" t-esc="previewText(props.reaction)"/>
            </div>
        </div>
    </t>

`);
registerTemplate("mail.MessageReactionMenu", `/mail/static/src/core/common/message_reaction_menu.xml`, `<t t-name="mail.MessageReactionMenu" xml:space="preserve">
        <Dialog size="'md'" header="false" footer="false" contentClass="contentClass">
            <div class="d-flex h-100" t-on-keydown="onKeydown" t-att-class="{'flex-column': store.useMobileView}" t-ref="root">
                <div class="d-flex overflow-auto o-scrollbar-thin bg-100 p-1 border-end" t-att-class="{'flex-column h-100 p-2': !store.useMobileView}">
                    <t t-foreach="props.message.reactions" t-as="reaction" t-key="reaction.content">
                        <button class="btn p-1 rounded-2 mx-2 py-0 d-flex align-items-center" t-att-class="{ 'bg-200 border-primary': reaction.eq(state.reaction) }" t-att-title="getEmojiShortcode(reaction)" t-on-click="() =&gt; state.reaction = reaction">
                            <span class="mx-1 fs-2" t-esc="reaction.content"/>
                            <span class="mx-1 pe-2" t-att-class="{ 'text-primary': reaction.eq(state.reaction) }" t-esc="reaction.count"/>
                        </button>
                    </t>
                </div>
                <div class="d-flex overflow-auto o-scrollbar-thin flex-column flex-grow-1 bg-view p-2 h-100">
                    <div t-foreach="state.reaction.personas" t-as="persona" t-key="persona.id" class="o-mail-MessageReactionMenu-persona d-flex p-1 align-items-center" t-att-class="{ 'o-isDeviceSmall': ui.isSmall }">
                        <img class="rounded object-fit-cover o-mail-MessageReactionMenu-avatar" t-att-src="persona.avatarUrl"/>
                        <span class="d-flex flex-grow-1 align-items-center">
                            <span class="mx-2 text-truncate fs-6" t-esc="props.message.getPersonaName(persona)"/>
                            <div class="flex-grow-1"/>
                            <button t-if="props.message.effectiveSelf.eq(persona)" class="btn btn-light fa fa-trash rounded-pill bg-inherit border-0" title="Remove" t-on-click.stop="() =&gt; state.reaction.remove()"/>
                        </span>
                    </div>
                </div>
            </div>
        </Dialog>
    </t>

`);
registerTemplate("mail.MessageReactions", `/mail/static/src/core/common/message_reactions.xml`, `<t t-name="mail.MessageReactions" xml:space="preserve">
    <div class="o-mail-MessageReactions position-relative d-flex flex-wrap" t-att-class="{             'flex-row-reverse me-3': env.inChatWindow and env.alignedRight,             'ms-3': !(env.inChatWindow and env.alignedRight) and (props.message.isDiscussion),             'o-emojiPickerOpen': emojiPicker.isOpen,             'mt-n1': props.message.message_type === 'comment' and !props.message.attachment_ids.length,             'o-mt-0_5': props.message.attachment_ids.length,         }">
        <t t-foreach="props.message.reactions" t-as="reaction" t-key="reaction.content">
            <MessageReactionList message="this.props.message" openReactionMenu="this.props.openReactionMenu" reaction="reaction"/>
        </t>
        <QuickReactionMenu t-if="props.message.canAddReaction()" action="messageActions.actions.find(action =&gt; action.id === 'reaction')" classNames="{ 'p-1 mb-1 opacity-25 opacity-100-hover': true }" message="props.message"/>
    </div>
</t>
`);
registerTemplate("mail.NavigableList", `/mail/static/src/core/common/navigable_list.xml`, `<t t-name="mail.NavigableList" xml:space="preserve">
        <div class="o-mail-NavigableList bg-view m-0 p-0 shadow-sm" t-ref="root" t-att-class="props.class">
            <div t-if="show" class="o-open d-flex flex-column bg-inherit" t-on-mousedown.prevent="">
                <div t-if="state.showLoading" t-att-class="{ 'position-absolute bg-inherit smaller o-mail-NavigableList-floatingLoading': props.options.length, 'bg-300': props.options.length and state.activeIndex === 0, 'o-mail-NavigableList-item': !props.options.length }">
                    <t t-call="mail.NavigableList.spinner"/>
                </div>
                <div t-foreach="sortedOptions" t-as="option" t-key="option_index" class="o-mail-NavigableList-item" t-att-class="option.classList" t-on-mouseenter="() =&gt; this.onOptionMouseEnter(option_index)" t-on-click="(ev) =&gt; this.selectOption(ev, option_index)">
                    <hr class="my-2" t-if="option.group != lastGroup and option_index != 0"/>
                    <a role="button" class="d-flex align-items-center w-100 px-3 py-1 small" t-att-class="{ 'o-mail-NavigableList-active': state.activeIndex === option_index }" t-attf-class="{{ option.buttonClass }}">
                        <t t-if="option.optionTemplate" t-call="{{ option.optionTemplate }}"/>
                        <t t-elif="props.optionTemplate" t-call="{{ props.optionTemplate }}"/>
                        <t t-else="" t-esc="option.label"/>
                    </a>
                    <t t-set="lastGroup" t-value="option.group"/>
                </div>
            </div>
        </div>
    </t>

    `);
registerTemplate("mail.NavigableList.spinner", `/mail/static/src/core/common/navigable_list.xml`, `<t t-name="mail.NavigableList.spinner" xml:space="preserve">
        <span class="d-flex align-items-center w-100 py-2 gap-1 text-muted opacity-75" t-att-class="{ 'px-1': props.options.length, 'px-4': !props.options.length }">
            <i class="fa fa-spin fa-circle-o-notch"/>
            Loading
        </span>
    </t>
`);
registerTemplate("mail.NotificationMessage", `/mail/static/src/core/common/notification_message.xml`, `<t t-name="mail.NotificationMessage" xml:space="preserve">
        <div class="o-mail-NotificationMessage text-break mx-auto px-3 text-center smaller position-relative" t-on-click="onClickNotificationMessage" t-ref="root">
            <div class="o-mail-Message-jumpTarget position-absolute top-0 pe-none"/>
            <i t-if="message.notificationIcon" t-attf-class="{{ message.notificationIcon }} me-1 text-muted"/>
            <t t-if="message.notificationType === 'call'">
                <span class="text-muted" t-esc="callInformation"/>
            </t>
            <t t-elif="['channel_rename', 'thread_deletion'].includes(message.notificationType)">
                <span class="text-muted" t-out="message.inlineBody"/>
            </t>
            <t t-else="">
                <span class="o-mail-NotificationMessage-author d-inline text-muted" t-if="message.authorName and !message.richBody.includes(escape(message.authorName))" t-esc="message.authorName"/> <span class="text-muted" t-out="message.richBody"/>
            </t>
            <span class="o-mail-Message-date o-xsmaller ms-1" t-esc="message.dateSimpleWithDay"/>
        </div>
    </t>
`);
registerTemplate("mail.QuickReactionMenu", `/mail/static/src/core/common/quick_reaction_menu.xml`, `<t t-name="mail.QuickReactionMenu" xml:space="preserve">
        <t t-if="ui.isSmall" t-call="mail.QuickReactionMenu.toggler"/>
        <Dropdown t-else="" state="dropdown" manual="true" menuClass="\`o-mail-QuickReactionMenu-popover shadow-none\`" position="'top-middle'" navigationOptions="navigationOptions" bottomSheet="false">
            <t t-call="mail.QuickReactionMenu.toggler"/>
            <t t-set-slot="content">
                <div class="o-mail-QuickReactionMenu d-flex align-items-center o-px-0_5 bg-100 border border-secondary o-rounded-bubble shadow-sm gap-1" t-ref="toggle">
                    <button t-foreach="mostFrequentEmojis" t-as="emoji" t-key="emoji" class="o-mail-QuickReactionMenu-emoji o-mail-QuickReactionMenu-popEffect o-navigable d-flex justify-content-center align-items-center o-rounded-bubble btn lh-1 p-1" t-att-class="{ 'bg-secondary': reactedBySelf(emoji) }" t-att-title="getEmojiShortcode(emoji)" t-on-click="() =&gt; this.toggleReaction(emoji)">
                        <span class="fs-2" t-esc="emoji"/>
                    </button>
                    <button class="o-mail-QuickReactionMenu-emojiPicker o-mail-QuickReactionMenu-popEffect o-mail-QuickReactionMenu-popEffect--smaller o-navigable text-muted d-flex justify-content-center align-items-center btn btn-secondary o-rounded-bubble border border-dark-subtle" title="Toggle Emoji Picker" t-on-click="() =&gt; this.togglePicker()">
                        <i class="oi oi-close"/>
                    </button>
                </div>
            </t>
        </Dropdown>
    </t>

    `);
registerTemplate("mail.QuickReactionMenu.toggler", `/mail/static/src/core/common/quick_reaction_menu.xml`, `<t t-name="mail.QuickReactionMenu.toggler" xml:space="preserve">
        <button class="btn border-0 o-p-0_5 o-inline o-mail-QuickReactionMenu-toggler" t-att-class="attClass" t-att-title="props.action.name" t-att-aria-label="props.action.name" t-on-click="onClick">
            <i t-att-class="props.action.icon"/>
        </button>
    </t>
`);
registerTemplate("mail.SearchMessageInput", `/mail/static/src/core/common/search_message_input.xml`, `<t t-name="mail.SearchMessageInput" xml:space="preserve">
        <div class="o-mail-SearchMessageInput d-flex py-2">
            <div class="input-group">
                <div class="o_searchview form-control d-flex align-items-center bg-view p-0" role="search" aria-autocomplete="list">
                    <div class="o_searchview_input_container d-flex flex-grow-1 flex-wrap gap-1 h-100">
                        <input type="text" class="o_searchview_input flex-grow-1 w-auto border-0 rounded-start px-2 bg-view" accesskey="Q" placeholder="Search" t-model="state.searchTerm" t-on-keydown="onKeydownSearch" t-ref="autofocus" role="searchbox"/>
                    </div>
                </div>
                <button class="btn" t-att-class="state.searchedTerm === state.searchTerm ? 'btn-outline-secondary' : 'btn-secondary'" t-on-click="() =&gt; this.search()" aria-label="Search button">
                    <i t-if="!props.messageSearch.searching" class="o_searchview_icon oi oi-search" role="img" aria-label="Search Messages" title="Search Messages"/>
                    <i t-else="" class="fa fa-circle-o-notch fa-spin" aria-label="Search in progress" title="Search in progress"/>
                </button>
            </div>
            <Dropdown t-if="env.inChatter">
                <button class="btn btn-outline-secondary ms-3" aria-label="Filter Messages" title="Filter Messages">
                    <i class="fa fa-filter" role="img"/>
                </button>
                <t t-set-slot="content">
                    <t t-foreach="searchFilters" t-as="searchFilter" t-key="searchFilter.label">
                        <DropdownItem onSelected="() =&gt; this.onChangeSearchFilter(searchFilter)">
                            <input type="radio" class="form-check-input ms-0 me-2" t-att-checked="searchFilter.is_notification === this.props.messageSearch.is_notification" value="searchFilter.label"/>
                            <t t-esc="searchFilter.name"/>
                        </DropdownItem>
                    </t>
                </t>
            </Dropdown>
            <button t-if="env.inChatter" class="btn btn-outline-secondary ms-3" t-on-click="() =&gt; this.clear()" aria-label="Close button">
                <i class="o_searchview_icon oi oi-close cursor-pointer" role="img" aria-label="Close search" title="Close"/>
            </button>
        </div>
    </t>
`);
registerTemplate("mail.SearchMessageResult", `/mail/static/src/core/common/search_message_result.xml`, `<t t-name="mail.SearchMessageResult" xml:space="preserve">
        <div class="o-mail-SearchMessageResult">
            <p t-if="MESSAGE_FOUND" class="o-mail-SearchMessagesPanel-title py-1 mb-0 fw-bolder text-center text-uppercase text-muted smaller">
                <t t-out="MESSAGE_FOUND"/>
            </p>
            <MessageCardList messages="props.messageSearch.messages" thread="props.thread" mode="'search'" messageSearch="props.messageSearch" showEmpty="props.messageSearch.messages.length === 0 and props.messageSearch.searched" onClickJump="() =&gt; this.props.onClickJump?.()" loadMore="props.messageSearch.loadMore" onLoadMoreVisible.bind="onLoadMoreVisible"/>    
        </div>
    </t>
`);
registerTemplate("mail.SearchMessagesPanel", `/mail/static/src/core/common/search_messages_panel.xml`, `<t t-name="mail.SearchMessagesPanel" xml:space="preserve">
        <ActionPanel title="title" minWidth="200" initialWidth="400" icon="'oi oi-search'">
            <SearchMessageInput closeSearch="props.closeSearch" messageSearch="messageSearch" thread="props.thread"/>
            <SearchMessageResult thread="props.thread" messageSearch="messageSearch"/>
        </ActionPanel>
    </t>
`);
registerTemplate("mail.Thread", `/mail/static/src/core/common/thread.xml`, `<t t-name="mail.Thread" xml:space="preserve">
    <div class="o-mail-Thread position-relative flex-grow-1 d-flex flex-column overflow-auto o-scrollbar-thin bg-inherit" t-att-class="{ 'pb-5': env.inChatter?.aside, 'o-pb-3_5': !env.inChatter?.aside, 'ps-2 pe-3': env.inDiscussApp and !ui.isSmall, 'o-focused': state.isFocused }" t-att-data-transient="props.thread.isTransient" t-ref="messages" tabindex="-1" t-on-focusin="onFocusin" t-on-focusout="onFocusout">
        <t t-if="!props.thread.isEmpty or props.thread.loadOlder or props.thread.hasLoadingFailed" name="content">
            <div class="d-flex flex-column position-relative flex-grow-1 bg-inherit" t-att-class="{'justify-content-end': !env.inChatter and props.thread.model !== 'mail.box'}">
                <span class="position-absolute w-100 invisible" t-att-class="props.order === 'asc' ? 'bottom-0' : 'top-0'" t-ref="present-treshold" t-att-style="\`height: Min(\${PRESENT_THRESHOLD}px, 100%)\`"/>
                <t t-set="currentDay" t-value="0"/>
                <t t-if="props.order === 'asc'">
                    <t t-if="showLoadOlder" t-call="mail.Thread.loadOlder"/>
                    <t t-elif="props.thread.hasLoadingFailed" t-call="mail.Thread.loadingError"/>
                    <t t-elif="showStartMessage" t-call="mail.Thread.startMessage"/>
                </t>
                <span t-else="" class="pt-1" t-ref="load-newer"/>
                <t t-set="messages" t-value="orderedMessages"/>
                <t t-foreach="messages" t-as="msg" t-key="msg.id">
                    <t t-set="prevMsg" t-value="messages[msg_index -1]"/>
                    <t t-if="msg.dateDay !== currentDay and props.showDates">
                        <DateSection date="msg.dateDay" className="'pt-2 px-2'"/>
                        <t t-set="currentDay" t-value="msg.dateDay"/>
                    </t>
                    <div t-if="msg.threadAsFirstUnread?.eq(props.thread) and (prevMsg or props.thread.markedAsUnread)" class="o-mail-Thread-newMessage d-flex align-items-center fw-bold z-1 px-2">
                        <div class="o-mail-Thread-newMessageLine flex-grow-1 border border-danger rounded-start-3 opacity-100 shadow-sm my-1"/><span class="o-ps-1_5 pe-1 bg-danger o-text-white rounded text-uppercase shadow-sm o-xxsmaller">New</span>
                    </div>
                    <NotificationMessage t-if="msg.isNotification and !msg.notificationHidden" message="msg" thread="props.thread" registerMessageRef="registerMessageRef"/>
                    <Message t-elif="!msg.isNotification" asCard="props.thread.model === 'mail.box'" className="getMessageClassName(msg)" isInChatWindow="props.isInChatWindow" message="msg" previousMessage="prevMsg" registerMessageRef="registerMessageRef" squashed="isSquashed(msg, prevMsg)" onParentMessageClick.bind="() =&gt; msg.parent_id and env.messageHighlight?.highlightMessage(msg.parent_id, props.thread)" thread="props.thread" isFirstMessage="msg_first" hasActions="props.messageActions and !msg.eq(props.thread.from_message_id)" showDates="props.showDates"/>
                </t>
                <span t-if="props.order === 'asc'" class="pt-1" t-ref="load-newer"/>
                <t t-else="">
                    <t t-if="showLoadOlder" t-call="mail.Thread.loadOlder"/>
                    <t t-if="props.thread.hasLoadingFailed" t-call="mail.Thread.loadingError"/>
                </t>
            </div>
        </t>
        <t t-else="">
            <div class="o-mail-Thread-empty d-flex flex-column h-100" t-att-class="{                     'p-4': props.showEmptyMessage and !showStartMessage,                     'align-items-start justify-content-end': showStartMessage,                     'align-items-center justify-content-center opacity-75': !showStartMessage                 }">
                <t t-if="props.thread.isLoaded and props.showEmptyMessage">
                    <t name="empty-message">
                        <t t-if="showStartMessage" t-call="mail.Thread.startMessage"/>
                        <div t-else="" class="d-flex flex-column align-items-center">
                            <span class="fs-1" style="filter: grayscale(1);"></span>
                            <span>The conversation is empty.</span>
                        </div>
                    </t>
                </t>
            </div>
        </t>
        <t t-call="mail.Thread.jumpPresent"/>
    </div>
</t>

`);
registerTemplate("mail.Thread.jumpPresent", `/mail/static/src/core/common/thread.xml`, `<t t-name="mail.Thread.jumpPresent" xml:space="preserve">
    <button t-if="props.showJumpPresent and state.showJumpPresent" class="o-mail-Thread-jumpPresent position-fixed p-2 rounded-circle lh-1 m-n3 user-select-none btn btn-light shadow-sm border border-secondary" t-att-class="{ 'bottom-0': env.inChatter and !env.inChatter.aside }" t-ref="jump-present" t-on-click="() =&gt; this.jumpToPresent()" title="Jump to Present"><i class="oi text-muted" t-att-class="{ 'oi-chevron-down': props.order === 'asc', 'oi-chevron-up': props.order !== 'asc' }"/></button>
</t>

`);
registerTemplate("mail.Thread.loadOlder", `/mail/static/src/core/common/thread.xml`, `<t t-name="mail.Thread.loadOlder" xml:space="preserve">
    <button class="btn btn-link" t-att-class="{ 'opacity-0': !mountedAndLoaded }" t-on-click="onClickLoadOlder" t-ref="load-older">Load More</button>
</t>

`);
registerTemplate("mail.Thread.loadingError", `/mail/static/src/core/common/thread.xml`, `<t t-name="mail.Thread.loadingError" xml:space="preserve">
    <div class="d-flex flex-grow-1 align-items-center justify-content-center flex-column">
        <div class="o-mail-Thread-error">
            An error occurred while fetching messages.
        </div>
        <button class="btn btn-link" t-on-click="onClickLoadOlder">
            Click here to retry
        </button>
    </div>
</t>


`);
registerTemplate("mail.discuss_badge", `/mail/static/src/core/common/thread.xml`, `<t t-name="mail.discuss_badge" xml:space="preserve">
    <span class="badge rounded-pill o-discuss-badge flex-shrink-0 bg-inherit d-flex align-items-center justify-content-center" t-attf-class="{{ badgeClass }}" t-att-style="'margin: 0px; background-color: inherit !important;' + (floating ? 'padding: 1px;' : 'padding: 0px;')">
        <span class="rounded-pill o-innerBadge" t-attf-class="{{ counterClass }}" t-esc="counter" style="top: 0 !important;"/>
    </span>
</t>

`);
registerTemplate("mail.Thread.startMessage", `/mail/static/src/core/common/thread.xml`, `<t t-name="mail.Thread.startMessage" xml:space="preserve">
    <div class="pt-4" t-att-class="{ 'px-3': env.inChatWindow, 'px-2': env.inDiscussApp or env.inMeetingChat }">
        <div class="d-flex align-items-center gap-2" t-att-class="{             'mt-2 mb-1': !props.thread.parent_channel_id,             'mt-1': props.thread.parent_channel_id,         }">
            <div class="o-mail-Thread-avatar d-inline" t-att-class="{'o-mail-Thread-avatarChatWindow': env.inChatWindow }">
                <img t-if="!props.thread.parent_channel_id" class="rounded-3 object-fit-cover" t-att-src="props.thread?.avatarUrl" alt="Thread Image"/>
                <i t-else="" class="fa fa-comments-o text-muted" role="presentation"/>
            </div>
            <div role="heading" aria-level="1" class="text-break" t-att-class="{ 'fs-1': !env.inChatWindow, 'fs-3': env.inChatWindow }" t-esc="startMessageTitle"/>
        </div>
        <p class="text-muted mb-0 small text-break" t-esc="startMessageSubtitle"/>
    </div>
</t>
`);
registerTemplate("mail.ThreadIcon", `/mail/static/src/core/common/thread_icon.xml`, `<t t-name="mail.ThreadIcon" xml:space="preserve">
        <div class="o-mail-ThreadIcon d-flex justify-content-center flex-shrink-0" t-att-class="props.className">
            <t t-set="largeClass" t-value="props.size === 'large' ? 'fa-lg' : ''"/>
            <t t-if="props.thread.channel_type === 'channel'">
                <div t-if="props.thread.group_public_id" class="fa fa-fw fa-hashtag" t-att-class="largeClass" t-att-title="props.thread.accessRestrictedToGroupText"/>
                <div t-else="" class="fa fa-fw fa-globe" t-att-class="largeClass" title="Public Channel"/>
            </t>
            <t t-elif="props.thread.channel_type?.includes('chat') and correspondent">
                <t name="chat">
                    <t name="chat_static">
                        <ImStatus t-if="correspondent.im_status" member="correspondent" size="'md'"/>
                        <div t-else="" class="d-flex rounded-circle bg-inherit">
                            <i class="fa-fw" t-att-class="largeClass" t-attf-class="#{ defaultChatIcon.class }" t-att-title="defaultChatIcon.title"/>
                        </div>
                    </t>
                </t>
            </t>
            <div t-elif="props.thread.channel_type === 'group'" class="o-mail-ThreadIcon oi fa-fw oi-users" t-att-class="largeClass" title="Grouped Chat"/>
            <t t-elif="props.thread.model === 'mail.box'">
                <div t-if="props.thread.id === 'inbox'" class="fa fa-fw fa-inbox" t-att-class="largeClass"/>
                <div t-elif="props.thread.id === 'starred'" class="fa fa-fw fa-star-o" t-att-class="largeClass"/>
                <div t-elif="props.thread.id === 'history'" class="fa fa-fw fa-history" t-att-class="largeClass"/>
            </t>
        </div>
    </t>

`);
registerTemplate("discuss.BlurPerformanceWarning", `/mail/static/src/discuss/call/common/blur_performance_warning.xml`, `<t t-name="discuss.BlurPerformanceWarning" xml:space="preserve">
        <CallDropdown class="'position-absolute top-0 start-0 z-2'" menuClass="'o-discuss-BlurPerformanceWarning'" openByDefault="true">
            <div class="o-discuss-BlurPerformanceWarning-button btn bg-warning-subtle p-1 rounded-circle" title="Background Blur Performance Warning">
                <i class="fa fa-exclamation-triangle fa-fw"/>
            </div>
            <t t-set-slot="content">
                <div class="position-relative p-3 shadow rounded bg-warning-subtle text-dark" style="min-width:275px;">
                    <div class="position-absolute top-0 end-0 m-2 cursor-pointer" t-on-click="onClickClose" title="Dismiss warning">
                        <i class="oi oi-close"/>
                    </div>
                    <div>
                        <strong>Performance Warning:</strong><br/>
                        Hardware acceleration is disabled. Blur effect impacts performance significantly.
                    </div>
                </div>
            </t>
        </CallDropdown>
    </t>
`);
registerTemplate("discuss.Call", `/mail/static/src/discuss/call/common/call.xml`, `<t t-name="discuss.Call" xml:space="preserve">
        <PttAdBanner/>
        <div class="o-discuss-Call user-select-none d-flex position-relative shadow-sm" t-att-class="{             'o-fullSize': isFullSize,             'o-compact': props.compact and !isMobileOs,             'o-minimized': minimized,             'position-relative o-mx-0_5 o-mt-0_5 p-1': !rtc.state.isFullscreen and !props.isPip,             'rounded-2': !rtc.state.isFullscreen and !props.isPip and isActiveCall,             'o-hasVideo': channel.videoCount &gt; 0,             'o-selfInCall': isActiveCall,             'border-bottom': !isActiveCall,         }" t-ref="root">
            <div class="o-discuss-Call-main d-flex flex-grow-1 flex-column align-items-center justify-content-center position-relative overflow-auto o-scrollbar-thin" t-on-mouseleave="onMouseleaveMain">
                <BlurPerformanceWarning t-if="store.settings.blurPerformanceWarning"/>
                <div class="o-discuss-Call-mainCards d-flex align-items-center overflow-hidden h-100 w-100 flex-wrap justify-content-center" t-att-class="{'mt-1': minimized}" t-attf-style="--height:{{state.tileHeight}}px; --width:{{state.tileWidth}}px;" t-on-click="() =&gt; this.showOverlay()" t-on-mousemove="onMousemoveMain" t-ref="grid">
                    <CallParticipantCard t-foreach="visibleMainCards.slice(0,6)" t-as="cardData" t-key="cardData.key" cardData="cardData" className="'o-discuss-Call-mainCardStyle'" minimized="minimized" compact="props.compact" thread="channel"/>
                    <span t-if="env.inChatWindow and visibleMainCards.length &gt; 6" class="oi oi-ellipsis-h ps-1 pe-1"/>
                    <CallParticipantCard t-if="!env.inChatWindow" t-foreach="visibleMainCards.slice(6)" t-as="cardData" t-key="cardData.key" cardData="cardData" className="'o-discuss-Call-mainCardStyle p-1'" minimized="minimized" compact="props.compact" thread="channel"/>
                </div>


                <t t-if="hasSidebarButton">
                    <i t-if="state.sidebar" class="o-discuss-Call-sidebarToggler p-2 fs-5 cursor-pointer position-absolute oi oi-arrow-right" title="Hide sidebar" t-on-click="() =&gt; this.state.sidebar = false"/>
                    <i t-else="" class="o-discuss-Call-sidebarToggler p-2 fs-5 cursor-pointer position-absolute oi oi-arrow-left" title="Show sidebar" t-on-click="() =&gt; this.state.sidebar = true"/>
                </t>
                <div t-if="props.hasOverlay and (state.overlay or !isControllerFloating)" class="o-discuss-Call-overlay d-flex justify-content-center w-100 pb-1" t-att-class="{ 'o-isFloating position-absolute z-2 bottom-0 pb-2': isControllerFloating }">
                    <div t-on-mousemove="onMousemoveOverlay">
                        <CallActionList thread="channel" compact="props.compact or props.isPip"/>
                    </div>
                </div>
                <div t-if="hasCallNotifications" class="position-absolute d-flex flex-column-reverse start-0 bottom-0" t-att-class="{ 'ps-5 pb-5': rtc.state.isFullscreen, 'ps-2 pb-2': !rtc.state.isFullscreen }">
                    <span class="o-discuss-Call-notification text-bg-800 shadow-lg rounded-1 m-1" t-att-class="{ 'p-4 fs-4': rtc.state.isFullscreen, 'p-2': !rtc.state.isFullscreen }" t-foreach="rtc.notifications.values()" t-as="notification" t-key="notification.id" t-esc="notification.text"/>
                </div>
                <div class="o-discuss-Call-layoutActions position-absolute z-2 bottom-0 end-0">
                    <ActionList actions="layoutActions" inline="true"/>
                </div>
            </div>
            <div t-if="state.sidebar and channel.activeRtcSession" class="o-discuss-Call-sidebar d-flex align-items-center h-100 flex-column">
                <CallParticipantCard t-foreach="channel.visibleCards" t-as="cardData" t-key="cardData.key" cardData="cardData" className="'o-discuss-Call-sidebarCard w-100 p-1'" thread="channel" isSidebarItem="true"/>
            </div>
            <CallParticipantCard t-if="channel.videoCount &gt; 0 and state.insetCard" cardData="state.insetCard" className="'o-discuss-Call-mainCardStyle o-bg-black'" thread="channel" inset.bind="setInset"/>
        </div>
    </t>

`);
registerTemplate("discuss.CallActionList", `/mail/static/src/discuss/call/common/call_action_list.xml`, `<t t-name="discuss.CallActionList" xml:space="preserve">
        <div class="o-discuss-CallActionList d-flex flex-column justify-content-center" t-attf-class="{{ className }}" t-ref="root">
            <div class="o-discuss-CallActionList-bar d-flex align-items-center justify-content-between" t-att-class="{ 'w-100 ps-2 pe-2': isSmall }">
                <ActionList actions="actions" inline="true" hasBtnBg="true"/>
            </div>
            <div t-if="isMobileOS and store.settings.use_push_to_talk and isOfActiveCall" class="d-flex align-items-center flex-wrap justify-content-between p-2">
                <button class="o-discuss-CallActionList-pushToTalk btn btn-primary d-flex w-100 border-0 shadow-none" aria-label="Push to talk" t-on-touchstart.stop="rtc.onPushToTalk" t-on-touchend.stop="rtc.setPttReleaseTimeout">
                    <span class="w-100 fs-4 text-center">Push to talk</span>
                </button>
            </div>
        </div>
    </t>

`);
registerTemplate("discuss.CallContextMenu", `/mail/static/src/discuss/call/common/call_context_menu.xml`, `<t t-name="discuss.CallContextMenu" xml:space="preserve">
        <div class="o-discuss-CallContextMenu d-flex flex-column p-3 rounded">
            <div class="text-center pb-2 fw-bolder" t-out="props.rtcSession.name"/>
            <div t-if="!isSelf" class="d-flex flex-row gap-2 align-items-center">
                <i class="fa fa-fw fa-lg opacity-75" t-attf-class="{{state.rangeVolume &gt; 0 ? 'fa-volume-up' : 'fa-volume-off'}}"/>
                <div class="position-relative">
                    <input type="range" min="0.0" max="1" step="0.01" class="form-range h-auto" t-att-value="volume" t-model="state.rangeVolume" t-on-change="onChangeVolume"/>
                    <output t-esc="\`\${Math.round(state.rangeVolume * 200)}%\`" class="o-mail-CallContextMenu-volumeTooltip fw-bold rounded" t-attf-style="--progress:{{state.rangeVolume * 100}}%;"/>
                </div>
            </div>
            <t t-if="env.debug and !isSelf and rtc.state.connectionType === rtcConnectionTypes.P2P">
                <hr class="w-100 border-top"/>
                <div><span class="fw-bolder">RTC Session ID: </span><t t-out="props.rtcSession.id"/></div>
                <div><span class="fw-bolder">Connection type: </span><t t-out="rtc.state.connectionType"/></div>
                <div><span class="fw-bolder">To peer: </span><t t-out="outboundConnectionTypeText"/></div>
                <div><span class="fw-bolder">From peer: </span><t t-out="inboundConnectionTypeText"/></div>
                <div><span class="fw-bolder">Connection: </span><t t-out="state.peerStats.connectionState"/></div>
                <div><span class="fw-bolder">ICE connection: </span><t t-out="state.peerStats.iceConnectionState"/></div>
                <div><span class="fw-bolder">ICE: </span><t t-out="state.peerStats.iceState"/></div>
                <div><span class="fw-bolder">DTLS: </span><t t-out="state.peerStats.dtlsState"/></div>
                <div><span class="fw-bolder">Data channel: </span><t t-out="state.peerStats.dataChannelState"/></div>
                <div t-if="props.rtcSession.audioError"><span class="fw-bolder">Audio player: </span><t t-out="props.rtcSession.audioError"/></div>
                <div t-if="props.rtcSession.videoError"><span class="fw-bolder">Video player: </span><t t-out="props.rtcSession.videoError"/></div>
                <hr class="w-100 border-top"/>
                <div><span class="fw-bolder">ICE gathering: </span><t t-out="state.peerStats.iceGatheringState"/></div>
                <div><span class="fw-bolder">Packets sent: </span><t t-out="state.peerStats.packetsSent"/></div>
                <div><span class="fw-bolder">Packets received: </span><t t-out="state.peerStats.packetsReceived"/></div>
                <div><span class="fw-bolder">Log step: </span><t t-out="props.rtcSession.logStep"/></div>
            </t>
            <t t-elif="env.debug and isSelf and rtc.state.connectionType === rtcConnectionTypes.SERVER">
                <div><span class="fw-bolder">Connection type: </span><t t-out="rtc.state.connectionType"/></div>
                <div><span class="fw-bolder">RTC Session ID: </span><t t-out="props.rtcSession.id"/></div>
                <hr class="w-100 border-top"/>
                <div><span class="fw-bolder">Upload: </span><t t-out="outboundConnectionTypeText"/></div>
                <div><span class="fw-bolder">up ICE: </span><t t-out="state.uploadStats.iceState"/></div>
                <div><span class="fw-bolder">up DTLS: </span><t t-out="state.uploadStats.dtlsState"/></div>
                <div><span class="fw-bolder">Packets sent: </span><t t-out="state.uploadStats.packetsSent"/></div>
                <div><span class="fw-bolder">available bitrate: </span><t t-out="state.uploadStats.availableOutgoingBitrate"/></div>
                <hr class="w-100 border-top"/>
                <div><span class="fw-bolder">Download: </span><t t-out="inboundConnectionTypeText"/></div>
                <div><span class="fw-bolder">down ICE: </span><t t-out="state.downloadStats.iceState"/></div>
                <div><span class="fw-bolder">down DTLS: </span><t t-out="state.downloadStats.dtlsState"/></div>
                <div><span class="fw-bolder">Packets received: </span><t t-out="state.downloadStats.packetsReceived"/></div>
                <t t-if="state.producerStats.audio">
                    <hr class="w-100 border-top"/>
                    <div><span class="fw-bolder">microphone</span></div>
                    <div><span class="fw-bolder">codec: </span><t t-out="state.producerStats.audio.codec"/></div>
                    <div><span class="fw-bolder">clock rate: </span><t t-out="state.producerStats.audio.clockRate"/></div>
                </t>
                <t t-if="state.producerStats.camera and props.rtcSession.is_camera_on">
                    <hr class="w-100 border-top"/>
                    <div><span class="fw-bolder">camera</span></div>
                    <div><span class="fw-bolder">codec: </span><t t-out="state.producerStats.camera.codec"/></div>
                    <div><span class="fw-bolder">clock rate: </span><t t-out="state.producerStats.camera.clockRate"/></div>
                </t>
                <t t-if="state.producerStats.screen and props.rtcSession.is_screen_sharing_on">
                    <hr class="w-100 border-top"/>
                    <div><span class="fw-bolder">screen</span></div>
                    <div><span class="fw-bolder">codec: </span><t t-out="state.producerStats.screen.codec"/></div>
                    <div><span class="fw-bolder">clock rate: </span><t t-out="state.producerStats.screen.clockRate"/></div>
                </t>
            </t>
        </div>
    </t>
`);
registerTemplate("discuss.CallDropdown", `/mail/static/src/discuss/call/common/call_dropdown.xml`, `<t t-name="discuss.CallDropdown" xml:space="preserve">
        <div class="o-discuss-CallDropdown" t-att-class="props.class">
            <div class="d-flex h-100" t-ref="trigger" t-on-click="handleClick">
                <t t-slot="default"/>
            </div>

            <div t-if="isOpen" t-ref="menu" t-on-click="onClickMenu" class="o-discuss-CallDropdown-content o-dropdown--menu dropdown-menu" t-att-class="props.menuClass">
                <t t-slot="content"/>
            </div>
        </div>
    </t>

`);
registerTemplate("discuss.CallInfiniteMirroringWarning", `/mail/static/src/discuss/call/common/call_infinite_mirroring_warning.xml`, `<t t-name="discuss.CallInfiniteMirroringWarning" xml:space="preserve">
        <div class="d-flex justify-content-start align-items-start position-fixed top-0 end-0 w-100 pe-none">
            <div class="d-flex o-discuss-CallInfiniteMirroringWarning rounded justify-content-between fs-3 w-100 m-5 px-3 py-2 pe-auto">
                <div class="d-flex align-items-center fs-4">
                    To avoid the infinite mirror effect, please share a specific window or tab or another monitor.
                </div>
                <div class="d-flex gap-2 flex-shrink-0">
                    <button class="btn btn-link text-info fs-4" t-on-click="() =&gt; this.props.onClose({ stopScreensharing: true })">
                        Stop sharing
                    </button>
                    <button class="o-discuss-CallInfiniteMirroringWarning-dismiss border-0 bg-transparent opacity-50 opacity-100-hover pe-auto" t-on-click="() =&gt; this.props.onClose()">
                        <i class="fa fa-lg fa-times-circle"/>
                    </button>
                </div>
            </div>
        </div>
    </t>
`);
registerTemplate("discuss.CallInvitation", `/mail/static/src/discuss/call/common/call_invitation.xml`, `<t t-name="discuss.CallInvitation" xml:space="preserve">
        <div class="o-discuss-CallInvitation align-self-center o-rounded-bubble overflow-hidden shadow-sm" t-att-class="{'o-preview-open': state.showCameraPreview, 'o-chat': props.thread.channel_type === 'chat', 'border border-light': !store.isOdooWhiteTheme}">
            <div class="d-flex flex-colum d-flex flex-column">
                <div class="o-discuss-CallInvitation-main" t-ref="root">
                    <div class="ms-1 position-relative d-flex justify-content-between p-2">
                        <div class="d-flex align-items-center" style="min-width: 0;">
                            <div class="o-mail-CallInvitation-avatar flex-shrink-0 cursor-pointer d-flex align-items-center justify-content-center rounded-circle overflow-hidden" t-att-class="{'bg-primary': !inviter}" t-on-click="() =&gt; props.thread.open({ focus: true })" t-att-title="avatarTitle">
                                <img t-if="inviter" class="object-fit-cover h-100 w-100" t-att-src="inviter.avatarUrl" alt="Avatar"/>
                                <i t-else="" class="fa fa-phone"/>
                            </div>
                            <div class="ms-2 me-3 flex-grow-1 overflow-hidden">
                                <p class="o-discuss-CallInvitation-channelName m-0 fw-bold small text-truncate" t-esc="props.thread.displayName"/>
                                <p class="o-discuss-CallInvitation-description m-0 fst-italic smaller text-truncate pe-1" t-esc="incomingCallText"/>
                            </div>
                        </div>
                        <div class="d-flex align-items-center flex-shrink-0">
                            <ActionList actions="acceptOrRejectActions" inline="true" hasBtnBg="true"/>
                            <ActionList actions="otherActions" inline="true"/>
                        </div>
                    </div>
                    <div class="o-discuss-CallInvitation-cameraPreview" t-att-class="{'o-opened': state.showCameraPreview}">
                        <CallPreview activateCamera="state.activateCamera" activateMicrophone="state.activateMicrophone" onSettingsChanged="(settings) =&gt; this.onCallSettingsChanged(settings)"/>
                    </div>
                </div>
            </div>
        </div>
    </t>
`);
registerTemplate("discuss.CallInvitations", `/mail/static/src/discuss/call/common/call_invitations.xml`, `<t t-name="discuss.CallInvitations" xml:space="preserve">
        <div t-if="store.ringingThreads.length &gt; 0" class="o-discuss-CallInvitations position-fixed top-0 end-0 d-flex flex-column p-2">
            <t t-foreach="store.ringingThreads" t-as="thread" t-key="thread.localId">
                <CallInvitation thread="thread"/>
            </t>
        </div>
    </t>

`);
registerTemplate("discuss.CallMenu", `/mail/static/src/discuss/call/common/call_menu.xml`, `<t t-name="discuss.CallMenu" xml:space="preserve">
        <div class="dropdown" t-attf-class="{{ className }}" t-ref="root">
            <button t-if="rtc.channel" class="user-select-none dropdown-toggle o-no-caret o-dropdown--narrow" t-att-title="buttonTitle" role="button" t-on-click="rtc.channel.open">
                <div class="o-discuss-CallMenu-buttonContent d-flex btn-group rounded-2 opacity-75 opacity-100-hover" t-att-class="{ 'o-is-talking': rtc.selfSession?.isActuallyTalking, 'o-isOdooCommunity': !isEnterprise }">
                    <div class="o-discuss-CallMenu-channelInfo text-truncate btn btn-group-item border-0 m-0 p-0 d-flex align-items-center o-gap-0_5 ps-1" role="button">
                        <span class="position-relative small bg-transparent">
                            <i class="me-2 fa fa-fw" t-att-class="icon"/>
                            <small class="d-flex position-absolute top-0 end-0 smaller bg-inherit">
                                <i class="o-discuss-CallMenu-animation fa fa-volume-up o-discuss-inCallIconColor bg-inherit" t-att-class="{ 'o-isOdooCommunity': !isEnterprise }"/>
                            </small>
                        </span>
                        <span class="text-truncate fw-bold pe-1" t-esc="rtc.channel.displayName"/>
                    </div>
                    <Dropdown>
                        <button class="o-discuss-CallMenu-dropdownMore btn btn-group-item m-0 pe-1 o-ps-0_5">
                            <i class="oi oi-chevron-down o-xsmaller"/>
                        </button>
                        <t t-set-slot="content">
                            <ActionList actions="callActions.actions" dropdown="true"/>
                        </t>
                    </Dropdown>
                </div>
            </button>
        </div>
    </t>

`);
registerTemplate("discuss.CallParticipantCard", `/mail/static/src/discuss/call/common/call_participant_card.xml`, `<t t-name="discuss.CallParticipantCard" xml:space="preserve">
        <div class="o-discuss-CallParticipantCard position-relative cursor-pointer d-flex flex-column align-items-center justify-content-center mh-100 mw-100" t-att-class="{                 'o-isTalking': !props.minimized and isTalking,                 'o-isInvitation opacity-50': !rtcSession,                 'o-inset': props.inset,                 'pe-none': rtc.state.screenTrack and !rtc.state.screenTrack.enabled,                 'o-small': props.inset and (ui.isSmall or props.minimized),                 'o-active': isActiveRtcSession and !props.inset and props.compact,                 'p-1 rounded-1': !isActiveRtcSession,             }" t-att-title="name" t-att-aria-label="name" t-att-data-is-context-menu-available="isContextMenuAvailable" t-attf-class="{{ props.className }}" t-on-click="onClick" t-on-mousedown="onMouseDown" t-on-touchmove="onTouchMove" t-ref="root">

            <t t-if="!props.isSidebarItem and props.cardData.type === 'screen' and rtc.state.screenTrack and !rtc.state.screenTrack.enabled">
                <div class="o-text-white display-5 gap-3">
                    <button class="pe-auto bg-transparent o-text-white border-0 opacity-25 opacity-75-hover" t-ref="resumeStream" t-on-click.stop="() =&gt; (this.rtc.state.screenTrack.enabled = true)">
                        <i class="fa fa-fw" t-att-class="{ 'fa-play-circle-o': resumeStreamHover.isHover, 'fa-pause-circle-o': !resumeStreamHover.isHover }"/> <span><t t-if="resumeStreamHover.isHover">Resume stream</t><t t-else="">Stream paused</t></span>
                    </button>
                </div>
            </t>
            <CallParticipantVideo t-elif="hasVideo" session="rtcSession" type="props.cardData.type" inset="props.inset"/>
            <div t-else="" class="o-discuss-CallParticipantCard-avatar d-flex align-items-center justify-content-center h-100 w-100 rounded-1" t-att-class="{ 'o-minimized': props.minimized, 'o-isRemoteVideo': isRemoteVideo }" draggable="false">
                <img t-if="!showRemoteWarning" alt="Avatar" class="h-100 rounded-circle border-5 object-fit-cover" t-att-src="channelMember?.avatarUrl" draggable="false" t-att-class="{                     'o-isTalking': isTalking and props.minimized,                     'o-isInvitation': !rtcSession,                 }"/>
            </div>
            <t t-if="rtcSession">

                <span class="o-discuss-CallParticipantCard-overlay o-discuss-CallParticipantCard-overlayBottom z-1 position-absolute bottom-0 start-0 d-flex overflow-hidden rounded-1" t-att-class="{ 'o-proportional-container w-50': isSmall }" t-att-data-connection-state="rtcSession.connectionState">
                    <span t-if="!props.minimized and !props.inset" class="rounded-1 text-truncate opacity-75 w-100 o-proportional-text o-discuss-CallParticipantCard-overlayBottomName" t-att-class="{'o-minimized px-1': isSmall, 'p-0': !isSmall }" t-esc="name"/>
                    <small t-if="rtcSession.is_screen_sharing_on and props.minimized and !isOfActiveCall" class="user-select-none o-proportional-text o-minimized rounded text-bg-danger d-flex align-items-center fw-bolder p-1" title="live" aria-label="live">
                        LIVE
                    </small>
                </span>
                <span t-if="showRemoteWarning" class="o-discuss-CallParticipantCard-overlay o-proportional-container z-1 w-50 position-absolute d-flex align-items-center justify-content-center overflow-hidden">
                    <span class="fw-bolder p-1 rounded-1 o-video-text o-proportional-text">Video visible in the call tab</span>
                </span>
                <CallDropdown t-if="isContextMenuAvailable and ((!isMobileOS and rootHover.isHover) or (isMobileOS and !props.minimized))" class="'position-absolute top-0 end-0'" menuClass="'d-flex o-discuss-CallParticipantCard-contextMenu'">
                    <button class="o-discuss-CallParticipantCard-contextButton btn btn-secondary btn-sm rounded-circle border-0 smaller p-1" title="Participant options">
                        <i class="fa fa-chevron-down fa-fw"/>
                    </button>
                    <t t-set-slot="content">
                        <CallContextMenu rtcSession="rtcSession"/>
                    </t>
                </CallDropdown>
                <div class="o-discuss-CallParticipantCard-overlay position-absolute bottom-0 end-0 d-flex w-50 flex-row-reverse w-50" t-att-class="{ 'o-proportional-container': isSmall, 'mw-25': props.isSidebarItem or props.inset }">
                    <span t-if="hasRaisingHand" class="o-proportional-text d-flex flex-column justify-content-center me-1 rounded-circle bg-500" t-att-class="{'o-minimized p-1': isSmall, 'p-2': !isSmall }" title="raising hand" aria-label="raising hand">
                        <i class="fa fa-hand-paper-o"/>
                    </span>
                    <span t-if="rtcSession.is_muted and !rtcSession.is_deaf" class="o-proportional-text d-flex flex-column justify-content-center me-1 rounded-circle o-discuss-CallParticipantCard-iconBlackBg" t-att-class="{'o-minimized p-1': isSmall, 'p-2': !isSmall }" title="muted" aria-label="muted">
                        <i class="fa fa-microphone-slash"/>
                    </span>
                    <span t-if="rtcSession.is_deaf" class="o-proportional-text d-flex flex-column justify-content-center me-1 rounded-circle o-discuss-CallParticipantCard-iconBlackBg" t-att-class="{'o-minimized p-1': isSmall, 'p-2': !isSmall }" title="deaf" aria-label="deaf">
                        <i class="fa fa-deaf"/>
                    </span>
                    <span t-if="hasMediaError" class="o-discuss-CallParticipantCard-overlay-replayButton o-proportional-text d-flex flex-column justify-content-center me-1 rounded-circle" t-att-class="{'o-minimized p-1': isSmall, 'p-2': !isSmall }" title="media player Error" t-on-click.stop="onClickReplay">
                        <i t-if="rootHover.isHover" class="fa fa-repeat text-danger"/>
                        <i t-else="" class="fa fa-exclamation-triangle text-danger"/>
                    </span>
                    <span t-if="showConnectionState" class="o-proportional-text d-flex flex-column justify-content-center me-1 rounded-circle o-discuss-CallParticipantCard-iconBlackBg" t-att-class="{'o-minimized p-1': isSmall, 'p-2': !isSmall }" t-att-title="rtcSession.connectionState">
                        <i class="fa fa-exclamation-triangle text-warning"/>
                    </span>
                    <span t-if="showLiveLabel" class="user-select-none rounded o-proportional-text text-bg-danger d-flex align-items-center py-1 px-2 fw-bolder" title="live" aria-label="live">
                        LIVE
                    </span>
                </div>
            </t>
        </div>
    </t>

`);
registerTemplate("discuss.CallParticipantVideo", `/mail/static/src/discuss/call/common/call_participant_video.xml`, `<t t-name="discuss.CallParticipantVideo" xml:space="preserve">
        <video class="w-100 h-100 cursor-pointer" t-att-class="{ 'o-inset rounded-1': props.inset }" t-att-type="props.type" t-att-data-facing-mode="store.settings.cameraFacingMode" playsinline="true" autoplay="true" muted="true" t-on-loadedmetadata="onVideoLoadedMetaData" t-ref="root"/>
    </t>
`);
registerTemplate("discuss.CallPermissionDialog", `/mail/static/src/discuss/call/common/call_permission_dialog.xml`, `<t t-name="discuss.CallPermissionDialog" xml:space="preserve">
        <Dialog title="''" size="'md'">
            <h5 class="fw-medium fs-2 mb-2" t-out="permissionPrompt"/>
            <small class="text-muted" t-out="permissionNote"/>
            <t t-set-slot="footer">
                <button class="btn btn-primary px-4" t-on-click="props.media === 'microphone' ? onClickUseMicrophone : onClickUseCamera" t-out="primaryActionText"/>
                <button class="btn btn-outline-primary px-4" t-if="rtc.cameraPermission !== 'granted' and rtc.microphonePermission !== 'granted'" t-on-click="onClickUseMicAndCamera">Use microphone and camera</button>
            </t>
        </Dialog>
    </t>

`);
registerTemplate("mail.CallPreview", `/mail/static/src/discuss/call/common/call_preview.xml`, `<t t-name="mail.CallPreview" xml:space="preserve">
        <div class="o-mail-CallPreview ratio ratio-16x9">
            <div class="bg-dark">
                <video class="object-fit-cover h-100 w-100" autoplay="" style="background-color: rgba(0, 0, 0, 0.5);" t-ref="video"/>
                <div class="position-absolute bottom-0 mb-3 w-100 d-flex justify-content-center">
                    <ActionList actions="actions" inline="true" hasBtnBg="true"/>
                </div>
            </div>
            <audio autoplay="" t-ref="audio"/>
        </div>
    </t>
`);
registerTemplate("discuss.CallSettings", `/mail/static/src/discuss/call/common/call_settings.xml`, `<t t-name="discuss.CallSettings" xml:space="preserve">
        <ActionPanel t-if="props.withActionPanel" title.translate="Voice settings" icon="'fa fa-gear'">
            <t t-call="discuss.CallSettings.content"/>
        </ActionPanel>
        <t t-else="" t-call="discuss.CallSettings.content"/>
    </t>

    `);
registerTemplate("discuss.CallSettings.content", `/mail/static/src/discuss/call/common/call_settings.xml`, `<t t-name="discuss.CallSettings.content" xml:space="preserve">
        <div class="o-discuss-CallSettings d-flex flex-column">
            <h4>Voice</h4>
            <label class="d-flex align-items-baseline mb-2" title="Microphone" aria-label="Microphone">
                <span class="flex-shrink-0 pe-2">
                    Microphone
                </span>
                <div class="flex-grow-1"/>
                <DeviceSelect kind="'audioinput'"/>
            </label>
            <label class="d-flex align-items-baseline mb-2" title="Audio Output" aria-label="Audio Output">
                <span class="flex-shrink-0 pe-2">
                    Audio Output
                </span>
                <div class="flex-grow-1"/>
                <DeviceSelect kind="'audiooutput'"/>
            </label>
            <div class="d-flex flex-column">
                <button class="btn d-flex my-1" t-att-class="{'bg-300' : !store.settings.use_push_to_talk }" t-on-click="()=&gt;this.store.settings.setPushToTalk(false)">
                    <input class="form-check-input" type="radio" t-att-checked="store.settings.use_push_to_talk ? '' : 'checked'"/>
                    <span class="text-start flex-grow-1 mx-3">Voice Detection</span>
                </button>
                <button class="btn d-flex my-1" t-att-class="{'bg-300' : store.settings.use_push_to_talk }" t-on-click="()=&gt;this.store.settings.setPushToTalk(true)">
                    <input class="form-check-input" type="radio" t-att-checked="store.settings.use_push_to_talk ? 'checked' : ''"/>
                    <span class="text-start flex-grow-1 mx-3">Push to Talk</span>
                </button>
                <span t-if="store.settings.use_push_to_talk and !isMobileOS and !pttExtService.isEnabled" class="small text-muted fst-italic mb-3" t-out="pttExtService.downloadText"/>
            </div>
            <div class="d-flex flex-column">
                <t t-if="!store.settings.use_push_to_talk">
                    <span class="me-2 my-1">Voice detection sensitivity</span>
                    <div class="d-flex align-items-center w-100 h-100">
                        <button class="btn btn-primary" t-on-click="microphoneVolume.toggle" t-att-disabled="!microphoneVolume.isReady">
                            <div class="position-relative">
                                <span class="d-flex invisible text-nowrap">
                                    <t t-out="testText.length &gt; stopText.length ? testText : stopText"/>
                                </span>
                                <span class="position-absolute start-0 top-0">
                                    <t t-if="microphoneVolume.isActive" t-out="stopText"/>
                                    <t t-else="" t-out="testText"/>
                                </span>
                            </div>
                        </button>
                        <label class="w-100 d-flex ms-2" title="Voice detection sensitivity" aria-label="Voice detection sensitivity">
                            <input class="o-Discuss-CallSettings-thresholdInput form-range rounded" t-attf-style="--volume: {{microphoneVolume.value * 100}}%;" type="range" min="0.001" max="1" step="0.001" t-model="store.settings.voiceActivationThreshold" t-on-input="store.settings.saveVoiceThresholdDebounce"/>
                        </label>
                    </div>
                </t>
                <div t-if="store.settings.use_push_to_talk" class="d-flex" t-att-class="{'flex-column': props.isCompact}">
                    <div t-if="!isMobileOS" class="d-flex flex-column align-items-center" t-att-class="{'me-1 w-50': !props.isCompact}">
                        <label class="d-flex flex-column align-items-start flex-wrap w-100" title="Push-to-talk key" aria-label="Push-to-talk key">
                            <span class="me-2 my-1 text-truncate text-wrap">Push-to-talk key</span>
                            <span class="d-flex border border-2 rounded w-100" t-attf-class="{{ store.settings.isRegisteringKey ? 'border-danger' : 'border-primary' }}">
                                <span t-if="store.settings.push_to_talk_key" class="ms-1 px-3 fs-3 flex-grow-1" t-esc="pushToTalkKeyText"/>
                                <button class="btn btn-link px-2 py-0 text-black" t-on-click="onClickRegisterKeyButton">
                                    <i t-if="store.settings.isRegisteringKey" title="Cancel" aria-label="Cancel" class="fa fa-2x fa-times-circle"/>
                                    <i t-else="" title="Register new key" aria-label="Register new key" class="fa fa-2x fa-keyboard-o"/>
                                </button>
                            </span>
                        </label>
                    </div>
                    <div class="d-flex align-items-center" t-att-class="{'ms-1 w-50': !props.isCompact}">
                        <label class="d-flex flex-column align-items-start flex-wrap h-100 w-100" title="Delay after releasing push-to-talk" aria-label="Delay after releasing push-to-talk">
                            <span class="me-2 my-1 text-truncate text-wrap">Delay after releasing push-to-talk</span>
                            <div class="d-flex w-100 align-items-center">
                                <input class="flex-grow-1 form-range" type="range" min="0" max="2000" step="1" t-att-value="store.settings.voice_active_duration" t-on-input="onChangeDelay"/>
                                <span class="p-1 text-end"><t t-out="store.settings.voice_active_duration"/>ms</span>
                            </div>
                        </label>
                    </div>
                </div>
                <span t-if="store.settings.isRegisteringKey">Press a key to register it as the push-to-talk shortcut.</span>
            </div>
            <hr class="o-discuss-separator my-2"/>
            <h4>Video</h4>
            <label class="d-flex align-items-baseline mb-2" title="Camera" aria-label="Camera">
                <span class="flex-shrink-0 pe-2">
                    Camera
                </span>
                <div class="flex-grow-1"/>
                <DeviceSelect kind="'videoinput'"/>
            </label>
            <div class="d-flex flex-column my-1">
                <t t-call="discuss.CallSettings.textToggler">
                    <t t-set="text">Show video participants only</t>
                    <t t-set="value" t-value="store.settings.showOnlyVideo"/>
                    <t t-set="onchange" t-value="onChangeShowOnlyVideo"/>
                </t>
            </div>
            <div t-if="store.settings.hasCanvasFilterSupport" class="d-flex flex-column my-1">
                <t t-call="discuss.CallSettings.textToggler">
                    <t t-set="text">Blur video background</t>
                    <t t-set="value" t-value="store.settings.useBlur"/>
                    <t t-set="onchange" t-value="onChangeBlur"/>
                </t>
            </div>
            <t t-if="store.settings.useBlur">
                <div class="d-flex mt-1" t-att-class="{'flex-column': props.isCompact}">
                    <div class="d-flex flex-column align-items-center" t-att-class="{'me-1 w-50': !props.isCompact}">
                        <label class="d-flex flex-column align-items-start flex-wrap w-100" title="Background blur intensity" aria-label="Background blur intensity">
                            <span class="me-2 text-truncate text-wrap">Background blur intensity</span>
                            <div class="d-flex w-100 flex-grow-1 align-items-center">
                                <input class="flex-grow-2 form-range" type="range" min="0" max="20" step="1" t-att-value="store.settings.backgroundBlurAmount" t-on-change="onChangeBackgroundBlurAmount"/>
                                <span class="p-1 text-end o-discuss-DiscussCallSettings-width-text-percentage"><t t-out="Math.floor(store.settings.backgroundBlurAmount * 5)"/>%</span>
                            </div>
                        </label>
                    </div>
                    <div class="d-flex align-items-center" t-att-class="{'ms-1 w-50': !props.isCompact}">
                        <label class="d-flex flex-column align-items-start flex-wrap h-100 w-100" title="Edge blur intensity" aria-label="Edge blur intensity">
                            <span class="me-2 text-truncate text-wrap">Edge blur intensity</span>
                            <div class="d-flex w-100 flex-grow-1 align-items-center">
                                <input class="flex-grow-2 form-range" type="range" min="0" max="20" step="1" t-att-value="store.settings.edgeBlurAmount" t-on-change="onChangeEdgeBlurAmount"/>
                                <span class="p-1 text-end o-discuss-DiscussCallSettings-width-text-percentage"><t t-out="Math.floor(store.settings.edgeBlurAmount * 5)"/>%</span>
                            </div>
                        </label>
                    </div>
                </div>
            </t>
            <hr class="o-discuss-separator my-2"/>
            <h4>Technical Settings</h4>
            <t t-if="env.debug">
                <div class="d-flex flex-column my-1">
                    <t t-call="discuss.CallSettings.textToggler">
                        <t t-set="text">Log RTC events</t>
                        <t t-set="value" t-value="store.settings.logRtc"/>
                        <t t-set="onchange" t-value="onChangeLogRtc"/>
                    </t>
                </div>
            </t>
            <button class="btn btn-secondary mt-1 mb-2 w-100" t-on-click="onClickDownloadLogs">Download logs</button>
        </div>
    </t>
    `);
registerTemplate("discuss.CallSettings.textToggler", `/mail/static/src/discuss/call/common/call_settings.xml`, `<t t-name="discuss.CallSettings.textToggler" xml:space="preserve">
        <div class="d-flex flex-wrap align-items-center">
            <label class="d-flex align-items-center flex-wrap mw-100" t-att-title="text" t-att-aria-label="text">
                <span class="text-truncate text-wrap" t-out="text"/>
            </label>
            <div class="flex-grow-1"/>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" t-on-change="onchange" t-att-checked="value ? 'checked' : ''" t-att-title="text" t-att-aria-label="text"/>
            </div>
        </div>
    </t>

`);
registerTemplateExtension("mail.ChatWindow", `/mail/static/src/discuss/call/common/chat_window_patch.xml`, `<t t-inherit="mail.ChatWindow" t-inherit-mode="extension" xml:space="preserve">
        <xpath expr="//Thread" position="before">
            <PipBanner t-if="rtc.state.isPipMode and thread.eq(rtc.channel)" compact="true"/>
            <Call t-elif="thread.showCallView" thread="thread" compact="true"/>
        </xpath>
    </t>
`);
registerTemplate("discuss.CallDeviceSelect", `/mail/static/src/discuss/call/common/device_select.xml`, `<t t-name="discuss.CallDeviceSelect" xml:space="preserve">
        <select t-if="!isPermissionGranted(props.kind)" name="inputDevice" class="form-select d-flex shadow-sm" t-on-pointerdown.prevent="() =&gt; this.showPermissionDialog(props.kind)" t-on-keydown.prevent="() =&gt; this.showPermissionDialog(props.kind)">
            <option value="">Permission Needed</option>
        </select>
        <select t-else="" name="inputDevice" class="form-select d-flex shadow-sm" t-on-change="onChangeSelectAudioInput">
            <option t-if="!isBrowserChrome" value="">Browser Default</option>
            <t t-foreach="state.userDevices" t-as="device" t-key="device_index">
                <option t-if="device.kind === props.kind" t-att-selected="isSelected(device.deviceId)" t-att-value="device.deviceId">
                    <t t-esc="device.label || 'device ' + device_index"/>
                </option>
            </t>
        </select>
    </t>

`);
registerTemplate("mail.DiscussCallSettingsClientAction", `/mail/static/src/discuss/call/common/discuss_call_settings_client_action.xml`, `<t t-name="mail.DiscussCallSettingsClientAction" xml:space="preserve">
        <div class="o-mail-DiscussCallSettingsClientAction mx-3 my-2">
            <CallSettings withActionPanel="false"/>
        </div>
    </t>
`);
registerTemplate("mail.Meeting", `/mail/static/src/discuss/call/common/meeting.xml`, `<t t-name="mail.Meeting" xml:space="preserve">
        <div t-if="store.rtc.channel" class="o-mail-Meeting h-100 w-100 d-flex flex-column" t-att-class="{'o-fullscreen': store.rtc.state.isFullscreen, 'p-1': !ui.isSmall, 'pb-3': !ui.iSmall and !props.isPip}">
            <div class="d-flex flex-grow-1 h-100 o-min-height-0 gap-1 position-relative">
                <div class="o-mail-Meeting-callContainer h-100 flex-grow-1 o-min-width-0" t-att-class="{'d-none': ui.isSmall and threadActions.activeAction?.actionPanelComponentCondition, 'pb-0': ui.isSmall}">
                    <Call hasOverlay="false" isPip="props.isPip"/>
                </div>
                <div t-if="threadActions.activeAction?.actionPanelComponentCondition" t-attf-class="{{ threadActions.activeAction.panelOuterClass }}" class="o-mail-DiscussContent-panelContainer o-mail-discussSidebarBgColor h-100 border-start border-secondary flex-shrink-0 rounded-2" t-att-class="{ 'w-100': ui.isSmall }">
                    <t t-component="threadActions.activeAction.actionPanelComponent" t-props="threadActions.activeAction.actionPanelComponentProps" thread="thread"/>
                </div>
            </div>
            <div class="pt-2 d-flex justify-content-between overflow-x-auto flex-shrink-0" t-att-class="{'p-2 pb-3': ui.isSmall}">
                <div/>
                <CallActionList thread="store.rtc.channel"/>
                <MeetingSideActions threadActions="threadActions"/>
            </div>
        </div>
    </t>
`);
registerTemplate("mail.MeetingChat", `/mail/static/src/discuss/call/common/meeting_chat.xml`, `<t t-name="mail.MeetingChat" xml:space="preserve">
        <ActionPanel t-if="thread" title.translate="Chat" resizable="true" minWidth="300" initialWidth="400" icon="'fa fa-comments'" contentRef="panelContentRef">
            <Thread thread="thread" jumpPresent="state.jumpPresent"/>
            <t t-call="mail.ChatWindow.memberTyping"/>
            <Composer composer="thread.composer" autofocus="!isMobileOS" onDiscardCallback="() =&gt; (thread.composer.replyToMessage = undefined)" onPostCallback.bind="() =&gt; this.state.jumpPresent++" dropzoneRef="panelContentRef"/>
        </ActionPanel>
    </t>
`);
registerTemplate("mail.MeetingSideActions", `/mail/static/src/discuss/call/common/meeting_side_actions.xml`, `<t t-name="mail.MeetingSideActions" xml:space="preserve">
        <t t-set="dummy" t-value="computeActions()"/>
        <div class="o-mail-MeetingSideActions d-flex">
            <ActionList actions="actions" inline="true" hasBtnBg="true" thread="store.rtc.channel" odooControlPanelSwitchStyle="true"/>
        </div>
    </t>
`);
registerTemplate("discuss.pipBanner", `/mail/static/src/discuss/call/common/pip_banner.xml`, `<t t-name="discuss.pipBanner" xml:space="preserve">
    <span class="o-discuss-PipBanner px-2 py-1 mx-1 mt-1 rounded-1">
        <div class="d-flex justify-content-between align-items-center p-2">
            <span class="small fw-bold">Your call is in another window. <t t-if="!props.compact">Using picture-in-picture lets you stay in the call while you do other things.</t></span>
            <button class="btn o-discuss-PipBannerButton d-flex rounded-1" title="Bring call back" t-on-click="onClickClose">
                <t t-if="props.compact">
                    Bring back
                </t>
                <t t-else="">
                    Bring the call back here
                </t>
            </button>
        </div>
        <div class="d-flex justify-content-center">
            <CallActionList thread="rtc.channel" compact="true"/>
        </div>
    </span>
</t>

`);
registerTemplate("discuss.pttAdBanner", `/mail/static/src/discuss/call/common/ptt_ad_banner.xml`, `<t t-name="discuss.pttAdBanner" xml:space="preserve">
    <span t-if="isVisible" class="o-discuss-PttAdBanner alert alert-info px-2 py-1 m-0 rounded-0">
        <div class="d-flex justify-content-between align-items-center">
            <span class="small" t-out="pttExtService.downloadText"/>
            <button class="btn d-flex opacity-75 opacity-100-hover" title="Close banner" t-on-click="onClickClose">
                <i class="fa fa-fw fa-close"/>
            </button>
        </div>
    </span>
</t>

`);
registerTemplate("discuss.QuickVideoSettings", `/mail/static/src/discuss/call/common/quick_video_settings.xml`, `<t t-name="discuss.QuickVideoSettings" xml:space="preserve">
        <div class="o-discuss-QuickVideoSettings d-flex flex-column gap-1">
            <label class="btn border-transparent d-flex flex-column align-items-baseline">
                <span class="flex-shrink-0 pe-2">
                    Camera
                </span>
                <div class="flex-grow-1"/>
                <DeviceSelect kind="'videoinput'"/>
            </label>
            <div t-if="!isBrowserSafari()" class="btn border-transparent d-flex gap-2" t-on-click="() =&gt; store.settings.useBlur = !store.settings.useBlur">
                <label class="d-flex align-items-center flex-wrap mw-100 cursor-pointer gap-2">
                    <i class="fa fa-fw fa-photo"/><span class="text-truncate text-wrap">Blur background</span>
                </label>
                <div class="flex-grow-1"/>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" t-att-checked="store.settings?.useBlur ? 'checked' : ''"/>
                </div>
            </div>
            <button class="btn border-transparent d-flex align-items-center gap-2" t-on-click="onClickVideoSettings">
                <i class="fa fa-fw fa-gear"/><span>Video Settings</span>
            </button>
        </div>
    </t>

`);
registerTemplate("discuss.QuickVoiceSettings", `/mail/static/src/discuss/call/common/quick_voice_settings.xml`, `<t t-name="discuss.QuickVoiceSettings" xml:space="preserve">
        <div class="o-discuss-QuickVoiceSettings d-flex flex-column gap-1">
            <label class="btn border-transparent d-flex flex-column align-items-baseline">
                <span class="flex-shrink-0 pe-2">
                    Microphone
                </span>
                <div class="flex-grow-1"/>
                <DeviceSelect kind="'audioinput'"/>
            </label>
            <label class="btn border-transparent d-flex flex-column align-items-baseline">
                <span class="flex-shrink-0 pe-2">
                    Audio Output
                </span>
                <div class="flex-grow-1"/>
                <DeviceSelect kind="'audiooutput'"/>
            </label>
            <button t-if="store.rtc.selfSession" class="btn border-transparent d-flex" t-on-click="() =&gt; this.store.rtc.toggleDeafen()">
                <label class="d-flex align-items-center flex-wrap mw-100 cursor-pointer">
                    <span class="text-truncate text-wrap">Deafen</span>
                </label>
                <div class="flex-grow-1"/>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" t-att-checked="store.rtc.selfSession?.is_deaf ? 'checked' : ''"/>
                </div>
            </button>
            <button class="btn border-transparent d-flex" t-on-click="() =&gt; this.store.settings.use_push_to_talk = !this.store.settings.use_push_to_talk">
                <label class="d-flex align-items-center flex-wrap mw-100 cursor-pointer">
                    <span class="text-truncate text-wrap">Push-to-Talk</span>
                </label>
                <div class="flex-grow-1"/>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" t-att-checked="store.settings.use_push_to_talk ? 'checked' : ''"/>
                </div>
            </button>
            <button class="btn border-transparent d-flex align-items-center gap-2" t-on-click="onClickVoiceSettings">
                <i class="fa fa-fw fa-gear"/><span>Voice Settings</span>
            </button>
        </div>
    </t>

`);
registerTemplate("mail.ActionPanel", `/mail/static/src/discuss/core/common/action_panel.xml`, `<t t-name="mail.ActionPanel" xml:space="preserve">
        <ResizablePanel t-if="props.resizable and !env.inChatWindow and !env.inChatter and !ui.isSmall" class="classNames" handleSide="'start'" initialWidth="initialWidth" minWidth="minWidth">
            <t t-call="mail.ActionPanel.content"/>
        </ResizablePanel>
        <div t-else="" t-att-class="classNames">
            <t t-call="mail.ActionPanel.content"/>
        </div>
    </t>

    `);
registerTemplate("mail.ActionPanel.content", `/mail/static/src/discuss/core/common/action_panel.xml`, `<t t-name="mail.ActionPanel.content" xml:space="preserve">
        <div class="o-mail-ActionPanel-header position-sticky top-0 pt-2 pb-1 d-flex flex-column bg-inherit smaller" t-att-class="{ 'px-1 pb-1': env.inChatWindow, 'ps-1 pe-2 pb-2': !env.inChatWindow and !env.inMeetingView, 'o-ps-2_5 pe-2': env.inMeetingChat, 'ps-1': env.inMeetingView and !env.inMeetingChat }">
            <div class="d-flex align-items-center gap-1">
                <button t-if="env.closeActionPanel and env.inChatWindow" class="btn p-1 opacity-75 opacity-100-hover" title="Close panel" t-on-click.stop="env.closeActionPanel">
                    <i class="oi oi-arrow-left fa-fw"/>
                </button>
                <i t-if="props.icon" class="text-muted fa-fw" t-att-class="props.icon"/>
                <p t-if="props.title" class="fw-bold text-uppercase m-0 flex-grow-1" t-esc="props.title"/>
                <button t-if="env.closeActionPanel and !env.inChatWindow" class="btn p-1 opacity-75 opacity-100-hover ms-auto" title="Close panel" t-on-click.stop="env.closeActionPanel">
                    <i class="oi oi-close fa-fw"/>
                </button>
            </div>
            <t t-slot="header"/>
        </div>
        <div class="px-1 d-flex flex-column flex-grow-1 bg-inherit o-min-height-0" t-ref="contentRef">
            <t t-slot="default"/>
        </div>
    </t>

`);
registerTemplate("mail.AttachmentPanel", `/mail/static/src/discuss/core/common/attachment_panel.xml`, `<t t-name="mail.AttachmentPanel" xml:space="preserve">
        <ActionPanel title.translate="Attachments" minWidth="200" initialWidth="400" icon="'fa fa-paperclip'">
            <div class="d-flex flex-column py-2 flex-grow-1">
                <div class="flex-grow-1" t-att-class="{                     'd-flex justify-content-center align-items-center': props.thread.attachments.length === 0,                 }">
                    <p t-if="props.thread.attachments.length === 0" class="text-center fst-italic text-500">
                        <t t-if="props.thread.channel_type === 'channel'">This channel doesn't have any attachments.</t>
                        <t t-else="">This conversation doesn't have any attachments.</t>
                    </p>
                    <div t-else="" t-foreach="attachmentsByDate" t-as="dateDay" t-key="dateDay" class="d-flex flex-column">
                        <DateSection date="dateDay" className="'my-1'"/>
                        <AttachmentList attachments="dateDay_value" unlinkAttachment="(attachment) =&gt; this.attachmentUploadService.unlink(attachment)"/>
                    </div>
                </div>
                <span t-ref="load-older"/>
            </div>
        </ActionPanel>
    </t>
`);
registerTemplate("mail.AvatarStack", `/mail/static/src/discuss/core/common/avatar_stack.xml`, `<t t-name="mail.AvatarStack" xml:space="preserve">
        <div t-if="props.personas.length &gt; 0" class="bg-inherit" t-att-class="props.containerClass" t-on-click="props.onClick">
            <div class="d-flex bg-inherit position-relative z-1" t-att-class="{'flex-column': props.direction === 'v'}">
                <span t-foreach="props.personas.slice(0, props.max)" t-as="persona" t-key="persona.localId" class="bg-inherit rounded-circle position-relative" t-attf-style="{{getStyle(persona_index)}}">
                    <img t-att-src="persona.avatarUrl" t-att-title="persona.displayName or persona.name" class="w-100 h-100 rounded-circle object-fit-cover" t-attf-class="{{props.avatarClass(persona)}}"/>
                    <t t-slot="avatarExtraInfo" persona="persona"/>
                </span>
                <span t-if="props.personas.length &gt; props.max" class="rounded-circle bg-secondary smaller d-flex justify-content-center align-items-center user-select-none" t-attf-style="{{getStyle(props.personas.length)}}; font-weight: 450;">+<t t-esc="props.personas.length - props.max"/></span>
            </div>
        </div>
    </t>
`);
registerTemplate("discuss.ChannelInvitation", `/mail/static/src/discuss/core/common/channel_invitation.xml`, `<t t-name="discuss.ChannelInvitation" xml:space="preserve">
        <ActionPanel t-if="props.thread" title.translate="Invite people" resizable="!!env.inMeetingView" minWidth="env.inMeetingView ? 300 : undefined" initialWidth="env.inMeetingView ? 400 : undefined" icon="'oi oi-user-plus'">
            <t t-call="discuss.ChannelInvitation.main"/>
        </ActionPanel>
        <t t-else="" t-call="discuss.ChannelInvitation.main"/>
    </t>

    `);
registerTemplate("discuss.ChannelInvitation.main", `/mail/static/src/discuss/core/common/channel_invitation.xml`, `<t t-name="discuss.ChannelInvitation.main" xml:space="preserve">
        <div class="d-flex flex-column flex-grow-1 bg-inherit o-min-height-0" t-att-class="{ 'o-mail-Discuss-threadActionPopover w-100': props.hasSizeConstraints, 'px-1': !props.thread }">
            <t t-if="store.self_partner">
                <input class="o-discuss-ChannelInvitation-search form-control lh-1 px-2 bg-view" t-att-value="searchStr" t-ref="input" t-att-placeholder="searchPlaceholder" t-on-input="onInput"/>
                <ul class="d-flex flex-column mx-0 pt-1 pb-0 overflow-auto o-scrollbar-thin list-group border-0 flex-grow-1" t-att-class="{ 'align-items-center justify-content-center': selectablePartners.length === 0 and state.selectableEmails.length === 0 }">
                    <div t-if="selectablePartners.length === 0 and state.selectableEmails.length === 0" class="smaller text-muted mx-1 opacity-50">
                        <t t-if="props.thread">No user found that is not already a member of this channel.</t>
                        <t t-else="">No user found.</t>
                    </div>
                    <div t-if="state.searchResultCount &gt; selectablePartners.length" class="smaller text-muted mx-1 mb-1 fst-italic" t-esc="showingResultNarrowText"/>
                    <t t-foreach="selectablePartners" t-as="selectablePartner" t-key="selectablePartner.id">
                        <t t-call="discuss.ChannelInvitation-selectableItem">
                            <t t-set="selectableItemIndex" t-value="selectablePartner_index"/>
                        </t>
                    </t>
                    <t t-foreach="state.selectableEmails" t-as="selectableEmailAddress" t-key="selectableEmailAddress">
                        <t t-call="discuss.ChannelInvitation-selectableItem">
                            <t t-set="selectableEmailAddress" t-value="selectableEmailAddress"/>
                            <t t-set="selectableItemIndex" t-value="selectablePartners.length + selectableEmailAddress_index"/>
                        </t>
                    </t>
                </ul>
            </t>
            <div class="o-discuss-ChannelInvitation-invitationBox pt-0 pb-1 bg-inherit">
                <t t-if="store.self_partner">
                    <div t-if="selectedPartners.length &gt; 0 or state.selectedEmails.length &gt; 0" class="pt-2">
                        <div class="o-discuss-ChannelInvitation-selectedList d-flex flex-wrap overflow-auto o-scrollbar-thin">
                            <t t-foreach="selectedPartners" t-as="selectedPartner" t-key="selectedPartner.id">
                                <button class="btn btn-light fw-bolder smaller pe-1" title="Unselect person" t-on-click="() =&gt; this.onClickSelectedPartner(selectedPartner)">
                                    <t t-esc="selectedPartner.name"/><i class="oi oi-close border border-dark-subtle ms-1"/>
                                </button>
                            </t>
                            <t t-foreach="state.selectedEmails" t-as="selectedEmail" t-key="selectedEmail">
                                <button class="btn btn-light fw-bolder smaller pe-1" title="Unselect person" t-on-click="() =&gt; this.onClickSelectedEmail(selectedEmail)">
                                    <t t-esc="selectedEmail"/><i class="oi oi-close border border-dark-subtle ms-1"/>
                                </button>
                            </t>
                        </div>
                    </div>
                    <button t-if="props.thread and (selectedPartners.length &gt; 0 or state.selectedEmails.length &gt; 0)" class="btn btn-primary w-100 my-2" t-att-title="invitationButtonText" t-on-click="onClickInvite">
                        <t t-esc="invitationButtonText"/>
                    </button>
                </t>
                <hr t-if="props.thread?.invitationLink" class="border-dark-subtle"/>
                <div t-if="props.thread?.invitationLink" class="input-group">
                    <input class="border border-secondary form-control lh-1 rounded-start border-0 smaller" type="text" t-att-value="props.thread.invitationLink" readonly="" disabled="" t-on-focus="onFocusInvitationLinkInput"/>
                    <button class="btn btn-primary px-2 o-py-0_5" t-on-click="onClickCopy">
                        <i class="fa fa-copy"/>
                    </button>
                </div>
                <div t-if="props.thread?.accessRestrictedToGroupText" class="mt-2 text-muted smaller mx-1" t-esc="props.thread.accessRestrictedToGroupText"/>
            </div>
        </div>
    </t>
    `);
registerTemplate("discuss.ChannelInvitation-selectableItem", `/mail/static/src/discuss/core/common/channel_invitation.xml`, `<t t-name="discuss.ChannelInvitation-selectableItem" xml:space="preserve">
        <t t-set="isSelected" t-value="selectablePartner ? selectablePartner.in(selectedPartners) : state.selectedEmails.includes(selectableEmailAddress)"/>
        <li class="o-discuss-ChannelInvitation-selectable object-fit-cover d-flex align-items-start px-1 py-0 btn list-group-item border-0 rounded-0 w-100" t-att-class="{ 'o-odd': selectableItemIndex % 2 === 1, 'o-selected': isSelected, 'align-items-center': selectableEmailAddress }" t-on-click="() =&gt; selectablePartner ? this.onClickSelectablePartner(selectablePartner) : this.onClickSelectableEmail(selectableEmailAddress) ">
            <div class="d-flex align-items-center p-1 bg-inherit">
                <div class="o-discuss-ChannelInvitation-avatar position-relative d-flex flex-shrink-0 bg-inherit">
                    <t t-if="selectablePartner">
                        <img class="w-100 h-100 rounded-3 object-fit-cover" t-att-src="selectablePartner.avatarUrl"/>
                        <ImStatus persona="selectablePartner" className="'position-absolute top-100 start-100 translate-middle mt-n1 ms-n1'" size="'md'"/>
                    </t>
                    <div t-else="" class="w-100 h-100 d-flex align-items-center justify-content-center rounded-3 bg-primary text-white">
                        <i class="fa fa-envelope"/>
                    </div>
                </div>
            </div>
            <div class="d-flex flex-column mx-2 flex-grow-1 overflow-hidden o-mt-0_5">
                <t t-if="selectablePartner">
                    <div class="d-flex overflow-hidden align-items-baseline" name="selectablePartnerName">
                        <span class="text-truncate" t-esc="selectablePartner.name"/>
                    </div>
                    <div class="d-flex flex-column flex-grow-1 gap-1" name="selectablePartnerDetail">
                        <span t-if="selectablePartner.email" t-esc="selectablePartner.email" class="text-truncate text-start smaller text-600 fw-normal lh-1"/>
                    </div>
                </t>
                <div t-else="" class="overflow-hidden d-flex flex-column align-items-baseline">
                    <span class="text-truncate text-start w-100" t-esc="selectableEmailAddress"/>
                    <span t-if="state.sentEmails.has(selectableEmailAddress)" class="text-truncate text-start smaller text-600 fw-normal lh-1 w-100">Invitation already sent to this address</span>
                </div>
            </div>
            <input class="form-check-input flex-shrink-0 me-1" type="checkbox" t-att-checked="isSelected ? 'checked' : undefined"/>
        </li>
    </t>
`);
registerTemplate("discuss.ChannelMemberList", `/mail/static/src/discuss/core/common/channel_member_list.xml`, `<t t-name="discuss.ChannelMemberList" xml:space="preserve">
        <ActionPanel title.translate="Members" minWidth="200" initialWidth="env.inMeetingView ? 400 : 250" icon="'oi oi-users'">
            <button name="inviteButton" t-on-click="() =&gt; props.openChannelInvitePanel({ keepPrevious: env.inChatWindow })" class="btn btn-sm btn-secondary mt-2 d-flex align-items-center justify-content-center gap-1 rounded-3"><i class="oi oi-user-plus"/><span>Invite a User</span></button>
            <t t-if="props.thread.onlineMembers.length &gt; 0">
                <t t-call="discuss.ChannelMemberList.section">
                    <t t-set="sectionName" t-value="onlineSectionText"/>
                </t>
                <div class="d-flex flex-column bg-inherit gap-1">
                    <t t-foreach="props.thread.onlineMembers" t-as="member" t-key="member.id" t-call="discuss.channel_member"/>
                </div>
            </t>
            <t name="offlineMembers" t-if="props.thread.offlineMembers.length &gt; 0">
                <t t-call="discuss.ChannelMemberList.section">
                    <t t-set="sectionName" t-value="offlineSectionText"/>
                </t>
                <div class="d-flex flex-column bg-inherit gap-1">
                    <t t-foreach="props.thread.offlineMembers" t-as="member" t-key="member.id" t-call="discuss.channel_member">
                        <t t-set="offline" t-value="1"/>
                    </t>
                </div>
            </t>
            <span t-if="props.thread.unknownMembersCount === 1" class="mx-2 mt-2">And 1 other member.</span>
            <span t-if="props.thread.unknownMembersCount &gt; 1" class="mx-2 mt-2">And <t t-esc="props.thread.unknownMembersCount"/> other members.</span>
            <div t-if="!props.thread.areAllMembersLoaded" class="mx-2 my-1">
                <button class="btn btn-secondary" title="Load more" t-on-click.stop="() =&gt; props.thread.fetchChannelMembers()">Load more</button>
            </div>
        </ActionPanel>
    </t>

    `);
registerTemplate("discuss.ChannelMemberList.section", `/mail/static/src/discuss/core/common/channel_member_list.xml`, `<t t-name="discuss.ChannelMemberList.section" xml:space="preserve">
        <h6 class="text-muted pt-4 text-uppercase o-xsmaller opacity-75" t-esc="sectionName"/>
    </t>

    `);
registerTemplate("discuss.channel_member", `/mail/static/src/discuss/core/common/channel_member_list.xml`, `<t t-name="discuss.channel_member" xml:space="preserve">
        <div class="o-discuss-ChannelMember d-flex align-items-center p-1 bg-inherit rounded-3" t-att-class="{ 'cursor-pointer': canOpenChatWith(member), 'o-offline': offline }" t-on-click.stop="(ev) =&gt; this.onClickAvatar(ev, member)">
            <div class="bg-inherit o-discuss-ChannelMember-avatar position-relative d-flex flex-shrink-0 rounded-3">
                <img class="w-100 h-100 rounded-3 object-fit-cover" t-att-src="member.avatarUrl"/>
                <ImStatus member="member" className="'position-absolute top-100 start-100 translate-middle mt-n1 ' + (member.isTyping ? 'ms-n2' : 'ms-n1')" size="'md'"/>
            </div>
            <div t-ref="displayName" class="d-flex overflow-hidden flex-column lh-sm">
                <span class="ms-2 text-truncate text-muted fw-bold" t-esc="member.name" t-att-title="member.name"/>
            </div>
            <span class="ms-auto">
                <span t-if="member.in(props.thread.invited_member_ids)" class="p-1 oi oi-user-plus opacity-75"/>
                <span t-if="member.rtcSession?.is_muted and !member.rtcSession?.is_deaf" class="p-1 fa fa-microphone-slash opacity-75"/>
                <span t-elif="member.rtcSession?.is_deaf" class="p-1 fa fa-deaf opacity-75"/>
                <span t-if="member.rtcSession?.raisingHand" class="p-1 fa fa-hand-paper-o"/>
            </span>

        </div>
    </t>

`);
registerTemplate("discuss.DeleteThreadDialog", `/mail/static/src/discuss/core/common/delete_thread_dialog.xml`, `<t t-name="discuss.DeleteThreadDialog" xml:space="preserve">
        <ActionPanel title.translate="Delete Thread" icon="'fa fa-trash'" resizable="false">
            <div class="d-flex justify-content-between align-items-center">
                <p class="fs-5 mb-0">Permanently delete this thread?</p>
                <button class="btn btn-danger" t-on-click="onConfirmation">
                    Delete Thread
                </button>
            </div>
        </ActionPanel>
    </t>
`);
registerTemplate("mail.DiscussNotificationSettings", `/mail/static/src/discuss/core/common/discuss_notification_settings.xml`, `<t t-name="mail.DiscussNotificationSettings" xml:space="preserve">
        <div class="o-mail-DiscussNotificationSettings d-flex flex-column">
            <div class="d-flex flex-column my-1">
                <h5>Channel Notifications</h5>
                <span class="mb-1 text-muted small">This setting will be applied to all channels using the default notification settings.</span>
                <t t-foreach="store.settings.NOTIFICATIONS" t-as="notif" t-key="notif.label">
                    <button class="btn d-flex my-1" t-att-class="{'o-selected' : notif.label === store.settings.channel_notifications}" t-on-click="()=&gt; this.store.settings.setCustomNotifications(notif.label)">
                        <input class="form-check-input" type="radio" t-att-checked="notif.label === store.settings.channel_notifications"/>
                        <div class="d-flex flex-column text-start flex-grow-1 mx-3">
                            <span t-esc="notif.name"/>
                        </div>
                    </button>
                </t>
            </div>
            <hr class="o-discuss-separator my-1"/>
            <label class="cursor-pointer d-flex align-items-center my-1">
                <h5>Message sound</h5>
                <div class="flex-grow-1"/>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" t-att-checked="store.settings.messageSound" t-on-change="onChangeMessageSound"/>
                </div>
            </label>
        </div>
    </t>
`);
registerTemplateExtension("mail.Message", `/mail/static/src/discuss/core/common/message_patch.xml`, `<t t-inherit="mail.Message" t-inherit-mode="extension" xml:space="preserve">
        <xpath expr="//div[hasclass('o-mail-Message-body')]" position="after">
            <div class="o-mail-Message-seenContainer position-absolute">
                <MessageSeenIndicator t-if="showSeenIndicator" message="props.message" thread="props.thread"/>
            </div>
        </xpath>
        <xpath expr="//AttachmentList" position="after">
            <div t-if="props.message.isBodyEmpty and message.attachment_ids.length &gt; 0" class="o-mail-Message-seenContainer position-absolute ratio-1x1 rounded-circle p-1">
                <MessageSeenIndicator t-if="showSeenIndicator" message="props.message" thread="props.thread"/>
            </div>
        </xpath>
    </t>
`);
registerTemplate("mail.MessageSeenIndicator", `/mail/static/src/discuss/core/common/message_seen_indicator.xml`, `<t t-name="mail.MessageSeenIndicator" xml:space="preserve">
        <span class="o-mail-MessageSeenIndicator position-relative" t-att-class="{ 'opacity-25': !props.message.hasEveryoneSeen, 'o-hasEveryoneSeen opacity-75': props.message.hasEveryoneSeen, 'cursor-pointer': props.message.channelMemberHaveSeen.length }" t-att-title="summary" t-attf-class="{{ props.className }}" t-on-click="openDialog">
            <t t-if="!props.message.isMessagePreviousToLastSelfMessageSeenByEveryone">
                <i t-if="props.message.hasSomeoneFetched or props.message.hasSomeoneSeen" class="fa fa-check ps-1"/>
                <i t-if="props.message.hasSomeoneSeen" class="o-second start-0 fa fa-check position-absolute"/>
            </t>
        </span>
    </t>

    `);
registerTemplate("mail.MessageSeenIndicatorPopover.card", `/mail/static/src/discuss/core/common/message_seen_indicator.xml`, `<t t-name="mail.MessageSeenIndicatorPopover.card" xml:space="preserve">
        <div class="o-mail-MessageSeenIndicatorPopover-card d-flex align-items-center gap-2">
            <span class="o_avatar position-relative o_card_avatar" style="width: 30px;height:30px;">
                <img t-att-src="member.avatarUrl" class="w-100 h-100 rounded object-fit-cover"/>
            </span>
            <span class="fw-bold" t-esc="member.name"/>
        </div>
    </t>

    `);
registerTemplate("mail.MessageSeenIndicatorDialog", `/mail/static/src/discuss/core/common/message_seen_indicator.xml`, `<t t-name="mail.MessageSeenIndicatorDialog" xml:space="preserve">
        <Dialog size="'sm'" title.translate="Seen by:" footer="false" withBodyPadding="false">
            <ul class="list-group list-group-flush list-unstyled py-1" t-ref="content">
                <li class="list-group-item py-2" t-foreach="props.message.channelMemberHaveSeen" t-as="member" t-key="member.id">
                    <t t-call="mail.MessageSeenIndicatorPopover.card"/>
                </li>
            </ul>
        </Dialog>
    </t>

`);
registerTemplate("discuss.NotificationSettings", `/mail/static/src/discuss/core/common/notification_settings.xml`, `<t t-name="discuss.NotificationSettings" xml:space="preserve">
        <ActionPanel title.translate="Notification Settings" resizable="!!env.inMeetingView" initialWidth="400" icon="'fa fa-bell'">
            <div class="o-discuss-NotificationSettings">
                <t t-if="props.thread.self_member_id?.mute_until_dt">
                    <button class="btn w-100 d-flex p-1 opacity-75 border-0" t-on-click="()=&gt;this.setMute(false)">
                        <div class="d-flex flex-column flex-grow-1 px-2 py-1 w-100 rounded">
                            <span class="fs-6 fw-bold text-wrap text-start text-break">Unmute Conversation</span>
                            <span class="fw-normal smaller text-start" t-out="store.settings.getMuteUntilText(props.thread.self_member_id?.mute_until_dt)"/>
                        </div>
                    </button>
                </t>
                <div class="d-flex">
                    <Dropdown position="ui.isSmall ? 'bottom-end' : 'right-start'" menuClass="'o-mail-NotificationSettings-submenu my-0 ' + store.discussDropdownMenuClass(this)">
                        <button class="btn w-100 d-flex p-1 opacity-75 border-0">
                            <div class="d-flex flex-grow-1 align-items-center px-0 py-1 w-100 rounded">
                                <span class="text-wrap text-start text-break">Mute Conversation</span>
                                <div class="o-discuss-NotificationSettings-separator flex-grow-1"/>
                                <i class="oi oi-arrow-right ms-2 me-1"/>
                            </div>
                        </button>
                        <t t-set-slot="content">
                            <t t-foreach="store.settings.MUTES" t-as="mute" t-key="mute.label">
                                <DropdownItem class="'o-mail-NotificationSettings-muteDuration btn rounded-0 d-flex align-items-center px-2 py-2 m-0'" onSelected="()=&gt;this.setMute(mute.value)"><button class="btn p-0 mx-2 text-wrap text-start text-break" t-out="mute.name"/></DropdownItem>
                            </t>
                        </t>
                    </Dropdown>
                </div>
                <t t-if="props.thread.channel_type === 'channel'">
                    <hr class="solid mx-1 my-2"/>
                    <button class="btn d-flex w-100 p-0 border-0" t-on-click="() =&gt; store.settings.setCustomNotifications(false, props.thread)">
                        <div class="d-flex flex-grow-1 align-items-center px-2 rounded">
                            <div class="d-flex flex-column align-items-start">
                                <span class="fs-6 text-wrap text-start text-break">Use Default</span>
                                <span class="fw-bolder o-xsmaller ps-2 o-discuss-NotificationSettings-defaultValue"><t t-out="store.settings.NOTIFICATIONS.find((n) =&gt; n.label === store.settings.channel_notifications).name"/></span>
                            </div>
                            <div class="o-discuss-NotificationSettings-separator flex-grow-1"/>
                            <input class="form-check-input shadow-sm" type="radio" t-att-checked="!props.thread.self_member_id?.custom_notifications"/>
                        </div>
                    </button>
                    <t t-foreach="store.settings.NOTIFICATIONS" t-as="notif" t-key="notif.label">
                        <button class="btn w-100 d-flex p-0 border-0" t-on-click="() =&gt; store.settings.setCustomNotifications(notif.label, props.thread)">
                            <div class="d-flex flex-grow-1 align-items-center px-2 py-1 rounded">
                                <span class="fs-6 fw-normal text-wrap text-start text-break" t-esc="notif.name"/>
                                <div class="o-discuss-NotificationSettings-separator flex-grow-1"/>
                                <input class="form-check-input ms-2 shadow-sm" type="radio" t-att-checked="props.thread.self_member_id?.custom_notifications === notif.label"/>
                            </div>
                        </button>
                    </t>
                </t>
            </div>
        </ActionPanel>
    </t>

`);
registerTemplateExtension("mail.Thread", `/mail/static/src/discuss/core/common/thread_patch.xml`, `<t t-inherit="mail.Thread" t-inherit-mode="extension" xml:space="preserve">
        <xpath expr="//div[hasclass('o-mail-Thread')]" position="before">
            <span t-if="!env.inChatter and props.thread.showUnreadBanner" class="o-mail-Thread-banner d-flex cursor-pointer shadow-sm smaller fw-bolder border border-warning">
                <t t-set="alertClass" t-value="'alert alert-warning m-0 border-start-0 o-mail-Thread-bannerHover py-1 rounded-0'"/>
                <span t-attf-class="{{ alertClass }} flex-grow-1" t-on-click="onClickUnreadMessagesBanner" t-esc="newMessageBannerText"/>
                <span t-attf-class="{{ alertClass }}" t-on-click="() =&gt; props.thread.markAsRead()">Mark as Read<i class="ms-2 fa fa-check-square"/></span>
            </span>
        </xpath>
    </t>
`);
registerTemplate("discuss.GifPicker", `/mail/static/src/discuss/gif_picker/common/gif_picker.xml`, `<t t-name="discuss.GifPicker" xml:space="preserve">
        <div class="o-discuss-GifPicker d-flex flex-column" t-attf-class="{{ props.className }}" t-att-class="{ 'h-100': props.mobile }" t-on-focusin="() =&gt; state.focused = true" t-on-focusout="() =&gt; state.focused = false">
            <div t-if="!store.hasGifPickerFeature and store.self.main_user_id?.is_admin" class="d-flex flex-column align-items-center justify-content-center m-3 h-100">
                <span class="o-discuss-GifPicker-bigEmoji"></span>
                <span class="fs-5 text-muted">Want to spice up your conversations with GIFs? Activate the feature in the settings!</span>
            </div>
            <t t-else="">
                <div class="o-EmojiPicker-search d-flex align-items-center m-2 rounded">
                    <i t-if="!state.showCategories" aria-label="back" t-on-click="openCategories" class="oi oi-arrow-left cursor-pointer p-2 fs-5"/>
                    <span class="d-flex mx-1 w-100 rounded o-active">
                        <t t-call="discuss.GifPicker.searchInput">
                            <t t-if="props.state" t-set="localState" t-value="props.state"/>
                            <t t-else="" t-set="localState" t-value="state"/>
                        </t>
                        <i class="oi oi-search p-2 fs-5 rounded-start-0 rounded-3 o-active" title="Search..." role="img" aria-label="Search..."/>
                    </span>
                </div>
                <div class="o-discuss-GifPicker-content overflow-y-auto overflow-x-hidden ps-2 pe-3 pb-2 h-100" t-ref="scroller">
                    <div t-if="state.loadingError" class="text-center">
                        <span class="o-discuss-GifPicker-error d-block"></span>
                        <span class="fs-5 text-muted d-block">Failed to load gifs...</span>
                    </div>
                    <div t-if="state.showCategories and !state.loadingError" class="row row-cols-2 gy-2 gx-2" aria-label="list">
                        <div t-if="store.self_partner" class="col">
                            <div class="position-relative ratio ratio-16x9 cursor-pointer rounded overflow-hidden" t-on-click="onClickFavoritesCategory" aria-label="list-item">
                                <img t-if="state.favorites.gifs.length &gt; 0" class="o-discuss-GifPicker-category" t-att-src="state.favorites.gifs[0].media_formats.tinygif.url" loading="lazy" alt="GIF Favorites"/>
                                <div class="position-absolute w-100 h-100 top-0 start-0 text-center o-text-white align-middle fs-2 o-bg-black bg-opacity-50">
                                    Favorites
                                </div>
                            </div>
                        </div>
                        <t t-if="state.categories.length === 0">
                            <t t-foreach="Array(10).keys()" t-as="category" t-key="category_index">
                                <div class="col">
                                    <div class="position-relative ratio ratio-16x9 cursor-pointer rounded overflow-hidden" aria-label="list-item">
                                        <div class="position-absolute w-100 h-100 top-0 start-0 text-center o-text-white align-middle fs-2 o-bg-black bg-opacity-50"/>
                                    </div>
                                </div>
                            </t>
                        </t>
                        <t t-else="">
                            <t t-foreach="state.categories" t-as="category" t-key="category_index">
                                <div class="col">
                                    <div class="position-relative ratio ratio-16x9 cursor-pointer rounded overflow-hidden" t-on-click="() =&gt; this.onClickCategory(category)" aria-label="list-item">
                                        <img class="o-discuss-GifPickerCategory-img img-fluid" t-att-src="category.image" loading="lazy" alt="GIF Category"/>
                                        <div class="position-absolute w-100 h-100 top-0 start-0 text-center o-text-white align-middle fs-2 o-bg-black bg-opacity-50">
                                            <t t-out="category.name"/>
                                        </div>
                                    </div>
                                </div>
                            </t>
                        </t>
                    </div>
                    <t t-if="!state.showCategories">
                        <div class="d-flex gap-1">
                            <div>
                                <t t-foreach="state.evenGif.gifs" t-as="gif" t-key="gif_index">
                                    <t t-call="discuss.GifPicker.gif"/>
                                </t>
                            </div>
                            <div>
                                <t t-foreach="state.oddGif.gifs" t-as="gif" t-key="gif_index">
                                    <t t-call="discuss.GifPicker.gif"/>
                                </t>
                            </div>
                        </div>
                        <div t-if="state.loadingGif" class="text-center fs-6 h-100 d-flex flex-column justify-content-center">
                            <i class="fa fa-spin fa-circle-o-notch"/>
                        </div>
                        <div t-elif="showFavorite and state.evenGif.gifs.size === 0 and state.oddGif.gifs.size === 0" class="d-flex flex-column h-100 align-items-center justify-content-center text-center text-muted gap-2">
                            <i class="o-discuss-GifPicker-noFavoritesIcon o-yellow fa fa-star fs-1"/>
                            <span class="fs-5">So uhh... maybe go favorite some GIFs?</span>
                        </div>
                    </t>
                </div>
            </t>
        </div>
    </t>

    `);
registerTemplate("discuss.GifPicker.gif", `/mail/static/src/discuss/gif_picker/common/gif_picker.xml`, `<t t-name="discuss.GifPicker.gif" xml:space="preserve">
        <div class="o-discuss-Gif position-relative mt-1 fs-5 cursor-pointer rounded overflow-hidden">
            <i t-if="store.self_partner" class="position-absolute top-0 end-0 me-3 mt-3 p-2 o-bg-black bg-opacity-75 fa cursor-pointer opacity-0" t-att-class="{ 'o-text-white fa-star-o': !isFavorite(gif_value), 'fa-star o-starred': isFavorite(gif_value) }" t-on-click="() =&gt; this.onClickFavorite(gif_value)"/>
            <Gif class="'img-fluid'" style="style" alt="'GIF'" onClick="() =&gt; this.onClickGif(gif_value)" src="gif_value.media_formats.tinygif.url" loading="'lazy'" paused="!state.focused"/>
        </div>
    </t>

    `);
registerTemplate("discuss.GifPicker.searchInput", `/mail/static/src/discuss/gif_picker/common/gif_picker.xml`, `<t t-name="discuss.GifPicker.searchInput" xml:space="preserve">
        <input class="form-control border-0 flex-grow-1 rounded-3 rounded-end-0 o-active" placeholder="Search for a GIF" t-model="localState.searchTerm" t-ref="autofocus"/>
    </t>
`);
registerTemplate("discuss.PinnedMessagesPanel", `/mail/static/src/discuss/message_pin/common/pinned_messages_panel.xml`, `<t t-name="discuss.PinnedMessagesPanel" xml:space="preserve">
        <ActionPanel title.translate="Pinned Messages" minWidth="200" initialWidth="400" icon="'fa fa-thumb-tack'">
            <MessageCardList emptyText="emptyText" messages="props.thread.pinnedMessages" thread="props.thread" mode="'pin'"/>
        </ActionPanel>
    </t>
`);
registerTemplateExtension("mail.Composer", `/mail/static/src/discuss/typing/common/composer_patch.xml`, `<t t-inherit="mail.Composer" t-inherit-mode="extension" xml:space="preserve">
        <xpath expr="//*[hasclass('o-mail-Composer-coreHeader')]" position="before">
            <div t-if="thread?.model === 'discuss.channel' and !compact and !env.inMeetingView" class="o-discuss-Typing d-flex position-absolute top-0 w-100 bg-100 pe-none o-pt-0_5 pe-2 z-1">
                <Typing t-if="thread.hasOtherMembersTyping" channel="thread" size="'medium'"/>
            </div>
        </xpath>
    </t>
`);
registerTemplateExtension("mail.ThreadIcon", `/mail/static/src/discuss/typing/common/thread_icon_patch.xml`, `<t t-inherit="mail.ThreadIcon" t-inherit-mode="extension" xml:space="preserve">
        <xpath expr="//t[@name='chat']" position="replace">
            <div t-if="props.thread.hasOtherMembersTyping" class="bg-inherit rounded-pill" style="padding: 1px;">
                <div class="bg-success rounded-pill" style="padding: 3px;">
                    <Typing member="props.member" channel="props.thread" size="props.size" displayText="false"/>
                </div>
            </div>
            <t t-else="">$0</t>
        </xpath>
    </t>
`);
registerTemplate("discuss.Typing", `/mail/static/src/discuss/typing/common/typing.xml`, `<t t-name="discuss.Typing" xml:space="preserve">
        <t t-if="props.member ? props.member.isTyping : props.channel.hasOtherMembersTyping">
            <div class="o-discuss-Typing-icon d-flex align-items-center bg-inherit" t-attf-class="{{ className }}" t-att-title="text">
                <span class="o-discuss-Typing-dot d-flex flex-shrink-0 rounded-pill" t-att-class="{                     'o-sizeMedium': ['medium', 'md'].includes(props.size),                     'o-sizeSmall': ['small', 'sm'].includes(props.size),                 }"/>
                <span class="flex-grow-1 flex-shrink-0"/>
                <span class="o-discuss-Typing-dot o-discuss-Typing-dot2 d-flex flex-shrink-0 rounded-pill" t-att-class="{                     'o-sizeMedium': ['medium', 'md'].includes(props.size),                     'o-sizeSmall': ['small', 'sm'].includes(props.size),                 }"/>
                <span class="flex-grow-1 flex-shrink-0"/>
                <span class="o-discuss-Typing-dot o-discuss-Typing-dot3 d-flex flex-shrink-0 rounded-pill" t-att-class="{                     'o-sizeMedium': ['medium', 'md'].includes(props.size),                     'o-sizeSmall': ['small', 'sm'].includes(props.size),                 }"/>
            </div>
            <t t-if="props.displayText">
                <span class="ms-1"/>
                <span class="text-truncate smaller text-muted" t-out="text"/>
            </t>
        </t>
    </t>

`);
registerTemplateExtension("mail.AttachmentList", `/mail/static/src/discuss/voice_message/common/attachment_list_patch.xml`, `<t t-inherit="mail.AttachmentList" t-inherit-mode="extension" xml:space="preserve">
        <xpath expr="//div[hasclass('o-mail-AttachmentCard-info')]" position="replace">
            <t t-if="attachment.voice">
                <VoicePlayer attachment="attachment"/>
            </t>
            <t t-else="">$0</t>
        </xpath>
        <xpath expr="(//div[@t-if='!isMobileOS'])" position="attributes">
            <attribute name="t-if">!isMobileOS and !attachment.voice</attribute>
        </xpath>
        <xpath expr="//div[hasclass('o-Attachment-uploaded')]" position="attributes">
            <attribute name="t-att-class">!isMobileOS and !attachment.voice ? 'end-0' : 'start-0'</attribute>
        </xpath>
    </t>
`);
registerTemplate("mail.VoicePlayer", `/mail/static/src/discuss/voice_message/common/voice_player.xml`, `<t t-name="mail.VoicePlayer" xml:space="preserve">
        <div class="o-mail-VoicePlayer d-flex align-items-center my-1 position-relative">
            <t t-set="playOrPause"><t t-if="state.repeat">Repeat</t><t t-elif="state.playing">Pause</t><t t-else="">Play</t></t>
            <button class="border-0 btn shadow-none rounded-pill fa fa-fw ms-2 me-3 bg-200" t-att-class="{                     'fa-stop text-danger btn-sm': state.playing,                     'btn-light btn-sm': !state.playing,                     'fa-play': !state.playing and !state.repeat,                     'fa-repeat': !state.playing and state.repeat,                 }" t-att-title="playOrPause" t-on-click.stop="() =&gt; this.onClickPlayPause()"/>
            <div class="o-mail-VoicePlayer-wrapper">
                <div t-ref="wrapper" class="h-100 position-relative">
                    <div class="o-mail-VoicePlayer-drawer position-absolute top-0 bottom-0 overflow-hidden" t-ref="drawer">
                        <canvas class="position-absolute" t-ref="progress"/>
                    </div>
                    <canvas class="position-absolute" t-ref="wave"/>
                </div>
            </div>
            <div class="mx-2 text-muted" style="font-variant-numeric: tabular-nums;"><t t-esc="state.visualTime"/></div>
        </div>
    </t>

`);
registerTemplate("mail.VoiceRecorder", `/mail/static/src/discuss/voice_message/common/voice_recorder.xml`, `<t t-name="mail.VoiceRecorder" xml:space="preserve">
        <t t-set="title"><t t-if="!state.recording">Voice Message</t><t t-else=""/></t>
        <button class="o-mail-VoiceRecorder d-flex align-items-center btn border-0 p-0" t-att-class="{ 'o-recording rounded-start-0 rounded-end user-select-none p-0': state.recording, 'rounded-circle': !state.recording }" t-att-title="title" t-att-disabled="state.isActionPending or props.composer.voiceAttachment" t-on-click="onClick">
            <div class="o-mail-VoiceRecorder-elapsed" t-att-class="{                 'o-active recording ms-2 me-1': state.recording,                 'mw-0': !state.recording,                 'text-danger': state.limitWarning,             }" style="font-variant-numeric: tabular-nums;"><span class="d-flex text-truncate" t-esc="state.elapsed"/></div>
            <span class="rounded-circle" t-att-class="{ 'p-1': state.recording }"><i t-att-class="!state.recording ? 'fa fa-fw fa-lg fa-microphone' : 'fa fa-fw fa-circle text-danger o-mail-VoiceRecorder-dot'"/></span>
        </button>
    </t>

`);
registerTemplateExtension("mail.Message", `/portal/static/src/chatter/core/message_patch.xml`, `<t t-inherit="mail.Message" t-inherit-mode="extension" xml:space="preserve">
        <xpath expr="//t[@t-call='mail.Message.notification']" position="replace"/>
    </t>
`);
registerTemplate("portal.Chatter", `/portal/static/src/chatter/core/portal_chatter.xml`, `<t t-name="portal.Chatter" xml:space="preserve">
    <div t-if="state.thread" class="o-mail-Chatter o-portal-Chatter w-100 h-100 flex-grow-1 d-flex pt-2" t-att-class="{ 'row':props.twoColumns, 'flex-column':!props.twoColumns }" t-on-scroll="onScrollDebounced" t-ref="root">
        <div class="o-mail-Chatter-top top-0" t-att-class="{ 'col-lg-5':props.twoColumns, 'position-sticky':props.composer }" t-att-style="(!props.twoColumns and env.inFrontendPortalChatter and !env.projectSharingId) and 'top: -1px !important; margin-top:-15px; padding-top: 20px'" t-ref="top">
            <Composer t-if="props.composer" composer="state.thread.composer" mode="'extended'" onPostCallback.bind="onPostCallback" dropzoneRef="rootRef" t-key="props.threadId" type="'message'"/>
        </div>
        <div class="o-mail-Chatter-content" t-att-class="{ 'col-lg-6 offset-lg-1':props.twoColumns }">
            <Thread thread="state.thread" t-key="state.thread.localId" order="'desc'" scrollRef="rootRef" jumpPresent="state.jumpThreadPresent"/>
        </div>
    </div>
</t>

`);
registerTemplateExtension("mail.Composer", `/portal_rating/static/src/chatter/frontend/composer_patch.xml`, `<t t-inherit="mail.Composer" t-inherit-mode="extension" xml:space="preserve">
        <xpath expr="//div[hasclass('o-mail-Composer-coreMain')]" position="before">
            <div t-if="env.displayRating and !message" class="o-mail-Composer-starCard d-flex mb-3 px-2">
                <div class="o-mail-Composer-stars enabled cursor-pointer" t-on-mouseleave="() =&gt; portalState.starValue = portalState.ratingValue">
                    <t t-set="index" t-value="0"/>
                    <t t-foreach="Array(portalState.starValue)" t-as="num" t-key="num_index">
                        <i class="fa fa-star" role="img" aria-label="Full star" t-att-index="index" t-on-mousemove="onMoveStar" t-on-click="onClickStar"/>
                        <t t-set="index" t-value="index + 1"/>
                    </t>
                    <t t-foreach="Array(5 - portalState.starValue)" t-as="num" t-key="num_index">
                        <i class="fa fa-star-o text-black-25" role="img" aria-label="Empty star" t-att-index="index" t-on-mousemove="onMoveStar" t-on-click="onClickStar"/>
                        <t t-set="index" t-value="index + 1"/>
                    </t>
                </div>
            </div>
        </xpath>
    </t>
`);
registerTemplateExtension("mail.Message", `/portal_rating/static/src/chatter/frontend/message_patch.xml`, `<t t-inherit="mail.Message" t-inherit-mode="extension" xml:space="preserve">
        <xpath expr="//div[@name='header']" position="after">
            <div t-if="ratingValue" class="mb-2">
                <t t-call="portal_rating.rating_stars_static">
                    <t t-set="val" t-value="ratingValue"/>
                </t>
            </div>
        </xpath>
        <xpath expr="//*[@t-ref='messageContent']" position="inside">

            <div t-if="message.rating_id and message.rating_id.id" class="o_wrating_publisher_container">
                <button t-if="store.self.is_user_publisher" t-attf-class="btn px-2 my-2 btn-sm border o_wrating_js_publisher_comment_btn {{ message.rating_id.publisher_comment !== '' ? 'd-none' : '' }}" t-att-data-mes_index="message.rating_id.mes_index" t-on-click="onClikEditComment">
                    <i class="fa fa-comment text-muted me-1"/>Comment
                </button>
                <div t-if="state.editRating" class="mt-2">
                    <Composer autofocus="true" composer="message.composer" onDiscardCallback.bind="exitEditCommentMode" onPostCallback.bind="exitEditCommentMode" mode="'compact'"/>
                </div>
                <div t-if="message.rating_id.publisher_comment and !state.editRating" class="o_wrating_publisher_comment mt-2 mb-2">
                    <div class="o-mail-Message-core position-relative d-flex flex-shrink-0">
                        <div class="o-mail-Message-sidebar d-flex flex-shrink-0">
                            <div class="o-mail-Message-avatarContainer position-relative">
                                <img class="o-mail-Message-avatar w-100 h-100 rounded" t-att-src="message.rating_id.publisher_avatar" t-att-class="authorAvatarAttClass"/>
                            </div>
                        </div>
                        <div class="w-100 o-min-width-0">
                            <div class="o-mail-Message-header d-flex flex-wrap align-items-baseline mb-1 lh-1">
                                <strong class="me-1 text-truncate"><t t-esc="message.rating_id.publisher_name"/></strong>
                                <small class="text-muted opacity-50 me-2">Published on <t t-esc="message.rating_id.publisher_datetime"/></small>
                                <div t-if="store.self.is_user_publisher" class="d-flex rounded-0">
                                    <Dropdown>
                                        <button class="bg-transparent border-0">
                                            <i class="btn px-1 py-0 oi oi-ellipsis-v"/>
                                        </button>
                                        <t t-set-slot="content">
                                            <DropdownItem class="'o_wrating_js_publisher_comment_edit'" onSelected="() =&gt; this.onClikEditComment()">
                                                <i class="fa fa-fw fa-pencil me-1"/>Edit
                                            </DropdownItem>
                                            <DropdownItem class="'o_wrating_js_publisher_comment_delete'" onSelected="() =&gt; this.deleteComment()">
                                                <i class="fa fa-fw fa-trash-o me-1"/>Delete
                                            </DropdownItem>
                                        </t>
                                    </Dropdown>
                                </div>
                            </div>
                            <div class="position-relative d-flex">
                                <div class="o-min-width-0 position-relative d-flex overflow-x-auto d-inline-block">
                                    <div class="o-mail-Message-bubble rounded-bottom-3 position-absolute top-0 start-0 w-100 h-100 bg-info-light opacity-25 rounded-end-3"/>
                                    <div class="position-relative text-break o-mail-Message-body mb-0 py-2 px-3 align-self-start rounded-end-3 rounded-bottom-3">
                                        <p><t t-out="message.rating_id.publisher_comment"/></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </xpath>
    </t>
`);
registerTemplateExtension("portal.Chatter", `/portal_rating/static/src/chatter/frontend/portal_chatter_patch.xml`, `<t t-inherit="portal.Chatter" t-inherit-mode="extension" xml:space="preserve">
        <xpath expr="//div[hasclass('o-mail-Chatter-top')]/*[1]" position="before">
            <div t-if="env.displayRating and ratingStats and ratingStats.total" class="my-2" t-att-class="{ 'mb-4':props.twoColumns }">
                <t t-call="portal_rating.rating_card">
                    <t t-set="two_columns" t-value="props.twoColumns"/>
                    <t t-set="rating_stats" t-value="ratingStats"/>
                    <t t-set="selected_rating" t-value="state.thread?.selectedRating"/>
                </t>
            </div>
        </xpath>
    </t>
`);
                    });
